<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‚¹å·¥å•</title>
    <!-- æœ¬åœ°åŠ è½½å®Œæ•´çš„Supabaseåº“ -->
    <script src="./JavaScript/supabase/supabase.min.js"></script>
    <!-- åŠ è½½æµè§ˆå™¨ç¯å¢ƒçš„Supabaseé…ç½® -->
    <script src="./JavaScript/supabase/supabase-client.js"></script>
    <!-- ç¦»çº¿åŒæ­¥æœåŠ¡ -->
    <script src="./JavaScript/ç¦»çº¿åŒæ­¥/offline-sync-service.js"></script>
    <!-- åŒæ­¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <script src="./JavaScript/ç¦»çº¿åŒæ­¥/sync-status-indicator.js"></script>
    <!-- å¼•å…¥Compressor.jsç”¨äºå›¾ç‰‡å‹ç¼© -->
    <script src="./JavaScript/supabase/compressor.min.js"></script>
    <!-- ä¸­æ–‡è½¬æ‹¼éŸ³åº“ -->
    <script src="./JavaScript/supabase/pinyin-pro.js"></script>
    <!-- PDFç”Ÿæˆåº“ -->
    <script src="./JavaScript/pdf/html2canvas.min.js"></script>
    <script src="./JavaScript/pdf/jspdf.umd.min.js"></script>
    <script src="./JavaScript/pdf/jspdf.plugin.autotable.min.js"></script>
    <!-- ç‚¹å·¥å•API -->
    <script src="./JavaScript/supabase/tus.min.js"></script>
    <!-- ç‚¹å·¥å•API -->
    <script src="./JavaScript/ç‚¹å·¥å•/work_record_api.js"></script>
    <!-- PDFç”ŸæˆåŠŸèƒ½ -->
    <script src="./JavaScript/ç‚¹å·¥å•/pdf_generator.js"></script>
    <!-- ç‚¹å·¥å•PDFç”Ÿæˆ -->
    <script src="./JavaScript/ç‚¹å·¥å•/work_order_pdf.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background-color: #f5f5f5;
            font-family: 'Microsoft YaHei', sans-serif;
            padding: 10px;
        }
        .container {
            width: 100%;
            margin: 0;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            padding: 20px;
        }
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        .form-row > div {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .form-row label {
            margin-bottom: 0;
            white-space: nowrap;
            font-weight: bold;
        }
        
        input[type="text"], select {
            width: 335px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f5f5f5;
        }

        input[type="date"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f5f5f5;
        }
        
        /* é¡¹ç›®åç§°è¾“å…¥æ¡†ç‰¹æ®Šæ ·å¼ */
        #projectName {
            background-color: #f8f9fa !important;
            cursor: not-allowed !important;
            color: #6c757d !important;
            border: 1px solid #dee2e6 !important;
            font-weight: 500;
            font-size: 16px !important;
        }
        
        #projectName:focus {
            outline: none !important;
            box-shadow: none !important;
            border-color: #dee2e6 !important;
        }
        
        /* å¿…å¡«é¡¹æ˜Ÿå·æ ·å¼ */
        .required-asterisk {
            display: none;
            color: #ff0000;
            font-weight: bold;
            margin-right: 2px;
        }
        
        /* æ—¥æœŸè¾“å…¥æ¡†å®¹å™¨æ ·å¼ */
        .date-input-container {
            position: relative;
            width: 335px;
        }
        
        .date-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f5f5f5;
            position: relative;
            z-index: 1;
        }
        
        .date-display {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 8px 8px 8px 30px;
            border: 1px solid #1890ff;
            border-radius: 4px;
            background-color: #e6f7ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            font-size: 16px;
            color: #333;
            z-index: 2;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%231890ff'%3e%3cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: 8px center;
            background-size: 16px 16px;
        }
        
        .today-text {
            color: #1890ff;
            font-weight: bold;
            margin-left: 5px;
        }
        
        /* æ—¥æœŸé€‰æ‹©å™¨æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .date-picker-content {
            background-color: white;
            border-radius: 12px;
            width: 480px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }
        
        .date-picker-body {
            padding: 20px;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .calendar-header button {
            background: linear-gradient(135deg, rgba(240, 240, 240, 0.8), rgba(255, 255, 255, 0.6));
            border: none;
            border-radius: 8px;
            width: auto;
            height: 36px;
            padding: 0 12px;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        #prevMonth,
        #nextMonth {
            width: 36px;
            padding: 0;
        }
        
        .calendar-header button:hover {
            background: linear-gradient(135deg, rgba(24, 144, 255, 0.9), rgba(64, 169, 255, 0.8));
            color: white;
            transform: translateY(-1px) scale(1.15);
            box-shadow: 0 4px 15px rgba(24, 144, 255, 0.4);
        }
        
        #currentMonth {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            min-width: 100px;
            text-align: center;
        }
        
        /* æœˆä»½é€‰æ‹©å™¨æ ·å¼ */
        .month-picker-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2001;
        }
        
        .month-picker {
            background-color: white;
            border-radius: 12px;
            width: 320px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }
        
        .picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .picker-year-btn {
            background: transparent;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 14px;
            color: #6c757d;
            transition: all 0.3s ease;
        }
        
        .picker-year-btn:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }
        
        #pickerYear {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #343a40;
        }
        
        .month-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: 20px;
        }
        
        .month-item {
            padding: 12px;
            text-align: center;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            color: #495057;
            background-color: #ffffff;
        }
        
        .month-item:hover {
            background-color: #e7f5ff;
            border-color: #91d5ff;
            color: #1890ff;
        }
        
        .month-item.selected {
            background-color: #1890ff;
            color: white;
            border-color: #1890ff;
        }

        /* ç¦ç”¨çŠ¶æ€çš„æœˆä»½æ ·å¼ */
        .month-item.disabled {
            background-color: #f5f5f5;
            color: #999;
            border-color: #e0e0e0;
            cursor: not-allowed !important;
            opacity: 0.5 !important;
            pointer-events: none !important;
        }
        
        /* æœˆä»½æ ‡é¢˜æ ·å¼ */
        .month-title {
            cursor: pointer;
            background: transparent;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 16px;
            font-weight: 600;
            color: #475569;
            transition: all 0.3s ease;
            appearance: none;
            -webkit-appearance: none;
            position: relative;
        }
        
        .month-title:hover {
            border-color: #667eea;
            color: #667eea;
            background-color: #f8fafc;
        }
        
        .calendar-grid {
            margin-bottom: 20px;
        }
        
        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 10px;
        }
        
        .weekdays > div {
            text-align: center;
            padding: 8px;
            font-weight: bold;
            color: #666;
            font-size: 14px;
        }
        
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        
        .day-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .day-cell:hover {
            background: linear-gradient(135deg, rgba(230, 247, 255, 0.8), rgba(240, 250, 255, 0.6));
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(24, 144, 255, 0.2);
            backdrop-filter: blur(5px);
        }
        
        .day-cell.other-month {
            color: #ccc;
            cursor: not-allowed;
        }
        
        .day-cell.disabled-future {
            color: #d0d0d0;
            background-color: #f9f9f9;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .day-cell.disabled-future:hover {
            background-color: #f9f9f9;
            transform: none;
        }
        
        .day-cell.today {
            background: #fff2e6;
            border: 2px solid #ff7a00;
            font-weight: bold;
            color: #ff7a00;
            position: relative;
        }
        
        .day-cell.today::before {
            content: 'ä»Šå¤©';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff7a00;
            color: white;
            font-size: 10px;
            padding: 1px 4px;
            border-radius: 8px;
            font-weight: bold;
            white-space: nowrap;
            z-index: 1;
        }
        
        .day-cell.selected-single {
            background: #1890ff;
            color: white;
            font-weight: bold;
        }
        
        /* å¤šé€‰æ¨¡å¼é€‰ä¸­æ—¥æœŸæ ·å¼ */
        .day-cell.selected-multi {
            background: linear-gradient(135deg, #52c41a, #389e0d);
            color: white;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(82, 196, 26, 0.3);
            transform: scale(1.05);
        }
        
        /* å¤šé€‰æ¨¡å¼æ—¥æœŸèŒƒå›´æ ·å¼ */
        .day-cell.selected-range {
            background: linear-gradient(135deg, #95de64, #73d13d);
            color: white;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(149, 222, 100, 0.2);
        }

        /* ç­ç»„è¾“å…¥æ¡†æ ·å¼ */
        #teamName {
            font-size: 16px;
            width: 120px;
            transition: all 0.3s;
        }
        
        /* ç­ç»„è¾“å…¥æ¡†æœ‰å€¼æ—¶çš„æ ·å¼ */
        #teamName.has-value {
            background-color: #e6f7ff;
            border: 1px solid #1890ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
            color: #333;
        }
        
        /* ç­ç»„é•¿è¾“å…¥æ¡†æ ·å¼ */
        #teamLeader {
            font-size: 16px;
            width: 120px;
            transition: all 0.3s;
        }
        
        /* ç­ç»„é•¿è¾“å…¥æ¡†æœ‰å€¼æ—¶çš„æ ·å¼ */
        #teamLeader.has-value {
            background-color: #e6f7ff;
            border: 1px solid #1890ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
            color: #333;
        }

        /* å·¥æ—¥/å•ä»·/é‡‘é¢è¾“å…¥æ¡†æ ·å¼ */
        #workDays,
        #unitPrice,
        #amount {
            font-size: 16px;
            width: 120px;
            height: 35px; /* æ˜¾å¼è®¾ç½®é«˜åº¦ï¼Œç¡®ä¿ä¸æ–‡æœ¬è¾“å…¥æ¡†ä¸€è‡´ */
            padding: 8px 40px 8px 8px; /* å³ä¾§ç•™å‡ºç©ºé—´ç»™å•ä½ */
            box-sizing: border-box; /* ç¡®ä¿é«˜åº¦åŒ…å«å†…è¾¹è·å’Œè¾¹æ¡† */
            border: 1px solid #ddd; /* ç»Ÿä¸€è¾¹æ¡† */
            border-radius: 4px; /* ç»Ÿä¸€åœ†è§’ */
            background-color: #f5f5f5; /* ç»Ÿä¸€èƒŒæ™¯è‰² */
            transition: all 0.3s;
            text-align: center; /* æ•°å­—æ°´å¹³å±…ä¸­ */
        }

        /* éšè—å•ä»·å’Œé‡‘é¢è¾“å…¥æ¡†çš„ä¸Šä¸‹ç®­å¤´ */
        #unitPrice::-webkit-outer-spin-button,
        #unitPrice::-webkit-inner-spin-button,
        #amount::-webkit-outer-spin-button,
        #amount::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        #unitPrice,
        #amount {
            -moz-appearance: textfield;
            appearance: textfield;
        }


        #workDays::placeholder,
        #unitPrice::placeholder,
        #amount::placeholder {
            font-size: 14px;
        }
        
        /* å·¥æ—¥å•ä½å®¹å™¨ */
        .work-days-wrapper {
            position: relative;
            display: inline-block;
        }
        
        /* å·¥æ—¥/å•ä»·/é‡‘é¢å•ä½æ ·å¼ */
        #workDaysUnit,
        #unitPriceUnit,
        #amountUnit {
            position: absolute;
            right: 8px; /* è·ç¦»è¾“å…¥æ¡†å³ä¾§è¾¹è· */
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px; /* ç¨å¾®è°ƒå°å­—ä½“ä»¥é€‚åº”å†…éƒ¨ */
            color: #666;
            pointer-events: none; /* é˜²æ­¢é®æŒ¡è¾“å…¥ç‚¹å‡» */
            z-index: 1; /* ç¡®ä¿æ˜¾ç¤ºåœ¨è¾“å…¥æ¡†å†…å®¹ä¹‹ä¸Š */
        }

        /* å·¥æ—¥/å•ä»·/é‡‘é¢è¾“å…¥æ¡†æœ‰å€¼æ—¶çš„æ ·å¼ */
        #workDays.has-value,
        #unitPrice.has-value,
        #amount.has-value {
            background-color: #e6f7ff;
            border: 1px solid #1890ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
            color: #333;
        }

        /* è¯´æ˜è¾“å…¥åŒºåŸŸæ ·å¼ */
        #description {
            width: 100%;
            max-width: 60%;
            min-height: 80px; /* å¢åŠ é«˜åº¦ä»¥å®¹çº³çº¦3è¡Œæ–‡å­— */
            height: 80px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        /* è¯´æ˜è¾“å…¥æ¡†æœ‰å€¼æ—¶çš„æ ·å¼ */
        #description.has-value {
            background-color: #e6f7ff;
            border: 1px solid #1890ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
            color: #333;
        }
        
        #description::placeholder { color: #999; }
        #description::-webkit-input-placeholder { color: #999; }
        #description::-moz-placeholder { color: #999; }
        #description:-ms-input-placeholder { color: #999; }

        /* å›¾ç‰‡é¢„è§ˆé¡¹æ ·å¼ */
        .image-upload-item {
            width: 100px;
            height: 100px;
        }

        /* é¡¶éƒ¨éšè—/æŠ˜å å¼€å…³æ ·å¼ - iOSé£æ ¼ */
        .checkbox-item {
            position: relative;
            width: 80px; /* åŠ å¤§å®½åº¦ */
            height: 34px; /* åŠ å¤§é«˜åº¦ */
            border-radius: 17px; /* è°ƒæ•´åœ†è§’ */
            padding: 0;
            background: transparent;
            overflow: hidden;
            margin-right: 5px;
            border: none;
            display: inline-block;
            vertical-align: middle;
        }

        .checkbox-item:hover {
            background: transparent;
        }

        /* éšè—é»˜è®¤å¤é€‰æ¡†ä½†ä¿æŒå¯ç‚¹å‡» */
        .checkbox-item input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 100%;
            width: 100%;
            z-index: 3;
        }

        /* è½¨é“ */
        .checkbox-item .custom-checkbox {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 17px; /* è°ƒæ•´åœ†è§’ */
            background-color: #10b981; /* ç»¿è‰²èƒŒæ™¯ */
            background-image: linear-gradient(135deg, #10b981, #059669);
            border: none;
            z-index: 1;
            transition: all 0.3s ease;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        /* é€‰ä¸­çŠ¶æ€è½¨é“ */
        .checkbox-item input:checked + .custom-checkbox {
            background: #3b82f6;
            background-image: linear-gradient(135deg, #3b82f6, #2563eb);
            box-shadow: none;
            border: none;
        }

        /* æ»‘å— */
        .checkbox-item .custom-checkbox::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 28px; /* åŠ å¤§æ»‘å— */
            height: 28px; /* åŠ å¤§æ»‘å— */
            background: white;
            border-radius: 50%;
            border: none;
            transform: none;
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* é€‰ä¸­çŠ¶æ€æ»‘å—ä½ç½® */
        .checkbox-item input:checked + .custom-checkbox::after {
            transform: translateX(46px); /* è°ƒæ•´ç§»åŠ¨è·ç¦» (80 - 28 - 3 - 3 = 46) */
            background: white;
            border: none;
            border-width: 0;
            
            /* å¼ºåˆ¶é‡ç½®è¢«å…¨å±€æ ·å¼è¦†ç›–çš„å±æ€§ï¼Œé˜²æ­¢åœ†ç‚¹æ¶ˆå¤± */
            width: 28px; /* åŠ å¤§æ»‘å— */
            height: 28px; /* åŠ å¤§æ»‘å— */
            left: 3px;
            top: 3px;
            border-radius: 50%;
        }

        /* æ–‡å­— span */
        .checkbox-item span:last-child {
            position: relative;
            z-index: 2;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            font-size: 16px; /* åŠ å¤§å­—ä½“ */
            font-weight: 600;
            transition: all 0.3s;
            pointer-events: none;
            
            /* æœªé€‰ä¸­çŠ¶æ€ï¼šæ–‡å­—åœ¨å³ */
            justify-content: flex-end;
            padding-right: 10px; /* è°ƒæ•´å†…è¾¹è· */
            color: white;
        }
        
        /* æŠ€å·¥/æ™®å·¥åˆ‡æ¢æ–‡å­—é€»è¾‘ */
        .checkbox-item input:not(:checked) ~ span:last-child::after {
            content: "æ™®å·¥";
        }

        .checkbox-item input:checked ~ span:last-child::after {
            content: "æŠ€å·¥";
        }

        /* é€‰ä¸­çŠ¶æ€æ–‡å­— */
        .checkbox-item input:checked ~ span:last-child {
            /* é€‰ä¸­çŠ¶æ€ï¼šæ–‡å­—åœ¨å·¦ */
            justify-content: flex-start;
            padding-left: 10px; /* è°ƒæ•´å†…è¾¹è· */
            color: white;
        }

        /* å·¥ä½œç±»å‹æ ‡ç­¾æ ·å¼ */
        .work-type-option {
            cursor: pointer;
            padding: 8px 16px;
            position: relative;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 8px;
            margin: 2px;
        }
        .work-type-option:hover {
            transform: translateY(-1px) scale(1.05);
            background: rgba(0, 102, 204, 0.2);
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3);
        }
        .work-type-option.active {
            color: white;
            background: linear-gradient(135deg, rgba(0, 102, 204, 0.9), rgba(30, 144, 255, 0.8));
            box-shadow: 0 2px 8px rgba(0, 102, 204, 0.4);
            transform: translateY(-0.5px);
        }
        .work-type-option.active:hover {
            transform: translateY(-1px) scale(1.05);
            box-shadow: 0 3px 12px rgba(0, 102, 204, 0.5);
        }

        /* æ ‡ç­¾é¡µå¯¼èˆªä¸­çš„æ ‡ç­¾æ ·å¼ */
        .work-type.tab-navigation {
            background-color: #fff;
            border-bottom: 1px solid #f0f0f0;
            padding: 0;
            gap: 0;
            overflow: visible;
            position: relative;
        }

        .work-type.tab-navigation .work-type-option {
            border: none;
            background-color: #fff;
            color: #333; /* æœªé€‰ä¸­å­—ä½“é»‘è‰² */
            margin: 0;
            flex: none; /* å–æ¶ˆè‡ªåŠ¨å¡«å…… */
            width: auto; /* æ¢å¤è‡ªåŠ¨å®½åº¦ */
            text-align: center;
            border-radius: 0;
            font-weight: bold; /* æœªé€‰ä¸­å­—ä½“åŠ ç²— */
            padding: 10px 35px; /* å¢åŠ å†…è¾¹è· */
            position: relative;
            cursor: pointer; /* ç¡®ä¿æ˜¾ç¤ºæŒ‡é’ˆ */
            display: inline-block; /* ç¡®ä¿ä¸ºå—çº§å…ƒç´  */
            pointer-events: auto; /* ç¡®ä¿å¯ä»¥æ¥æ”¶ç‚¹å‡»äº‹ä»¶ */
        }

        /* ç¬¬äºŒä¸ªæ ‡ç­¾ï¼ˆæ˜ç»†ï¼‰å·¦è¾¹æ·»åŠ é—´è· */
        .work-type.tab-navigation label[for="tabWorkFlow"] {
            margin-left: 20px;
        }

        /* ç¦ç”¨æ‚¬åœæ•ˆæœ */
        .work-type.tab-navigation .work-type-option:hover {
            background-color: #fff;
            transform: none;
            box-shadow: none;
        }

        .work-type.tab-navigation .work-type-option.active {
            border: none;
            color: white; /* é€‰ä¸­å­—ä½“ç™½è‰² */
            font-weight: bold;
            box-shadow: none;
            z-index: 1;
        }

        /* å·¦ä¾§"è®°å·¥"é€‰ä¸­æ—¶çš„èƒŒæ™¯ - å³ä¸Šåœ†è§’ */
        .work-type.tab-navigation label[for="tabWorkRecord"].active {
            background: linear-gradient(135deg, rgba(0, 102, 204, 0.9), rgba(30, 144, 255, 0.8));
            border-radius: 0 20px 0 0;
            transition: none !important;
        }

        /* å³ä¾§"è®°å·¥æµæ°´"é€‰ä¸­æ—¶çš„èƒŒæ™¯ - å·¦ä¸Šåœ†è§’ */
        .work-type.tab-navigation label[for="tabWorkFlow"].active {
            background: linear-gradient(135deg, rgba(0, 102, 204, 0.9), rgba(30, 144, 255, 0.8));
            border-radius: 20px 0 0 0;
            transition: none !important;
        }

        /* Restore global active underline */
        .work-type-option.active::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: #0066cc;
        }

        /* Hide underline for tab navigation */
        .work-type.tab-navigation .work-type-option.active::after {
            display: none;
        }

        /* éšè—å·¥ä½œç±»å‹é€‰é¡¹çš„input */
        .work-type input[type="radio"] {
            display: none !important;
        }

        /* ç¡®ä¿æ ‡ç­¾é¡µå¯¼èˆªä¸­çš„labelå¯ä»¥ç‚¹å‡» */
        .work-type.tab-navigation label {
            position: relative;
            z-index: 100;
        }

        /* ç°ä»£åŒ–è¡¨æ ¼æ ·å¼ */
        .modern-table {
            width: auto;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            border-radius: 12px;
            overflow: visible;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin: 5px 0 15px 0;
            border: 2px solid #e0e0e0;
            table-layout: fixed;
            border-spacing: 0;
        }

        .modern-table tbody {
            line-height: 20px;
        }

        .modern-table tbody tr {
            height: auto !important;
            max-height: none !important;
        }

        .modern-table thead {
            background: linear-gradient(135deg, #1890ff 0%, #40a9ff 100%);
            color: white;
        }

        .modern-table th {
            padding: 8px 12px;
            text-align: center;
            font-weight: 600;
            font-size: 13px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            border: 1px solid #1890ff;
            border-right: 1px solid #40a9ff;
            position: relative;
            white-space: nowrap;
            width: auto;
            min-width: min-content;
            max-width: none;
            height: auto;
            max-height: none;
            line-height: 16px;
            vertical-align: middle;
            overflow: hidden;
            background: linear-gradient(135deg, #1890ff 0%, #40a9ff 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .modern-table th:first-child {
            border-top-left-radius: 12px;
        }

        .modern-table th:last-child {
            border-top-right-radius: 12px;
        }

        /* å·¥ä½œå†…å®¹åˆ—æ ·å¼ */
        .work-content-header {
            max-width: 150px;
            width: 150px;
            white-space: normal !important;
            text-align: left;
            word-wrap: break-word;
        }

        .work-content-cell {
            max-width: 150px;
            width: 150px;
            white-space: normal !important;
            text-align: left;
            word-wrap: break-word;
            overflow: visible;
        }

        .modern-table th:not(:last-child)::after {
            content: '';
            position: absolute;
            right: 0;
            top: 20%;
            height: 60%;
            width: 1px;
            background: rgba(255, 255, 255, 0.3);
        }

        .modern-table td {
            padding: 6px 12px;
            text-align: center;
            font-size: 13px;
            color: #333;
            border: 1px solid #e0e0e0;
            border-right: 1px solid #d0d0d0;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.2s ease;
            white-space: nowrap;
            width: auto;
            min-width: min-content;
            max-width: none;
            height: auto;
            max-height: none;
            line-height: 20px;
            vertical-align: middle;
            overflow: hidden;
        }

        .modern-table tbody tr {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 3px solid transparent;
            height: auto;
            max-height: none;
            overflow: hidden;
        }

        .modern-table tbody tr:hover {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.15), rgba(255, 213, 79, 0.1));
            box-shadow: 0 6px 16px rgba(255, 193, 7, 0.3);
            border-left: 3px solid #ffc107;
            position: relative;
            z-index: 10;
        }

        .modern-table tbody tr:hover td {
            color: #d48806;
            font-weight: 500;
            border-color: #ffd54f;
            border-top: 1px solid #ffd54f !important;
            border-bottom: 1px solid #ffd54f !important;
            box-shadow: inset 0 0 0 1px rgba(255, 193, 7, 0.1);
        }

        .modern-table tbody tr:hover td:first-child {
            border-left: 2px solid #ffc107;
        }

        .modern-table tbody tr:hover td:last-child {
            border-right: 2px solid #ffc107;
        }

        .modern-table tbody tr:last-child td {
            border-bottom: none;
        }

        .modern-table tbody tr:nth-child(even) {
            background: rgba(240, 247, 255, 0.8);
        }

        .modern-table tbody tr:nth-child(odd) {
            background: rgba(255, 255, 255, 0.95);
        }

        .modern-table tbody tr:nth-child(even):hover {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.2), rgba(255, 213, 79, 0.15));
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }

        .modern-table tbody tr:nth-child(odd):hover {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.25), rgba(255, 213, 79, 0.2));
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.35);
        }

        /* è¡¨æ ¼è¡Œé€‰ä¸­çŠ¶æ€ */
        .modern-table tbody tr.selected {
            background: linear-gradient(135deg, rgba(24, 144, 255, 0.2), rgba(64, 169, 255, 0.1));
            border-left: 3px solid #1890ff;
            box-shadow: 0 4px 12px rgba(24, 144, 255, 0.3);
        }

        .modern-table tbody tr.selected td {
            color: #1890ff;
            font-weight: 500;
            border-color: #40a9ff;
        }

        /* åˆ é™¤å›¾æ ‡æ ·å¼ */
        .delete-icon {
            display: none;
            position: absolute;
            right: -30px;
            top: 50%;
            transform: translateY(-50%);
            color: #ff4d4f;
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            background-color: transparent;
            box-shadow: none;
            z-index: 10;
        }

        .modern-table tbody tr:hover .delete-icon {
            display: block;
        }

        .delete-icon:hover {
            background-color: #ff4d4f;
            color: white;
        }

        /* ä¸ºè¡¨æ ¼è¡Œæ·»åŠ ç›¸å¯¹å®šä½ï¼Œä»¥ä¾¿æ­£ç¡®å®šä½åˆ é™¤å›¾æ ‡ */
        .modern-table tbody tr {
            position: relative;
        }

        /* ä¸ºè¡¨æ ¼å®¹å™¨æ·»åŠ å³ä¾§ç©ºé—´ï¼Œä»¥å®¹çº³åˆ é™¤å›¾æ ‡ */
        .table-scroll {
            padding-right: 40px;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            padding: 2px 5px 15px 5px;
            margin: 2px 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e8e8e8;
        }

        .table-scroll {
            overflow-x: auto;
            overflow-y: auto;
            max-height: 70vh;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            width: 100%;
        }

        /* æ˜ç»†è¡¨æ ¼åŒºåŸŸ */
        #detailTableSection {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- è¾…åŠ©å…ƒç´ ï¼šç”¨äºå…¼å®¹åŸæœ‰JSä»£ç ä¸­çš„å¼•ç”¨ -->
        <input type="checkbox" id="projectDetail" style="display: none;">
        <input type="radio" name="workType" id="projectExpense" style="display: none;">

        <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
        <div class="form-row" style="margin-bottom: 15px;">
            <div class="work-type tab-navigation" style="margin-bottom: 0; border-bottom: 2px solid #ddd; display: flex; align-items: center; width: 100%;">
                <input type="radio" id="tabWorkRecord" name="workTab" value="è®°å·¥" checked>
                <label for="tabWorkRecord" class="work-type-option active">è®°å·¥</label>
                <input type="radio" id="tabWorkFlow" name="workTab" value="æ˜ç»†">
                <label for="tabWorkFlow" class="work-type-option">æ˜ç»†</label>
            </div>
        </div>

        <div class="form-row tab-work-content">
            <div>
                <label for="projectName">é¡¹ç›®ï¼š</label>
                <input type="text" id="projectName" readonly disabled style="background-color: #f8f9fa; cursor: not-allowed; color: #6c757d;">
            </div>
        </div>

        <div class="form-row" id="dateInputSection">
            <div>
                <label for="workDate"><span class="required-asterisk">*</span>æ—¥æœŸï¼š</label>
                <div class="date-input-container">
                    <input type="date" id="workDate" class="date-input">
                    <div id="dateDisplay" class="date-display"></div>
                </div>
            </div>
        </div>

        <!-- æ˜ç»†è¡¨æ ¼åŒºåŸŸ -->
        <div id="detailTableSection" class="table-container">
            <div class="table-scroll">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>åºå·</th>
                            <th>
                                æ—¥æœŸ <span id="dateFilterArrow" style="cursor: pointer; margin-left: 4px;">â–¼</span>
                                <select id="dateFilter" style="margin-left: 8px; padding: 2px 5px; font-size: 14px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.5); background: rgba(255,255,255,0.9); color: #333; opacity: 0; position: absolute; pointer-events: none; transition: all 0.3s ease; width: 80px;">
                                    <option value="">å…¨éƒ¨</option>
                                </select>
                            </th>
                            <th>
                                ç­ç»„ <span id="teamFilterArrow" style="cursor: pointer; margin-left: 4px;">â–¼</span>
                                <select id="teamFilter" style="margin-left: 8px; padding: 2px 5px; font-size: 14px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.5); background: rgba(255,255,255,0.9); color: #333; opacity: 0; position: absolute; pointer-events: none; transition: all 0.3s ease; width: 80px;">
                                    <option value="">å…¨éƒ¨</option>
                                </select>
                            </th>
                            <th>ç­ç»„é•¿</th>
                            <th>å·¥æ—¥</th>
                            <th>ç±»å‹</th>
                            <th>å•ä»·</th>
                            <th>é‡‘é¢</th>
                            <th class="work-content-header" style="max-width: 150px; width: 150px; white-space: normal; text-align: left; word-wrap: break-word;">å·¥ä½œå†…å®¹</th>
                            <th>å›¾ç‰‡</th>
                        </tr>
                    </thead>
                    <tbody id="detailTableBody">
                        <!-- è¡¨æ ¼å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="form-row tab-work-content">
            <div>
                <label for="teamName">ç­ç»„ï¼š</label>
                <input type="text" id="teamName" list="teamList" placeholder="é€‰æ‹©æˆ–è¾“å…¥ç­ç»„">
                <datalist id="teamList">
                    <option value="é’¢ç­‹ç­">
                    <option value="æœ¨å·¥ç­">
                    <option value="ç ¼å·¥ç­">
                    <option value="æ³¥æ°´ç­">
                    <option value="å¤–æ¶ç­">
                </datalist>

                <label for="teamLeader" style="margin-left: 10px;">ç­ç»„é•¿ï¼š</label>
                <input type="text" id="teamLeader" list="teamLeaderMemoryList" placeholder="è¾“å…¥ç­ç»„é•¿"
                       onfocus="this.setAttribute('placeholder', ''); loadTeamLeaderMemory();"
                       onblur="this.setAttribute('placeholder', 'è¾“å…¥ç­ç»„é•¿'); saveTeamLeaderToMemory();"
                       oninput="setTimeout(() => filterTeamLeaderMemory(), 100);"
                       autocomplete="on">
                <datalist id="teamLeaderMemoryList"></datalist>
            </div>
        </div>

        <!-- å·¥æ—¥è¾“å…¥åŒºåŸŸ -->
        <div class="form-row tab-work-content">
            <div>
                <label for="workDays">å·¥æ—¥ï¼š</label>
                <div class="work-days-wrapper">
                    <input type="number" id="workDays" placeholder="è¾“å…¥å·¥æ—¥" step="0.5" min="0" oninput="if(value<0)value=0">
                    <span id="workDaysUnit">ä¸ªå·¥</span>
                </div>

                <!-- æŠ€å·¥/æ™®å·¥åˆ‡æ¢æŒ‰é’® -->
                <div style="display: inline-block; vertical-align: middle; margin-left: 10px;">
                    <label class="checkbox-item" for="workerType" style="margin-right: 0;">
                        <input type="checkbox" id="workerType" checked>
                        <span class="custom-checkbox"></span>
                        <span></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- å•ä»·/é‡‘é¢è¾“å…¥åŒºåŸŸ -->
        <div class="form-row tab-work-content">
            <div>
                <label for="unitPrice">å•ä»·ï¼š</label>
                <div class="work-days-wrapper">
                    <input type="number" id="unitPrice" placeholder="è¾“å…¥å•ä»·" step="0.5" min="0" oninput="if(value<0)value=0">
                    <span id="unitPriceUnit">å…ƒ/å·¥</span>
                </div>

                <label for="amount" style="margin-left: 10px;">é‡‘é¢ï¼š</label>
                <div class="work-days-wrapper">
                    <input type="number" id="amount" placeholder="è¾“å…¥é‡‘é¢" step="0.5" min="0" oninput="if(value<0)value=0">
                    <span id="amountUnit">å…ƒ</span>
                </div>
            </div>
        </div>

        <!-- è¯´æ˜è¾“å…¥åŒºåŸŸ -->
        <div id="descriptionSection" class="form-row tab-work-content">
            <div>
                <label for="description" style="margin-bottom: 0; white-space: nowrap; font-weight: bold;">å·¥ä½œ<br>å†…å®¹ï¼š</label>
                <textarea id="description" placeholder="è¯·è¾“å…¥å·¥ä½œå†…å®¹"></textarea>
            </div>
        </div>

        <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
        <div id="imageSection" class="form-row tab-work-content">
            <div>
                <label style="font-weight: bold;">å›¾ç‰‡ï¼š</label>
                <input type="file" id="imageUpload" accept="image/*" style="display: none;">
            </div>
        </div>
        
        <!-- å›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡† -->
        <div id="imageModal" style="display: none;"></div>
    </div>

    <script>
        // æ—¥æœŸé€‰æ‹©å™¨æ¨¡æ€æ¡†HTML
        const datePickerModalHTML = `
            <div id="datePickerModal" class="modal" style="display: none;">
                <div class="date-picker-content">
                    <div class="date-picker-body">
                        <div class="calendar-header">
                            <button id="prevMonth" class="month-btn">&lt;</button>
                            <div style="display: flex; align-items: center; gap: 15px; flex: 1; justify-content: center;">
                                <button id="selectAllDates" class="month-btn" title="é€‰æ‹©å…¨éƒ¨æ—¥æœŸ" style="display: none;">ğŸ“‹ å…¨éƒ¨</button>
                                <span id="currentMonth" class="month-title"></span>
                                <button id="toggleMultiSelect" class="month-btn" title="åˆ‡æ¢å¤šé€‰æ¨¡å¼">ğŸ“…</button>
                            </div>
                            <button id="nextMonth" class="month-btn">&gt;</button>
                        </div>
                        <div class="calendar-grid">
                            <div class="weekdays">
                                <div>ä¸€</div>
                                <div>äºŒ</div>
                                <div>ä¸‰</div>
                                <div>å››</div>
                                <div>äº”</div>
                                <div>å…­</div>
                                <div>æ—¥</div>
                            </div>
                            <div class="calendar-days" id="calendarDays"></div>
                        </div>
                        <div id="multiSelectInfo" style="margin-top: 10px; padding: 10px; background-color: #f0f8ff; border-radius: 6px; display: none;">
                            <span style="color: #1890ff; font-size: 12px;">å¤šé€‰æ¨¡å¼ï¼šå¯é€‰æ‹©ä¸¤ä¸ªæ—¥æœŸä½œä¸ºèµ·æ­¢æ—¥æœŸ</span>
                        </div>
                    </div>

                    <!-- æœˆä»½é€‰æ‹©å™¨ -->
                    <div class="month-picker-overlay" id="monthPickerOverlay">
                        <div class="month-picker">
                            <div class="picker-header">
                                <button class="picker-year-btn" id="prevYear">&lt;</button>
                                <h3 id="pickerYear">2025</h3>
                                <button class="picker-year-btn" id="nextYear">&gt;</button>
                            </div>
                            <div class="month-grid" id="monthGrid">
                                <div class="month-item" data-month="0">1æœˆ</div>
                                <div class="month-item" data-month="1">2æœˆ</div>
                                <div class="month-item" data-month="2">3æœˆ</div>
                                <div class="month-item" data-month="3">4æœˆ</div>
                                <div class="month-item" data-month="4">5æœˆ</div>
                                <div class="month-item" data-month="5">6æœˆ</div>
                                <div class="month-item" data-month="6">7æœˆ</div>
                                <div class="month-item" data-month="7">8æœˆ</div>
                                <div class="month-item" data-month="8">9æœˆ</div>
                                <div class="month-item" data-month="9">10æœˆ</div>
                                <div class="month-item" data-month="10">11æœˆ</div>
                                <div class="month-item" data-month="11">12æœˆ</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // åœ¨bodyæœ«å°¾æ·»åŠ æ—¥æœŸé€‰æ‹©å™¨æ¨¡æ€æ¡†
        document.body.insertAdjacentHTML('beforeend', datePickerModalHTML);

        // æ ¼å¼åŒ–æ—¥æœŸä¸ºæ˜¾ç¤ºæ ¼å¼
        function formatDateForDisplay(dateStr) {
            const [year, month, day] = dateStr.split('-');
            return `${year}å¹´${parseInt(month)}æœˆ${parseInt(day)}æ—¥`;
        }

        // æ›´æ–°æ—¥æœŸæ˜¾ç¤ºï¼ˆåœ¨æ¡†å†…æ˜¾ç¤ºä»Šå¤©æ ‡è¯†ï¼‰
        function updateDateDisplay() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const formattedToday = `${yyyy}-${mm}-${dd}`;
            const workDateInput = document.getElementById('workDate');
            const dateDisplay = document.getElementById('dateDisplay');
            
            // æ£€æŸ¥æ˜¯å¦ä¸º"å…¨éƒ¨"çŠ¶æ€
            if (workDateInput.dataset.selectAll === 'true') {
                dateDisplay.innerHTML = 'å…¨éƒ¨';
                dateDisplay.classList.remove('today');
                workDateInput.removeAttribute('data-today');
                // æ¸…é™¤å…¶ä»–æ˜¾ç¤ºå€¼
                delete workDateInput.dataset.displayValue;
                return;
            }
            
            if (workDateInput.value) {
                // æ£€æŸ¥æ˜¯å¦æœ‰å¤šé€‰æ—¥æœŸçš„æ˜¾ç¤ºå€¼
                let displayText;
                if (workDateInput.dataset.displayValue) {
                    displayText = workDateInput.dataset.displayValue;
                } else {
                    // å•é€‰æ¨¡å¼ï¼Œæ ¼å¼åŒ–å•ä¸ªæ—¥æœŸ
                    displayText = formatDateForDisplay(workDateInput.value);
                    
                    // æ£€æŸ¥æ˜¯å¦ä¸ºä»Šå¤©
                    if (workDateInput.value === formattedToday) {
                        displayText += '<span class="today-text">ï¼ˆä»Šå¤©ï¼‰</span>';
                    }
                }
                
                dateDisplay.innerHTML = displayText;
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºä»Šå¤©ï¼ˆåªåœ¨å•é€‰æ¨¡å¼ä¸‹æ£€æŸ¥ï¼‰
                if (!workDateInput.dataset.displayValue && workDateInput.value === formattedToday) {
                    dateDisplay.classList.add('today');
                    workDateInput.setAttribute('data-today', 'true');
                } else {
                    dateDisplay.classList.remove('today');
                    workDateInput.removeAttribute('data-today');
                }
            } else {
                dateDisplay.innerHTML = 'è¯·é€‰æ‹©æ—¥æœŸ';
                dateDisplay.classList.remove('today');
                workDateInput.removeAttribute('data-today');
                // æ¸…é™¤å¤šé€‰æ˜¾ç¤ºå€¼å’Œå…¶ä»–çŠ¶æ€
                delete workDateInput.dataset.displayValue;
                delete workDateInput.dataset.selectAll;
            }
        }

        // è®¾ç½®å½“å‰æ—¥æœŸåˆ°æ—¥æœŸè¾“å…¥æ¡†å¹¶æ·»åŠ "ä»Šå¤©"æ ‡è¯†
        function setTodayDate() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const formattedToday = `${yyyy}-${mm}-${dd}`;
            const workDateInput = document.getElementById('workDate');
            
            // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
            workDateInput.value = formattedToday;
            
            // æ›´æ–°æ˜¾ç¤º
            updateDateDisplay();
        }

        // å¤„ç†æ—¥æœŸè¾“å…¥æ¡†äº¤äº’
        function setupDateInteraction() {
            const workDateInput = document.getElementById('workDate');
            
            // ç‚¹å‡»æ˜¾ç¤ºåŒºåŸŸæ—¶æ¿€æ´»è¾“å…¥æ¡†æˆ–æ‰“å¼€æ—¥æœŸé€‰æ‹©å™¨
            const dateDisplay = document.getElementById('dateDisplay');
            dateDisplay.addEventListener('click', function() {
                showDatePicker();
            });
            
            // è¾“å…¥æ¡†ç‚¹å‡»æ—¶æ‰“å¼€æ—¥æœŸé€‰æ‹©å™¨
            workDateInput.addEventListener('click', function(e) {
                e.preventDefault();
                showDatePicker();
            });
            
            // é˜²æ­¢åŸç”Ÿæ—¥æœŸè¾“å…¥æ¡†è·å¾—ç„¦ç‚¹
            workDateInput.addEventListener('focus', function(e) {
                e.preventDefault();
                this.blur(); // ç«‹å³å¤±å»ç„¦ç‚¹
                showDatePicker();
            });
            
            // æ—¥æœŸæ”¹å˜æ—¶æ›´æ–°æ˜¾ç¤º
            workDateInput.addEventListener('change', function() {
                updateDateDisplay();
            });
        }

        // æ—¥æœŸé€‰æ‹©å™¨çŠ¶æ€ç®¡ç†
        let datePickerState = {
            currentDate: new Date(),
            displayDate: new Date(),
            singleSelectedDate: null, // å•é€‰æ¨¡å¼ä¸‹çš„é€‰ä¸­æ—¥æœŸ
            multiSelectedDates: [], // å¤šé€‰æ¨¡å¼ä¸‹çš„é€‰ä¸­æ—¥æœŸæ•°ç»„
            isMultiSelect: false // æ˜¯å¦å¤šé€‰æ¨¡å¼
        };

        // æœˆä»½é€‰æ‹©å™¨çŠ¶æ€å˜é‡
        let selectedYear = datePickerState.displayDate.getFullYear();
        let selectedMonth = datePickerState.displayDate.getMonth();

        // æ˜¾ç¤ºæ—¥æœŸé€‰æ‹©å™¨
        function showDatePicker() {
            // ç«‹å³ä¿æŠ¤æ˜ç»†checkboxçŠ¶æ€ï¼Œé˜²æ­¢è¢«æ„å¤–é‡ç½®
            const detailCheckbox = document.getElementById('projectDetail');
            const activeWorkType = document.querySelector('input[name="workType"]:checked');
            
            const modal = document.getElementById('datePickerModal');
            modal.style.display = 'flex';
            
            // åˆå§‹åŒ–é€‰æ‹©å™¨çŠ¶æ€
            initializeDatePicker();
            
            // æ¸²æŸ“æ—¥å†
            renderCalendar();
            
            // è¿™é‡Œç®€åŒ–äº†åŸæœ‰çš„å¤æ‚ä¿æŠ¤é€»è¾‘ï¼Œå› ä¸ºç‚¹å·¥å•é¡µé¢ç»“æ„ç®€å•
        }

        // éšè—æ—¥æœŸé€‰æ‹©å™¨
        function hideDatePicker() {
            const modal = document.getElementById('datePickerModal');
            modal.style.display = 'none';
        }

        // åˆå§‹åŒ–æ—¥æœŸé€‰æ‹©å™¨
        function initializeDatePicker() {
            const workDateInput = document.getElementById('workDate');
            
            // æ£€æŸ¥å½“å‰æ ‡ç­¾çŠ¶æ€ - ç‚¹å·¥å•ç‰ˆæœ¬
            const activeTab = document.querySelector('input[name="workTab"]:checked');
            const isDetailActive = activeTab && activeTab.value === 'æ˜ç»†';
            
            // åœ¨æ˜ç»†æ ‡ç­¾é¡µé¢æ˜¾ç¤ºå¤šé€‰åŠŸèƒ½
            const shouldShowMultiSelect = isDetailActive;
            
            // æ§åˆ¶å¤šé€‰å›¾æ ‡çš„æ˜¾ç¤º/éšè—
            const toggleBtn = document.getElementById('toggleMultiSelect');
            const multiSelectInfo = document.getElementById('multiSelectInfo');
            const selectAllBtn = document.getElementById('selectAllDates');
            
            if (toggleBtn) {
                if (shouldShowMultiSelect) {
                    toggleBtn.style.setProperty('display', 'flex', 'important');
                    toggleBtn.style.setProperty('visibility', 'visible', 'important');
                    toggleBtn.style.setProperty('opacity', '1', 'important');
                    toggleBtn.style.setProperty('align-items', 'center', 'important');
                    toggleBtn.style.setProperty('justify-content', 'center', 'important');
                } else {
                    toggleBtn.style.setProperty('display', 'none', 'important');
                }
            }
            
            if (multiSelectInfo) {
                if (!shouldShowMultiSelect) {
                    multiSelectInfo.style.setProperty('display', 'none', 'important');
                }
            }
            
            // æ§åˆ¶å…¨éƒ¨æŒ‰é’®çš„æ˜¾ç¤º/éšè— - åªåœ¨å¤šé€‰æ¨¡å¼ä¸‹æ˜¾ç¤º
            if (selectAllBtn) {
                if (shouldShowMultiSelect) {
                    selectAllBtn.style.setProperty('display', 'flex', 'important');
                    selectAllBtn.style.setProperty('align-items', 'center', 'important');
                    selectAllBtn.style.setProperty('justify-content', 'center', 'important');
                    selectAllBtn.style.setProperty('visibility', 'visible', 'important');
                    selectAllBtn.style.setProperty('opacity', '1', 'important');
                } else {
                    selectAllBtn.style.setProperty('display', 'none', 'important');
                }
            }
            
            // æ§åˆ¶æœˆä»½æ ‡é¢˜æ ·å¼å’ŒåŠŸèƒ½ - åªåœ¨æ˜ç»†é¡µé¢å¯ç”¨
            const currentMonthEl = document.getElementById('currentMonth');
            if (currentMonthEl) {
                if (shouldShowMultiSelect) {
                    currentMonthEl.classList.add('month-title');
                } else {
                    currentMonthEl.classList.remove('month-title');
                }
            }
            
            // å¦‚æœä¸æ˜¯åœ¨å…è®¸å¤šé€‰çš„ç•Œé¢ï¼Œé‡ç½®ä¸ºå¤šé€‰çŠ¶æ€
            if (!shouldShowMultiSelect) {
                datePickerState.isMultiSelect = false;
            }
            
            // è®¾ç½®å½“å‰æ˜¾ç¤ºæ—¥æœŸ
            if (workDateInput.value) {
                datePickerState.displayDate = new Date(workDateInput.value + 'T00:00:00');
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºå…¨éƒ¨çŠ¶æ€
                if (workDateInput.dataset.selectAll === 'true') {
                    datePickerState.singleSelectedDate = null;
                    datePickerState.multiSelectedDates = [];
                    datePickerState.isMultiSelect = false;
                }
                // æ£€æŸ¥æ˜¯å¦æœ‰å¤šé€‰æ—¥æœŸ
                else if (shouldShowMultiSelect && workDateInput.dataset.displayValue && workDateInput.dataset.displayValue.includes('~')) {
                    const dates = workDateInput.dataset.displayValue.split(' ~ ');
                    if (dates.length === 2) {
                        datePickerState.multiSelectedDates = dates;
                        datePickerState.isMultiSelect = true;
                        if (toggleBtn) {
                            toggleBtn.innerHTML = 'ğŸ”¢';
                            toggleBtn.title = 'åˆ‡æ¢å•é€‰æ¨¡å¼';
                        }
                        if (multiSelectInfo) multiSelectInfo.style.setProperty('display', 'block', 'important');
                    }
                } else {
                    datePickerState.singleSelectedDate = workDateInput.value;
                    datePickerState.isMultiSelect = false;
                    if (toggleBtn) {
                        toggleBtn.innerHTML = 'ğŸ“…';
                        toggleBtn.title = 'åˆ‡æ¢å¤šé€‰æ¨¡å¼';
                    }
                }
            } else {
                datePickerState.displayDate = new Date();
                datePickerState.isMultiSelect = false;
                if (toggleBtn) {
                    toggleBtn.innerHTML = 'ğŸ“…';
                    toggleBtn.title = 'åˆ‡æ¢å¤šé€‰æ¨¡å¼';
                }
            }
            
            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            bindDatePickerEvents();
        }

        // ç»‘å®šæ—¥æœŸé€‰æ‹©å™¨äº‹ä»¶
        function bindDatePickerEvents() {
            // æ£€æŸ¥å½“å‰æ ‡ç­¾çŠ¶æ€ - ç‚¹å·¥å•ç‰ˆæœ¬
            const activeTab = document.querySelector('input[name="workTab"]:checked');
            const isDetailActive = activeTab && activeTab.value === 'æ˜ç»†';
            const shouldShowMultiSelect = isDetailActive;
            
            // å¤šé€‰åˆ‡æ¢æŒ‰é’®
            const toggleBtn = document.getElementById('toggleMultiSelect');
            if (toggleBtn) toggleBtn.onclick = toggleMultiSelect;
            
            // æœˆä»½åˆ‡æ¢
            document.getElementById('prevMonth').onclick = () => changeMonth(-1);
            document.getElementById('nextMonth').onclick = () => changeMonth(1);
            
            // å…¨éƒ¨æŒ‰é’®
            const selectAllBtn = document.getElementById('selectAllDates');
            if (selectAllBtn) {
                selectAllBtn.onclick = selectAllDates;
            }
            
            // æœˆä»½æ ‡é¢˜ç‚¹å‡»äº‹ä»¶
            const currentMonthEl = document.getElementById('currentMonth');
            if (currentMonthEl) {
                if (shouldShowMultiSelect) {
                    currentMonthEl.onclick = showMonthPicker;
                    currentMonthEl.classList.add('month-title');
                } else {
                    currentMonthEl.onclick = null;
                    currentMonthEl.classList.remove('month-title');
                }
            }
            
            // æœˆä»½é€‰æ‹©å™¨äº‹ä»¶
            // ç§»é™¤æ¡ä»¶åˆ¤æ–­ï¼Œç¡®ä¿æœˆä»½é€‰æ‹©åŠŸèƒ½åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½èƒ½æ­£å¸¸å·¥ä½œ
            const prevYearBtn = document.getElementById('prevYear');
            const nextYearBtn = document.getElementById('nextYear');
            const monthPickerOverlay = document.getElementById('monthPickerOverlay');
            
            if (prevYearBtn) prevYearBtn.onclick = () => changePickerYear(-1);
            if (nextYearBtn) nextYearBtn.onclick = () => changePickerYear(1);
            
            if (monthPickerOverlay) {
                monthPickerOverlay.addEventListener('click', function(e) {
                    if (e.target === monthPickerOverlay) {
                        hideMonthPicker();
                    }
                });
            }
            
            const monthItems = document.querySelectorAll('.month-item');
            monthItems.forEach(item => {
                item.onclick = function() {
                    const month = parseInt(this.dataset.month);
                    selectMonth(month);
                };
            });
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            const modal = document.getElementById('datePickerModal');
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    hideDatePicker();
                }
            });
        }

        // æ˜¾ç¤ºæœˆä»½é€‰æ‹©å™¨
        function showMonthPicker() {
            const monthPickerOverlay = document.getElementById('monthPickerOverlay');
            const pickerYearEl = document.getElementById('pickerYear');
            const monthItems = document.querySelectorAll('.month-item');
            
            if (monthPickerOverlay && pickerYearEl) {
                selectedYear = datePickerState.displayDate.getFullYear();
                selectedMonth = datePickerState.displayDate.getMonth();
                pickerYearEl.textContent = selectedYear;
                
                // è·å–å½“å‰æ—¥æœŸ
                const today = new Date();
                const currentYear = today.getFullYear();
                const currentMonth = today.getMonth();
                
                monthItems.forEach(item => {
                    item.classList.remove('selected');
                    item.classList.remove('disabled');
                    item.style.cursor = 'pointer';
                    item.style.opacity = '1';
                    item.style.pointerEvents = 'auto';
                    
                    const month = parseInt(item.dataset.month);
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æœªæ¥æœˆä»½
                    if (selectedYear > currentYear || (selectedYear === currentYear && month > currentMonth)) {
                        // æœªæ¥æœˆä»½ï¼Œç°è‰²æ˜¾ç¤ºå¹¶ä¸å¯é€‰æ‹©
                        item.classList.add('disabled');
                        item.style.cursor = 'not-allowed';
                        item.style.opacity = '0.5';
                        item.style.pointerEvents = 'none';
                    } else if (month === selectedMonth) {
                        item.classList.add('selected');
                    }
                });
                
                monthPickerOverlay.style.display = 'flex';
            }
        }
        
        // éšè—æœˆä»½é€‰æ‹©å™¨
        function hideMonthPicker() {
            const monthPickerOverlay = document.getElementById('monthPickerOverlay');
            if (monthPickerOverlay) {
                monthPickerOverlay.style.display = 'none';
            }
        }
        
        // æ”¹å˜å¹´ä»½é€‰æ‹©å™¨çš„å¹´ä»½
        function changePickerYear(delta) {
            const pickerYearEl = document.getElementById('pickerYear');
            if (pickerYearEl) {
                selectedYear += delta;
                pickerYearEl.textContent = selectedYear;
                
                // æ›´æ–°æœˆä»½ç¦ç”¨çŠ¶æ€
                const monthItems = document.querySelectorAll('.month-item');
                const today = new Date();
                const currentYear = today.getFullYear();
                const currentMonth = today.getMonth();
                
                monthItems.forEach(item => {
                    item.classList.remove('disabled');
                    item.style.cursor = 'pointer';
                    item.style.opacity = '1';
                    item.style.pointerEvents = 'auto';
                    
                    const month = parseInt(item.dataset.month);
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æœªæ¥æœˆä»½
                    if (selectedYear > currentYear || (selectedYear === currentYear && month > currentMonth)) {
                        // æœªæ¥æœˆä»½ï¼Œç°è‰²æ˜¾ç¤ºå¹¶ä¸å¯é€‰æ‹©
                        item.classList.add('disabled');
                        item.style.cursor = 'not-allowed';
                        item.style.opacity = '0.5';
                        item.style.pointerEvents = 'none';
                    }
                });
            }
        }
        
        // é€‰æ‹©æœˆä»½
        function selectMonth(month) {
            const pickerYearEl = document.getElementById('pickerYear');
            if (pickerYearEl) {
                const selectedYear = parseInt(pickerYearEl.textContent);
                datePickerState.displayDate = new Date(selectedYear, month);
                const firstDay = new Date(selectedYear, month, 1);
                const lastDay = new Date(selectedYear, month + 1, 0);
                
                const formatDate = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };
                
                const startDate = formatDate(firstDay);
                const endDate = formatDate(lastDay);
                
                const workDateInput = document.getElementById('workDate');
                workDateInput.value = startDate;
                workDateInput.dataset.displayValue = `${startDate} ~ ${endDate}`;
                delete workDateInput.dataset.selectAll;
                
                updateDateDisplay();
                workDateInput.dispatchEvent(new Event('change', { bubbles: true }));
                renderCalendar();
                hideMonthPicker();
                hideDatePicker();
            }
        }

        // é€‰æ‹©å…¨éƒ¨æ—¥æœŸ
        function selectAllDates() {
            const workDateInput = document.getElementById('workDate');
            workDateInput.value = '';
            delete workDateInput.dataset.displayValue;
            workDateInput.dataset.selectAll = 'true';
            updateDateDisplay();
            workDateInput.dispatchEvent(new Event('change', { bubbles: true }));
            hideDatePicker();
        }

        // åˆ‡æ¢å¤šé€‰æ¨¡å¼
        function toggleMultiSelect() {
            // æ£€æŸ¥å½“å‰æ ‡ç­¾çŠ¶æ€ - ç‚¹å·¥å•ç‰ˆæœ¬
            const activeTab = document.querySelector('input[name="workTab"]:checked');
            const isDetailActive = activeTab && activeTab.value === 'æ˜ç»†';
            
            if (!isDetailActive) return;
            
            datePickerState.isMultiSelect = !datePickerState.isMultiSelect;
            
            const toggleBtn = document.getElementById('toggleMultiSelect');
            const multiSelectInfo = document.getElementById('multiSelectInfo');
            const selectAllBtn = document.getElementById('selectAllDates');
            
            if (datePickerState.isMultiSelect) {
                toggleBtn.innerHTML = 'ğŸ”¢';
                toggleBtn.title = 'åˆ‡æ¢å•é€‰æ¨¡å¼';
                multiSelectInfo.style.setProperty('display', 'block', 'important');
                if (selectAllBtn) selectAllBtn.style.setProperty('display', 'flex', 'important');
                datePickerState.multiSelectedDates = [];
                datePickerState.singleSelectedDate = null;
            } else {
                toggleBtn.innerHTML = 'ğŸ“…';
                toggleBtn.title = 'åˆ‡æ¢å¤šé€‰æ¨¡å¼';
                if (selectAllBtn) selectAllBtn.style.setProperty('display', 'none', 'important');
                multiSelectInfo.style.setProperty('display', 'none', 'important');
                datePickerState.multiSelectedDates = [];
                datePickerState.singleSelectedDate = null;
            }
            renderCalendar();
        }

        // æ¸²æŸ“æ—¥å†
        function renderCalendar() {
            const currentMonthEl = document.getElementById('currentMonth');
            const calendarDays = document.getElementById('calendarDays');
            
            const year = datePickerState.displayDate.getFullYear();
            const month = datePickerState.displayDate.getMonth();
            
            currentMonthEl.textContent = `${year}å¹´${month + 1}æœˆ`;
            updateMonthNavigationButtons(year, month);
            
            calendarDays.innerHTML = '';
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const firstDayOfWeek = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
            const daysInMonth = lastDay.getDate();
            
            const prevMonth = new Date(year, month - 1, 0);
            const daysInPrevMonth = prevMonth.getDate();
            
            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                const dateStr = formatDate(year, month - 1, day);
                const dayEl = createDayElement(day, true, dateStr);
                calendarDays.appendChild(dayEl);
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = formatDate(year, month, day);
                const dayEl = createDayElement(day, false, dateStr);
                calendarDays.appendChild(dayEl);
            }
            
            const totalCells = calendarDays.children.length;
            const remainingCells = 42 - totalCells;
            for (let day = 1; day <= remainingCells; day++) {
                const dateStr = formatDate(year, month + 1, day);
                const dayEl = createDayElement(day, true, dateStr);
                calendarDays.appendChild(dayEl);
            }
        }

        // æ›´æ–°æœˆä»½å¯¼èˆªæŒ‰é’®çŠ¶æ€
        function updateMonthNavigationButtons(year, month) {
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();
            const nextMonthBtn = document.getElementById('nextMonth');
            
            if (year > currentYear || (year === currentYear && month >= currentMonth)) {
                nextMonthBtn.disabled = true;
                nextMonthBtn.style.opacity = '0.3';
                nextMonthBtn.style.cursor = 'not-allowed';
            } else {
                nextMonthBtn.disabled = false;
                nextMonthBtn.style.opacity = '1';
                nextMonthBtn.style.cursor = 'pointer';
            }
        }

        // å†œå†è½¬æ¢
        function getLunarCalendar(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const lunarDays = ['åˆä¸€', 'åˆäºŒ', 'åˆä¸‰', 'åˆå››', 'åˆäº”', 'åˆå…­', 'åˆä¸ƒ', 'åˆå…«', 'åˆä¹', 'åˆå',
                              'åä¸€', 'åäºŒ', 'åä¸‰', 'åå››', 'åäº”', 'åå…­', 'åä¸ƒ', 'åå…«', 'åä¹', 'äºŒå',
                              'å»¿ä¸€', 'å»¿äºŒ', 'å»¿ä¸‰', 'å»¿å››', 'å»¿äº”', 'å»¿å…­', 'å»¿ä¸ƒ', 'å»¿å…«', 'å»¿ä¹', 'ä¸‰å'];
            const offset = (year - 2000) * 12 + month;
            const lunarDayIndex = (day + offset) % 30;
            return `${lunarDays[lunarDayIndex]}`;
        }

        // åˆ›å»ºæ—¥æœŸå…ƒç´ 
        function createDayElement(day, isOtherMonth, dateStr) {
            const dayEl = document.createElement('div');
            dayEl.className = 'day-cell';
            dayEl.dataset.date = dateStr;
            
            const dayContent = document.createElement('div');
            dayContent.style.display = 'flex';
            dayContent.style.flexDirection = 'column';
            dayContent.style.alignItems = 'center';
            dayContent.style.justifyContent = 'center';
            dayContent.style.height = '100%';
            dayContent.style.padding = '5px';
            
            const dayNumber = document.createElement('span');
            dayNumber.textContent = day;
            dayNumber.style.fontSize = '14px';
            dayNumber.style.fontWeight = 'bold';
            dayContent.appendChild(dayNumber);
            
            if (!isOtherMonth) {
                const lunarCalendar = getLunarCalendar(dateStr);
                const lunarElement = document.createElement('span');
                lunarElement.textContent = lunarCalendar;
                lunarElement.style.fontSize = '10px';
                lunarElement.style.color = '#999';
                lunarElement.style.marginTop = '2px';
                dayContent.appendChild(lunarElement);
            }
            
            dayEl.appendChild(dayContent);
            
            if (isOtherMonth) {
                dayEl.classList.add('other-month');
                return dayEl;
            }
            
            const today = new Date();
            const todayStr = formatDate(today.getFullYear(), today.getMonth(), today.getDate());
            if (dateStr === todayStr) {
                dayEl.classList.add('today');
            }
            
            const selectedDate = new Date(dateStr + 'T00:00:00');
            if (selectedDate > today) {
                dayEl.classList.add('disabled-future');
                dayEl.style.cursor = 'not-allowed';
                return dayEl;
            }
            
            if (!datePickerState.isMultiSelect && dateStr === datePickerState.singleSelectedDate) {
                dayEl.classList.add('selected-single');
            }
            
            if (datePickerState.isMultiSelect && datePickerState.multiSelectedDates.includes(dateStr)) {
                dayEl.classList.add('selected-multi');
            }
            
            dayEl.addEventListener('click', () => selectDate(dateStr));
            return dayEl;
        }

        // é€‰æ‹©æ—¥æœŸ
        function selectDate(dateStr) {
            if (datePickerState.isMultiSelect) {
                const index = datePickerState.multiSelectedDates.indexOf(dateStr);
                if (index > -1) {
                    datePickerState.multiSelectedDates.splice(index, 1);
                } else {
                    if (datePickerState.multiSelectedDates.length < 2) {
                        datePickerState.multiSelectedDates.push(dateStr);
                        datePickerState.multiSelectedDates.sort();
                    } else {
                        datePickerState.multiSelectedDates[0] = datePickerState.multiSelectedDates[1];
                        datePickerState.multiSelectedDates[1] = dateStr;
                    }
                }
                
                if (datePickerState.multiSelectedDates.length === 2) {
                    const startDate = datePickerState.multiSelectedDates[0];
                    const endDate = datePickerState.multiSelectedDates[1];
                    const workDateInput = document.getElementById('workDate');
                    workDateInput.value = startDate;
                    workDateInput.dataset.displayValue = `${startDate} ~ ${endDate}`;
                    delete workDateInput.dataset.selectAll;
                    updateDateDisplay();
                    workDateInput.dispatchEvent(new Event('change', { bubbles: true }));
                    setTimeout(() => { hideDatePicker(); }, 500);
                }
            } else {
                datePickerState.singleSelectedDate = dateStr;
                const workDateInput = document.getElementById('workDate');
                workDateInput.value = dateStr;
                delete workDateInput.dataset.displayValue;
                delete workDateInput.dataset.selectAll;
                updateDateDisplay();
                workDateInput.dispatchEvent(new Event('change', { bubbles: true }));
                hideDatePicker();
            }
            renderCalendar();
        }

        // æ”¹å˜æœˆä»½
        function changeMonth(delta) {
            const newDate = new Date(datePickerState.displayDate);
            newDate.setMonth(newDate.getMonth() + delta);
            
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();
            const newYear = newDate.getFullYear();
            const newMonth = newDate.getMonth();
            
            if (newYear > currentYear || (newYear === currentYear && newMonth > currentMonth)) {
                return;
            }
            
            datePickerState.displayDate = newDate;
            renderCalendar();
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(year, month, day) {
            const adjustedMonth = month < 0 ? 11 : (month > 11 ? 0 : month);
            const adjustedYear = month < 0 ? year - 1 : (month > 11 ? year + 1 : year);
            const yyyy = adjustedYear;
            const mm = String(adjustedMonth + 1).padStart(2, '0');
            const dd = String(day).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }
        
        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // é€šçŸ¥çˆ¶é¡µé¢æ›´æ–°æ ‡é¢˜
            if (window.parent && window.parent !== window) {
                const targetOrigin = window.location.origin || '*';
                window.parent.postMessage({
                    type: 'updateTitle',
                    page: 'ç‚¹å·¥å•.html'
                }, targetOrigin);
            }

            setTodayDate();
            setupDateInteraction();

            // æ ‡ç­¾åˆ‡æ¢å¤„ç†
            const tabRadios = document.querySelectorAll('input[name="workTab"]');
            const tabLabels = document.querySelectorAll('.work-type-option');
            const tabWorkContent = document.querySelectorAll('.tab-work-content');

            window.updateTabContent = function(selectedValue) {
                const detailTableSection = document.getElementById('detailTableSection');
                const bottomButtons = document.querySelector('.bottom-buttons');
                const totalAmountDisplay = document.getElementById('totalAmountDisplay');
                const tabWorkContent = document.querySelectorAll('.tab-work-content');

                if (selectedValue === 'æ˜ç»†') {
                    // éšè—è®°å·¥ç›¸å…³å†…å®¹
                    tabWorkContent.forEach(element => {
                        element.style.display = 'none';
                    });
                    
                    // å¦‚æœæ­£åœ¨ç¼–è¾‘æ¨¡å¼ï¼Œé€€å‡ºç¼–è¾‘æ¨¡å¼
                    if (window.isEditMode) {
                        exitEditMode();
                    }
                    
                    // æ˜¾ç¤ºæ˜ç»†è¡¨æ ¼
                    detailTableSection.style.display = 'block';
                    // éšè—ä¿å­˜æŒ‰é’®
                    if (bottomButtons) bottomButtons.style.display = 'none';
                    // æ˜¾ç¤ºåˆè®¡å’Œç”ŸæˆPDFæŒ‰é’®
                    if (totalAmountDisplay) totalAmountDisplay.style.display = 'flex';
                    // åŠ è½½æ˜ç»†æ•°æ®
                    loadDetailData();
                } else {
                    // æ˜¾ç¤ºæ‰€æœ‰è®°å·¥ç›¸å…³å†…å®¹
                    tabWorkContent.forEach(element => {
                        element.style.display = '';
                    });
                    // éšè—æ˜ç»†è¡¨æ ¼
                    detailTableSection.style.display = 'none';
                    // æ˜¾ç¤ºä¿å­˜æŒ‰é’®
                    if (bottomButtons) bottomButtons.style.display = 'flex';
                    // éšè—åˆè®¡å’Œç”ŸæˆPDFæŒ‰é’®
                    if (totalAmountDisplay) totalAmountDisplay.style.display = 'none';
                }
            };

            function updateTabContent(selectedValue) {
                window.updateTabContent(selectedValue);
            }

            tabRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    // ç§»é™¤æ‰€æœ‰labelçš„activeç±»
                    tabLabels.forEach(label => {
                        label.classList.remove('active');
                    });
                    // ä¸ºé€‰ä¸­çš„labelæ·»åŠ activeç±»
                    const selectedLabel = document.querySelector(`label[for="${this.id}"]`);
                    if (selectedLabel) {
                        selectedLabel.classList.add('active');
                    }
                    // æ›´æ–°å†…å®¹æ˜¾ç¤º
                    updateTabContent(this.value);
                });
            });

            // æ·»åŠ æ—¥æœŸå˜æ›´äº‹ä»¶ç›‘å¬å™¨ï¼Œå½“åœ¨æ˜ç»†ç•Œé¢å˜æ›´æ—¥æœŸæ—¶åˆ·æ–°æ•°æ®
            const workDateInput = document.getElementById('workDate');
            workDateInput.addEventListener('change', function() {
                // æ£€æŸ¥å½“å‰æ˜¯å¦åœ¨æ˜ç»†æ ‡ç­¾é¡µé¢
                const activeTab = document.querySelector('input[name="workTab"]:checked');
                if (activeTab && activeTab.value === 'æ˜ç»†') {
                    // å»¶è¿ŸåŠ è½½ï¼Œç¡®ä¿æ—¥æœŸå€¼å·²æ›´æ–°
                    setTimeout(() => {
                        loadDetailData();
                    }, 100);
                }
            });

            // æ·»åŠ æ—¥æœŸèŒƒå›´å˜æ›´äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
            // ç›‘å¬æ—¥æœŸé€‰æ‹©å™¨çš„ç¡®è®¤äº‹ä»¶
            document.addEventListener('datePickerConfirm', function() {
                // æ£€æŸ¥å½“å‰æ˜¯å¦åœ¨æ˜ç»†æ ‡ç­¾é¡µé¢
                const activeTab = document.querySelector('input[name="workTab"]:checked');
                if (activeTab && activeTab.value === 'æ˜ç»†') {
                    setTimeout(() => {
                        loadDetailData();
                    }, 100);
                }
            });

            // åˆå§‹åŒ–ç­›é€‰åŠŸèƒ½
            initializeFiltering();
            
            // ç®€å•çš„é¡¹ç›®åç§°è·å–é€»è¾‘
            const urlParams = new URLSearchParams(window.location.search);
            const projectIdFromUrl = urlParams.get('project_id');
            const storedName = localStorage.getItem('currentProjectName');
            const storedId = localStorage.getItem('currentProjectId');
            
            // å¤„ç†ä»äº‘ç›¸å†Œè·³è½¬è¿‡æ¥çš„å‚æ•°
            const workDateFromUrl = urlParams.get('work_date');
            const showDetailFromUrl = urlParams.get('show_detail');

            // ä¼˜å…ˆå¤„ç†æ˜ç»†æ ‡ç­¾åˆ‡æ¢
            if (showDetailFromUrl === 'true') {
                // ç«‹å³è®¾ç½®æ˜ç»†æ ‡ç­¾é€‰ä¸­
                const detailTab = document.querySelector('input[name="workTab"][value="æ˜ç»†"]');
                const workTab = document.querySelector('input[name="workTab"][value="è®°å·¥"]');
                
                if (detailTab) {
                    detailTab.checked = true;
                    if (workTab) workTab.checked = false;
                    
                    // é¢å¤–ç¡®ä¿UIæ›´æ–°
                    const tabLabels = document.querySelectorAll('.work-type-option');
                    tabLabels.forEach(label => label.classList.remove('active'));
                    const selectedLabel = document.querySelector(`label[for="${detailTab.id}"]`);
                    if (selectedLabel) selectedLabel.classList.add('active');
                    
                    // ç«‹å³éšè—è®°å·¥ç›¸å…³å†…å®¹ï¼Œæ˜¾ç¤ºæ˜ç»†ç›¸å…³å†…å®¹
                    const detailTableSection = document.getElementById('detailTableSection');
                    const tabWorkContent = document.querySelectorAll('.tab-work-content');
                    const bottomButtons = document.querySelector('.bottom-buttons');
                    const totalAmountDisplay = document.getElementById('totalAmountDisplay');
                    
                    // éšè—è®°å·¥å†…å®¹
                    tabWorkContent.forEach(element => element.style.display = 'none');
                    // æ˜¾ç¤ºæ˜ç»†å†…å®¹
                    if (detailTableSection) detailTableSection.style.display = 'block';
                    // éšè—ä¿å­˜æŒ‰é’®
                    if (bottomButtons) bottomButtons.style.display = 'none';
                    // æ˜¾ç¤ºåˆè®¡
                    if (totalAmountDisplay) totalAmountDisplay.style.display = 'flex';
                }
            }

            if (workDateFromUrl) {
                const workDateInput = document.getElementById('workDate');
                if (workDateInput) {
                    workDateInput.value = workDateFromUrl;
                    // è§¦å‘changeäº‹ä»¶ä»¥æ›´æ–°ç›¸å…³é€»è¾‘
                    workDateInput.dispatchEvent(new Event('change'));
                }
            }

            if (showDetailFromUrl === 'true') {
                // å»¶è¿Ÿå†æ¬¡è§¦å‘ä»¥ç¡®ä¿æ•°æ®åŠ è½½
                setTimeout(() => {
                    if (window.updateTabContent) {
                        window.updateTabContent('æ˜ç»†');
                    }
                }, 100);
            }

            // å¦‚æœURLä¸­æœ‰IDï¼Œä¸”ä¸å­˜å‚¨çš„IDä¸€è‡´ï¼Œåˆ™ä½¿ç”¨å­˜å‚¨çš„åç§°
            if (projectIdFromUrl && projectIdFromUrl === storedId && storedName) {
                document.getElementById('projectName').value = storedName;
            } else if (storedName) {
                // å¦‚æœURLä¸­æ²¡æœ‰IDï¼Œä½†æœ¬åœ°æœ‰å­˜å‚¨ï¼Œä¹Ÿå¡«å……ï¼ˆæˆ–è€…ä½ å¯ä»¥å†³å®šæ¸…ç©ºï¼‰
                // è¿™é‡Œä¸ºäº†æ–¹ä¾¿ï¼Œå¦‚æœURLæ²¡æœ‰IDï¼Œæˆ‘ä»¬å‡è®¾ç”¨æˆ·æ˜¯æƒ³ç»§ç»­æ“ä½œä¸Šæ¬¡çš„é¡¹ç›®
                 document.getElementById('projectName').value = storedName;
            }
            
            // æ³¨æ„ï¼šè¿™é‡Œæ²¡æœ‰å®ç°ä»Supabaseæ ¹æ®IDæŸ¥åç§°çš„é€»è¾‘ï¼Œå› ä¸ºéœ€è¦å¼•å…¥project_finance_api.jsä¸­çš„projectså˜é‡
            // å¦‚æœéœ€è¦å®Œæ•´åŠŸèƒ½ï¼Œå»ºè®®ç¡®ä¿projectså˜é‡å·²åŠ è½½

            // ç­ç»„è¾“å…¥æ¡†äº¤äº’é€»è¾‘
            const teamInput = document.getElementById('teamName');
            
            function updateTeamInputStyle() {
                if (teamInput.value && teamInput.value.trim() !== '') {
                    teamInput.classList.add('has-value');
                } else {
                    teamInput.classList.remove('has-value');
                }
            }
            
            // ç›‘å¬è¾“å…¥å’Œå˜åŒ–äº‹ä»¶
            teamInput.addEventListener('input', updateTeamInputStyle);
            teamInput.addEventListener('change', updateTeamInputStyle);
            
            // åˆå§‹åŒ–æ£€æŸ¥
            updateTeamInputStyle();

            // ç­ç»„é•¿è¾“å…¥æ¡†äº¤äº’é€»è¾‘
            const teamLeaderInput = document.getElementById('teamLeader');
            
            function updateTeamLeaderInputStyle() {
                if (teamLeaderInput.value && teamLeaderInput.value.trim() !== '') {
                    teamLeaderInput.classList.add('has-value');
                } else {
                    teamLeaderInput.classList.remove('has-value');
                }
            }
            
            teamLeaderInput.addEventListener('input', updateTeamLeaderInputStyle);
            teamLeaderInput.addEventListener('change', updateTeamLeaderInputStyle);
            updateTeamLeaderInputStyle();

            // å·¥æ—¥è¾“å…¥æ¡†äº¤äº’é€»è¾‘
            const workDaysInput = document.getElementById('workDays');
            const workDaysUnit = document.getElementById('workDaysUnit');
            
            function updateWorkDaysInputStyle() {
                if (workDaysInput.value && workDaysInput.value.trim() !== '') {
                    workDaysInput.classList.add('has-value');
                } else {
                    workDaysInput.classList.remove('has-value');
                }
            }
            
            workDaysInput.addEventListener('input', updateWorkDaysInputStyle);
            workDaysInput.addEventListener('change', updateWorkDaysInputStyle);
            updateWorkDaysInputStyle();

            // å•ä»·è¾“å…¥æ¡†äº¤äº’é€»è¾‘
            const unitPriceInput = document.getElementById('unitPrice');

            function updateUnitPriceInputStyle() {
                if (unitPriceInput.value && unitPriceInput.value.trim() !== '') {
                    unitPriceInput.classList.add('has-value');
                } else {
                    unitPriceInput.classList.remove('has-value');
                }
                // è§¦å‘é‡‘é¢è®¡ç®—
                calculateAmount();
            }

            unitPriceInput.addEventListener('input', updateUnitPriceInputStyle);
            unitPriceInput.addEventListener('change', updateUnitPriceInputStyle);
            updateUnitPriceInputStyle();

            // é‡‘é¢è¾“å…¥æ¡†äº¤äº’é€»è¾‘
            const amountInput = document.getElementById('amount');

            function updateAmountInputStyle() {
                if (amountInput.value && amountInput.value.trim() !== '') {
                    amountInput.classList.add('has-value');
                } else {
                    amountInput.classList.remove('has-value');
                }
            }

            // è‡ªåŠ¨è®¡ç®—é‡‘é¢
            function calculateAmount() {
                const workDays = parseFloat(workDaysInput.value) || 0;
                const unitPrice = parseFloat(unitPriceInput.value) || 0;

                // è®¡ç®—é‡‘é¢
                const amount = workDays * unitPrice;

                // å¦‚æœæœ‰å·¥æ—¥å’Œå•ä»·ï¼Œåˆ™æ›´æ–°é‡‘é¢
                if (workDays > 0 && unitPrice > 0) {
                    // å››èˆäº”å…¥åˆ°ä¸€ä½å°æ•°
                    const roundedAmount = Math.round(amount * 10) / 10;

                    // å¦‚æœé‡‘é¢æ˜¯æ•´æ•°ï¼Œæ˜¾ç¤ºä¸ºæ•´æ•°ï¼›å¦åˆ™ä¿ç•™ä¸€ä½å°æ•°
                    if (roundedAmount === Math.floor(roundedAmount)) {
                        amountInput.value = roundedAmount.toString();
                    } else {
                        amountInput.value = roundedAmount.toFixed(1);
                    }
                    updateAmountInputStyle();
                }
            }

            // ä¸ºå·¥æ—¥è¾“å…¥æ¡†æ·»åŠ è®¡ç®—äº‹ä»¶
            workDaysInput.addEventListener('input', calculateAmount);
            workDaysInput.addEventListener('change', calculateAmount);

            amountInput.addEventListener('input', updateAmountInputStyle);
            amountInput.addEventListener('change', updateAmountInputStyle);
            updateAmountInputStyle();

            // å·¥ä½œå†…å®¹è¾“å…¥æ¡†äº¤äº’é€»è¾‘
            const descriptionInput = document.getElementById('description');
            
            function updateDescriptionInputStyle() {
                if (descriptionInput.value && descriptionInput.value.trim() !== '') {
                    descriptionInput.classList.add('has-value');
                } else {
                    descriptionInput.classList.remove('has-value');
                }
            }
            
            descriptionInput.addEventListener('input', updateDescriptionInputStyle);
            descriptionInput.addEventListener('change', updateDescriptionInputStyle);
            updateDescriptionInputStyle();

            // åˆå§‹åŒ–å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½
            initializeImageUpload();
        });
        
        // ç­ç»„é•¿è®°å¿†åŠŸèƒ½ç›¸å…³å‡½æ•°
        function loadTeamLeaderMemory() {
            const memoryList = document.getElementById('teamLeaderMemoryList');
            const savedLeaders = JSON.parse(localStorage.getItem('teamLeaderMemory') || '[]');
            memoryList.innerHTML = '';
            savedLeaders.forEach(leader => {
                const option = document.createElement('option');
                option.value = leader;
                memoryList.appendChild(option);
            });
        }

        function saveTeamLeaderToMemory() {
            const leaderInput = document.getElementById('teamLeader');
            const leader = leaderInput.value.trim();
            if (leader) {
                const savedLeaders = JSON.parse(localStorage.getItem('teamLeaderMemory') || '[]');
                if (!savedLeaders.includes(leader)) {
                    savedLeaders.push(leader);
                    // é™åˆ¶è®°å¿†æ¡æ•°
                    if (savedLeaders.length > 10) {
                        savedLeaders.shift();
                    }
                    localStorage.setItem('teamLeaderMemory', JSON.stringify(savedLeaders));
                }
            }
        }

        function filterTeamLeaderMemory() {
            const leaderInput = document.getElementById('teamLeader');
            const value = leaderInput.value.toLowerCase();
            const memoryList = document.getElementById('teamLeaderMemoryList');
            const savedLeaders = JSON.parse(localStorage.getItem('teamLeaderMemory') || '[]');
            memoryList.innerHTML = '';
            savedLeaders.filter(leader => leader.toLowerCase().includes(value)).forEach(leader => {
                const option = document.createElement('option');
                option.value = leader;
                memoryList.appendChild(option);
            });
        }

        // åˆå§‹åŒ–ç­›é€‰åŠŸèƒ½
        function initializeFiltering() {
            // æ—¥æœŸç­›é€‰
            const dateFilterArrow = document.getElementById('dateFilterArrow');
            const dateFilter = document.getElementById('dateFilter');
            
            if (dateFilterArrow && dateFilter) {
                dateFilter.addEventListener('change', function() {
                    // åº”ç”¨ç­›é€‰
                    applyFilters();
                });

                dateFilterArrow.addEventListener('click', function() {
                    dateFilter.style.opacity = '1';
                    dateFilter.style.pointerEvents = 'auto';
                    dateFilter.focus();
                    if (typeof dateFilter.showPicker === 'function') {
                        dateFilter.showPicker();
                    } else {
                        dateFilter.click();
                    }
                });

                dateFilter.addEventListener('blur', function() {
                    dateFilter.style.opacity = '0';
                    dateFilter.style.pointerEvents = 'none';
                });
            }
            
            // ç­ç»„ç­›é€‰
            const teamFilterArrow = document.getElementById('teamFilterArrow');
            const teamFilter = document.getElementById('teamFilter');
            
            if (teamFilterArrow && teamFilter) {
                teamFilter.addEventListener('change', function() {
                    // åº”ç”¨ç­›é€‰
                    applyFilters();
                });

                teamFilterArrow.addEventListener('click', function() {
                    teamFilter.style.opacity = '1';
                    teamFilter.style.pointerEvents = 'auto';
                    teamFilter.focus();
                    if (typeof teamFilter.showPicker === 'function') {
                        teamFilter.showPicker();
                    } else {
                        teamFilter.click();
                    }
                });

                teamFilter.addEventListener('blur', function() {
                    teamFilter.style.opacity = '0';
                    teamFilter.style.pointerEvents = 'none';
                });
            }
        }
        
        // åº”ç”¨ç­›é€‰
        function applyFilters() {
            const dateFilter = document.getElementById('dateFilter');
            const teamFilter = document.getElementById('teamFilter');
            
            const selectedDate = dateFilter ? dateFilter.value : '';
            const selectedTeam = teamFilter ? teamFilter.value : '';
            
            // è·å–å½“å‰è¡¨æ ¼æ•°æ®
            const tbody = document.getElementById('detailTableBody');
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const dateCell = row.querySelector('td:nth-child(2)');
                const teamCell = row.querySelector('td:nth-child(3)');
                
                const rowDate = dateCell ? dateCell.textContent.trim() : '';
                const rowTeam = teamCell ? teamCell.textContent.trim() : '';
                
                let showRow = true;
                
                if (selectedDate && rowDate !== selectedDate) {
                    showRow = false;
                }
                
                if (selectedTeam && rowTeam !== selectedTeam) {
                    showRow = false;
                }
                
                row.style.display = showRow ? '' : 'none';
            });
        }
        
        // æ›´æ–°ç­›é€‰é€‰é¡¹
        function updateFilterOptions(data) {
            // æ›´æ–°æ—¥æœŸç­›é€‰é€‰é¡¹
            const dateFilter = document.getElementById('dateFilter');
            if (dateFilter) {
                const dates = new Set();
                data.forEach(item => {
                    if (item.record_date) {
                        dates.add(item.record_date);
                    }
                });
                
                // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼Œä¿ç•™"å…¨éƒ¨"
                const allOption = dateFilter.querySelector('option[value=""]');
                dateFilter.innerHTML = '';
                if (allOption) {
                    dateFilter.appendChild(allOption);
                } else {
                    const newAllOption = document.createElement('option');
                    newAllOption.value = '';
                    newAllOption.textContent = 'å…¨éƒ¨';
                    dateFilter.appendChild(newAllOption);
                }
                
                // æ·»åŠ æ—¥æœŸé€‰é¡¹
                Array.from(dates).sort().forEach(date => {
                    const option = document.createElement('option');
                    option.value = date;
                    option.textContent = date;
                    dateFilter.appendChild(option);
                });
            }
            
            // æ›´æ–°ç­ç»„ç­›é€‰é€‰é¡¹
            const teamFilter = document.getElementById('teamFilter');
            if (teamFilter) {
                const teams = new Set();
                data.forEach(item => {
                    if (item.team_name) {
                        teams.add(item.team_name);
                    }
                });
                
                // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼Œä¿ç•™"å…¨éƒ¨"
                const allOption = teamFilter.querySelector('option[value=""]');
                teamFilter.innerHTML = '';
                if (allOption) {
                    teamFilter.appendChild(allOption);
                } else {
                    const newAllOption = document.createElement('option');
                    newAllOption.value = '';
                    newAllOption.textContent = 'å…¨éƒ¨';
                    teamFilter.appendChild(newAllOption);
                }
                
                // æ·»åŠ ç­ç»„é€‰é¡¹
                Array.from(teams).sort().forEach(team => {
                    const option = document.createElement('option');
                    option.value = team;
                    option.textContent = team;
                    teamFilter.appendChild(option);
                });
            }
        }

        // åŠ è½½æ˜ç»†æ•°æ®
        async function loadDetailData() {
            try {
                const projectId = localStorage.getItem('currentProjectId');
                if (!projectId) {
                    console.warn('æœªæ‰¾åˆ°é¡¹ç›®ID');
                    // æ˜¾ç¤ºç©ºæ•°æ®çŠ¶æ€
                    renderDetailTable([]);
                    return;
                }

                // è·å–å½“å‰é€‰æ‹©çš„æ—¥æœŸèŒƒå›´
                const workDateInput = document.getElementById('workDate');
                let startDate = '';
                let endDate = '';

                if (workDateInput.dataset.selectAll) {
                    // å…¨é€‰æ¨¡å¼ï¼Œä¸è®¾ç½®æ—¥æœŸèŒƒå›´
                } else if (workDateInput.dataset.displayValue) {
                    // èŒƒå›´é€‰æ‹©æ¨¡å¼
                    const dateRange = workDateInput.dataset.displayValue.split(' ~ ');
                    if (dateRange.length === 2) {
                        startDate = dateRange[0];
                        endDate = dateRange[1];
                    }
                } else if (workDateInput.value) {
                    // å•é€‰æ¨¡å¼
                    startDate = workDateInput.value;
                    endDate = workDateInput.value;
                } else {
                    // æ—¥æœŸå€¼ä¸ºç©ºï¼Œè®¾ç½®ä¸ºä»Šå¤©
                    const today = new Date();
                    const yyyy = today.getFullYear();
                    const mm = String(today.getMonth() + 1).padStart(2, '0');
                    const dd = String(today.getDate()).padStart(2, '0');
                    const formattedToday = `${yyyy}-${mm}-${dd}`;
                    startDate = formattedToday;
                    endDate = formattedToday;
                }

                // éªŒè¯æ—¥æœŸå‚æ•° (éå…¨é€‰æ¨¡å¼ä¸‹)
                if (!workDateInput.dataset.selectAll && (!startDate || !endDate)) {
                    console.warn('æ—¥æœŸå‚æ•°æ— æ•ˆ');
                    renderDetailTable([]);
                    return;
                }

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const tbody = document.getElementById('detailTableBody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 20px; color: #999;">
                                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                    <div style="margin-bottom: 10px; font-size: 24px;">âŒ›</div>
                                    <div>æ•°æ®åŠ è½½ä¸­...</div>
                                </div>
                            </td>
                        </tr>
                    `;
                }

                // ä»æ•°æ®åº“æŸ¥è¯¢ç‚¹å·¥å•æ•°æ®
                // ä¼˜å…ˆæ£€æŸ¥ç½‘ç»œçŠ¶æ€ï¼Œå¦‚æœæ˜¯ç¦»çº¿æ¨¡å¼ï¼Œç›´æ¥ä»æœ¬åœ°å­˜å‚¨è·å–
                if (!navigator.onLine) {
                    console.log('ç¦»çº¿æ¨¡å¼ï¼šä»æœ¬åœ°å­˜å‚¨è·å–ç‚¹å·¥å•æ•°æ®');
                    const localStorageKey = 'work_records';
                    const storedData = localStorage.getItem(localStorageKey);
                    let localRecords = [];
                    
                    if (storedData) {
                        try {
                            localRecords = JSON.parse(storedData);
                        } catch (e) {
                            console.error('è§£ææœ¬åœ°ç‚¹å·¥å•æ•°æ®å¤±è´¥:', e);
                        }
                    }
                    
                    // æ ¹æ®ç­›é€‰æ¡ä»¶è¿‡æ»¤æœ¬åœ°æ•°æ®
                    let filteredRecords = localRecords.filter(record => record.project_id === projectId);
                    
                    // å¦‚æœä¸æ˜¯å…¨é€‰æ¨¡å¼ï¼Œæ·»åŠ æ—¥æœŸç­›é€‰
                    if (!workDateInput.dataset.selectAll) {
                        filteredRecords = filteredRecords.filter(record => {
                            return record.record_date >= startDate && record.record_date <= endDate;
                        });
                    }
                    
                    // æ’åºï¼šæ—¥æœŸå‡åºï¼Œåˆ›å»ºæ—¶é—´å‡åº
                    filteredRecords.sort((a, b) => {
                        if (a.record_date !== b.record_date) {
                            return a.record_date.localeCompare(b.record_date);
                        }
                        return (a.created_at || '').localeCompare(b.created_at || '');
                    });
                    
                    // æ›´æ–°ç­›é€‰é€‰é¡¹
                    updateFilterOptions(filteredRecords);
                    
                    // æ¸²æŸ“è¡¨æ ¼æ•°æ®
                    renderDetailTable(filteredRecords);
                    // æ›´æ–°åˆè®¡é‡‘é¢
                    updateTotalAmount(filteredRecords);
                    return;
                }

                // ä½¿ç”¨å®é™…çš„è¡¨å work_records
                let query = supabase
                    .from('work_records')
                    .select('*')
                    .eq('project_id', projectId);

                // å¦‚æœä¸æ˜¯å…¨é€‰æ¨¡å¼ï¼Œæ·»åŠ æ—¥æœŸç­›é€‰
                if (!workDateInput.dataset.selectAll) {
                    query = query
                        .gte('record_date', startDate)
                        .lte('record_date', endDate);
                }

                const { data: workOrders, error } = await query
                    .order('record_date', { ascending: true })
                    .order('created_at', { ascending: true });

                if (error) {
                    console.error('æŸ¥è¯¢ç‚¹å·¥å•æ•°æ®å¤±è´¥:', error);
                    
                    // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯ï¼Œå°è¯•ä»æœ¬åœ°å­˜å‚¨è·å–æ•°æ®ä½œä¸ºé™çº§æ–¹æ¡ˆ
                    if (error.message && (error.message.includes('fetch') || error.message.includes('network'))) {
                        console.log('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œå°è¯•ä»æœ¬åœ°å­˜å‚¨è·å–æ•°æ®');
                        const localStorageKey = 'work_records';
                        const storedData = localStorage.getItem(localStorageKey);
                        let localRecords = [];
                        
                        if (storedData) {
                            try {
                                localRecords = JSON.parse(storedData);
                            } catch (e) {
                                console.error('è§£ææœ¬åœ°ç‚¹å·¥å•æ•°æ®å¤±è´¥:', e);
                            }
                        }
                        
                        // æ ¹æ®ç­›é€‰æ¡ä»¶è¿‡æ»¤æœ¬åœ°æ•°æ®
                        let filteredRecords = localRecords.filter(record => record.project_id === projectId);
                        
                        // å¦‚æœä¸æ˜¯å…¨é€‰æ¨¡å¼ï¼Œæ·»åŠ æ—¥æœŸç­›é€‰
                        if (!workDateInput.dataset.selectAll) {
                            filteredRecords = filteredRecords.filter(record => {
                                return record.record_date >= startDate && record.record_date <= endDate;
                            });
                        }
                        
                        // æ’åºï¼šæ—¥æœŸå‡åºï¼Œåˆ›å»ºæ—¶é—´å‡åº
                        filteredRecords.sort((a, b) => {
                            if (a.record_date !== b.record_date) {
                                return a.record_date.localeCompare(b.record_date);
                            }
                            return (a.created_at || '').localeCompare(b.created_at || '');
                        });
                        
                        // æ›´æ–°ç­›é€‰é€‰é¡¹
                        updateFilterOptions(filteredRecords);
                        
                        // æ¸²æŸ“è¡¨æ ¼æ•°æ®
                        renderDetailTable(filteredRecords);
                        // æ›´æ–°åˆè®¡é‡‘é¢
                        updateTotalAmount(filteredRecords);
                        return;
                    }

                    // æ˜¾ç¤ºç©ºæ•°æ®çŠ¶æ€
                    renderDetailTable([]);
                    updateTotalAmount([]);
                    return;
                }

                // æ›´æ–°ç­›é€‰é€‰é¡¹
                updateFilterOptions(workOrders || []);
                
                // æ¸²æŸ“è¡¨æ ¼æ•°æ®
                renderDetailTable(workOrders || []);
                // æ›´æ–°åˆè®¡é‡‘é¢
                updateTotalAmount(workOrders || []);
            } catch (error) {
                console.error('åŠ è½½æ˜ç»†æ•°æ®å¤±è´¥:', error);
                // æ˜¾ç¤ºç©ºæ•°æ®çŠ¶æ€
                renderDetailTable([]);
                updateTotalAmount([]);
            }
        }

        // æ›´æ–°åˆè®¡é‡‘é¢
        function updateTotalAmount(data) {
            const totalAmountValue = document.getElementById('totalAmountValue');
            const totalWorkDaysValue = document.getElementById('totalWorkDaysValue');
            if (!totalAmountValue || !totalWorkDaysValue) return;

            // è®¡ç®—åˆè®¡é‡‘é¢
            const totalAmount = data.reduce((sum, item) => {
                return sum + (parseFloat(item.amount) || 0);
            }, 0);

            // è®¡ç®—å·¥æ—¥åˆè®¡
            const totalWorkDays = data.reduce((sum, item) => {
                return sum + (parseFloat(item.work_days) || 0);
            }, 0);

            // æ ¼å¼åŒ–é‡‘é¢æ˜¾ç¤º
            totalAmountValue.textContent = `Â¥${totalAmount.toFixed(2)}`;
            // æ˜¾ç¤ºå·¥æ—¥åˆè®¡
            totalWorkDaysValue.textContent = totalWorkDays.toFixed(1);
        }

        // é€€å‡ºç¼–è¾‘æ¨¡å¼
        function exitEditMode() {
            window.isEditMode = false;
            
            // é‡ç½®å…¨å±€å˜é‡
            if (window.workRecordDetail) {
                window.workRecordDetail = null;
            }
            
            // ä½¿ç”¨ work_record_api.js ä¸­çš„ resetWorkRecordForm æ¥é‡ç½®è¡¨å•
            if (window.workRecordAPI && typeof window.workRecordAPI.resetWorkRecordForm === 'function') {
                window.workRecordAPI.resetWorkRecordForm();
            } else if (typeof window.resetWorkRecordForm === 'function') {
                // å¦‚æœæ˜¯æŒ‚è½½åœ¨ window ä¸Šçš„å…¨å±€å‡½æ•°
                window.resetWorkRecordForm();
            } else {
                // é™çº§å¤„ç†ï¼šæ‰‹åŠ¨é‡ç½®ï¼Œå°½å¯èƒ½æ¨¡æ‹Ÿ resetWorkRecordForm çš„è¡Œä¸º
                
                // 1. é‡ç½®å„ä¸ªè¾“å…¥æ¡†
                const inputs = [
                    'teamName', 'teamLeader', 'workDays',
                    'unitPrice', 'amount', 'description'
                ];
                
                inputs.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.value = '';
                        // é‡ç½®è¾“å…¥æ¡†æ ·å¼
                        element.style.border = '';
                        element.style.backgroundColor = '';
                        element.style.boxShadow = '';
                        element.classList.remove('has-value');
                    }
                });

                // 2. ç¡®ä¿é¡¹ç›®åç§°ä¸è¢«æ¸…ç©ºï¼ˆä¸ä¿å­˜é€»è¾‘ä¸€è‡´ï¼Œé€šå¸¸ä¿ç•™å½“å‰é¡¹ç›®ï¼‰
                // æ³¨æ„ï¼šè¿™é‡Œä¸åº”è¯¥æ¸…ç©º projectName å’Œ workerNameï¼Œé™¤éæœ‰æ˜ç¡®éœ€æ±‚
                // å¦‚æœéœ€è¦é‡ç½® workerName:
                const workerNameInput = document.getElementById('workerName');
                if (workerNameInput) {
                    workerNameInput.value = '';
                    workerNameInput.classList.remove('has-value');
                }

                // 3. é‡ç½®æ—¥æœŸä¸ºä»Šå¤©
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const todayStr = `${year}-${month}-${day}`;
                const displayStr = `${year}å¹´${month}æœˆ${day}æ—¥`;
                const displayHtml = `${displayStr}<span class="today-text">ï¼ˆä»Šå¤©ï¼‰</span>`;

                const dateDisplay = document.getElementById('dateDisplay');
                if (dateDisplay) {
                    dateDisplay.innerHTML = displayHtml;
                    dateDisplay.classList.add('today');
                }
                const workDateInput = document.getElementById('workDate');
                if (workDateInput) {
                    workDateInput.value = todayStr;
                    delete workDateInput.dataset.displayValue;
                    delete workDateInput.dataset.selectAll;
                    workDateInput.setAttribute('data-today', 'true');
                }

                // 4. é‡ç½®å›¾ç‰‡
                if (typeof window.clearImage === 'function') {
                    window.clearImage();
                }
            }
            
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            const confirmBtn = document.getElementById('confirmAccountBtn');
            if (confirmBtn) {
                confirmBtn.textContent = 'ä¿å­˜';
                delete confirmBtn.dataset.editMode;
                delete confirmBtn.dataset.recordId;
                // æ¢å¤é»˜è®¤æ ·å¼
                confirmBtn.style.display = 'block'; 
                confirmBtn.style.background = 'linear-gradient(135deg, rgba(0, 102, 204, 0.9), rgba(30, 144, 255, 0.8))'; // æ¢å¤é»˜è®¤è“è‰²èƒŒæ™¯
                confirmBtn.style.boxShadow = '0 2px 8px rgba(0, 102, 204, 0.3)'; // æ¢å¤é»˜è®¤é˜´å½±
            }
            
            // ç¡®ä¿åº•éƒ¨æŒ‰é’®å®¹å™¨æ˜¾ç¤º
            const bottomButtons = document.querySelector('.bottom-buttons');
            if (bottomButtons) {
                bottomButtons.style.display = 'flex';
            }
        }
        
        // ç¼–è¾‘ç‚¹å·¥å•è®°å½•
        function editWorkRecord(record) {
            // è®¾ç½®ç¼–è¾‘æ¨¡å¼æ ‡å¿—
            window.isEditMode = true;

            // åˆ‡æ¢åˆ°"è®°å·¥"æ ‡ç­¾
            const workTabRadio = document.querySelector('input[name="workTab"][value="è®°å·¥"]');
            if (workTabRadio) {
                workTabRadio.checked = true;
                updateTabContent("è®°å·¥");
            }
            
            // åˆå§‹åŒ–ç¼–è¾‘è¯¦æƒ…å¯¹è±¡
            window.workRecordDetail = {
                editingRecordId: record.work_record_id,
                oldImageList: [],
                deleteRecordImages: async function(imagesToDelete) {
                    if (!imagesToDelete || imagesToDelete.length === 0) return;
                    
                    try {
                        // æå–æ–‡ä»¶è·¯å¾„
                        const filePaths = imagesToDelete.map(url => {
                            // URLæ ¼å¼: https://.../storage/v1/object/public/FYKQ/project_id/temporaryworker/filename.ext
                            // éœ€è¦æå–: project_id/temporaryworker/filename.ext
                            const urlParts = url.split('/FYKQ/');
                            if (urlParts.length > 1) {
                                return decodeURIComponent(urlParts[1]);
                            }
                            return null;
                        }).filter(path => path !== null);

                        if (filePaths.length > 0 && window.workRecordAPI && window.workRecordAPI.supabase) {
                            const { error } = await window.workRecordAPI.supabase
                                .storage
                                .from('FYKQ')
                                .remove(filePaths);
                            
                            if (error) {
                                console.error('åˆ é™¤æ—§å›¾ç‰‡å¤±è´¥:', error);
                            }
                        }
                    } catch (e) {
                        console.error('åˆ é™¤æ—§å›¾ç‰‡å‡ºé”™:', e);
                    }
                }
            };

            // å¡«å……æ•°æ®åˆ°è¾“å…¥æ¡†
            const workDateInput = document.getElementById('workDate');
            if (workDateInput && record.record_date) {
                workDateInput.value = record.record_date;
                delete workDateInput.dataset.displayValue;
                delete workDateInput.dataset.selectAll;
                updateDateDisplay();
            } else {
                console.error('æ—¥æœŸå¡«å……å¤±è´¥:', { workDateInput, recordDate: record.record_date });
            }
            document.getElementById('teamName').value = record.team_name || '';
            document.getElementById('teamLeader').value = record.team_leader || '';
            document.getElementById('workDays').value = record.work_days || '';
            document.getElementById('unitPrice').value = record.unit_price || '';
            document.getElementById('amount').value = record.amount || '';
            document.getElementById('description').value = record.description || '';
            
            // è®¾ç½®æŠ€å·¥/æ™®å·¥çŠ¶æ€
            const workerTypeCheckbox = document.getElementById('workerType');
            workerTypeCheckbox.checked = record.worker_type === 'æŠ€å·¥';
            
            // åˆ‡æ¢åˆ°è®°å·¥æ ‡ç­¾é¡µ
            document.getElementById('tabWorkRecord').checked = true;
            document.querySelector('label[for="tabWorkRecord"]').classList.add('active');
            document.querySelector('label[for="tabWorkFlow"]').classList.remove('active');
            
            // æ›´æ–°æ ‡ç­¾å†…å®¹æ˜¾ç¤º
            const tabWorkContent = document.querySelectorAll('.tab-work-content');
            const detailTableSection = document.getElementById('detailTableSection');
            
            tabWorkContent.forEach(element => {
                element.style.display = '';
            });
            detailTableSection.style.display = 'none';
            
            // æ›´æ–°è¾“å…¥æ¡†æ ·å¼
            const teamInput = document.getElementById('teamName');
            if (teamInput.value && teamInput.value.trim() !== '') {
                teamInput.classList.add('has-value');
            } else {
                teamInput.classList.remove('has-value');
            }
            
            const teamLeaderInput = document.getElementById('teamLeader');
            if (teamLeaderInput.value && teamLeaderInput.value.trim() !== '') {
                teamLeaderInput.classList.add('has-value');
            } else {
                teamLeaderInput.classList.remove('has-value');
            }
            
            const workDaysInput = document.getElementById('workDays');
            if (workDaysInput.value && workDaysInput.value.trim() !== '') {
                workDaysInput.classList.add('has-value');
            } else {
                workDaysInput.classList.remove('has-value');
            }
            
            const unitPriceInput = document.getElementById('unitPrice');
            if (unitPriceInput.value && unitPriceInput.value.trim() !== '') {
                unitPriceInput.classList.add('has-value');
            } else {
                unitPriceInput.classList.remove('has-value');
            }
            
            const amountInput = document.getElementById('amount');
            if (amountInput.value && amountInput.value.trim() !== '') {
                amountInput.classList.add('has-value');
            } else {
                amountInput.classList.remove('has-value');
            }
            
            const descriptionInput = document.getElementById('description');
            if (descriptionInput.value && descriptionInput.value.trim() !== '') {
                descriptionInput.classList.add('has-value');
            } else {
                descriptionInput.classList.remove('has-value');
            }
            
            // å¤„ç†å›¾ç‰‡
            if (record.image_ids && Array.isArray(record.image_ids) && record.image_ids.length > 0) {
                // ä¿å­˜æ—§å›¾ç‰‡åˆ—è¡¨
                window.workRecordDetail.oldImageList = [...record.image_ids];
                loadImagesToForm(record.image_ids);
            } else if (record.image_ids && typeof record.image_ids === 'string' && record.image_ids.trim() !== '') {
                // ä¿å­˜æ—§å›¾ç‰‡åˆ—è¡¨
                window.workRecordDetail.oldImageList = [record.image_ids];
                loadImagesToForm([record.image_ids]);
            } else {
                // æ¸…ç©ºå›¾ç‰‡
                window.workRecordDetail.oldImageList = [];
                if (typeof window.clearImage === 'function') {
                    window.clearImage();
                }
            }
            
            // éšè—åˆè®¡å’ŒPDFæŒ‰é’®
            const totalAmountDisplay = document.getElementById('totalAmountDisplay');
            if (totalAmountDisplay) {
                totalAmountDisplay.style.display = 'none';
            }
            
            // æ˜¾ç¤ºå¹¶ä¿®æ”¹ä¿å­˜æŒ‰é’®ä¸ºä¿®æ”¹æŒ‰é’®
            const bottomButtons = document.querySelector('.bottom-buttons');
            const confirmBtn = document.getElementById('confirmAccountBtn');
            if (bottomButtons) {
                bottomButtons.style.display = 'flex';
            }
            if (confirmBtn) {
                confirmBtn.style.display = 'block';
                confirmBtn.textContent = 'ä¿®æ”¹';
                // æ·»åŠ ç¼–è¾‘æ¨¡å¼æ ‡è¯†
                confirmBtn.dataset.editMode = 'true';
                // å­˜å‚¨å½“å‰ç¼–è¾‘çš„è®°å½•ID
                confirmBtn.dataset.recordId = record.work_record_id;
                // ä¿®æ”¹æŒ‰é’®é¢œè‰²ä¸ºç´«è‰²
                confirmBtn.style.background = 'linear-gradient(135deg, #722ed1 0%, #531dab 100%)';
                confirmBtn.style.boxShadow = '0 2px 8px rgba(114, 46, 209, 0.3)';
            }
        }
        
        // åŠ è½½å›¾ç‰‡åˆ°è¡¨å•
        function loadImagesToForm(imageIds) {
            // æ¸…ç©ºå½“å‰é€‰ä¸­çš„å›¾ç‰‡
            if (typeof window.clearImage === 'function') {
                window.clearImage();
            }
            
            // ç¡®ä¿å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½å·²åˆå§‹åŒ–
            if (typeof window.initializeImageUpload === 'function') {
                window.initializeImageUpload();
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showImageLoadingStatus(imageIds.length);
            
            // ä¸‹è½½å¹¶æ˜¾ç¤ºå›¾ç‰‡
            let loadedCount = 0;
            imageIds.forEach((url, index) => {
                if (url && url.trim()) {
                    // å¤„ç†ä¸åŒç±»å‹çš„URL
                    if (url.startsWith('data:')) {
                        // ç›´æ¥å¤„ç†data URLï¼ˆbase64å›¾ç‰‡ï¼‰
                        try {
                            // ä»data URLåˆ›å»ºBlobå¯¹è±¡
                            const [header, data] = url.split(',');
                            const mime = header.match(/:(.*?);/)[1];
                            const bstr = atob(data);
                            let n = bstr.length;
                            const u8arr = new Uint8Array(n);
                            while (n--) {
                                u8arr[n] = bstr.charCodeAt(n);
                            }
                            const blob = new Blob([u8arr], { type: mime });
                            
                            // ç”Ÿæˆæ–‡ä»¶å
                            let fileName;
                            const urlParts = url.split('/');
                            if (urlParts.length > 1) {
                                const lastPart = urlParts[urlParts.length - 1];
                                if (lastPart.includes('.')) {
                                    fileName = lastPart;
                                } else {
                                    fileName = `image_${Date.now()}_${index}.${mime.split('/')[1] || 'jpg'}`;
                                }
                            } else {
                                fileName = `image_${Date.now()}_${index}.${mime.split('/')[1] || 'jpg'}`;
                            }
                            
                            // åˆ›å»ºFileå¯¹è±¡
                            const file = new File([blob], fileName, { type: mime });
                            // æ ‡è®°ä¸ºå·²å­˜åœ¨çš„å›¾ç‰‡ï¼Œé¿å…é‡å¤ä¸Šä¼ 
                            file.isExisting = true;
                            file.originalUrl = url;
                            
                            // æ·»åŠ åˆ°å…¨å±€å›¾ç‰‡æ•°ç»„
                            if (window.selectedImages) {
                                window.selectedImages.push(file);
                            } else {
                                window.selectedImages = [file];
                            }
                            
                            // æ›´æ–°åŠ è½½çŠ¶æ€
                            loadedCount++;
                            updateImageLoadingStatus(loadedCount, imageIds.length);
                            
                            // æ›´æ–°å›¾ç‰‡æ˜¾ç¤º
                            updateImagePreview();
                        } catch (error) {
                            console.error('å¤„ç†base64å›¾ç‰‡å¤±è´¥:', error);
                            // å³ä½¿å¤±è´¥ä¹Ÿè¦æ›´æ–°åŠ è½½è®¡æ•°
                            loadedCount++;
                            updateImageLoadingStatus(loadedCount, imageIds.length);
                        }
                    } else {
                        // å¤„ç†æ™®é€šURLå›¾ç‰‡
                        // ä½¿ç”¨è·¨åŸŸä»£ç†æˆ–æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜é—®é¢˜
                        const fetchUrl = url + (url.includes('?') ? '&' : '?') + 't=' + new Date().getTime();
                        
                        fetch(url, { mode: 'cors' })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Network response was not ok');
                                }
                                return response.blob();
                            })
                            .then(blob => {
                                // ç”Ÿæˆæ–‡ä»¶å
                                const urlParts = url.split('/');
                                const fileName = urlParts[urlParts.length - 1] || `image_${Date.now()}_${index}.jpg`;
                                
                                // åˆ›å»ºFileå¯¹è±¡
                                const file = new File([blob], fileName, { type: blob.type });
                                // æ ‡è®°ä¸ºå·²å­˜åœ¨çš„å›¾ç‰‡ï¼Œé¿å…é‡å¤ä¸Šä¼ 
                                file.isExisting = true;
                                file.originalUrl = url;
                                
                                // æ·»åŠ åˆ°å…¨å±€å›¾ç‰‡æ•°ç»„
                                if (window.selectedImages) {
                                    window.selectedImages.push(file);
                                } else {
                                    window.selectedImages = [file];
                                }
                                
                                // æ›´æ–°åŠ è½½çŠ¶æ€
                                loadedCount++;
                                updateImageLoadingStatus(loadedCount, imageIds.length);
                                
                                // æ›´æ–°å›¾ç‰‡æ˜¾ç¤º
                                updateImagePreview();
                            })
                            .catch(error => {
                                console.error('åŠ è½½å›¾ç‰‡å¤±è´¥:', error);
                                // å°è¯•ç›´æ¥ä½¿ç”¨URLæ˜¾ç¤ºï¼Œä¸è½¬æ¢ä¸ºFileå¯¹è±¡
                                // è¿™ç§æƒ…å†µé€šå¸¸å‘ç”Ÿåœ¨è·¨åŸŸé™åˆ¶å¯¼è‡´æ— æ³•è·å–blobæ—¶
                                
                                // åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿçš„Fileå¯¹è±¡ï¼ˆå®é™…ä¸Šæ˜¯ä¸€ä¸ªåŒ…å«urlçš„å¯¹è±¡ï¼‰
                                // è¿™æ ·è‡³å°‘èƒ½æ˜¾ç¤ºå‡ºæ¥ï¼Œè™½ç„¶å¯èƒ½æ— æ³•å†æ¬¡ä¸Šä¼ ï¼ˆé™¤éåç«¯æ”¯æŒç›´æ¥å¤„ç†URLï¼‰
                                // ä½†æˆ‘ä»¬çš„ updateImagePreview ä½¿ç”¨ URL.createObjectURL(file)ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦ç‰¹æ®Šå¤„ç†
                                
                                // æ›´å¥½çš„é™çº§æ–¹æ¡ˆï¼šç›´æ¥å°†åŸå§‹URLæ·»åŠ åˆ°selectedImages
                                // updateImagePreview éœ€è¦ä¿®æ”¹ä»¥æ”¯æŒå­—ç¬¦ä¸²ç±»å‹çš„URL
                                
                                const imageObj = {
                                    name: `image_${index}.jpg`,
                                    type: 'image/jpeg',
                                    isExisting: true,
                                    originalUrl: url,
                                    // æ·»åŠ ä¸€ä¸ªç‰¹æ®Šçš„æ ‡è®°ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæ— æ³•è½¬æ¢ä¸ºBlobçš„è¿œç¨‹å›¾ç‰‡
                                    isRemoteUrl: true
                                };
                                
                                if (window.selectedImages) {
                                    window.selectedImages.push(imageObj);
                                } else {
                                    window.selectedImages = [imageObj];
                                }
                                
                                loadedCount++;
                                updateImageLoadingStatus(loadedCount, imageIds.length);
                                updateImagePreview();
                            });
                    }
                }
            });
        }
        
        // æ›´æ–°å›¾ç‰‡é¢„è§ˆ
        function updateImagePreview() {
            // ç¡®ä¿å›¾ç‰‡ä¸Šä¼ å®¹å™¨å·²åˆå§‹åŒ–
            if (typeof window.initializeImageUpload === 'function') {
                window.initializeImageUpload();
            }
            
            const container = document.getElementById('imageUploadContainer');
            if (!container) return;
            
            // ä¿ç•™æ·»åŠ æŒ‰é’®ï¼Œåˆ é™¤æ‰€æœ‰é¢„è§ˆå›¾ç‰‡
            const addButton = container.querySelector('.image-upload-item');
            
            // æ¸…ç©ºé™¤æ·»åŠ æŒ‰é’®å¤–çš„æ‰€æœ‰å†…å®¹
            // æ³¨æ„ï¼šä¸èƒ½ç›´æ¥ innerHTML = '' å† appendChildï¼Œå› ä¸ºè¿™æ ·ä¼šä¸¢å¤± addButton çš„äº‹ä»¶ç»‘å®š
            // åº”è¯¥åªåˆ é™¤ .image-preview-item
            const existingPreviews = container.querySelectorAll('.image-preview-item');
            existingPreviews.forEach(el => el.remove());
            
            // å¦‚æœæ·»åŠ æŒ‰é’®ä¸å­˜åœ¨ï¼ˆå¯èƒ½è¢«æ„å¤–æ¸…ç©ºï¼‰ï¼Œé‡æ–°åˆ›å»º
            if (!addButton) {
                // å¦‚æœå®¹å™¨æ˜¯ç©ºçš„ï¼Œè¿™é‡Œéœ€è¦é‡æ–°åˆå§‹åŒ–æ·»åŠ æŒ‰é’®
                // ä½†é€šå¸¸ initializeImageUpload ä¼šå¤„ç†
                // å¦‚æœæ²¡æœ‰ï¼Œæ‰‹åŠ¨åˆ›å»º
                if (typeof window.initializeImageUpload !== 'function') {
                     const initialItem = document.createElement('div');
                    initialItem.className = 'image-upload-item';
                    initialItem.innerHTML = `
                        <label for="imageUpload" style="display: block; width: 100px; height: 100px; border: 1px dashed #ddd; border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; color: #999; margin-bottom: 5px;">+</div>
                                <div style="font-size: 12px; color: #999;">æ·»åŠ å›¾ç‰‡</div>
                            </div>
                        </label>
                    `;
                    container.appendChild(initialItem);
                }
            }
            
            // é‡æ–°è·å–æ·»åŠ æŒ‰é’®ï¼ˆä»¥é˜²ä¸Šé¢åˆšåˆ›å»ºï¼‰
            const currentAddButton = container.querySelector('.image-upload-item');
            
            // æ·»åŠ é¢„è§ˆå›¾ç‰‡
            if (window.selectedImages && window.selectedImages.length > 0) {
                window.selectedImages.forEach((file, index) => {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'image-preview-item';
                    previewItem.style.cssText = `
                        position: relative;
                        width: 100px;
                        height: 100px;
                        border: 1px solid #ddd;
                        border-radius: 4px;
                        overflow: hidden;
                        margin-right: 10px;
                        margin-bottom: 10px;
                    `;
                    
                    const img = document.createElement('img');
                    
                    // å¤„ç†å›¾ç‰‡æº
                    if (file.isRemoteUrl) {
                        img.src = file.originalUrl;
                    } else if (file instanceof File || file instanceof Blob) {
                        img.src = URL.createObjectURL(file);
                    } else if (typeof file === 'string') {
                        img.src = file;
                    } else {
                        // å…œåº•
                        img.src = file.originalUrl || '';
                    }
                    
                    img.style.cssText = `
                        width: 100%;
                        height: 100%;
                        object-fit: cover;
                        cursor: pointer;
                    `;
                    
                    // æ·»åŠ ç‚¹å‡»é¢„è§ˆåŠŸèƒ½
                    img.onclick = function() {
                        viewImage(this.src);
                    };
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = 'Ã—';
                    deleteBtn.style.cssText = `
                        position: absolute;
                        top: 2px;
                        right: 2px;
                        background: rgba(255, 0, 0, 0.7);
                        color: white;
                        border: none;
                        border-radius: 50%;
                        width: 20px;
                        height: 20px;
                        font-size: 16px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    `;
                    deleteBtn.onclick = function() {
                        window.selectedImages.splice(index, 1);
                        updateImagePreview();
                    };

                    previewItem.appendChild(img);
                    previewItem.appendChild(deleteBtn);
                    
                    // æ’å…¥åˆ°æ·»åŠ æŒ‰é’®ä¹‹å‰
                    if (currentAddButton && currentAddButton.parentNode === container) {
                        container.insertBefore(previewItem, currentAddButton);
                    } else {
                        container.appendChild(previewItem);
                    }
                });
            }
        }
        
        /**
         * æ˜¾ç¤ºå›¾ç‰‡åŠ è½½çŠ¶æ€
         */
        function showImageLoadingStatus(totalImages) {
            const container = document.getElementById('imageUploadContainer');
            if (!container) return;
            
            // åˆ›å»ºåŠ è½½æŒ‡ç¤ºå™¨
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'imageLoadingIndicator';
            loadingDiv.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(255, 255, 255, 0.95);
                padding: 15px 25px;
                border-radius: 8px;
                border: 1px solid #ddd;
                font-size: 14px;
                color: #666;
                z-index: 1000;
                box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
                text-align: center;
            `;
            loadingDiv.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <div style="
                        width: 18px;
                        height: 18px;
                        border: 2px solid #1890ff;
                        border-top: 2px solid transparent;
                        border-radius: 50%;
                        animation: spin 0.8s linear infinite;
                    "></div>
                    <span id="loadingText">æ­£åœ¨åŠ è½½å›¾ç‰‡...</span>
                </div>
                <div id="loadingProgress" style="margin-top: 8px; font-size: 12px; color: #999;">0 / ${totalImages}</div>
            `;
            
            // æ·»åŠ æ—‹è½¬åŠ¨ç”»æ ·å¼
            if (!document.getElementById('loadingAnimationStyle')) {
                const style = document.createElement('style');
                style.id = 'loadingAnimationStyle';
                style.textContent = `
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // å¦‚æœå®¹å™¨æ²¡æœ‰position:relativeï¼Œæ·»åŠ å®ƒ
            if (getComputedStyle(container).position === 'static') {
                container.style.position = 'relative';
            }
            
            container.appendChild(loadingDiv);
        }
        
        /**
         * æ›´æ–°å›¾ç‰‡åŠ è½½çŠ¶æ€
         */
        function updateImageLoadingStatus(loadedCount, totalCount) {
            const loadingIndicator = document.getElementById('imageLoadingIndicator');
            if (!loadingIndicator) return;
            
            // æ›´æ–°è¿›åº¦æ–‡æœ¬
            const progressText = loadingIndicator.querySelector('#loadingProgress');
            if (progressText) {
                progressText.textContent = `${loadedCount} / ${totalCount}`;
            }
            
            // å¦‚æœæ‰€æœ‰å›¾ç‰‡éƒ½åŠ è½½å®Œæˆï¼Œéšè—åŠ è½½æŒ‡ç¤ºå™¨
            if (loadedCount >= totalCount) {
                setTimeout(() => {
                    if (loadingIndicator && loadingIndicator.parentNode) {
                        loadingIndicator.remove();
                    }
                }, 300); // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹ï¼Œè®©ç”¨æˆ·èƒ½çœ‹åˆ°åŠ è½½å®Œæˆçš„çŠ¶æ€
            }
        }
        
        /**
         * éšè—å›¾ç‰‡åŠ è½½çŠ¶æ€
         */
        function hideImageLoadingStatus() {
            const loadingIndicator = document.getElementById('imageLoadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.remove();
            }
        }

        // æ¸²æŸ“æ˜ç»†è¡¨æ ¼
        function renderDetailTable(data) {
            const tbody = document.getElementById('detailTableBody');
            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="10" style="text-align: center; padding: 20px; color: #999;">
                        æš‚æ— æ•°æ®
                    </td>
                `;
                tbody.appendChild(emptyRow);
                return;
            }

            data.forEach((item, index) => {
                const row = document.createElement('tr');

                // å¤„ç†å›¾ç‰‡æ˜¾ç¤º
                let imageHtml = '-';
                if (item.image_ids) {
                    // ç¡®ä¿ image_ids æ˜¯æ•°ç»„ä¸”æœ‰å€¼
                    const imageId = Array.isArray(item.image_ids) ? item.image_ids[0] : item.image_ids;
                    if (imageId) {
                        imageHtml = `<span class="image-icon" style="cursor: pointer; color: #1890ff; font-size: 14px;" onclick="viewImage('${imageId}')">ğŸ–¼ï¸</span>`;
                    }
                }

                // å¤„ç†å·¥æ—¥æ˜¾ç¤º
                const workDaysDisplay = item.work_days ? `${item.work_days}ä¸ªå·¥` : '-';

                // å¤„ç†ç±»å‹æ˜¾ç¤º
                const workTypeDisplay = item.worker_type || '-';

                // å¤„ç†å•ä»·æ˜¾ç¤º
                let unitPriceDisplay = '-';
                if (item.unit_price) {
                    if (Number.isInteger(item.unit_price)) {
                        unitPriceDisplay = item.unit_price.toString();
                    } else {
                        unitPriceDisplay = item.unit_price.toFixed(1);
                    }
                }

                // å¤„ç†é‡‘é¢æ˜¾ç¤º
                let amountDisplay = '-';
                if (item.amount) {
                    if (Number.isInteger(item.amount)) {
                        amountDisplay = `Â¥${item.amount}`;
                    } else {
                        amountDisplay = `Â¥${item.amount.toFixed(1)}`;
                    }
                }

                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.record_date}</td>
                    <td>${item.team_name || '-'}</td>
                    <td>${item.team_leader || '-'}</td>
                    <td>${workDaysDisplay}</td>
                    <td>${workTypeDisplay}</td>
                    <td>${unitPriceDisplay}</td>
                    <td>${amountDisplay}</td>
                    <td class="work-content-cell" style="max-width: 150px; width: 150px; white-space: normal; text-align: left; word-wrap: break-word; overflow: visible;">${item.description || '-'}</td>
                    <td>${imageHtml}</td>
                    <span class="delete-icon" onclick="deleteWorkRecord('${item.work_record_id}', ${JSON.stringify(item.image_ids || []).replace(/"/g, '&quot;')})">ğŸ—‘ï¸</span>
                `;

                // æ·»åŠ åŒå‡»äº‹ä»¶ç›‘å¬å™¨
                row.addEventListener('dblclick', function() {
                    editWorkRecord(item);
                });

                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ï¼Œå®ç°è¡Œé€‰ä¸­
                row.addEventListener('click', function(e) {
                    // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘æ–‡æ¡£ç‚¹å‡»äº‹ä»¶
                    e.stopPropagation();
                    
                    // ç§»é™¤å…¶ä»–è¡Œçš„é€‰ä¸­çŠ¶æ€
                    document.querySelectorAll('.modern-table tbody tr.selected').forEach(selectedRow => {
                        selectedRow.classList.remove('selected');
                    });
                    
                    // æ·»åŠ å½“å‰è¡Œçš„é€‰ä¸­çŠ¶æ€
                    this.classList.add('selected');
                    
                    // ä¿®æ”¹æŒ‰é’®æ–‡æœ¬ä¸º"ç”Ÿæˆç‚¹å·¥å•"
                    const generatePdfBtn = document.getElementById('generatePdfBtn');
                    if (generatePdfBtn) {
                        generatePdfBtn.textContent = 'ç”Ÿæˆç‚¹å·¥å•';
                        // ä¿®æ”¹æŒ‰é’®èƒŒæ™¯é¢œè‰²
                        generatePdfBtn.style.background = 'linear-gradient(135deg, #1890ff 0%, #40a9ff 100%)';
                        generatePdfBtn.style.boxShadow = '0 2px 8px rgba(24, 144, 255, 0.3)';
                    }
                });

                tbody.appendChild(row);
            });
        }

        // åˆ é™¤ç‚¹å·¥å•è®°å½•
        function deleteWorkRecord(recordId, imageIds = []) {
            // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†
            showDeleteModal(recordId, imageIds);
        }

        // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†
        function showDeleteModal(recordId, imageIds) {
            // æ£€æŸ¥æ¨¡æ€æ¡†æ˜¯å¦å·²å­˜åœ¨
            let modal = document.getElementById('deleteConfirmModal');
            if (!modal) {
                // åˆ›å»ºæ¨¡æ€æ¡†
                modal = document.createElement('div');
                modal.id = 'deleteConfirmModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;
                
                // æ¨¡æ€æ¡†å†…å®¹
                modal.innerHTML = `
                    <div style="
                        background-color: white;
                        border-radius: 8px;
                        padding: 15px;
                        width: 85%;
                        max-width: 320px;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                    ">
                        <div style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 15px;
                        ">
                            <h3 style="margin: 0; color: #333; font-size: 16px;">ç¡®è®¤åˆ é™¤</h3>
                            <button id="closeDeleteModalBtn" style="
                                background: none;
                                border: none;
                                font-size: 18px;
                                cursor: pointer;
                                color: #999;
                                transition: all 0.3s ease;
                            " onmouseover="this.style.color='#ff4d4f';this.style.transform='rotate(90deg)'" onmouseout="this.style.color='#999';this.style.transform='rotate(0deg)'">Ã—</button>
                        </div>
                        <p style="color: #666; margin-bottom: 15px; font-size: 13px;">
                            ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚
                        </p>
                        <div style="margin-bottom: 15px;">
                            <label style="
                                display: block;
                                margin-bottom: 6px;
                                color: #333;
                                font-weight: bold;
                                font-size: 13px;
                            ">è¯·è¾“å…¥å¯†ç ç¡®è®¤åˆ é™¤ï¼š</label>
                            <input type="password" id="deletePasswordInput" style="
                                width: 100%;
                                padding: 8px;
                                border: 1px solid #d9d9d9;
                                border-radius: 4px;
                                font-size: 13px;
                                box-sizing: border-box;
                            ">
                            <div id="passwordErrorMsg" style="
                                color: #ff4d4f;
                                font-size: 12px;
                                margin-top: 4px;
                                display: none;
                            ">å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•</div>
                        </div>
                        <div style="
                            display: flex;
                            justify-content: flex-end;
                            gap: 8px;
                        ">
                            <button id="cancelDeleteBtn" style="
                                padding: 6px 12px;
                                border: 1px solid #d9d9d9;
                                border-radius: 4px;
                                background-color: white;
                                color: #333;
                                cursor: pointer;
                                font-size: 13px;
                                transition: all 0.3s ease;
                            " onmouseover="this.style.backgroundColor='#f5f5f5';this.style.borderColor='#bfbfbf'" onmouseout="this.style.backgroundColor='white';this.style.borderColor='#d9d9d9'">å–æ¶ˆ</button>
                            <button id="confirmDeleteBtn" style="
                                padding: 6px 12px;
                                border: 1px solid #ff4d4f;
                                border-radius: 4px;
                                background-color: #ff4d4f;
                                color: white;
                                cursor: pointer;
                                font-size: 13px;
                                transition: all 0.3s ease;
                            " onmouseover="this.style.backgroundColor='#ff7875';this.style.borderColor='#ff7875';this.style.transform='scale(1.05)'" onmouseout="this.style.backgroundColor='#ff4d4f';this.style.borderColor='#ff4d4f';this.style.transform='scale(1)'">ç¡®è®¤åˆ é™¤</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // ç»‘å®šäº‹ä»¶
                bindDeleteModalEvents();
            }
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            modal.style.display = 'flex';
            
            // ä¿å­˜å½“å‰è¦åˆ é™¤çš„è®°å½•IDå’Œå›¾ç‰‡ID
            modal.recordIdToDelete = recordId;
            modal.imageIdsToDelete = imageIds;
            
            // èšç„¦å¯†ç è¾“å…¥æ¡†
            setTimeout(() => {
                const passwordInput = document.getElementById('deletePasswordInput');
                if (passwordInput) {
                    passwordInput.focus();
                }
            }, 100);
        }

        // ç»‘å®šåˆ é™¤æ¨¡æ€æ¡†äº‹ä»¶
        function bindDeleteModalEvents() {
            const modal = document.getElementById('deleteConfirmModal');
            const closeBtn = document.getElementById('closeDeleteModalBtn');
            const cancelBtn = document.getElementById('cancelDeleteBtn');
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            const passwordInput = document.getElementById('deletePasswordInput');
            const errorMsg = document.getElementById('passwordErrorMsg');
            
            // å…³é—­æ¨¡æ€æ¡†
            const closeModal = () => {
                if (modal) {
                    modal.style.display = 'none';
                    // æ¸…ç©ºå¯†ç è¾“å…¥
                    if (passwordInput) {
                        passwordInput.value = '';
                    }
                    // éšè—é”™è¯¯ä¿¡æ¯
                    if (errorMsg) {
                        errorMsg.style.display = 'none';
                    }
                }
            };
            
            // å…³é—­æŒ‰é’®äº‹ä»¶
            if (closeBtn) {
                closeBtn.addEventListener('click', closeModal);
            }
            
            // å–æ¶ˆæŒ‰é’®äº‹ä»¶
            if (cancelBtn) {
                cancelBtn.addEventListener('click', closeModal);
            }
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal();
                    }
                });
            }
            
            // ç¡®è®¤åˆ é™¤äº‹ä»¶
            if (confirmBtn) {
                confirmBtn.addEventListener('click', async () => {
                    // è·å–è¾“å…¥çš„å¯†ç 
                    const password = passwordInput?.value || '';
                    
                    // éªŒè¯å¯†ç 
                    if (await verifyPassword(password)) {
                        // å¯†ç æ­£ç¡®ï¼Œæ‰§è¡Œåˆ é™¤
                        if (modal && modal.recordIdToDelete) {
                            executeDelete(modal.recordIdToDelete, modal.imageIdsToDelete);
                            closeModal();
                        }
                    } else {
                        // å¯†ç é”™è¯¯ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                        if (errorMsg) {
                            errorMsg.style.display = 'block';
                        }
                        // æ¸…ç©ºå¯†ç è¾“å…¥
                        if (passwordInput) {
                            passwordInput.value = '';
                            passwordInput.focus();
                        }
                    }
                });
            }
            
            // å›è½¦é”®è§¦å‘ç¡®è®¤åˆ é™¤
            if (passwordInput) {
                passwordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        confirmBtn?.click();
                    }
                });
            }
        }

        // éªŒè¯å¯†ç  - ä¸ç®¡æ˜¯å¦åœ¨çº¿ï¼ŒåªéªŒè¯æœ¬åœ°çš„ç™»å½•å¯†ç 
        async function verifyPassword(password) {
            try {
                // è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
                const currentUserStr = localStorage.getItem('currentUser');
                if (!currentUserStr) {
                    console.error('æœªæ‰¾åˆ°å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯');
                    return false;
                }
                
                const currentUser = JSON.parse(currentUserStr);
                const phone = currentUser.phone || currentUser.login_name;
                
                if (!phone) {
                    console.error('å½“å‰ç™»å½•ç”¨æˆ·æ²¡æœ‰ç”µè¯ä¿¡æ¯');
                    return false;
                }
                
                // ä¸ç®¡æ˜¯å¦åœ¨çº¿ï¼Œåªä½¿ç”¨æœ¬åœ°å­˜å‚¨çš„ç™»å½•ä¿¡æ¯éªŒè¯
                return verifyOfflinePassword(phone, password);
            } catch (error) {
                console.error('å¯†ç éªŒè¯å¤±è´¥:', error);
                return false;
            }
        }
        
        // ç¦»çº¿éªŒè¯å¯†ç 
        function verifyOfflinePassword(phone, password) {
            try {
                // ä»æœ¬åœ°å­˜å‚¨è·å–ç™»å½•ä¿¡æ¯
                // æ£€æŸ¥æ˜¯å¦æœ‰ç™»å½•æˆåŠŸä¿å­˜çš„ä¿¡æ¯
                const loginInfoStr = localStorage.getItem('loginInfo');
                if (loginInfoStr) {
                    const loginInfo = JSON.parse(loginInfoStr);
                    // éªŒè¯phoneå’Œpasswordæ˜¯å¦åŒ¹é…
                    if (loginInfo.phone === phone && loginInfo.password === password) {
                        return true;
                    }
                }
                
                // å°è¯•ä»å…¶ä»–å¯èƒ½çš„å­˜å‚¨ä½ç½®è·å–
                const currentUserStr = localStorage.getItem('currentUser');
                if (currentUserStr) {
                    const currentUser = JSON.parse(currentUserStr);
                    // æœ‰äº›æƒ…å†µä¸‹ï¼ŒcurrentUserä¸­å¯èƒ½ç›´æ¥åŒ…å«password
                    if (currentUser.password && currentUser.password === password) {
                        return true;
                    }
                }
                
                return false;
            } catch (error) {
                console.error('ç¦»çº¿å¯†ç éªŒè¯å¤±è´¥:', error);
                return false;
            }
        }

        // æ‰§è¡Œåˆ é™¤æ“ä½œ
        function executeDelete(recordId, imageIds) {
            if (window.workRecordAPI) {
                workRecordAPI.deleteWorkRecord(recordId, imageIds).then(result => {
                    if (result.success) {
                        showNotification('åˆ é™¤æˆåŠŸ', false);
                        // é‡æ–°åŠ è½½æ˜ç»†æ•°æ®
                        loadDetailData();
                    } else {
                        showNotification('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', true);
                    }
                }).catch(error => {
                    console.error('åˆ é™¤è®°å½•å¤±è´¥:', error);
                    showNotification('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', true);
                });
            } else {
                showNotification('APIæœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', true);
            }
        }

        // æŸ¥çœ‹å¤§å›¾
        function viewImage(imageUrl) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                cursor: pointer;
            `;

            const imgContainer = document.createElement('div');
            imgContainer.style.cssText = `
                position: relative;
                width: 90%;
                height: 90%;
                display: flex;
                align-items: center;
                justify-content: center;
                overflow: hidden;
            `;

            const img = document.createElement('img');
            img.id = 'draggableImage';
            img.src = imageUrl;
            img.style.cssText = `
                max-width: 100%;
                max-height: 100%;
                object-fit: contain;
                position: absolute;
                cursor: move;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
            `;
            img.ondragstart = function() { return false; };

            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = 'Ã—';
            closeBtn.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #f5222d;
                color: white;
                border: none;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                font-size: 20px;
                cursor: pointer;
                z-index: 10001;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            imgContainer.appendChild(img);
            modal.appendChild(imgContainer);
            modal.appendChild(closeBtn);
            document.body.appendChild(modal);

            // å›¾ç‰‡æ‹–åŠ¨å’Œç¼©æ”¾åŠŸèƒ½
            let isDragging = false;
            let offsetX, offsetY;
            let scale = 1;

            img.addEventListener('mousedown', function(e) {
                isDragging = true;
                offsetX = e.clientX - img.getBoundingClientRect().left;
                offsetY = e.clientY - img.getBoundingClientRect().top;
                img.style.cursor = 'grabbing';
            });

            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                img.style.left = (e.clientX - offsetX) + 'px';
                img.style.top = (e.clientY - offsetY) + 'px';
                img.style.transform = `translate(0, 0) scale(${scale})`;
            });

            document.addEventListener('mouseup', function() {
                isDragging = false;
                img.style.cursor = 'move';
            });

            // é¼ æ ‡æ»šè½®ç¼©æ”¾åŠŸèƒ½
            img.addEventListener('wheel', function(e) {
                e.preventDefault();
                
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                scale += delta;
                scale = Math.max(0.5, Math.min(3, scale));
                
                img.style.left = '50%';
                img.style.top = '50%';
                img.style.transform = `translate(-50%, -50%) scale(${scale})`;
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal || e.target === closeBtn || e.target === imgContainer) {
                    modal.remove();
                }
            });

            closeBtn.addEventListener('click', () => {
                modal.remove();
            });
        }

        // åˆå§‹åŒ–å…¨å±€å›¾ç‰‡æ•°ç»„
        window.selectedImages = [];

        // æ¸…é™¤å›¾ç‰‡å‡½æ•°
        window.clearImage = function() {
            // æ¸…ç©ºå…¨å±€å›¾ç‰‡æ•°ç»„
            window.selectedImages = [];
            
            const container = document.getElementById('imageUploadContainer');
            if (container) {
                // ä¿ç•™æ·»åŠ æŒ‰é’®ï¼Œåˆ é™¤æ‰€æœ‰é¢„è§ˆå›¾ç‰‡
                const items = container.querySelectorAll('.image-preview-item');
                items.forEach(item => item.remove());
            }
            document.getElementById('imageUpload').value = '';
            const imageModal = document.getElementById('imageModal');
            if (imageModal) {
                imageModal.style.display = 'none';
            }
        }

        // åˆå§‹åŒ–å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½
        function initializeImageUpload() {
            if (window.imageUploadInitialized) {
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»åˆå§‹åŒ–è¿‡å›¾ç‰‡ä¸Šä¼ å®¹å™¨
            if (document.getElementById('imageUploadContainer')) {
                // å®¹å™¨å·²å­˜åœ¨ï¼Œä½†ä»éœ€è¦ç¡®ä¿äº‹ä»¶ç»‘å®šæ­£ç¡®
                window.imageUploadInitialized = true;
                bindImageUploadEvents();
                return;
            }
            
            // è·å–å›¾ç‰‡è¡¨å•ç»„ - é€šè¿‡æŸ¥æ‰¾åŒ…å«å›¾ç‰‡æ ‡ç­¾çš„div
            const labels = document.querySelectorAll('label');
            let formGroup = null;
            for (let label of labels) {
                if (label.textContent.includes('å›¾ç‰‡')) {
                    formGroup = label.closest('div');
                    break;
                }
            }
            if (!formGroup) return;
            
            // åˆ›å»ºå›¾ç‰‡ä¸Šä¼ å¾®ç¼©æ¡†å®¹å™¨
            const container = document.createElement('div');
            container.id = 'imageUploadContainer';
            container.style.display = 'flex';
            container.style.gap = '10px';
            container.style.flexWrap = 'wrap';
            container.style.marginTop = '10px';
            
            // åˆ›å»ºåˆå§‹æ·»åŠ å›¾ç‰‡å¾®ç¼©æ¡†
            const initialItem = document.createElement('div');
            initialItem.className = 'image-upload-item';
            initialItem.innerHTML = `
                <label for="imageUpload" style="display: block; width: 100px; height: 100px; border: 1px dashed #ddd; border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                    <div style="text-align: center;">
                        <div style="font-size: 24px; color: #999; margin-bottom: 5px;">+</div>
                        <div style="font-size: 12px; color: #999;">æ·»åŠ å›¾ç‰‡</div>
                    </div>
                </label>
            `;
            
            // æ·»åŠ åˆå§‹å¾®ç¼©æ¡†åˆ°å®¹å™¨
            container.appendChild(initialItem);
            
            // å°†å®¹å™¨æ·»åŠ åˆ°è¡¨å•ç»„ä¸­
            formGroup.appendChild(container);
            
            // ç»‘å®šå›¾ç‰‡é€‰æ‹©äº‹ä»¶
            bindImageUploadEvents();
            
            window.imageUploadInitialized = true;
        }

        // ç»‘å®šå›¾ç‰‡ä¸Šä¼ äº‹ä»¶
        function bindImageUploadEvents() {
            const imageUpload = document.getElementById('imageUpload');
            if (!imageUpload) return;
            
            // ç§»é™¤å·²å­˜åœ¨çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            const newImageUpload = imageUpload.cloneNode(true);
            imageUpload.parentNode.replaceChild(newImageUpload, imageUpload);
            
            newImageUpload.addEventListener('change', function(e) {
                if (e.target.files && e.target.files.length > 0) {
                    const file = e.target.files[0];
                    // å¤„ç†æ–‡ä»¶åï¼ˆä¸­æ–‡è½¬æ‹¼éŸ³ï¼‰
                    const originalName = file.name;
                    const nameWithoutExt = originalName.substring(0, originalName.lastIndexOf('.'));
                    const ext = originalName.substring(originalName.lastIndexOf('.'));
                    const pinyinName = window.convertChineseToEnglish ? window.convertChineseToEnglish(nameWithoutExt) + ext : originalName;
                    
                    // åˆ›å»ºä¸€ä¸ªæ–°çš„Fileå¯¹è±¡ï¼Œä½¿ç”¨æ‹¼éŸ³æ–‡ä»¶å
                    const fileWithPinyinName = new File([file], pinyinName, {
                        type: file.type,
                        lastModified: file.lastModified
                    });
                    
                    // æ·»åŠ åˆ°å…¨å±€æ•°ç»„
                    window.selectedImages.push(fileWithPinyinName);

                    
                    // å‹ç¼©å›¾ç‰‡
                    processImage(fileWithPinyinName).then(compressed => {
                        // ç»™å‹ç¼©åçš„blobæ·»åŠ æ‹¼éŸ³æ–‡ä»¶å
                        const blobWithPinyinName = new File([compressed.blob], pinyinName, {
                            type: compressed.blob.type
                        });
                        
                        // æ›¿æ¢å…¨å±€æ•°ç»„ä¸­çš„åŸå§‹æ–‡ä»¶ä¸ºå‹ç¼©åçš„å¸¦æ‹¼éŸ³æ–‡ä»¶åçš„blob
                        window.selectedImages[window.selectedImages.length - 1] = blobWithPinyinName;
                        
                        // æ¸²æŸ“é¢„è§ˆ
                        renderImagePreview(file, window.selectedImages.length - 1);
                    }).catch(error => {
                        console.warn('å›¾ç‰‡å‹ç¼©å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹å›¾ç‰‡:', error);
                        // æ¸²æŸ“é¢„è§ˆ
                        renderImagePreview(file, window.selectedImages.length - 1);
                    });
                    
                    // æ¸…ç©ºinputå€¼ï¼Œå…è®¸é€‰æ‹©ç›¸åŒæ–‡ä»¶
                    e.target.value = '';
                }
            });
        }

        // å›¾ç‰‡å‹ç¼©å‡½æ•°
        function processImage(file) {
            return new Promise((resolve, reject) => {
                try {
                    // æ£€æŸ¥fileæ˜¯å¦ä¸ºæœ‰æ•ˆçš„Fileæˆ–Blobå¯¹è±¡
                    if (!file || typeof file !== 'object' || !(file instanceof File || file instanceof Blob)) {
                        reject(new Error('æ— æ•ˆçš„å›¾ç‰‡æ–‡ä»¶å¯¹è±¡'));
                        return;
                    }
                    
                    // æ£€æŸ¥æ–‡ä»¶ç±»å‹æ˜¯å¦ä¸ºå›¾ç‰‡
                    if (!file.type || !file.type.startsWith('image/')) {
                        reject(new Error('ä¸æ˜¯æœ‰æ•ˆçš„å›¾ç‰‡ç±»å‹'));
                        return;
                    }
                    
                    if (typeof Compressor === 'undefined') {
                        // å¦‚æœæ²¡æœ‰åŠ è½½Compressoråº“ï¼Œç›´æ¥è¿”å›åŸå›¾
                        resolve({
                            dataURL: URL.createObjectURL(file),
                            blob: file,
                            width: 0,
                            height: 0
                        });
                        return;
                    }
                    
                    new Compressor(file, {
                        quality: 0.7,
                        maxWidth: 1920,
                        maxHeight: 1080,
                        success(result) {
                            const reader = new FileReader();
                            reader.readAsDataURL(result);
                            reader.onload = function(e) {
                                resolve({
                                    dataURL: e.target.result,
                                    blob: result,
                                    width: 0,
                                    height: 0
                                });
                            };
                            reader.onerror = function() {
                                reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                            };
                        },
                        error(err) {
                            reject(err);
                        }
                    });
                } catch (error) {
                    reject(error);
                }
            });
        }

        // æ¸²æŸ“å•ä¸ªå›¾ç‰‡é¢„è§ˆ
        function renderImagePreview(file, index) {
            const container = document.getElementById('imageUploadContainer');
            if (!container) return;
            
            const initialItem = container.querySelector('.image-upload-item');
            
            const previewItem = document.createElement('div');
            previewItem.className = 'image-preview-item';
            previewItem.style.position = 'relative';
            previewItem.style.width = '100px';
            previewItem.style.height = '100px';
            previewItem.style.borderRadius = '4px';
            previewItem.style.overflow = 'hidden';
            previewItem.style.border = '1px solid #ddd';
            
            // ä¿å­˜æ–‡ä»¶å¯¹è±¡å¼•ç”¨å’Œå”¯ä¸€æ ‡è¯†ç¬¦
            previewItem.fileObject = file;
            previewItem.dataset.fileIndex = index;
            
            // ç”Ÿæˆå”¯ä¸€æ ‡è¯†ç¬¦
            const uniqueId = `img_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            previewItem.dataset.uniqueId = uniqueId;
            
            // åˆ›å»ºä¸´æ—¶URLï¼Œæ”¯æŒFile/Blobå¯¹è±¡
            let tempUrl;
            let isUrl = false;
            
            if (file instanceof File || file instanceof Blob) {
                // å¦‚æœæ˜¯Fileæˆ–Blobå¯¹è±¡ï¼Œåˆ›å»ºæœ¬åœ°URL
                tempUrl = URL.createObjectURL(file);
            } else {
                return;
            }
            
            // åˆ›å»ºé¢„è§ˆå›¾ç‰‡
            const previewImg = document.createElement('img');
            previewImg.style.width = '100%';
            previewImg.style.height = '100%';
            previewImg.style.objectFit = 'cover';
            previewImg.style.cursor = 'pointer';
            previewImg.src = tempUrl;
            
            // æŸ¥çœ‹å¤§å›¾åŠŸèƒ½
            previewImg.addEventListener('click', function() {
                const modal = document.getElementById('imageModal');
                modal.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2001;" 
                         onclick="if(event.target === this) document.getElementById('imageModal').style.display='none'">
                        <img id="draggableImage" src="${tempUrl}" 
                             style="max-width: 90%; max-height: 90%; position: absolute; cursor: move; top: 50%; left: 50%; transform: translate(-50%, -50%);" 
                             ondragstart="return false;">
                        <button onclick="document.getElementById('imageModal').style.display='none'" 
                                style="position: fixed; top: 20px; right: 20px; background: #f5222d; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer; z-index: 2002;">Ã—</button>
                    </div>
                `;
                modal.style.display = 'block';
                
                // å›¾ç‰‡æ‹–åŠ¨å’Œç¼©æ”¾åŠŸèƒ½
                const img = document.getElementById('draggableImage');
                let isDragging = false;
                let offsetX, offsetY;
                let scale = 1; // åˆå§‹ç¼©æ”¾æ¯”ä¾‹

                img.addEventListener('mousedown', function(e) {
                    isDragging = true;
                    // è®¡ç®—æ‹–åŠ¨åç§»é‡ï¼Œè€ƒè™‘ç¼©æ”¾å› ç´ 
                    offsetX = e.clientX - img.getBoundingClientRect().left;
                    offsetY = e.clientY - img.getBoundingClientRect().top;
                    img.style.cursor = 'grabbing';
                });

                document.addEventListener('mousemove', function(e) {
                    if (!isDragging) return;
                    // æ‹–åŠ¨æ—¶ï¼Œä½¿ç”¨ç»å¯¹å®šä½è€Œétransformå¹³ç§»
                    img.style.left = (e.clientX - offsetX) + 'px';
                    img.style.top = (e.clientY - offsetY) + 'px';
                    img.style.transform = `scale(${scale})`;
                });

                document.addEventListener('mouseup', function() {
                    isDragging = false;
                    img.style.cursor = 'move';
                });
                
                // é¼ æ ‡æ»šè½®ç¼©æ”¾åŠŸèƒ½
                img.addEventListener('wheel', function(e) {
                    e.preventDefault();
                    
                    // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
                    const delta = e.deltaY > 0 ? -0.1 : 0.1;
                    scale += delta;
                    
                    // é™åˆ¶ç¼©æ”¾èŒƒå›´
                    scale = Math.max(0.5, Math.min(3, scale));
                    
                    // åº”ç”¨ç¼©æ”¾å¹¶ä¿æŒä¸­å¿ƒ
                    img.style.left = '50%';
                    img.style.top = '50%';
                    img.style.transform = `translate(-50%, -50%) scale(${scale})`;
                });
            });
            
            // åˆ›å»ºåˆ é™¤æŒ‰é’®
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = 'Ã—';
            deleteBtn.style.position = 'absolute';
            deleteBtn.style.top = '5px';
            deleteBtn.style.right = '5px';
            deleteBtn.style.width = '24px';
            deleteBtn.style.height = '24px';
            deleteBtn.style.background = 'rgba(0, 0, 0, 0.5)';
            deleteBtn.style.color = 'white';
            deleteBtn.style.border = 'none';
            deleteBtn.style.borderRadius = '50%';
            deleteBtn.style.cursor = 'pointer';
            deleteBtn.style.fontSize = '16px';
            deleteBtn.style.fontWeight = 'bold';
            deleteBtn.style.display = 'flex';
            deleteBtn.style.alignItems = 'center';
            deleteBtn.style.justifyContent = 'center';
            deleteBtn.style.padding = '0';
            
            // åˆ é™¤å›¾ç‰‡åŠŸèƒ½ - ç›´æ¥ä½¿ç”¨æ–‡ä»¶å¯¹è±¡å¼•ç”¨
            deleteBtn.addEventListener('click', function() {
                // ç›´æ¥ä½¿ç”¨æ–‡ä»¶å¯¹è±¡å¼•ç”¨åˆ é™¤
                const fileToDelete = previewItem.fileObject;
                console.log('è¦åˆ é™¤çš„æ–‡ä»¶å¯¹è±¡:', fileToDelete);
                
                if (fileToDelete && window.selectedImages) {
                    // æŸ¥æ‰¾æ–‡ä»¶å¯¹è±¡åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•
                    const fileIndex = window.selectedImages.findIndex(file => file === fileToDelete);
                    console.log('æ‰¾åˆ°æ–‡ä»¶åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•:', fileIndex);
                    
                    if (fileIndex !== -1) {
                        console.log('åˆ é™¤å‰æ•°ç»„é•¿åº¦:', window.selectedImages.length);
                        window.selectedImages.splice(fileIndex, 1);
                        console.log('åˆ é™¤åæ•°ç»„é•¿åº¦:', window.selectedImages.length);
                    } else {
                        console.log('æœªæ‰¾åˆ°æ–‡ä»¶å¯¹è±¡åœ¨æ•°ç»„ä¸­çš„ä½ç½®');
                        
                        // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå°è¯•ä½¿ç”¨æ–‡ä»¶ååŒ¹é…
                        const nameIndex = window.selectedImages.findIndex(file => file.name === fileToDelete.name);
                        if (nameIndex !== -1) {
                            console.log('é€šè¿‡æ–‡ä»¶åæ‰¾åˆ°ç´¢å¼•:', nameIndex);
                            window.selectedImages.splice(nameIndex, 1);
                            console.log('åˆ é™¤åæ•°ç»„é•¿åº¦:', window.selectedImages.length);
                        }
                    }
                }
                
                // ç§»é™¤é¢„è§ˆå…ƒç´ 
                previewItem.remove();
                
                // é‡Šæ”¾å¯¹è±¡URL
                if (!isUrl) {
                    URL.revokeObjectURL(tempUrl);
                }
                
                console.log('åˆ é™¤æ“ä½œå®Œæˆï¼Œå½“å‰ window.selectedImages:', window.selectedImages ? window.selectedImages.length : 0, 'å¼ å›¾ç‰‡');
            });
            
            // æ·»åŠ åˆ°é¢„è§ˆå¾®ç¼©æ¡†
            previewItem.appendChild(previewImg);
            previewItem.appendChild(deleteBtn);
            
            // æ’å…¥åˆ°æ·»åŠ æŒ‰é’®ä¹‹å‰
            container.insertBefore(previewItem, initialItem);
        }

        // ç»‘å®šä¿å­˜æŒ‰é’®äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            const confirmBtn = document.getElementById('confirmAccountBtn');
            
            if (confirmBtn) {
                confirmBtn.addEventListener('click', function() {
                    if (typeof saveWorkRecord === 'function') {
                        saveWorkRecord();
                    } else {
                        console.error('saveWorkRecord å‡½æ•°æœªæ‰¾åˆ°');
                    }
                });
            } else {
                console.error('æœªæ‰¾åˆ°ä¿å­˜æŒ‰é’®');
            }

            // æ·»åŠ æ–‡æ¡£ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ï¼Œç‚¹å‡»è¡¨æ ¼å¤–éƒ¨ç©ºç™½å¤„å–æ¶ˆè¡Œé€‰ä¸­
            document.addEventListener('click', function(e) {
                // æ£€æŸ¥ç‚¹å‡»çš„å…ƒç´ æ˜¯å¦åœ¨è¡¨æ ¼å†…éƒ¨
                const table = document.querySelector('.modern-table');
                if (table && !table.contains(e.target)) {
                    // å–æ¶ˆæ‰€æœ‰è¡Œçš„é€‰ä¸­çŠ¶æ€
                    document.querySelectorAll('.modern-table tbody tr.selected').forEach(selectedRow => {
                        selectedRow.classList.remove('selected');
                    });
                    
                    // æ¢å¤æŒ‰é’®æ–‡æœ¬ä¸º"ç”Ÿæˆè¡¨æ ¼"
                    const generatePdfBtn = document.getElementById('generatePdfBtn');
                    if (generatePdfBtn) {
                        generatePdfBtn.textContent = 'ç”Ÿæˆè¡¨æ ¼';
                        // æ¢å¤æŒ‰é’®åŸå§‹èƒŒæ™¯é¢œè‰²
                        generatePdfBtn.style.background = 'linear-gradient(135deg, #52c41a 0%, #389e0d 100%)';
                        generatePdfBtn.style.boxShadow = '0 2px 8px rgba(82, 196, 26, 0.3)';
                    }
                }
            });

        });
    </script>

    <!-- ä¸ºåº•éƒ¨æŒ‰é’®é¢„ç•™ç©ºé—´ï¼Œé˜²æ­¢é®æŒ¡å†…å®¹ -->
    <div style="height: 70px;"></div>

    <!-- åº•éƒ¨åˆè®¡æ˜¾ç¤º -->
    <div id="totalAmountDisplay" class="total-amount-container" style="position: fixed; bottom: 0; left: 0; right: 0; display: none; justify-content: flex-start; align-items: center; background: linear-gradient(135deg, #fff7e6 0%, #fffbe6 100%); padding: 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 999;">
        <div style="display: flex; align-items: center;">
            <span style="font-size: 16px; font-weight: bold; color: #333;">åˆè®¡ï¼š<span id="totalWorkDaysValue" style="color: #1890ff; font-size: 18px;">0</span><span style="color: #333;">å¤©</span>        <span id="totalAmountValue" style="color: #ff4d4f; font-size: 18px;">Â¥0.00</span><span style="color: #333;">å…ƒ</span></span>
            <button id="generatePdfBtn" style="margin-left: 15px; padding: 8px 16px; background: linear-gradient(135deg, #52c41a 0%, #389e0d 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 2px 8px rgba(82, 196, 26, 0.3);">ç”Ÿæˆè¡¨æ ¼</button>
        </div>
    </div>

    <!-- åº•éƒ¨ä¿å­˜æŒ‰é’® -->
    <div class="bottom-buttons" style="position: fixed; bottom: 0; left: 0; right: 0; display: flex; justify-content: flex-start; background-color: transparent; padding: 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000;">
        <button id="confirmAccountBtn" style="padding: 8px 16px; background: linear-gradient(135deg, rgba(0, 102, 204, 0.9), rgba(30, 144, 255, 0.8)); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 2px 8px rgba(0, 102, 204, 0.3);">ä¿å­˜</button>
    </div>

    <style>
        /* ç¡®è®¤è®°è´¦æŒ‰é’®æ ·å¼ - è“è‰²ä¸»é¢˜ */
        #confirmAccountBtn:hover {
            background: linear-gradient(135deg, rgba(30, 144, 255, 1), rgba(0, 102, 204, 1));
            transform: translateY(-1px) scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 102, 204, 0.4);
        }

        .total-amount-container {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 249, 250, 0.95));
            border-top: 2px solid #ff4d4f;
            backdrop-filter: blur(10px);
        }

        #totalAmountValue {
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(255, 77, 79, 0.2);
        }

        /* ç”ŸæˆPDFæŒ‰é’®æ ·å¼ */
        #generatePdfBtn:hover {
            background: linear-gradient(135deg, #73d13d 0%, #52c41a 100%);
            transform: translateY(-1px) scale(1.05);
            box-shadow: 0 4px 15px rgba(82, 196, 26, 0.4);
        }
    </style>
</body>
</html>