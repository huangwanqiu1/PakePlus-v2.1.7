<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–½å·¥æ—¥å¿—</title>
    <!-- æœ¬åœ°åŠ è½½å®Œæ•´çš„Supabaseåº“ -->
    <script src="./JavaScript/supabase/supabase.min.js"></script>
    <!-- åŠ è½½æµè§ˆå™¨ç¯å¢ƒçš„Supabaseé…ç½® -->
    <script src="./JavaScript/supabase/supabase-client.js"></script>
    <!-- ç¦»çº¿åŒæ­¥æœåŠ¡ -->
    <script src="./JavaScript/ç¦»çº¿åŒæ­¥/offline-sync-service.js"></script>
    <!-- åŒæ­¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <script src="./JavaScript/ç¦»çº¿åŒæ­¥/sync-status-indicator.js"></script>
    <!-- tus-js-clientç”¨äºå¤§æ–‡ä»¶ä¸Šä¼  -->
    <script src="./JavaScript/supabase/tus.min.js"></script>
    <!-- Compressor.jsç”¨äºå›¾ç‰‡å‹ç¼© -->
    <script src="./JavaScript/supabase/compressor.min.js"></script>
    <!-- ä¸­æ–‡è½¬æ‹¼éŸ³åº“ -->
    <script src="./JavaScript/supabase/pinyin-pro.js"></script>
    <!-- PDFç”Ÿæˆç›¸å…³åº“ -->
    <script src="./JavaScript/pdf/html2canvas.min.js"></script>
    <script src="./JavaScript/pdf/jspdf.umd.min.js"></script>
    <script src="./JavaScript/pdf/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* åŸºç¡€é‡ç½® */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        /* é¡¶éƒ¨æ“ä½œæ å®¹å™¨ */
        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        /* æŒ‰é’®é€šç”¨æ ·å¼ */
        .btn {
            padding: 8px 20px;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.3s;
            outline: none;
            min-width: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .btn-outline-primary {
            color: #409EFF;
            background-color: #ecf5ff;
            border-color: #b3d8ff;
        }

        .btn-outline-primary:hover {
            background-color: #409EFF;
            color: #fff;
            border-color: #409EFF;
        }

        .btn-primary {
            color: #fff;
            background-color: #409EFF;
            border-color: #409EFF;
            box-shadow: 0 2px 4px rgba(64, 158, 255, 0.2);
        }

        .btn-primary:hover {
            background-color: #66b1ff;
            border-color: #66b1ff;
        }

        /* --- æ—¥å¿—åˆ—è¡¨æ ·å¼ --- */
        .log-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .log-card {
            background-color: #fff;
            border-radius: 4px; /* å¡ç‰‡åœ†è§’ï¼Œå‚è€ƒå›¾ç‰‡æ¯”è¾ƒç›´ */
            border: 1px solid #ebeef5; /* æµ…æ·¡çš„è¾¹æ¡† */
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.02); /* éå¸¸æ·¡çš„é˜´å½± */
        }

        .log-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        /* å¤´åƒæ ·å¼ */
        .avatar {
            width: 48px;
            height: 48px;
            background-color: #409EFF; /* è“è‰²èƒŒæ™¯ */
            color: #fff;
            border-radius: 50%; /* åœ†å½¢ */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            font-weight: 500;
            margin-right: 12px;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .user-name {
            font-size: 16px;
            font-weight: 600; /* åŠ ç²— */
            color: #303133;
            margin-bottom: 4px;
        }

        .log-date {
            font-size: 12px;
            color: #909399; /* ç°è‰²æ—¥æœŸ */
        }

        .log-content {
            font-size: 14px;
            color: #606266;
            margin-bottom: 15px;
            line-height: 1.5;
            padding-left: 2px; /* ç¨å¾®å¯¹å…¶ä¸€ç‚¹è§†è§‰ */
        }

        .log-footer {
            font-size: 12px;
            color: #909399;
        }

        /* åº•éƒ¨æç¤ºæ–‡å­— */
        .no-more-data {
            text-align: center;
            color: #909399;
            font-size: 13px;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        /* --- ä¾§è¾¹æ åŠé®ç½©å±‚æ ·å¼ --- */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000; /* æé«˜å±‚çº§ */
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .overlay.active {
            display: block;
            opacity: 1;
        }

        .sidebar {
            position: fixed;
            top: 0;
            right: -320px; /* é»˜è®¤éšè—åœ¨å³ä¾§å¤– */
            width: 320px;
            height: 100%;
            background-color: white;
            z-index: 2001; /* æé«˜å±‚çº§ */
            box-shadow: -2px 0 8px rgba(0, 0, 0, 0.15);
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .sidebar.active {
            right: 0;
            transform: none; /* ç§»é™¤ä¹‹å‰çš„ transform */
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e8e8e8;
            font-size: 16px;
            color: #333;
            font-weight: bold;
        }

        .sidebar-content {
            padding: 24px;
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .form-item {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
        }

        .form-label {
            width: 80px;
            text-align: right;
            margin-right: 16px;
            color: #333;
            font-size: 15px; /* å¢å¤§å­—ä½“ï¼Œä» 14px æ”¹ä¸º 15px */
            margin-bottom: 0;
            min-width: unset;
            flex-shrink: unset;
        }

        .form-label .required {
            color: #ff4d4f;
            margin-right: 4px;
        }

        /* å¿…å¡«æ˜Ÿå·é€šç”¨æ ·å¼ */
        .required-star {
            color: #F56C6C;
            margin-right: 4px;
        }

        .form-input-wrapper {
            flex: 1;
            position: relative;
        }

        .form-input {
            width: 100%;
            height: 36px;
            padding: 0 12px;
            background: linear-gradient(135deg, rgba(230, 247, 255, 0.8), rgba(240, 250, 255, 0.6));
            border: 1px solid #91d5ff;
            border-radius: 4px;
            font-size: 14px; /* å¢å¤§å­—ä½“ï¼Œä» 13px æ”¹ä¸º 14px */
            color: #333;
            outline: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            box-shadow: 0 1px 2px rgba(24, 144, 255, 0.1);
            cursor: pointer;
        }
        
        .form-input:hover {
            background: linear-gradient(135deg, rgba(24, 144, 255, 0.9), rgba(64, 169, 255, 0.8));
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(24, 144, 255, 0.3);
            border-color: #1890ff;
        }
        
        .form-input:focus {
            border-color: #1890ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }

        .form-input:hover ~ .input-icon {
            color: white;
        }

        .input-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #bfbfbf;
            pointer-events: none;
            width: 16px;
            height: 16px;
            transition: color 0.3s;
        }

        .sidebar-actions {
            margin-top: 10px;
            padding-left: 20px; /* å‘å·¦ç§»åŠ¨ï¼Œå‡å°å·¦å†…è¾¹è· */
            display: flex;
            gap: 12px;
        }

        .sidebar-actions .btn {
            height: 36px;
            padding: 0 20px;
            border-radius: 6px; /* å¢å¤§åœ†è§’ï¼Œä» 4px æ”¹ä¸º 6px */
            font-size: 14px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.3s;
            min-width: unset;
        }

        .sidebar-actions .btn-primary {
            background-color: #1890ff;
            color: white;
            border-color: #1890ff;
        }

        .sidebar-actions .btn-primary:hover {
            background-color: #40a9ff;
            border-color: #40a9ff;
        }

        .sidebar-actions .btn-default {
            background-color: white;
            color: #666;
            border-color: #d9d9d9;
        }

        .sidebar-actions .btn-default:hover {
            color: #40a9ff;
            border-color: #40a9ff;
            background-color: white;
        }

        /* Date Picker Styles */
        .date-picker-dropdown {
            position: fixed;
            z-index: 2002;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            width: 250px;
            font-size: 13px;
            display: none;
            border: 1px solid #e8e8e8;
        }

        .date-picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .date-picker-header span {
            cursor: pointer;
            user-select: none;
            padding: 0 4px;
            color: #999;
        }
        
        .date-picker-header span:hover {
            color: #1890ff;
        }

        .current-year-month {
            font-weight: bold;
            color: #333 !important;
            font-size: 14px;
        }

        .date-picker-body {
            padding: 8px;
        }

        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            margin-bottom: 6px;
            color: #666;
            font-size: 12px;
        }

        .days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .day-cell {
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            border: 1px solid #f0f0f0;
        }

        .day-cell:hover {
            background-color: #f5f5f5;
            border-color: #d9d9d9;
        }

        .day-cell.current-month {
            color: #333;
        }

        .day-cell.prev-month, .day-cell.next-month {
            color: #ccc;
        }

        .day-cell.selected {
            background-color: #1890ff;
            color: white;
            border-color: #1890ff;
            border-radius: 8px;
        }
        
        .day-cell.today {
            border: 1px solid #1890ff;
            border-radius: 8px;
            font-weight: bold;
        }

        .day-cell.disabled {
            color: #d9d9d9;
            background-color: #f5f5f5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .date-picker-footer {
            padding: 8px;
            border-top: 1px solid #f0f0f0;
            text-align: center;
        }

        .today-btn {
            color: #1890ff;
            cursor: pointer;
            font-weight: 500;
        }
        
        .today-btn:hover {
            color: #40a9ff;
        }

        /* é¡¹ç›®åç§°è¾“å…¥æ¡†ç‰¹æ®Šæ ·å¼ */
        #projectName {
            background-color: #f8f9fa !important;
            cursor: not-allowed !important;
            color: #6c757d !important;
            border: 1px solid #dee2e6 !important;
            font-weight: 500;
            font-size: 16px !important;
        }
        
        #projectName:focus {
            outline: none !important;
            box-shadow: none !important;
            border-color: #dee2e6 !important;
        }

    /* --- å†™æ—¥å¿—ç•Œé¢æ ·å¼ --- */
        .write-log-container {
            background-color: #fff;
            border-radius: 8px;
            padding: 30px;
            min-height: 500px;
            display: none; /* é»˜è®¤éšè— */
        }

        .write-form-group {
            margin-bottom: 24px;
            display: flex;
            align-items: flex-start; /* é¡¶éƒ¨å¯¹é½ï¼Œé€‚åº”å¤šè¡Œæ–‡æœ¬æ¡† */
        }

        .write-form-label {
            width: 80px;
            text-align: right;
            margin-right: 20px;
            color: #606266;
            font-size: 15px;
            line-height: 36px; /* ä¸è¾“å…¥æ¡†é«˜åº¦ä¸€è‡´ */
            flex-shrink: 0;
        }

        .write-form-content {
            flex: 1;
            max-width: 600px; /* é™åˆ¶æœ€å¤§å®½åº¦ */
            position: relative;
        }

        /* å¤©æ°”å¡ç‰‡æ ·å¼ */
        .weather-cards {
            display: flex;
            gap: 20px;
        }

        .weather-card {
            width: 200px;
            padding: 40px 15px 15px 15px; /* é¡¶éƒ¨ç•™å‡ºç©ºé—´ç»™æ ‡ç­¾ */
            border-radius: 8px;
            position: relative;
        }

        .weather-card.am {
            background-color: #fcf6ec; /* æµ…æ©™è‰²èƒŒæ™¯ */
        }

        .weather-card.pm {
            background-color: #f0f8ff; /* æµ…è“è‰²èƒŒæ™¯ */
        }

        .weather-tag {
            position: absolute;
            top: 0;
            left: 0;
            padding: 4px 16px;
            border-radius: 8px 0 10px 0; /* å·¦ä¸Šè§’åœ†è§’å¤„ç† */
            font-size: 13px;
            color: #fff;
            line-height: 1.5;
        }

        .weather-tag.am {
            background-color: #ff9800; /* æ©™è‰² */
        }

        .weather-tag.pm {
            background-color: #409EFF; /* è“è‰² */
        }

        .weather-info {
            font-size: 14px;
            color: #606266;
            line-height: 1.8;
        }

        .weather-edit-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            color: #409EFF; /* è¿™é‡Œçš„ä¿®æ”¹æŒ‰é’®é¢œè‰²å¯èƒ½éœ€è¦æ ¹æ®å¡ç‰‡ç±»å‹è°ƒæ•´ï¼Œä½†ç»Ÿä¸€è“è‰²ä¹Ÿè¡Œ */
            color: #5d8aff; /* ç»Ÿä¸€ç”¨åè“ç´«è‰²ï¼Œæˆ–è€…è·Ÿéšä¸»é¢˜ */
            color: #409EFF;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
        }
        
        /* é’ˆå¯¹AMå¡ç‰‡çš„ä¿®æ”¹æŒ‰é’®é¢œè‰²å¾®è°ƒï¼Œå¦‚æœéœ€è¦çš„è¯ã€‚æš‚æ—¶ä¿æŒä¸€è‡´ */
        .weather-card.am .weather-edit-btn {
            color: #6a71e2; /* å›¾ç‰‡ä¸­å¯èƒ½æ˜¯è“ç´«è‰² */
        }
        
        .weather-card.pm .weather-edit-btn {
            color: #6a71e2;
        }

        /* æ–‡æœ¬åŸŸæ ·å¼ */
        .log-textarea {
            width: 100%;
            height: 150px;
            padding: 12px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            resize: none;
            outline: none;
            font-family: inherit;
            font-size: 14px;
            color: #606266;
            transition: border-color 0.2s;
        }

        .log-textarea:focus {
            border-color: #409EFF;
        }

        .log-textarea.error {
            border-color: #F56C6C;
        }

        .rich-editor-editable.error {
            background-color: #fef0f0;
        }

        .textarea-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
        }

        .char-count {
            font-size: 12px;
            color: #909399;
        }

        .error-message {
            font-size: 12px;
            color: #F56C6C;
            visibility: hidden;
        }

        /* å›¾ç‰‡ä¸Šä¼ æ ·å¼ */
        .upload-box {
            width: 100px;
            height: 100px;
            border: 1px dashed #d9d9d9;
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: border-color 0.3s;
            background-color: #fafafa;
        }

        .upload-box:hover {
            border-color: #409EFF;
        }

        .upload-icon {
            font-size: 24px;
            color: #8c939d;
        }

        /* åº•éƒ¨æ“ä½œæ  */
        .footer-actions {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ebeef5;
            display: flex;
            gap: 15px;
        }

        /* å¤©æ°”é€‰æ‹©ä¾§è¾¹æ æ ·å¼ */
        .weather-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            margin-bottom: 30px;
        }

        .weather-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 10px 5px;
            border: 1px solid transparent;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .weather-item:hover {
            background-color: #f5f7fa;
        }

        .weather-item.selected {
            background-color: #ecf5ff;
            border-color: #409EFF;
        }

        .weather-icon {
            font-size: 24px;
            margin-bottom: 8px;
            line-height: 1;
        }

        .weather-name {
            font-size: 12px;
            color: #606266;
        }

        .weather-section-title {
            font-size: 16px;
            font-weight: bold;
            color: #303133;
            margin-bottom: 15px;
        }

        .temp-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .temp-input {
            width: 100%;
            height: 40px;
            padding: 0 30px 0 12px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            outline: none;
            font-size: 14px;
            color: #606266;
        }

        .temp-input:focus {
            border-color: #409EFF;
        }

        .temp-suffix {
            position: absolute;
            right: 12px;
            color: #909399;
            font-size: 14px;
        }

        /* åŠ è½½åŠ¨ç”» */
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes dash {
            0% { stroke-dasharray: 1, 150; stroke-dashoffset: 0; }
            50% { stroke-dasharray: 90, 150; stroke-dashoffset: -35; }
            100% { stroke-dasharray: 90, 150; stroke-dashoffset: -124; }
        }

        /* éšè—ä¸åŒæ¨¡å¼çš„ä¾§è¾¹æ å†…å®¹ */
        .sidebar-content-section {
            display: none;
        }
        
        .sidebar-content-section.active {
            display: block;
        }

        /* æ¨¡æ€æ¡†é€šç”¨æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2005; /* æ¯”ä¾§è¾¹æ é«˜ */
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.2s ease-out;
        }

        .modal-container {
            background-color: white;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            animation: slideUp 0.2s ease-out;
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #ebeef5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: #303133;
            margin: 0;
        }

        .modal-close {
            cursor: pointer;
            font-size: 24px;
            color: #909399;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .modal-close:hover {
            color: #F56C6C;
            background-color: rgba(245, 108, 108, 0.1);
            transform: rotate(90deg) scale(1.1);
        }

        .modal-body {
            padding: 20px;
            font-size: 14px;
            color: #606266;
            line-height: 1.5;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #ebeef5;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* æ¨¡æ€æ¡†æŒ‰é’®ç‰¹æ®ŠåŠ¨ç”» */
        .modal-footer .btn {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .modal-footer .btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .modal-footer .btn:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            padding: 20px 20px 10px 20px;
            border-radius: 25px;
            width: 380px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2), 0 10px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.8);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .form-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

    </style>
</head>
<body>

    <!-- é®ç½©å±‚ -->
    <div class="overlay" id="overlay"></div>

    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            é€‰æ‹©æ—¶é—´èŒƒå›´
        </div>
        <div class="sidebar-content">
            <!-- æ—¥æœŸèŒƒå›´é€‰æ‹©å†…å®¹ -->
            <div id="dateRangeContent" class="sidebar-content-section active">
                <div class="form-item">
                    <label class="form-label"><span class="required">*</span>å¼€å§‹æ—¥æœŸ</label>
                    <div class="form-input-wrapper">
                        <input type="text" class="form-input" id="startDate" placeholder="è¯·é€‰æ‹©æ—¥æœŸ" readonly>
                        <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                    </div>
                </div>
                <div class="form-item">
                    <label class="form-label"><span class="required">*</span>ç»“æŸæ—¥æœŸ</label>
                    <div class="form-input-wrapper">
                        <input type="text" class="form-input" id="endDate" placeholder="è¯·é€‰æ‹©æ—¥æœŸ" readonly>
                        <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- å¤©æ°”è®¾ç½®å†…å®¹ -->
            <div id="weatherSettingsContent" class="sidebar-content-section">
                <div class="weather-grid" id="weatherGrid">
                    <!-- JS Generated -->
                </div>
                
                <div class="weather-section-title" id="tempTitle">è®¾ç½®ä¸Šåˆæ¸©åº¦</div>
                <div class="temp-input-wrapper">
                    <input type="number" class="temp-input" id="weatherTemp" value="19">
                    <span class="temp-suffix">â„ƒ</span>
                </div>
            </div>
            
            <!-- æŒ‰é’®ç§»åŠ¨åˆ°è¿™é‡Œ -->
            <div class="sidebar-actions">
                <button class="btn btn-primary" id="confirmBtn">ç¡®å®š</button>
                <button class="btn btn-default" id="cancelBtn">å–æ¶ˆ</button>
            </div>
        </div>
        <!-- ç§»é™¤åŸæ¥çš„ footer -->
    </div>

    <!-- Date Picker Dropdown -->
    <div class="date-picker-dropdown" id="datePicker">
        <div class="date-picker-header">
            <span class="year-prev-btn" id="pickerPrevYear" title="ä¸Šä¸€å¹´">&lt;&lt;</span>
            <span class="month-prev-btn" id="pickerPrevMonth" title="ä¸Šä¸ªæœˆ">&lt;</span>
            <span class="current-year-month" id="pickerCurrentMonth">2026å¹´ 1æœˆ</span>
            <span class="month-next-btn" id="pickerNextMonth" title="ä¸‹ä¸ªæœˆ">&gt;</span>
            <span class="year-next-btn" id="pickerNextYear" title="ä¸‹ä¸€å¹´">&gt;&gt;</span>
        </div>
        <div class="date-picker-body">
            <div class="weekdays">
                <span>ä¸€</span><span>äºŒ</span><span>ä¸‰</span><span>å››</span><span>äº”</span><span>å…­</span><span>æ—¥</span>
            </div>
            <div class="days-grid" id="daysGrid">
                <!-- JS generated -->
            </div>
        </div>
        <div class="date-picker-footer">
            <span class="today-btn" id="pickerTodayBtn">ä»Šå¤©</span>
        </div>
    </div>

    <!-- åˆ—è¡¨é¡µå®¹å™¨ -->
    <div id="listPageContainer">
        <!-- é¡¶éƒ¨æ“ä½œæ  -->
        <div class="header-actions">
            <button class="btn btn-outline-primary" id="filterBtn">ç­›é€‰</button>
            <button class="btn btn-outline-primary" id="exportBtn">æ‰¹é‡å¯¼å‡º</button>
            <button class="btn btn-primary" id="writeLogBtn">å†™æ—¥å¿—</button>
        </div>

        <!-- æ—¥å¿—åˆ—è¡¨åŒºåŸŸ -->
        <div class="log-list">
            <div class="loading-state" style="text-align: center; padding: 40px; color: #909399;">
                <div style="margin-bottom: 10px;">
                    <svg viewBox="0 0 24 24" width="32" height="32" style="animation: rotate 1s linear infinite;">
                        <circle cx="12" cy="12" r="10" stroke="#409EFF" stroke-width="3" fill="none" stroke-dasharray="31.4 31.4" stroke-linecap="round" style="animation: dash 1.5s ease-in-out infinite;"/>
                    </svg>
                </div>
                <div>æ•°æ®æ­£åœ¨åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- å†™æ—¥å¿—ç•Œé¢å®¹å™¨ -->
    <div id="writeLogContainer" class="write-log-container">
        <!-- é¡¹ç›®åç§° -->
        <div class="write-form-group">
            <label class="write-form-label">é¡¹ç›®åç§°</label>
            <div class="write-form-content">
                <input type="text" class="form-input" id="projectName" value="123" readonly disabled style="background-color: #f8f9fa; cursor: not-allowed; color: #6c757d;">
            </div>
        </div>

        <!-- è®°å½•æ—¥æœŸ -->
        <div class="write-form-group">
            <label class="write-form-label"><span class="required-star">*</span>è®°å½•æ—¥æœŸ</label>
            <div class="write-form-content">
                <div class="form-input-wrapper">
                    <input type="text" class="form-input" id="logDate" value="2026å¹´02æœˆ02æ—¥ (ä»Šå¤©)" readonly>
                    <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                </div>
            </div>
        </div>

        <!-- å¤©æ°” -->
        <div class="write-form-group">
            <label class="write-form-label">å¤©æ°”</label>
            <div class="write-form-content">
                <div class="weather-cards">
                    <!-- ä¸Šåˆå¡ç‰‡ -->
                    <div class="weather-card am">
                        <div class="weather-tag am">ä¸Šåˆ</div>
                        <div class="weather-edit-btn">ä¿®æ”¹</div>
                        <div class="weather-info">
                            <div class="weather-empty-text" style="color: #909399; margin-top: 10px; text-align: center;">æœªè®¾ç½®</div>
                        </div>
                    </div>
                    <!-- ä¸‹åˆå¡ç‰‡ -->
                    <div class="weather-card pm">
                        <div class="weather-tag pm">ä¸‹åˆ</div>
                        <div class="weather-edit-btn">ä¿®æ”¹</div>
                        <div class="weather-info">
                            <div class="weather-empty-text" style="color: #909399; margin-top: 10px; text-align: center;">æœªè®¾ç½®</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ—¥å¿—å†…å®¹ -->
        <div class="write-form-group">
            <label class="write-form-label"><span class="required-star">*</span>æ—¥å¿—å†…å®¹</label>
            <div class="write-form-content">
                <textarea class="log-textarea"></textarea>
                <div class="textarea-footer">
                    <span class="error-message">è¯·è¾“å…¥æ—¥å¿—å†…å®¹</span>
                    <span class="char-count">0 / 2000</span>
                </div>
            </div>
        </div>

        <!-- å›¾ç‰‡ -->
        <div class="write-form-group">
            <label class="write-form-label">å›¾ç‰‡</label>
            <div class="write-form-content" id="imageUploadSection">
                <div id="imageUploadContainer" style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <div class="image-upload-item" id="addImgBtn" style="cursor: pointer;">
                        <div class="upload-box">
                            <span class="upload-icon">+</span>
                        </div>
                    </div>
                </div>
                <input type="file" id="imageUpload" accept="image/*" style="display: none;" multiple>
            </div>
        </div>

        <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
        <div class="footer-actions">
            <button class="btn btn-default" id="cancelWriteBtn" style="border: 1px solid #dcdfe6;">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="saveLogBtn">ä¿å­˜æ—¥å¿—</button>
        </div>
    </div>

    <!-- æ—¥å¿—è¯¦æƒ…å®¹å™¨ -->
    <div id="logDetailContainer" class="write-log-container" style="display: none; padding: 20px;">
        <!-- å¤´éƒ¨ï¼šå¤´åƒ + ä¿¡æ¯ + æ“ä½œæŒ‰é’® -->
        <div style="display: flex; align-items: flex-start; margin-bottom: 20px; border-bottom: 1px solid #ebeef5; padding-bottom: 20px;">
            <div style="display: flex; align-items: center; margin-right: 20px;">
                <div class="avatar" id="detailAvatar" style="width: 50px; height: 50px; background-color: #409EFF; font-size: 16px;">ç”¨æˆ·</div>
                <div class="user-info">
                    <span class="user-name" id="detailUserName" style="font-size: 16px; margin-bottom: 5px;">ç”¨æˆ·</span>
                    <span class="log-date" id="detailDate" style="font-size: 13px;">-</span>
                </div>
            </div>
            <!-- æ“ä½œæŒ‰é’®ï¼šå»æ‰ justify-content: space-between åï¼Œè‡ªç„¶å·¦ç§»ã€‚
                 margin-top ç¨å¾®è°ƒæ•´ä»¥å¯¹é½ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼Œè¿™é‡Œé»˜è®¤ flex-start å¯¹é½ã€‚
                 ä¸ºäº†è®©æŒ‰é’®ä¸ç´§è´´ç”¨æˆ·ä¿¡æ¯ï¼Œå¯ä»¥ç»™ä¸Šé¢çš„ user-info å®¹å™¨åŠ  margin-rightï¼Œæˆ–è€…ç»™æŒ‰é’®å®¹å™¨åŠ  margin-leftã€‚
                 è¿™é‡Œç»™æŒ‰é’®å®¹å™¨åŠ  margin-left: auto; å¯ä»¥æ¨åˆ°å³è¾¹ï¼Œä½†ç”¨æˆ·è¦æ±‚å·¦ç§»ã€‚
                 å¦‚æœæƒ³ç´§è·Ÿåœ¨ç”¨æˆ·ä¿¡æ¯åé¢ï¼Œå°±ä¸ç”¨åŠ  margin-left: autoã€‚
            -->
            <div style="display: flex; gap: 10px; margin-left: 20px; align-self: center;">
                <button id="detailDeleteBtn" class="btn" style="color: #F56C6C; background: #fff; border: 1px solid #fde2e2;" onmouseover="this.style.backgroundColor='#fef0f0'; this.style.borderColor='#fde2e2';" onmouseout="this.style.backgroundColor='#fff'; this.style.borderColor='#fde2e2';">åˆ é™¤</button>
                <button class="btn" style="color: #409EFF; background: #fff; border: 1px solid #b3d8ff;" onmouseover="this.style.backgroundColor='#ecf5ff'; this.style.borderColor='#b3d8ff';" onmouseout="this.style.backgroundColor='#fff'; this.style.borderColor='#b3d8ff';" id="detailModifyBtn">ä¿®æ”¹</button>
            </div>
        </div>

        <!-- å¤©æ°”æ¿å— -->
        <div style="margin-bottom: 30px;">
            <h3 style="font-size: 16px; font-weight: bold; color: #303133; margin-bottom: 15px;">å¤©æ°”</h3>
            <div class="weather-cards">
                <!-- ä¸Šåˆå¡ç‰‡ (åªè¯») -->
                <div class="weather-card am" style="padding-top: 40px; width: 220px;">
                    <div class="weather-tag am">ä¸Šåˆ</div>
                    <div class="weather-info">
                        <div style="margin-bottom: 8px;">å¤©æ°”ï¼š<svg viewBox="0 0 64 64" width="20" height="20" style="vertical-align: middle;"><circle cx="32" cy="32" r="14" fill="#FFD700" stroke="#FFA500" stroke-width="2"/><g stroke="#FFD700" stroke-width="3" stroke-linecap="round"><line x1="32" y1="10" x2="32" y2="4"/><line x1="32" y1="54" x2="32" y2="60"/><line x1="54" y1="32" x2="60" y2="32"/><line x1="4" y1="32" x2="10" y2="32"/><line x1="48" y1="16" x2="52" y2="12"/><line x1="16" y1="48" x2="12" y2="52"/><line x1="48" y1="48" x2="52" y2="52"/><line x1="16" y1="16" x2="12" y2="12"/></g></svg> <span style="vertical-align: middle;">æ™´</span></div>
                        <div>æ¸©åº¦ï¼š19.00â„ƒ</div>
                    </div>
                </div>
                <!-- ä¸‹åˆå¡ç‰‡ (åªè¯») -->
                <div class="weather-card pm" style="padding-top: 40px; width: 220px;">
                    <div class="weather-tag pm">ä¸‹åˆ</div>
                    <div class="weather-info">
                        <div style="margin-bottom: 8px;">å¤©æ°”ï¼š<svg viewBox="0 0 64 64" width="20" height="20" style="vertical-align: middle;"><circle cx="32" cy="32" r="14" fill="#FFD700" stroke="#FFA500" stroke-width="2"/><g stroke="#FFD700" stroke-width="3" stroke-linecap="round"><line x1="32" y1="10" x2="32" y2="4"/><line x1="32" y1="54" x2="32" y2="60"/><line x1="54" y1="32" x2="60" y2="32"/><line x1="4" y1="32" x2="10" y2="32"/><line x1="48" y1="16" x2="52" y2="12"/><line x1="16" y1="48" x2="12" y2="52"/><line x1="48" y1="48" x2="52" y2="52"/><line x1="16" y1="16" x2="12" y2="12"/></g></svg> <span style="vertical-align: middle;">æ™´</span></div>
                        <div>æ¸©åº¦ï¼š19.00â„ƒ</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ—¥å¿—å†…å®¹æ¿å— -->
        <div>
            <h3 style="font-size: 16px; font-weight: bold; color: #303133; margin-bottom: 15px;">æ—¥å¿—å†…å®¹</h3>
            <div id="detailContent" style="font-size: 14px; color: #606266; line-height: 1.6; margin-bottom: 20px; white-space: pre-wrap;">
                -
            </div>
            <!-- å›¾ç‰‡åˆ—è¡¨ -->
            <div id="detailImageList" style="display: flex; gap: 10px; flex-wrap: wrap;">
                <!-- å›¾ç‰‡å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>

            <!-- åº•éƒ¨å–æ¶ˆæŒ‰é’® -->
            <div style="margin-top: 30px; display: flex; justify-content: flex-start; gap: 12px;">
                <button id="detailCancelBtn" class="btn" style="color: #606266; background: #fff; border: 1px solid #dcdfe6; padding: 10px 25px;" onmouseover="this.style.color='#409EFF'; this.style.borderColor='#c6e2ff'; this.style.backgroundColor='#ecf5ff';" onmouseout="this.style.color='#606266'; this.style.borderColor='#dcdfe6'; this.style.backgroundColor='#fff';">å–æ¶ˆ</button>
                <button id="detailPrintBtn" class="btn" style="color: #fff; background: #409EFF; border: 1px solid #409EFF; padding: 10px 25px;" onmouseover="this.style.backgroundColor='#66b1ff'; this.style.borderColor='#66b1ff';" onmouseout="this.style.backgroundColor='#409EFF'; this.style.borderColor='#409EFF';">æ‰“å°æ–½å·¥æ—¥å¿—</button>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="imageModal" style="display: none;"></div>

    <!-- ç¡®è®¤åˆ é™¤æ¨¡æ€æ¡† -->
    <div id="confirmModal" class="modal-overlay" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h3>ç¡®è®¤åˆ é™¤</h3>
                <span class="modal-close" id="confirmModalClose">&times;</span>
            </div>
            <div class="modal-body">
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                    <svg viewBox="0 0 1024 1024" width="24" height="24" style="flex-shrink: 0; color: #E6A23C;">
                        <path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z" fill="currentColor"></path>
                        <path d="M464 688a48 48 0 1 0 96 0 48 48 0 1 0-96 0zm24-112h48c4.4 0 8-3.6 8-8V296c0-4.4-3.6-8-8-8h-48c-4.4 0-8 3.6-8 8v272c0 4.4 3.6 8 8 8z" fill="currentColor"></path>
                    </svg>
                    <p style="margin: 0; padding-top: 2px;">ç¡®å®šè¦åˆ é™¤è¿™æ¡æ–½å·¥æ—¥å¿—å—ï¼Ÿ<br><span style="color: #909399; font-size: 13px;">æ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œè¯·è°¨æ…æ“ä½œã€‚</span></p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-default" id="confirmModalCancel">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="confirmModalOk" style="background-color: #F56C6C; border-color: #F56C6C;">ç¡®å®šåˆ é™¤</button>
            </div>
        </div>
    </div>

    <div class="modal" id="construction-log-export-choice-modal" style="display: none;">
        <div class="modal-content" style="text-align: center; width: 320px; padding: 15px;">
            <h3 style="color: #409EFF; margin-bottom: 15px; font-size: 18px;">é€‰æ‹©å¯¼å‡ºç±»å‹</h3>
            <div style="display: flex; gap: 15px; justify-content: center; margin-bottom: 15px;">
                <div style="flex: 1; padding: 15px 10px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.3s; background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);" id="construction-log-pdf-option" onmouseover="this.style.borderColor='#667eea'; this.style.boxShadow='0 8px 20px rgba(102, 126, 234, 0.2)';" onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none';">
                    <div style="font-size: 36px; margin-bottom: 8px; color: #667eea;">ğŸ“„</div>
                    <div style="font-size: 14px; font-weight: bold; color: #374151; margin-bottom: 4px;">å¯¼å‡ºPDF</div>
                    <div style="font-size: 11px; color: #64748b;">ç”ŸæˆPDFæ ¼å¼</div>
                </div>
                <div style="flex: 1; padding: 15px 10px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.3s; background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);" id="construction-log-word-option" onmouseover="this.style.borderColor='#10b981'; this.style.boxShadow='0 8px 20px rgba(16, 185, 129, 0.2)';" onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none';">
                    <div style="font-size: 36px; margin-bottom: 8px; color: #10b981;">ğŸ“</div>
                    <div style="font-size: 14px; font-weight: bold; color: #374151; margin-bottom: 4px;">å¯¼å‡ºWord</div>
                    <div style="font-size: 11px; color: #64748b;">ç”ŸæˆWordæ ¼å¼</div>
                </div>
            </div>
            <div class="form-buttons">
                <button id="construction-log-cancel-export-btn" style="background-color: #64748b; color: #fff; border: none; padding: 10px 24px; border-radius: 10px; cursor: pointer;" onmouseover="this.style.backgroundColor='#475569'" onmouseout="this.style.backgroundColor='#64748b'">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ -->
    <script src="./JavaScript/æ–½å·¥æ—¥å¿—/richTextEditor.js"></script>
    <!-- æ–½å·¥æ—¥å¿—API -->
    <script src="./JavaScript/æ–½å·¥æ—¥å¿—/construction-log-api.js"></script>
    <!-- æ–½å·¥æ—¥å¿—å¯¼å‡ºPDF -->
    <script src="./JavaScript/æ–½å·¥æ—¥å¿—/export-log-pdf.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const filterBtn = document.getElementById('filterBtn');
            const exportBtn = document.getElementById('exportBtn'); // è·å–å¯¼å‡ºæŒ‰é’®
            const overlay = document.getElementById('overlay');
            const sidebar = document.getElementById('sidebar');
            const cancelBtn = document.getElementById('cancelBtn');
            const confirmBtn = document.getElementById('confirmBtn');
            const sidebarHeader = document.querySelector('.sidebar-header'); // è·å–ä¾§è¾¹æ æ ‡é¢˜

            // æ–°å¢å…ƒç´ è·å–
            const listPageContainer = document.getElementById('listPageContainer');
            const writeLogContainer = document.getElementById('writeLogContainer');
            const logDetailContainer = document.getElementById('logDetailContainer'); // æ–°å¢è¯¦æƒ…é¡µå®¹å™¨
            const writeLogBtn = document.getElementById('writeLogBtn');
            const cancelWriteBtn = document.getElementById('cancelWriteBtn');
            const saveLogBtn = document.getElementById('saveLogBtn');
            const detailModifyBtn = document.getElementById('detailModifyBtn'); // è¯¦æƒ…é¡µçš„ä¿®æ”¹æŒ‰é’®
            const detailCancelBtn = document.getElementById('detailCancelBtn'); // è¯¦æƒ…é¡µçš„å–æ¶ˆæŒ‰é’®
            const detailDeleteBtn = document.getElementById('detailDeleteBtn'); // è¯¦æƒ…é¡µçš„åˆ é™¤æŒ‰é’®
            const detailPrintBtn = document.getElementById('detailPrintBtn');
            const exportChoiceModal = document.getElementById('construction-log-export-choice-modal');
            const exportPdfOption = document.getElementById('construction-log-pdf-option');
            const exportWordOption = document.getElementById('construction-log-word-option');
            const exportCancelBtn = document.getElementById('construction-log-cancel-export-btn');

            // æ¨¡æ€æ¡†ç›¸å…³å…ƒç´ 
            const confirmModal = document.getElementById('confirmModal');
            const confirmModalClose = document.getElementById('confirmModalClose');
            const confirmModalCancel = document.getElementById('confirmModalCancel');
            const confirmModalOk = document.getElementById('confirmModalOk');

            // æ¨¡æ€æ¡†å…³é—­å‡½æ•°
            function closeConfirmModal() {
                confirmModal.style.display = 'none';
            }

            // ç»‘å®šæ¨¡æ€æ¡†å…³é—­äº‹ä»¶
            if (confirmModalClose) confirmModalClose.addEventListener('click', closeConfirmModal);
            if (confirmModalCancel) confirmModalCancel.addEventListener('click', closeConfirmModal);
            
            // ç‚¹å‡»é®ç½©å±‚å…³é—­
            if (confirmModal) {
                confirmModal.addEventListener('click', function(e) {
                    if (e.target === confirmModal) {
                        closeConfirmModal();
                    }
                });
            }

            // å½“å‰ç¼–è¾‘çš„æ—¥å¿—IDï¼ˆç”¨äºåŒºåˆ†æ–°å¢å’Œç¼–è¾‘æ¨¡å¼ï¼‰
            let currentEditingLogId = null;
            // å½“å‰æŸ¥çœ‹æ—¥å¿—çš„å›¾ç‰‡IDåˆ—è¡¨ï¼ˆç”¨äºåˆ é™¤ï¼‰
            let currentLogImageIds = [];
            // å­˜å‚¨åŸå§‹äº‘ç«¯å›¾ç‰‡URLï¼ˆç”¨äºåˆ é™¤äº‘ç«¯æ—§å›¾ç‰‡ï¼‰
            let originalCloudImageUrls = [];
            let allConstructionLogs = [];
            let currentViewingLog = null;
            let pendingExportContext = null;

            // é‡ç½®å†™æ—¥å¿—è¡¨å•
            function resetWriteLogForm() {
                // 1. é‡ç½®æ—¥æœŸä¸ºä»Šå¤©
                const logDateInput = document.getElementById('logDate');
                if (logDateInput) {
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    logDateInput.value = `${year}å¹´${month}æœˆ${day}æ—¥ (ä»Šå¤©)`;
                }

                // 2. é‡ç½®å¤©æ°”
                document.querySelectorAll('.weather-card').forEach(card => {
                    const infoDiv = card.querySelector('.weather-info');
                    if (infoDiv) {
                        infoDiv.innerHTML = '<div class="weather-empty-text" style="color: #909399; margin-top: 10px; text-align: center;">æœªè®¾ç½®</div>';
                    }
                });

                // 3. æ¸…ç©ºç¼–è¾‘å™¨
                if (editor) {
                    editor.setContent('');
                }

                // 4. æ¸…ç©ºå›¾ç‰‡
                window.selectedImages = [];
                originalCloudImageUrls = [];
                const imageContainer = document.getElementById('imageUploadContainer');
                if (imageContainer) {
                    // ä¿ç•™æ·»åŠ æŒ‰é’®ï¼Œåˆ é™¤é¢„è§ˆé¡¹
                    const previews = imageContainer.querySelectorAll('.image-preview-item');
                    previews.forEach(p => p.remove());
                }

                // 5. é‡ç½®å…¨å±€çŠ¶æ€
                currentEditingLogId = null;
                
                // 6. é‡ç½®æ ‡é¢˜
                document.title = 'æ–°å¢æ–½å·¥æ—¥å¿—';
                if (window.parent) {
                    window.parent.postMessage({ type: 'updateTitle', title: 'æ–°å¢æ–½å·¥æ—¥å¿—' }, '*');
                }
            }

            // åˆ‡æ¢æ˜¾ç¤ºå†™æ—¥å¿—ç•Œé¢
            writeLogBtn.addEventListener('click', function() {
                listPageContainer.style.display = 'none';
                logDetailContainer.style.display = 'none'; // ç¡®ä¿è¯¦æƒ…é¡µéšè—
                writeLogContainer.style.display = 'block';
                
                // é‡ç½®è¡¨å•
                resetWriteLogForm();
            });

            // è¿”å›åˆ—è¡¨ç•Œé¢
            function backToList() {
                writeLogContainer.style.display = 'none';
                logDetailContainer.style.display = 'none'; // è¯¦æƒ…é¡µéšè—
                listPageContainer.style.display = 'block';
                document.title = 'æ–½å·¥æ—¥å¿—'; // æ¢å¤åŸæ ‡é¢˜ï¼ˆå‡è®¾åŸæ ‡é¢˜æ˜¯æ–½å·¥æ—¥å¿—ï¼‰
                // é€šçŸ¥çˆ¶é¡µé¢ï¼ˆé¦–é¡µï¼‰æ¢å¤æ ‡é¢˜
                window.parent.postMessage({ type: 'updateTitle', title: 'æ–½å·¥æ—¥å¿—' }, '*');
            }

            cancelWriteBtn.addEventListener('click', backToList);
            
            // ä¿å­˜æ—¥å¿—æŒ‰é’® - ä»å¯Œæ–‡æœ¬ç¼–è¾‘å™¨è·å–å†…å®¹
            saveLogBtn.addEventListener('click', async function() {
                const content = editor.getContent();
                
                // éªŒè¯å†…å®¹æ˜¯å¦ä¸ºç©º
                if (!content || content.trim().length === 0) {
                    const errorMsg = document.querySelector('.error-message');
                    const editableDiv = document.querySelector('.rich-editor-editable');
                    if (editableDiv) editableDiv.classList.add('error');
                    if (errorMsg) errorMsg.style.visibility = 'visible';
                    return; // é˜»æ­¢ä¿å­˜
                }
                
                // æ£€æŸ¥APIæ˜¯å¦å·²åˆå§‹åŒ–
                if (!window.constructionLogAPI) {
                    showNotification('APIæ­£åœ¨åˆå§‹åŒ–ï¼Œè¯·ç¨å€™é‡è¯•', true);
                    return;
                }
                
                // è·å–é¡¹ç›®ID
                const projectId = localStorage.getItem('currentProjectId');
                if (!projectId) {
                    showNotification('æœªæ‰¾åˆ°é¡¹ç›®IDï¼Œè¯·å…ˆé€‰æ‹©é¡¹ç›®', true);
                    return;
                }
                
                // è·å–ç”¨æˆ·IDï¼ˆä»localStorageè·å–å½“å‰ç™»å½•ç”¨æˆ·ï¼‰
                const currentUserStr = localStorage.getItem('currentUser');
                let userId = null;
                if (currentUserStr) {
                    try {
                        const currentUser = JSON.parse(currentUserStr);
                        userId = currentUser.user_id;
                    } catch (e) {
                        console.error('è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥:', e);
                    }
                }
                if (!userId) {
                    showNotification('æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œè¯·é‡æ–°ç™»å½•', true);
                    return;
                }
                
                // è·å–è®°å½•æ—¥æœŸ
                const logDateInput = document.getElementById('logDate');
                const recordDate = logDateInput ? logDateInput.value.match(/(\d{4})å¹´(\d{2})æœˆ(\d{2})æ—¥/) : null;
                const formattedDate = recordDate ? `${recordDate[1]}-${recordDate[2]}-${recordDate[3]}` : new Date().toISOString().split('T')[0];
                
                // è·å–å¤©æ°”ä¿¡æ¯
                const weatherInfo = getCurrentWeatherInfo();
                
                // å‡†å¤‡ä¿å­˜æ•°æ®
                const logData = {
                    project_id: projectId,
                    user_id: userId,
                    record_date: formattedDate,
                    weather_info: weatherInfo,
                    log_content: content,
                    images: window.selectedImages || []
                };

                // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œæ·»åŠ æ—¥å¿—IDå’ŒåŸå§‹äº‘ç«¯å›¾ç‰‡URL
                let oldImages = [];
                if (currentEditingLogId) {
                    logData.log_id = currentEditingLogId;
                    // æ·»åŠ åŸå§‹äº‘ç«¯å›¾ç‰‡URLï¼Œç”¨äºåˆ é™¤è¢«ç§»é™¤çš„äº‘ç«¯å›¾ç‰‡
                    // æ³¨æ„ï¼šè¿™é‡Œä¸å†ä¼ é€’ original_cloud_image_urls ç»™ logDataï¼Œè€Œæ˜¯ä½œä¸ºå•ç‹¬å‚æ•°ä¼ é€’ oldImages
                    
                    if (originalCloudImageUrls && originalCloudImageUrls.length > 0) {
                        // å¤åˆ¶ä¸€ä»½åŸå§‹å›¾ç‰‡åˆ—è¡¨
                        oldImages = [...originalCloudImageUrls];
                        
                        // æ‰¾å‡ºå½“å‰ä»å­˜åœ¨çš„åŸå§‹å›¾ç‰‡URL
                        const keepUrls = new Set();
                        if (window.selectedImages && window.selectedImages.length > 0) {
                            window.selectedImages.forEach(img => {
                                // æ£€æŸ¥æ˜¯å¦æœ‰ originalUrl å±æ€§ï¼ˆè¿™æ˜¯åœ¨ä»è¯¦æƒ…é¡µåŠ è½½å›¾ç‰‡æ—¶æ·»åŠ çš„ï¼‰
                                if (img.originalUrl) {
                                    keepUrls.add(img.originalUrl);
                                }
                            });
                        }
                        
                        // è¿‡æ»¤ oldImagesï¼Œåªä¿ç•™çœŸæ­£è¢«ç”¨æˆ·åˆ é™¤çš„å›¾ç‰‡
                        oldImages = oldImages.filter(url => !keepUrls.has(url));
                    }
                }
                
                try {
                    showNotification(currentEditingLogId ? 'æ›´æ–°ä¸­...' : 'ä¿å­˜ä¸­...', false);
                    
                    let result;
                    if (currentEditingLogId) {
                        // ç¼–è¾‘æ¨¡å¼ï¼šè°ƒç”¨æ›´æ–°APIï¼Œä¼ å…¥logId, logData å’Œ oldImages
                        result = await window.constructionLogAPI.updateConstructionLog(currentEditingLogId, logData, oldImages);
                    } else {
                        // æ–°å¢æ¨¡å¼ï¼šè°ƒç”¨ä¿å­˜API
                        result = await window.constructionLogAPI.saveConstructionLog(logData);
                    }
                    
                    if (result.success) {
                        if (result.data && result.data.is_local) {
                            showNotification(currentEditingLogId ? 'å·²æ›´æ–°åˆ°æœ¬åœ°å­˜å‚¨ï¼Œå°†åœ¨ç½‘ç»œæ¢å¤ååŒæ­¥' : 'å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼Œå°†åœ¨ç½‘ç»œæ¢å¤ååŒæ­¥', false);
                        } else {
                            showNotification(currentEditingLogId ? 'æ›´æ–°æˆåŠŸ' : 'ä¿å­˜æˆåŠŸ', false);
                        }
                        
                        // é‡ç½®è¡¨å•ï¼ˆåŒ…æ‹¬æ¸…ç©ºå†…å®¹ã€å›¾ç‰‡ã€å¤©æ°”ã€é‡ç½®æ—¥æœŸï¼‰
                        resetWriteLogForm();
                        
                        // è¿”å›åˆ—è¡¨
                        backToList();
                        // åˆ·æ–°æ—¥å¿—åˆ—è¡¨
                        await loadConstructionLogs();
                    } else {
                        showNotification((currentEditingLogId ? 'æ›´æ–°' : 'ä¿å­˜') + 'å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), true);
                    }
                } catch (error) {
                    console.error(currentEditingLogId ? 'æ›´æ–°æ—¥å¿—å¤±è´¥:' : 'ä¿å­˜æ—¥å¿—å¤±è´¥:', error);
                    showNotification((currentEditingLogId ? 'æ›´æ–°' : 'ä¿å­˜') + 'å¤±è´¥ï¼Œè¯·é‡è¯•', true);
                }
            });
            
            // è·å–å½“å‰å¤©æ°”ä¿¡æ¯çš„è¾…åŠ©å‡½æ•°
            function getCurrentWeatherInfo() {
                const amCard = document.querySelector('.weather-card.am');
                const pmCard = document.querySelector('.weather-card.pm');
                
                const weatherInfo = { am: null, pm: null };
                
                // è¾…åŠ©è§£æå‡½æ•°
                const parseCard = (card) => {
                    if (!card) return null;
                    const infoDiv = card.querySelector('.weather-info');
                    if (!infoDiv) return null;
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æœªè®¾ç½®çŠ¶æ€ï¼ˆåŒ…å« weather-empty-text ç±»æˆ–æ–‡æœ¬å†…å®¹åŒ…å«â€œæœªè®¾ç½®â€ï¼‰
                    if (infoDiv.querySelector('.weather-empty-text') || infoDiv.textContent.includes('æœªè®¾ç½®')) {
                        return null; 
                    }
                    
                    // å°è¯•è§£ææ ‡å‡†æ ¼å¼ï¼š
                    // <div>å¤©æ°”ï¼š[SVG] æ™´å¤©</div>
                    // <div>æ¸©åº¦ï¼š19â„ƒ</div>
                    try {
                        const weatherDiv = infoDiv.children[0];
                        const tempDiv = infoDiv.children[1];
                        
                        if (!weatherDiv || !tempDiv) return null;
                        
                        // æå–å¤©æ°”åç§°ï¼ˆå‡è®¾æ ¼å¼ä¸º "å¤©æ°”ï¼š[å›¾æ ‡] åç§°" æˆ– "å¤©æ°”ï¼šåç§°"ï¼‰
                        // ä½¿ç”¨ textContent æå–çº¯æ–‡æœ¬ï¼Œç„¶ååˆ†å‰²
                        const weatherFullText = weatherDiv.textContent || '';
                        const weatherText = weatherFullText.split('ï¼š')[1]?.trim();
                        
                        // æå–æ¸©åº¦
                        const tempFullText = tempDiv.textContent || '';
                        const tempText = tempFullText.match(/(\d+)/)?.[0];
                        
                        if (weatherText && tempText) {
                            return {
                                weather: weatherText,
                                temp: tempText
                            };
                        }
                    } catch (e) {
                        console.warn('è§£æå¤©æ°”å¡ç‰‡å¤±è´¥:', e);
                    }
                    return null;
                };

                weatherInfo.am = parseCard(amCard);
                weatherInfo.pm = parseCard(pmCard);
                
                return weatherInfo;
            }
            
            // æ˜¾ç¤ºé€šçŸ¥çš„è¾…åŠ©å‡½æ•°
            function showNotification(message, isError = false) {
                // ç§»é™¤æ‰€æœ‰å·²å­˜åœ¨çš„é€šçŸ¥
                const existingNotifications = document.querySelectorAll('div[style*="position: fixed"][style*="top: 50%"][style*="left: 50%"]');
                existingNotifications.forEach(notification => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                });

                // åˆ›å»ºé€šçŸ¥å®¹å™¨
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    padding: 15px 20px;
                    border-radius: 8px;
                    color: white;
                    font-size: 14px;
                    font-weight: 500;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                    z-index: 9999;
                    max-width: 300px;
                    word-wrap: break-word;
                    animation: fadeIn 0.3s ease-out;
                    background-color: ${isError ? '#ff4d4f' : '#52c41a'};
                `;

                notification.textContent = message;

                // æ·»åŠ åŠ¨ç”»æ ·å¼
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes fadeIn {
                        from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
                        to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                    }
                `;
                document.head.appendChild(style);

                // æ·»åŠ åˆ°é¡µé¢
                document.body.appendChild(notification);

                // 3ç§’åè‡ªåŠ¨ç§»é™¤
                setTimeout(() => {
                    notification.style.animation = 'fadeIn 0.3s ease-in reverse';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }

            function openConstructionLogExportChoiceModal(context) {
                pendingExportContext = context;
                if (exportChoiceModal) {
                    exportChoiceModal.style.display = 'flex';
                }
            }

            function closeConstructionLogExportChoiceModal() {
                if (exportChoiceModal) {
                    exportChoiceModal.style.display = 'none';
                }
                pendingExportContext = null;
            }

            async function handleConstructionLogExportChoice(format) {
                if (!pendingExportContext) {
                    showNotification('æœªæ‰¾åˆ°å¯¼å‡ºå†…å®¹', true);
                    closeConstructionLogExportChoiceModal();
                    return;
                }

                const ctx = pendingExportContext;
                closeConstructionLogExportChoiceModal();

                try {
                    if (format === 'pdf') {
                        if (ctx.mode === 'single') {
                            if (window.exportConstructionLog) {
                                await window.exportConstructionLog(ctx.log);
                            } else {
                                showNotification('å¯¼å‡ºåŠŸèƒ½æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', true);
                            }
                        } else if (ctx.mode === 'range') {
                            if (window.exportConstructionLogs) {
                                await window.exportConstructionLogs(ctx.startDate, ctx.endDate);
                            } else {
                                showNotification('å¯¼å‡ºåŠŸèƒ½æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', true);
                            }
                        }
                        return;
                    }

                    if (format === 'word') {
                        if (ctx.mode === 'single') {
                            if (window.exportConstructionLogWord) {
                                await window.exportConstructionLogWord(ctx.log);
                            } else {
                                showNotification('å¯¼å‡ºåŠŸèƒ½æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', true);
                            }
                        } else if (ctx.mode === 'range') {
                            if (window.exportConstructionLogsWord) {
                                await window.exportConstructionLogsWord(ctx.startDate, ctx.endDate);
                            } else {
                                showNotification('å¯¼å‡ºåŠŸèƒ½æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', true);
                            }
                        }
                    }
                } catch (e) {
                    showNotification('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•', true);
                }
            }

            if (exportCancelBtn) {
                exportCancelBtn.addEventListener('click', closeConstructionLogExportChoiceModal);
            }
            if (exportChoiceModal) {
                exportChoiceModal.addEventListener('click', function(e) {
                    if (e.target === exportChoiceModal) {
                        closeConstructionLogExportChoiceModal();
                    }
                });
            }
            if (exportPdfOption) {
                exportPdfOption.addEventListener('click', () => handleConstructionLogExportChoice('pdf'));
            }
            if (exportWordOption) {
                exportWordOption.addEventListener('click', () => handleConstructionLogExportChoice('word'));
            }
            
            // è¯¦æƒ…é¡µå–æ¶ˆæŒ‰é’®ä¹Ÿè¿”å›åˆ—è¡¨
            if (detailCancelBtn) {
                detailCancelBtn.addEventListener('click', backToList);
            }

            if (detailPrintBtn) {
                detailPrintBtn.addEventListener('click', function() {
                    if (!currentViewingLog) {
                        showNotification('æœªæ‰¾åˆ°å½“å‰æ—¥å¿—', true);
                        return;
                    }
                    openConstructionLogExportChoiceModal({ mode: 'single', log: currentViewingLog });
                });
            }

            // è¯¦æƒ…é¡µåˆ é™¤æŒ‰é’®é€»è¾‘
            if (detailDeleteBtn) {
                // ç‚¹å‡»åˆ é™¤æŒ‰é’®ï¼Œæ˜¾ç¤ºæ¨¡æ€æ¡†
                detailDeleteBtn.addEventListener('click', function() {
                    if (!currentEditingLogId) {
                        showNotification('æœªæ‰¾åˆ°è¦åˆ é™¤çš„æ—¥å¿—', true);
                        return;
                    }

                    // æ˜¾ç¤ºæ¨¡æ€æ¡†
                    confirmModal.style.display = 'flex';
                });

                // æ¨¡æ€æ¡†ç¡®å®šæŒ‰é’®é€»è¾‘
                if (confirmModalOk) {
                    confirmModalOk.addEventListener('click', async function() {
                        // å…³é—­æ¨¡æ€æ¡†
                        closeConfirmModal();

                        try {
                            showNotification('æ­£åœ¨åˆ é™¤...', false);
                            
                            const result = await window.constructionLogAPI.deleteConstructionLog(currentEditingLogId, currentLogImageIds);
                            
                            if (result.success) {
                                showNotification('åˆ é™¤æˆåŠŸ', false);
                                // é‡ç½®ç¼–è¾‘ID
                                currentEditingLogId = null;
                                currentLogImageIds = [];
                                originalCloudImageUrls = []; // é‡ç½®åŸå§‹äº‘ç«¯å›¾ç‰‡URL
                                // è¿”å›åˆ—è¡¨
                                backToList();
                                // åˆ·æ–°æ—¥å¿—åˆ—è¡¨
                                await loadConstructionLogs();
                            } else {
                                showNotification('åˆ é™¤å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), true);
                            }
                        } catch (error) {
                            console.error('åˆ é™¤æ—¥å¿—å¤±è´¥:', error);
                            showNotification('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', true);
                        }
                    });
                }
            }

            // è¯¦æƒ…é¡µä¿®æ”¹æŒ‰é’®é€»è¾‘
            detailModifyBtn.addEventListener('click', function() {
                logDetailContainer.style.display = 'none';
                writeLogContainer.style.display = 'block';
                document.title = 'ç¼–è¾‘æ–½å·¥æ—¥å¿—';
                // é€šçŸ¥çˆ¶é¡µé¢ï¼ˆé¦–é¡µï¼‰æ›´æ–°æ ‡é¢˜
                window.parent.postMessage({ type: 'updateTitle', title: 'ç¼–è¾‘æ–½å·¥æ—¥å¿—' }, '*');
                
                // è·å–å½“å‰æ­£åœ¨ç¼–è¾‘çš„æ—¥å¿—ID
                const activeLogCard = document.querySelector('.log-card.active');
                if (activeLogCard) {
                    currentEditingLogId = activeLogCard.dataset.logId;
                }
                
                // 1. å¡«å……æ—¥æœŸ
                try {
                    const detailDateText = document.querySelector('#logDetailContainer .log-date').textContent.trim();
                    const logDateInput = document.getElementById('logDate');
                    if (logDateInput) {
                        // æå–æ—¥æœŸéƒ¨åˆ†ï¼Œå¯èƒ½æ ¼å¼ä¸º "2026/02/04" æˆ– "2026-02-04"
                        const rawDate = detailDateText.split(' ')[0];

                        // æ”¯æŒæ¨ªæ å’Œæ–œæ ä¸¤ç§åˆ†éš”ç¬¦
                        let parts;
                        if (rawDate.includes('/')) {
                            parts = rawDate.split('/');
                        } else if (rawDate.includes('-')) {
                            parts = rawDate.split('-');
                        } else {
                            parts = rawDate.split(/[/-]/); // ä½¿ç”¨æ­£åˆ™åŒæ—¶åŒ¹é…æ¨ªæ å’Œæ–œæ 
                        }

                        if (parts.length === 3) {
                            let dateValue = `${parts[0]}å¹´${parts[1]}æœˆ${parts[2]}æ—¥`;

                            // æ£€æŸ¥æ˜¯å¦æ˜¯ä»Šå¤©ï¼Œå¦‚æœæ˜¯åˆ™æ·»åŠ "ï¼ˆä»Šå¤©ï¼‰"
                            const now = new Date();
                            const currentYear = now.getFullYear();
                            const currentMonth = String(now.getMonth() + 1).padStart(2, '0');
                            const currentDay = String(now.getDate()).padStart(2, '0');

                            // ä½¿ç”¨ç›¸åŒçš„åˆ†éš”ç¬¦è¿›è¡Œæ¯”è¾ƒ
                            const currentDateStr = `${currentYear}/${currentMonth}/${currentDay}`;

                            if (rawDate === currentDateStr) {
                                dateValue += 'ï¼ˆä»Šå¤©ï¼‰';
                            }

                            logDateInput.value = dateValue;
                        } else {
                            logDateInput.value = rawDate;
                        }
                    }
                } catch (e) {
                    console.error('å¡«å……æ—¥æœŸå¤±è´¥', e);
                }

                // 2. å¡«å……å¤©æ°”å’Œæ¸©åº¦
                try {
                    // è¾…åŠ©å‡½æ•°ï¼šä»è¯¦æƒ…é¡µå¡ç‰‡æå–æ•°æ®å¹¶å¡«å……åˆ°ç¼–è¾‘é¡µå¡ç‰‡
                    function syncWeatherCard(type) {
                        const detailCard = document.querySelector(`#logDetailContainer .weather-card.${type}`);
                        const writeCard = document.querySelector(`#writeLogContainer .weather-card.${type}`);
                        
                        if (detailCard && writeCard) {
                            const detailInfoDiv = detailCard.querySelector('.weather-info');
                            const writeInfoDiv = writeCard.querySelector('.weather-info');
                            
                            // ç›´æ¥å¤åˆ¶ HTML å†…å®¹ä»¥ä¿æŒå›¾æ ‡å’Œæ–‡æœ¬ä¸€è‡´
                            writeInfoDiv.innerHTML = detailInfoDiv.innerHTML;
                        }
                    }

                    syncWeatherCard('am');
                    syncWeatherCard('pm');
                } catch (e) {
                    console.error('å¡«å……å¤©æ°”å¤±è´¥', e);
                }

                // 3. å¡«å……æ—¥å¿—å†…å®¹
                try {
                    const detailContent = document.querySelector('#logDetailContainer div[style*="font-size: 14px"]').innerHTML.trim();
                    // ä½¿ç”¨å¯Œæ–‡æœ¬ç¼–è¾‘å™¨è®¾ç½®å†…å®¹
                    if (editor) {
                        editor.setContent(detailContent);
                    }
                } catch (e) {
                    console.error('å¡«å……æ—¥å¿—å†…å®¹å¤±è´¥', e);
                }

                // 4. å¡«å……å›¾ç‰‡
                try {
                    // æ¸…ç©ºç°æœ‰çš„å›¾ç‰‡é¢„è§ˆï¼ˆé™¤äº†æ·»åŠ æŒ‰é’®ï¼‰
                    const previews = imageUploadContainer.querySelectorAll('.image-preview-item');
                    previews.forEach(p => p.remove());
                    window.selectedImages = []; // é‡ç½®å·²é€‰å›¾ç‰‡æ•°ç»„
                    originalCloudImageUrls = []; // é‡ç½®åŸå§‹äº‘ç«¯å›¾ç‰‡URLæ•°ç»„

                    // è·å–è¯¦æƒ…é¡µçš„æ‰€æœ‰å›¾ç‰‡
                    const detailImages = document.querySelectorAll('#logDetailContainer .detail-image');

                    // å°†è¯¦æƒ…é¡µå›¾ç‰‡è½¬æ¢ä¸ºæ–‡ä»¶å¯¹è±¡å¹¶æ·»åŠ åˆ°é¢„è§ˆåŒºåŸŸ
                    detailImages.forEach(async (img, index) => {
                        try {
                            // è®°å½•åŸå§‹äº‘ç«¯å›¾ç‰‡URL
                            originalCloudImageUrls.push(img.src);

                            const response = await fetch(img.src);
                            const blob = await response.blob();

                            // ä»URLä¸­æå–åŸå§‹æ–‡ä»¶å
                            const url = new URL(img.src);
                            const pathname = decodeURIComponent(url.pathname);
                            const originalFileName = pathname.substring(pathname.lastIndexOf('/') + 1) || `image_${index}.png`;

                            const file = new File([blob], originalFileName, { type: blob.type });

                            // ä¸ºäº‘ç«¯ä¸‹è½½çš„å›¾ç‰‡æ·»åŠ åŸå§‹URLå±æ€§ï¼Œç”¨äºåŒºåˆ†äº‘ç«¯å›¾ç‰‡å’Œæ–°å›¾ç‰‡
                            file.originalUrl = img.src;

                            window.selectedImages.push(file);
                            renderImagePreview(file, window.selectedImages.length - 1);
                        } catch (e) {
                            console.error('å•ä¸ªå›¾ç‰‡åŠ è½½å¤±è´¥', e);
                        }
                    });
                } catch (e) {
                    console.error('å¡«å……å›¾ç‰‡åˆ—è¡¨å¤±è´¥', e);
                }
            });

            // ç‚¹å‡»æ—¥å¿—å¡ç‰‡è¿›å…¥è¯¦æƒ…é¡µ
            document.querySelector('.log-list').addEventListener('click', function(e) {
                const card = e.target.closest('.log-card');
                if (card) {
                    listPageContainer.style.display = 'none';
                    writeLogContainer.style.display = 'none';
                    logDetailContainer.style.display = 'block';
                    
                    // è¿™é‡Œå¯ä»¥è·å–å¡ç‰‡æ•°æ®å¹¶å¡«å……åˆ°è¯¦æƒ…é¡µ
                    // ç›®å‰æ¼”ç¤ºé™æ€åˆ‡æ¢ï¼Œåç»­å¯å¢åŠ æ•°æ®ç»‘å®š
                }
            });

            // æ‰“å¼€ä¾§è¾¹æ é€šç”¨å‡½æ•°
            function openSidebar(title, confirmText, mode = 'date') {
                // éšè—æ‰€æœ‰å†…å®¹åŒºåŸŸ
                document.querySelectorAll('.sidebar-content-section').forEach(el => el.classList.remove('active'));
                
                // è®¾ç½®æ ‡é¢˜å’ŒæŒ‰é’®æ–‡å­—
                sidebarHeader.textContent = title;
                confirmBtn.textContent = confirmText;

                // æ ¹æ®æ¨¡å¼æ˜¾ç¤ºå¯¹åº”å†…å®¹
                if (mode === 'date') {
                    document.getElementById('dateRangeContent').classList.add('active');
                    // ä»localStorageè¯»å–ä¸Šæ¬¡é€‰æ‹©çš„æ—¥æœŸ
                    const savedStartDate = localStorage.getItem('filterStartDate');
                    const savedEndDate = localStorage.getItem('filterEndDate');
                    if (savedStartDate) {
                        document.getElementById('startDate').value = savedStartDate;
                    }
                    if (savedEndDate) {
                        document.getElementById('endDate').value = savedEndDate;
                    }
                } else if (mode === 'weather') {
                    document.getElementById('weatherSettingsContent').classList.add('active');
                }

                overlay.classList.add('active');
                sidebar.classList.add('active');
            }

            // æ‰“å¼€ç­›é€‰ä¾§è¾¹æ 
            filterBtn.addEventListener('click', function() {
                openSidebar('é€‰æ‹©æ—¶é—´èŒƒå›´', 'ç¡®å®š', 'date');
            });

            // æ‰“å¼€æ‰¹é‡å¯¼å‡ºä¾§è¾¹æ 
            exportBtn.addEventListener('click', function() {
                openSidebar('é€‰æ‹©å¯¼å‡ºæ—¶é—´', 'å¯¼å‡ºæ–½å·¥æ—¥å¿—', 'date');
            });
            
            // --- å¤©æ°”è®¾ç½®é€»è¾‘ ---
            const weatherOptions = [
                { 
                    name: 'æ™´å¤©', 
                    icon: '<svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="14" fill="#FFD700" stroke="#FFA500" stroke-width="2"/><g stroke="#FFD700" stroke-width="3" stroke-linecap="round"><line x1="32" y1="10" x2="32" y2="4"/><line x1="32" y1="54" x2="32" y2="60"/><line x1="54" y1="32" x2="60" y2="32"/><line x1="4" y1="32" x2="10" y2="32"/><line x1="48" y1="16" x2="52" y2="12"/><line x1="16" y1="48" x2="12" y2="52"/><line x1="48" y1="48" x2="52" y2="52"/><line x1="16" y1="16" x2="12" y2="12"/></g></svg>' 
                },
                { 
                    name: 'å¤šäº‘', 
                    icon: '<svg viewBox="0 0 64 64" width="32" height="32"><circle cx="24" cy="24" r="12" fill="#FFD700"/><path d="M46,28a10,10,0,0,1,10,10c0,5.5-4.5,10-10,10H26c-5.5,0-10-4.5-10-10a10,10,0,0,1,8-9.8,12,12,0,0,1,22-8.2Z" fill="#F0F8FF" stroke="#B0C4DE" stroke-width="2"/></svg>' 
                },
                { 
                    name: 'é˜´', 
                    icon: '<svg viewBox="0 0 64 64" width="32" height="32"><path d="M46,26a12,12,0,0,1,12,12c0,6.6-5.4,12-12,12H22c-6.6,0-12-5.4-12-12a12,12,0,0,1,9.6-11.8,14,14,0,0,1,26.4-9.8Z" fill="#D3D3D3" stroke="#A9A9A9" stroke-width="2"/></svg>' 
                },
                { 
                    name: 'é›·é›¨å¤©', 
                    icon: '<svg viewBox="0 0 64 64" width="32" height="32"><path d="M46,24a12,12,0,0,1,12,12c0,6.6-5.4,12-12,12H22c-6.6,0-12-5.4-12-12a12,12,0,0,1,9.6-11.8,14,14,0,0,1,26.4-9.8Z" fill="#708090" stroke="#696969" stroke-width="2"/><polygon points="34,48 26,62 36,58 32,68 44,52 34,54" fill="#FFD700" stroke="#DAA520" stroke-width="1"/><circle cx="24" cy="56" r="1.5" fill="#4682B4"/><circle cx="48" cy="56" r="1.5" fill="#4682B4"/></svg>' 
                },
                { 
                    name: 'é›¨', 
                    icon: '<svg viewBox="0 0 64 64" width="32" height="32"><path d="M46,24a12,12,0,0,1,12,12c0,6.6-5.4,12-12,12H22c-6.6,0-12-5.4-12-12a12,12,0,0,1,9.6-11.8,14,14,0,0,1,26.4-9.8Z" fill="#D3D3D3" stroke="#A9A9A9" stroke-width="2"/><g fill="#4682B4"><path d="M26,52l-2,8" stroke="#4682B4" stroke-width="2" stroke-linecap="round"/><path d="M34,54l-2,8" stroke="#4682B4" stroke-width="2" stroke-linecap="round"/><path d="M42,52l-2,8" stroke="#4682B4" stroke-width="2" stroke-linecap="round"/></g></svg>' 
                },
                { 
                    name: 'é£', 
                    icon: '<svg viewBox="0 0 64 64" width="32" height="32"><path d="M12,24h30a6,6,0,0,1,0,12h-4" fill="none" stroke="#87CEEB" stroke-width="3" stroke-linecap="round"/><path d="M8,36h24a6,6,0,0,0,0-12h-4" fill="none" stroke="#B0C4DE" stroke-width="3" stroke-linecap="round"/><path d="M16,48h20a6,6,0,0,1,0,12" fill="none" stroke="#87CEEB" stroke-width="3" stroke-linecap="round"/></svg>' 
                },
                { 
                    name: 'é›¾', 
                    icon: '<svg viewBox="0 0 64 64" width="32" height="32"><line x1="12" y1="20" x2="52" y2="20" stroke="#D3D3D3" stroke-width="3" stroke-linecap="round"/><line x1="8" y1="32" x2="56" y2="32" stroke="#D3D3D3" stroke-width="3" stroke-linecap="round"/><line x1="16" y1="44" x2="48" y2="44" stroke="#D3D3D3" stroke-width="3" stroke-linecap="round"/></svg>' 
                },
                { 
                    name: 'éœ¾', 
                    icon: '<svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="20" fill="#FFE4B5" opacity="0.6"/><path d="M20,32h24" stroke="#808080" stroke-width="2" stroke-dasharray="4,4"/><path d="M24,24h16" stroke="#808080" stroke-width="2" stroke-dasharray="4,4"/><path d="M24,40h16" stroke="#808080" stroke-width="2" stroke-dasharray="4,4"/></svg>' 
                },
                { 
                    name: 'é›ª', 
                    icon: 'â„ï¸' 
                },
                { 
                    name: 'åœç”µ', 
                    icon: '<svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="24" fill="#333"/><polygon points="36,16 24,36 34,36 28,52 44,28 32,28" fill="#FFD700" stroke="#FFA500" stroke-width="1"/></svg>' 
                }
            ];

            let currentWeatherType = 'am'; // 'am' or 'pm'
            let selectedWeather = 'æ™´å¤©';

            // ç”Ÿæˆå¤©æ°”å›¾æ ‡ç½‘æ ¼
            const weatherGrid = document.getElementById('weatherGrid');
            weatherOptions.forEach(weather => {
                const item = document.createElement('div');
                item.className = 'weather-item';
                item.innerHTML = `
                    <div class="weather-icon">${weather.icon}</div>
                    <div class="weather-name">${weather.name}</div>
                `;
                item.addEventListener('click', function() {
                    // ç§»é™¤å…¶ä»–é€‰ä¸­çŠ¶æ€
                    document.querySelectorAll('.weather-item').forEach(el => el.classList.remove('selected'));
                    // æ·»åŠ é€‰ä¸­çŠ¶æ€
                    item.classList.add('selected');
                    selectedWeather = weather.name;
                });
                weatherGrid.appendChild(item);
            });

            // ç›‘å¬å¤©æ°”å¡ç‰‡ä¿®æ”¹æŒ‰é’®
            document.querySelectorAll('.weather-edit-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const card = this.closest('.weather-card');
                    currentWeatherType = card.classList.contains('am') ? 'am' : 'pm';
                    const titleText = currentWeatherType === 'am' ? 'è®¾ç½®ä¸Šåˆå¤©æ°”' : 'è®¾ç½®ä¸‹åˆå¤©æ°”';
                    const tempTitleText = currentWeatherType === 'am' ? 'è®¾ç½®ä¸Šåˆæ¸©åº¦' : 'è®¾ç½®ä¸‹åˆæ¸©åº¦';
                    
                    document.getElementById('tempTitle').textContent = tempTitleText;

                    // è·å–å½“å‰å¡ç‰‡çš„å¤©æ°”å’Œæ¸©åº¦æ•°æ®ï¼ˆè¿™é‡Œç®€åŒ–ä¸ºä»DOMè¯»å–ï¼Œå®é™…å¯èƒ½ä»æ•°æ®å¯¹è±¡è¯»å–ï¼‰
                    const infoDiv = card.querySelector('.weather-info');
                    
                    let weatherText = 'æ™´å¤©';
                    let tempText = '19';

                    // æ£€æŸ¥æ˜¯å¦å·²è®¾ç½®ï¼Œå¦‚æœä¸æ˜¯â€œæœªè®¾ç½®â€çŠ¶æ€ï¼Œåˆ™å°è¯•è§£æå½“å‰å€¼
                    if (!infoDiv.querySelector('.weather-empty-text') && !infoDiv.textContent.includes('æœªè®¾ç½®')) {
                        try {
                            // å‡è®¾æ ¼å¼ä¸º "å¤©æ°”ï¼š[å›¾æ ‡] åç§°" æˆ– "å¤©æ°”ï¼šåç§°" (å¦‚æœå›¾æ ‡æ˜¯SVGä¸”ä¸å æ–‡æœ¬)
                            if (infoDiv.children[0] && infoDiv.children[0].textContent) {
                                const fullText = infoDiv.children[0].textContent.split('ï¼š')[1].trim();
                                const parts = fullText.split(' ');
                                if (parts.length > 1 && parts[0] !== '') {
                                    weatherText = parts[1];
                                } else {
                                    weatherText = fullText;
                                }
                            }
                            
                            if (infoDiv.children[1] && infoDiv.children[1].textContent) {
                                tempText = infoDiv.children[1].textContent.split('ï¼š')[1].replace('â„ƒ', '').trim();
                            }
                        } catch (e) {
                            console.warn('è§£æå½“å‰å¤©æ°”å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼', e);
                        }
                    }

                    // è®¾ç½®é€‰ä¸­çŠ¶æ€
                    document.querySelectorAll('.weather-item').forEach(el => {
                        el.classList.remove('selected');
                        if (el.querySelector('.weather-name').textContent === weatherText) {
                            el.classList.add('selected');
                            selectedWeather = weatherText;
                        }
                    });
                    
                    // å¦‚æœæ²¡æœ‰åŒ¹é…çš„ï¼ˆé»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªï¼‰
                    if (!document.querySelector('.weather-item.selected')) {
                         document.querySelector('.weather-item').classList.add('selected');
                         selectedWeather = weatherOptions[0].name;
                    }

                    document.getElementById('weatherTemp').value = tempText;

                    openSidebar(titleText, 'ç¡®å®š', 'weather');
                });
            });

            // å…³é—­ä¾§è¾¹æ å‡½æ•°
            function closeSidebar() {
                overlay.classList.remove('active');
                sidebar.classList.remove('active');
            }

            // ç‚¹å‡»é®ç½©å±‚å…³é—­
            overlay.addEventListener('click', closeSidebar);

            // ç‚¹å‡»å–æ¶ˆæŒ‰é’®å…³é—­
            cancelBtn.addEventListener('click', closeSidebar);

            // ç‚¹å‡»ç¡®å®šæŒ‰é’®ï¼ˆæš‚æ—¶ä¹Ÿæ˜¯å…³é—­ï¼Œåç»­å¯æ·»åŠ ç­›é€‰é€»è¾‘ï¼‰
            confirmBtn.addEventListener('click', function() {
                // åˆ¤æ–­å½“å‰æ˜¯å“ªä¸ªæ¨¡å¼
                if (document.getElementById('weatherSettingsContent').classList.contains('active')) {
                    // å¤©æ°”è®¾ç½®ç¡®è®¤é€»è¾‘
                    const temp = document.getElementById('weatherTemp').value;
                    const cardSelector = currentWeatherType === 'am' ? '.weather-card.am' : '.weather-card.pm';
                    const card = document.querySelector(cardSelector);
                    
                    if (card) {
                        const weatherInfo = card.querySelector('.weather-info');
                        const selectedOption = weatherOptions.find(w => w.name === selectedWeather);
                        const icon = selectedOption ? selectedOption.icon : '';
                        
                        weatherInfo.innerHTML = `
                            <div>å¤©æ°”ï¼š${icon} ${selectedWeather}</div>
                            <div>æ¸©åº¦ï¼š${temp}â„ƒ</div>
                        `;
                    }
                } else {
                    // ç­›é€‰æˆ–å¯¼å‡ºç¡®è®¤é€»è¾‘
                    const startDateInput = document.getElementById('startDate').value;
                    const endDateInput = document.getElementById('endDate').value;
                    
                    // ä¿å­˜é€‰æ‹©çš„æ—¥æœŸåˆ°localStorage
                    if (startDateInput) {
                        localStorage.setItem('filterStartDate', startDateInput);
                    }
                    if (endDateInput) {
                        localStorage.setItem('filterEndDate', endDateInput);
                    }
                    
                    // è½¬æ¢æ—¥æœŸæ ¼å¼ä¸º YYYY-MM-DD
                    const startDateMatch = startDateInput.match(/(\d{4})å¹´(\d{2})æœˆ(\d{2})æ—¥/);
                    const endDateMatch = endDateInput.match(/(\d{4})å¹´(\d{2})æœˆ(\d{2})æ—¥/);
                    
                    const startDate = startDateMatch ? `${startDateMatch[1]}-${startDateMatch[2]}-${startDateMatch[3]}` : null;
                    const endDate = endDateMatch ? `${endDateMatch[1]}-${endDateMatch[2]}-${endDateMatch[3]}` : null;
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯å¯¼å‡ºæ“ä½œ
                    const sidebarTitle = document.querySelector('.sidebar-header').textContent;
                    if (sidebarTitle === 'é€‰æ‹©å¯¼å‡ºæ—¶é—´' || this.textContent.trim() === 'å¯¼å‡ºæ–½å·¥æ—¥å¿—') {
                        openConstructionLogExportChoiceModal({ mode: 'range', startDate, endDate });
                    } else {
                        // ç­›é€‰é€»è¾‘
                        filterConstructionLogs(startDate, endDate);
                    }
                }
                closeSidebar();
            });

            // æ³¨æ„ï¼šå­—ç¬¦è®¡æ•°ä¸éªŒè¯å·²ç”±å¯Œæ–‡æœ¬ç¼–è¾‘å™¨å¤„ç†
            // ä¿ç•™æ­¤æ³¨é‡Šä»¥è¯´æ˜åŸtextareaçš„äº‹ä»¶ç›‘å¬å·²è¢«RichTextEditoræ›¿ä»£

            // Date Picker Logic
            const datePicker = document.getElementById('datePicker');
            const pickerCurrentMonthEl = document.getElementById('pickerCurrentMonth');
            const daysGrid = document.getElementById('daysGrid');
            const pickerPrevYearBtn = document.getElementById('pickerPrevYear');
            const pickerPrevMonthBtn = document.getElementById('pickerPrevMonth');
            const pickerNextMonthBtn = document.getElementById('pickerNextMonth');
            const pickerNextYearBtn = document.getElementById('pickerNextYear');
            const pickerTodayBtn = document.getElementById('pickerTodayBtn');
            
            let pickerDate = new Date(); // Internal state for picker navigation
            let activeInputId = null; // 'startDate' or 'endDate'

            // æ£€æŸ¥æ—¥æœŸæ˜¯å¦åœ¨æœªæ¥
            function isFutureDate(date) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                // åˆ›å»ºä¸€ä¸ªå‰¯æœ¬ä»¥é¿å…ä¿®æ”¹åŸå§‹æ—¥æœŸ
                const checkDate = new Date(date);
                checkDate.setHours(0, 0, 0, 0);
                return checkDate > today;
            }

            // æ£€æŸ¥æœˆä»½æ˜¯å¦åœ¨æœªæ¥
            function isFutureMonth(year, month) {
                const today = new Date();
                const currentYear = today.getFullYear();
                const currentMonth = today.getMonth();
                
                if (year > currentYear) return true;
                if (year === currentYear && month > currentMonth) return true;
                return false;
            }

            function renderDatePicker(date) {
                const year = date.getFullYear();
                const month = date.getMonth();
                
                pickerCurrentMonthEl.textContent = `${year}å¹´ ${month + 1}æœˆ`;
                
                // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
                // æ£€æŸ¥ä¸‹ä¸€å¹´
                if (isFutureMonth(year + 1, month)) {
                    pickerNextYearBtn.style.color = '#ccc';
                    pickerNextYearBtn.style.pointerEvents = 'none';
                    pickerNextYearBtn.style.cursor = 'default';
                } else {
                    pickerNextYearBtn.style.color = '#999';
                    pickerNextYearBtn.style.pointerEvents = 'auto';
                    pickerNextYearBtn.style.cursor = 'pointer';
                }

                // æ£€æŸ¥ä¸‹ä¸ªæœˆ
                // ä¸‹ä¸ªæœˆçš„å¹´ä»½å’Œæœˆä»½
                let nextMonthYear = year;
                let nextMonthIndex = month + 1;
                if (nextMonthIndex > 11) {
                    nextMonthYear++;
                    nextMonthIndex = 0;
                }
                
                if (isFutureMonth(nextMonthYear, nextMonthIndex)) {
                    pickerNextMonthBtn.style.color = '#ccc';
                    pickerNextMonthBtn.style.pointerEvents = 'none';
                    pickerNextMonthBtn.style.cursor = 'default';
                } else {
                    pickerNextMonthBtn.style.color = '#999';
                    pickerNextMonthBtn.style.pointerEvents = 'auto';
                    pickerNextMonthBtn.style.cursor = 'pointer';
                }

                // Clear grid
                daysGrid.innerHTML = '';
                
                // First day of the month
                const firstDay = new Date(year, month, 1);
                // Day of week (0-6, Sun-Sat). We want Mon(1)-Sun(0)
                let startDay = firstDay.getDay(); 
                // Adjust for Mon start: Sun(0) -> 6, Mon(1) -> 0, Tue(2) -> 1...
                let startDayIndex = (startDay + 6) % 7;
                
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const daysInPrevMonth = new Date(year, month, 0).getDate();
                const todayDate = new Date();
                todayDate.setHours(0, 0, 0, 0); // Normalize today for comparison
                
                // Previous month days
                for (let i = startDayIndex - 1; i >= 0; i--) {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'day-cell prev-month';
                    dayDiv.textContent = daysInPrevMonth - i;
                    
                    const prevDate = new Date(year, month - 1, daysInPrevMonth - i);
                    if (prevDate > todayDate) {
                        dayDiv.classList.add('disabled');
                    } else {
                        dayDiv.addEventListener('click', (e) => {
                            e.stopPropagation();
                            selectDate(prevDate);
                        });
                    }
                    daysGrid.appendChild(dayDiv);
                }
                
                // Current month days
                const today = new Date();
                const currentInputVal = document.getElementById(activeInputId).value;
                // Parse current input value "YYYYå¹´MMæœˆDDæ—¥"
                let selectedDate = null;
                const match = currentInputVal.match(/(\d{4})å¹´(\d{2})æœˆ(\d{2})æ—¥/);
                if (match) {
                    selectedDate = new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));
                }

                for (let i = 1; i <= daysInMonth; i++) {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'day-cell current-month';
                    dayDiv.textContent = i;
                    const currentDate = new Date(year, month, i);
                    
                    // Check if disabled (future date)
                    if (currentDate > todayDate) {
                        dayDiv.classList.add('disabled');
                    } else {
                        // Check if selected
                        if (selectedDate && 
                            selectedDate.getFullYear() === year && 
                            selectedDate.getMonth() === month && 
                            selectedDate.getDate() === i) {
                            dayDiv.classList.add('selected');
                        }
                        
                        // Check if today
                        if (today.getFullYear() === year && 
                            today.getMonth() === month && 
                            today.getDate() === i) {
                            dayDiv.classList.add('today');
                        }
                        
                        dayDiv.addEventListener('click', (e) => {
                            e.stopPropagation();
                            selectDate(currentDate);
                        });
                    }
                    
                    daysGrid.appendChild(dayDiv);
                }
                
                // Next month days to fill grid (6 rows * 7 cols = 42 cells)
                const totalCells = 42;
                const currentCells = startDayIndex + daysInMonth;
                const remainingCells = totalCells - currentCells;
                
                for (let i = 1; i <= remainingCells; i++) {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'day-cell next-month';
                    dayDiv.textContent = i;
                    
                    const nextDate = new Date(year, month + 1, i);
                    if (nextDate > todayDate) {
                        dayDiv.classList.add('disabled');
                    } else {
                        dayDiv.addEventListener('click', (e) => {
                            e.stopPropagation();
                            selectDate(nextDate);
                        });
                    }
                    daysGrid.appendChild(dayDiv);
                }
            }

            function selectDate(date) {
                if (activeInputId) {
                    const input = document.getElementById(activeInputId);
                    const year = date.getFullYear();
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const day = date.getDate().toString().padStart(2, '0');
                    let dateStr = `${year}å¹´${month}æœˆ${day}æ—¥`;

                    // å¦‚æœæ˜¯å†™æ—¥å¿—ç•Œé¢çš„æ—¥æœŸæ¡†ï¼Œä¸”é€‰æ‹©äº†ä»Šå¤©ï¼Œæ·»åŠ  (ä»Šå¤©) æ ‡è¯†
                    if (activeInputId === 'logDate') {
                        const today = new Date();
                        if (date.getFullYear() === today.getFullYear() && 
                            date.getMonth() === today.getMonth() && 
                            date.getDate() === today.getDate()) {
                            dateStr += ' (ä»Šå¤©)';
                        }
                    }

                    input.value = dateStr;
                }
                datePicker.style.display = 'none';
            }

            function showDatePicker(inputId) {
                activeInputId = inputId;
                const input = document.getElementById(inputId);
                const rect = input.getBoundingClientRect();
                
                // Parse initial date from input
                const val = input.value;
                const match = val.match(/(\d{4})å¹´(\d{2})æœˆ(\d{2})æ—¥/);
                if (match) {
                    pickerDate = new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));
                } else {
                    pickerDate = new Date();
                }
                
                renderDatePicker(pickerDate);
                
                datePicker.style.display = 'block';
                datePicker.style.top = (rect.bottom + 5) + 'px';
                // Align right of picker with right of input wrapper
                // Since sidebar width is fixed (320px) and form-input-wrapper is flex:1 inside sidebar
                // We can calculate left based on rect.right
                datePicker.style.left = (rect.right - 250) + 'px'; // 250 is picker width
            }

            // Event Listeners for Date Picker
            document.getElementById('startDate').addEventListener('click', (e) => {
                e.stopPropagation();
                showDatePicker('startDate');
            });
            
            document.getElementById('endDate').addEventListener('click', (e) => {
                e.stopPropagation();
                showDatePicker('endDate');
            });

            // æ–°å¢ logDate çš„ç›‘å¬
            document.getElementById('logDate').addEventListener('click', (e) => {
                e.stopPropagation();
                showDatePicker('logDate');
            });
            
            pickerPrevYearBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                pickerDate.setFullYear(pickerDate.getFullYear() - 1);
                renderDatePicker(pickerDate);
            });
            
            pickerNextYearBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                pickerDate.setFullYear(pickerDate.getFullYear() + 1);
                renderDatePicker(pickerDate);
            });
            
            pickerPrevMonthBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                pickerDate.setMonth(pickerDate.getMonth() - 1);
                renderDatePicker(pickerDate);
            });
            
            pickerNextMonthBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                pickerDate.setMonth(pickerDate.getMonth() + 1);
                renderDatePicker(pickerDate);
            });
            
            pickerTodayBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const today = new Date();
                selectDate(today);
            });
            
            // Close picker when clicking outside
            window.addEventListener('click', (e) => {
                if (!datePicker.contains(e.target) && 
                    e.target.id !== 'startDate' && 
                    e.target.id !== 'endDate' &&
                    e.target.id !== 'logDate') { // å¢åŠ æ’é™¤ logDate
                    datePicker.style.display = 'none';
                }
            });
            
            // Prevent sidebar closing when clicking picker
            datePicker.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            // åˆå§‹åŒ–å¯Œæ–‡æœ¬ç¼–è¾‘å™¨
            const editor = new RichTextEditor({
                container: '.write-form-content',
                textarea: '.log-textarea',
                placeholder: 'è¯·è¾“å…¥æ—¥å¿—å†…å®¹ï¼Œç‚¹å‡»æ­¤å¤„æ˜¾ç¤ºç¼–è¾‘å·¥å…·...',
                maxLength: 2000,
                onChange: function(content) {
                    const length = content.length;
                    document.querySelector('.char-count').textContent = `${length} / 2000`;
                    
                    // éªŒè¯
                    const errorMsg = document.querySelector('.error-message');
                    const editableDiv = document.querySelector('.rich-editor-editable');
                    
                    if (length === 0) {
                        if (editableDiv) editableDiv.classList.add('error');
                        if (errorMsg) errorMsg.style.visibility = 'visible';
                    } else {
                        if (editableDiv) editableDiv.classList.remove('error');
                        if (errorMsg) errorMsg.style.visibility = 'hidden';
                    }
                }
            });
            
            // å¤„ç†URLå‚æ•°ä¸­çš„é¡¹ç›®ä¿¡æ¯
            const urlParams = new URLSearchParams(window.location.search);
            const projectNameParam = urlParams.get('project_name');
            const projectIdParam = urlParams.get('project_id');
            
            // é€šçŸ¥çˆ¶é¡µé¢æ›´æ–°æ ‡é¢˜
            if (window.parent && window.parent !== window) {
                // ä½¿ç”¨å½“å‰é¡µé¢çš„originä½œä¸ºtargetOriginï¼Œæé«˜å®‰å…¨æ€§
                const targetOrigin = window.location.origin || '*';
                window.parent.postMessage({
                    type: 'updateTitle',
                    page: 'æ–½å·¥æ—¥å¿—.html'
                }, targetOrigin);
            }

            if (projectNameParam) {
                const decodedName = decodeURIComponent(projectNameParam);
                // æ›´æ–°é¡¹ç›®åç§°è¾“å…¥æ¡†
                const projectNameInput = document.getElementById('projectName');
                if (projectNameInput) {
                    projectNameInput.value = decodedName;
                }
                // ä¿å­˜åˆ°localStorage
                localStorage.setItem('currentProjectName', decodedName);
            } else {
                 // å¦‚æœURLæ²¡æœ‰ï¼Œå°è¯•ä»localStorageè·å–å¹¶æ›´æ–°UI
                 const storedProjectName = localStorage.getItem('currentProjectName');
                 if (storedProjectName) {
                     const projectNameInput = document.getElementById('projectName');
                     if (projectNameInput) {
                         projectNameInput.value = storedProjectName;
                     }
                 }
            }
            
            if (projectIdParam) {
                const decodedId = decodeURIComponent(projectIdParam);
                localStorage.setItem('currentProjectId', decodedId);
            }

            // åŠ è½½æ–½å·¥æ—¥å¿—åˆ—è¡¨
            async function loadConstructionLogs() {
                const projectId = localStorage.getItem('currentProjectId');
                if (!projectId) {
                    console.log('æœªæ‰¾åˆ°é¡¹ç›®IDï¼Œæ— æ³•åŠ è½½æ—¥å¿—åˆ—è¡¨');
                    return;
                }

                if (!window.constructionLogAPI) {
                    console.log('APIæœªåˆå§‹åŒ–ï¼Œç­‰å¾…åˆå§‹åŒ–å®Œæˆ...');
                    return;
                }

                try {
                    // æ£€æŸ¥URLå‚æ•°ä¸­æ˜¯å¦åŒ…å«æ—¥æœŸä¿¡æ¯
                    const urlParams = new URLSearchParams(window.location.search);
                    const dateParam = urlParams.get('work_date'); // ä½¿ç”¨work_dateå‚æ•°ï¼Œä¸äº‘ç›¸å†Œé¡µé¢ä¿æŒä¸€è‡´
                    
                    let filters = {};
                    if (dateParam) {
                        // å¦‚æœæœ‰æ—¥æœŸå‚æ•°ï¼Œåˆ™åªè·å–è¯¥æ—¥æœŸçš„æ—¥å¿—è®°å½•
                        filters.startDate = dateParam;
                        filters.endDate = dateParam;
                    }
                    
                    const logs = await window.constructionLogAPI.getConstructionLogs(projectId, filters);
                    // ä¿å­˜æ‰€æœ‰æ—¥å¿—åˆ°å…¨å±€å˜é‡ï¼ˆç”¨äºæœ¬åœ°ç­›é€‰ï¼‰
                    allConstructionLogs = logs || [];
                    renderLogList(logs);
                } catch (error) {
                    console.error('åŠ è½½æ–½å·¥æ—¥å¿—åˆ—è¡¨å¤±è´¥:', error);
                }
            }

            // æ¸²æŸ“æ—¥å¿—åˆ—è¡¨
            function renderLogList(logs) {
                const logListContainer = document.querySelector('.log-list');
                if (!logListContainer) return;

                if (!logs || logs.length === 0) {
                    logListContainer.innerHTML = `
                        <div class="empty-state" style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; text-align: center;">
                            <div style="width: 120px; height: 100px; margin-bottom: 20px; position: relative;">
                                <!-- æ–‡ä»¶å¤¹å›¾æ ‡ -->
                                <svg viewBox="0 0 120 100" style="width: 100%; height: 100%;">
                                    <!-- åé¢æ–‡ä»¶å¤¹ -->
                                    <path d="M20 25 Q20 20 25 20 L45 20 Q50 20 52 25 L55 30 L95 30 Q100 30 100 35 L100 75 Q100 80 95 80 L25 80 Q20 80 20 75 Z" fill="#E3F2FD" stroke="#BBDEFB" stroke-width="1.5"/>
                                    <!-- å‰é¢æ–‡ä»¶å¤¹ -->
                                    <path d="M10 35 Q10 30 15 30 L40 30 Q45 30 47 35 L50 40 L105 40 Q110 40 110 45 L110 85 Q110 90 105 90 L15 90 Q10 90 10 85 Z" fill="#E8F4FD" stroke="#90CAF9" stroke-width="1.5"/>
                                    <!-- é½¿è½®å›¾æ ‡ -->
                                    <g transform="translate(45, 50)">
                                        <circle cx="15" cy="15" r="8" fill="none" stroke="#90CAF9" stroke-width="2"/>
                                        <circle cx="15" cy="15" r="4" fill="#90CAF9"/>
                                        <path d="M15 2 L15 5 M15 25 L15 28 M2 15 L5 15 M25 15 L28 15 M6 6 L8 8 M22 22 L24 24 M6 24 L8 22 M22 6 L24 8" stroke="#90CAF9" stroke-width="2" stroke-linecap="round"/>
                                    </g>
                                </svg>
                            </div>
                            <div style="font-size: 16px; color: #606266; margin-bottom: 20px;">æš‚æ— æ–½å·¥æ—¥å¿—</div>
                            <button class="btn btn-primary" onclick="document.getElementById('writeLogBtn').click()" style="padding: 10px 30px; font-size: 14px;">å†™æ—¥å¿—</button>
                        </div>
                    `;
                    return;
                }

                // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ç”¨äºæ˜¾ç¤º
                const currentUserStr = localStorage.getItem('currentUser');
                let userName = 'ç”¨æˆ·';
                if (currentUserStr) {
                    try {
                        const currentUser = JSON.parse(currentUserStr);
                        userName = currentUser.login_name || 'ç”¨æˆ·';
                    } catch (e) {
                        console.error('è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥:', e);
                    }
                }

                // æ¸…ç©ºç°æœ‰åˆ—è¡¨
                logListContainer.innerHTML = '';

                // æ¸²æŸ“æ¯æ¡æ—¥å¿—
                logs.forEach(log => {
                    const logCard = createLogCard(log, userName);
                    logListContainer.appendChild(logCard);
                });

                // æ·»åŠ åº•éƒ¨æç¤º
                const noMoreData = document.createElement('div');
                noMoreData.className = 'no-more-data';
                noMoreData.textContent = 'æ²¡æœ‰æ›´å¤šæ•°æ®äº† ~';
                logListContainer.appendChild(noMoreData);
            }

            // å»é™¤BBCodeæ ‡ç­¾çš„è¾…åŠ©å‡½æ•°
            function stripBbCode(text) {
                if (!text) return '';
                // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼å»é™¤BBCodeæ ‡ç­¾
                let plainText = text;

                // å…ˆå»é™¤é—­åˆçš„æ ‡ç­¾å¯¹ [tag]...[/tag]
                plainText = plainText.replace(/\[\/?\w+(=[^\]]*)?\]/g, '');

                return plainText;
            }

            // å°†BBCodeè½¬æ¢ä¸ºHTMLçš„è¾…åŠ©å‡½æ•°
            function convertBbCodeToHtml(text) {
                if (!text) return '';
                let html = text;
                // è½¬æ¢å¸¸è§çš„BBCodeæ ‡ç­¾ä¸ºHTML
                html = html.replace(/\[b\]/gi, '<b>');
                html = html.replace(/\[\/b\]/gi, '</b>');
                html = html.replace(/\[i\]/gi, '<i>');
                html = html.replace(/\[\/i\]/gi, '</i>');
                html = html.replace(/\[u\]/gi, '<u>');
                html = html.replace(/\[\/u\]/gi, '</u>');
                html = html.replace(/\[align=(center|left|right)\]/gi, '<div style="text-align: $1;">');
                html = html.replace(/\[\/align\]/gi, '</div>');
                html = html.replace(/\[color=([^\]]+)\]/gi, '<span style="color: $1;">');
                html = html.replace(/\[\/color\]/gi, '</span>');
                html = html.replace(/\[size=(\d+)\]/gi, '<span style="font-size: $1px;">');
                html = html.replace(/\[\/size\]/gi, '</span>');
                // å¤„ç†æ¢è¡Œ
                html = html.replace(/\n/g, '<br>');
                return html;
            }

            // åˆ›å»ºæ—¥å¿—å¡ç‰‡
            function createLogCard(log, userName) {
                const card = document.createElement('div');
                card.className = 'log-card';
                card.dataset.logId = log.log_id;

                // è§£ææ—¥æœŸ
                const recordDate = new Date(log.record_date);
                const dateStr = recordDate.toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                const weekDay = recordDate.toLocaleDateString('zh-CN', { weekday: 'short' });

                // è·å–æœ€åä¿®æ”¹æ—¶é—´
                // ä»ISOå­—ç¬¦ä¸²ä¸­æå–æ—¶é—´éƒ¨åˆ†ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
                const updatedAtStr = log.updated_at;
                let timeStr = '--:--';
                if (updatedAtStr) {
                    // æ ¼å¼: 2026-02-02T22:31:00+08:00 æˆ– 2026-02-02 22:31:00+08
                    const match = updatedAtStr.match(/(\d{2}):(\d{2}):\d{2}/);
                    if (match) {
                        timeStr = `${match[1]}:${match[2]}`;
                    }
                }

                // è§£æå¤©æ°”ä¿¡æ¯
                const weatherInfo = window.constructionLogAPI ? 
                    window.constructionLogAPI.parseWeatherInfo(log.weather_info) : 
                    { am: { weather: 'æ™´å¤©', temp: '19' }, pm: { weather: 'æ™´å¤©', temp: '19' } };

                // è·å–ç”¨æˆ·åå­—çš„é¦–å­—æ¯æˆ–å‰ä¸¤ä¸ªå­—
                const avatarText = userName.substring(0, 2);

                card.innerHTML = `
                    <div class="log-header">
                        <div class="avatar">${avatarText}</div>
                        <div class="user-info">
                            <span class="user-name">${userName}</span>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="log-date">${dateStr} ${weekDay}</span>
                                <span style="font-size: 12px; color: #909399;">${timeStr}</span>
                            </div>
                        </div>
                    </div>
                `;

                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…
                card.addEventListener('click', function() {
                    // ç§»é™¤å…¶ä»–å¡ç‰‡çš„activeçŠ¶æ€
                    document.querySelectorAll('.log-card').forEach(c => c.classList.remove('active'));
                    // æ·»åŠ å½“å‰å¡ç‰‡çš„activeçŠ¶æ€
                    card.classList.add('active');
                    // ä¿å­˜å½“å‰æ—¥å¿—IDåˆ°å…¨å±€å˜é‡
                    currentEditingLogId = log.log_id;
                    // ä¿å­˜å½“å‰æ—¥å¿—çš„å›¾ç‰‡IDåˆ—è¡¨
                    currentLogImageIds = log.image_ids || [];
                    showLogDetail(log);
                });

                return card;
            }

            // æ˜¾ç¤ºæ—¥å¿—è¯¦æƒ…
            function showLogDetail(log) {
                const logDetailContainer = document.getElementById('logDetailContainer');
                const listPageContainer = document.getElementById('listPageContainer');
                const writeLogContainer = document.getElementById('writeLogContainer');

                if (!logDetailContainer) return;

                // éšè—åˆ—è¡¨å’Œå†™æ—¥å¿—ç•Œé¢
                listPageContainer.style.display = 'none';
                writeLogContainer.style.display = 'none';
                logDetailContainer.style.display = 'block';
                currentViewingLog = log;

                // å¡«å……è¯¦æƒ…æ•°æ®
                const currentUserStr = localStorage.getItem('currentUser');
                let userName = 'ç”¨æˆ·';
                if (currentUserStr) {
                    try {
                        const currentUser = JSON.parse(currentUserStr);
                        userName = currentUser.login_name || 'ç”¨æˆ·';
                    } catch (e) {}
                }

                // è§£ææ—¥æœŸ
                const recordDate = new Date(log.record_date);
                const dateStr = recordDate.toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                const weekDay = recordDate.toLocaleDateString('zh-CN', { weekday: 'short' });

                // æ›´æ–°è¯¦æƒ…é¡µå†…å®¹
                const detailAvatar = document.getElementById('detailAvatar');
                const detailUserName = document.getElementById('detailUserName');
                const detailDate = document.getElementById('detailDate');
                const detailContent = document.getElementById('detailContent');

                if (detailAvatar) detailAvatar.textContent = userName.substring(0, 2);
                if (detailUserName) detailUserName.textContent = userName;
                if (detailDate) detailDate.textContent = `${dateStr} ${weekDay}`;
                if (detailContent) {
                    // å°†BBCodeè½¬æ¢ä¸ºHTML
                    const htmlContent = convertBbCodeToHtml(log.log_content || '');
                    detailContent.innerHTML = htmlContent;
                }

                // æ›´æ–°å¤©æ°”ä¿¡æ¯
                const weatherInfo = window.constructionLogAPI ? 
                    window.constructionLogAPI.parseWeatherInfo(log.weather_info) : 
                    { am: { weather: 'æ™´å¤©', temp: '19' }, pm: { weather: 'æ™´å¤©', temp: '19' } };

                // æ›´æ–°è¯¦æƒ…é¡µå¤©æ°”æ˜¾ç¤º
                const detailAmCard = logDetailContainer.querySelector('.weather-card.am');
                const detailPmCard = logDetailContainer.querySelector('.weather-card.pm');
                
                if (detailAmCard && weatherInfo.am) {
                    const amInfoDiv = detailAmCard.querySelector('.weather-info');
                    if (amInfoDiv) {
                        const weatherIcon = getWeatherIcon(weatherInfo.am.weather);
                        amInfoDiv.innerHTML = `
                            <div style="margin-bottom: 8px;">å¤©æ°”ï¼š${weatherIcon} <span style="vertical-align: middle;">${weatherInfo.am.weather}</span></div>
                            <div>æ¸©åº¦ï¼š${weatherInfo.am.temp}â„ƒ</div>
                        `;
                    }
                }
                
                if (detailPmCard && weatherInfo.pm) {
                    const pmInfoDiv = detailPmCard.querySelector('.weather-info');
                    if (pmInfoDiv) {
                        const weatherIcon = getWeatherIcon(weatherInfo.pm.weather);
                        pmInfoDiv.innerHTML = `
                            <div style="margin-bottom: 8px;">å¤©æ°”ï¼š${weatherIcon} <span style="vertical-align: middle;">${weatherInfo.pm.weather}</span></div>
                            <div>æ¸©åº¦ï¼š${weatherInfo.pm.temp}â„ƒ</div>
                        `;
                    }
                }

                // æ›´æ–°å›¾ç‰‡åˆ—è¡¨
                const detailImageList = document.getElementById('detailImageList');
                if (detailImageList) {
                    detailImageList.innerHTML = '';
                    if (log.image_ids && log.image_ids.length > 0) {
                        log.image_ids.forEach(imageUrl => {
                            const imgContainer = document.createElement('div');
                            imgContainer.style.cssText = 'width: 80px; height: 80px; background-color: #f0f2f5; display: flex; align-items: center; justify-content: center; border-radius: 4px; overflow: hidden; position: relative;';
                            
                            // æ·»åŠ åŠ è½½çŠ¶æ€
                            const loadingDiv = document.createElement('div');
                            loadingDiv.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(240, 242, 245, 0.8); display: flex; align-items: center; justify-content: center; z-index: 1;';
                            loadingDiv.innerHTML = '<svg viewBox="0 0 24 24" width="20" height="20" style="animation: rotate 1s linear infinite;"><circle cx="12" cy="12" r="10" stroke="#409EFF" stroke-width="2" fill="none" stroke-dasharray="31.4 31.4" stroke-linecap="round" style="animation: dash 1.5s ease-in-out infinite;"/></svg>';
                            imgContainer.appendChild(loadingDiv);
                            
                            const img = document.createElement('img');
                            img.src = imageUrl;
                            img.alt = 'æ–½å·¥æ—¥å¿—å›¾ç‰‡';
                            img.style.cssText = 'width: 100%; height: 100%; object-fit: cover; cursor: pointer;';
                            img.className = 'detail-image';
                            img.addEventListener('click', () => showImageModal(imageUrl));
                            
                            // å›¾ç‰‡åŠ è½½å®Œæˆåéšè—åŠ è½½çŠ¶æ€
                            img.onload = function() {
                                loadingDiv.style.display = 'none';
                            };
                            
                            // å›¾ç‰‡åŠ è½½å¤±è´¥åéšè—åŠ è½½çŠ¶æ€
                            img.onerror = function() {
                                loadingDiv.style.display = 'none';
                            };
                            
                            imgContainer.appendChild(img);
                            detailImageList.appendChild(imgContainer);
                        });
                    } else {
                        detailImageList.innerHTML = '<span style="color: #909399; font-size: 13px;">æš‚æ— å›¾ç‰‡</span>';
                    }
                }

                // æ›´æ–°æ ‡é¢˜
                document.title = 'æ–½å·¥æ—¥å¿—è¯¦æƒ…';
                window.parent.postMessage({ type: 'updateTitle', title: 'æ–½å·¥æ—¥å¿—è¯¦æƒ…' }, '*');
            }

            // è·å–å¤©æ°”å›¾æ ‡SVG
            function getWeatherIcon(weather) {
                const weatherIcons = {
                    'æ™´å¤©': '<svg viewBox="0 0 64 64" width="20" height="20" style="vertical-align: middle;"><circle cx="32" cy="32" r="14" fill="#FFD700" stroke="#FFA500" stroke-width="2"/><g stroke="#FFD700" stroke-width="3" stroke-linecap="round"><line x1="32" y1="10" x2="32" y2="4"/><line x1="32" y1="54" x2="32" y2="60"/><line x1="54" y1="32" x2="60" y2="32"/><line x1="4" y1="32" x2="10" y2="32"/><line x1="48" y1="16" x2="52" y2="12"/><line x1="16" y1="48" x2="12" y2="52"/><line x1="48" y1="48" x2="52" y2="52"/><line x1="16" y1="16" x2="12" y2="12"/></g></svg>',
                    'å¤šäº‘': '<svg viewBox="0 0 64 64" width="20" height="20" style="vertical-align: middle;"><circle cx="25" cy="25" r="10" fill="#FFD700" stroke="#FFA500" stroke-width="2"/><path d="M15 45 Q15 35 25 35 L45 35 Q55 35 55 45 Q55 55 45 55 L25 55 Q15 55 15 45" fill="#E0E0E0" stroke="#BDBDBD" stroke-width="2"/></svg>',
                    'é˜´å¤©': '<svg viewBox="0 0 64 64" width="20" height="20" style="vertical-align: middle;"><path d="M15 45 Q15 35 25 35 L45 35 Q55 35 55 45 Q55 55 45 55 L25 55 Q15 55 15 45" fill="#BDBDBD" stroke="#9E9E9E" stroke-width="2"/></svg>',
                    'é›¨å¤©': '<svg viewBox="0 0 64 64" width="20" height="20" style="vertical-align: middle;"><path d="M15 40 Q15 30 25 30 L45 30 Q55 30 55 40 Q55 50 45 50 L25 50 Q15 50 15 40" fill="#90CAF9" stroke="#64B5F6" stroke-width="2"/><line x1="25" y1="55" x2="22" y2="62" stroke="#2196F3" stroke-width="2" stroke-linecap="round"/><line x1="35" y1="55" x2="32" y2="62" stroke="#2196F3" stroke-width="2" stroke-linecap="round"/><line x1="45" y1="55" x2="42" y2="62" stroke="#2196F3" stroke-width="2" stroke-linecap="round"/></svg>',
                    'é›ªå¤©': '<svg viewBox="0 0 64 64" width="20" height="20" style="vertical-align: middle;"><path d="M15 40 Q15 30 25 30 L45 30 Q55 30 55 40 Q55 50 45 50 L25 50 Q15 50 15 40" fill="#E3F2FD" stroke="#90CAF9" stroke-width="2"/><circle cx="25" cy="58" r="2" fill="#2196F3"/><circle cx="35" cy="62" r="2" fill="#2196F3"/><circle cx="45" cy="58" r="2" fill="#2196F3"/></svg>',
                    'é›·é˜µé›¨': '<svg viewBox="0 0 64 64" width="20" height="20" style="vertical-align: middle;"><path d="M15 35 Q15 25 25 25 L45 25 Q55 25 55 35 Q55 45 45 45 L25 45 Q15 45 15 35" fill="#757575" stroke="#616161" stroke-width="2"/><polygon points="35,48 30,58 34,58 32,68 42,55 37,55" fill="#FFD700" stroke="#FFA500" stroke-width="1.5"/></svg>'
                };
                return weatherIcons[weather] || weatherIcons['æ™´å¤©'];
            }

            // æ ¹æ®æ—¥æœŸèŒƒå›´ç­›é€‰æ–½å·¥æ—¥å¿—ï¼ˆåœ¨æœ¬åœ°åˆ—è¡¨ä¸­ç­›é€‰ï¼‰
            function filterConstructionLogs(startDate, endDate) {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const logListContainer = document.querySelector('.log-list');
                if (logListContainer) {
                    logListContainer.innerHTML = `
                        <div class="loading-state" style="text-align: center; padding: 40px; color: #909399;">
                            <div style="margin-bottom: 10px;">
                                <svg viewBox="0 0 24 24" width="32" height="32" style="animation: rotate 1s linear infinite;">
                                    <circle cx="12" cy="12" r="10" stroke="#409EFF" stroke-width="3" fill="none" stroke-dasharray="31.4 31.4" stroke-linecap="round" style="animation: dash 1.5s ease-in-out infinite;"/>
                                </svg>
                            </div>
                            <div>æ­£åœ¨ç­›é€‰...</div>
                        </div>
                    `;
                }

                // ä½¿ç”¨setTimeoutè®©UIæœ‰æœºä¼šæ›´æ–°åŠ è½½çŠ¶æ€
                setTimeout(() => {
                    try {
                        // åœ¨æœ¬åœ°æ—¥å¿—åˆ—è¡¨ä¸­ç­›é€‰
                        let filteredLogs = allConstructionLogs;
                        
                        if (startDate) {
                            filteredLogs = filteredLogs.filter(log => log.record_date >= startDate);
                        }
                        if (endDate) {
                            filteredLogs = filteredLogs.filter(log => log.record_date <= endDate);
                        }

                        renderLogList(filteredLogs);

                        // æ˜¾ç¤ºç­›é€‰ç»“æœæç¤º
                        const dateRangeText = startDate && endDate ? `${startDate} è‡³ ${endDate}` : 
                                             startDate ? `${startDate} ä¹‹å` : 
                                             endDate ? `${endDate} ä¹‹å‰` : 'å…¨éƒ¨';
                        showNotification(`å·²ç­›é€‰ ${dateRangeText} çš„æ—¥å¿—ï¼Œå…± ${filteredLogs.length} æ¡`, false);
                    } catch (error) {
                        console.error('ç­›é€‰æ–½å·¥æ—¥å¿—å¤±è´¥:', error);
                        showNotification('ç­›é€‰å¤±è´¥ï¼Œè¯·é‡è¯•', true);
                    }
                }, 100);
            }

            // é¡µé¢åŠ è½½å®ŒæˆååŠ è½½æ—¥å¿—åˆ—è¡¨
            loadConstructionLogs();

            // --- å›¾ç‰‡ä¸Šä¼ ä¸é¢„è§ˆåŠŸèƒ½ ---
            window.selectedImages = []; // å…¨å±€å­˜å‚¨é€‰ä¸­çš„å›¾ç‰‡æ–‡ä»¶

            const addImgBtn = document.getElementById('addImgBtn');
            const imageUploadInput = document.getElementById('imageUpload');
            const imageUploadContainer = document.getElementById('imageUploadContainer');

            // ç‚¹å‡»æ·»åŠ æŒ‰é’®è§¦å‘æ–‡ä»¶é€‰æ‹©
            if (addImgBtn && imageUploadInput) {
                addImgBtn.addEventListener('click', function() {
                    imageUploadInput.click();
                });
            }

            // ç›‘å¬æ–‡ä»¶é€‰æ‹©å˜åŒ–
            if (imageUploadInput) {
                imageUploadInput.addEventListener('change', function(e) {
                    if (e.target.files && e.target.files.length > 0) {
                        Array.from(e.target.files).forEach(file => {
                            // æ·»åŠ åˆ°å…¨å±€æ•°ç»„
                            window.selectedImages.push(file);
                            
                            // è·å–å½“å‰ç´¢å¼•
                            const currentIndex = window.selectedImages.length - 1;

                            // å°è¯•å‹ç¼©å¹¶é¢„è§ˆ
                            processImage(file).then(compressed => {
                                // æ›¿æ¢ä¸ºå‹ç¼©åçš„æ–‡ä»¶ï¼ˆå¦‚æœæœ‰éœ€è¦å¯ä»¥æ›¿æ¢ï¼Œè¿™é‡Œæš‚æ—¶ä¿ç•™åŸæ–‡ä»¶æˆ–ä½¿ç”¨compressed.blobï¼‰
                                // window.selectedImages[currentIndex] = new File([compressed.blob], file.name, { type: compressed.blob.type });
                                renderImagePreview(file, currentIndex);
                            }).catch(error => {
                                console.warn('å›¾ç‰‡å‹ç¼©å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹å›¾ç‰‡:', error);
                                renderImagePreview(file, currentIndex);
                            });
                        });
                        
                        // æ¸…ç©ºinputå€¼ï¼Œå…è®¸é‡å¤é€‰æ‹©
                        e.target.value = '';
                    }
                });
            }

            // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†
            function showImageModal(imageUrl) {
                const modal = document.getElementById('imageModal');
                modal.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2001;" 
                         onclick="if(event.target === this) document.getElementById('imageModal').style.display='none'">
                        <img id="draggableImage" src="${imageUrl}" 
                             style="max-width: 90%; max-height: 90%; position: absolute; cursor: move; top: 50%; left: 50%; transform: translate(-50%, -50%); transition: transform 0.1s ease-out;" 
                             ondragstart="return false;">
                        
                        <!-- å…³é—­æŒ‰é’® -->
                        <button onclick="document.getElementById('imageModal').style.display='none'" 
                                style="position: fixed; top: 20px; right: 20px; background: #f5222d; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer; z-index: 2002; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">Ã—</button>
                        
                        <!-- æ—‹è½¬æ§åˆ¶æŒ‰é’® -->
                        <div style="position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; z-index: 2002;">
                            <button id="rotateLeftBtn" style="background: rgba(255,255,255,0.2); backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; transition: all 0.2s;">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                                <span style="margin-left: 6px;">å·¦æ—‹è½¬</span>
                            </button>
                            <button id="flipHorizontalBtn" style="background: rgba(255,255,255,0.2); backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; transition: all 0.2s;">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v18"/><path d="M5 9l-3 3 3 3"/><path d="M19 9l3 3-3 3"/></svg>
                                <span style="margin-left: 6px;">å·¦å³é•œåƒ</span>
                            </button>
                            <button id="flipVerticalBtn" style="background: rgba(255,255,255,0.2); backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; transition: all 0.2s;">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12h18"/><path d="M9 5l3-3 3 3"/><path d="M9 19l3 3 3-3"/></svg>
                                <span style="margin-left: 6px;">ä¸Šä¸‹é•œåƒ</span>
                            </button>
                            <button id="rotateRightBtn" style="background: rgba(255,255,255,0.2); backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; transition: all 0.2s;">
                                <span style="margin-right: 6px;">å³æ—‹è½¬</span>
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
                            </button>
                        </div>
                    </div>
                `;
                modal.style.display = 'block';
                
                // å›¾ç‰‡æ‹–åŠ¨ã€ç¼©æ”¾å’Œæ—‹è½¬é€»è¾‘
                const dragImg = document.getElementById('draggableImage');
                const rotateLeftBtn = document.getElementById('rotateLeftBtn');
                const rotateRightBtn = document.getElementById('rotateRightBtn');
                const flipHorizontalBtn = document.getElementById('flipHorizontalBtn');
                const flipVerticalBtn = document.getElementById('flipVerticalBtn');
                
                let isDragging = false;
                let startX, startY;
                let initialLeft, initialTop;
                let scale = 1;
                let rotation = 0;
                let scaleX = 1;
                let scaleY = 1;

                // ç»Ÿä¸€æ›´æ–°å˜æ¢æ ·å¼
                function updateTransform() {
                    // æ³¨æ„å˜æ¢é¡ºåºï¼šå…ˆä½ç§»å±…ä¸­ï¼Œç„¶åæ—‹è½¬ï¼Œç„¶åç¼©æ”¾(åŒ…å«é•œåƒ)
                    // ç”±äºscaleX/scaleYæ˜¯åŸºäºåŸå§‹å°ºå¯¸çš„é•œåƒï¼Œscaleæ˜¯ç¼©æ”¾å€æ•°
                    // ç»„åˆç¼©æ”¾å› å­ï¼šæ€»Xç¼©æ”¾ = scale * scaleX, æ€»Yç¼©æ”¾ = scale * scaleY
                    dragImg.style.transform = `translate(-50%, -50%) rotate(${rotation}deg) scale(${scale * scaleX}, ${scale * scaleY})`;
                }

                // æ—‹è½¬æŒ‰é’®äº‹ä»¶
                rotateLeftBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    rotation -= 90;
                    updateTransform();
                });

                rotateRightBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    rotation += 90;
                    updateTransform();
                });

                // é•œåƒæŒ‰é’®äº‹ä»¶
                flipHorizontalBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    scaleX = scaleX === 1 ? -1 : 1;
                    updateTransform();
                });

                flipVerticalBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    scaleY = scaleY === 1 ? -1 : 1;
                    updateTransform();
                });

                // æŒ‰é’®æ‚¬åœæ•ˆæœ
                [rotateLeftBtn, rotateRightBtn, flipHorizontalBtn, flipVerticalBtn].forEach(btn => {
                    btn.addEventListener('mouseenter', () => btn.style.background = 'rgba(255,255,255,0.3)');
                    btn.addEventListener('mouseleave', () => btn.style.background = 'rgba(255,255,255,0.2)');
                });

                dragImg.addEventListener('mousedown', function(e) {
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    const rect = dragImg.getBoundingClientRect();
                    
                    // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ‹–æ‹½ï¼Œéœ€è¦åˆå§‹åŒ–style.leftå’Œstyle.topä¸ºå½“å‰åƒç´ å€¼
                    if (!dragImg.style.left || dragImg.style.left === '50%') {
                        // è®¡ç®—å½“å‰çš„ä¸­å¿ƒç‚¹ä½ç½®ï¼Œé¿å…è·³åŠ¨
                        // ä½¿ç”¨ boundingClientRect çš„ä¸­å¿ƒç‚¹ä½œä¸ºåˆå§‹ left/top
                        const centerX = rect.left + rect.width / 2;
                        const centerY = rect.top + rect.height / 2;
                        
                        dragImg.style.left = centerX + 'px';
                        dragImg.style.top = centerY + 'px';
                    }
                    
                    initialLeft = parseFloat(dragImg.style.left);
                    initialTop = parseFloat(dragImg.style.top);
                    
                    dragImg.style.cursor = 'grabbing';
                    // æ‹–åŠ¨æ—¶æš‚æ—¶ç§»é™¤è¿‡æ¸¡æ•ˆæœä»¥ä¿è¯è·Ÿæ‰‹
                    dragImg.style.transition = 'none';
                });

                document.addEventListener('mousemove', function(e) {
                    if (!isDragging) return;
                    e.preventDefault();
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    
                    dragImg.style.left = (initialLeft + dx) + 'px';
                    dragImg.style.top = (initialTop + dy) + 'px';
                });

                document.addEventListener('mouseup', function() {
                    if (isDragging) {
                        isDragging = false;
                        if(dragImg) {
                            dragImg.style.cursor = 'move';
                            // æ¢å¤è¿‡æ¸¡æ•ˆæœ
                            dragImg.style.transition = 'transform 0.1s ease-out';
                        }
                    }
                });

                // æ»šè½®ç¼©æ”¾
                dragImg.addEventListener('wheel', function(e) {
                    e.preventDefault();
                    const delta = e.deltaY > 0 ? -0.1 : 0.1;
                    scale += delta;
                    scale = Math.max(0.5, Math.min(5, scale)); // ç¨å¾®æ”¾å®½ç¼©æ”¾é™åˆ¶
                    updateTransform();
                });
            }

            // ç›‘å¬è¯¦æƒ…é¡µå›¾ç‰‡ç‚¹å‡»
            document.body.addEventListener('click', function(e) {
                if (e.target.classList.contains('detail-image')) {
                    showImageModal(e.target.src);
                }
            });

            // å›¾ç‰‡å‹ç¼©å‡½æ•°
            function processImage(file) {
                return new Promise((resolve, reject) => {
                    try {
                        if (!file || !file.type.startsWith('image/')) {
                            reject(new Error('ä¸æ˜¯æœ‰æ•ˆçš„å›¾ç‰‡ç±»å‹'));
                            return;
                        }
                        
                        if (typeof Compressor === 'undefined') {
                            reject(new Error('Compressoråº“æœªåŠ è½½'));
                            return;
                        }

                        new Compressor(file, {
                            quality: 0.7,
                            maxWidth: 1920,
                            maxHeight: 1080,
                            success(result) {
                                resolve({
                                    blob: result
                                });
                            },
                            error(err) {
                                reject(err);
                            }
                        });
                    } catch (error) {
                        reject(error);
                    }
                });
            }

            // æ¸²æŸ“å›¾ç‰‡é¢„è§ˆ
            function renderImagePreview(file, index) {
                const previewItem = document.createElement('div');
                previewItem.className = 'image-preview-item';
                previewItem.style.position = 'relative';
                previewItem.style.width = '100px';
                previewItem.style.height = '100px';
                previewItem.style.borderRadius = '6px';
                previewItem.style.overflow = 'hidden';
                previewItem.style.border = '1px solid #d9d9d9';
                
                // ä¿å­˜æ–‡ä»¶å¼•ç”¨
                previewItem.fileObject = file;
                
                const tempUrl = URL.createObjectURL(file);
                
                // æ·»åŠ åŠ è½½çŠ¶æ€
                const loadingDiv = document.createElement('div');
                loadingDiv.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(240, 242, 245, 0.8); display: flex; align-items: center; justify-content: center; z-index: 1;';
                loadingDiv.innerHTML = '<svg viewBox="0 0 24 24" width="20" height="20" style="animation: rotate 1s linear infinite;"><circle cx="12" cy="12" r="10" stroke="#409EFF" stroke-width="2" fill="none" stroke-dasharray="31.4 31.4" stroke-linecap="round" style="animation: dash 1.5s ease-in-out infinite;"/></svg>';
                previewItem.appendChild(loadingDiv);
                
                const img = document.createElement('img');
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                img.style.cursor = 'pointer';
                img.src = tempUrl;
                
                // ç‚¹å‡»æŸ¥çœ‹å¤§å›¾
                img.addEventListener('click', function() {
                    showImageModal(tempUrl);
                });
                
                // å›¾ç‰‡åŠ è½½å®Œæˆåéšè—åŠ è½½çŠ¶æ€
                img.onload = function() {
                    loadingDiv.style.display = 'none';
                };
                
                // å›¾ç‰‡åŠ è½½å¤±è´¥åéšè—åŠ è½½çŠ¶æ€
                img.onerror = function() {
                    loadingDiv.style.display = 'none';
                };
                
                // åˆ é™¤æŒ‰é’®
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = 'Ã—';
                deleteBtn.style.position = 'absolute';
                deleteBtn.style.top = '0';
                deleteBtn.style.right = '0';
                deleteBtn.style.width = '20px';
                deleteBtn.style.height = '20px';
                deleteBtn.style.background = 'rgba(0,0,0,0.5)';
                deleteBtn.style.color = '#fff';
                deleteBtn.style.border = 'none';
                deleteBtn.style.cursor = 'pointer';
                deleteBtn.style.display = 'flex';
                deleteBtn.style.alignItems = 'center';
                deleteBtn.style.justifyContent = 'center';
                deleteBtn.style.borderBottomLeftRadius = '4px';
                deleteBtn.style.zIndex = '2'; // ç¡®ä¿åˆ é™¤æŒ‰é’®åœ¨åŠ è½½åŠ¨ç”»ä¹‹ä¸Š

                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation(); // é˜²æ­¢è§¦å‘å›¾ç‰‡ç‚¹å‡»
                    const idx = window.selectedImages.indexOf(file);
                    if (idx > -1) {
                        window.selectedImages.splice(idx, 1);
                    }
                    previewItem.remove();
                });

                previewItem.appendChild(img);
                previewItem.appendChild(deleteBtn);
                
                // æ’å…¥åˆ°æ·»åŠ æŒ‰é’®ä¹‹å‰
                imageUploadContainer.insertBefore(previewItem, addImgBtn);
            }
        });
    </script>

</body>
</html>
