<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>飞鱼记工</title>
    <!-- 本地加载完整的Supabase库 -->
    <script src="JavaScript/supabase/supabase.min.js"></script>
    <!-- 加载浏览器环境的Supabase配置 -->
    <script src="JavaScript/supabase/supabase-client.js"></script>
    
    <!-- 导入本地数据清理工具 -->
    <script src="JavaScript/首页/local-data-cleaner.js"></script>
    
    <!-- 导入项目数据同步服务 -->
    <script src="JavaScript/首页/project-sync-service.js"></script>
    
    <!-- 导入员工数据同步服务 -->
    <script src="JavaScript/首页/employee-sync-service.js"></script>
    
    <!-- 初始化执行顺序控制脚本 -->
    <script>
    // 查询employees表中status为"在职"和"隐藏"的个数之和
    async function getEmployeeCount(projectId) {
        try {
            // 检查Supabase客户端是否可用
            if (!window.supabase) {
                console.error('Supabase客户端未初始化');
                return 0;
            }
            
            // 执行SQL查询
            let query = window.supabase
                .from('employees')
                .select('status')
                .in('status', ['在职', '隐藏']);
            
            // 如果提供了项目ID，添加项目过滤
            if (projectId) {
                query = query.eq('project_id', projectId);
            }
            
            // 执行查询
            const { data, error } = await query;
            
            if (error) {
                console.error('查询员工数据失败:', error);
                return 0;
            }
            
            // 返回结果数量
            return data.length;
        } catch (error) {
            console.error('获取员工数量失败:', error);
            return 0;
        }
    }

    // 按顺序执行初始化流程：初始化首页功能→清除本地项目数据→初始化Supabase客户端→同步项目数据→查询员工数量→加载项目列表页面
    document.addEventListener('DOMContentLoaded', async function() {
        try {
            // 初始化首页功能 - 检查是否有首页初始化函数
            if (window.initializeHomePage) {
                await window.initializeHomePage();
                console.log('✅ 1.首页功能初始化成功');
            } else {
                // 跳过此步骤，不输出日志
            }
            
            // 清除本地项目数据
            if (window.clearLocalProjectData) {
                await window.clearLocalProjectData();
                // 本地数据清理日志由local-data-cleaner.js输出，这里不再重复
            } else {
                // 跳过此步骤，不输出日志
            }
            
            // 确保Supabase客户端已初始化 - 使用waitForSupabase方法等待客户端准备就绪
            if (window.waitForSupabase) {
                await window.waitForSupabase();
                console.log('✅ 3.Supabase客户端初始化成功');
            } else {
                // 检查是否已经有初始化好的客户端
                if (window.supabase) {
                    console.log('✅ 3.Supabase客户端已存在');
                } else {
                    throw new Error('Supabase客户端初始化方法不可用');
                }
            }
            
            // 确保Supabase客户端已初始化后再同步项目数据
            if (window.supabase) {
                // 等待项目数据同步完成，并获取返回的项目数据
                let projectsData = [];
                try {
                    if (window.ProjectSyncService && window.ProjectSyncService.syncProjectData) {
                        // 直接使用已初始化的window.supabase，获取返回的项目数据
                        projectsData = await window.ProjectSyncService.syncProjectData();
                        // 同步完成的日志已在service中输出，这里不再重复输出
                    } else if (window.syncProjectData) {
                        projectsData = await window.syncProjectData();
                        // 同步完成的日志已在service中输出，这里不再重复输出
                    } else {
                        // 跳过此步骤，不输出日志
                    }
                } catch (syncError) {
                    // 同步失败不阻止页面加载，不输出日志
                }
                
                // 项目数据同步完成后，初始化实时订阅
                if (typeof initHomeRealtimeSubscription === 'function') {
                    initHomeRealtimeSubscription();
                }
                
                // 获取到项目数据后立即加载项目列表页面
                if (window.loadProjectList) {
                    window.loadProjectList();
                    // 隐藏加载指示器
                    const loadingIndicator = document.getElementById('loadingIndicator');
                    if (loadingIndicator) {
                        loadingIndicator.style.display = 'none';
                    }
                } else {
                    // 如果没有专门的加载函数，直接导航到项目列表
                    if (typeof navigateTo === 'function') {
                        navigateTo('项目列表.html');
                    } else {
                        // 隐藏加载指示器
                        const loadingIndicator = document.getElementById('loadingIndicator');
                        if (loadingIndicator) {
                            loadingIndicator.style.display = 'none';
                        }
                        window.location.href = '项目列表.html';
                    }
                }
                
                // 异步查询每个项目的员工数量并存储到本地存储
                setTimeout(async () => {
                    try {
                        if (projectsData.length > 0) {
                            // 从currentUser获取user_id
                            let userId = 'default';
                            try {
                                const currentUserStr = localStorage.getItem('currentUser');
                                if (currentUserStr) {
                                    const currentUser = JSON.parse(currentUserStr);
                                    userId = currentUser.user_id || 'default';
                                }
                            } catch (e) {
                                console.error('解析currentUser失败:', e);
                            }
                            
                            // 为每个项目查询员工数量
                            const employeeCounts = {};
                            for (const project of projectsData) {
                                if (project.project_id) {
                                    const count = await getEmployeeCount(project.project_id);
                                    employeeCounts[project.project_id] = count;
                                }
                            }
                            
                            // 存储员工数量到本地存储
                            localStorage.setItem('employee_counts_' + userId, JSON.stringify(employeeCounts));
                            
                            // 发送消息通知其他窗口员工数据已更新
                            window.localStorage.setItem('employeeDataUpdated', Date.now());
                            // 静默处理，不输出日志
                        }
                    } catch (error) {
                        console.error('查询员工数量失败:', error);
                    }
                }, 0);
                
                // 并行执行数据同步，不阻塞页面加载
                // 员工数据同步
                try {
                    // 直接使用项目数据同步服务返回的项目数据，筛选出状态为在建的项目ID
                    const ongoingProjectIds = projectsData
                        .filter(project => project.status === '在建' && project.project_id)
                        .map(project => project.project_id);
                    
                    // 如果有在建项目ID，同步员工数据
                    if (ongoingProjectIds.length > 0) {
                        if (window.EmployeeSyncService && window.EmployeeSyncService.syncEmployeeData) {
                            // 异步执行，不等待完成
                            window.EmployeeSyncService.syncEmployeeData(ongoingProjectIds).catch(err => {
                                console.warn('员工数据同步过程中出现警告:', err);
                            });
                            // 同步完成的日志已在service中输出，这里不再重复输出
                        } else if (window.syncEmployeeData) {
                            // 异步执行，不等待完成
                            window.syncEmployeeData(ongoingProjectIds).catch(err => {
                                console.warn('员工数据同步过程中出现警告:', err);
                            });
                            // 同步完成的日志已在service中输出，这里不再重复输出
                        } else {
                            console.log('员工数据同步函数未定义，跳过此步骤');
                        }
                    } else {
                        console.log('没有找到在建项目，跳过员工数据同步');
                    }
                } catch (employeeSyncError) {
                    console.warn('员工数据同步过程中出现警告:', employeeSyncError);
                    // 员工同步失败不阻止页面加载
                }
                
                // 考勤记录数据同步（如果有专门的同步函数）
                try {
                    if (window.ProjectSyncService && window.ProjectSyncService.syncAttendanceData) {
                        // 异步执行，不等待完成
                        window.ProjectSyncService.syncAttendanceData(projectsData).catch(err => {
                            console.warn('考勤记录数据同步过程中出现警告:', err);
                        });
                    }
                } catch (attendanceSyncError) {
                    console.warn('考勤记录数据同步过程中出现警告:', attendanceSyncError);
                }
                
                // 结算记录数据同步（如果有专门的同步函数）
                try {
                    if (window.ProjectSyncService && window.ProjectSyncService.syncSettlementData) {
                        // 异步执行，不等待完成
                        window.ProjectSyncService.syncSettlementData(projectsData).catch(err => {
                            console.warn('结算记录数据同步过程中出现警告:', err);
                        });
                    }
                } catch (settlementSyncError) {
                    console.warn('结算记录数据同步过程中出现警告:', settlementSyncError);
                }
            } else {
                console.error('❌ 项目数据同步失败：Supabase客户端未初始化');
                
                // 即使Supabase未初始化，也尝试加载项目列表页面
                console.log('5. 准备加载项目列表页面...');
                // 隐藏加载指示器
                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                if (window.loadProjectList) {
                    console.log('加载项目列表页面...');
                    window.loadProjectList();
                } else {
                    console.log('加载项目列表页面...');
                    // 如果没有专门的加载函数，直接导航到项目列表
                    if (typeof navigateTo === 'function') {
                        navigateTo('项目列表.html');
                    } else {
                        window.location.href = '项目列表.html';
                    }
                }
            }
            
        } catch (error) {
            console.error('初始化过程中发生错误:', error);
            // 隐藏加载指示器
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
            // 即使出错也尝试加载项目列表页面，避免用户无法继续操作
            setTimeout(() => {
                if (typeof navigateTo === 'function') {
                    navigateTo('项目列表.html');
                } else {
                    window.location.href = '项目列表.html';
                }
            }, 1000);
        }
    });
    </script>
    <style>
        * {
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            display: flex;
            min-height: 100vh;
        }

        /* 左侧导航栏 */
        .sidebar {
            width: 80px; 
            background: linear-gradient(180deg, #667eea 0%, #764ba2 20%, #1e293b 100%);
            color: white; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 40px 0; 
            box-shadow: 8px 0 30px rgba(102, 126, 234, 0.3);
            position: fixed;
            height: 100vh;
            z-index: 100;
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-item {
            margin: 15px 0; 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            padding: 12px 0;
            width: 60px;
            height: 60px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .sidebar-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: scale(1.08) translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .sidebar-item.active {
            color: #ffffff;
            background: linear-gradient(135deg, #38bdf8, #0ea5e9);
            box-shadow: 0 8px 25px rgba(56, 189, 248, 0.5);
            border-color: rgba(56, 189, 248, 0.3);
        }

        .sidebar-item.active::before {
            content: '';
            position: absolute;
            left: -2px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 30px;
            background: linear-gradient(to bottom, #ffffff, #38bdf8);
            border-radius: 6px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }

        .sidebar-icon {
            font-size: 20px;
            margin-bottom: 2px;
            transition: all 0.4s ease;
            font-weight: 300;
            opacity: 0.8;
            color: white;
        }

        .sidebar-item:hover .sidebar-icon {
            transform: translateY(-2px) scale(1.05);
            opacity: 1;
        }

        .sidebar-item.active .sidebar-icon {
            opacity: 1;
            animation: iconPulse 2s infinite;
        }

        @keyframes iconPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

        .sidebar-text {
            font-size: 11px;
            font-weight: 400;
            opacity: 0.7;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        /* 主内容区域 */
        .main-content {
            flex: 1; 
            margin-left: 80px; 
            display: flex; 
            flex-direction: column;
            border-radius: 20px 0 0 20px;
            overflow: hidden;
            box-shadow: -8px 0 30px rgba(102, 126, 234, 0.15);
            position: relative;
        }

        /* 顶部栏 */
        .header {
            background: rgba(255, 255, 255, 0.95);
            color: #1e293b; 
            padding: 15px 30px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            height: 50px;
        }

        .header-title {
            font-size: 24px; 
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            /* 超长省略与悬停完整显示 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 60vw;
        }

        /* 返回按钮样式 */
        .back-button {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            opacity: 0.5;
            pointer-events: none;
        }

        .back-button.enabled {
            opacity: 1;
            pointer-events: auto;
        }

        .back-button.enabled:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
            background: linear-gradient(135deg, #764ba2, #667eea);
        }

        .back-button:active {
            transform: translateY(0);
        }

        .back-icon {
            font-size: 16px;
        }

        /* 历史记录下拉菜单 */
        .history-dropdown {
            position: absolute;
            top: 50px;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            padding: 8px 0;
            min-width: 250px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: modalSlideIn 0.3s ease;
        }

        .history-dropdown.active {
            display: block;
        }

        .history-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #374151;
        }

        .history-item:hover {
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.1), transparent);
        }

        .history-item.current {
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.15), transparent);
            color: #667eea;
            font-weight: 600;
        }

        .history-item-icon {
            font-size: 12px;
            color: #94a3b8;
            width: 16px;
            text-align: center;
        }

        .history-item-text {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-dropdown-header {
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 12px;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* 用户信息区域调整，为返回按钮腾出空间 */
        .user-info {
            display: flex;
            align-items: center;
            cursor: pointer;
            position: relative;
            padding: 8px 16px;
            border-radius: 50px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            margin-left: 12px;
        }

        .user-info:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .user-info:hover .user-name {
            color: #667eea;
        }

        .user-name {
            margin-right: 12px;
            font-weight: 600;
            font-size: 15px;
            color: #1e293b;
            transition: color 0.3s ease;
        }

        .avatar {
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: 700;
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }

        .user-info:hover .avatar {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        /* 确认弹窗样式 */
.confirm-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(4px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 2000;
  animation: fadeIn 0.2s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.confirm-box {
  background: rgba(255, 255, 255, 0.98);
  border-radius: 20px;
  padding: 32px;
  width: 380px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  animation: scaleIn 0.3s ease;
}

@keyframes scaleIn {
  from {
    opacity: 0;
    transform: scale(0.9);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.confirm-content h3 {
  display: flex;
  align-items: center;
  gap: 12px;
  color: #1e293b;
  margin-bottom: 16px;
  font-size: 20px;
  font-weight: 600;
}

.warning-icon {
  font-size: 28px;
  color: #f59e0b;
  min-width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(245, 158, 11, 0.1);
  border-radius: 50%;
  padding: 4px;
}

.confirm-content p {
  color: #64748b;
  margin-bottom: 32px;
  font-size: 16px;
  line-height: 1.5;
}

.confirm-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    flex-wrap: nowrap;
  }

.confirm-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.2s ease;
    min-width: 80px;
    white-space: nowrap;
  }

.confirm-cancel {
  background: #f1f5f9;
  color: #64748b;
  border: 1px solid #e2e8f0;
}

.confirm-cancel:hover {
  background: #e2e8f0;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.confirm-ok {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: white;
  box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

.confirm-ok:hover {
  background: linear-gradient(135deg, #dc2626, #b91c1c);
  transform: translateY(-1px);
  box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
}

/* 退出登录弹窗 */
        .logout-modal {
            position: absolute;
            top: 60px;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            padding: 8px 0;
            min-width: 140px;
            z-index: 1000;
            display: none;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: modalSlideIn 0.3s ease;
        }

        .logout-modal.active {
            display: block;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logout-btn {
            display: block;
            width: 70%;
            margin: 0 auto;
            padding: 0px 0px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            color: #374151;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .logout-btn:hover {
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.1), transparent);
            color: #ef4444;
            padding-left: 24px;
        }

        /* 项目设置模态框样式 */
        .project-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.4));
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(4px);
            z-index: 2000;
        }

        .project-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .project-modal {
            background: linear-gradient(135deg, #ffffff, #f8fafc);
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
            width: 90%;
            max-width: 320px;
            padding: 24px;
            position: relative;
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.3s ease;
            overflow-y: auto;
            max-height: 80vh;
        }

        .project-modal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #06b6d4);
        }

        .project-modal-overlay.active .project-modal {
            transform: scale(1);
            opacity: 1;
        }

        .project-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .project-modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
            background: linear-gradient(135deg, #1e293b, #475569);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
        }

        .project-modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #94a3b8;
            transition: all 0.3s ease;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            padding: 0;
        }

        .project-modal-close:hover {
            color: #ef4444;
            background-color: #fee2e2;
            transform: rotate(90deg);
        }

        .project-modal-body {
            margin-bottom: 24px;
            padding: 0;
        }

        .project-form-group {
            margin-bottom: 8px;
        }

        .project-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .project-form-group input {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background-color: #f9fafb;
            color: #111827;
            min-height: 44px;
        }

        .project-form-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
            background-color: #ffffff;
            transform: translateY(-1px);
        }

        .project-form-group input:hover {
            border-color: #d1d5db;
            background-color: #ffffff;
        }

        .project-form-row {
            display: flex;
            gap: 16px;
            margin-bottom: 0px;
            padding: 4px;
            background: linear-gradient(135deg, #ffffff, #f9fafb);
            border-radius: 12px;
        }

        .project-form-control-wrapper {
            display: flex;
            align-items: center;
            position: relative;
        }

        .project-form-control-wrapper input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px 0 0 8px;
            font-size: 15px;
            transition: all 0.3s ease;
            background-color: #f9fafb;
            color: #111827;
            min-width: 80px;
            min-height: 42px;
        }

        .project-form-control-wrapper .unit {
            padding: 10px 8px;
            background-color: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-left: none;
            border-radius: 0 8px 8px 0;
            color: #6b7280;
            font-size: 13px;
            white-space: nowrap;
            font-weight: 500;
            min-width: 65px;
            text-align: center;
            min-height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: static;
            transform: none;
        }

        .project-info-display {
            padding: 10px;
            background-color: #f9fafb;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
            margin-top: 5px;
            height: 40px;
            display: flex;
            align-items: center;
        }

        .project-modal-footer {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            padding: 20px 24px;
            border-top: 1px solid #e2e8f0;
            margin-top: 32px;
            margin-bottom: -8px;
        }

        .project-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .project-btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border-color: #3b82f6;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }

        .project-btn-primary:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            border-color: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
        }

        .project-btn-secondary {
            background: white;
            color: #374151;
            border-color: #d1d5db;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .project-btn-secondary:hover {
            background: #f9fafb;
            border-color: #9ca3af;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .project-btn-danger {
            color: #ef4444;
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            border-color: #fca5a5;
        }

        .project-btn-danger:hover {
            background: linear-gradient(135deg, #fecaca, #f87171);
            border-color: #ef4444;
            color: white;
        }

        /* 内容框架 */
        .content-frame {
            flex: 1;
            border: none;
            width: 100%;
            height: calc(100vh - 50px);
            background: #ffffff;
            border-radius: 0 0 0 20px;
            box-shadow: inset 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        /* 响应式设计 - 移动设备适配 */
        @media (max-width: 768px) {
            /* 侧边栏改为底部栏 */
            .sidebar {
                width: 100%;
                height: 60px;
                flex-direction: row;
                padding: 8px 0;
                top: auto;
                bottom: 0;
                justify-content: space-around;
                border-right: none;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
                box-shadow: 0 -8px 30px rgba(102, 126, 234, 0.3);
            }

            .sidebar-item {
                margin: 0;
                padding: 8px 0;
                width: 50px;
                height: 44px;
            }

            .sidebar-item:hover {
                transform: scale(1.05) translateY(-1px);
            }

            .sidebar-item.active::before {
                left: 50%;
                top: -2px;
                transform: translateX(-50%);
                width: 30px;
                height: 4px;
                background: linear-gradient(to right, #ffffff, #38bdf8);
            }

            .sidebar-icon {
                font-size: 18px;
                margin-bottom: 1px;
            }

            .sidebar-text {
                font-size: 10px;
                letter-spacing: 0.3px;
            }

            /* 主内容区域调整 */
            .main-content {
                margin-left: 0;
                margin-bottom: 60px;
                border-radius: 0;
                min-height: calc(100vh - 60px);
            }

            .content-frame {
                height: calc(100vh - 110px);
                border-radius: 0;
            }

            /* 顶部栏调整 */
            .header {
                padding: 12px 20px;
                height: 44px;
            }

            .header-title {
                font-size: 18px;
                max-width: 50vw;
            }

            .back-button {
                padding: 6px 12px;
                font-size: 12px;
            }

            .back-icon {
                font-size: 14px;
            }

            /* 用户信息区域调整 */
            .user-info {
                padding: 6px 12px;
                margin-left: 8px;
            }

            .user-name {
                font-size: 13px;
                margin-right: 8px;
            }

            .avatar {
                width: 32px;
                height: 32px;
                font-size: 12px;
            }

            /* 加载指示器调整 */
            .loading-indicator {
                height: calc(100vh - 60px);
            }

            .loading-indicator div {
                font-size: 36px;
            }

            /* 弹窗调整 */
            .confirm-box {
                width: 90%;
                max-width: 300px;
                padding: 24px;
            }

            .project-modal {
                width: 95%;
                max-width: 280px;
                padding: 20px;
            }
        }

        /* 计算器模态框样式 */
        .calculator-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: transparent;
            pointer-events: none; /* 允许点击穿透 */
            display: none; /* 改为默认不显示 */
            /* 移除flex布局，以便子元素可以absolute定位 */
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .calculator-modal-overlay.active {
            display: block; /* 激活时显示 */
            opacity: 1;
            visibility: visible;
        }

        .calculator-frame-container {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%); /* 初始居中，之后由JS控制left/top */
            width: auto;
            height: auto;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            background: #222; /* 添加背景色，避免头部透明 */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            pointer-events: auto; /* 恢复点击 */
        }
        
        /* 拖拽时移除 transform，改用 top/left 控制位置 */
        .calculator-frame-container.dragging {
            transform: none;
            /* 此时 left 和 top 会由 JS 设置为具体像素值 */
        }

        .calculator-header {
            height: 40px;
            background: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            cursor: move;
            border-bottom: 1px solid #444;
        }
        
        .calculator-title {
            color: #fff;
            font-size: 14px;
            font-weight: 500;
            user-select: none;
        }

        .calculator-close-btn-header {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #ff5f57; /* Mac风格关闭按钮 */
            border: none;
            color: #000; /* 始终显示黑色X */
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .calculator-close-btn-header:hover {
            color: #000;
            background: #ff5f57;
        }
        
        .calculator-close-btn-header::before {
            content: '×';
        }

        @media (max-width: 768px) {
            /* 
             * 移动端强制重置样式 
             */
            .calculator-modal-overlay {
                display: flex !important; /* 改回 flex 居中 */
                justify-content: center;
                align-items: center;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                background: rgba(0, 0, 0, 0.6) !important; /* 恢复半透明遮罩 */
                z-index: 9999 !important;
                padding: 0 !important;
                margin: 0 !important;
                overflow: hidden !important;
            }

            /* 容器变为悬浮卡片样式 */
            .calculator-frame-container {
                width: 80% !important; /* 比屏幕窄 */
                height: 95% !important; /* 上下留空 */
                position: relative !important;
                left: auto !important;
                top: auto !important;
                transform: none !important;
                background: #222 !important; /* 恢复背景色 */
                box-shadow: 0 10px 30px rgba(0,0,0,0.5) !important;
                display: flex !important;
                flex-direction: column !important;
                padding-bottom: env(safe-area-inset-bottom);
                border-radius: 24px !important; /* 大圆角 */
                overflow: hidden !important;
            }
            
            .calculator-header {
                flex: 0 0 50px; 
                display: flex;
                align-items: center;
                justify-content: space-between;
                background: #333;
                padding-top: 0; 
                padding-left: 15px;
                padding-right: 15px;
                box-sizing: border-box; 
                z-index: 10;
            }
            
            #calculatorFrame {
                flex: 1 1 0% !important; 
                width: 100% !important;
                height: 100% !important; 
                border: none !important;
                display: block !important;
                overflow-y: auto !important; 
                -webkit-overflow-scrolling: touch;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    
    <!-- 左侧导航栏 -->
    <div class="sidebar">
        <div class="sidebar-item active" onclick="navigateTo('项目列表.html', this)">
            <div class="sidebar-icon"><i class="fas fa-layer-group"></i></div>
            <div class="sidebar-text">项目</div>
        </div>
        <div class="sidebar-item" onclick="navigateTo('员工录入.html', this)">
            <div class="sidebar-icon"><i class="fas fa-address-book"></i></div>
            <div class="sidebar-text">通讯录</div>
        </div>
        <div class="sidebar-item" onclick="navigateTo('统计.html', this)">
            <div class="sidebar-icon"><i class="fas fa-chart-pie"></i></div>
            <div class="sidebar-text">统计</div>
        </div>
        <div class="sidebar-item" onclick="navigateTo('未结.html', this)">
            <div class="sidebar-icon" style="position: relative;">
                <i class="fas fa-file-invoice-dollar"></i>
                <i class="fas fa-clock" style="position: absolute; bottom: -2px; right: -5px; font-size: 0.6em; background: inherit; border-radius: 50%;"></i>
            </div>
            <div class="sidebar-text">未结</div>
        </div>
        <div class="sidebar-item" onclick="toggleCalculatorModal()">
            <div class="sidebar-icon"><i class="fas fa-calculator"></i></div>
            <div class="sidebar-text">计算器</div>
        </div>
    </div>

    <!-- 主内容区域 -->
    <div class="main-content">
        <!-- 顶部栏 -->
        <div class="header">
            <div class="header-left" style="display:flex;align-items:center;gap:8px;min-width:0;">
                <button class="back-button" id="backButton" onclick="goBack()" title="返回上一页">
                    <span class="back-icon">◀</span>
                    <span>返回</span>
                </button>
                <div class="header-title" id="headerProjectTitle" title="飞鱼记工">飞鱼记工</div>
            </div>
            <div class="user-info" onclick="toggleLogoutModal()">
                <div class="user-name" id="currentUserName">加载中...</div>
                <div class="avatar" id="userAvatar">?</div>
                <!-- 退出登录弹窗 -->
                <div class="logout-modal" id="logoutModal">
                    <button class="logout-btn" onclick="openChangePasswordModal()">修改密码</button>
                    <div style="height:1px; background: linear-gradient(90deg, transparent, #e5e7eb, transparent); margin: 8px 15%;"></div>
                    <button class="logout-btn" onclick="showConfirmDialog()">退出登录</button>
                </div>
            </div>
            <!-- 历史记录下拉菜单 -->
            <div class="history-dropdown" id="historyDropdown">
                <div class="history-dropdown-header">浏览历史</div>
                <div id="historyList"></div>
            </div>
        </div>

        <!-- 加载状态指示器 -->
        <div class="loading-indicator" id="loadingIndicator" style="
            display: flex;
            justify-content: center;
            align-items: center;
            height: calc(100vh - 50px);
            background: rgba(255, 255, 255, 0.9);
            position: absolute;
            top: 50px;
            left: 0;
            right: 0;
            z-index: 100;
            font-size: 18px;
            color: #667eea;
            font-weight: 600;
        ">
            <div style="text-align: center;">
                <div style="font-size: 48px; margin-bottom: 16px; animation: spin 1s linear infinite;">⏳</div>
                <div>数据加载中，请稍后...</div>
            </div>
        </div>

        <!-- 内容框架 -->
        <iframe class="content-frame" id="contentFrame" src="" frameborder="0"></iframe>
    </div>
    
    <!-- 确认退出弹窗 -->
    <div class="confirm-overlay" id="confirmDialog">
      <div class="confirm-box">
        <div class="confirm-content">
          <h3><div class="warning-icon">⚠</div>温馨提示</h3>
          <p>确认要退出吗？</p>
        </div>
        <div class="confirm-actions">
          <button class="confirm-btn confirm-cancel" onclick="closeConfirmDialog()">取消</button>
          <button class="confirm-btn confirm-ok" onclick="logout()">确认退出</button>
        </div>
      </div>
    </div>
    
    <!-- 修改密码模态框 -->
    <div class="project-modal-overlay" id="changePasswordModal">
        <div class="project-modal">
            <div class="project-modal-header">
                <h2 class="project-modal-title">修改密码</h2>
                <button class="project-modal-close" onclick="closeChangePasswordModal()">&times;</button>
            </div>
            <div class="project-modal-body">
                <div class="project-form-group">
                    <label for="currentPassword">旧密码</label>
                    <input type="password" id="currentPassword" placeholder="请输入旧密码">
                </div>
                <div class="project-form-group">
                    <label for="newPassword">新密码</label>
                    <input type="password" id="newPassword" placeholder="请输入新密码（至少6位）">
                </div>
                <div class="project-form-group">
                    <label for="confirmPassword">确认新密码</label>
                    <input type="password" id="confirmPassword" placeholder="请再次输入新密码">
                </div>
            </div>
            <div class="project-modal-footer">
                <button class="project-btn project-btn-secondary" onclick="closeChangePasswordModal()">取消</button>
                <button class="project-btn project-btn-primary" onclick="changePassword()">确认修改</button>
            </div>
        </div>
    </div>

    <!-- 实时订阅服务 -->
    <script src="JavaScript/实时订阅/realtime-sync-service.js"></script>
    <!-- 引入首页主功能文件 -->
    <script src="./JavaScript/首页/home-main.js"></script>
    
    <!-- 计算器模态框 -->
    <div class="calculator-modal-overlay" id="calculatorModal" onclick="closeCalculatorModal(event)">
        <div class="calculator-frame-container" id="calculatorContainer">
            <div class="calculator-header" id="calculatorHeader">
                <span class="calculator-title">计算器</span>
                <button class="calculator-close-btn-header" onclick="toggleCalculatorModal()"></button>
            </div>
            <iframe id="calculatorFrame" src="" style="width: 700px; height: 710px; border: none; background: transparent; max-width: 95vw; max-height: calc(95vh - 40px);"></iframe>
        </div>
    </div>

    <script>
        // 计算器模态框控制
        function toggleCalculatorModal() {
            const modal = document.getElementById('calculatorModal');
            const frame = document.getElementById('calculatorFrame');
            const container = document.getElementById('calculatorContainer');
            
            if (modal.classList.contains('active')) {
                modal.classList.remove('active');
            } else {
                // 每次打开都重新加载，确保状态重置
                frame.src = '计算器.html';
                modal.classList.add('active');
                
                // 重置位置到居中
                container.style.left = '50%';
                container.style.top = '50%';
                container.style.transform = 'translate(-50%, -50%)';
                container.classList.remove('dragging');
            }
        }

        function closeCalculatorModal(event) {
            // 点击遮罩层关闭
            if (event.target.id === 'calculatorModal') {
                const modal = document.getElementById('calculatorModal');
                modal.classList.remove('active');
            }
        }
        
        // 拖拽逻辑实现
        (function() {
            const container = document.getElementById('calculatorContainer');
            const header = document.getElementById('calculatorHeader');
            const iframe = document.getElementById('calculatorFrame');
            
            let isDragging = false;
            let startX, startY;
            let startLeft, startTop;
            
            // 鼠标按下事件
            header.addEventListener('mousedown', function(e) {
                // 如果是移动端或小屏幕，不启用拖拽
                if (window.innerWidth <= 768) return;
                
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                
                // 获取当前位置
                const rect = container.getBoundingClientRect();
                
                // 切换到绝对定位模式，取消transform居中
                // 必须在移除transform之前计算好left和top，使其视觉位置不变
                container.classList.add('dragging');
                
                // 设置当前的left和top为像素值
                container.style.left = rect.left + 'px';
                container.style.top = rect.top + 'px';
                // 移除transform
                container.style.transform = 'none';
                
                // 记录起始的left/top
                startLeft = rect.left;
                startTop = rect.top;
                
                // 给iframe添加pointer-events: none，防止拖拽过程中鼠标进入iframe导致事件丢失
                iframe.style.pointerEvents = 'none';
                
                // 添加全局移动和松开监听
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
                
                // 防止选中文本
                e.preventDefault();
            });
            
            function onMouseMove(e) {
                if (!isDragging) return;
                
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                container.style.left = (startLeft + dx) + 'px';
                container.style.top = (startTop + dy) + 'px';
            }
            
            function onMouseUp() {
                if (!isDragging) return;
                
                isDragging = false;
                
                // 恢复iframe交互
                iframe.style.pointerEvents = 'auto';
                
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }
        })();

        // ========== 页面导航历史记录管理 ==========
        const NavigationHistory = {
            history: [],
            currentIndex: -1,
            maxHistory: 50, // 最大保存50条历史记录
            lastPage: '', // 记录上一次加载的页面
            isInitialLoad: true, // 标记是否为初始加载

            // 规范化页面路径（去掉参数和盘符路径）
            normalizePagePath: function(page) {
                if (!page) return '';

                // 提取文件名（去掉路径和参数）
                const fileName = page.split('/').pop().split('?')[0].split('#')[0];
                return fileName;
            },

            // 添加历史记录
            add: function(page, title, forceAdd = false) {
                // 规范化页面路径（去掉参数和盘符路径）
                const normalizedPage = this.normalizePagePath(page);
                const normalizedLastPage = this.normalizePagePath(this.lastPage);

                // 如果页面没有变化且不是强制添加，则不重复添加
                if (!forceAdd && normalizedPage === normalizedLastPage) {
                    return;
                }

                // 如果当前不是最新位置，先删除当前位置之后的所有记录
                if (this.currentIndex < this.history.length - 1) {
                    this.history = this.history.slice(0, this.currentIndex + 1);
                }

                // 添加新记录
                this.history.push({
                    page: page,
                    title: title || this.getPageTitle(page),
                    timestamp: Date.now()
                });

                // 如果超过最大记录数，删除最旧的记录
                if (this.history.length > this.maxHistory) {
                    this.history.shift();
                }

                // 更新当前索引和最后页面
                this.currentIndex = this.history.length - 1;
                this.lastPage = page;

                // 保存到本地存储
                this.saveToStorage();

                // 清除初始加载标记
                if (this.isInitialLoad) {
                    this.isInitialLoad = false;
                }

                // 更新返回按钮状态
                this.updateBackButton();
            },

            // 返回上一页
            back: function() {
                if (this.currentIndex > 0) {
                    this.currentIndex--;
                    const record = this.history[this.currentIndex];
                    this.loadPage(record.page, false); // false表示不重复添加历史记录
                    this.lastPage = record.page;
                    this.saveToStorage();
                    this.updateBackButton();
                    return true;
                }
                return false;
            },

            // 前进到下一页
            forward: function() {
                if (this.currentIndex < this.history.length - 1) {
                    this.currentIndex++;
                    const record = this.history[this.currentIndex];
                    this.loadPage(record.page, false);
                    this.lastPage = record.page;
                    this.saveToStorage();
                    this.updateBackButton();
                    return true;
                }
                return false;
            },

            // 加载页面
            loadPage: function(page, addToHistory = true) {
                const contentFrame = document.getElementById('contentFrame');
                if (contentFrame) {
                    contentFrame.src = page;
                    updateHeaderTitle(page);
                }
            },

            // 获取页面标题（从URL中提取项目名等信息）
            getPageTitle: function(page) {
                try {
                    // 解析URL参数
                    const url = new URL(page, window.location.href);
                    const params = new URLSearchParams(url.search);
                    const projectName = params.get('project_name');
                    const projectId = params.get('project_id');

                    // 获取文件名，确保只获取到.html部分，避免包含查询参数
                    const fileName = decodeURIComponent(page.split('?')[0].split('/').pop());

                    // 页面标题映射
                    const titleMap = {
                        '项目列表.html': '项目列表',
                        '记工.html': '记工',
                        '统计.html': '统计',
                        '员工录入.html': '员工录入',
                        '结算借支.html': '结算/借支',
                        '项目记账.html': '项目记账',
                        '项目主页.html': '项目主页',
                        '未结.html': '项目未结',
                        '记工表.html': '记工表',
                        '施工日志.html': '施工日志'
                    };

                    // 构建完整标题
                    let fullTitle = '';
                    
                    // 先确定页面基本标题
                    if (fileName.includes('结算借支.html')) {
                        fullTitle = titleMap['结算借支.html'];
                    } else if (fileName.includes('记工.html')) {
                        fullTitle = titleMap['记工.html'];
                    } else if (fileName.includes('项目主页.html')) {
                        fullTitle = titleMap['项目主页.html'];
                    } else if (fileName.includes('项目记账.html')) {
                        fullTitle = titleMap['项目记账.html'];
                    } else if (fileName.includes('统计.html')) {
                        fullTitle = titleMap['统计.html'];
                    } else if (fileName.includes('员工录入.html')) {
                        fullTitle = titleMap['员工录入.html'];
                    } else if (fileName.includes('项目列表.html')) {
                        fullTitle = titleMap['项目列表.html'];
                    } else if (fileName.includes('施工日志.html')) {
                        fullTitle = titleMap['施工日志.html'];
                    } else {
                        fullTitle = titleMap[fileName] || fileName;
                    }
                    
                    // 如果有项目名，添加到标题前面
                    if (projectName && projectName !== 'undefined' && projectName !== 'null' && projectName.trim() !== '') {
                        let displayProjectName = projectName;
                        try {
                            // 尝试解码，处理可能的URL编码字符串
                            if (projectName.includes('%')) {
                                displayProjectName = decodeURIComponent(projectName);
                            }
                        } catch (e) {
                            // 解码失败保持原样
                        }
                        fullTitle = `${displayProjectName} - ${fullTitle}`;
                    }
                    
                    // 如果有项目ID，添加到标题后面
                    if (projectId && projectId !== 'undefined' && projectId !== 'null' && projectId.trim() !== '') {
                        fullTitle = `${fullTitle} (${projectId})`;
                    }

                    return fullTitle;
                } catch (e) {
                    // 如果URL解析失败，返回简单的文件名
                    try {
                        const decodedPage = decodeURIComponent(page);
                        return decodedPage.split('/').pop().split('?')[0];
                    } catch (e2) {
                        return page.split('/').pop().split('?')[0];
                    }
                }
            },

            // 保存到本地存储
            saveToStorage: function() {
                try {
                    const data = {
                        history: this.history,
                        currentIndex: this.currentIndex,
                        lastPage: this.lastPage
                    };
                    localStorage.setItem('navigationHistory', JSON.stringify(data));
                } catch (e) {
                    console.warn('保存历史记录失败:', e);
                }
            },

            // 从本地存储加载
            loadFromStorage: function() {
                try {
                    const data = localStorage.getItem('navigationHistory');
                    if (data) {
                        const parsed = JSON.parse(data);
                        this.history = parsed.history || [];
                        this.currentIndex = parsed.currentIndex || -1;
                        this.lastPage = parsed.lastPage || '';
                        this.updateBackButton();
                    }
                } catch (e) {
                    console.warn('加载历史记录失败:', e);
                    this.history = [];
                    this.currentIndex = -1;
                    this.lastPage = '';
                }
            },

            // 清除历史记录
            clear: function() {
                this.history = [];
                this.currentIndex = -1;
                this.lastPage = '';
                this.isInitialLoad = true; // 重置初始加载标记
                localStorage.removeItem('navigationHistory');
                this.updateBackButton();
            },

            // 更新返回按钮状态
            updateBackButton: function() {
                const backButton = document.getElementById('backButton');
                if (backButton) {
                    // 只要有历史记录就激活返回按钮
                    if (this.history.length > 0 && this.currentIndex > 0) {
                        backButton.classList.add('enabled');
                        const prevRecord = this.history[this.currentIndex - 1];
                        backButton.title = `返回: ${prevRecord?.title || '上一页'}`;
                    } else {
                        backButton.classList.remove('enabled');
                        backButton.title = '没有可返回的页面';
                    }
                }
            },

            // 显示历史记录下拉菜单
            showHistoryDropdown: function() {
                const dropdown = document.getElementById('historyDropdown');
                const historyList = document.getElementById('historyList');
                if (!dropdown || !historyList) return;

                // 清空现有列表
                historyList.innerHTML = '';

                if (this.history.length === 0) {
                    historyList.innerHTML = '<div class="history-item" style="justify-content:center;color:#94a3b8;">暂无历史记录</div>';
                } else {
                    // 生成历史记录列表（倒序显示，最新的在上面）
                    this.history.slice().reverse().forEach((record, index) => {
                        const originalIndex = this.history.length - 1 - index;
                        const item = document.createElement('div');
                        item.className = `history-item ${originalIndex === this.currentIndex ? 'current' : ''}`;
                        item.innerHTML = `
                            <span class="history-item-icon">${originalIndex === this.currentIndex ? '●' : '○'}</span>
                            <span class="history-item-text">${record.title}</span>
                        `;
                        item.onclick = () => {
                            this.jumpTo(originalIndex);
                            this.hideHistoryDropdown();
                        };
                        historyList.appendChild(item);
                    });
                }

                // 显示下拉菜单
                dropdown.classList.add('active');

                // 点击其他地方关闭下拉菜单
                const closeHandler = (e) => {
                    if (!dropdown.contains(e.target) && e.target.id !== 'backButton') {
                        this.hideHistoryDropdown();
                        document.removeEventListener('click', closeHandler);
                    }
                };
                setTimeout(() => {
                    document.addEventListener('click', closeHandler);
                }, 0);
            },

            // 隐藏历史记录下拉菜单
            hideHistoryDropdown: function() {
                const dropdown = document.getElementById('historyDropdown');
                if (dropdown) {
                    dropdown.classList.remove('active');
                }
            },

            // 跳转到指定历史记录
            jumpTo: function(index) {
                if (index >= 0 && index < this.history.length) {
                    this.currentIndex = index;
                    const record = this.history[index];
                    this.loadPage(record.page, false);
                    this.lastPage = record.page;
                    this.saveToStorage();
                    this.updateBackButton();
                }
            },

            // 获取当前历史记录
            getCurrent: function() {
                return this.currentIndex >= 0 ? this.history[this.currentIndex] : null;
            },

            // 处理iframe页面加载事件
            handleIframeLoad: function(page) {
                this.add(page, null, false);
            }
        };

        // 导航切换函数
        function navigateTo(page, element) {
            // 移除所有active类
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });

            // 添加active类到当前点击的元素（仅当element存在时）
            if (element && element.classList) {
                element.classList.add('active');
            }

            // 如果点击的是项目按钮，清除历史记录并恢复默认标题
            if (page === '项目列表.html') {
                setProjectTitle(''); // 清除项目名，恢复为默认标题
                NavigationHistory.clear(); // 清除历史记录，重新开始
            }

            // 获取页面标题
            const title = getPageTitleFromSidebar(page, element) || NavigationHistory.getPageTitle(page);

            // 添加到历史记录（强制添加侧边栏导航）
            NavigationHistory.add(page, title, true);

            // 更新iframe的src
            const contentFrame = document.getElementById('contentFrame');
            if (contentFrame) {
                contentFrame.src = page;
            }

            // 隐藏加载指示器
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }

            // 更新标题
            updateHeaderTitle(page);
        }

        // 从侧边栏获取页面标题
        function getPageTitleFromSidebar(page, element) {
            // 特殊处理员工录入和统计页面，确保标题正确
            if (page === '员工录入.html') {
                return '员工录入';
            } else if (page === '统计.html') {
                return '统计';
            }
            
            if (element) {
                const sidebarText = element.querySelector('.sidebar-text');
                if (sidebarText) {
                    return sidebarText.textContent;
                }
            }
            return null;
        }

        // 返回上一页
        function goBack() {
            const success = NavigationHistory.back();
            if (!success) {
                showNotification('没有可返回的页面', true);
            }
        }

        // 页面加载时初始化历史记录
        document.addEventListener('DOMContentLoaded', function() {
            // 清除可能存在的旧历史记录，确保初始状态干净
            NavigationHistory.clear();

            // 监听iframe的load事件来捕获页面跳转
            const contentFrame = document.getElementById('contentFrame');
            if (contentFrame) {
                // 使用load事件监听iframe内容变化
                contentFrame.addEventListener('load', function() {
                    try {
                        // 如果系统还没准备好，不处理iframe加载
                        if (!NavigationHistory.isReady) {
                            return;
                        }

                        // 获取iframe的当前URL
                        const currentUrl = contentFrame.contentWindow.location.href;

                        // 提取相对路径
                        let pagePath = currentUrl;

                        // 解码URL以处理URL编码
                        try {
                            const decodedUrl = decodeURIComponent(currentUrl);

                            if (decodedUrl.includes('项目列表.html')) {
                                pagePath = '项目列表.html';
                            } else if (decodedUrl.includes('项目主页.html')) {
                                const match = decodedUrl.match(/.*项目主页\.html\?.*/);
                                pagePath = match ? match[0] : '项目主页.html';
                            } else if (decodedUrl.includes('记工.html')) {
                                const match = decodedUrl.match(/.*记工\.html\?.*/);
                                pagePath = match ? match[0] : '记工.html';
                            } else if (decodedUrl.includes('统计.html')) {
                                const match = decodedUrl.match(/.*统计\.html\?.*/);
                                pagePath = match ? match[0] : '统计.html';
                            } else if (decodedUrl.includes('员工录入.html')) {
                                const match = decodedUrl.match(/.*员工录入\.html\?.*/);
                                pagePath = match ? match[0] : '员工录入.html';
                            } else if (decodedUrl.includes('结算借支.html')) {
                                const match = decodedUrl.match(/.*结算借支\.html\?.*/);
                                pagePath = match ? match[0] : '结算借支.html';
                            } else                             if (decodedUrl.includes('项目记账.html')) {
                                const match = decodedUrl.match(/.*项目记账\.html\?.*/);
                                pagePath = match ? match[0] : '项目记账.html';
                            } else if (decodedUrl.includes('未结.html')) {
                                const match = decodedUrl.match(/.*未结\.html\?.*/);
                                pagePath = match ? match[0] : '未结.html';
                            } else if (decodedUrl.includes('记工表.html')) {
                                const match = decodedUrl.match(/.*记工表\.html\?.*/);
                                pagePath = match ? match[0] : '记工表.html';
                            }
                        } catch (decodeError) {
                            // 如果解码失败，使用原始URL
                            if (currentUrl.includes('项目列表.html')) {
                                pagePath = '项目列表.html';
                            } else if (currentUrl.includes('项目主页.html')) {
                                const match = currentUrl.match(/.*项目主页\.html\?.*/);
                                pagePath = match ? match[0] : currentUrl;
                            } else if (currentUrl.includes('记工.html')) {
                                const match = currentUrl.match(/.*记工\.html\?.*/);
                                pagePath = match ? match[0] : currentUrl;
                            } else if (currentUrl.includes('统计.html')) {
                                const match = currentUrl.match(/.*统计\.html\?.*/);
                                pagePath = match ? match[0] : currentUrl;
                            } else if (currentUrl.includes('员工录入.html')) {
                                const match = currentUrl.match(/.*员工录入\.html\?.*/);
                                pagePath = match ? match[0] : currentUrl;
                            } else if (currentUrl.includes('结算借支.html')) {
                                const match = currentUrl.match(/.*结算借支\.html\?.*/);
                                pagePath = match ? match[0] : currentUrl;
                            } else                             if (currentUrl.includes('项目记账.html')) {
                                const match = currentUrl.match(/.*项目记账\.html\?.*/);
                                pagePath = match ? match[0] : currentUrl;
                            } else if (currentUrl.includes('未结.html')) {
                                const match = currentUrl.match(/.*未结\.html\?.*/);
                                pagePath = match ? match[0] : currentUrl;
                            } else if (currentUrl.includes('记工表.html')) {
                                const match = currentUrl.match(/.*记工表\.html\?.*/);
                                pagePath = match ? match[0] : currentUrl;
                            }
                        }

                        // 只处理同源的页面
                        if (pagePath && pagePath !== 'about:blank' && pagePath !== window.location.href) {
                            NavigationHistory.handleIframeLoad(pagePath);
                        }
                    } catch (e) {
                        // 跨域访问失败，静默处理
                    }
                });
            }

            // 恢复最后一次访问的页面
            const currentRecord = NavigationHistory.getCurrent();
            if (currentRecord) {
                if (contentFrame && (contentFrame.src === '' || contentFrame.src === 'about:blank')) {
                    contentFrame.src = currentRecord.page;
                    updateHeaderTitle(currentRecord.page);
                    NavigationHistory.lastPage = currentRecord.page;
                }
            }

            // 延迟500毫秒后标记系统为准备好，确保初始加载完成
            setTimeout(() => {
                NavigationHistory.isReady = true;

                // 手动添加项目列表作为第一条历史记录（不会激活返回按钮）
                NavigationHistory.add('项目列表.html', '项目列表', false);
            }, 500);

            // 为返回按钮添加右键菜单事件
            const backButton = document.getElementById('backButton');
            if (backButton) {
                backButton.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    NavigationHistory.showHistoryDropdown();
                });

                // 为返回按钮添加长按事件（移动端）
                let longPressTimer;
                backButton.addEventListener('mousedown', function() {
                    longPressTimer = setTimeout(() => {
                        NavigationHistory.showHistoryDropdown();
                    }, 500);
                });

                backButton.addEventListener('mouseup', function() {
                    clearTimeout(longPressTimer);
                });

                backButton.addEventListener('mouseleave', function() {
                    clearTimeout(longPressTimer);
                });

                // 触摸事件支持
                backButton.addEventListener('touchstart', function() {
                    longPressTimer = setTimeout(() => {
                        NavigationHistory.showHistoryDropdown();
                    }, 500);
                });

                backButton.addEventListener('touchend', function() {
                    clearTimeout(longPressTimer);
                });
            }
        });

        // 更新标题函数（非项目主页场景使用）
        function updateHeaderTitle(page) {
            const headerTitle = document.querySelector('.header-title');
            
            // 获取纯文件名用于判断
            let pageName = page;
            try {
                // 如果是完整URL，先获取路径部分
                let urlPath = page;
                if (page.includes('://')) {
                    try {
                        urlPath = new URL(page).pathname;
                    } catch(e) { urlPath = page; }
                }
                // 提取文件名（去掉路径和参数）
                pageName = urlPath.split('/').pop().split('?')[0].split('#')[0];
                // 解码
                pageName = decodeURIComponent(pageName);
            } catch (e) {
                // 保持原值
            }

            // 解析URL参数获取project_id
            let projectId = null;
            try {
                // 检查page是否包含完整URL或只有文件名
                let urlToParse = page;
                if (!urlToParse.includes('://') && !urlToParse.startsWith('/')) {
                    // 如果只有文件名，构建完整URL
                    urlToParse = new URL(page, window.location.href).href;
                }
                const url = new URL(urlToParse);
                const params = new URLSearchParams(url.search);
                projectId = params.get('project_id');
            } catch (e) {
                // URL解析失败，忽略
            }
            
            let titleText = '';
            let titleAttr = '';

            if (pageName === '项目列表.html' || page === '项目列表.html') {
                titleText = '飞鱼记工';
                titleAttr = '飞鱼记工';
                // 清除当前项目名称，因为已经回到了列表页
                localStorage.removeItem('currentProjectName');
            } else if (pageName === '记工.html' || page === '记工.html') {
                titleText = '记工';
                titleAttr = '记工';
            } else if (pageName === '统计.html' || page === '统计.html') {
                titleText = '统计';
                titleAttr = '统计';
            } else if (pageName === '记工流水' || page === '记工流水') {
                titleText = '记工流水';
                titleAttr = '记工流水';
            } else if (pageName === '流水明细' || page === '流水明细') {
                titleText = '流水明细';
                titleAttr = '流水明细';
            } else if (pageName === '员工录入.html' || page === '员工录入.html') {
                titleText = '员工录入';
                titleAttr = '员工录入';
            } else if (pageName === '未结.html' || page === '未结.html') {
                titleText = '项目未结';
                titleAttr = '项目未结';
            } else if (pageName === '结算借支.html' || page === '结算借支.html') {
                titleText = '结算/借支';
                titleAttr = '结算/借支';
            } else if (pageName === '结算/借支' || page === '结算/借支') {
                titleText = '结算/借支';
                titleAttr = '结算/借支';
            } else if (pageName === '当日流水' || page === '当日流水') {
                titleText = '当日流水';
                titleAttr = '当日流水';
            } else if (pageName === '修改点工' || page === '修改点工') {
                titleText = '修改点工';
                titleAttr = '修改点工';
            } else if (pageName === '修改包工' || page === '修改包工') {
                titleText = '修改包工';
                titleAttr = '修改包工';
            } else if (pageName === '修改工量' || page === '修改工量') {
                titleText = '修改工量';
                titleAttr = '修改工量';
            } else if (pageName === '修改借支' || page === '修改借支') {
                titleText = '修改借支';
                titleAttr = '修改借支';
            } else if (pageName === '修改扣款' || page === '修改扣款') {
                titleText = '修改扣款';
                titleAttr = '修改扣款';
            } else if (pageName === '修改公司转账' || page === '修改公司转账') {
                titleText = '修改公司转账';
                titleAttr = '修改公司转账';
            } else if (pageName === '修改结算' || page === '修改结算') {
                titleText = '修改结算';
                titleAttr = '修改结算';
            } else if (pageName === '修改支出' || page === '修改支出') {
                titleText = '修改支出';
                titleAttr = '修改支出';
            } else if (pageName === '修改收入' || page === '修改收入') {
                titleText = '修改收入';
                titleAttr = '修改收入';
            } else if (pageName === '带班设置.html' || page === '带班设置.html' || pageName === '带班设置' || page === '带班设置') {
                titleText = '带班设置';
                titleAttr = '带班设置';
            } else if (pageName === '项目记账.html' || page === '项目记账.html' || page === '项目记账') {
                titleText = '项目记账';
                titleAttr = '项目记账';
            } else if (pageName === '记工表.html' || page === '记工表.html' || page === '记工表') {
                titleText = '记工表';
                titleAttr = '记工表';
            } else if (pageName === '点工单.html' || page === '点工单.html' || page === '点工单') {
                titleText = '点工单';
                titleAttr = '点工单';
            } else if (pageName === '云相册.html' || page === '云相册.html' || page === '云相册') {
                titleText = '云相册';
                titleAttr = '云相册';
            } else if (pageName === '施工日志.html' || page === '施工日志.html' || page === '施工日志') {
                titleText = '施工日志';
                titleAttr = '施工日志';
            } else {
                // 其他页面优先显示已选择的项目名，否则回退默认
                const saved = localStorage.getItem('currentProjectName');
                const title = saved && saved.trim() ? saved.trim() : '飞鱼记工';
                titleText = title;
                titleAttr = title;
            }
            
            // 如果有项目ID，添加到标题后面
            // 特殊处理：记工表页面不显示项目ID
            const isTimesheetPage = (pageName === '记工表.html' || page === '记工表.html' || page === '记工表');
            
            if (projectId && projectId !== 'undefined' && projectId !== 'null' && !isTimesheetPage) {
                titleText = `${titleText} (${projectId})`;
                titleAttr = `${titleAttr} (${projectId})`;
            }
            
            headerTitle.textContent = titleText;
            headerTitle.setAttribute('title', titleAttr);
        }
        
        // 根据完整标题直接更新页面标题
        function updateHeaderTitleFromTitle(title) {
            const headerTitle = document.querySelector('.header-title');
            if (headerTitle) {
                headerTitle.textContent = title;
                headerTitle.setAttribute('title', title);
            }
        }
        
        // 设置项目标题函数，只使用新字段
        function setProjectTitle(projectName) {
            const headerTitle = document.querySelector('.header-title');
            // 支持传入项目对象或直接传入名称字符串
            const name = typeof projectName === 'object' 
                ? (projectName.project_name || '') 
                : (projectName || '');
            const title = (name && name.trim()) ? name.trim() : '飞鱼记工';
            if (headerTitle) {
                headerTitle.textContent = title;
                headerTitle.setAttribute('title', title);
            }
            if (name && name.trim()) {
                localStorage.setItem('currentProjectName', title);
            } else {
                localStorage.removeItem('currentProjectName');
            }
        }
        
        // 页面加载时从localStorage检查并更新标题
document.addEventListener('DOMContentLoaded', function() {
    const savedProjectName = localStorage.getItem('currentProjectName');
    if (savedProjectName && savedProjectName.trim()) {
        setProjectTitle(savedProjectName);
    }
});
        
        // 切换退出登录弹窗
        function toggleLogoutModal() {
            const logoutModal = document.getElementById('logoutModal');
            logoutModal.classList.toggle('active');
        }
        
        // 确保函数在全局作用域中可用
        window.toggleLogoutModal = toggleLogoutModal;
        
        // 显示确认对话框
        function showConfirmDialog() {
            document.getElementById('confirmDialog').style.display = 'flex';
        }
        
        // 关闭确认对话框
        function closeConfirmDialog() {
            document.getElementById('confirmDialog').style.display = 'none';
        }
        
        // 退出登录
        function logout() {
            // 清除用户信息
            localStorage.removeItem('currentUser');
            localStorage.removeItem('loggedInPhone');
            
            // 跳转到登录页面
            window.location.href = '登录注册.html';
        }
        
        // 打开修改密码模态框
        function openChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.add('active');
        }
        
        // 关闭修改密码模态框
        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.remove('active');
        }
        
        // 修改密码函数
        async function changePassword() {
            console.log('[密码修改] 开始修改密码流程');
            
            try {
                // 获取输入值
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                console.log('[密码修改] 获取到表单数据');
                
                // 验证表单
                if (!currentPassword) {
                    showNotification('请输入当前密码', true);
                    return;
                }
                
                if (!newPassword || newPassword.length < 6) {
                    showNotification('新密码至少需要6位', true);
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    showNotification('两次输入的新密码不一致', true);
                    return;
                }
                
                // 获取当前用户信息
                const currentUser = localStorage.getItem('currentUser');
                if (!currentUser) {
                    showNotification('获取用户信息失败，请重新登录', true);
                    window.redirectToLogin();
                    return;
                }
                
                const userData = JSON.parse(currentUser);
                
                // 从用户数据中获取user_id作为查询条件
                const userId = userData.user_id;
                
                if (!userId) {
                    console.error('[密码修改] 用户信息中缺少user_id');
                    showNotification('获取用户标识失败，请重新登录', true);
                    window.redirectToLogin();
                    return;
                }
                
                // 只使用Supabase验证旧密码
                if (window.supabase && typeof window.supabase.from === 'function') {
                    try {
                        // 查询用户的密码进行验证
                        const { data: userFromDb, error: queryError } = await window.supabase
                            .from('users')
                            .select('password')
                            .eq('user_id', userId)
                            .single();
                        
                        if (queryError) {
                            console.error('[密码修改] Supabase查询用户密码失败:', queryError);
                            showNotification('验证旧密码失败，用户不存在或系统错误', true);
                            return;
                        }
                        
                        // 处理可能是数组的返回数据，获取第一个元素（参考登录逻辑）
                        const userInfo = Array.isArray(userFromDb) && userFromDb.length > 0 ? userFromDb[0] : userFromDb;
                        
                        // 安全比较密码，去除可能的空格并确保字段存在
                        const dbPassword = userInfo?.password ? String(userInfo.password).trim() : '';
                        const inputPassword = String(currentPassword).trim();
                        
                        // 验证旧密码
                        if (userInfo && dbPassword === inputPassword) {
                            console.log('[密码修改] Supabase验证旧密码成功');
                            
                            try {
                                // 验证通过，更新密码
                                // 创建北京时间（UTC+8）的时间戳
                                const now = new Date();
                                const beijingTime = new Date(now.getTime() + 8 * 60 * 60 * 1000); // UTC+8
                                
                                const { error: updateError } = await window.supabase
                                    .from('users')
                                    .update({ 
                                        password: newPassword,
                                        updated_at: beijingTime.toISOString() // 使用统一的updated_at字段
                                    })
                                    .eq('user_id', userId);
                                
                                if (updateError) {
                                    console.error('[密码修改] Supabase更新密码失败:', updateError);
                                    showNotification('密码修改失败，请联系管理员', true);
                                } else {
                                    console.log('[密码修改] Supabase密码更新成功');
                                    
                                    // 确保用户数据对象结构完整
                                    const formattedUserData = {
                                        ...userData,
                                        password: newPassword,
                                        updated_at: beijingTime.toISOString(),
                                        user_id: userId // 确保使用新的主键字段名
                                    };
                                    
                                    // 更新本地存储的用户信息
                                    localStorage.setItem('currentUser', JSON.stringify(formattedUserData));
                                    
                                    showNotification('密码修改成功！');
                                    closeChangePasswordModal();
                                    console.log('密码修改流程正常完成');
                                }
                            } catch (updateException) {
                                console.error('[密码修改] 更新密码过程中发生异常:', updateException);
                                showNotification('密码修改过程中发生异常，请稍后再试', true);
                            }
                        } else {
                            console.log('[密码修改] Supabase密码验证失败');
                            showNotification('旧密码不正确，请重新输入', true);
                        }
                    } catch (queryException) {
                        console.error('[密码修改] 查询密码过程中发生异常:', queryException);
                        showNotification('网络异常，无法验证密码，请检查网络连接', true);
                    }
                } else {
                    console.error('[密码修改] Supabase不可用或缺少用户标识');
                    showNotification('密码验证系统不可用，请稍后再试', true);
                }
            } catch (error) {
                console.error('[密码修改] 修改密码失败:', error);
                showNotification('修改密码失败，请重试', true);
            }
        }
        
        // 显示通知
        function showNotification(message, isError = false) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                padding: 16px 24px;
                background: ${isError ? '#ef4444' : '#10b981'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 9999;
                font-weight: 500;
                max-width: 300px;
                text-align: center;
                pointer-events: auto;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // 重定向到登录页面
        function redirectToLogin() {
            window.location.href = '登录注册.html';
        }
        
        // 实时订阅相关的页面间通信和刷新逻辑
        
        // 页面与数据类型的映射关系
        const PAGE_DATA_MAPPING = {
            'settlement_records': ['结算借支.html', '项目主页.html', '统计.html', '未结.html'],
            'attendance_records': ['记工.html', '项目主页.html', '统计.html', '未结.html'],
            'employees': ['员工录入.html', '项目主页.html', '统计.html', '未结.html'],
            'project_expenses': ['项目记账.html', '项目主页.html']
        };
        
        // 获取当前打开的iframe页面
        function getCurrentIframePage() {
            const contentFrame = document.getElementById('contentFrame');
            if (!contentFrame) return null;
            
            try {
                // 首先尝试从contentWindow.location获取实际URL
                // 这能反映iframe内部实际加载的页面，而不仅仅是初始src
                let currentUrl;
                if (contentFrame.contentWindow && contentFrame.contentWindow.location) {
                    currentUrl = contentFrame.contentWindow.location.href;
                } else {
                    // 如果无法访问contentWindow.location，使用src作为备选
                    currentUrl = contentFrame.src;
                }
                
                // 解码URL
                const decodedUrl = decodeURIComponent(currentUrl);
                
                // 提取页面名称和project_id参数
                const url = new URL(decodedUrl);
                const pageName = url.pathname.split('/').pop().split('?')[0];
                // 第一步：尝试从URL参数中获取项目ID
                let projectId = url.searchParams.get('project_id');
                if (!projectId) {
                    projectId = url.searchParams.get('projectId');
                }
                
                // 第二步：如果URL中没有项目ID，尝试从iframe内部获取当前选中的项目ID
                if (!projectId && contentFrame.contentWindow) {
                    try {
                        // 检查iframe中是否有选中的项目ID
                        const iframeDoc = contentFrame.contentDocument || contentFrame.contentWindow.document;
                        
                        // 查找项目选择下拉框
                        const projectSelect = iframeDoc.getElementById('project-name');
                        if (projectSelect && projectSelect.value) {
                            // 从下拉框中获取选中的项目ID
                            projectId = projectSelect.value;
                            console.log(`从iframe内部获取到项目ID: ${projectId}`);
                        } else {
                            // 尝试从iframe的全局变量中获取项目ID
                            if (contentFrame.contentWindow.selectedProjectId) {
                                projectId = contentFrame.contentWindow.selectedProjectId;
                                console.log(`从iframe全局变量获取到项目ID: ${projectId}`);
                            }
                        }
                    } catch (e) {
                        // 跨域访问可能失败，忽略此错误
                        console.warn('无法从iframe内部获取项目ID:', e);
                    }
                }
                
                // 如果有project_id，返回格式：页面名称_项目ID
                if (projectId) {
                    return `${pageName}_${projectId}`;
                }
                
                // 否则只返回页面名称
                return pageName;
            } catch (e) {
                console.warn('无法获取iframe页面名称:', e);
                // 作为最后的备选，使用src属性
                try {
                    const src = contentFrame.src;
                    const decodedSrc = decodeURIComponent(src);
                    
                    // 提取页面名称和project_id参数
                    const url = new URL(decodedSrc);
                    const pageName = url.pathname.split('/').pop().split('?')[0];
                    // 第一步：尝试从URL参数中获取项目ID
                    let projectId = url.searchParams.get('project_id');
                    if (!projectId) {
                        projectId = url.searchParams.get('projectId');
                    }
                    
                    // 第二步：如果URL中没有项目ID，尝试从iframe内部获取当前选中的项目ID
                    if (!projectId && contentFrame.contentWindow) {
                        try {
                            // 检查iframe中是否有选中的项目ID
                            const iframeDoc = contentFrame.contentDocument || contentFrame.contentWindow.document;
                            
                            // 查找项目选择下拉框
                            const projectSelect = iframeDoc.getElementById('project-name');
                            if (projectSelect && projectSelect.value) {
                                // 从下拉框中获取选中的项目ID
                                projectId = projectSelect.value;
                                console.log(`从iframe内部获取到项目ID: ${projectId}`);
                            } else {
                                // 尝试从iframe的全局变量中获取项目ID
                                if (contentFrame.contentWindow.selectedProjectId) {
                                    projectId = contentFrame.contentWindow.selectedProjectId;
                                    console.log(`从iframe全局变量获取到项目ID: ${projectId}`);
                                }
                            }
                        } catch (e) {
                            // 跨域访问可能失败，忽略此错误
                            console.warn('无法从iframe内部获取项目ID:', e);
                        }
                    }
                    
                    // 如果有project_id，返回格式：页面名称_项目ID
                    if (projectId) {
                        return `${pageName}_${projectId}`;
                    }
                    
                    // 否则只返回页面名称
                    return pageName;
                } catch (e2) {
                    console.warn('使用src获取iframe页面名称也失败:', e2);
                    // 使用NavigationHistory.lastPage作为最后的备选方案
                    if (NavigationHistory && NavigationHistory.lastPage) {
                        try {
                            const lastPage = NavigationHistory.lastPage;
                            const decodedLastPage = decodeURIComponent(lastPage);
                            
                            // 提取页面名称和project_id参数
                            const url = new URL(decodedLastPage, window.location.origin);
                            const pageName = url.pathname.split('/').pop().split('?')[0];
                            // 尝试获取项目ID，支持两种命名格式：project_id（下划线）和projectId（驼峰）
                            let projectId = url.searchParams.get('project_id');
                            if (!projectId) {
                                projectId = url.searchParams.get('projectId');
                            }
                            
                            // 如果有project_id，返回格式：页面名称_项目ID
                            if (projectId) {
                                return `${pageName}_${projectId}`;
                            }
                            
                            // 否则只返回页面名称
                            return pageName;
                        } catch (e3) {
                            console.warn('使用NavigationHistory.lastPage获取页面名称也失败:', e3);
                        }
                    }
                    return null;
                }
            }
        }
        
        // 获取当前项目ID
        function getCurrentProjectId() {
            // 先尝试从localStorage获取currentProjectId（项目列表页面设置的键）
            const currentProjectId = localStorage.getItem('currentProjectId');
            if (currentProjectId) {
                return currentProjectId;
            }
            
            // 再尝试从localStorage获取currentProject对象
            const currentProject = localStorage.getItem('currentProject');
            if (currentProject) {
                try {
                    const project = JSON.parse(currentProject);
                    return project.project_id || project.id;
                } catch (e) {
                    console.warn('解析当前项目失败:', e);
                }
            }
            return null;
        }
        
        // 检查是否应该刷新当前页面
        function shouldRefreshCurrentPage(dataType, currentPage, projectId) {
            // 如果当前页面是项目列表，不刷新页面
            if (currentPage && (currentPage.includes('项目列表.html') || currentPage.includes('%E9%A1%B9%E7%9B%AE%E5%88%97%E8%A1%A8.html'))) {
                console.log('⏭️ 当前页面是项目列表，只接收数据不刷新');
                return false;
            }
            
            // 检查数据类型是否会影响当前页面
            const affectedPages = PAGE_DATA_MAPPING[dataType];
            if (!affectedPages || !currentPage) return false;
            
            // 首先获取并检查项目ID，这是最重要的判断条件
            let iframeProjectId = null;
            const contentFrame = document.getElementById('contentFrame');
            if (contentFrame) {
                try {
                    // 从iframe的URL参数中提取项目ID
                    let url;
                    if (contentFrame.contentWindow && contentFrame.contentWindow.location) {
                        url = contentFrame.contentWindow.location.href;
                    } else {
                        url = contentFrame.src;
                    }
                    
                    // 解码URL以处理URL编码
                    const decodedUrl = decodeURIComponent(url);
                    const urlParams = new URL(decodedUrl).searchParams;
                    // 尝试获取项目ID，支持两种命名格式：project_id（下划线）和projectId（驼峰）
                    iframeProjectId = urlParams.get('project_id');
                    if (!iframeProjectId) {
                        iframeProjectId = urlParams.get('projectId');
                    }
                } catch (e) {
                    console.warn('无法从iframe URL提取项目ID:', e);
                }
            }
            
            // 提取当前页面的项目ID（从返回的currentPage中）
            let currentPageProjectId = null;
            // 正则表达式修改为匹配从第一个下划线开始到字符串末尾的所有字符，因为页面名称不包含下划线
            const projectIdMatch = currentPage.match(/_(.+)$/);
            if (projectIdMatch) {
                currentPageProjectId = projectIdMatch[1];
            }
            
            // 检查项目ID是否匹配，优先使用iframe URL中的项目ID，其次使用currentPage中的项目ID
            const targetProjectId = iframeProjectId || currentPageProjectId;
            if (targetProjectId && targetProjectId !== projectId) {
                console.log(`⏭️ 项目ID不匹配（当前页面: ${targetProjectId}, 收到: ${projectId}），跳过刷新`);
                return false;
            }
            
            // 检查当前页面是否在受影响的页面列表中
            // 提取页面基本名称（移除_项目ID后缀）
            const basicPageName = currentPage.split('_')[0];
            
            // 解码currentPage以处理URL编码，确保正确匹配
            const decodedCurrentPage = decodeURIComponent(basicPageName);
            
            // 检查页面是否受影响
            const shouldRefresh = affectedPages.some(page => decodedCurrentPage.includes(page));
            if (!shouldRefresh) {
                console.log(`⏭️ 当前页面 ${currentPage} (解码: ${decodedCurrentPage}) 不受 ${dataType} 数据更新影响，跳过刷新`);
                return false;
            }
            
            return true;
        }
        
        // 向iframe发送刷新消息
        function sendRefreshMessage(iframe, dataType, projectId) {
            if (!iframe) return;
            
            try {
                // 根据数据类型发送不同的刷新指令
                let message;
                switch (dataType) {
                    case 'settlement_records':
                        message = { type: 'refreshSettlementData', projectId: projectId };
                        break;
                    case 'attendance_records':
                        message = { type: 'refreshAttendanceData', projectId: projectId };
                        break;
                    case 'employees':
                        message = { type: 'refreshEmployeeData', projectId: projectId };
                        break;
                    case 'project_expenses':
                        message = { type: 'refreshExpenseData', projectId: projectId };
                        break;
                    default:
                        message = { type: 'refreshData', projectId: projectId };
                        break;
                }
                
                const targetOrigin = window.location.origin || '*';
                iframe.contentWindow.postMessage(message, targetOrigin);
                console.log(`✅ 向iframe发送刷新消息: ${dataType}, 项目: ${projectId}`);
            } catch (e) {
                console.error('发送刷新消息失败:', e);
            }
        }
        
        // 初始化首页实时订阅
        function initHomeRealtimeSubscription() {
            
            // 等待Supabase客户端初始化完成
            const waitForSupabaseAndSubscribe = async () => {
                try {
                    if (typeof window.waitForSupabase === 'function') {
                        await window.waitForSupabase();
                    }
                    
                    // 获取当前所有项目ID
                    const userId = getUserId();
                    if (!userId) {
                        console.warn('⚠️ 未找到用户ID，无法初始化实时订阅');
                        return;
                    }
                    
                    // 从本地存储获取项目数据
                    const projectsData = localStorage.getItem('project_cache_' + userId);
                    if (!projectsData) {
                        console.warn('⚠️ 未找到项目数据，无法初始化实时订阅');
                        return;
                    }
                    
                    let projects = [];
                    try {
                        projects = JSON.parse(projectsData);
                    } catch (e) {
                        console.error('解析项目数据失败:', e);
                        return;
                    }
                    
                    // 使用单个通道订阅所有项目的变更
                    if (window.realtimeSyncService) {
                        await window.realtimeSyncService.subscribeToAllProjects();
                    }
                    
                    // 监听实时数据更新事件
                    window.addEventListener('realtimeDataUpdated', (event) => {
                        const { table, projectId, timestamp } = event.detail;
                        console.log(`🏠 首页收到实时更新: ${table}, 项目: ${projectId}`);
                        
                        // 获取当前打开的iframe页面
                        const currentPage = getCurrentIframePage();
                        const iframe = document.getElementById('contentFrame');
                        
                        // 检查是否需要刷新当前页面
                        if (shouldRefreshCurrentPage(table, currentPage, projectId)) {
                            console.log(`🔄 当前页面 ${currentPage} 受到 ${table} 数据更新影响，准备刷新...`);
                            
                            // 等待iframe加载完成后再发送消息
                            if (iframe) {
                                if (iframe.contentDocument && iframe.contentDocument.readyState === 'complete') {
                                    sendRefreshMessage(iframe, table, projectId);
                                } else {
                                    // 如果iframe还未加载完成，等待加载完成后再发送
                                    iframe.onload = function() {
                                        sendRefreshMessage(iframe, table, projectId);
                                        // 重置onload处理器
                                        iframe.onload = null;
                                    };
                                }
                            }
                        } else {
                            console.log(`⏭️ 当前页面 ${currentPage} 不受 ${table} 数据更新影响，跳过刷新`);
                        }
                    });
                    
                } catch (error) {
                    console.error('❌ 初始化首页实时订阅失败:', error);
                }
            };
            
            // 立即执行，不再需要延迟
            waitForSupabaseAndSubscribe();
        }
        
        // 获取用户ID
        function getUserId() {
            try {
                const currentUserStr = localStorage.getItem('currentUser');
                if (currentUserStr) {
                    const currentUser = JSON.parse(currentUserStr);
                    return currentUser.user_id || 'default';
                }
            } catch (e) {
                console.error('解析currentUser失败:', e);
            }
            return 'default';
        }
        
        // 完全重写消息处理逻辑，避免异步响应问题
        (function() {
            // 保存原始的console.error方法以进行错误过滤
            const originalConsoleError = console.error;
            
            // 重写console.error，过滤特定的Chrome扩展错误
            console.error = function(...args) {
                // 将参数转换为字符串以检查是否包含特定错误信息
                const errorMessage = args.join(' ');
                
                // 过滤掉关于消息监听器异步响应的错误
                if (errorMessage.includes('Unchecked runtime.lastError') && 
                    errorMessage.includes('listener indicated an asynchronous response')) {
                    // 静默处理这个特定错误，不输出到控制台
                    return;
                }
                
                // 其他错误正常输出
                originalConsoleError.apply(console, args);
            };
            
            // 优化postMessage处理，避免消息通道关闭问题
            const originalPostMessage = window.postMessage;
            window.postMessage = function(message, targetOrigin, transfer) {
                try {
                    // 如果未指定targetOrigin，使用当前域名
                    if (!targetOrigin || targetOrigin === '*') {
                        targetOrigin = window.location.origin;
                    }
                    // 正常执行postMessage
                    originalPostMessage.call(window, message, targetOrigin, transfer);
                } catch (e) {
                    // 捕获并静默处理错误
                }
            };
            
            // 移除所有现有的message事件监听器（避免重复绑定）
            // 由于无法直接移除匿名监听器，我们创建一个新的监听器覆盖
            // 首先使用capture选项来确保我们的监听器先执行
            window.addEventListener('message', handleMessageEvent, { capture: true });
            
            // 定义消息处理函数
            function handleMessageEvent(event) {
                // 关键：不要使用async函数作为事件监听器
                // 不要返回任何值，特别是不要返回true

                // 简化来源检查逻辑：对于本地文件系统运行的应用，允许所有消息
                // 在生产环境部署时，可以添加更严格的来源验证

                try {
                    // 处理消息数据
                    if (event.data && typeof event.data === 'object') {
                        // 消息类型处理
                        switch (event.data.type) {
                            case 'updateTitle':
                                if (event.data.title) {
                                    // 处理完整标题更新
                                    setTimeout(() => {
                                        // 更新页面顶部标题 - 只有在没有onlyUpdateHistory标志时才更新
                                        if (!event.data.onlyUpdateHistory) {
                                            const headerTitle = document.querySelector('.header-title');
                                            if (headerTitle) {
                                                headerTitle.textContent = event.data.title;
                                                headerTitle.setAttribute('title', event.data.title);
                                            }
                                        }

                                        // 同时更新历史记录中的标题
                                        const currentIndex = NavigationHistory.currentIndex;
                                        if (currentIndex >= 0 && NavigationHistory.history[currentIndex]) {
                                            NavigationHistory.history[currentIndex].title = event.data.title;
                                            NavigationHistory.saveToStorage();
                                        }
                                    }, 0);
                                } else if (event.data.project_name) {
                                    // 处理项目名称更新
                                    setTimeout(() => setProjectTitle(event.data.project_name), 0);
                                } else if (event.data.page) {
                                    // 处理页面标题更新
                                    setTimeout(() => updateHeaderTitle(event.data.page), 0);
                                }
                                break;
                            case 'navigate':
                                if (event.data.page) {
                                    // 导航处理
                                    setTimeout(() => {
                                        const title = event.data.project_name
                                            ? `${event.data.project_name} - ${NavigationHistory.getPageTitle(event.data.page)}`
                                            : NavigationHistory.getPageTitle(event.data.page);
                                        NavigationHistory.add(event.data.page, title, false);
                                    }, 0);
                                }
                                break;
                            case 'pageChange':
                                // 监听页面变化消息
                                if (event.data.page || event.data.url) {
                                    const page = event.data.page || event.data.url;
                                    const title = event.data.title || NavigationHistory.getPageTitle(page);
                                    NavigationHistory.add(page, title, false);
                                }
                                break;
                            case 'refreshAttendanceData':
                            case 'refreshSettlementData':
                            case 'refreshEmployeeData':
                            case 'refreshExpenseData':
                            case 'refreshData':
                                // 刷新消息由iframe发送给首页，首页不需要处理
                                // 这些消息是用于通知iframe刷新数据的
                                console.log(`📢 收到刷新消息: ${event.data.type}`);
                                break;
                            default:
                                // 忽略其他类型的消息
                                break;
                        }
                    }
                } catch (e) {
                    // 静默处理错误，不抛出异常
                }

                // 重要：不要在这里返回任何值，特别是不要返回true
                // 这是防止异步响应错误的关键
            }
            
            // 清理函数，用于在组件卸载时移除监听器
            window.cleanupMessageListeners = function() {
                window.removeEventListener('message', handleMessageEvent, { capture: true });
            };
        })();
        
        // 初始化流程已在页面头部的专用脚本中按顺序控制执行
    </script>
</body>
</html>