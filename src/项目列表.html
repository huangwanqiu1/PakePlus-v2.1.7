<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£é±¼è€ƒå‹¤ - é¡¹ç›®åˆ—è¡¨</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <!-- åŠ è½½é¡¹ç›®ç»Ÿè®¡æœåŠ¡ -->
    <script src="JavaScript/é¡¹ç›®åˆ—è¡¨/project-statistics-service.js"></script>
    <!-- æœ¬åœ°åŠ è½½å®Œæ•´çš„Supabaseåº“ -->
    <script src="JavaScript/supabase/supabase.min.js"></script>
    <!-- åŠ è½½æµè§ˆå™¨ç¯å¢ƒçš„Supabaseé…ç½® -->
    <script src="JavaScript/supabase/supabase-client.js"></script>
    <!-- ç¦»çº¿åŒæ­¥æœåŠ¡ -->
    <script src="JavaScript/ç¦»çº¿åŒæ­¥/offline-sync-service.js"></script>
    <script src="JavaScript/ç¦»çº¿åŒæ­¥/sync-status-indicator.js"></script>

    <style>
        :root {
            --primary-color: #165DFF;
            --secondary-color: #6B7280;
            --success-color: #10B981;
            --danger-color: #EF4444;
            --warning-color: #F59E0B;
            --light-bg: #F9FAFB;
            --dark-bg: #1F2937;
            --border-color: #E5E7EB;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        /* é¡¹ç›®è®¾ç½®ä¿¡æ¯æ ·å¼ */
        .info-display {
            padding: 10px;
            background-color: var(--light-bg);
            border-radius: 4px;
            border: 1px solid var(--border-color);
            margin-top: 5px;
            height: 40px;
            display: flex;
            align-items: center;
        }

        /* é€šçŸ¥æ ·å¼ */
        .notification {
            font-weight: 500;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            padding: 20px;
        }

        /* å†…å®¹åŒºåŸŸ */
        .content {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* æ ‡ç­¾é¡µ */
        .tabs {
            display: flex;
            margin-bottom: 24px;
            border-bottom: 1px solid #e2e8f0;
            background: white;
            border-radius: 12px;
            padding: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            justify-content: flex-start;
            width: fit-content;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            font-weight: 600;
            color: #64748b;
            border-bottom: none;
            border-radius: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            flex: none;
            text-align: center;
            min-width: 120px;
        }

        .tab:hover {
            color: #374151;
            background: rgba(59, 130, 246, 0.05);
        }

        .tab.active {
            color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }

        .tab.active.tab-ongoing {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.8), rgba(37, 99, 235, 0.8));
        }

        .tab.active.tab-settled {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.8), rgba(220, 38, 38, 0.8));
        }

        /* æ–°å»ºé¡¹ç›®æŒ‰é’® */
        .new-project-btn {
            background: linear-gradient(135deg, #f97316, #ea580c);
            color: white;
            border: none;
            padding: 8px 20px; 
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
            position: relative;
            overflow: hidden;
        }

        .new-project-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .new-project-btn:hover::before {
            left: 100%;
        }

        .new-project-btn:hover {
            background: linear-gradient(135deg, #ea580c, #c2410c);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(249, 115, 22, 0.4);
        }

        .new-project-btn:active {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .new-project-btn .icon {
            margin-right: 6px;
            font-size: 24px; 
            font-weight: bold;
        }

        /* é¡¹ç›®ç½‘æ ¼ */
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        /* é¡¹ç›®å¡ç‰‡ */
        .project-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.04);
            padding: 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(226, 232, 240, 0.8);
            position: relative;
            overflow: hidden;
        }

        .project-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #06b6d4, #8b5cf6);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .project-card:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .project-card:hover::before {
            opacity: 1;
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .project-name {
            font-weight: 700;
            font-size: 18px;
            color: #1e293b;
            background: linear-gradient(135deg, #1e293b, #334155);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 4px;
            letter-spacing: -0.025em;
        }

        .project-date {
            color: #000000;
            font-size: 14px;
        }

        .project-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .project-count {
            color: #000000;
            font-size: 14px;
        }

        .project-date {
            color: #000000;
            font-size: 14px;
        }

        .last-work-date {
            color: #3b82f6;
            font-weight: 600;
        }

        .last-work-label {
            background-color: #fff7e6;
            color: #fa8c16;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
            text-align: center;
        }

        .project-info > .project-date:last-child {
            text-align: center;
        }

        .project-count-number {
            color: #3b82f6;
            font-weight: 600;
        }

        .project-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            padding-top: 12px;
            border-top: 1px solid #e5e7eb;
        }

        .project-actions-left {
            display: flex;
            gap: 8px;
            justify-content: flex-start;
            flex: 1;
            min-width: 150px;
        }

        .project-actions-right {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            flex: 1;
            min-width: 200px;
        }

        .action-btn {
            padding: 10px 16px;
            border: 1px solid rgba(226, 232, 240, 0.8);
            border-radius: 8px;
            background: linear-gradient(135deg, #ffffff, #f8fafc);
            color: #374151;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s;
        }

        .action-btn:hover::before {
            left: 100%;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .settings-btn {
            color: #1f2937;
            border-color: #d1d5db;
            background: linear-gradient(135deg, #ffffff, #f9fafb);
        }

        .settings-btn:hover {
            color: #ffffff;
            border-color: #000000;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            transform: translateY(-1px);
        }

        .settings-btn svg {
            transition: transform 0.3s ease;
        }

        .settings-btn:hover svg {
            transform: rotate(90deg);
        }

        .settlement-btn {
            color: #d97706;
            border-color: #fbbf24;
            background: linear-gradient(135deg, #fffbeb, #fef3c7);
        }

        .settlement-btn:hover {
            color: #ffffff;
            background: rgba(249, 115, 22, 0.85);
            border-color: #f97316;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 16px rgba(249, 115, 22, 0.4);
            transform: translateY(-1px);
        }

        .record-btn {
            color: #ffffff;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border-color: #3b82f6;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }

        .record-btn:hover {
            color: #ffffff;
            background: rgba(185, 28, 28, 0.85);
            border-color: #b91c1c;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 16px rgba(185, 28, 28, 0.4);
            transform: translateY(-1px);
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.4));
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: linear-gradient(135deg, #ffffff, #f8fafc);
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 520px;
            padding: 32px;
            transform: translateY(20px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            max-height: 90vh;
        }

        .modal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #06b6d4);
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
            background: linear-gradient(135deg, #1e293b, #475569);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #94a3b8;
            transition: all 0.3s ease;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            padding: 0;
        }

        .modal-close:hover {
            color: #ef4444;
            background-color: #fee2e2;
            transform: rotate(90deg);
        }

        .modal-body {
            margin-bottom: 24px;
            padding: 0;
        }

        .form-group {
            margin-bottom: 8px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background-color: #f9fafb;
            color: #111827;
            min-height: 44px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
            background-color: #ffffff;
            transform: translateY(-1px);
        }

        .form-group input:hover {
            border-color: #d1d5db;
            background-color: #ffffff;
        }

        .form-row {
            display: flex;
            gap: 16px;
            margin-bottom: 0px;
            padding: 4px;
            background: linear-gradient(135deg, #ffffff, #f9fafb);
            border-radius: 12px;
        }

        .form-control-wrapper {
            display: flex;
            align-items: center;
            position: relative;
        }

        .form-control-wrapper input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px 0 0 8px;
            font-size: 15px;
            transition: all 0.3s ease;
            background-color: #f9fafb;
            color: #111827;
            min-width: 80px;
            min-height: 42px;
        }

        .form-control-wrapper .unit {
            padding: 10px 8px;
            background-color: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-left: none;
            border-radius: 0 8px 8px 0;
            color: #6b7280;
            font-size: 13px;
            white-space: nowrap;
            font-weight: 500;
            min-width: 65px;
            text-align: center;
            min-height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: static;
            transform: none;
        }

        .modal-footer {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            padding: 20px 24px;
            border-top: 1px solid #e2e8f0;
            margin-top: 32px;
            margin-bottom: -8px;
        }

        #markAsSettled {
            color: #ef4444;
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            border-color: #fca5a5;
        }

        #markAsSettled:hover {
            background: linear-gradient(135deg, #fecaca, #f87171);
            border-color: #ef4444;
            color: white;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border-color: #3b82f6;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            border-color: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #374151;
            border-color: #d1d5db;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .btn-secondary:hover {
            background: #f9fafb;
            border-color: #9ca3af;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* å“åº”å¼è®¾è®¡ */
        /* æ‰‹æœºè®¾å¤‡ (å°äº 576px) */
        @media (max-width: 575.98px) {
            body {
                padding: 10px;
            }
            
            .content {
                padding: 5px;
            }

            .tabs {
                width: 100%;
                overflow-x: auto;
                padding: 4px 0;
            }

            .tab {
                padding: 8px 16px;
                min-width: 100px;
                font-size: 14px;
            }

            .new-project-btn {
                padding: 10px 16px;
                font-size: 14px;
            }

            .projects-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .project-card {
                padding: 16px;
            }

            .project-name {
                font-size: 16px;
            }

            .action-btn {
                padding: 8px 12px;
                font-size: 12px;
            }

            .modal {
                width: 95%;
                margin: 10px;
                padding: 20px;
            }

            .modal-header {
                margin-bottom: 16px;
                padding-bottom: 16px;
            }

            .modal-title {
                font-size: 20px;
            }

            .btn {
                padding: 8px 16px;
                font-size: 13px;
            }
        }

        /* å¹³æ¿è®¾å¤‡ (576px - 767px) */
        @media (min-width: 576px) and (max-width: 767.98px) {
            .projects-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 16px;
            }

            .content {
                padding: 15px;
            }

            .tab {
                padding: 10px 20px;
            }

            .project-card {
                padding: 18px;
            }

            .action-btn {
                padding: 9px 14px;
                font-size: 13px;
            }

            .modal {
                width: 90%;
                max-width: 500px;
            }
        }

        /* å°å±å¹•ç”µè„‘ (768px - 991px) */
        @media (min-width: 768px) and (max-width: 991.98px) {
            .projects-grid {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 20px;
            }

            .content {
                padding: 20px;
            }
        }

        /* å¤§å±å¹•ç”µè„‘ (992pxåŠä»¥ä¸Š) */
        @media (min-width: 992px) {
            .projects-grid {
                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
                gap: 24px;
            }

            .content {
                padding: 25px;
            }
        }
    </style>
</head>
<body>
    <div class="content">
        <!-- æ ‡ç­¾é¡µ -->
        <div class="tabs">
            <div class="tab active">åœ¨å»ºé¡¹ç›® (0)</div>
            <div class="tab">å·²ç»“æ¸…é¡¹ç›® (0)</div>
        </div>

        <!-- æ–°å»ºé¡¹ç›®æŒ‰é’® -->
        <button class="new-project-btn" onclick="createNewProject()">
            <span class="icon">+</span> æ–°å»ºé¡¹ç›®
        </button>

        <!-- é¡¹ç›®ç½‘æ ¼ -->
        <div class="projects-grid" id="projectsGrid">
            <!-- é¡¹ç›®å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <!-- æ–°å»ºé¡¹ç›®æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="projectModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">æ–°å»ºé¡¹ç›®</h3>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group half-width">
                        <label for="projectname"><span style="color: #ef4444; margin-right: 4px;">*</span>é¡¹ç›®åç§°ï¼š</label>
                        <input type="text" id="projectname" placeholder="è¯·è¾“å…¥é¡¹ç›®åç§°" required style="color: #2563eb;">
                    </div>
                    <div class="form-group half-width">
                        <label for="projectaddress">é¡¹ç›®åœ°å€ï¼š</label>
                        <input type="text" id="projectaddress" placeholder="è¯·è¾“å…¥é¡¹ç›®åœ°å€" style="color: #2563eb;">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group half-width">
                        <label for="regularHours"><span style="color: #ef4444; margin-right: 4px;">*</span>ç‚¹å·¥ï¼š</label>
                        <div class="form-control-wrapper">
                            <input type="number" id="regularHours" placeholder="æ­£å¸¸æ—¶é—´" min="0" step="0.5" required style="color: #2563eb;">
                            <span class="unit">å°æ—¶/å¤©</span>
                        </div>
                    </div>
                    <div class="form-group half-width">
                        <label for="overtimeHours"><span style="color: #ef4444; margin-right: 4px;">*</span>åŠ ç­ï¼š</label>
                        <div class="form-control-wrapper">
                            <input type="number" id="overtimeHours" placeholder="åŠ ç­æ—¶é—´" min="0" step="0.5" required style="color: #2563eb;">
                            <span class="unit">å°æ—¶/å¤©</span>
                        </div>
                    </div>
                </div>
                <!-- é¡¹ç›®è®¾ç½®é¢å¤–ä¿¡æ¯ -->
                <div id="projectSettingsInfo" style="display: none;">
                    <div class="form-row">
                        <div class="form-group" style="width: 33.33%; margin-right: auto;">
                            <label>åœ¨åœºå‘˜å·¥ï¼š</label>
                            <div id="presentWorkers" class="info-display"></div>
                        </div>
                        <div class="form-group" style="width: 33.33%;">
                            <label>ç»Ÿè®¡(æ€»å·¥èµ„)ï¼š</label>
                            <div id="statistics" class="info-display"></div>
                        </div>
                        <div class="form-group" style="width: 33.33%; margin-left: auto;">
                            <label>æœªç»“é‡‘é¢ï¼š</label>
                            <div id="unsettled" class="info-display"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" id="markAsSettled" style="display: none;">è®¾ä¸ºå·²ç»“æ¸…</button>
                <button class="btn btn-secondary" id="cancelProject">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="confirmProject">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <!-- è®¾ä¸ºå·²ç»“æ¸…ç¡®è®¤æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="confirmSettleModal">
          <div class="modal" style="width: 320px; max-width: 90%; max-height: 240px; padding: 16px;">
            <div class="modal-header" style="margin-bottom: 6px; padding-bottom: 6px;">
                <h4 class="modal-title" style="font-size: 14px; font-weight: bold;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ff8c00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 5px; vertical-align: middle;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>
                    ç¡®è®¤è®¾ä¸ºå·²ç»“æ¸…å—ï¼Ÿ
                </h4>
                <button class="modal-close" id="closeConfirmSettleModal">&times;</button>
            </div>
            <div class="modal-body">
                <p style="text-align: left; display: flex; align-items: center; height: 40px; margin: 6px 0;">
                    <span style="color: black; font-size: 14px;">è®¾ä¸ºå·²ç»“æ¸…åï¼Œä¸å‚ä¸ç»Ÿè®¡å’Œå±•ç¤º</span>
                </p>
            </div>
            <div class="modal-footer" style="margin-top: 0; padding: 6px 12px;">
                <button class="btn btn-secondary" id="cancelSettleBtn" style="padding: 6px 12px; font-size: 12px;">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="confirmSettleBtn" style="padding: 6px 12px; font-size: 12px;">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <!-- ç¡®è®¤æ¢å¤ä¸ºåœ¨å»ºæ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="confirmRestoreModal">
        <div class="modal" style="width: 320px; max-width: 90%; max-height: 240px; padding: 16px;">
            <div class="modal-header" style="margin-bottom: 6px; padding-bottom: 6px;">
                <h4 class="modal-title" style="font-size: 16px;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 5px; vertical-align: middle;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>
                    ç¡®è®¤è®¾ä¸ºåœ¨å»ºå—ï¼Ÿ
                </h4>
                <button class="modal-close" id="closeConfirmRestoreModal">&times;</button>
            </div>
            <div class="modal-body">
                <p style="text-align: left; display: flex; align-items: center; height: 40px; margin: 6px 0;">
                    <span style="color: black; font-size: 14px;">è®¾ä¸ºåœ¨å»ºåï¼Œå°†å‚ä¸ç»Ÿè®¡å’Œå±•ç¤º</span>
                </p>
            </div>
            <div class="modal-footer" style="margin-top: 6px; padding: 6px 12px;">
                <button class="btn btn-secondary" id="cancelRestoreBtn" style="padding: 6px 12px; font-size: 12px;">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="confirmRestoreBtn" style="padding: 6px 12px; font-size: 12px;">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <!-- åˆ é™¤é¡¹ç›®ç¡®è®¤æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="confirmDeleteModal">
        <div class="modal" style="width: 350px; max-width: 90%; max-height: 350px; padding: 16px;">
            <div class="modal-header" style="margin-bottom: 6px; padding-bottom: 6px;">
                <h4 class="modal-title" style="font-size: 18px;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 5px; vertical-align: middle;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>
                    ç¡®å®šåˆ é™¤è¯¥é¡¹ç›®ï¼Ÿ
                </h4>
                <button class="modal-close" id="closeConfirmDeleteModal">&times;</button>
            </div>
            <div class="modal-body" style="padding: 10px 0;">
                <p style="text-align: left; margin: 6px 0; font-size: 14px;">æ‚¨å°†ä¼šå¤±å»è¯¥é¡¹ç›®çš„ï¼š</p>
                <ul style="text-align: left; margin: 6px 0 16px 20px; font-size: 14px; list-style-type: none; padding-left: 5px; display: grid; grid-template-columns: 1fr 1fr; gap: 4px;">
                    <li style="margin: 4px 0;"><span style="display: inline-block; width: 8px; height: 8px; background-color: #ef4444; border-radius: 50%; margin-right: 8px; vertical-align: middle;"></span>å‘˜å·¥è®°å½•</li>
                    <li style="margin: 4px 0;"><span style="display: inline-block; width: 8px; height: 8px; background-color: #ef4444; border-radius: 50%; margin-right: 8px; vertical-align: middle;"></span>é¡¹ç›®è®°è´¦è®°å½•</li>
                    <li style="margin: 4px 0;"><span style="display: inline-block; width: 8px; height: 8px; background-color: #ef4444; border-radius: 50%; margin-right: 8px; vertical-align: middle;"></span>å€Ÿæ”¯è®°å½•</li>
                    <li style="margin: 4px 0;"><span style="display: inline-block; width: 8px; height: 8px; background-color: #ef4444; border-radius: 50%; margin-right: 8px; vertical-align: middle;"></span>ç‚¹å·¥å•è®°å½•</li>
                    <li style="margin: 4px 0;"><span style="display: inline-block; width: 8px; height: 8px; background-color: #ef4444; border-radius: 50%; margin-right: 8px; vertical-align: middle;"></span>è€ƒå‹¤è®°å½•</li>
                    <li style="margin: 4px 0;"><span style="display: inline-block; width: 8px; height: 8px; background-color: #ef4444; border-radius: 50%; margin-right: 8px; vertical-align: middle;"></span>æ–½å·¥æ—¥å¿—è®°å½•</li>
                </ul>
                <div style="margin: 16px 0 0 0;">
                    <input type="password" id="deleteConfirmationCode" style="width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px;" placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
            </div>
            <div class="modal-footer" style="margin-top: 6px; padding: 6px 12px;">
                <button class="btn btn-secondary" id="cancelDeleteBtn" style="padding: 6px 12px; font-size: 12px;">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="confirmDeleteBtn" style="padding: 6px 12px; font-size: 12px;">ç¡®è®¤</button>
            </div>
        </div>
    </div>
    
    <script>

        // è¾…åŠ©å‡½æ•°ï¼šè·å–æ­£ç¡®çš„åŒ—äº¬æ—¶é—´ï¼ˆUTC+8ï¼‰å­—ç¬¦ä¸²
        function getBeijingTimeString() {
            // åˆ›å»ºä¸€ä¸ªæ–°çš„Dateå¯¹è±¡ï¼ˆæ³¨æ„ï¼šJavaScript Dateå¯¹è±¡å†…éƒ¨ä½¿ç”¨UTCæ—¶é—´ï¼Œä½†ä¼šæ ¹æ®æœ¬åœ°æ—¶åŒºæ˜¾ç¤ºï¼‰
            const now = new Date();
            
            // ç›´æ¥ä½¿ç”¨Dateå¯¹è±¡çš„UTCæ–¹æ³•è·å–å½“å‰æ—¶é—´çš„UTCæ—¶é—´éƒ¨åˆ†
            // è¿™æ ·å¯ä»¥é¿å…æ—¶åŒºè½¬æ¢é—®é¢˜ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦çš„å°±æ˜¯UTC+8æ—¶é—´
            let year = now.getUTCFullYear();
            let month = now.getUTCMonth();
            let day = now.getUTCDate();
            let hours = now.getUTCHours();
            
            // åŠ ä¸Š8å°æ—¶å¾—åˆ°åŒ—äº¬æ—¶é—´
            hours += 8;
            
            // å¤„ç†æ—¥æœŸè¿›ä½
            if (hours >= 24) {
                hours -= 24;
                day += 1;
                
                // å¤„ç†æœˆä»½è¿›ä½
                const daysInMonth = new Date(Date.UTC(year, month + 1, 0)).getUTCDate();
                if (day > daysInMonth) {
                    day = 1;
                    month += 1;
                    
                    // å¤„ç†å¹´ä»½è¿›ä½
                    if (month > 11) {
                        month = 0;
                        year += 1;
                    }
                }
            }
            
            // æ ¼å¼åŒ–è¾“å‡º
            month = String(month + 1).padStart(2, '0');
            day = String(day).padStart(2, '0');
            hours = String(hours).padStart(2, '0');
            const minutes = String(now.getUTCMinutes()).padStart(2, '0');
            const seconds = String(now.getUTCSeconds()).padStart(2, '0');
            
            // è¿”å›æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²ï¼Œç¡®ä¿SupabaseæŒ‰å­—é¢æ–‡æœ¬ä¿å­˜è€Œéæ—¶é—´æˆ³ç±»å‹
            // è¿™å°†é¿å…Supabaseè‡ªåŠ¨æ·»åŠ æ¯«ç§’ç²¾åº¦
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
        
        // ç”Ÿæˆå½“å‰æ—¶é—´çš„ISOå­—ç¬¦ä¸²ï¼Œæ­£ç¡®å¤„ç†æ—¶åŒº
        function getCurrentTimeISOString() {
            const now = new Date();
            // è®¡ç®—åŒ—äº¬æ—¶é—´ï¼ˆUTC+8ï¼‰
            const beijingTime = new Date(now.getTime() + 8 * 60 * 60 * 1000);
            // è¿”å›æ ‡å‡†ISOæ ¼å¼å­—ç¬¦ä¸²
            return beijingTime.toISOString();
        }

        // ç¤ºä¾‹é¡¹ç›®æ•°æ®
        let projects = [];

        // é¡µé¢åŠ è½½æ—¶è·å–é¡¹ç›®æ•°æ®
        window.addEventListener('DOMContentLoaded', async function() {
            // æ³¨æ„ï¼šè¿™ä¸ªäº‹ä»¶ç›‘å¬å™¨ä¼šåœ¨Supabaseåˆå§‹åŒ–ä¹‹å‰æ‰§è¡Œï¼Œä½†loadUserProjectså‡½æ•°ä¼šå¤„ç†æœ¬åœ°æ•°æ®
            await loadUserProjects();

            // æ£€æŸ¥URLå‚æ•°ï¼Œå¦‚æœéœ€è¦æ‰“å¼€é¡¹ç›®è®¾ç½®æ¨¡æ€æ¡†
            checkUrlForSettings();
        });
        
        // ç›‘å¬æ•°æ®æ›´æ–°äº‹ä»¶
        window.addEventListener('dataUpdated', function(event) {
            console.log('ğŸ“Š æ•°æ®æ›´æ–°äº‹ä»¶è§¦å‘:', event.detail);
            // æ•°æ®æ›´æ–°åé‡æ–°åŠ è½½é¡¹ç›®è¯¦ç»†æ•°æ®
            loadProjectDetails();
        });
        
        // ç›‘å¬localStorageå˜åŒ–äº‹ä»¶ï¼Œå½“å…¶ä»–é¡µé¢ä¿®æ”¹æœ¬åœ°å­˜å‚¨æ—¶è§¦å‘
        window.addEventListener('storage', function(event) {
            // å½“è€ƒå‹¤ã€ç»“ç®—æ•°æ®ã€å‘˜å·¥æ•°é‡æ•°æ®æˆ–å‘˜å·¥æ•°æ®æ›´æ–°é€šçŸ¥å‘ç”Ÿå˜åŒ–æ—¶ï¼Œé‡æ–°åŠ è½½è¯¦ç»†æ•°æ®
            if (event.key && (event.key.includes('work_records_') || event.key === 'settlementRecords' || event.key.includes('employee_counts_') || event.key === 'employeeDataUpdated')) {
                // é™é»˜å¤„ç†ï¼Œä¸è¾“å‡ºæ—¥å¿—
                loadProjectDetails();
            }
        });
        
        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œå½“é¡µé¢ä»åå°å›åˆ°å‰å°æ—¶é‡æ–°åŠ è½½æ•°æ®
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                loadProjectDetails();
            }
        });
        

        
        // æŸ¥è¯¢employeesè¡¨ä¸­statusä¸º"åœ¨èŒ"å’Œ"éšè—"çš„ä¸ªæ•°ä¹‹å’Œ
        async function getEmployeeCount(projectId) {
            try {
                // ä»æœ¬åœ°å­˜å‚¨è·å–å‘˜å·¥æ•°é‡
                let userId = 'default';
                try {
                    const currentUserStr = localStorage.getItem('currentUser');
                    if (currentUserStr) {
                        const currentUser = JSON.parse(currentUserStr);
                        userId = currentUser.user_id || 'default';
                    }
                } catch (e) {
                    console.error('è§£æcurrentUserå¤±è´¥:', e);
                }
                
                // ä»æœ¬åœ°å­˜å‚¨è·å–å‘˜å·¥æ•°é‡
                const employeeCountsStr = localStorage.getItem('employee_counts_' + userId);
                if (employeeCountsStr) {
                    try {
                        const employeeCounts = JSON.parse(employeeCountsStr);
                        if (employeeCounts[projectId] !== undefined) {
                            return employeeCounts[projectId];
                        }
                    } catch (e) {
                        console.error('è§£æå‘˜å·¥æ•°é‡æ•°æ®å¤±è´¥:', e);
                    }
                }
                
                // å¦‚æœæœ¬åœ°æ²¡æœ‰æ•°æ®ï¼Œè¿”å›0
                return 0;
            } catch (error) {
                console.error('è·å–å‘˜å·¥æ•°é‡å¤±è´¥:', error);
                return 0;
            }
        }

        // é¡¹ç›®æ•°æ®åŠ è½½å‡½æ•°
        async function loadUserProjects() {
            try {
                // æ¸…ç©ºé¡¹ç›®æ•°ç»„
                ongoingProjects = [];
                settledProjects = [];
                
                try {
                    // ä»æœ¬åœ°åŠ è½½é¡¹ç›®æ•°æ®
                    loadProjectsFromLocal();
                    
                    // å…ˆæ¸²æŸ“é¡¹ç›®åˆ—è¡¨ï¼ˆåªæ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯ï¼‰
                    renderProjects('ongoing');
                    updateTabCounts();
                    
                    // åœ¨åå°å¼‚æ­¥åŠ è½½è¯¦ç»†æ•°æ®
                    loadProjectDetails();
                } catch (dbError) {
                    showNotification('åŠ è½½é¡¹ç›®æ•°æ®å¤±è´¥', true);
                    console.error('åŠ è½½é¡¹ç›®æ•°æ®å¤±è´¥:', dbError);
                }
            } catch (error) {
                showNotification('åŠ è½½é¡¹ç›®å¤±è´¥', true);
                console.error('åŠ è½½é¡¹ç›®æ—¶å‘ç”Ÿé”™è¯¯:', error);
                // åŠ è½½å¤±è´¥æ—¶ä½¿ç”¨ç©ºé¡¹ç›®åˆ—è¡¨
                ongoingProjects = [];
                settledProjects = [];
                renderProjects('ongoing');
                updateTabCounts();
            }
        }
        
        // åå°åŠ è½½é¡¹ç›®è¯¦ç»†æ•°æ®
        async function loadProjectDetails() {
            try {
                // ä¸ºæ¯ä¸ªé¡¹ç›®å¹¶è¡ŒæŸ¥è¯¢æ‰€éœ€æ•°æ®
                const projectsWithData = await Promise.all(
                    [...ongoingProjects, ...settledProjects].map(async (project) => {
                        // æ¸…é™¤è¯¥é¡¹ç›®çš„ç¼“å­˜ï¼Œå¼ºåˆ¶ä»æ•°æ®åº“æŸ¥è¯¢æœ€æ–°æ•°æ®
                        window.projectStatisticsService.clearCache(project.project_id);

                        // è·å–å®Œæ•´ç»Ÿè®¡æ•°æ®
                        const stats = await window.projectStatisticsService.getProjectStatistics(project.project_id);

                        // å¹¶è¡ŒæŸ¥è¯¢å‘˜å·¥æ•°é‡
                        const employeeCount = await getEmployeeCount(project.project_id);

                        // å°†æ•°æ®å­˜å‚¨åˆ°é¡¹ç›®å¯¹è±¡ä¸­
                        return {
                            ...project,
                            employeeCount,
                            totalWage: stats.æ€»å·¥èµ„,
                            unsettledAmount: stats.æœªç»“é‡‘é¢
                        };
                    })
                );

                // é‡æ–°åˆ†ç±»é¡¹ç›®
                ongoingProjects = projectsWithData.filter(p => p.status === 'åœ¨å»º');
                settledProjects = projectsWithData.filter(p => p.status === 'ç»“æ¸…');

                // æ›´æ–°é¡¹ç›®åˆ—è¡¨ï¼ˆæ˜¾ç¤ºè¯¦ç»†æ•°æ®ï¼‰
                renderProjects('ongoing');
            } catch (error) {
                console.error('åŠ è½½é¡¹ç›®è¯¦ç»†æ•°æ®å¤±è´¥:', error);
            }
        }

        // æ£€æŸ¥URLå‚æ•°ï¼Œå¦‚æœå­˜åœ¨open_settings=trueï¼Œåˆ™è‡ªåŠ¨æ‰“å¼€é¡¹ç›®è®¾ç½®æ¨¡æ€æ¡†
        function checkUrlForSettings() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const openSettings = urlParams.get('open_settings');
                const projectId = urlParams.get('project_id');

                if (openSettings === 'true' && projectId) {
                    // è§£ç é¡¹ç›®ID
                    const decodedProjectId = decodeURIComponent(projectId);

                    // éšè—é¡¹ç›®åˆ—è¡¨å®¹å™¨ï¼Œç›´æ¥æ˜¾ç¤ºæ¨¡æ€æ¡†
                    const projectsGrid = document.getElementById('projectsGrid');
                    const tabsContainer = document.querySelector('.tabs');
                    if (projectsGrid) {
                        projectsGrid.style.display = 'none';
                    }
                    if (tabsContainer) {
                        tabsContainer.style.display = 'none';
                    }

                    // æŸ¥æ‰¾é¡¹ç›®
                    let project = ongoingProjects.find(p => p.project_id === decodedProjectId);
                    if (!project) {
                        project = settledProjects.find(p => p.project_id === decodedProjectId);
                    }

                    if (project) {
                        // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç­‰å¾…é¡¹ç›®åˆ—è¡¨å®Œå…¨æ¸²æŸ“
                        setTimeout(() => {
                            // è°ƒç”¨projectSettingså‡½æ•°æ‰“å¼€æ¨¡æ€æ¡†
                            if (typeof projectSettings === 'function') {
                                projectSettings(decodedProjectId);
                            } else {
                                console.error('projectSettingså‡½æ•°ä¸å­˜åœ¨');
                            }
                        }, 300);
                    } else {
                        console.error('æœªæ‰¾åˆ°é¡¹ç›®ï¼ŒID:', decodedProjectId);
                        // å¦‚æœæ‰¾ä¸åˆ°é¡¹ç›®ï¼Œæ¢å¤æ˜¾ç¤ºé¡¹ç›®åˆ—è¡¨
                        if (projectsGrid) {
                            projectsGrid.style.display = 'grid';
                        }
                        if (tabsContainer) {
                            tabsContainer.style.display = 'flex';
                        }
                    }
                }
            } catch (error) {
                console.error('æ£€æŸ¥URLå‚æ•°å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºé€šçŸ¥å‡½æ•° 
        function showNotification(message, isError = false) {
            // é¿å…çŸ­æ—¶é—´å†…æ˜¾ç¤ºå¤šä¸ªç›¸åŒçš„é€šçŸ¥
            const existingNotifications = document.querySelectorAll('.notification');
            const hasDuplicate = Array.from(existingNotifications).some(notification => 
                notification.textContent === message
            );
            
            if (hasDuplicate) {
                return;
            }
            
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                padding: 16px 24px;
                background: ${isError ? '#ef4444' : '#10b981'};
                color: white;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
                z-index: 9999;
                font-weight: 500;
                font-size: 16px;
                max-width: 350px;
                text-align: center;
                animation: fadeInOut 3s ease;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
    <script>
        // é¡¹ç›®æ•°æ®
        let ongoingProjects = []; // åœ¨å»ºé¡¹ç›®
        let settledProjects = []; // ç»“æ¸…é¡¹ç›®

        // ä»æœ¬åœ°åŠ è½½é¡¹ç›®æ•°æ®
        function loadProjectsFromLocal() {
            try {
                // è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
                let currentUser = {};
                let userId = 'default';
                try {
                    const currentUserStr = localStorage.getItem('currentUser');
                    if (currentUserStr) {
                        currentUser = JSON.parse(currentUserStr);
                        userId = currentUser.user_id || 'default';
                    }
                } catch (e) {
                    console.error('è§£æcurrentUserå¤±è´¥:', e);
                }
                
                let projectsData = localStorage.getItem('project_cache_' + userId);
                
                if (projectsData) {
                    let projects = JSON.parse(projectsData);
                    
                    projects = projects.map(project => {
                        const effectiveUserId = project.user_id || currentUser.user_id;
                        return {
                            // ä¿ç•™åŸå§‹å­—æ®µå¹¶æ·»åŠ å¿…è¦çš„æ˜ å°„
                            ...project,
                            // ç¡®ä¿æ‰€æœ‰å¿…è¦å­—æ®µéƒ½æœ‰å€¼
                            project_name: project.project_name || 'æœªå‘½åé¡¹ç›®',
                            address: project.address || 'æš‚æ— åœ°å€',
                            status: project.status || 'åœ¨å»º',
                            project_id: project.project_id || '',
                            user_id: effectiveUserId,
                            created_at: project.created_at || getCurrentTimeISOString(),
                            updated_at: project.updated_at || getCurrentTimeISOString(),
                            // å·¥æ—¶ç›¸å…³å­—æ®µçš„é»˜è®¤å€¼
                            regular_hours: project.regular_hours || 0,
                            overtime_hours: project.overtime_hours || 0,
                            // é‡æ–°è®¡ç®—æ˜¯å¦ä¸ºå¸¦ç­é¡¹ç›®: å¦‚æœé¡¹ç›®æ‰€å±ç”¨æˆ·ä¸æ˜¯å½“å‰ç™»å½•ç”¨æˆ·ï¼Œåˆ™æ˜¯å¸¦ç­é¡¹ç›®
                            is_foreman_project: effectiveUserId !== userId
                        };
                    });
                    
                    // ä½¿ç”¨å¤„ç†åçš„æ•°æ®ï¼ŒæŒ‰çŠ¶æ€åˆ†ç±»
                    ongoingProjects = projects.filter(p => p.status === 'åœ¨å»º');
                    settledProjects = projects.filter(p => p.status === 'ç»“æ¸…');
                    
                } else {
                    console.log('æœ¬åœ°æœªå­˜å‚¨é¡¹ç›®æ•°æ®');
                    ongoingProjects = [];
                    settledProjects = [];
                }
            } catch (error) {
                console.error('ä»æœ¬åœ°åŠ è½½é¡¹ç›®å¤±è´¥:', error);
                ongoingProjects = [];
                settledProjects = [];
                showNotification('åŠ è½½é¡¹ç›®å¤±è´¥: ' + error.message, true);
                throw error;
            }
        }
        

        






        // ä»æœ¬åœ°é¡¹ç›®ç´¢å¼•åŠ è½½é¡¹ç›®æ•°æ®
        async function loadLocalProjectIndex() {
            try {
                // è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
                let currentUser = {};
                let userId = 'default';
                try {
                    const currentUserStr = localStorage.getItem('currentUser');
                    if (currentUserStr) {
                        currentUser = JSON.parse(currentUserStr);
                        userId = currentUser.user_id || 'default';
                    }
                } catch (e) {
                    console.error('è§£æcurrentUserå¤±è´¥:', e);
                }
                
                // åªä½¿ç”¨project_cache_${userId}æ ¼å¼
                const cacheKey = 'project_cache_' + userId;
                const cacheData = localStorage.getItem(cacheKey);
                
                if (cacheData) {
                    const parsed = JSON.parse(cacheData);
                    console.log('ä½¿ç”¨project_cacheæ ¼å¼çš„é¡¹ç›®æ•°æ®');
                    return Array.isArray(parsed) ? parsed : (parsed.projects || []);
                }
                
                return [];
            } catch (error) {
                console.error('ä»ç¼“å­˜åŠ è½½é¡¹ç›®å¤±è´¥:', error);
                return [];
            }
        }

        // æ›´æ–°æ ‡ç­¾é¡µè®¡æ•°
        function updateTabCounts() {
            const tabs = document.querySelectorAll('.tab');
            const ongoingCount = ongoingProjects.length;
            const settledCount = settledProjects.length;
            
            // åªæœ‰å½“è®¡æ•°å‘ç”Ÿå˜åŒ–æ—¶æ‰æ›´æ–°DOMå’Œè¾“å‡ºæ—¥å¿—
            if (tabs[0].textContent !== `åœ¨å»ºé¡¹ç›® (${ongoingCount})` || 
                tabs[1].textContent !== `å·²ç»“æ¸…é¡¹ç›® (${settledCount})`) {
                tabs[0].textContent = `åœ¨å»ºé¡¹ç›® (${ongoingCount})`;
                tabs[1].textContent = `å·²ç»“æ¸…é¡¹ç›® (${settledCount})`;
                // console.log(`âœ… æ ‡ç­¾é¡µè®¡æ•°å·²æ›´æ–°ï¼šåœ¨å»ºé¡¹ç›® ${ongoingCount} ä¸ªï¼Œå·²ç»“æ¸…é¡¹ç›® ${settledCount} ä¸ª`);
            }
        }

        // æ¸²æŸ“é¡¹ç›®å¡ç‰‡
        // æ—¥æœŸæ ¼å¼åŒ–å‡½æ•°
        function formatDate(dateString) {
            if (!dateString) return 'æ— æ—¥æœŸ';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'æ— æ•ˆæ—¥æœŸ';
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // è·å–é¡¹ç›®çš„ä¸Šæ¬¡è®°å·¥æ—¥æœŸ
        function getLastWorkDate(projectId) {
            try {
                // ä»currentUserè·å–user_id
                let userId = 'default';
                try {
                    const currentUserStr = localStorage.getItem('currentUser');
                    if (currentUserStr) {
                        const currentUser = JSON.parse(currentUserStr);
                        userId = currentUser.user_id || 'default';
                    }
                } catch (e) {
                    console.error('è§£æcurrentUserå¤±è´¥:', e);
                }

                // è·å–è€ƒå‹¤è®°å½•æ•°æ®
                const workRecordsKey = 'work_records_' + userId;
                const workRecords = localStorage.getItem(workRecordsKey);
                
                // è·å–ç»“ç®—è®°å½•æ•°æ®
                const settlementRecordsKey = 'settlementRecords';
                const settlementRecordsData = localStorage.getItem(settlementRecordsKey);
                
                let allDates = [];
                
                // å¤„ç†è€ƒå‹¤è®°å½•
                if (workRecords) {
                    const records = JSON.parse(workRecords);
                    const projectRecords = records.filter(record => record.project_id === projectId);
                    
                    projectRecords.forEach(record => {
                        if (record.record_date) {
                            allDates.push(new Date(record.record_date));
                        }
                    });
                }
                
                // å¤„ç†ç»“ç®—è®°å½•
                if (settlementRecordsData) {
                    const settlementRecords = JSON.parse(settlementRecordsData);
                    const projectSettlements = settlementRecords.filter(record => record.project_id === projectId);
                    
                    projectSettlements.forEach(record => {
                        if (record.record_date) {
                            allDates.push(new Date(record.record_date));
                        }
                    });
                }
                
                if (allDates.length > 0) {
                    // æ‰¾å‡ºæœ€å¤§çš„æ—¥æœŸ
                    const maxDate = new Date(Math.max(...allDates));
                    // æ ¼å¼åŒ–ä¸º"XæœˆXæ—¥"æ ¼å¼
                    const month = maxDate.getMonth() + 1;
                    const day = maxDate.getDate();
                    return `${month}æœˆ${day}æ—¥`;
                }
                
                return 'æœªè®°å·¥';
            } catch (error) {
                console.error('è·å–ä¸Šæ¬¡è®°å·¥æ—¥æœŸå¤±è´¥:', error);
                return 'æœªè®°å·¥';
            }
        }

        async function renderProjects(tab = 'ongoing') {
            const projectsGrid = document.getElementById('projectsGrid');
            
            let projectsToRender = [];
            switch (tab) {
                case 'ongoing':
                    projectsToRender = ongoingProjects;
                    break;
                case 'settled':
                    projectsToRender = settledProjects;
                    break;
                default:
                    projectsToRender = ongoingProjects;
            }

            // éšè—æˆ–æ˜¾ç¤ºæ–°å»ºé¡¹ç›®æŒ‰é’®
            const newProjectBtn = document.querySelector('.new-project-btn');
            if (tab === 'settled') {
                newProjectBtn.style.display = 'none';
            } else {
                newProjectBtn.style.display = 'flex';
            }

            // æ¸…ç©ºæ‰€æœ‰ç°æœ‰å¡ç‰‡ï¼Œé¿å…åŠ¨ç”»å†²çª
            projectsGrid.innerHTML = '';

            // æ¸²æŸ“é¡¹ç›®å¡ç‰‡
            projectsToRender.forEach((project) => {
                // åˆ›å»ºæ–°å¡ç‰‡
                const projectCard = document.createElement('div');
                projectCard.className = 'project-card';
                projectCard.dataset.projectId = project.project_id;
                
                // è·å–è¯¥é¡¹ç›®çš„åœ¨èŒäººæ•°ï¼ˆä»å†…å­˜ä¸­è¯»å–ï¼‰
                const activeEmployeeCount = project.employeeCount || 0;
                
                // æ ¹æ®é¡¹ç›®ç±»å‹ç”Ÿæˆä¸åŒçš„å¡ç‰‡å†…å®¹
                let cardContent = '';
                
                // å¸¦ç­é¡¹ç›®æ ‡è¯†
                const foremanBadge = project.is_foreman_project ? 
                    `<span style="background-color: #fff7e6; color: #fa8c16; -webkit-text-fill-color: #fa8c16; padding: 2px 8px; border-radius: 4px; font-size: 12px; border: 1px solid #ffd591; margin-left: 8px; vertical-align: middle; display: inline-block; font-weight: normal;">å¸¦ç­</span>` : '';
                
                if (tab === 'settled') {
                    // å·²ç»“æ¸…é¡¹ç›®çš„å¡ç‰‡å†…å®¹
                    cardContent = `
                        <div class="project-header">
                            <div class="project-name" style="display: flex; align-items: center;">
                                <span>${project.project_name}</span>
                                ${foremanBadge}
                            </div>
                        </div>
                        <div class="project-info">
                                <div class="project-count">ç­ç»„äººæ•°: <span class="project-count-number" data-field="employeeCount">${activeEmployeeCount}</span>äºº</div>
                                <div class="project-date"><span class="last-work-label">ä¸Šæ¬¡è®°å·¥</span><br><span class="last-work-date">${getLastWorkDate(project.project_id)}</span></div>
                            </div>
                        <div class="project-actions">
                            <div class="project-actions-left">
                                <!-- å·²ç»“æ¸…é¡¹ç›®æ²¡æœ‰é¡¹ç›®è®¾ç½®æŒ‰é’® -->
                            </div>
                            <div class="project-actions-right">
                                <button class="action-btn restore-btn" onclick="window.restoreProject('${project.project_id}')" style="background: transparent; border: none; box-shadow: none; padding: 5px 10px; color: #333; display: flex; align-items: center;">
                                    <i class="fas fa-reply" style="color: #4379FF; margin-right: 6px; font-size: 16px;"></i>
                                    æ¢å¤ä¸ºåœ¨å»º
                                </button>
                                <button class="action-btn delete-btn" onclick="window.deleteProject('${project.project_id}')" style="background: transparent; border: none; box-shadow: none; padding: 5px 10px; color: #333; display: flex; align-items: center;">
                                    <i class="fas fa-trash-alt" style="color: #FF2B2B; margin-right: 6px; font-size: 16px;"></i>
                                    åˆ é™¤
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    // åœ¨å»ºé¡¹ç›®çš„å¡ç‰‡å†…å®¹
                    cardContent = `
                        <div class="project-header">
                            <div class="project-name" style="display: flex; align-items: center;">
                                <span>${project.project_name}</span>
                                ${foremanBadge}
                            </div>
                        </div>
                        <div class="project-info">
                                <div class="project-count">ç­ç»„äººæ•°: <span class="project-count-number" data-field="employeeCount">${activeEmployeeCount}</span>äºº</div>
                                <div class="project-date"><span class="last-work-label">ä¸Šæ¬¡è®°å·¥</span><br><span class="last-work-date">${getLastWorkDate(project.project_id)}</span></div>
                            </div>
                        <div class="project-actions">
                            <div class="project-actions-left">
                                <button class="action-btn settings-btn" onclick="projectSettings('${project.project_id}')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 4px; display: inline-block; vertical-align: middle;">
                                        <circle cx="12" cy="12" r="3"></circle>
                                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                                    </svg>
                                    é¡¹ç›®è®¾ç½®
                                </button>
                            </div>
                            <div class="project-actions-right">
                                <button class="action-btn settlement-btn" onclick="window.location.href='ç»“ç®—å€Ÿæ”¯.html?project_id=${project.project_id}&project_name=${encodeURIComponent(project.project_name)}'">
                                    <i class="fas fa-hand-holding-usd"></i> ç»“ç®—/å€Ÿæ”¯
                                </button>
                                <button class="action-btn record-btn" onclick="goToRecord('${project.project_name}', '${project.project_id}')">
                                    <i class="fas fa-edit"></i> è®° å·¥
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                // è®¾ç½®å¡ç‰‡å†…å®¹
                projectCard.innerHTML = cardContent;
                
                // åªæœ‰åœ¨å»ºé¡¹ç›®æ‰æ·»åŠ å¡ç‰‡ç‚¹å‡»äº‹ä»¶ï¼ˆç©ºç™½åŒºåŸŸï¼‰ï¼Œå·²ç»“æ¸…é¡¹ç›®ä¸æ·»åŠ 
                if (tab !== 'settled') {
                    // æ·»åŠ å¡ç‰‡ç‚¹å‡»äº‹ä»¶ï¼ˆç©ºç™½åŒºåŸŸï¼‰
                    projectCard.addEventListener('click', function(e) {
                        // æ£€æŸ¥ç‚¹å‡»çš„æ˜¯å¦æ˜¯æŒ‰é’®
                        if (e.target.closest('button')) {
                            return; // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®ï¼Œä¸æ‰§è¡Œè·³è½¬
                        }
                        // è®¾ç½®é¡¹ç›®åç§°åˆ°localStorageï¼Œç”¨äºé¦–é¡µæ ‡é¢˜æ˜¾ç¤º
                        localStorage.setItem('currentProjectName', project.project_name);
                        localStorage.setItem('currentProjectId', project.project_id);
                        // è·³è½¬åˆ°é¡¹ç›®ä¸»é¡µï¼Œä¼ é€’é¡¹ç›®åç§°å‚æ•°
                        const encodedProjectName = encodeURIComponent(project.project_name);
                        window.location.href = 'é¡¹ç›®ä¸»é¡µ.html?project_id=' + project.project_id + '&project_name=' + encodedProjectName;
                    });
                }
                
                // æ·»åŠ åˆ°ç½‘æ ¼
                projectsGrid.appendChild(projectCard);
            });
        }

        // åˆå§‹åŒ–æ¨¡æ€æ¡†ç›¸å…³å…ƒç´ 
        const modalOverlay = document.getElementById('projectModal');
        const modalTitle = document.getElementById('modalTitle');
        const projectnameInput = document.getElementById('projectname');
        const projectaddressInput = document.getElementById('projectaddress');
        const regularHoursInput = document.getElementById('regularHours');
        const overtimeHoursInput = document.getElementById('overtimeHours');
        const workerCountElement = document.getElementById('workerCount');
        const statisticsElement = document.getElementById('statistics');
        const unsettledElement = document.getElementById('unsettled');
        const markAsSettledBtn = document.getElementById('markAsSettled');
        const closeModalBtn = document.getElementById('closeModal');
        const cancelProjectBtn = document.getElementById('cancelProject');
        const confirmProjectBtn = document.getElementById('confirmProject');
        let currentProjectid = null;

        // ä¸ºè®¾ä¸ºå·²ç»“æ¸…æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
        markAsSettledBtn.addEventListener('click', markAsSettled);

        // è·³è½¬åˆ°è®°å·¥é¡µé¢å‡½æ•°
        function goToRecord(project_name, project_id) {
            try {
                // è®°å·¥æŒ‰é’®ç‚¹å‡»ï¼Œé¡¹ç›®ID: ${project_id}
                
                if (!project_id) {
                    console.error('é¡¹ç›®IDä¸ºç©ºï¼Œæ— æ³•æ‰§è¡Œè·³è½¬');
                    showNotification('é¡¹ç›®IDè·å–å¤±è´¥ï¼Œè¯·é‡è¯•', true);
                    return;
                }
                
                // å°†é¡¹ç›®IDå’Œé¡¹ç›®åç§°ä½œä¸ºURLå‚æ•°ä¼ é€’åˆ°è®°å·¥é¡µé¢
                const encodedProjectName = encodeURIComponent(project_name);
                const targetUrl = `è®°å·¥.html?project_id=${project_id}&project_name=${encodedProjectName}`;
                
                // æ£€æŸ¥æ˜¯å¦åœ¨iframeä¸­
                const inIframe = window.parent && window.parent !== window;
                
                // ç®€åŒ–å¯¼èˆªé€»è¾‘
                if (inIframe) {
                    // åœ¨iframeä¸­ï¼Œé€šè¿‡çˆ¶çª—å£å¯¼èˆª
                    window.parent.postMessage({
                        type: 'navigate',
                        page: targetUrl,
                        title: 'è®°å·¥'
                    }, window.location.origin);
                    
                    // åŒæ—¶æ‰§è¡Œç›´æ¥è·³è½¬ä»¥æé«˜å“åº”é€Ÿåº¦
                    window.location.href = targetUrl;
                } else {
                    // ç›´æ¥è®¿é—®ï¼Œæ­£å¸¸è·³è½¬
                    window.location.href = targetUrl;
                }
            } catch (error) {
                // ä¿ç•™é”™è¯¯æ—¥å¿—ä»¥ä¾¿è°ƒè¯•
                console.error('æ‰§è¡ŒgoToRecordå‡½æ•°æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showNotification('è·³è½¬å¤±è´¥ï¼Œè¯·é‡è¯•', true);
            }
        }

        // æ‰“å¼€æ¨¡æ€æ¡†
        function openModal() {
            modalOverlay.classList.add('active');
            // æ³¨æ„ï¼šä¸å†æ¸…ç©ºè¾“å…¥æ¡†ï¼Œå› ä¸ºprojectSettingså‡½æ•°ä¼šåœ¨è°ƒç”¨openModalå‰å¡«å……æ•°æ®
            // æ–°å»ºé¡¹ç›®æ—¶ä¼šæ‰‹åŠ¨æ¸…ç©ºè¾“å…¥æ¡†
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            modalOverlay.classList.remove('active');
            // é‡ç½®æ¨¡æ€æ¡†çŠ¶æ€
            modalTitle.textContent = 'æ–°å»ºé¡¹ç›®';
            document.getElementById('projectSettingsInfo').style.display = 'none';
            markAsSettledBtn.style.display = 'none';

            // æ¢å¤æ˜¾ç¤ºé¡¹ç›®åˆ—è¡¨å’Œæ ‡ç­¾ï¼ˆå¦‚æœä¹‹å‰è¢«éšè—äº†ï¼‰
            const projectsGrid = document.getElementById('projectsGrid');
            const tabsContainer = document.querySelector('.tabs');
            if (projectsGrid && projectsGrid.style.display === 'none') {
                projectsGrid.style.display = 'grid';
            }
            if (tabsContainer && tabsContainer.style.display === 'none') {
                tabsContainer.style.display = 'flex';
            }

            if (!document.getElementById('confirmSettleModal').classList.contains('active') &&
                !document.getElementById('confirmRestoreModal').classList.contains('active')) {
                currentProjectid = null;
            }
        }

        // è®¾ä¸ºå·²ç»“æ¸…
        function markAsSettled() {
            if (currentProjectid) {
                // ä¿å­˜é¡¹ç›®IDåˆ°ç¡®è®¤æ¨¡æ€æ¡†ï¼Œé¿å…æ¨¡æ€æ¡†å…³é—­åä¸¢å¤±
                document.getElementById('confirmSettleModal').dataset.projectId = currentProjectid;
                // æ˜¾ç¤ºç¡®è®¤æ¨¡æ€æ¡†
                openConfirmSettleModal();
            } else {
                console.error('å½“å‰é¡¹ç›®IDä¸ºç©ºï¼Œæ— æ³•è®¾ä¸ºå·²ç»“æ¸…');
                showNotification('è¯·å…ˆé€‰æ‹©é¡¹ç›®', true);
            }
        }

        // æ‰§è¡Œè®¾ä¸ºå·²ç»“æ¸…æ“ä½œ
        async function executeMarkAsSettled(projectId = null) {
            // ä½¿ç”¨ä¼ å…¥çš„é¡¹ç›®IDï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨currentProjectid
            const targetProjectId = projectId || currentProjectid;
            if (targetProjectId) {
                // æŸ¥æ‰¾é¡¹ç›® - ä½¿ç”¨æ­£ç¡®çš„å­—æ®µå
                const projectIndex = ongoingProjects.findIndex(p => p.project_id === targetProjectId);
                if (projectIndex !== -1) {
                    const project = ongoingProjects[projectIndex];
                    
                    try {
                        // è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
                        let currentUser = {};
                        try {
                            const currentUserStr = localStorage.getItem('currentUser');
                            if (currentUserStr) {
                                currentUser = JSON.parse(currentUserStr);
                            }
                        } catch (e) {
                            console.error('è§£æcurrentUserå¤±è´¥:', e);
                        }
                        
                        if (!currentUser.user_id) {
                            console.error('æœªæ‰¾åˆ°ç”¨æˆ·ID');
                            showNotification('æ“ä½œå¤±è´¥ï¼šæœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯', true);
                            return;
                        }
                        
                        // ä½¿ç”¨ç»Ÿä¸€çš„æ—¶é—´å¤„ç†å‡½æ•°
                        const beijingTimeString = getBeijingTimeString();
                        const isoTimeString = getCurrentTimeISOString();
                        
                        // æŒ‰ç…§æ•°æ®åº“åˆ—é¡ºåºå®šä¹‰ï¼šproject_idã€user_idã€project_nameã€addressã€regular_hoursã€overtime_hoursã€statusã€updated_at
                        const updatedProjectData = {
                            project_id: targetProjectId,  // é¡¹ç›®å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆä¿æŒé¡ºåºï¼Œè™½ç„¶æ˜¯ä¸å¯å˜å­—æ®µï¼‰
                            user_id: project.user_id || currentUser.user_id,
                            project_name: project.project_name || 'æœªå‘½åé¡¹ç›®',
                            address: project.address || '',
                            regular_hours: project.regular_hours || 0,
                            overtime_hours: project.overtime_hours || 0,
                            status: 'ç»“æ¸…',  // æ›´æ–°ä¸ºç»“æ¸…çŠ¶æ€
                            updated_at: isoTimeString  // ä½¿ç”¨ISOæ—¶é—´æ ¼å¼è¿›è¡Œå†²çªæ£€æµ‹
                        };

                        // æ¸…ç†æ•°æ®ï¼Œåªæ›´æ–°statuså’Œupdated_atå­—æ®µ
                        const cleanProjectData = {
                            project_id: updatedProjectData.project_id,
                            status: updatedProjectData.status,
                            updated_at: updatedProjectData.updated_at
                        };

                        // ä»åœ¨å»ºé¡¹ç›®ç§»é™¤
                        ongoingProjects.splice(projectIndex, 1);
                        // æ·»åŠ åˆ°å·²ç»“æ¸…é¡¹ç›®ï¼Œå¹¶æ›´æ–°çŠ¶æ€
                        const settledProject = {
                            ...project,
                            project_id: project.project_id,
                            user_id: project.user_id || currentUser.user_id,
                            project_name: project.project_name,
                            regular_hours: project.regular_hours || 0,
                            overtime_hours: project.overtime_hours || 0,
                            status: 'ç»“æ¸…',
                            updated_at: isoTimeString  // ä½¿ç”¨ISOæ—¶é—´æ ¼å¼è¿›è¡Œå†²çªæ£€æµ‹
                        };
                        settledProjects.push(settledProject);

                        // æ›´æ–°æœ¬åœ°ç´¢å¼•
                        await updateLocalProjectIndex();

                        // æ›´æ–°UI
                        renderProjects('ongoing');
                        updateTabCounts();
                        closeModal();
                        closeConfirmSettleModal();
                        // æ£€æŸ¥ç½‘ç»œçŠ¶æ€å¹¶æ˜¾ç¤ºç›¸åº”çš„æç¤ºä¿¡æ¯
                        const isOnline = window.offlineSyncService && window.offlineSyncService.syncStatus.isOnline;
                        showNotification(isOnline ? 'é¡¹ç›®å·²è®¾ä¸ºç»“æ¸…çŠ¶æ€' : 'é¡¹ç›®å·²è®¾ä¸ºç»“æ¸…çŠ¶æ€ï¼Œå°†åœ¨ç½‘ç»œæ¢å¤ååŒæ­¥åˆ°äº‘ç«¯', false);
                        
                        console.log('âœ… é¡¹ç›®çŠ¶æ€å·²æ›´æ–°åˆ°æœ¬åœ°');
                        
                        // å¼‚æ­¥æ›´æ–°äº‘ç«¯æ•°æ®ï¼ˆåå°å¤„ç†ï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒï¼‰
                        setTimeout(() => {
                            handleProjectStatusChangeToSupabase(cleanProjectData, targetProjectId, false); // ä¼ å…¥falseè¡¨ç¤ºä¸æ˜¾ç¤ºé€šçŸ¥
                        }, 0);
                        
                    } catch (error) {
                        console.error('æ‰§è¡Œè®¾ä¸ºå·²ç»“æ¸…æ“ä½œå¤±è´¥:', error);
                        showNotification('æ“ä½œå¤±è´¥: ' + error.message, true);
                        return;
                    }
                }
            }
        }

        // åˆ›å»ºæ–°é¡¹ç›®
        function createNewProject() {
            currentProjectid = null; // é‡ç½®ä¸ºnullï¼Œç¡®ä¿æ‰§è¡Œåˆ›å»ºæ“ä½œ
            
            // ç¡®ä¿æŒ‰é’®å¯è§ä¸”è¾“å…¥æ¡†å¯ç”¨ï¼ˆé‡ç½®å¯èƒ½è¢«å¸¦ç­é¡¹ç›®ç¦ç”¨çš„çŠ¶æ€ï¼‰
            if (confirmProjectBtn) confirmProjectBtn.style.display = 'flex';
            if (projectnameInput) projectnameInput.disabled = false;
            if (projectaddressInput) projectaddressInput.disabled = false;
            if (regularHoursInput) regularHoursInput.disabled = false;
            if (overtimeHoursInput) overtimeHoursInput.disabled = false;

            // æ¸…ç©ºè¡¨å•ï¼Œç¡®ä¿æ²¡æœ‰æ®‹ç•™æ•°æ®
            projectnameInput.value = '';
            projectaddressInput.value = '';
            projectaddressInput.placeholder = 'è¯·è¾“å…¥é¡¹ç›®åœ°å€'; // é‡ç½®ä¸ºé»˜è®¤å ä½ç¬¦
            regularHoursInput.value = '';
            overtimeHoursInput.value = '';
            // é‡ç½®æ¨¡æ€æ¡†æ ‡é¢˜
            modalTitle.textContent = 'æ–°å»ºé¡¹ç›®';
            // éšè—ä»»ä½•ç¼–è¾‘æ¨¡å¼ä¸‹çš„ç‰¹æ®Šå…ƒç´ 
            document.getElementById('projectSettingsInfo').style.display = 'none';
            openModal();
        }

        // ç¡®è®¤æ›´æ–°é¡¹ç›®ï¼ˆé¡¹ç›®è®¾ç½®ä¿å­˜ï¼‰
        async function confirmUpdateProject() {
            // æ£€æŸ¥æ˜¯å¦æ˜¯æ›´æ–°é¡¹ç›®ï¼ˆcurrentProjectidå­˜åœ¨ï¼‰è¿˜æ˜¯æ–°å»ºé¡¹ç›®
            if (currentProjectid) {
                console.log('æ‰§è¡Œæ›´æ–°é¡¹ç›®ä¿å­˜æ“ä½œ');
            } else {
                console.log('æ‰§è¡Œæ–°å»ºé¡¹ç›®ä¿å­˜æ“ä½œ');
            }
            const projectname = projectnameInput.value.trim();
            const address = projectaddressInput.value.trim();
            const regularHours = parseFloat(regularHoursInput.value) || 0;
            const overtimeHours = parseFloat(overtimeHoursInput.value) || 0;

            if (!projectname) {
                showNotification('è¯·è¾“å…¥é¡¹ç›®åç§°', true);
                return;
            }

            try {
                const phone = localStorage.getItem('loggedInPhone');
                if (!phone) {
                    showNotification('æœªæ‰¾åˆ°ç™»å½•ä¿¡æ¯', true);
                    return;
                }
                
                // å¦‚æœcurrentProjectidä¸å­˜åœ¨ï¼Œè¯´æ˜æ˜¯æ–°å»ºé¡¹ç›®
                if (!currentProjectid) {
                    // æ‰§è¡Œåˆ›å»ºé¡¹ç›®é€»è¾‘
                    await confirmCreateProject();
                    return;
                }

                // æŸ¥æ‰¾åŸé¡¹ç›®ä¿¡æ¯
                let originalProject;
                let originalStatus = '';
                
                if (ongoingProjects.some(p => p.project_id === currentProjectid)) {
                    originalProject = ongoingProjects.find(p => p.project_id === currentProjectid);
                    originalStatus = 'åœ¨å»º';
                } else if (settledProjects.some(p => p.project_id === currentProjectid)) {
                    originalProject = settledProjects.find(p => p.project_id === currentProjectid);
                    originalStatus = 'ç»“æ¸…';
                }

                if (!originalProject) {
                    // æœªæ‰¾åˆ°åŸé¡¹ç›®ä¿¡æ¯ï¼Œæ”¹ä¸ºåˆ›å»ºæ–°é¡¹ç›®
                    await confirmCreateProject();
                    return;
                }

                // æ£€æŸ¥æ–°çš„é¡¹ç›®åç§°æ˜¯å¦å·²è¢«å…¶ä»–é¡¹ç›®ä½¿ç”¨ï¼ˆæ’é™¤å½“å‰é¡¹ç›®ï¼‰
                const allProjects = [...ongoingProjects, ...settledProjects];
                const isNameDuplicate = allProjects.some(project => 
                    project.project_name === projectname && project.project_id !== currentProjectid
                );
                
                if (isNameDuplicate) {
                    showNotification('è¯¥é¡¹ç›®åç§°å·²å­˜åœ¨ï¼', true);
                    return;
                }

                // è·å–åŒ—äº¬æ—¶é—´å¹¶åˆ›å»ºæ—¶é—´æˆ³
                const beijingTime = getBeijingTimeString();
                const currentTimeISO = getCurrentTimeISOString();
                
                // è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
                let currentUser = {};
                try {
                    const currentUserStr = localStorage.getItem('currentUser');
                    if (currentUserStr) {
                        currentUser = JSON.parse(currentUserStr);
                    }
                } catch (e) {
                    console.error('è§£æcurrentUserå¤±è´¥:', e);
                }
                
                // åˆ›å»ºæ›´æ–°åçš„é¡¹ç›®æ•°æ®ï¼ˆä»…åŒ…å«æ•°æ®åº“è¡¨å­˜åœ¨çš„åŸºæœ¬å­—æ®µï¼‰
                const updatedProjectData = {
                    project_id: currentProjectid,
                    user_id: originalProject.user_id || currentUser.user_id,
                    project_name: projectname,
                    address: address || '',
                    regular_hours: regularHours,
                    overtime_hours: overtimeHours,
                    status: originalStatus,
                    created_at: originalProject.created_at, // ä¿æŒåˆ›å»ºæ—¶é—´ä¸å˜
                    updated_at: currentTimeISO,
                    // ä¿æŒå¸¦ç­é¡¹ç›®æ ‡è¯†
                    is_foreman_project: originalProject.is_foreman_project
                };

                // å…ˆæ›´æ–°æœ¬åœ°æ•°æ®ï¼ˆç«‹å³åé¦ˆç”¨æˆ·ï¼‰
                try {
                    await updateProjectInMemory(currentProjectid, updatedProjectData);
                    await updateLocalProjectIndex();
                    console.log('âœ… é¡¹ç›®å·²æ›´æ–°åˆ°æœ¬åœ°');
                } catch (error) {
                    console.error('æ›´æ–°é¡¹ç›®æ•°æ®åˆ°æœ¬åœ°å¤±è´¥', error);
                    showNotification('æ›´æ–°é¡¹ç›®å¤±è´¥: ' + error.message, true);
                    return;
                }

                // ä¿å­˜currentProjectidå‰¯æœ¬ï¼Œå› ä¸ºcloseModalä¼šå°†å…¶è®¾ä¸ºnull
                const projectIdForSync = currentProjectid;
                
                // å…³é—­æ¨¡æ€æ¡†å¹¶æ›´æ–°UI
                closeModal();
                renderProjects();
                updateTabCounts();

                // å¼‚æ­¥å¤„ç†äº‘ç«¯åŒæ­¥ï¼ˆåå°å¤„ç†ï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒï¼‰
                setTimeout(async () => {
                    const syncSuccess = await handleProjectUpdateToSupabase(updatedProjectData);
                    if (syncSuccess) {
                        showNotification('é¡¹ç›®æ›´æ–°æˆåŠŸ!', false);
                    } else {
                        showNotification('é¡¹ç›®æ›´æ–°æˆåŠŸï¼Œå°†åœ¨ç½‘ç»œæ¢å¤ååŒæ­¥åˆ°äº‘ç«¯', false);
                    }
                }, 0);
            } catch (error) {
                console.error('æ›´æ–°é¡¹ç›®å¤±è´¥:', error);
                showNotification('æ›´æ–°é¡¹ç›®å¤±è´¥: ' + error.message, true);
            }
        }

        // å¤„ç†é¡¹ç›®æ·»åŠ åˆ°Supabase
        async function handleProjectAddToSupabase(projectData) {
            try {
                // æ£€æŸ¥æ˜¯å¦åœ¨çº¿
                if (navigator.onLine && window.supabase && typeof window.supabase.from === 'function') {
                    // åœ¨çº¿æ—¶ç›´æ¥ä¿å­˜åˆ°äº‘ç«¯
                const { data, error } = await window.supabase
                    .from('projects')
                    .insert(projectData);
                
                if (error) {
                    console.error('âŒ åˆ›å»ºé¡¹ç›®å¤±è´¥ - è¯¦ç»†é”™è¯¯:', error);
                    console.error('âŒ é”™è¯¯è¯¦æƒ… - ä»£ç :', error.code);
                    console.error('âŒ é”™è¯¯è¯¦æƒ… - æ¶ˆæ¯:', error.message);
                    console.error('âŒ é”™è¯¯è¯¦æƒ… - è¯¦æƒ…:', error.details);
                    console.error('âŒ å‘é€çš„æ•°æ®:', projectData);
                    
                    // å¦‚æœäº‘ç«¯ä¿å­˜å¤±è´¥ï¼Œæ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—
                    if (window.offlineSyncService) {
                        await window.offlineSyncService.addToSyncQueue('add', projectData, projectData.project_id, 'project');
                    }
                    return false;
                } else {
                    console.log('âœ… é¡¹ç›®å·²æˆåŠŸä¿å­˜åˆ°Supabase');
                    return true;
                }
                } else {
                    console.log('ğŸ“¡ ç¦»çº¿çŠ¶æ€ï¼Œæ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—');
                    // ç¦»çº¿çŠ¶æ€ï¼Œæ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—
                    if (window.offlineSyncService) {
                        await window.offlineSyncService.addToSyncQueue('add', projectData, projectData.project_id, 'project');
                    }
                    return false;
                }
            } catch (error) {
                console.error('ğŸ’¥ ä¿å­˜é¡¹ç›®æ•°æ®åˆ°äº‘ç«¯å¤±è´¥:', error);
                console.error('ğŸ’¥ é”™è¯¯å †æ ˆ:', error.stack);
                // å‘ç”Ÿå¼‚å¸¸æ—¶æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—
                if (window.offlineSyncService) {
                    await window.offlineSyncService.addToSyncQueue('add', projectData, projectData.project_id, 'project');
                }
                return false;
            }
        }

        // å¤„ç†é¡¹ç›®æ›´æ–°åˆ°Supabase
        async function handleProjectUpdateToSupabase(projectData) {
            try {
                // æ£€æŸ¥æ˜¯å¦åœ¨çº¿
                if (navigator.onLine && window.supabase && typeof window.supabase.from === 'function') {
                    // åœ¨çº¿æ—¶ç›´æ¥æ›´æ–°åˆ°äº‘ç«¯
                    const { error } = await window.supabase
                        .from('projects')
                        .update(projectData)
                        .eq('project_id', projectData.project_id);
                    
                    if (error) {
                        console.error('âŒ æ›´æ–°é¡¹ç›®å¤±è´¥ - è¯¦ç»†é”™è¯¯:', error);
                        console.error('âŒ é”™è¯¯è¯¦æƒ… - ä»£ç :', error.code);
                        console.error('âŒ é”™è¯¯è¯¦æƒ… - æ¶ˆæ¯:', error.message);
                        console.error('âŒ é”™è¯¯è¯¦æƒ… - è¯¦æƒ…:', error.details);
                        console.error('âŒ å‘é€çš„æ•°æ®:', projectData);
                        
                        // å¦‚æœäº‘ç«¯æ›´æ–°å¤±è´¥ï¼Œæ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—
                        if (window.offlineSyncService) {
                            await window.offlineSyncService.addToSyncQueue('update', projectData, projectData.project_id, 'project');
                        }
                        return false;
                    } else {
                        console.log('âœ… é¡¹ç›®å·²æˆåŠŸæ›´æ–°åˆ°Supabase');
                        return true;
                    }
                } else {
                    console.log('ğŸ“¡ ç¦»çº¿çŠ¶æ€ï¼Œæ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—');
                    // ç¦»çº¿çŠ¶æ€ï¼Œæ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—
                    if (window.offlineSyncService) {
                        await window.offlineSyncService.addToSyncQueue('update', projectData, projectData.project_id, 'project');
                    }
                    return false;
                }
            } catch (error) {
                console.error('ğŸ’¥ æ›´æ–°é¡¹ç›®æ•°æ®åˆ°äº‘ç«¯å¤±è´¥:', error);
                console.error('ğŸ’¥ é”™è¯¯å †æ ˆ:', error.stack);
                // å‘ç”Ÿå¼‚å¸¸æ—¶æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—
                if (window.offlineSyncService) {
                    await window.offlineSyncService.addToSyncQueue('update', projectData, projectData.project_id, 'project');
                }
                return false;
            }
        }

        // ç¡®è®¤åˆ›å»ºé¡¹ç›®
        async function confirmCreateProject() {
            const projectname = projectnameInput.value.trim();
            const address = projectaddressInput.value.trim();
            const regularHours = parseFloat(regularHoursInput.value) || 0;
            const overtimeHours = parseFloat(overtimeHoursInput.value) || 0;

            if (!projectname) {
                showNotification('è¯·è¾“å…¥é¡¹ç›®åç§°', true);
                return;
            }

            // æ£€æŸ¥æœ¬åœ°é¡¹ç›®åˆ—è¡¨ä¸­æ˜¯å¦å·²å­˜åœ¨åŒåé¡¹ç›®
            const allProjects = [...ongoingProjects, ...settledProjects];
            const isLocalDuplicate = allProjects.some(project => project.project_name === projectname);
            
            if (isLocalDuplicate) {
                showNotification('è¯¥é¡¹ç›®åç§°å·²å­˜åœ¨ï¼', true);
                return;
            }

            // ç”Ÿæˆé¡¹ç›®ID (PRO_å‰ç¼€ + 16ä½éšæœºå­—ç¬¦)
            const project_id = 'PRO_' + Math.random().toString(36).substring(2, 12) + '_' + Math.random().toString(36).substring(2, 7);

            // è·å–åŒ—äº¬æ—¶é—´å¹¶åˆ›å»ºæ—¶é—´æˆ³
            const beijingTime = getBeijingTimeString();
            const currentTimeISO = getCurrentTimeISOString();
            
            // è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
            let currentUser = {};
            try {
                const currentUserStr = localStorage.getItem('currentUser');
                if (currentUserStr) {
                    currentUser = JSON.parse(currentUserStr);
                }
            } catch (e) {
                console.error('è§£æcurrentUserå¤±è´¥:', e);
            }
            
            // åˆ›å»ºæ–°é¡¹ç›®æ•°æ®ï¼ˆä»…åŒ…å«æ•°æ®åº“è¡¨å­˜åœ¨çš„åŸºæœ¬å­—æ®µï¼‰
            const newProjectData = {
                project_id: project_id,
                user_id: currentUser.user_id,
                project_name: projectname,
                address: address || '',
                regular_hours: regularHours,
                overtime_hours: overtimeHours,
                status: 'åœ¨å»º',
                created_at: currentTimeISO,
                updated_at: currentTimeISO
            };

            // å…ˆä¿å­˜åˆ°æœ¬åœ°ï¼ˆç«‹å³åé¦ˆç”¨æˆ·ï¼‰
            try {
                ongoingProjects.push(newProjectData);
                await updateLocalProjectIndex();
                console.log('âœ… é¡¹ç›®å·²ä¿å­˜åˆ°æœ¬åœ°');
            } catch (error) {
                console.error('ä¿å­˜é¡¹ç›®æ•°æ®åˆ°æœ¬åœ°å¤±è´¥:', error);
                showNotification('ä¿å­˜é¡¹ç›®å¤±è´¥: ' + error.message, true);
                return;
            }

            // å…³é—­æ¨¡æ€æ¡†å¹¶æ›´æ–°UI
            closeModal();
            renderProjects();
            updateTabCounts();

            // å¼‚æ­¥å¤„ç†äº‘ç«¯åŒæ­¥ï¼ˆåå°å¤„ç†ï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒï¼‰
            setTimeout(async () => {
                const syncSuccess = await handleProjectAddToSupabase(newProjectData);
                if (syncSuccess) {
                    showNotification('é¡¹ç›®åˆ›å»ºæˆåŠŸ!', false);
                } else {
                    showNotification('é¡¹ç›®åˆ›å»ºæˆåŠŸï¼Œå°†åœ¨ç½‘ç»œæ¢å¤ååŒæ­¥åˆ°äº‘ç«¯', false);
                }
            }, 0);
        }

        // æ›´æ–°é¡¹ç›®ç´¢å¼•
        async function updateProjectIndex() {
            try {
                const phone = localStorage.getItem('loggedInPhone');
                if (!phone) return;

                // ä½¿ç”¨æ•°æ®å­˜å‚¨æœåŠ¡å¤„ç†é¡¹ç›®ç´¢å¼•
                let index = { projects: [] };

                // å°è¯•åŠ è½½ç°æœ‰ç´¢å¼•
                try {
                    const storageKey = `project_index_${phone}`;
                    // ç›´æ¥ä»localStorageè·å–ç´¢å¼•æ•°æ®
                    const existingIndexStr = localStorage.getItem(storageKey);
                    if (existingIndexStr) {
                        index = JSON.parse(existingIndexStr);
                    }
                } catch (error) {
                    console.log('åˆ›å»ºæ–°ç´¢å¼•');
                }

                // æ›´æ–°é¡¹ç›®åˆ—è¡¨
                index.projects = projects.map(p => ({
                    id: p.project_id,  // ä½¿ç”¨project_idä½œä¸ºid
                    name: p.project_name,
                    date: p.date,
                    count: p.count
                }));

                console.log('é¡¹ç›®ç´¢å¼•å·²æ›´æ–°ï¼Œä¸å†ä½¿ç”¨JSONæ–‡ä»¶å­˜å‚¨');
            } catch (error) {
                console.error('æ›´æ–°é¡¹ç›®ç´¢å¼•å¤±è´¥:', error);
            }
        }

        // é¡¹ç›®ç›¸å…³å‡½æ•°
        async function projectSettings(project_id) {
            currentProjectid = project_id;
            
            try {
                // ä»æœ¬åœ°é¡¹ç›®æ•°æ®ä¸­æŸ¥æ‰¾åŒ¹é…çš„é¡¹ç›®
                let project = null;
                
                // å…ˆåœ¨è¿›è¡Œä¸­çš„é¡¹ç›®ä¸­æŸ¥æ‰¾ 
                project = ongoingProjects.find(p => p.project_id === project_id);
                
                // å¦‚æœåœ¨è¿›è¡Œä¸­çš„é¡¹ç›®ä¸­æ²¡æ‰¾åˆ°ï¼Œå†åˆ°å·²ç»“æ¸…çš„é¡¹ç›®ä¸­æŸ¥æ‰¾
                if (!project) {
                    project = settledProjects.find(p => p.project_id === project_id);
                }
                
                if (project) {
                    let projectStatus = project.status || 'åœ¨å»º';
                    
                    // è®¾ç½®æ¨¡æ€æ¡†æ ‡é¢˜å’Œå†…å®¹ - ä½¿ç”¨æœ¬åœ°æ•°æ®
                    modalTitle.textContent = 'é¡¹ç›®è®¾ç½®: ' + project.project_name;
                    
                    // æ˜¾ç¤ºé¡¹ç›®è®¾ç½®é¢å¤–ä¿¡æ¯
                    document.getElementById('projectSettingsInfo').style.display = 'block';

                    // æ£€æŸ¥æ˜¯å¦ä¸ºå¸¦ç­é¡¹ç›®ï¼Œå¦‚æœæ˜¯åˆ™ç¦æ­¢ä¿®æ”¹
                    if (project.is_foreman_project) {
                        // å¸¦ç­ä¸èƒ½ä¿®æ”¹é¡¹ç›®ä¿¡æ¯ï¼Œä¹Ÿä¸èƒ½è®¾ä¸ºå·²ç»“æ¸…
                        if (markAsSettledBtn) markAsSettledBtn.style.display = 'none';
                        if (confirmProjectBtn) confirmProjectBtn.style.display = 'none';
                        
                        // ç¦ç”¨è¾“å…¥æ¡†
                        if (projectnameInput) projectnameInput.disabled = true;
                        if (projectaddressInput) projectaddressInput.disabled = true;
                        if (regularHoursInput) regularHoursInput.disabled = true;
                        if (overtimeHoursInput) overtimeHoursInput.disabled = true;
                    } else {
                        // éå¸¦ç­é¡¹ç›®ï¼ˆæˆ–è€…æ˜¯é¡¹ç›®åˆ›å»ºè€…ï¼‰ï¼Œå…è®¸ä¿®æ”¹
                        if (confirmProjectBtn) confirmProjectBtn.style.display = 'flex';
                        
                        // å¯ç”¨è¾“å…¥æ¡†
                        if (projectnameInput) projectnameInput.disabled = false;
                        if (projectaddressInput) projectaddressInput.disabled = false;
                        if (regularHoursInput) regularHoursInput.disabled = false;
                        if (overtimeHoursInput) overtimeHoursInput.disabled = false;

                        // æ ¹æ®é¡¹ç›®çŠ¶æ€æ˜¾ç¤º/éšè—è®¾ä¸ºå·²ç»“æ¸…æŒ‰é’®
                        if (projectStatus === 'åœ¨å»º') {
                            if (markAsSettledBtn) markAsSettledBtn.style.display = 'flex';
                        } else {
                            if (markAsSettledBtn) markAsSettledBtn.style.display = 'none';
                        }
                    }

                    // ä½¿ç”¨æœ¬åœ°æ•°æ®å¡«å……è¾“å…¥æ¡†
                    if (projectnameInput && projectaddressInput && regularHoursInput && overtimeHoursInput) {
                        projectnameInput.value = project.project_name?.trim() || 'æœªå‘½åé¡¹ç›®';
                        
                        // å¤„ç†é¡¹ç›®åœ°å€ï¼šå¦‚æœä¸ºç©ºåˆ™è®¾ç½®å ä½ç¬¦
                        const addressValue = project.address?.trim() || '';
                        if (addressValue) {
                            projectaddressInput.value = addressValue;
                            projectaddressInput.placeholder = 'è¯·è¾“å…¥é¡¹ç›®åœ°å€';
                        } else {
                            projectaddressInput.value = '';
                            projectaddressInput.placeholder = 'åœ°å€æœªå¡«å†™';
                        }
                        
                        // ä»…ä½¿ç”¨å°å†™å­—æ®µå
                        regularHoursInput.value = project.regular_hours?.toString() || '0';
                        overtimeHoursInput.value = project.overtime_hours?.toString() || '0';
                        
                        // è§¦å‘è¾“å…¥äº‹ä»¶æ›´æ–°UI
                        projectnameInput.dispatchEvent(new Event('input'));
                        projectaddressInput.dispatchEvent(new Event('input'));
                        regularHoursInput.dispatchEvent(new Event('input'));
                    }
                    
                    // æ¸…é™¤ç¼“å­˜å¹¶å®æ—¶è®¡ç®—æœ€æ–°ç»Ÿè®¡æ•°æ®
                    window.projectStatisticsService.clearCache(project_id);
                    const stats = await window.projectStatisticsService.getProjectStatistics(project_id);
                    const employeeCount = await getEmployeeCount(project_id);
                    
                    // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–é‡‘é¢æ˜¾ç¤º
                    function formatAmount(amount) {
                        if (Number.isInteger(amount)) {
                            return amount;
                        } else {
                            return Math.floor(amount);
                        }
                    }
                    
                    // æ›´æ–°UIæ˜¾ç¤º
                    if (document.getElementById('presentWorkers')) {
                        document.getElementById('presentWorkers').innerHTML = '<span style="color: purple;">' + employeeCount + '</span>&nbsp;&nbsp;&nbsp;äºº';
                    }
                    
                    if (document.getElementById('statistics')) {
                        document.getElementById('statistics').innerHTML = '<span style="color: orange;">' + formatAmount(stats.æ€»å·¥èµ„) + '</span>&nbsp;&nbsp;&nbsp;å…ƒ';
                    }
                    
                    if (document.getElementById('unsettled')) {
                        document.getElementById('unsettled').innerHTML = '<span style="color: red;">' + formatAmount(stats.æœªç»“é‡‘é¢) + '</span>&nbsp;&nbsp;&nbsp;å…ƒ';
                    }
                    
                    // æ›´æ–°é¡¹ç›®å¯¹è±¡ä¸­çš„æ•°æ®ï¼Œç¡®ä¿ä¸‹æ¬¡æ‰“å¼€æ—¶ä¹Ÿæ˜¯æœ€æ–°çš„
                    project.employeeCount = employeeCount;
                    project.totalWage = stats.æ€»å·¥èµ„;
                    project.unsettledAmount = stats.æœªç»“é‡‘é¢;
                    
                    // æ˜¾ç¤ºæ¨¡æ€æ¡†
                    openModal();
                    
                    // âœ… æ¨¡æ€æ¡†æ‰“å¼€å®Œæˆ
                } else {
                    console.error('âŒ æœªåœ¨æœ¬åœ°é¡¹ç›®æ•°æ®ä¸­æ‰¾åˆ°é¡¹ç›®ï¼Œé¡¹ç›®ID:', projectId);
                    showNotification('æœªæ‰¾åˆ°é¡¹ç›®æ•°æ®', true);
                    return;
                }
            } catch (e) {
                console.error('ğŸ’¥ æŸ¥æ‰¾æœ¬åœ°é¡¹ç›®æ•°æ®å¼‚å¸¸:', e);
                showNotification('æŸ¥æ‰¾é¡¹ç›®æ•°æ®å¼‚å¸¸: ' + (e.message || e), true);
                return;
            }
        }

        function recordWork(project_id) {
            showNotification(`è®°å·¥: ${project_id}`, false);
        }
        

        // æ›´æ–°æœ¬åœ°é¡¹ç›®ç´¢å¼•
        async function updateLocalProjectIndex() {
            try {
                const allProjects = [
                    ...ongoingProjects.map(p => ({...p, status: 'åœ¨å»º'})),
                    ...settledProjects.map(p => ({...p, status: 'ç»“æ¸…'}))
                ];
                
                // è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
                let currentUser = {};
                let userId = 'default';
                try {
                    const currentUserStr = localStorage.getItem('currentUser');
                    if (currentUserStr) {
                        currentUser = JSON.parse(currentUserStr);
                        userId = currentUser.user_id || 'default';
                    }
                } catch (e) {
                    console.error('è§£æcurrentUserå¤±è´¥:', e);
                }
                
                // ä½¿ç”¨æ•°ç»„æ ¼å¼çš„project_cache_${userId}
                const cacheKey = 'project_cache_' + userId;
                localStorage.setItem(cacheKey, JSON.stringify(allProjects));
                
                // âœ… é¡¹ç›®å·²ä¿å­˜åˆ°æœ¬åœ°
            } catch (error) {
                console.error('æ›´æ–°é¡¹ç›®æ•°æ®å¤±è´¥:', error);
            }
        }

        function updateProjectInMemory(projectId, updatedProject) {
            // ä»ä¸¤ä¸ªæ•°ç»„ä¸­ç§»é™¤æ—§é¡¹ç›® 
            ongoingProjects = ongoingProjects.filter(p => p.project_id !== projectId);
            settledProjects = settledProjects.filter(p => p.project_id !== projectId);
            
            // æ ¹æ®é¡¹ç›®çŠ¶æ€æ·»åŠ åˆ°ç›¸åº”çš„æ•°ç»„
            if (updatedProject.status === 'ç»“æ¸…') {
                settledProjects.push(updatedProject);
            } else {
                ongoingProjects.push(updatedProject);
            }
            
            // æ›´æ–°æœ¬åœ°ç´¢å¼•
            updateLocalProjectIndex();
        }

        function settlement(projectId) {
            showNotification(`ç»“ç®—/å€Ÿæ”¯: ${projectId}`, false);
        }

        function recordWork(project_id) {
            showNotification(`è®°å·¥: ${project_id}`, false);
        }

        // äº‹ä»¶ç›‘å¬å™¨
        closeModalBtn.addEventListener('click', closeModal);
        cancelProjectBtn.addEventListener('click', closeModal);
        confirmProjectBtn.addEventListener('click', async function() {
            // æ£€æŸ¥æ˜¯å¦æ˜¯æ›´æ–°é¡¹ç›®ï¼ˆcurrentProjectidå­˜åœ¨ï¼‰è¿˜æ˜¯æ–°å»ºé¡¹ç›®
            if (currentProjectid) {
                console.log('ç‚¹å‡»é¡¹ç›®è®¾ç½®ç¡®è®¤æŒ‰é’®');
            } else {
                console.log('ç‚¹å‡»æ–°å»ºé¡¹ç›®ç¡®è®¤æŒ‰é’®');
            }
            await confirmUpdateProject();
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        modalOverlay.addEventListener('click', function(e) {
            if (e.target === modalOverlay) {
                closeModal();
            }
        });

        // ç¡®è®¤è®¾ä¸ºå·²ç»“æ¸…æ¨¡æ€æ¡†ç›¸å…³å‡½æ•°
        function openConfirmSettleModal() {
            document.getElementById('confirmSettleModal').classList.add('active');
        }

        function closeConfirmSettleModal() {
            document.getElementById('confirmSettleModal').classList.remove('active');
        }

        // ç¡®è®¤è®¾ä¸ºå·²ç»“æ¸…æ¨¡æ€æ¡†äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('closeConfirmSettleModal').addEventListener('click', closeConfirmSettleModal);
        document.getElementById('cancelSettleBtn').addEventListener('click', closeConfirmSettleModal);
        document.getElementById('confirmSettleBtn').addEventListener('click', async function() {
            // ä»ç¡®è®¤æ¨¡æ€æ¡†è·å–ä¿å­˜çš„é¡¹ç›®ID
            const projectId = document.getElementById('confirmSettleModal').dataset.projectId;
            if (projectId) {
                // ç¡®è®¤è®¾ä¸ºå·²ç»“æ¸…
                // ç›´æ¥ä¼ é€’é¡¹ç›®IDç»™executeMarkAsSettledå‡½æ•°ï¼Œé¿å…ä¾èµ–currentProjectid
                closeConfirmSettleModal();
                await executeMarkAsSettled(projectId);
            } else {
                console.error('æœªæ‰¾åˆ°é¡¹ç›®IDï¼Œæ— æ³•æ‰§è¡Œè®¾ä¸ºå·²ç»“æ¸…æ“ä½œ');
                showNotification('æ“ä½œå¤±è´¥ï¼šæœªæ‰¾åˆ°é¡¹ç›®ä¿¡æ¯', true);
            }
        });

        // ç‚¹å‡»ç¡®è®¤è®¾ä¸ºå·²ç»“æ¸…æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('confirmSettleModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeConfirmSettleModal();
            }
        });

        // ç¡®è®¤æ¢å¤ä¸ºåœ¨å»ºæ¨¡æ€æ¡†ç›¸å…³å‡½æ•°
        function openConfirmRestoreModal() {
            document.getElementById('confirmRestoreModal').classList.add('active');
        }

        function closeConfirmRestoreModal() {
            document.getElementById('confirmRestoreModal').classList.remove('active');
        }

        // ç¡®è®¤æ¢å¤ä¸ºåœ¨å»ºæ¨¡æ€æ¡†äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('closeConfirmRestoreModal').addEventListener('click', closeConfirmRestoreModal);
        document.getElementById('cancelRestoreBtn').addEventListener('click', closeConfirmRestoreModal);
        document.getElementById('confirmRestoreBtn').addEventListener('click', async function() {
            closeConfirmRestoreModal();
            await executeRestoreProject();
        });

        // åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('closeConfirmDeleteModal').addEventListener('click', closeConfirmDeleteModal);
        document.getElementById('cancelDeleteBtn').addEventListener('click', closeConfirmDeleteModal);
        document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
            await executeDeleteProject();
        });

        // ç‚¹å‡»ç¡®è®¤æ¢å¤ä¸ºåœ¨å»ºæ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('confirmRestoreModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeConfirmRestoreModal();
            }
        });

        // ç‚¹å‡»åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('confirmDeleteModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeConfirmDeleteModal();
            }
        });

        // ç›‘å¬åˆ é™¤ç¡®è®¤è¾“å…¥æ¡†çš„é”®ç›˜äº‹ä»¶ï¼Œæ”¯æŒEnteré”®ç¡®è®¤
        document.getElementById('deleteConfirmationCode').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault(); // é˜²æ­¢å¯èƒ½çš„è¡¨å•æäº¤
                document.getElementById('confirmDeleteBtn').click();
            }
        });

        let projectToRestoreId = null;

        // æ‰§è¡Œæ¢å¤é¡¹ç›®æ“ä½œ
        async function executeRestoreProject() {
            if (!projectToRestoreId) return;

            try {
                // æŸ¥æ‰¾é¡¹ç›® - ä½¿ç”¨æ­£ç¡®çš„project_idå­—æ®µ
                const projectIndex = settledProjects.findIndex(p => p.project_id === projectToRestoreId);
                if (projectIndex === -1) {
                    showNotification('æœªæ‰¾åˆ°é¡¹ç›®', true);
                    return;
                }
                const project = settledProjects[projectIndex];
                
                // è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
                let currentUser = {};
                try {
                    const currentUserStr = localStorage.getItem('currentUser');
                    if (currentUserStr) {
                        currentUser = JSON.parse(currentUserStr);
                    }
                } catch (e) {
                    console.error('è§£æcurrentUserå¤±è´¥:', e);
                }
                
                if (!currentUser.user_id) {
                    showNotification('æœªæ‰¾åˆ°ç™»å½•ä¿¡æ¯', true);
                    return;
                }

                // è·å–æœ¬åœ°æ—¶é—´å¹¶åº”ç”¨æ—¶åŒºåç§»ï¼Œè§£å†³æ—¶å·®é—®é¢˜
                const now = new Date();
                // è°ƒæ•´æ—¶é—´æˆ³ï¼ŒåŠ ä¸Šæ—¶åŒºåç§»é‡ï¼ˆåŒ—äº¬æ—¶é—´ä¸ºä¸œå…«åŒºï¼Œéœ€è¦+8å°æ—¶ï¼‰
                const adjustedTime = new Date(now.getTime() + 8 * 60 * 60 * 1000);
                
                // åˆ›å»ºæ›´æ–°åçš„é¡¹ç›®æ•°æ®ï¼ˆä½¿ç”¨å°å†™å­—æ®µåä»¥åŒ¹é…æ•°æ®åº“è¡¨ç»“æ„ï¼‰
                // ä½¿ç”¨ç»Ÿä¸€çš„æ—¶é—´å¤„ç†å‡½æ•°
                const beijingTimeString = getBeijingTimeString();
                const isoTimeString = getCurrentTimeISOString();
                
                const updatedProjectData = {
                    project_id: projectToRestoreId,
                    user_id: project.user_id || currentUser.user_id,
                    project_name: project.project_name || 'æœªå‘½åé¡¹ç›®',
                    address: project.address || '',
                    regular_hours: project.regular_hours || 0,
                    overtime_hours: project.overtime_hours || 0,
                    status: 'åœ¨å»º',
                    updated_at: isoTimeString  // ä½¿ç”¨ISOæ—¶é—´æ ¼å¼è¿›è¡Œå†²çªæ£€æµ‹
                };

                // æ¸…ç†æ•°æ®ï¼Œåªæ›´æ–°statuså’Œupdated_atå­—æ®µ
                const cleanProjectData = {
                    project_id: updatedProjectData.project_id,
                    status: updatedProjectData.status,
                    updated_at: updatedProjectData.updated_at
                };

                // å…ˆæ›´æ–°æœ¬åœ°æ•°æ®ï¼ˆæ— è®ºäº‘ç«¯æ˜¯å¦æˆåŠŸï¼Œéƒ½æ›´æ–°æœ¬åœ°ï¼‰
                // ä»å·²ç»“æ¸…é¡¹ç›®ç§»é™¤
                settledProjects.splice(projectIndex, 1);
                // æ·»åŠ åˆ°åœ¨å»ºé¡¹ç›®ï¼Œå¹¶æ›´æ–°çŠ¶æ€
                const restoredProject = {
                    ...project,
                    project_id: project.project_id,
                    user_id: project.user_id || currentUser.user_id,
                    project_name: project.project_name,
                    regular_hours: project.regular_hours || 0,
                    overtime_hours: project.overtime_hours || 0,
                    status: 'åœ¨å»º',
                    updated_at: isoTimeString  // ä½¿ç”¨ISOæ—¶é—´æ ¼å¼è¿›è¡Œå†²çªæ£€æµ‹
                };
                ongoingProjects.push(restoredProject);

                // æ›´æ–°æœ¬åœ°ç´¢å¼•
                await updateLocalProjectIndex();

                // æ›´æ–°UI
                renderProjects('settled');
                updateTabCounts();
                closeConfirmRestoreModal();
                
                // æ£€æŸ¥ç½‘ç»œçŠ¶æ€å¹¶æ˜¾ç¤ºç›¸åº”çš„æç¤ºä¿¡æ¯
                const isOnline = window.offlineSyncService && window.offlineSyncService.syncStatus.isOnline;
                showNotification(isOnline ? 'é¡¹ç›®å·²æ¢å¤ä¸ºåœ¨å»ºçŠ¶æ€' : 'é¡¹ç›®å·²æ¢å¤ä¸ºåœ¨å»ºçŠ¶æ€ï¼Œå°†åœ¨ç½‘ç»œæ¢å¤ååŒæ­¥åˆ°äº‘ç«¯', false);
                
                console.log('âœ… é¡¹ç›®çŠ¶æ€å·²æ›´æ–°åˆ°æœ¬åœ°');
                
                // å¼‚æ­¥æ›´æ–°äº‘ç«¯æ•°æ®ï¼ˆåå°å¤„ç†ï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒï¼‰
                // æ•è·å½“å‰projectToRestoreIdå€¼åˆ°å±€éƒ¨å˜é‡ï¼Œé¿å…å¼‚æ­¥æ‰§è¡Œæ—¶è¢«finallyå—ä¿®æ”¹
                const currentProjectId = projectToRestoreId;
                setTimeout(() => {
                    handleProjectStatusChangeToSupabase(cleanProjectData, currentProjectId, false); // ä¼ å…¥falseè¡¨ç¤ºä¸æ˜¾ç¤ºé€šçŸ¥
                }, 0);
            } catch (error) {
                // æ¢å¤é¡¹ç›®å¤±è´¥
                showNotification('æ¢å¤é¡¹ç›®å¤±è´¥: ' + error.message, true);
                return;
            } finally {
                projectToRestoreId = null;
            }
        }

        // æ¢å¤é¡¹ç›®ä¸ºåœ¨å»ºçŠ¶æ€
        function restoreProject(project_id) {
            // å­˜å‚¨è¦æ¢å¤çš„é¡¹ç›®ID
              projectToRestoreId = project_id;
            // æ‰“å¼€ç¡®è®¤æ¢å¤æ¨¡æ€æ¡†
            openConfirmRestoreModal();
        }
        // æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
        window.restoreProject = restoreProject;

        // åˆ é™¤é¡¹ç›®ç›¸å…³å˜é‡
        let projectToDeleteId = null;
        let deleteConfirmCode = '';

        // è·å–é¡¹ç›®ç›¸å…³ç¼“å­˜ç»Ÿè®¡ï¼ˆåªåˆ é™¤ä¸å½“å‰é¡¹ç›®ç¡®åˆ‡ç›¸å…³çš„æ•°æ®ï¼‰
        function getProjectCacheStats(projectId) {
            const projectKeys = [];
            
            // åªåŒ¹é…ç¡®åˆ‡çš„é¡¹ç›®ç›¸å…³é”®ï¼Œé¿å…æ¨¡ç³ŠåŒ¹é…
            const exactProjectPatterns = [
                `project_${projectId}_data`,           // é¡¹ç›®æ•°æ®
                `project_${projectId}_attendance`,   // é¡¹ç›®è€ƒå‹¤æ•°æ®
                `project_${projectId}_settlement`,   // é¡¹ç›®ç»“ç®—æ•°æ®
                `project_${projectId}_borrow`,       // é¡¹ç›®å€Ÿæ”¯æ•°æ®
                `project_${projectId}_wage`,         // é¡¹ç›®å·¥èµ„æ•°æ®
                `project_${projectId}_index`,        // é¡¹ç›®ç´¢å¼•
                `project_${projectId}_cache`,        // é¡¹ç›®ç¼“å­˜
                `attendance_${projectId}`,           // è€ƒå‹¤è®°å½•
                `settlement_${projectId}`,           // ç»“ç®—è®°å½•
                `borrow_${projectId}`,               // å€Ÿæ”¯è®°å½•
                `wage_${projectId}`                  // å·¥èµ„è®°å½•
            ];

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (!key) continue; // è·³è¿‡ç©ºé”®
                
                // åªåŒ¹é…ç¡®åˆ‡çš„é¡¹ç›®ç›¸å…³é”®
                if (exactProjectPatterns.includes(key)) {
                    projectKeys.push(key);
                }
                // æˆ–è€…é”®åä»¥é¡¹ç›®IDç»“å°¾ï¼ˆæ›´ç²¾ç¡®çš„åŒ¹é…ï¼‰
                else if (key.endsWith(`_${projectId}`) || key === `project_${projectId}`) {
                    projectKeys.push(key);
                }
            }

            return projectKeys;
        }

        // æ‰“å¼€åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†
        function openConfirmDeleteModal(project_id) {
            // å­˜å‚¨è¦åˆ é™¤çš„é¡¹ç›®ID
              projectToDeleteId = project_id;
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('deleteConfirmationCode').value = '';
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('confirmDeleteModal').classList.add('active');
        }

        // å…³é—­åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†
        function closeConfirmDeleteModal() {
            document.getElementById('confirmDeleteModal').classList.remove('active');
            projectToDeleteId = null;
        }

        // åˆ é™¤é¡¹ç›®
        async function deleteProject(project_id) {
            // æ‰“å¼€åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†
              openConfirmDeleteModal(project_id);
        }
        // æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
        window.deleteProject = deleteProject;

        // åˆ é™¤é¡¹ç›®å…³è”æ•°æ®ï¼ˆæ•°æ®åº“ï¼‰
        async function deleteProjectRelatedData(projectId) {
            console.log(`å¼€å§‹åˆ é™¤é¡¹ç›® ${projectId} çš„å…³è”æ•°æ®...`);
            
            // åˆ†ä¸¤æ­¥è¿›è¡Œï¼Œå…ˆåˆ é™¤ä¾èµ–è¡¨ï¼Œå†åˆ é™¤è¢«ä¾èµ–è¡¨(employees)
            
            // ç¬¬ä¸€æ­¥ï¼šåˆ é™¤å¼•ç”¨äº†employeesçš„è¡¨å’Œå…¶ä»–ç‹¬ç«‹è¡¨
            const dependentTables = [
                'attendance_records', // å¼•ç”¨ employees
                'settlement_records', // å¼•ç”¨ employees
                'construction_logs',
                'project_expenses',
                'project_income',
                'work_records'
            ];
            
            console.log('å¼€å§‹åˆ é™¤ä¾èµ–è¡¨æ•°æ®...');
            const dependentDeletePromises = dependentTables.map(async (table) => {
                try {
                    const { error } = await supabase
                        .from(table)
                        .delete()
                        .eq('project_id', projectId);
                    
                    if (error) {
                        console.error(`åˆ é™¤è¡¨ ${table} æ•°æ®å¤±è´¥:`, error);
                        // ä¸æŠ›å‡ºé”™è¯¯ï¼Œå°è¯•ç»§ç»­åˆ é™¤å…¶ä»–è¡¨
                    } else {
                        console.log(`å·²åˆ é™¤è¡¨ ${table} å…³è”æ•°æ®`);
                    }
                } catch (e) {
                    console.error(`åˆ é™¤è¡¨ ${table} æ•°æ®æ—¶å‘ç”Ÿå¼‚å¸¸:`, e);
                }
            });

            await Promise.all(dependentDeletePromises);
            
            // ç¬¬äºŒæ­¥ï¼šåˆ é™¤ employees è¡¨
            console.log('å¼€å§‹åˆ é™¤ employees è¡¨æ•°æ®...');
            try {
                const { error } = await supabase
                    .from('employees')
                    .delete()
                    .eq('project_id', projectId);
                
                if (error) {
                    console.error('åˆ é™¤ employees è¡¨æ•°æ®å¤±è´¥:', error);
                } else {
                    console.log('å·²åˆ é™¤ employees è¡¨å…³è”æ•°æ®');
                }
            } catch (e) {
                console.error('åˆ é™¤ employees è¡¨æ•°æ®æ—¶å‘ç”Ÿå¼‚å¸¸:', e);
            }
            
            console.log('é¡¹ç›®å…³è”æ•°æ®åˆ é™¤æµç¨‹ç»“æŸ');
        }

        // åˆ é™¤é¡¹ç›®å…³è”æ–‡ä»¶ï¼ˆå­˜å‚¨æ¡¶ï¼‰
        async function deleteProjectStorage(projectId) {
            const bucketName = 'FYKQ';
            console.log(`å¼€å§‹åˆ é™¤é¡¹ç›® ${projectId} çš„å­˜å‚¨æ–‡ä»¶...`);

            // é€’å½’åˆ é™¤æ–‡ä»¶å¤¹å†…å®¹çš„è¾…åŠ©å‡½æ•°
            async function deleteFolderRecursively(path) {
                try {
                    // åˆ—å‡ºå½“å‰è·¯å¾„ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å’Œæ–‡ä»¶å¤¹
                    const { data, error } = await supabase
                        .storage
                        .from(bucketName)
                        .list(path, {
                            limit: 100,
                            offset: 0,
                            sortBy: { column: 'name', order: 'asc' },
                        });

                    if (error) {
                        console.error(`åˆ—å‡ºç›®å½• ${path} å¤±è´¥:`, error);
                        return;
                    }

                    if (!data || data.length === 0) return;

                    const filesToDelete = [];
                    const subFolders = [];

                    for (const item of data) {
                        // è¿™é‡Œçš„åˆ¤æ–­é€»è¾‘ä¾èµ–äºSupabase Storage APIçš„å…·ä½“è¡¨ç°
                        // é€šå¸¸å¦‚æœæœ‰idåˆ™ä¸ºæ–‡ä»¶ï¼Œæ²¡æœ‰idåˆ™ä¸ºæ–‡ä»¶å¤¹ï¼ˆæˆ–è€…æ ¹æ®metadataåˆ¤æ–­ï¼‰
                        // ä¸ºä¿é™©èµ·è§ï¼Œæˆ‘ä»¬å¯¹æ¯ä¸ªiteméƒ½å°è¯•ä½œä¸ºæ–‡ä»¶åˆ é™¤ï¼Œå¹¶å°è¯•ä½œä¸ºæ–‡ä»¶å¤¹é€’å½’
                        
                        // æ³¨æ„ï¼šSupabase list API è¿”å›çš„ item.id å¯¹äºæ–‡ä»¶æ˜¯å­˜åœ¨çš„
                        // å¯¹äºæ–‡ä»¶å¤¹ï¼ˆå ä½ç¬¦ï¼‰ï¼Œè¡Œä¸ºå¯èƒ½ä¸åŒ
                        // ç®€å•ç­–ç•¥ï¼šå¦‚æœæ˜¯æ–‡ä»¶ï¼ˆæœ‰idæˆ–metadata.mimetypeï¼‰ï¼ŒåŠ å…¥åˆ é™¤åˆ—è¡¨
                        // å¦‚æœçœ‹èµ·æ¥åƒæ–‡ä»¶å¤¹ï¼ˆæ²¡æœ‰idï¼‰ï¼ŒåŠ å…¥é€’å½’åˆ—è¡¨
                        // å®é™…ä¸Šï¼Œæˆ‘ä»¬æ„å»ºå…¨è·¯å¾„ï¼Œå¦‚æœæ˜¯æ–‡ä»¶å¤¹ï¼Œremoveå¯èƒ½ä¼šå¿½ç•¥æˆ–å¤±è´¥ï¼Œè¿™æ²¡å…³ç³»
                        
                        if (item.id) {
                            filesToDelete.push(`${path}/${item.name}`);
                        } else {
                            subFolders.push(`${path}/${item.name}`);
                        }
                    }

                    // æ‰¹é‡åˆ é™¤æ–‡ä»¶
                    if (filesToDelete.length > 0) {
                        const { error: removeError } = await supabase
                            .storage
                            .from(bucketName)
                            .remove(filesToDelete);
                        
                        if (removeError) {
                            console.error(`åˆ é™¤æ–‡ä»¶å¤±è´¥:`, removeError);
                        } else {
                            console.log(`å·²åˆ é™¤æ–‡ä»¶: ${filesToDelete.length} ä¸ª`);
                        }
                    }

                    // é€’å½’å¤„ç†å­æ–‡ä»¶å¤¹
                    for (const subFolder of subFolders) {
                        await deleteFolderRecursively(subFolder);
                    }
                    
                } catch (e) {
                    console.error(`å¤„ç†ç›®å½• ${path} æ—¶å‘ç”Ÿå¼‚å¸¸:`, e);
                }
            }

            // ä»é¡¹ç›®æ ¹ç›®å½•å¼€å§‹é€’å½’åˆ é™¤
            // æ³¨æ„ï¼šprojectId æœ¬èº«åœ¨ bucket ä¸­å¯èƒ½ä¸æ˜¯ä¸€ä¸ªç‰©ç†æ–‡ä»¶å¤¹å¯¹è±¡ï¼Œè€Œæ˜¯ä¸€ä¸ªå‰ç¼€
            // æˆ‘ä»¬åˆ—å‡º projectId ä¸‹çš„å†…å®¹
            await deleteFolderRecursively(projectId);
            console.log('é¡¹ç›®å­˜å‚¨æ–‡ä»¶åˆ é™¤æµç¨‹ç»“æŸ');
        }

        // åˆ é™¤æœ¬åœ°é¡¹ç›®æ•°æ®ï¼ˆç¦»çº¿æ¨¡å¼ï¼‰
        function deleteProjectLocalData(projectId) {
            console.log(`å¼€å§‹æ¸…ç†é¡¹ç›® ${projectId} çš„æœ¬åœ°æ•°æ®...`);
            
            // å®šä¹‰éœ€è¦æ¸…ç†çš„localStorageé”®å’Œå¯¹åº”çš„IDå­—æ®µï¼ˆå¦‚æœæ˜¯æ•°ç»„ï¼‰
            const keysToClean = [
                { key: 'attendance_records', idField: 'project_id' }, // å‡è®¾attendance_recordsç›´æ¥å­˜å‚¨æ•°ç»„
                { key: 'construction_logs', idField: 'project_id' },
                { key: 'employees', idField: 'current_project_id' }, // æ³¨æ„ï¼šå‘˜å·¥å¯èƒ½å…³è”å¤šä¸ªé¡¹ç›®ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œæˆ–è€…éœ€è¦æ›´å¤æ‚çš„é€»è¾‘
                { key: 'project_expenses', idField: 'project_id' },
                { key: 'project_project_expenses', idField: 'project_id' },
                { key: 'project_income', idField: 'project_id' },
                { key: 'project_project_income', idField: 'project_id' },
                { key: 'settlement_records', idField: 'project_id' },
                { key: 'settlementRecords', idField: 'project_id' },
                { key: 'offline_settlement_records', idField: 'project_id' },
                { key: 'work_records', idField: 'project_id' }
            ];

            // 1. æ¸…ç†å„ä¸ªè¡¨çš„è®°å½•
            keysToClean.forEach(item => {
                try {
                    const dataStr = localStorage.getItem(item.key);
                    if (dataStr) {
                        const data = JSON.parse(dataStr);
                        if (Array.isArray(data)) {
                            // è¿‡æ»¤æ‰è¯¥é¡¹ç›®çš„è®°å½•
                            const filteredData = data.filter(record => record[item.idField] !== projectId);
                            if (filteredData.length !== data.length) {
                                localStorage.setItem(item.key, JSON.stringify(filteredData));
                                console.log(`å·²æ¸…ç† ${item.key}: åˆ é™¤ ${data.length - filteredData.length} æ¡è®°å½•`);
                            }
                        }
                    }
                } catch (e) {
                    console.error(`æ¸…ç†æœ¬åœ°æ•°æ® ${item.key} å¤±è´¥:`, e);
                }
            });

            // 2. æ¸…ç†é¡¹ç›®æœ¬èº«
            // å‡è®¾é¡¹ç›®åˆ—è¡¨å­˜å‚¨åœ¨ 'projects' æˆ– 'allProjects'
            const projectKeys = ['projects', 'allProjects', 'myProjects', 'joinedProjects'];
            projectKeys.forEach(key => {
                try {
                    const dataStr = localStorage.getItem(key);
                    if (dataStr) {
                        const data = JSON.parse(dataStr);
                        if (Array.isArray(data)) {
                            const filteredData = data.filter(p => p.project_id !== projectId);
                            if (filteredData.length !== data.length) {
                                localStorage.setItem(key, JSON.stringify(filteredData));
                                console.log(`å·²ä» ${key} ä¸­ç§»é™¤é¡¹ç›®`);
                            }
                        }
                    }
                } catch (e) {
                    console.error(`æ¸…ç†é¡¹ç›®åˆ—è¡¨ ${key} å¤±è´¥:`, e);
                }
            });
            
            console.log('æœ¬åœ°æ•°æ®æ¸…ç†å®Œæˆ');
        }

        // æ‰§è¡Œåˆ é™¤é¡¹ç›®æ“ä½œ
        async function executeDeleteProject() {
            if (!projectToDeleteId) return;

            try {
                // è·å–ç”¨æˆ·è¾“å…¥çš„å¯†ç 
                const inputPassword = document.getElementById('deleteConfirmationCode').value.trim();
                
                if (!inputPassword) {
                    showNotification('è¯·è¾“å…¥å¯†ç ï¼', true);
                    return;
                }

                // è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„å¯†ç 
                let currentUser = {};
                try {
                    const currentUserStr = localStorage.getItem('currentUser');
                    if (currentUserStr) {
                        currentUser = JSON.parse(currentUserStr);
                    }
                } catch (e) {
                    console.error('è§£æcurrentUserå¤±è´¥:', e);
                }

                if (!currentUser.password) {
                    // å¦‚æœæœ¬åœ°æ²¡æœ‰å­˜å‚¨å¯†ç ï¼ˆå¼‚å¸¸æƒ…å†µï¼‰ï¼Œå°è¯•é‡æ–°ç™»å½•æˆ–æç¤º
                    console.error('æœªæ‰¾åˆ°ç”¨æˆ·å¯†ç ä¿¡æ¯');
                    showNotification('ç”¨æˆ·ä¿¡æ¯å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•', true);
                    return;
                }

                // éªŒè¯å¯†ç 
                if (inputPassword !== currentUser.password) {
                    showNotification('å¯†ç é”™è¯¯ï¼Œæ— æ³•åˆ é™¤é¡¹ç›®ï¼', true);
                    return;
                }

                // å¯†ç éªŒè¯é€šè¿‡ï¼Œç»§ç»­æ‰§è¡Œåˆ é™¤é€»è¾‘
                
                // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
                if (navigator.onLine) {
                    // åœ¨çº¿æ¨¡å¼
                    showNotification('æ­£åœ¨åˆ é™¤é¡¹ç›®åŠå…³è”æ•°æ®...', false);
                    
                    // 1. åˆ é™¤å…³è”çš„æ•°æ®åº“è®°å½•
                    await deleteProjectRelatedData(projectToDeleteId);
                    
                    // 2. åˆ é™¤å…³è”çš„å­˜å‚¨æ–‡ä»¶
                    await deleteProjectStorage(projectToDeleteId);

                    // 3. åˆ é™¤é¡¹ç›®æœ¬èº«
                    const { error } = await supabase
                        .from('projects')
                        .delete()
                        .eq('project_id', projectToDeleteId);

                    if (error) {
                        throw error;
                    }
                } else {
                    // ç¦»çº¿æ¨¡å¼
                    showNotification('ç¦»çº¿æ¨¡å¼ï¼šæ­£åœ¨æœ¬åœ°åˆ é™¤å¹¶æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—...', false);
                    
                    // 1. æ¸…ç†æœ¬åœ°æ•°æ®
                    deleteProjectLocalData(projectToDeleteId);
                    
                    // 2. æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—ï¼ˆä½¿ç”¨ç‰¹æ®Šçš„æ“ä½œç±»å‹ 'åˆ é™¤é¡¹ç›®å…³è”æ•°æ®'ï¼‰
                    if (window.offlineSyncService) {
                        window.offlineSyncService.addToSyncQueue('åˆ é™¤é¡¹ç›®å…³è”æ•°æ®', { projectId: projectToDeleteId }, projectToDeleteId, 'project');
                        console.log('å·²æ·»åŠ å®Œæ•´åˆ é™¤ä»»åŠ¡åˆ°åŒæ­¥é˜Ÿåˆ—');
                    } else {
                        console.warn('ç¦»çº¿åŒæ­¥æœåŠ¡æœªåˆå§‹åŒ–ï¼Œæ— æ³•æ·»åŠ åŒæ­¥ä»»åŠ¡');
                        showNotification('åŒæ­¥æœåŠ¡æœªå¯åŠ¨ï¼Œç¦»çº¿åˆ é™¤å¯èƒ½æ— æ³•åŒæ­¥åˆ°äº‘ç«¯', true);
                    }
                }

                // æŸ¥æ‰¾é¡¹ç›® - ä½¿ç”¨æ­£ç¡®çš„project_idå­—æ®µ
                const projectIndex = settledProjects.findIndex(p => p.project_id === projectToDeleteId);
                
                // æ— è®ºåœ¨çº¿è¿˜æ˜¯ç¦»çº¿ï¼Œéƒ½åœ¨UIä¸Šç§»é™¤é¡¹ç›®
                // ... (åç»­ä»£ç ä¿æŒä¸å˜ï¼Œæ›´æ–°UI)

                if (projectIndex === -1) {
                    showNotification('æœªæ‰¾åˆ°é¡¹ç›®', true);
                    return;
                }
                const project = settledProjects[projectIndex];

                // 1. åˆ é™¤æœ¬åœ°å­˜å‚¨çš„é¡¹ç›®æ•°æ®
                try {
                    const storageKey = `project_${project.project_id}_data`;
                    localStorage.removeItem(storageKey);
                    console.log('âœ… é¡¹ç›®è®°å½•å·²ä»æœ¬åœ°åˆ é™¤');
                } catch (error) {
                    console.error('åˆ é™¤æœ¬åœ°å­˜å‚¨çš„é¡¹ç›®æ•°æ®å¤±è´¥:', error);
                }

                // 2. ä»æœ¬åœ°æ•°ç»„ä¸­ç§»é™¤é¡¹ç›®
                settledProjects.splice(projectIndex, 1);

                // 3. æ›´æ–°æœ¬åœ°ç´¢å¼•
                await updateLocalProjectIndex();

                // 4. æ¸…é™¤é¡¹ç›®ç›¸å…³ç¼“å­˜
                try {
                    const stats = getProjectCacheStats(project.project_id);
                    if (stats.length > 0) {
                        stats.forEach(key => {
                            localStorage.removeItem(key);
                        });
                    }
                } catch (error) {
                    console.error('æ¸…é™¤é¡¹ç›®ç¼“å­˜å¤±è´¥:', error);
                }

                // 5. ç«‹å³å…³é—­æ¨¡æ€æ¡†å¹¶æ›´æ–°UIï¼Œè®©ç”¨æˆ·å¯ä»¥ç«‹å³ç»§ç»­æ“ä½œ
                closeModal();
                closeConfirmDeleteModal();
                renderProjects('settled');
                updateTabCounts();
                
                // 6. ä½¿ç”¨ç¦»çº¿åŒæ­¥æœåŠ¡å¤„ç†é¡¹ç›®åˆ é™¤ï¼ˆåå°å¼‚æ­¥å¤„ç†ï¼‰
                await handleProjectDeleteToSupabase(project);
                
            } catch (error) {
                // åˆ é™¤é¡¹ç›®å¤±è´¥
                showNotification('åˆ é™¤é¡¹ç›®å¤±è´¥: ' + error.message, true);
            }
        }

        // å¤„ç†é¡¹ç›®çŠ¶æ€å˜æ›´åˆ°Supabaseçš„å‡½æ•°ï¼ˆæ”¯æŒç¦»çº¿åŒæ­¥ï¼‰
        async function handleProjectStatusChangeToSupabase(projectData, targetProjectId, showNotificationFlag = true) {
            try {
                // æ˜¾ç¤ºæœ¬åœ°çŠ¶æ€å˜æ›´æˆåŠŸé€šçŸ¥ï¼ˆä»…åœ¨éœ€è¦æ—¶æ˜¾ç¤ºï¼‰
                if (showNotificationFlag) {
                    const isOnline = window.offlineSyncService && window.offlineSyncService.syncStatus.isOnline;
                    const statusText = projectData.status === 'ç»“æ¸…' ? 'å·²è®¾ä¸ºç»“æ¸…' : 'å·²æ¢å¤ä¸ºåœ¨å»º';
                    showNotification(isOnline ? statusText : `${statusText}ï¼ˆæœ¬åœ°ä¿å­˜ï¼‰`, false);
                }

                // ç„¶åå¼‚æ­¥æ›´æ–°äº‘ç«¯æ•°æ®
                setTimeout(async () => {
                    try {
                        // æ£€æŸ¥æ˜¯å¦åœ¨çº¿
                        if (window.offlineSyncService && window.offlineSyncService.syncStatus.isOnline) {
                            // åœ¨çº¿æ—¶ç›´æ¥æ›´æ–°äº‘ç«¯æ•°æ®
                    try {
                        const { error } = await window.supabase
                            .from('projects')
                            .update(projectData)
                            .eq('project_id', targetProjectId);
                        
                        if (error) {
                            console.error('ä»Supabaseæ›´æ–°é¡¹ç›®çŠ¶æ€å¤±è´¥:', error);
                            // å¦‚æœäº‘ç«¯æ›´æ–°å¤±è´¥ï¼Œæ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—
                            if (window.offlineSyncService) {
                                await window.offlineSyncService.addToSyncQueue('update', projectData, targetProjectId, 'project');
                            }
                        } else {
                            console.log('âœ… é¡¹ç›®çŠ¶æ€å·²æˆåŠŸæ›´æ–°åˆ°Supabase');
                        }
                    } catch (supabaseError) {
                        console.error('Supabaseæ›´æ–°é¡¹ç›®çŠ¶æ€æ“ä½œå¼‚å¸¸:', supabaseError);
                        // å¦‚æœäº‘ç«¯æ›´æ–°å¤±è´¥ï¼Œæ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—
                        if (window.offlineSyncService) {
                            await window.offlineSyncService.addToSyncQueue('update', projectData, targetProjectId, 'project');
                        }
                    }
                        } else {
                            // ç¦»çº¿æ—¶æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—
                            if (window.offlineSyncService) {
                                await window.offlineSyncService.addToSyncQueue('update', projectData, targetProjectId, 'project');
                            }
                        }
                    } catch (error) {
                        console.error('æ›´æ–°é¡¹ç›®çŠ¶æ€åˆ°äº‘ç«¯å¤±è´¥:', error);
                        // å¦‚æœäº‘ç«¯æ›´æ–°å¤±è´¥ï¼Œå°è¯•æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—
                        if (window.offlineSyncService) {
                            try {
                                await window.offlineSyncService.addToSyncQueue('update', projectData, targetProjectId, 'project');
                            } catch (queueError) {
                                console.error('æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—å¤±è´¥:', queueError);
                            }
                        }
                    }
                }, 0);
            } catch (error) {
                console.error('å¤„ç†é¡¹ç›®çŠ¶æ€å˜æ›´æ—¶å‡ºé”™:', error);
                showNotification('é¡¹ç›®çŠ¶æ€å˜æ›´æˆåŠŸï¼Œä½†æ•°æ®åŒæ­¥å¤±è´¥', true);
            }
        }

        // å¤„ç†é¡¹ç›®åˆ é™¤åˆ°Supabaseçš„å‡½æ•°ï¼ˆæ”¯æŒç¦»çº¿åŒæ­¥ï¼‰
        async function handleProjectDeleteToSupabase(project) {
            try {
                // æ˜¾ç¤ºæœ¬åœ°åˆ é™¤æˆåŠŸé€šçŸ¥
                const isOnline = window.offlineSyncService && window.offlineSyncService.syncStatus.isOnline;
                showNotification(isOnline ? 'é¡¹ç›®åˆ é™¤æˆåŠŸ' : 'é¡¹ç›®åˆ é™¤æˆåŠŸï¼Œå°†åœ¨ç½‘ç»œæ¢å¤ååŒæ­¥åˆ°äº‘ç«¯', false);

                // ç„¶åå¼‚æ­¥åˆ é™¤äº‘ç«¯æ•°æ®
                setTimeout(async () => {
                    try {
                        // æ£€æŸ¥æ˜¯å¦åœ¨çº¿
                        if (window.offlineSyncService && window.offlineSyncService.syncStatus.isOnline) {
                            // åœ¨çº¿æ—¶ç›´æ¥åˆ é™¤äº‘ç«¯æ•°æ®
                            try {
                                const { error } = await window.supabase
                                    .from('projects')
                                    .delete()
                                    .eq('project_id', project.project_id);
                                
                                if (error) {
                                    console.error('ä»Supabaseåˆ é™¤é¡¹ç›®å¤±è´¥:', error);
                                    // å¦‚æœäº‘ç«¯åˆ é™¤å¤±è´¥ï¼Œæ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—
                                    if (window.offlineSyncService) {
                                        await window.offlineSyncService.addToSyncQueue('delete', project, project.project_id, 'project');
                                    }
                                } else {
                                    console.log('âœ… é¡¹ç›®æ•°æ®å·²æˆåŠŸä»Supabaseåˆ é™¤');
                                }
                            } catch (supabaseError) {
                                console.error('Supabaseåˆ é™¤é¡¹ç›®æ“ä½œå¼‚å¸¸:', supabaseError);
                                // å¦‚æœäº‘ç«¯åˆ é™¤å¤±è´¥ï¼Œæ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—
                                if (window.offlineSyncService) {
                                    await window.offlineSyncService.addToSyncQueue('delete', project, project.project_id, 'project');
                                }
                            }
                        } else {
                            // ç¦»çº¿æ—¶æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—
                            if (window.offlineSyncService) {
                                await window.offlineSyncService.addToSyncQueue('delete', project, project.project_id, 'project');
                            }
                        }
                    } catch (error) {
                        console.error('åˆ é™¤é¡¹ç›®æ•°æ®åˆ°äº‘ç«¯å¤±è´¥:', error);
                        // å¦‚æœäº‘ç«¯åˆ é™¤å¤±è´¥ï¼Œå°è¯•æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—
                        if (window.offlineSyncService) {
                            try {
                                await window.offlineSyncService.addToSyncQueue('delete', project, project.project_id, 'project');
                            } catch (queueError) {
                                console.error('æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—å¤±è´¥:', queueError);
                            }
                        }
                    }
                }, 0);
            } catch (error) {
                console.error('å¤„ç†é¡¹ç›®åˆ é™¤æ—¶å‡ºé”™:', error);
                showNotification('é¡¹ç›®åˆ é™¤æˆåŠŸï¼Œä½†æ•°æ®åŒæ­¥å¤±è´¥', true);
            }
        }

        // æ·»åŠ æ–°æŒ‰é’®æ ·å¼ - ä½¿ç”¨å”¯ä¸€å˜é‡åé¿å…å†²çª
        const buttonStyle = document.createElement('style');
        buttonStyle.textContent = `
            /* 
            .action-btn.restore-btn {
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                margin-right: 8px;
            }

            .action-btn.delete-btn {
                background: linear-gradient(135deg, #ef4444, #dc2626);
                color: white;
            }
            */
            
            /* æ–°æ ·å¼è¦†ç›– */
            .action-btn.restore-btn:hover, .action-btn.delete-btn:hover {
                background-color: rgba(0,0,0,0.05) !important;
                transform: translateY(-1px);
            }
            
            .action-btn.restore-btn::before, .action-btn.delete-btn::before {
                display: none; /* ç§»é™¤åŸæ¥çš„å…‰æ•ˆ */
            }
        `;
        document.head.appendChild(buttonStyle);

        // åˆå§‹åŒ–æ ‡ç­¾é¡µç±»å
        document.querySelectorAll('.tab').forEach((tab, index) => {
            if (index === 0) {
                tab.classList.add('tab-ongoing');
            } else if (index === 1) {
                tab.classList.add('tab-settled');
            }
        });

        // æ ‡ç­¾é¡µåˆ‡æ¢
        document.querySelectorAll('.tab').forEach((tab, index) => {
            tab.addEventListener('click', function() {
                // ç§»é™¤æ‰€æœ‰æ ‡ç­¾é¡µçš„activeç±»
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                // ä¸ºå½“å‰æ ‡ç­¾é¡µæ·»åŠ activeç±»
                this.classList.add('active');
                // æ ¹æ®æ ‡ç­¾é¡µç´¢å¼•æ¸²æŸ“å¯¹åº”é¡¹ç›®
                if (index === 0) {
                    renderProjects('ongoing');
                } else if (index === 1) {
                    renderProjects('settled');
                }
            });
        });

        // ç­‰å¾…Supabaseåˆå§‹åŒ–å®Œæˆåå†æ‰§è¡Œé¡µé¢é€»è¾‘
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // ç­‰å¾…Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ–å®Œæˆ
                const supabase = await window.waitForSupabase();
                // console.log('âœ… Supabaseåˆå§‹åŒ–å®Œæˆ');
                
                // é¡¹ç›®åˆ—è¡¨é¡µé¢ä½¿ç”¨å…¨å±€çš„ç¦»çº¿åŒæ­¥æœåŠ¡ï¼Œé¿å…é‡å¤åˆ›å»ºå®ä¾‹
                if (window.offlineSyncService) {
                    // console.log('âœ… ä½¿ç”¨ç°æœ‰çš„ç¦»çº¿åŒæ­¥æœåŠ¡');
                } else if (typeof OfflineSyncService !== 'undefined') {
                    window.offlineSyncService = new OfflineSyncService();
                    // console.log('âœ… åˆå§‹åŒ–ç¦»çº¿åŒæ­¥æœåŠ¡');
                } else {
                    // console.warn('âš ï¸ OfflineSyncService æœªå®šä¹‰');
                }
                
                // é¡¹ç›®åˆ—è¡¨é¡µé¢ä½¿ç”¨å…¨å±€çš„åŒæ­¥çŠ¶æ€æŒ‡ç¤ºå™¨
                if (window.syncStatusIndicator) {
                    // console.log('âœ… ä½¿ç”¨ç°æœ‰çš„åŒæ­¥çŠ¶æ€æŒ‡ç¤ºå™¨');
                } else if (typeof SyncStatusIndicator !== 'undefined') {
                    window.syncStatusIndicator = new SyncStatusIndicator();
                    // console.log('âœ… åˆå§‹åŒ–åŒæ­¥çŠ¶æ€æŒ‡ç¤ºå™¨');
                }
                
                // é¡µé¢åŠ è½½å®Œæˆåï¼Œä¸»åŠ¨è§¦å‘ä¸€æ¬¡åŒæ­¥é˜Ÿåˆ—å¤„ç†
                if (window.offlineSyncService) {
                    // å»¶è¿Ÿ1ç§’åå¤„ç†åŒæ­¥é˜Ÿåˆ—ï¼Œç¡®ä¿é¡µé¢å…¶ä»–èµ„æºå·²åŠ è½½å®Œæˆ
                    setTimeout(() => {
                        // console.log('â³ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹å¤„ç†åŒæ­¥é˜Ÿåˆ—...');
                        window.offlineSyncService.processSyncQueue();
                    }, 1000);
                }
                
            } catch (error) {
                console.error('âŒ Supabaseåˆå§‹åŒ–å¤±è´¥:', error);
                showNotification('æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', true);
            }
        });
    </script>
    
    <!-- æ‹¦æˆªæ§åˆ¶å°é”™è¯¯ï¼Œè¿‡æ»¤ç‰¹å®šçš„ERR_ABORTEDé”™è¯¯ -->
    <script>
        // ä¿å­˜åŸå§‹çš„console.error
        const originalConsoleError = console.error;
        

        // å®Œå…¨é‡å†™æ¶ˆæ¯å¤„ç†é€»è¾‘ï¼Œé¿å…å¼‚æ­¥å“åº”é—®é¢˜
        (function() {
            // ä¿å­˜åŸå§‹çš„console.erroræ–¹æ³•ä»¥è¿›è¡Œé”™è¯¯è¿‡æ»¤
            const originalConsoleError = console.error;
            
            // é‡å†™console.errorï¼Œè¿‡æ»¤ç‰¹å®šçš„é”™è¯¯
            console.error = function(...args) {
                // å°†å‚æ•°è½¬æ¢ä¸ºå­—ç¬¦ä¸²ä»¥æ£€æŸ¥æ˜¯å¦åŒ…å«ç‰¹å®šé”™è¯¯ä¿¡æ¯
                const errorMessage = args.join(' ');
                
                // è¿‡æ»¤æ‰ç½‘ç»œé”™è¯¯å’ŒChromeæ‰©å±•é”™è¯¯
                if (errorMessage.includes('net::ERR_ABORTED') || 
                    (errorMessage.includes('Unchecked runtime.lastError') && 
                    errorMessage.includes('listener indicated an asynchronous response'))) {
                    // é™é»˜å¤„ç†è¿™äº›ç‰¹å®šé”™è¯¯ï¼Œä¸è¾“å‡ºåˆ°æ§åˆ¶å°
                    return;
                }
                
                // å…¶ä»–é”™è¯¯æ­£å¸¸è¾“å‡º
                originalConsoleError.apply(console, args);
            };
            
            // ä¿å­˜åŸå§‹çš„console.logå’Œwarnæ–¹æ³•
            const originalConsoleLog = console.log;
            const originalConsoleWarn = console.warn;
            
            // é‡å†™console.logï¼Œè¿‡æ»¤æ‰ç‰¹å®šçš„é”™è¯¯ä¿¡æ¯
            console.log = function(...args) {
                const message = args.join(' ');
                
                // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯æˆ–Chromeæ‰©å±•é”™è¯¯ï¼Œä¸æ˜¾ç¤º
                if (message.includes('net::ERR_ABORTED') || 
                    (message.includes('Unchecked runtime.lastError') && 
                    message.includes('listener indicated an asynchronous response'))) {
                    return; // é™é»˜è¿‡æ»¤ï¼Œä¸æ˜¾ç¤ºè¿™ä¸ªé”™è¯¯
                }
                
                // å…¶ä»–æ—¥å¿—æ­£å¸¸æ˜¾ç¤º
                originalConsoleLog.apply(console, args);
            };
            
            // é‡å†™console.warnï¼Œè¿‡æ»¤æ‰ç‰¹å®šçš„é”™è¯¯ä¿¡æ¯
            console.warn = function(...args) {
                const message = args.join(' ');
                
                // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯æˆ–Chromeæ‰©å±•é”™è¯¯ï¼Œä¸æ˜¾ç¤º
                if (message.includes('net::ERR_ABORTED') || 
                    (message.includes('Unchecked runtime.lastError') && 
                    message.includes('listener indicated an asynchronous response'))) {
                    return; // é™é»˜è¿‡æ»¤ï¼Œä¸æ˜¾ç¤ºè¿™ä¸ªé”™è¯¯
                }
                
                // å…¶ä»–è­¦å‘Šæ­£å¸¸æ˜¾ç¤º
                originalConsoleWarn.apply(console, args);
            };
            
            // ä¼˜åŒ–postMessageå¤„ç†ï¼Œé¿å…æ¶ˆæ¯é€šé“å…³é—­é—®é¢˜
            const originalPostMessage = window.postMessage;
            window.postMessage = function(message, targetOrigin, transfer) {
                try {
                    // ç¡®ä¿targetOriginå®‰å…¨è®¾ç½®
                    if (!targetOrigin || targetOrigin === '*') {
                        console.warn('ä¸å®‰å…¨çš„postMessageè°ƒç”¨ï¼ŒæœªæŒ‡å®štargetOrigin');
                    }
                    // æ­£å¸¸æ‰§è¡ŒpostMessage
                    originalPostMessage.apply(window, arguments);
                } catch (e) {
                    // æ•è·å¹¶é™é»˜å¤„ç†é”™è¯¯
                }
            };
            
            // é¦–å…ˆä½¿ç”¨captureé€‰é¡¹æ¥ç¡®ä¿æˆ‘ä»¬çš„ç›‘å¬å™¨å…ˆæ‰§è¡Œ
            window.addEventListener('message', handleMessageEvent, { capture: true });
            
            // å®šä¹‰æ¶ˆæ¯å¤„ç†å‡½æ•°
            function handleMessageEvent(event) {
                
                
                try {
                    // å¤„ç†æ¶ˆæ¯æ•°æ®
                    if (event.data && typeof event.data === 'object') {
                        // æ¶ˆæ¯ç±»å‹å¤„ç†
                        switch (event.data.type) {
                            case 'updateTitle':
                                if (event.data.project_name) {
                                    // å¤„ç†é¡¹ç›®åç§°æ›´æ–°
                                    setTimeout(() => {
                                        const headerTitle = document.getElementById('headerTitle');
                                        if (headerTitle) {
                                            headerTitle.textContent = event.data.project_name;
                                        }
                                    }, 0);
                                }
                                break;
                            case 'navigate':
                                if (event.data.page) {
                                    // å¯¼èˆªå¤„ç†
                                    setTimeout(() => {
                                        window.location.href = event.data.page;
                                    }, 0);
                                }
                                break;
                            default:
                                // å¿½ç•¥å…¶ä»–ç±»å‹çš„æ¶ˆæ¯
                                break;
                        }
                    }
                } catch (e) {
                    // é™é»˜å¤„ç†é”™è¯¯ï¼Œä¸æŠ›å‡ºå¼‚å¸¸
                }
                
                // é‡è¦ï¼šä¸è¦åœ¨è¿™é‡Œè¿”å›ä»»ä½•å€¼ï¼Œç‰¹åˆ«æ˜¯ä¸è¦è¿”å›true
                // è¿™æ˜¯é˜²æ­¢å¼‚æ­¥å“åº”é”™è¯¯çš„å…³é”®
            }
            
            // æ¸…ç†å‡½æ•°ï¼Œç”¨äºåœ¨ç»„ä»¶å¸è½½æ—¶ç§»é™¤ç›‘å¬å™¨
            window.cleanupMessageListeners = function() {
                window.removeEventListener('message', handleMessageEvent, { capture: true });
            };
        })();
    </script>
</body>
</html>