<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>员工录入系统</title>
    <!-- 本地加载完整的Supabase库 -->
    <script src="JavaScript/supabase/supabase.min.js"></script>
    <!-- 加载浏览器环境的Supabase配置 -->
      <script src="JavaScript/supabase/supabase-client.js"></script>
      <!-- 离线同步服务 -->
    <script src="JavaScript/离线同步/offline-sync-service.js"></script>
    <!-- 同步状态指示器 -->
<script src="JavaScript/离线同步/sync-status-indicator.js"></script>
      <script src="JavaScript/excel/exceljs.min.js"></script>
      <script src="JavaScript/excel/FileSaver.min.js"></script>
      <!-- PDF生成相关库 -->
      <script src="JavaScript/pdf/jspdf.umd.min.js"></script>
      <script src="JavaScript/pdf/html2canvas.min.js"></script>
      <script src="JavaScript/pdf/jspdf.plugin.autotable.min.js"></script>
      <!-- PDF生成器 -->
      <script src="JavaScript/员工录入/pdf-generator.js"></script>

      <script>
        // 初始化全局员工数据缓存
        window.employeeDataCache = window.employeeDataCache || {};
        
        // 辅助函数：获取正确的北京时间（UTC+8）字符串
        function getBeijingTimeString() {
            // 创建一个新的Date对象（注意：JavaScript Date对象内部使用UTC时间，但会根据本地时区显示）
            const now = new Date();
            
            // 直接使用Date对象的UTC方法获取当前时间的UTC时间部分
            // 这样可以避免时区转换问题，因为我们需要的就是UTC+8时间
            let year = now.getUTCFullYear();
            let month = now.getUTCMonth();
            let day = now.getUTCDate();
            let hours = now.getUTCHours();
            
            // 加上8小时得到北京时间
            hours += 8;
            
            // 处理日期进位
            if (hours >= 24) {
                hours -= 24;
                day += 1;
                
                // 处理月份进位
                const daysInMonth = new Date(Date.UTC(year, month + 1, 0)).getUTCDate();
                if (day > daysInMonth) {
                    day = 1;
                    month += 1;
                    
                    // 处理年份进位
                    if (month > 11) {
                        month = 0;
                        year += 1;
                    }
                }
            }
            
            // 格式化输出
            month = String(month + 1).padStart(2, '0');
            day = String(day).padStart(2, '0');
            hours = String(hours).padStart(2, '0');
            const minutes = String(now.getUTCMinutes()).padStart(2, '0');
            const seconds = String(now.getUTCSeconds()).padStart(2, '0');
            
            // 返回格式化为字符串，确保Supabase按字面文本保存而非时间戳类型
            // 这将避免Supabase自动添加毫秒精度
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
        
        // 生成当前时间的ISO字符串，正确处理时区
        function getCurrentTimeISOString() {
            const now = new Date();
            // 直接返回本地时间的ISO格式字符串
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            // 返回格式：YYYY-MM-DD HH:MM:SS
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
        
        // 格式化时间戳，移除毫秒精度并确保正确的显示格式
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            
            try {
                // 检查是否已经是我们生成的北京时间格式（YYYY-MM-DD HH:MM:SS或YYYY-MM-DD HH:MM:SS.mmm）
                // 这种格式的时间戳不需要再进行时区转换
                if (/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}(\.\d+)?$/.test(timestamp)) {
                    // 已经是标准格式，移除毫秒部分后返回
                    return timestamp.split('.')[0];
                }
                
                // 如果时间戳包含毫秒精度（如.855483），则移除
                const cleanTimestamp = timestamp.split('.')[0];
                
                // 处理ISO格式时间戳（如2023-01-01T12:00:00）
                if (cleanTimestamp.includes('T')) {
                    // 创建Date对象，会自动处理时区
                    const date = new Date(cleanTimestamp);
                    
                    // 检查日期是否有效
                    if (isNaN(date.getTime())) {
                        // 如果无法解析，返回原始字符串（移除T）
                        return cleanTimestamp.replace('T', ' ');
                    }
                    
                    // 检查是否是UTC时间（以Z结尾）
                    if (cleanTimestamp.endsWith('Z')) {
                        // 如果是UTC时间，直接格式化为本地时间（不再手动加8小时）
                        const localTime = new Date(date.getTime());
                        
                        // 格式化为YYYY-MM-DD HH:MM:SS
                        const year = localTime.getFullYear();
                        const month = String(localTime.getMonth() + 1).padStart(2, '0');
                        const day = String(localTime.getDate()).padStart(2, '0');
                        const hours = String(localTime.getHours()).padStart(2, '0');
                        const minutes = String(localTime.getMinutes()).padStart(2, '0');
                        const seconds = String(localTime.getSeconds()).padStart(2, '0');
                        
                        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
                    } else {
                        // 如果不是UTC时间，直接格式化为北京时间格式
                        // 假设已经是本地时间，不需要时区转换
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        const hours = String(date.getHours()).padStart(2, '0');
                        const minutes = String(date.getMinutes()).padStart(2, '0');
                        const seconds = String(date.getSeconds()).padStart(2, '0');
                        
                        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
                    }
                }
                
                // 尝试直接解析
                const date = new Date(cleanTimestamp);
                
                // 检查日期是否有效
                if (isNaN(date.getTime())) {
                    // 如果无法解析，返回原始字符串
                    return cleanTimestamp;
                }
                
                // 检查是否是UTC时间戳（通过时间戳值判断）
                // 如果时间戳值远小于当前时间，可能是UTC时间
                const currentTime = Date.now();
                if (date.getTime() < currentTime - 8 * 60 * 60 * 1000) {
                    // 可能是UTC时间，直接格式化为本地时间（不再手动加8小时）
                    const localTime = new Date(date.getTime());
                    
                    // 格式化为YYYY-MM-DD HH:MM:SS
                    const year = localTime.getFullYear();
                    const month = String(localTime.getMonth() + 1).padStart(2, '0');
                    const day = String(localTime.getDate()).padStart(2, '0');
                    const hours = String(localTime.getHours()).padStart(2, '0');
                    const minutes = String(localTime.getMinutes()).padStart(2, '0');
                    const seconds = String(localTime.getSeconds()).padStart(2, '0');
                    
                    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
                } else {
                    // 可能是本地时间，直接格式化
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const seconds = String(date.getSeconds()).padStart(2, '0');
                    
                    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
                }
            } catch (error) {
                console.error('格式化时间戳出错:', error, '原始时间戳:', timestamp);
                // 出错时返回原始处理（移除毫秒，转换T为空格）
                const formatted = timestamp.split('.')[0];
                return formatted.includes('T') ? formatted.replace('T', ' ') : formatted;
            }
        }
        
        // 确保时间戳格式一致，用于保存到数据库
        function normalizeTimestamp(timestamp) {
            if (!timestamp) return getCurrentTimeISOString();
            
            // 如果时间戳包含毫秒精度（如.855483），则移除
            const normalized = timestamp.split('.')[0];
            // 如果时间戳是ISO格式（如2023-01-01T12:00:00），则转换为显示格式
            if (normalized.includes('T')) {
                return normalized.replace('T', ' ');
            }
            return normalized;
        }

        // 处理员工添加到Supabase的函数（支持离线同步）
        async function handleEmployeeAddToSupabase(newEmployee) {
            try {
                // 获取当前选中的项目信息
                const projectSelect = document.getElementById('project-name');
                let selectedProjectId = null;
                let selectedProjectName = 'default_project';
                
                if (projectSelect && projectSelect.selectedIndex >= 0 && projectSelect.value !== '') { // 确保选择的是真实项目而不是提示语
                    const selectedOption = projectSelect.options[projectSelect.selectedIndex];
                    selectedProjectId = projectSelect.value; // 获取项目ID
                    selectedProjectName = selectedOption.textContent || 'default_project';
                    
                    // 如果项目信息中有更完整的ID信息，优先使用
                    if (selectedOption.dataset.projectInfo) {
                        try {
                            const projectInfo = JSON.parse(selectedOption.dataset.projectInfo);
                            selectedProjectId = projectInfo.id || projectSelect.value;
                        } catch (e) {
                            // 如果解析失败，使用select的value
                        }
                    }
                }

                // 创建Supabase专用的员工对象，使用数据库实际的字段名
                const supabaseEmployee = {
                    // 员工唯一标识字段 - 使用UUID格式
                    employee_id: newEmployee.employee_id || generateUUID(),
                    // 项目唯一标识符
                    project_id: selectedProjectId,
                    // 工号字段
                    emp_code: newEmployee.emp_code || '',
                    // 基本信息字段，使用英文列名
                    emp_name: newEmployee.emp_name || '',
                    status: newEmployee.status || '在职',
                    labor_cost: newEmployee.labor_cost || null,
                    phone: newEmployee.phone || '',  // 直接使用员工电话字段
                    id_card: newEmployee.id_card || null,
                    hire_date: newEmployee.hire_date || null,
                    leave_date: newEmployee.leave_date || null,
                    remarks: newEmployee.remarks || '',
                    // 银行信息字段
                    bank_name: newEmployee.bank_name || '',
                    bank_card_number: newEmployee.bank_card_number || '',
                    bank_address: newEmployee.bank_address || ''
                };
                // 删除可能存在的created_at字段，由数据库默认值处理
                delete supabaseEmployee.created_at;

                // 检查是否在线
                if (navigator.onLine && window.supabase && typeof window.supabase.from === 'function') {
                    try {
                        const { error } = await window.supabase
                            .from('employees')
                            .insert(supabaseEmployee);
                        
                        if (error) {
                            console.error('保存到Supabase失败:', error);
                            // 添加到同步队列，稍后重试
                            if (window.offlineSyncService) {
                                window.offlineSyncService.addToSyncQueue('add', supabaseEmployee, supabaseEmployee.employee_id);
                            }
                            showNotification('员工添加成功，将在网络恢复后自动同步到云端', false);
                            playSuccessSound();
                        } else {
                            console.log('员工数据已成功保存到Supabase');
                            showNotification('员工添加成功!', false);
                            playSuccessSound();
                        }
                    } catch (supabaseError) {
                        console.error('Supabase操作异常:', supabaseError);
                        // 添加到同步队列
                        if (window.offlineSyncService) {
                            window.offlineSyncService.addToSyncQueue('add', supabaseEmployee, supabaseEmployee.employee_id);
                        }
                        showNotification('员工添加成功，将在网络恢复后自动同步到云端', false);
                        playSuccessSound();
                    }
                } else {
                    // 离线状态，添加到同步队列
                    if (window.offlineSyncService) {
                        window.offlineSyncService.addToSyncQueue('add', supabaseEmployee, supabaseEmployee.employee_id);
                    }
                    showNotification('员工添加成功（离线模式），将在网络恢复后自动同步', false);
                    playSuccessSound();
                }
            } catch (error) {
                console.error('处理员工添加时出错:', error);
                showNotification('员工添加成功，但数据同步失败', true);
            }
        }

        // 处理员工修改到Supabase的函数（支持离线同步）
        async function handleEmployeeUpdateToSupabase(supabaseEmployee, employeeUniqueId) {
            try {
                // 获取当前选中的项目信息
                const projectSelect = document.getElementById('project-name');
                let selectedProjectId = null;
                
                if (projectSelect && projectSelect.selectedIndex >= 0 && projectSelect.value !== '') { // 确保选择的是真实项目而不是提示语
                    const selectedOption = projectSelect.options[projectSelect.selectedIndex];
                    selectedProjectId = projectSelect.value; // 获取项目ID
                    
                    // 如果项目信息中有更完整的ID信息，优先使用
                    if (selectedOption.dataset.projectInfo) {
                        try {
                            const projectInfo = JSON.parse(selectedOption.dataset.projectInfo);
                            selectedProjectId = projectInfo.id || projectSelect.value;
                        } catch (e) {
                            // 如果解析失败，使用select的value
                        }
                    }
                }

                // 添加项目唯一标识符到员工对象
                supabaseEmployee.project_id = selectedProjectId;

                // 检查是否在线
                if (navigator.onLine && window.supabase && typeof window.supabase.from === 'function') {
                    try {
                        let updateResult;
                        
                        if (employeeUniqueId) {
                            // 只使用员工唯一标识(employee_id)进行更新
                            const { error } = await window.supabase
                                .from('employees')
                                .update(supabaseEmployee)
                                .eq('employee_id', employeeUniqueId);
                            
                            updateResult = error ? { success: false, error: error.message } : { success: true };
                        } else {
                            // 创建新员工
                            const { error } = await window.supabase
                                .from('employees')
                                .insert(supabaseEmployee);
                            updateResult = error ? { success: false, error: error.message } : { success: true };
                        }

                        if (updateResult.success) {
                            console.log('员工数据已成功更新到Supabase');
                            console.log('✅ 员工修改成功！员工信息已更新到云端数据库');
                            showNotification('员工修改成功!', false);
                            
                            // 从数据库查询最新数据，获取正确的时间戳
                            if (employeeUniqueId) {
                                try {
                                    const { data: latestData, error: queryError } = await window.supabase
                                        .from('employees')
                                        .select('*')
                                        .eq('employee_id', employeeUniqueId)
                                        .single();
                                    
                                    if (!queryError && latestData) {
                                        // 更新本地数据，包括数据库设置的时间戳
                                        const employee = employees.find(emp => 
                                            String(emp.employee_id) === employeeUniqueId
                                        );
                                        if (employee) {
                                            Object.assign(employee, latestData);
                                        }
                                    }
                                } catch (queryErr) {
                                    console.warn('查询最新数据失败，继续使用前端数据:', queryErr);
                                }
                            }
                        } else {
                            console.error('更新到Supabase失败:', updateResult.error);
                            // 添加到同步队列，稍后重试
                            if (window.offlineSyncService) {
                                window.offlineSyncService.addToSyncQueue('update', supabaseEmployee, employeeUniqueId);
                            }
                            console.log('✅ 员工修改成功！员工信息已保存到同步队列，将在网络恢复后自动同步');
                        showNotification('员工修改成功，将在网络恢复后自动同步到云端', false);
                        }
                    } catch (supabaseError) {
                        console.error('Supabase操作异常:', supabaseError);
                        // 添加到同步队列
                        if (window.offlineSyncService) {
                            window.offlineSyncService.addToSyncQueue('update', supabaseEmployee, employeeUniqueId);
                        }
                        showNotification('员工修改成功，将在网络恢复后自动同步到云端', false);
                    }
                } else {
                    // 离线状态，添加到同步队列
                    if (window.offlineSyncService) {
                        window.offlineSyncService.addToSyncQueue('update', supabaseEmployee, employeeUniqueId);
                    }
                    console.log('✅ 员工修改成功！员工信息已保存到离线同步队列');
                    showNotification('员工修改成功（离线模式），将在网络恢复后自动同步', false);
                }
            } catch (error) {
                console.error('处理员工修改时出错:', error);
                console.log('⚠️ 员工修改成功，但数据同步失败，请检查网络连接');
                    showNotification('员工修改成功，但数据同步失败', true);
            }
        }

        // 处理员工删除到Supabase的函数（支持离线同步）
        async function handleEmployeeDeleteToSupabase(employeeUniqueId) {
            try {
                // 显示本地删除成功通知
                const isOnline = window.offlineSyncService && window.offlineSyncService.syncStatus.isOnline;
                showNotification(isOnline ? '员工删除成功' : '员工删除成功（本地保存）', false);

                // 然后异步删除云端数据
                setTimeout(async () => {
                    try {
                        const phone = localStorage.getItem('loggedInPhone');
                        if (!phone) {
                            console.error('未找到用户手机号');
                            return;
                        }

                        // 检查是否在线
                        if (window.offlineSyncService && window.offlineSyncService.syncStatus.isOnline) {
                            // 在线时直接删除云端数据
                            try {
                                const { error } = await window.supabase
                                    .from('employees')
                                    .delete()
                                    .eq('employee_id', employeeUniqueId);
                                
                                if (error) {
                                    console.error('从Supabase删除失败:', error);
                                    // 如果云端删除失败，添加到同步队列
                                    if (window.offlineSyncService) {
                                        await window.offlineSyncService.addToSyncQueue('delete', null, employeeUniqueId);
                                    }
                                } else {
                                    console.log('✅ 员工数据已成功从Supabase删除');
                                }
                            } catch (supabaseError) {
                                console.error('Supabase删除操作异常:', supabaseError);
                                // 如果云端删除失败，添加到同步队列
                                if (window.offlineSyncService) {
                                    await window.offlineSyncService.addToSyncQueue('delete', null, employeeUniqueId);
                                }
                            }
                        } else {
                            // 离线时添加到同步队列
                            if (window.offlineSyncService) {
                                await window.offlineSyncService.addToSyncQueue('delete', null, employeeUniqueId);
                            }
                        }
                    } catch (error) {
                        console.error('删除员工数据到云端失败:', error);
                        // 如果云端删除失败，尝试添加到同步队列
                        if (window.offlineSyncService) {
                            try {
                                await window.offlineSyncService.addToSyncQueue('delete', null, employeeUniqueId);
                            } catch (queueError) {
                            }
                        }
                    }
                }, 0);
            } catch (error) {
                console.error('处理员工删除时出错:', error);
                showNotification('员工删除成功，但数据同步失败', true);
            }
        }
        async function openAttendanceSheet() {
            try {
                // 检查是否选择了项目
                const selectedProject = document.getElementById('project-name').value;
                if (!selectedProject) {
                    alert('没有可用的项目，请先创建项目');
                    return;
                }

                // 检查是否有员工数据
                const rows = document.querySelectorAll('#employee-table tbody tr');
                if (rows.length === 0) {
                    showNotification('没有员工数据可供创建记工表', true);
                    return;
                }

                // 显示选择模态框
                document.getElementById('export-choice-modal').style.display = 'flex';
            } catch (e) {
                showNotification(`打开选择框失败：${e.message}`, true);
            }
        }

        // 生成PDF记工表
        async function generateAttendancePDF() {
            try {
                // 获取所有员工数据
                const rows = document.querySelectorAll('#employee-table tbody tr');
                const employeeData = [];
                rows.forEach(row => {
                    if (row.style.display !== 'none') {
                        const employeeId = row.dataset.id;
                        // 使用UUID格式的employee_id查找员工
                        const employee = employees.find(emp =>
                            emp.employee_id === employeeId
                        );
                        if (employee) {
                            employeeData.push({
                                emp_code: employee.emp_code,
                                emp_name: employee.emp_name,
                                phone: employee.phone,
                                status: employee.status,
                                labor_cost: employee.labor_cost,
                                id_card: employee.id_card,
                                hire_date: employee.hire_date,
                                leave_date: employee.leave_date,
                                remarks: employee.remarks,
                                bank_name: employee.bank_name,
                                bank_card_number: employee.bank_card_number,
                                bank_address: employee.bank_address
                            });
                        }
                    }
                });

                // 获取项目名称
                const projectSelect = document.getElementById('project-name');
                const selectedOption = projectSelect.options[projectSelect.selectedIndex];
                const projectName = selectedOption ? selectedOption.textContent : '未选择项目';

                await PDFGenerator.generateAttendancePDF(employeeData, projectName);
                showNotification('记工表PDF生成成功', false);

                // 关闭模态框
                document.getElementById('export-choice-modal').style.display = 'none';
            } catch (e) {
                showNotification(`生成PDF失败：${e.message}`, true);
            }
        }

        // 生成Excel员工信息
        async function generateEmployeeExcel() {
            try {
                // 检查是否有员工数据
                const rows = document.querySelectorAll('#employee-table tbody tr');
                if (rows.length === 0) {
                    showNotification('没有员工数据可供导出', true);
                    return;
                }

                // 获取当前日期作为默认值
                const currentDate = new Date();
                const formattedDate = currentDate.getFullYear() +
                                    String(currentDate.getMonth() + 1).padStart(2, '0') +
                                    String(currentDate.getDate()).padStart(2, '0');
                const defaultFilename = `员工信息_${formattedDate}.xlsx`;

                // 创建Excel工作簿
                const workbook = new ExcelJS.Workbook();

                // === 添加员工信息工作表 ===
                const employeeWorksheet = workbook.addWorksheet('员工信息');

                // 获取所有员工数据
                const visibleEmployees = [];
                rows.forEach(row => {
                    if (row.style.display !== 'none') {
                        const employeeId = row.dataset.id;
                        // 使用UUID格式的employee_id查找员工
                        const employee = employees.find(emp =>
                            emp.employee_id === employeeId
                        );
                        if (employee) {
                            // 动态计算身份证验证、性别和年龄信息
                            const idCardInfo = calculateIdCardInfo(employee.id_card);

                            visibleEmployees.push({
                                employee_id: employee.emp_code,
                                empname: employee.emp_name,
                                empstatus: employee.status,
                                laborcost: employee.labor_cost,
                                empphone: employee.phone,
                                身份证: employee.id_card,
                                入职日期: employee.hire_date,
                                离职日期: employee.leave_date,
                                备注: employee.remarks,
                                判断: idCardInfo.idcardValid,
                                性别: idCardInfo.gender,
                                年龄: idCardInfo.age,
                                银行: employee.bank_name,
                                卡号: employee.bank_card_number,
                                开户行地址: employee.bank_address
                            });
                        }
                    }
                });

                // 准备表头
                const headers = ['工号', '姓名', '状态', '工价', '电话', '身份证', '入职日期', '离职日期', '备注', '判断', '性别', '年龄', '银行', '卡号', '开户行地址'];

                // 添加表头行并设置样式
                const headerRow = employeeWorksheet.addRow(headers);
                headerRow.height = 22;

                // 为表头前15列（A~O）设置样式和边框
                headerRow.eachCell((cell, colNumber) => {
                    // 只为前15列设置样式
                    if (colNumber <= 15) {
                        cell.font = {
                            bold: true,
                            color: { argb: 'FFFF0000' }
                        };
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFFFFFFF' }
                        };
                        cell.border = {
                            top: { style: 'thin', color: { argb: 'FF000000' } },
                            left: { style: 'thin', color: { argb: 'FF000000' } },
                            bottom: { style: 'thin', color: { argb: 'FF000000' } },
                            right: { style: 'thin', color: { argb: 'FF000000' } }
                        };
                    }
                    // 设置文字对齐方式：水平垂直居中
                    cell.alignment = {
                        horizontal: 'center',
                        vertical: 'middle'
                    };
                });

                // 添加数据行
                visibleEmployees.forEach(employee => {
                    // 确保所有字段都有值，即使是空字符串
                    // 处理纯数字问题，确保空值保持为空
                    const employeeId = employee.employee_id || '';
                    const laborcost = employee.laborcost || '';
                    const empphone = employee.empphone || '';
                    const age = employee.年龄 || '';
                    const empname = employee.empname || '';
                    const 卡号 = employee.卡号 || '';
                    const 身份证 = employee.身份证 || '';

                    // 只有非空值才尝试转换为数字
                    const employeeIdNum = employeeId ? Number(employeeId) : NaN;
                    const laborcostNum = laborcost ? Number(laborcost) : NaN;
                    const empphoneNum = empphone ? Number(empphone) : NaN;
                    const ageNum = age ? Number(age) : NaN;
                    const empnameNum = empname ? Number(empname) : NaN;

                    const rowData = [
                        !isNaN(employeeIdNum) ? employeeIdNum : employeeId,
                        !isNaN(empnameNum) ? empnameNum : empname,
                        employee.empstatus || '',
                        !isNaN(laborcostNum) ? laborcostNum : laborcost,
                        !isNaN(empphoneNum) ? empphoneNum : empphone,
                        身份证,  // 身份证号作为文本处理
                        employee.入职日期 || '',
                        employee.离职日期 || '',
                        employee.备注 || '',
                        employee.判断 || '',
                        employee.性别 || '',
                        !isNaN(ageNum) ? ageNum : age,
                        employee.银行 || '',
                        卡号,  // 卡号作为文本处理
                        employee.开户行地址 || ''
                    ];

                    const row = employeeWorksheet.addRow(rowData);

                    // 设置数据行样式
                    row.height = 22;
                    row.eachCell((cell, colNumber) => {
                        // 为所有单元格添加边框，包括空单元格
                        cell.border = {
                            top: { style: 'thin', color: { argb: 'FF000000' } },
                            left: { style: 'thin', color: { argb: 'FF000000' } },
                            bottom: { style: 'thin', color: { argb: 'FF000000' } },
                            right: { style: 'thin', color: { argb: 'FF000000' } }
                        };

                        // 设置文字对齐方式
                        // 需要居中的列：状态(3)、工价(4)、电话(5)、身份证(6)、入职日期(7)、离职日期(8)、判断(10)、性别(11)、年龄(12)、卡号(14)
                        const centeredCols = [3, 4, 5, 6, 7, 8, 10, 11, 12, 14];
                        cell.alignment = {
                            vertical: 'middle',
                            horizontal: centeredCols.includes(colNumber) ? 'center' : 'left'
                        };
                    });
                });

                // 设置列宽
                employeeWorksheet.columns = [
                    { width: 5 },  // empid
                    { width: 8 },  // empname
                    { width: 6 },  // empstatus
                    { width: 6 },  // laborcost
                    { width: 12 }, // empphone
                    { width: 20 }, // id_card
                    { width: 12 }, // hire_data
                    { width: 12 }, // leave_data
                    { width: 15 }, // remarks
                    { width: 6 },  // 判断
                    { width: 6 },  // 性别
                    { width: 6 },  // 年龄
                    { width: 10 }, // bank_name
                    { width: 20 }, // bank_card_number
                    { width: 20 }  // bank_address
                ];

                // 生成Excel文件
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], {type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
                saveAs(blob, defaultFilename);
                showNotification('员工信息Excel生成成功', false);

                // 关闭模态框
                document.getElementById('export-choice-modal').style.display = 'none';
            } catch (e) {
                showNotification(`生成Excel失败：${e.message}`, true);
            }
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            color: #333;
            min-height: 100vh;
            padding: 10px 10px 20px 10px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 25px;
            box-shadow: 0 0 40px rgba(102, 126, 234, 0.2), 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            transition: max-width 0.3s ease;
        }
        

        .button-frame {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: nowrap; /* 禁止换行 */
            gap: 10px;
            white-space: nowrap; /* 防止内容换行 */
        }
        
        /* 现代复选框组样式 - 已移除背景和边框 */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 15px;
            /* background: #ffffff; */
            /* padding: 12px 16px; */
            /* border-radius: 12px; */
            /* box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); */
            /* border: 1px solid #e5e7eb; */
            transition: all 0.3s ease;
            flex-wrap: nowrap; /* 禁止换行 */
        }
        
        /* 自定义复选框样式 */
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
            padding: 6px 10px;
            border-radius: 8px;
            position: relative;
        }
        
        .checkbox-item:hover {
            background: #f3f4f6;
        }
        
        /* 隐藏默认复选框 */
        .checkbox-group input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }
        
        /* 自定义复选框外观 */
        .custom-checkbox {
            content: "";
            display: inline-block;
            width: 18px;
            height: 18px;
            background: #ffffff;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            transition: all 0.3s ease;
            position: relative;
            flex-shrink: 0;
        }
        
        /* 筛选模态框中的自定义复选框 */
        .filter-modal-content .custom-checkbox {
            width: 20px;
            height: 20px;
        }
        
        /* 选中状态样式 */
        .checkbox-item input[type="checkbox"]:checked + .custom-checkbox {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* 选中状态的对勾 */
        .checkbox-item input[type="checkbox"]:checked + .custom-checkbox::after {
            content: "";
            position: absolute;
            left: 50%;
            top: 50%;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: translate(-50%, -60%) rotate(45deg);
            transition: all 0.3s ease;
        }
        
        /* 筛选模态框中选中状态的对勾 */
        .filter-modal-content .checkbox-item input[type="checkbox"]:checked + .custom-checkbox::after {
            left: 50%;
            top: 50%;
            width: 6px;
            height: 12px;
            transform: translate(-50%, -60%) rotate(45deg);
        }
        
        /* 复选框标签样式 */
        .checkbox-group label {
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            user-select: none;
            font-size: 14px;
            transition: color 0.2s ease;
            position: relative;
        }
        
        /* 选中状态的标签样式 */
        .checkbox-item input[type="checkbox"]:checked + label {
            color: #667eea;
            font-weight: 600;
        }
        
        /* 筛选模态框中的复选框组样式 */
        .filter-modal-content .checkbox-group {
            margin-top: 8px;
            width: 100%;
            padding: 10px;
            flex-direction: row;
            align-items: flex-start;
        }
        
        .filter-modal-content .checkbox-item {
            font-size: 14px;
            padding: 4px 8px;
        }
        
        .filter-modal-content .checkbox-item::before {
            width: 20px;
            height: 20px;
        }
        
        .filter-modal-content .checkbox-item input[type="checkbox"]:checked + label::after {
            left: 13px;
            top: 10px;
            width: 6px;
            height: 12px;
        }
        
        /* 项目下拉框样式 */
        #project-name {
            color: #8B0000 !important;
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            padding: 4px 6px;
            font-weight: 600;
            font-size: 10px;
            min-width: 90px;
            transition: all 0.3s ease;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.02);
        }
        
        #project-name:hover {
            border-color: #667eea;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
            transform: translateY(-1px);
        }
        
        #project-name option {
            color: #8B0000 !important;
            padding: 8px;
        }
        
        .button-group {
            display: flex;
            gap: 6px;
        }

        .right-buttons {
            display: flex;
            gap: 6px;
            margin-left: auto;
        }
        
        button {
            padding: 4px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 10px;
            font-weight: 600;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            box-shadow: 0 1px 6px rgba(0, 0, 0, 0.03);
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s;
        }
        
        button:hover::before {
            left: 100%;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        #add-btn, #edit-btn, #delete-btn, #filter-btn {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            color: white;
            border: 2px solid rgba(100, 116, 139, 0.3);
            padding: 4px 8px; /* 减小水平内边距以减小宽度 */
        }
        
        #add-btn:hover, #edit-btn:hover, #delete-btn:hover, #filter-btn:hover {
            background: linear-gradient(135deg, #475569 0%, #334155 100%);
            box-shadow: 0 12px 30px rgba(71, 85, 105, 0.4);
        }
        
        #add-save-btn, #edit-save-btn, #confirm-delete-btn, #filter-apply-btn, 
        #font-confirm-btn, #font-apply-btn, #attendance-btn, #font-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: 2px solid rgba(102, 126, 234, 0.3);
        }
        

        
        #add-save-btn:hover, #edit-save-btn:hover, #confirm-delete-btn:hover, 
        #filter-apply-btn:hover, #font-confirm-btn:hover, #font-apply-btn:hover, 
        #attendance-btn:hover, #font-btn:hover {
            background: linear-gradient(135deg, #5b6fd8 0%, #6b46c1 100%);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
        }
        

        
        #add-cancel-btn, #edit-cancel-btn, #delete-cancel-btn, #filter-cancel-btn, #font-cancel-btn {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            color: #64748b;
            border: 2px solid rgba(226, 232, 240, 0.8);
        }
        
        #add-cancel-btn:hover, #edit-cancel-btn:hover, #delete-cancel-btn:hover, 
        #filter-cancel-btn:hover, #font-cancel-btn:hover {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            box-shadow: 0 8px 20px rgba(148, 163, 184, 0.3);
        }
        
        .employee-frame {
            padding: 10px 10px; /* 减小左右padding */
            background: rgba(255, 255, 255, 0.95);
            overflow-x: auto;
            position: relative;
        }
        
        /* 底部固定按钮容器样式 */
        .bottom-fixed-buttons {
            position: fixed;
            bottom: 0px;
            left: 10px;
            z-index: 9999;
            display: flex;
            gap: 6px;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(226, 232, 240, 0.8);
            cursor: move;
            user-select: none;
        }
        
        /* 拖拽时的样式 */
        .bottom-fixed-buttons.dragging {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            opacity: 0.8;
        }
        
        .bottom-fixed-buttons button {
            padding: 4px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 10px;
            font-weight: 600;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            box-shadow: 0 1px 6px rgba(0, 0, 0, 0.03);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: 2px solid rgba(102, 126, 234, 0.3);
        }
        
        .bottom-fixed-buttons button:hover {
            background: linear-gradient(135deg, #5b6fd8 0%, #6b46c1 100%);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }
        
        .bottom-fixed-buttons button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s;
        }
        
        .bottom-fixed-buttons button:hover::before {
            left: 100%;
        }
        
        #employee-container {
            max-height: 76vh;
            overflow-y: auto;
            overflow-x: auto;
            position: relative;
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 8px; /* 减小圆角 */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05), 0 2px 6px rgba(0, 0, 0, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
        }
        
        #employee-container:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08), 0 4px 12px rgba(0, 0, 0, 0.03);
        }
        
        table {
            min-width: 100%;
            width: auto;
            border-collapse: separate;
            border-spacing: 0;
            border: 1px solid #94a3b8;
        }
        
        th, td {
            padding: 8px 6px;
            text-align: center;
            border: 1px solid #94a3b8;
            white-space: nowrap;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            font-weight: 700;
            color: #ffffff;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid #64748b;
            border-right: 1px solid #64748b;
            font-size: 13px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        tr:nth-child(even) {
            background: #DDEBF7;
        }
        
        tr:nth-child(odd) {
            background: #FFFFFF;
        }
        
        tr:hover {
            background: linear-gradient(135deg, rgba(254, 243, 199, 0.9) 0%, rgba(253, 230, 138, 0.8) 100%) !important; /* 浅黄色高亮 */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        }

        /* 确保鼠标悬停时所有列（包括固定列）颜色一致 */
        tr:hover td {
            background: linear-gradient(135deg, rgba(254, 243, 199, 0.9) 0%, rgba(253, 230, 138, 0.8) 100%) !important;
        }
        
        tr.active-row {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%) !important;
            color: white;
            box-shadow: 0 6px 18px rgba(14, 165, 233, 0.3);
        }
        
        tr.active-row td {
            /* 保持与固定列一致的边框颜色 */
            border-color: #94a3b8;
        }

        /* 固定列样式 - 工号 */
        table th:nth-child(1),
        table td:nth-child(1) {
            position: sticky;
            left: 0;
            z-index: 100; /* 大幅提高z-index，确保覆盖所有内容 */
            background-clip: padding-box;
            /* 解决滚动时边框闪烁问题 */
            outline: 1px solid #94a3b8;
            outline-offset: -1px;
            /* 增强左边框 */
            border-left: 1px solid #94a3b8;
        }
        
        table th:nth-child(1) {
            z-index: 200; /* 表头需要更高，必须高于 tr:hover td 的 120 */
            outline: 1px solid #64748b; /* 表头使用更深的边框颜色 */
            outline-offset: -1px;
            /* 增强左边框 */
            border-left: 1px solid #64748b;
        }
        
        /* 固定列样式 - 姓名 */
        table th:nth-child(2),
        table td:nth-child(2) {
            position: sticky;
            left: 0; /* 初始值，JS中会动态计算 */
            z-index: 90;
            background-clip: padding-box;
            /* 解决滚动时边框闪烁问题 */
            outline: 1px solid #94a3b8;
            outline-offset: -1px;
        }

        table th:nth-child(2) {
            z-index: 190; /* 必须高于 tr:hover td 的 120 */
            outline: 1px solid #64748b; /* 表头使用更深的边框颜色 */
            outline-offset: -1px;
        }
        
        /* 确保固定列背景色正确，避免透明 */
        table td:nth-child(1),
        table td:nth-child(2) {
            background-color: #ffffff;
        }

        /* 偶数行固定列背景色 */
        tr:nth-child(even) td:nth-child(1),
        tr:nth-child(even) td:nth-child(2) {
            background-color: #DDEBF7;
        }

        /* 奇数行固定列背景色 */
        tr:nth-child(odd) td:nth-child(1),
        tr:nth-child(odd) td:nth-child(2) {
            background-color: #ffffff;
        }

        /* 确保选中行的所有列（包括固定列）颜色一致 */
        tr.active-row td {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%) !important;
            color: white;
        }
        
        /* 表格底部圆角 */
        table tr:last-child td:first-child {
            border-bottom-left-radius: 8px;
        }
        
        table tr:last-child td:last-child {
            border-bottom-right-radius: 8px;
        }

        /* 鼠标悬停行固定列背景色 */
        tr:hover td:nth-child(1),
        tr:hover td:nth-child(2) {
            background: linear-gradient(135deg, rgba(254, 243, 199, 1) 0%, rgba(253, 230, 138, 1) 100%) !important;
            /* 确保悬停时固定列z-index更高 */
            z-index: 120 !important;
        }

        /* 选中行固定列背景色 */
        tr.active-row td:nth-child(1),
        tr.active-row td:nth-child(2) {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%) !important;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            padding: 20px 20px 10px 20px;
            border-radius: 25px;
            width: 380px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2), 0 10px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.8);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        #add-modal .modal-content, #edit-modal .modal-content {
            height: auto;
            overflow-y: auto;
            max-height: 90vh;
            min-height: 250px; /* 减小最小高度以在折叠时更紧凑 */
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 700;
            color: #1e293b;
            font-size: 13px;
        }
        
        /* 基础输入框和选择框样式 */
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: #ffffff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            color: #374151;
            appearance: none;
            position: relative;
        }
        
        /* 自定义下拉箭头 */
        .form-group select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }
        
        /* 聚焦状态样式 */
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1), 0 2px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }
        
        /* 悬停状态样式 */
        .form-group input:hover, .form-group select:hover {
            border-color: #cbd5e1;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.07);
        }
        
        /* 禁用状态样式 */
        .form-group input:disabled, .form-group select:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #f9fafb;
        }
        
        /* 自定义复选框样式 */
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
        }
        
        /* 隐藏原生复选框 */
        .custom-checkbox-input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }
        
        /* 自定义复选框外观 */
        .custom-checkbox-display {
            width: 18px;
            height: 18px;
            background: #ffffff;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        /* 选中状态样式 */
        .custom-checkbox-input:checked + .custom-checkbox-display {
            background: #ef4444;
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }
        
        /* 选中状态的对勾 */
        .custom-checkbox-input:checked + .custom-checkbox-display::after {
            content: "";
            position: absolute;
            left: 50%;
            top: 50%;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: translate(-50%, -60%) rotate(45deg);
            transition: all 0.3s ease;
        }
        
        /* 复选框文本样式 */
        .checkbox-text {
            font-weight: 500;
            color: #374151;
            font-size: 14px;
        }
        
        /* 字体模态框中加粗选项样式 */
        #font-modal .checkbox-label {
            width: auto;
            display: flex;
            align-items: center;
        }
        
        /* 字体模态框中加粗复选框特定样式 */
        #font-bold {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        /* 调整字体模态框中字号和加粗选项的布局 */
        #font-modal div[style*="display: flex; gap: 20px; align-items: center;"] {
            flex-wrap: wrap;
            gap: 15px;
        }
        
        /* 调整字体模态框中加粗选项的form-group样式 */
        #font-modal .form-group {
            margin-bottom: 0;
        }
        
        .form-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            gap: 15px;
            margin-bottom: 0;
        }
        
        .filter-modal-content {
            width: 320px;
            padding: 15px;
        }
        
        /* 筛选模态框内部布局优化 */
        .filter-modal-content .form-group {
            margin-bottom: 15px;
        }
        
        .filter-modal-content .form-group label {
            font-size: 14px;
            margin-bottom: 8px;
            color: #334155;
        }
        
        .filter-modal-content #filter-status-group {
            margin-top: 8px;
        }
        
        /* 工价筛选下拉框样式优化 */
        .filter-modal-content #filter-wage {
            width: 120px;
            padding: 8px 10px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            font-size: 14px;
            transition: all 0.3s ease;
            height: 36px;
            margin-top: 8px;
        }
        
        .filter-modal-content #filter-wage:hover {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* 按钮样式优化 */
        .filter-modal-content .form-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
        }
        
        .filter-modal-content button {
            padding: 8px 16px;
            font-size: 14px;
        }
        
        .hidden-status {
            color: #f59e0b !important;
        }
        
        .resigned-status {
            color: #8b5cf6 !important;
        }
        
        .settled-status {
            color: #10b981 !important;
        }
        
        .duplicate-name {
            color: #ef4444 !important;
            font-weight: 600;
        }
        
        /* 自定义tooltip样式 */
        .custom-tooltip {
            position: absolute;
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 16px;
            font-weight: bold;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4), 0 6px 15px rgba(0, 0, 0, 0.25);
            pointer-events: none;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .custom-tooltip.show {
            opacity: 1;
            transform: translateY(-3px) scale(1.02);
        }
        
        .notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 18px 28px;
            border-radius: 20px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 15px 40px rgba(16, 185, 129, 0.4), 0 8px 20px rgba(16, 185, 129, 0.2);
            display: none;
            z-index: 9999;
            font-weight: 700;
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-size: 16px;
            min-width: 200px;
            text-align: center;
        }
        
        @keyframes notificationPop {
            0% {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0;
            }
            80% {
                transform: translate(-50%, -50%) scale(1.05);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        .notification.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 15px 40px rgba(239, 68, 68, 0.4), 0 8px 20px rgba(239, 68, 68, 0.2);
        }
        
        .form-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        /* 小屏幕适配样式 */
        @media screen and (max-width: 800px) {
            /* 调整按钮和容器间距 */
            .button-frame {
                padding: 6px 10px;
                gap: 6px;
                justify-content: flex-start;
            }

            /* 调整复选框组大小 */
            .checkbox-group {
                padding: 6px 8px;
                gap: 8px;
            }

            .checkbox-item {
                padding: 4px 6px;
                font-size: 12px;
            }

            .checkbox-group label {
                font-size: 12px;
            }

            .custom-checkbox {
                width: 14px;
                height: 14px;
            }
            
            .checkbox-item input[type="checkbox"]:checked + .custom-checkbox::after {
                width: 4px;
                height: 8px;
                left: 50%;
                top: 45%;
            }

            /* 调整项目下拉框 */
            #project-name {
                padding: 2px 4px;
                font-size: 12px;
                min-width: 70px;
                height: 28px;
            }

            /* 调整按钮大小 */
            button {
                padding: 3px 8px;
                font-size: 12px;
                height: 28px;
            }

            /* 调整按钮组间距 */
            .button-group, .right-buttons {
                gap: 4px;
            }

            /* 表格容器样式调整 - 确保出现滚动条 */
            #employee-container {
                overflow-x: auto;
                /* 确保容器宽度跟随屏幕变小 */
                width: 100% !important; 
                max-width: 100% !important;
            }

            /* 表格样式 - 确保内容不换行，保持列宽 */
            table {
                min-width: 800px; /* 设置最小宽度，确保在小屏幕下触发滚动 */
            }

            th, td {
                padding: 6px 4px; /* 稍微减小单元格内边距 */
                font-size: 12px; /* 稍微减小字体 */
            }
        }

        /* 顶部隐藏/折叠开关样式 - iOS风格 */
        .button-frame .checkbox-item {
            position: relative;
            width: 60px;
            height: 26px;
            border-radius: 13px;
            padding: 0;
            background: transparent;
            overflow: hidden;
            margin-right: 5px;
            border: none;
        }

        .button-frame .checkbox-item:hover {
            background: transparent;
        }

        /* 轨道 */
        .button-frame .checkbox-item .custom-checkbox {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 13px;
            background-color: #10b981; /* 绿色背景 */
            background-image: linear-gradient(135deg, #10b981, #059669);
            border: none;
            z-index: 1;
            transition: all 0.3s ease;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        /* 选中状态轨道 */
        .button-frame .checkbox-item input:checked + .custom-checkbox {
            background: #3b82f6;
            background-image: linear-gradient(135deg, #3b82f6, #2563eb);
            box-shadow: none;
            border: none;
        }

        /* 滑块 */
        .button-frame .checkbox-item .custom-checkbox::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            border: none;
            transform: none;
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* 选中状态滑块位置 */
        .button-frame .checkbox-item input:checked + .custom-checkbox::after {
            transform: translateX(34px);
            background: white;
            border: none;
            border-width: 0;
            
            /* 强制重置被全局样式覆盖的属性，防止圆点消失 */
            width: 20px;
            height: 20px;
            left: 3px;
            top: 3px;
            border-radius: 50%;
        }

        /* 文字 span */
        .button-frame .checkbox-item span:last-child {
            position: relative;
            z-index: 2;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
            pointer-events: none;
            
            /* 未选中状态：文字在右 */
            justify-content: flex-end;
            padding-right: 8px;
            color: white;
        }

        /* 选中状态文字 */
        .button-frame .checkbox-item input:checked ~ span:last-child {
            /* 选中状态：文字在左 */
            justify-content: flex-start;
            padding-left: 8px;
            color: white;
        }
        </style>
</head>
<body>
    <div class="container">
        <div class="button-frame">
            <div class="checkbox-group">
                <label class="checkbox-item" for="hide">
                    <input type="checkbox" id="hide" checked>
                    <span class="custom-checkbox"></span>
                    <span>隐藏</span>
                </label>
                <label class="checkbox-item" for="collapse">
                    <input type="checkbox" id="collapse" checked>
                    <span class="custom-checkbox"></span>
                    <span>折叠</span>
                </label>
                <select id="project-name">
                </select>
            </div>
            <div class="button-group">
                <button id="add-btn">添加</button>
                <button id="edit-btn">修改</button>
                <button id="delete-btn">删除</button>
                <button id="filter-btn">筛选</button>
            </div>
        </div>
        
        <div class="employee-frame">
            <div id="employee-container" style="max-height: 76vh; overflow-y: auto; position: relative;">
        <table id="employee-table">
                <thead>
                    <tr>
                        <th>工号</th>
                        <th>姓名</th>
                        <th>状态</th>
                        <th>工价</th>
                        <th>电话</th>
                        <th>身份证</th>
                        <th>入职日期</th>
                        <th>离职日期</th>
                        <th>备注</th>
                        <th>银行</th>
                        <th>卡号</th>
                        <th>开户行地址</th>
                    </tr>
                </thead>
                <tbody id="employee-tbody">
                    <!-- 员工数据将通过JavaScript动态添加 -->
                </tbody>
            </table>
        </div>
        </div>
    </div>

    <!-- 底部固定按钮容器 -->
    <div class="bottom-fixed-buttons">
        <button id="font-btn">字体</button>
        <button id="attendance-btn" onclick="openAttendanceSheet()">记工表</button>
    </div>

    <style>
    .form-row { display: flex; gap: 10px; margin-bottom: 15px; }
    .form-row .form-group { flex: 1; margin-bottom: 0; }
    </style>
    <!-- 添加员工模态框 -->
    <div class="modal" id="add-modal">
        <div class="modal-content">
            <h3 style="color: #ED7D31;">添加员工</h3>
            <!-- 默认显示的字段 -->
            <div class="form-row">
            <div class="form-group">
                <label for="add-name">★姓名:</label>
                <input type="text" id="add-name">
            </div>
            <div class="form-group">
                <label for="add-status">★状态:</label>
                <select id="add-status">
                    <option value="在职">在职</option>
                    <option value="隐藏">隐藏</option>
                </select>
            </div>
            <div class="form-group">
                <label for="add-wage">★工价:</label>
                <input type="text" id="add-wage" maxlength="3">
            </div>
            </div>
            <div class="form-row">
            <div class="form-group">
                <label for="add-phone">电话:</label>
                <input type="text" id="add-phone" maxlength="11">
            </div>
            <div class="form-group">
                <label for="add-entry-date">入职日期:</label>
                <input type="date" id="add-entry-date">
            </div>
            </div>
            
            <!-- 需要折叠的字段 -->
            <div id="add-extra-fields" style="display: none;">
                <div class="form-group">
                    <label for="add-id-card">身份证:</label>
                    <input type="text" id="add-id-card" maxlength="18">
                </div>
                <div class="form-row">
                <div class="form-group" style="width: 33.33%;">
                    <label for="add-bank">银行:</label>
                    <select id="add-bank">
                        <option value=""></option>
                        <option value="建设银行">建设银行</option>
                        <option value="农业银行">农业银行</option>
                        <option value="中国银行">中国银行</option>
                        <option value="邮政银行">邮政银行</option>
                        <option value="工商银行">工商银行</option>
                        <option value="农商银行">农商银行</option>
                        <option value="平安银行">平安银行</option>
                        <option value="交通银行">交通银行</option>
                        <option value="广发银行">广发银行</option>
                    </select>
                </div>
                <div class="form-group" style="width: 66.67%;">
                    <label for="add-bank-branch">开户行地址:</label>
                    <input type="text" id="add-bank-branch">
                </div>
                </div>
                <div class="form-group">
                    <label for="add-bank-card">卡号:</label>
                    <input type="text" id="add-bank-card" maxlength="19">
                </div>
                <div class="form-group">
                    <label for="add-remark">备注:</label>
                    <input type="text" id="add-remark">
                </div>
            </div>
            
            <div class="form-buttons">
                <button id="add-cancel-btn">取消</button>
                <button id="toggle-fields-btn" style="background: none; border: none; cursor: pointer; font-size: 18px; color: #1890ff;">▼</button>
                <button id="add-save-btn">添加</button>
            </div>
        </div>
    </div>

    <!-- 修改员工模态框 -->
    <div class="modal" id="edit-modal">
        <div class="modal-content">
            <h3 style="color: #ED7D31;">修改员工</h3>
            <input type="hidden" id="edit-id">
            <div class="form-row">
            <div class="form-group">
                <label for="edit-name">★姓名:</label>
                <input type="text" id="edit-name">
            </div>
            <div class="form-group">
                <label for="edit-status">★状态:</label>
                <select id="edit-status">
                    <option value="在职">在职</option>
                    <option value="隐藏">隐藏</option>
                    <option value="离职">离职</option>
                    <option value="结清">结清</option>
                </select>
            </div>
            <div class="form-group">
                <label for="edit-wage">★工价:</label>
                <input type="text" id="edit-wage" maxlength="3">
            </div>
            </div>
            <div class="form-row">
            <div class="form-group">
                <label for="edit-phone">电话:</label>
                <input type="text" id="edit-phone" maxlength="11">
            </div>

            <div class="form-group">
                <label for="edit-leave-date">离职日期:</label>
                <input type="date" id="edit-leave-date">
            </div>
            </div>
            
            <!-- 额外字段 - 默认折叠 -->
            <div id="edit-extra-fields" style="display: none;">
            <div class="form-group">
                <label for="edit-id-card">身份证:</label>
                <input type="text" id="edit-id-card" maxlength="18">
            </div>
            <div class="form-row">
            <div class="form-group" style="width: 33.33%;">
                <label for="edit-bank">银行:</label>
                <select id="edit-bank">
                    <option value=""></option>
                    <option value="建设银行">建设银行</option>
                    <option value="农业银行">农业银行</option>
                    <option value="中国银行">中国银行</option>
                    <option value="邮政银行">邮政银行</option>
                    <option value="工商银行">工商银行</option>
                    <option value="农商银行">农商银行</option>
                    <option value="平安银行">平安银行</option>
                    <option value="交通银行">交通银行</option>
                    <option value="广发银行">广发银行</option>
                </select>
            </div>
            <div class="form-group" style="width: 66.67%;">
                <label for="edit-bank-branch">开户行地址:</label>
                <input type="text" id="edit-bank-branch">
            </div>
            </div>
            <div class="form-group">
                <label for="edit-bank-card">卡号:</label>
                <input type="text" id="edit-bank-card" maxlength="19">
            </div>
            <div class="form-group">
                <label for="edit-remark">备注:</label>
                <input type="text" id="edit-remark">
            </div>
            </div>
            
            <div class="form-buttons">
                <button id="edit-cancel-btn">取消</button>
                <button id="edit-toggle-fields-btn" style="background: none; border: none; cursor: pointer; font-size: 18px; color: #1890ff;">▼</button>
                <button id="edit-save-btn">修改</button>
            </div>
        </div>
    </div>

    <!-- 筛选员工模态框 -->
    <div class="modal" id="filter-modal">
        <div class="modal-content filter-modal-content">
            <h3 style="color: #ED7D31;">筛选员工</h3>
            <div style="display: flex; gap: 25px; align-items: flex-start;">
                <div class="form-group" style="flex: 1;">
                    <label>状态筛选:</label>
                    <div class="checkbox-group" id="filter-status-group">
                        <div style="display: flex; gap: 15px; margin-bottom: 4px;">
                            <label class="checkbox-item">
                                <input type="checkbox" name="filter-status" value="在职" checked>
                                <span class="custom-checkbox"></span>
                                在职
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="filter-status" value="隐藏">
                                <span class="custom-checkbox"></span>
                                隐藏
                            </label>
                        </div>
                        <div style="display: flex; gap: 15px;">
                            <label class="checkbox-item">
                                <input type="checkbox" name="filter-status" value="离职">
                                <span class="custom-checkbox"></span>
                                离职
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="filter-status" value="结清">
                                <span class="custom-checkbox"></span>
                                结清
                            </label>
                        </div>
                    </div>
                </div>
                <div class="form-group" style="display: flex; flex-direction: column; justify-content: flex-start; gap: 8px;">
                    <label for="filter-wage">工价筛选:</label>
                    <select id="filter-wage">
                        <option value="全部">全部</option>
                    </select>
                </div>
            </div>
            <div class="form-buttons">
                <button id="filter-apply-btn">应用</button>
                <button id="filter-cancel-btn">取消</button>
            </div>
        </div>
    </div>

    <!-- 字体设置模态框 -->
    <div class="modal" id="font-modal">
        <div class="modal-content">
            <h3 style="color: #ED7D31;">字体</h3>
            <div class="form-group">
                <label for="font-family">字体:</label>
                <select id="font-family">
                    <option value="Microsoft YaHei">Microsoft YaHei</option>
                    <option value="SimSun">SimSun</option>
                    <option value="SimHei">SimHei</option>
                    <option value="KaiTi">KaiTi</option>
                    <option value="FangSong">FangSong</option>
                    <option value="Arial">Arial</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Calibri">Calibri</option>
                    <option value="Verdana">Verdana</option>
                    <option value="Courier New">Courier New</option>
                    <option value="Consolas">Consolas</option>
                    <option value="Tahoma">Tahoma</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Palatino Linotype">Palatino Linotype</option>
                </select>
            </div>
            <div style="display: flex; gap: 20px; align-items: center;">
                <div class="form-group">
                    <label for="font-size">字号:</label>
                    <select id="font-size">
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12" selected>12</option>
                        <option value="13">13</option>
                        <option value="14">14</option>
                        <option value="15">15</option>
                        <option value="16">16</option>
                        <option value="17">17</option>
                        <option value="18">18</option>
                        <option value="19">19</option>
                        <option value="20">20</option>
                        <option value="21">21</option>
                        <option value="22">22</option>
                        <option value="23">23</option>
                        <option value="24">24</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="font-bold" class="checkbox-label">
                        <input type="checkbox" id="font-bold" class="custom-checkbox-input">
                        <span class="custom-checkbox-display"></span>
                        <span class="checkbox-text">加粗</span>
                    </label>
                </div>
            </div>
            <div class="form-buttons">
                <button id="font-apply-btn">应用</button>
                <button id="font-confirm-btn">确定</button>
                <button id="font-cancel-btn">取消</button>
            </div>
        </div>
    </div>



    
    <script>
        // 全局变量
        let employees = [];
        let selectedEmployeeId = null;
        let deletePassword = null;
        let currentFont = { family: 'Microsoft YaHei', size: 14, bold: false };
        let isInitialized = false;
        let showWageData = true;
        // 员工数据缓存对象
        window.employeeDataCache = {};

        // 加载项目列表函数
        async function loadProjectList(targetProjectName = null) {
            return new Promise(async (resolve, reject) => {
                try {
                    let phone = localStorage.getItem('loggedInPhone');
                    
                    // 测试环境下使用测试手机号
                    if (!phone && window.location.hostname === 'localhost') {
                        phone = '13800138000';
                    }
                    
                    if (!phone) {
                        console.error('未找到用户手机号');
                        showNotification('未找到用户信息，请重新登录', true);
                        resolve();
                        return;
                    }

                    // 获取全局目标项目ID
                    const targetProjectId = window.targetProjectId;
                    
                    // 清空项目数组
                    let ongoingProjects = [];

                    // 1. 只从本地存储加载项目数据
                    
                    // 从本地存储获取项目数据
                    let allProjects = await loadLocalProjectIndex(phone);
                    
                    // 确保allProjects是数组
                    if (!Array.isArray(allProjects)) {
                        console.error('项目数据格式错误，应为数组:', allProjects);
                        allProjects = [];
                    }
                    

                    
                    // 4. 处理和标准化项目数据 - 使用更宽松的处理方式
                    const tempOngoingProjects = [];
                    
                    allProjects.forEach(project => {
                        // 跳过无效项目
                        if (!project || typeof project !== 'object') {
                            return;
                        }
                        
                        // 检查项目状态 - 更宽松的状态判断
                        const projectStatus = project.status || '';
                        const isOngoing = projectStatus === '在建' || 
                                        projectStatus.toLowerCase() === 'ongoing' ||
                                        !projectStatus; // 如果没有状态，默认为在建
                        
                        // 确保项目有必要的字段（标准化处理）
                        
                        const projectInfo = {
                            project_id: project.project_id,
                            project_name: project.project_name || '未命名项目',
                            date: project.date || new Date().toISOString().split('T')[0],
                            count: project.count || 0,
                            status: isOngoing ? '在建' : projectStatus,
                            phone: project.phone || phone,
                            address: project.address || '',
                            created_at: project.created_at || new Date(new Date().getTime() + 8 * 60 * 60 * 1000).toISOString(),
                            updated_at: project.updated_at || new Date(new Date().getTime() + 8 * 60 * 60 * 1000).toISOString()
                        };
                        
                        // 对于"在建"状态的项目，直接添加（暂时移除一些限制条件）
                        if (projectInfo.status === '在建') {
                            tempOngoingProjects.push(projectInfo);
                        }
                    });
                    
                    ongoingProjects = tempOngoingProjects;
                    
                    // 如果有目标项目ID，过滤出该项目
                    if (targetProjectId) {
                        ongoingProjects = ongoingProjects.filter(project => project.project_id === targetProjectId);
                    }

                    // 5. 处理项目列表并填充下拉框
                    const projectSelect = document.getElementById('project-name');
                    
                    // 确保项目选择器存在
                    if (!projectSelect) {
                        console.error('未找到项目选择器元素');
                        showNotification('页面元素缺失', true);
                        resolve();
                        return;
                    }
                    
                    // 清空现有选项
                    projectSelect.innerHTML = '';
                    
                    if (ongoingProjects && ongoingProjects.length > 0) {
                        
                        // 按项目创建时间排序（最新的在前）
                        ongoingProjects.sort((a, b) => {
                            const timeA = new Date(a.created_at || '2000-01-01').getTime();
                            const timeB = new Date(b.created_at || '2000-01-01').getTime();
                            return timeB - timeA; // 降序排列，最新的在前
                        });
                        
                        // 如果没有传入目标项目且没有目标项目ID，添加提示选项
                        if (!targetProjectName && !targetProjectId) {
                            const hintOption = document.createElement('option');
                            hintOption.value = '';
                            hintOption.textContent = '请选择项目';
                            hintOption.disabled = true; // 禁用此选项，使其不能被选择
                            hintOption.selected = true; // 设置为选中状态
                            hintOption.style.color = '#999'; // 灰色字体表示提示
                            projectSelect.appendChild(hintOption);
                        }
                        
                        // 添加真实项目到下拉框
                        ongoingProjects.forEach((project, index) => {
                            const option = document.createElement('option');
                            // 始终使用项目ID作为值，确保project_id正确传递
                            option.value = project.project_id;
                            option.textContent = project.project_name;
                            // 存储完整项目信息到option元素上，便于后续使用
                            option.dataset.projectInfo = JSON.stringify(project);
                            option.style.color = '#8B0000'; // 深红色字体
                            projectSelect.appendChild(option);

                        });
                        
                        // 修改默认选择逻辑
                        let selectedProjectName = null;
                        let selectedProjectId = null;
                        
                        // 如果有目标项目ID或名称且存在，则选择该目标项目
                        if ((targetProjectId || targetProjectName) && ongoingProjects.length > 0) {
                            // 优先使用项目ID查找
                            const targetProject = targetProjectId ? 
                                ongoingProjects.find(p => p.project_id === targetProjectId) :
                                ongoingProjects.find(p => p.project_name === targetProjectName || p.project_id === targetProjectName);
                            
                            if (targetProject) {
                                selectedProjectName = targetProject.project_name;
                            selectedProjectId = targetProject.project_id;
                                
                                // 将项目ID存储到全局变量中，供父页面访问
                                window.selectedProjectId = selectedProjectId;
                                
                                // 设置选中的项目并加载员工数据
                                // 使用标志变量避免change事件触发重复加载
                                window.skipProjectChangeEvent = true;
                                // 优先使用ID作为值，确保准确性
                                projectSelect.value = selectedProjectId;
                                
                                // 加载选中项目的员工数据 - 注意参数顺序：第一个是名称，第二个是ID
                                await loadEmployeeDataForProject(selectedProjectName, selectedProjectId);
                                
                                // 重置标志变量
                                setTimeout(() => {
                                    window.skipProjectChangeEvent = false;
                                }, 100);
                            }
                        } else if (!targetProjectName && ongoingProjects.length > 0) {
                            // 没有传入目标项目时，不自动选择任何项目，保持提示语显示
                            projectSelect.value = '';
                        }
                        
                        // 通知已取消
                    } else {
                        // 尝试从localStorage直接获取项目数据作为最后的备选方案
                        // 从currentUser获取user_id
                        let userId = 'default';
                        try {
                            const currentUserStr = localStorage.getItem('currentUser');
                            if (currentUserStr) {
                                const currentUser = JSON.parse(currentUserStr);
                                userId = currentUser.user_id || 'default';
                            }
                        } catch (e) {
                            console.error('解析currentUser失败:', e);
                        }
                        const directProjectKey = 'project_cache_' + userId;
                        const directProjectData = localStorage.getItem(directProjectKey);
                        if (directProjectData) {
                            try {
                                const parsed = JSON.parse(directProjectData);
                            } catch (e) {
                                console.error('解析直接项目数据失败:', e);
                            }
                        }
                        showNotification('未找到在建项目，请检查项目状态或联系管理员', true);
                    }
                    
                    resolve();
                } catch (error) {
                    showNotification('加载项目列表失败: ' + error.message, true);
                    resolve(); // 即使出错也resolve，避免阻塞
                }
            });
        }
        

        // 更新本地项目索引
        async function updateLocalProjectIndex(ongoingProjects) {
            try {
                const allProjects = ongoingProjects.map(p => ({...p, status: '在建'}));
                
                // 从currentUser获取user_id
                let userId = 'default';
                try {
                    const currentUserStr = localStorage.getItem('currentUser');
                    if (currentUserStr) {
                        const currentUser = JSON.parse(currentUserStr);
                        userId = currentUser.user_id || 'default';
                    }
                } catch (e) {
                    console.error('解析currentUser失败:', e);
                }
                
                // 只使用数组格式的project_cache_${userId}
                const cacheKey = 'project_cache_' + userId;
                localStorage.setItem(cacheKey, JSON.stringify(allProjects));
                
                console.log('✅ 项目数据已更新（仅使用数组格式）');

            } catch (error) {
                console.error('更新项目数据失败:', error);
            }
        }

        // 从本地存储加载项目索引 - 现在只使用project_cache格式
        async function loadLocalProjectIndex() {
            try {
                // 从currentUser获取user_id
                let userId = 'default';
                try {
                    const currentUserStr = localStorage.getItem('currentUser');
                    if (currentUserStr) {
                        const currentUser = JSON.parse(currentUserStr);
                        userId = currentUser.user_id || 'default';
                    }
                } catch (e) {
                    console.error('解析currentUser失败:', e);
                }

                // 只使用project_cache_${userId}格式，简化加载逻辑
                const cacheKey = 'project_cache_' + userId;
                const data = localStorage.getItem(cacheKey);
                
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        return Array.isArray(parsed) ? parsed : (parsed.projects || []);
                    } catch (e) {
                        console.error('解析项目数据失败:', e);
                    }
                }
                
                // 如果没有找到用户特定的数据，尝试默认的缓存键
                const defaultCacheKey = 'project_cache_default';
                const defaultData = localStorage.getItem(defaultCacheKey);
                
                if (defaultData) {
                    try {
                        const parsed = JSON.parse(defaultData);
                        console.log('使用默认project_cache格式的项目数据');
                        return Array.isArray(parsed) ? parsed : (parsed.projects || []);
                    } catch (e) {
                        console.error('解析默认项目数据失败:', e);
                    }
                }
                
                console.log('未找到项目数据');
                return [];
            } catch (error) {
                console.error('加载项目数据失败:', error);
                return [];
            }
        }

        // 初始化函数
        function init() {
            // 设置当前日期为入职日期默认值
            const today = new Date().toISOString().split('T')[0];

            // 从URL参数获取项目名称
            const urlParams = new URLSearchParams(window.location.search);
            const projectNameFromUrl = urlParams.get('project_name');
            const projectIdFromUrl = urlParams.get('project_id');
            const targetProjectName = projectNameFromUrl ? decodeURIComponent(projectNameFromUrl) : null;
            const targetProjectId = projectIdFromUrl ? decodeURIComponent(projectIdFromUrl) : null;

            // 加载数据
            loadData();
            
            // 将项目ID存储在全局变量中，供loadProjectList函数使用
            window.targetProjectId = targetProjectId;

            // 读取保存的工价显示状态
            const savedShowWageData = localStorage.getItem('showWageData');
            if (savedShowWageData !== null) {
                showWageData = JSON.parse(savedShowWageData);
            }

            // 设置初始状态
            document.getElementById('hide').checked = true;
            document.getElementById('collapse').checked = true;

            // 应用初始状态
            document.getElementById('edit-btn').disabled = false;
            toggleCollapse();

            // 加载项目列表，并设置目标项目
            loadProjectList(targetProjectName).then(() => {
                // 项目列表加载完成后，获取当前选中的项目名称和ID
                const projectSelect = document.getElementById('project-name');
                const selectedProjectId = projectSelect.value;
                
                // 获取项目名称
                let selectedProjectName = null;
                const selectedOption = projectSelect.options[projectSelect.selectedIndex];
                if (selectedOption && selectedOption.dataset.projectInfo) {
                    try {
                        const projectInfo = JSON.parse(selectedOption.dataset.projectInfo);
                            selectedProjectName = projectInfo.project_name;
                    } catch (e) {
                        // 如果解析失败，使用选项文本作为项目名称
                        selectedProjectName = selectedOption ? selectedOption.textContent : '';
                    }
                } else {
                    // 如果没有项目信息，使用选项文本作为项目名称
                    selectedProjectName = selectedOption ? selectedOption.textContent : '';
                }
                
                // 员工数据已在loadProjectList函数内部设置默认项目时加载
                // 这里只处理后续操作，避免重复加载
                if (selectedProjectName && selectedProjectId) {
                    // 发送消息给父页面，更新返回列表的标题
                    const targetOrigin = window.location.origin || '*';
                    window.parent.postMessage({
                        type: 'updateTitle',
                        title: `${selectedProjectName} - 员工录入 (${selectedProjectId})`,
                        onlyUpdateHistory: true // 只更新历史记录，不更新页面标题
                    }, targetOrigin);
                    
                    // 尝试加载员工数据
                    loadEmployeeDataForProject(selectedProjectName, selectedProjectId).then(() => {
                        // 为每个员工处理身份证信息（不再计算判断、性别和年龄字段）
                        employees.forEach(employee => {
                            processIdCardInfo(employee);
                        });
                        
                        // 刷新显示
                        toggleHide();
                        

                    }).catch(error => {
                        showNotification('加载员工数据失败: ' + error.message, true);
                    });
                }
            });

            // 为项目名称选择框添加change事件，当项目切换时自动加载新的员工数据
            const projectSelect = document.getElementById('project-name');
            projectSelect.addEventListener('change', function() {
                // 检查是否需要跳过此事件（用于初始化时避免重复加载）
                if (window.skipProjectChangeEvent) {
                    console.log('跳过初始化时的项目change事件，避免重复加载员工数据');
                    return;
                }
                
                // 获取选中的选项
                const selectedOption = this.options[this.selectedIndex];
                const selectedProjectId = this.value; // 获取项目ID
                
                // 将项目ID存储到全局变量中，供父页面访问
                window.selectedProjectId = selectedProjectId;
                
                // 获取项目名称
                let selectedProjectName = null;
                if (selectedOption && selectedOption.dataset.projectInfo) {
                    try {
                        const projectInfo = JSON.parse(selectedOption.dataset.projectInfo);
                        selectedProjectName = projectInfo.project_name;
                    } catch (e) {
                        // 如果解析失败，使用选项文本作为项目名称
                        selectedProjectName = selectedOption ? selectedOption.textContent : '';
                    }
                } else {
                    // 如果没有项目信息，使用选项文本作为项目名称
                    selectedProjectName = selectedOption ? selectedOption.textContent : '';
                }
                
                // 页面加载完成后，主动触发一次同步队列处理
                if (window.offlineSyncService) {
                    // 延迟1秒后处理同步队列，确保页面其他资源已加载完成
                    setTimeout(() => {
                        window.offlineSyncService.processSyncQueue();
                    }, 1000);
                }
                


                    
                
                if (selectedProjectId && selectedProjectName) {
                    // 发送消息给父页面，更新页面标题
                    const targetOrigin = window.location.origin || '*';
                    window.parent.postMessage({
                        type: 'updateTitle',
                        title: `${selectedProjectName} - 员工录入 (${selectedProjectId})`,
                        onlyUpdateHistory: true // 只更新历史记录，不更新页面标题
                    }, targetOrigin);

                    // 加载该项目的员工数据 - 注意参数顺序：第一个是名称，第二个是ID
                    loadEmployeeDataForProject(selectedProjectName, selectedProjectId).then(() => {

                        // 员工数据加载完成后，处理每个员工的身份证信息
                        employees.forEach(employee => {
                            processIdCardInfo(employee);
                        });
                        
                        // 刷新显示
                        toggleHide();
                        
                    }).catch(error => {
                        console.error('加载员工数据失败:', error);
                        showNotification('加载员工数据失败: ' + error.message, true);
                    });
                } else {
                    console.warn('项目ID或项目名称为空，无法加载员工数据');
                }
            });

            // 完成初始化（延迟设置确保所有异步操作完成）
            setTimeout(() => {
                isInitialized = true;
            }, 0);

            // 绑定事件
            bindEvents();
        }

        // 绑定事件
        function bindEvents() {
            // 点击表格外部空白区域取消选中行
            document.addEventListener('click', function(e) {
                const employeeTable = document.getElementById('employee-table');
                const employeeContainer = document.getElementById('employee-container');
                
                // 检查点击的目标是否在表格或表格容器内部
                if (employeeTable && employeeContainer && 
                    !employeeTable.contains(e.target) && 
                    !employeeContainer.contains(e.target)) {
                    // 移除所有行的选中状态
                    document.querySelectorAll('#employee-tbody tr').forEach(row => {
                        row.classList.remove('active-row');
                        // 移除直接设置背景色的代码，使用CSS样式控制隔行背景色
                        row.style.backgroundColor = '';
                    });
                    // 重置选中的员工ID
                    selectedEmployeeId = null;
                }
            });
            
            // 按钮事件
            document.getElementById('add-btn').addEventListener('click', showAddModal);
            document.getElementById('edit-btn').addEventListener('click', showEditModal);
            document.getElementById('delete-btn').addEventListener('click', function() {
                if (!selectedEmployeeId) {
                    showNotification('请选择要删除的员工', true);
                    return;
                }
                
                // 查找要删除的员工，只通过employee_id（UUID格式）查找
                let employee = employees.find(emp => 
                    String(emp.employee_id) === selectedEmployeeId
                );
                
                // 确保获取UUID格式的员工唯一标识
                if (employee) {
                    // 将UUID格式的employeeid保存到模态框的隐藏字段中
                    const confirmDeleteModal = document.getElementById('confirm-delete-modal');
                    // 移除旧的隐藏字段（如果存在）
                    const existingHiddenField = confirmDeleteModal.querySelector('#delete-employeeid');
                    if (existingHiddenField) {
                        existingHiddenField.remove();
                    }
                    // 创建新的隐藏字段保存employee_id（UUID格式）
                    const hiddenField = document.createElement('input');
                    hiddenField.type = 'hidden';
                    hiddenField.id = 'delete-employeeid';
                    hiddenField.value = employee.employee_id;
                    confirmDeleteModal.querySelector('.modal-content').appendChild(hiddenField);
                }
                
                // 显示确认删除模态框
                document.getElementById('confirm-delete-modal').style.display = 'flex';
            });
            
            // 确认删除按钮事件
            document.getElementById('confirm-delete-btn').addEventListener('click', async function() {
                // 从隐藏字段获取employeeid（UUID格式）
                const hiddenField = document.getElementById('delete-employeeid');
                let employeeUniqueId = hiddenField ? hiddenField.value : selectedEmployeeId;
                
                // 检查该员工是否有考勤记录或结算记录
                try {
                    // 获取当前用户ID
                    let userId = 'default';
                    const currentUserStr = localStorage.getItem('currentUser');
                    if (currentUserStr) {
                        const currentUser = JSON.parse(currentUserStr);
                        userId = currentUser.user_id || 'default';
                    }

                    // 检查考勤记录
                    let hasAttendance = false;
                    const workRecordsKey = 'work_records_' + userId;
                    const workRecordsStr = localStorage.getItem(workRecordsKey);
                    if (workRecordsStr) {
                        const workRecords = JSON.parse(workRecordsStr);
                        // 确保类型一致进行比较
                        hasAttendance = workRecords.some(record => String(record.employee_id) === String(employeeUniqueId));
                    }

                    // 检查结算记录
                    let hasSettlement = false;
                    // 结算记录可能存储在 settlementRecords 中（不带userId后缀，根据项目主页代码推断）
                    // 也可以尝试带后缀的键名以防万一，但主要以前者为准
                    const settlementRecordsKey = 'settlementRecords';
                    const settlementRecordsStr = localStorage.getItem(settlementRecordsKey);
                    if (settlementRecordsStr) {
                        const settlementRecords = JSON.parse(settlementRecordsStr);
                        hasSettlement = settlementRecords.some(record => String(record.employee_id) === String(employeeUniqueId));
                    }

                    if (hasAttendance || hasSettlement) {
                        showNotification('当前员工有考勤或结算记录，不允许删除！', true);
                        // 关闭模态框
                        document.getElementById('confirm-delete-modal').style.display = 'none';
                        return;
                    }
                } catch (error) {
                    console.error('检查员工关联记录失败:', error);
                    // 出错时不阻止删除，或者可以选择提示错误
                }

                // 查找要删除的员工，使用UUID格式的employee_id进行匹配
                const employeeToDelete = employees.find(emp => 
                    String(emp.employee_id) === employeeUniqueId
                );
                
                // 确保正确区分并获取emp_code(工号)和employee_id(员工唯一标识)
                let emp_code = selectedEmployeeId; // 工号
                
                if (employeeToDelete) {
                    // 明确区分工号和员工唯一标识
                    emp_code = employeeToDelete.emp_code || '';
                    
                    // 保存员工的project_id到本地存储，以便实时订阅服务获取
                    if (employeeToDelete.project_id) {
                        localStorage.setItem(`deleting_employee_project_id_${employeeUniqueId}`, employeeToDelete.project_id);
                        console.log(`已保存删除员工的project_id到本地存储: ${employeeToDelete.project_id}`);
                    }
                }
                
                try {
                    // 首先删除本地数据 - 只使用UUID格式的employee_id进行匹配
                    employees = employees.filter(emp => {
                        // 只检查员工唯一标识(employee_id)
                        const matchesEmployeeId = 
                            String(emp.employee_id) === employeeUniqueId;
                        
                        // 只保留不匹配employee_id的员工记录
                        return !matchesEmployeeId;
                    });
                    
                    // 按工号升序排序
                    employees.sort((a, b) => {
                        const codeA = parseInt(a.emp_code) || 0;
                        const codeB = parseInt(b.emp_code) || 0;
                        return codeA - codeB;
                    });
                    
                    // 刷新表格显示
                    toggleHide();
                    // 立即关闭模态框，不等待云端上传
                    document.getElementById('confirm-delete-modal').style.display = 'none';
                    
                    // 保存本地数据
                    await saveEmployeeData();
                    
                    // 使用离线同步服务处理员工删除
                    await handleEmployeeDeleteToSupabase(employeeUniqueId);
                } catch (error) {
                    // 即使数据库操作失败，也删除本地数据 - 只以UUID格式的employee_id为准
                    employees = employees.filter(emp => {
                        // 只检查员工唯一标识(employee_id)
                        const matchesEmployeeId = 
                            String(emp.employee_id) === employeeUniqueId;
                        
                        // 只保留不匹配employee_id的员工记录
                        return !matchesEmployeeId;
                    });
                    
                    // 按工号升序排序
                    employees.sort((a, b) => {
                        const idA = a.emp_code || '';
                        const idB = b.emp_code || '';
                        return idA.localeCompare(idB, 'zh-CN');
                    });
                    
                    toggleHide();
                    // 立即关闭模态框，不等待云端上传
                    document.getElementById('confirm-delete-modal').style.display = 'none';
                    await saveEmployeeData();
                    // 数据库操作失败，不显示成功提示
                } finally {
                    // 重置选中的员工ID
                    selectedEmployeeId = null;
                }
            });
            
            // 取消删除按钮事件
            document.getElementById('cancel-delete-btn').addEventListener('click', function() {
                // 隐藏模态框
                document.getElementById('confirm-delete-modal').style.display = 'none';
            });
            document.getElementById('filter-btn').addEventListener('click', showFilterModal);
            


            document.getElementById('font-btn').addEventListener('click', showFontModal);

            // 模态框按钮事件
            document.getElementById('add-save-btn').addEventListener('click', saveEmployee);
            document.getElementById('add-cancel-btn').addEventListener('click', hideAddModal);
            document.getElementById('edit-save-btn').addEventListener('click', updateEmployee);
            document.getElementById('edit-cancel-btn').addEventListener('click', hideEditModal);
            document.getElementById('filter-apply-btn').addEventListener('click', applyFilter);
            document.getElementById('filter-cancel-btn').addEventListener('click', hideFilterModal);
            
            // 折叠图标按钮点击事件 - 添加模态框
            document.getElementById('toggle-fields-btn').addEventListener('click', function() {
                const extraFields = document.getElementById('add-extra-fields');
                const toggleBtn = this;
                
                if (extraFields.style.display === 'none') {
                    extraFields.style.display = 'block';
                    toggleBtn.textContent = '▲';
                } else {
                    extraFields.style.display = 'none';
                    toggleBtn.textContent = '▼';
                }
            });
            
            // 折叠图标按钮点击事件 - 修改模态框
            document.getElementById('edit-toggle-fields-btn').addEventListener('click', function() {
                const extraFields = document.getElementById('edit-extra-fields');
                const toggleBtn = this;
                
                if (extraFields.style.display === 'none') {
                    extraFields.style.display = 'block';
                    toggleBtn.textContent = '▲';
                } else {
                    extraFields.style.display = 'none';
                    toggleBtn.textContent = '▼';
                }
            });
            document.getElementById('font-apply-btn').addEventListener('click', applyFontSettings);
            document.getElementById('font-confirm-btn').addEventListener('click', confirmFontSettings);
            document.getElementById('font-cancel-btn').addEventListener('click', hideFontModal);

            // 复选框事件
            document.getElementById('hide').addEventListener('change', toggleHide);
            document.getElementById('collapse').addEventListener('change', toggleCollapse);
            
            // 项目下拉框自定义tooltip
            const projectSelect = document.getElementById('project-name');
            let tooltip = null;
            
            projectSelect.addEventListener('mouseenter', function(e) {
                // 创建 tooltip
                tooltip = document.createElement('div');
                tooltip.className = 'custom-tooltip';
                tooltip.textContent = '项目切换';
                document.body.appendChild(tooltip);
                
                // 计算位置
                const rect = e.target.getBoundingClientRect();
                tooltip.style.left = (rect.left + 10) + 'px';
                tooltip.style.top = (rect.bottom + 5) + 'px';
                
                // 显示 tooltip
                setTimeout(() => {
                    if (tooltip) {
                        tooltip.classList.add('show');
                    }
                }, 10);
            });
            
            projectSelect.addEventListener('mouseleave', function() {
                if (tooltip) {
                    tooltip.classList.remove('show');
                    setTimeout(() => {
                        if (tooltip && tooltip.parentNode) {
                            tooltip.parentNode.removeChild(tooltip);
                        }
                        tooltip = null;
                    }, 300);
                }
            });
            
            // 隐藏复选框自定义tooltip
            const hideCheckbox = document.getElementById('hide');
            let hideTooltip = null;
            
            hideCheckbox.addEventListener('mouseenter', function(e) {
                hideTooltip = document.createElement('div');
                hideTooltip.className = 'custom-tooltip';
                // 根据复选框状态显示不同提示
                if (hideCheckbox.checked) {
                    hideTooltip.textContent = '显示所有员工';
                } else {
                    hideTooltip.textContent = '隐藏非"在职"员工';
                }
                document.body.appendChild(hideTooltip);
                
                const rect = e.target.getBoundingClientRect();
                hideTooltip.style.left = (rect.left + 10) + 'px';
                hideTooltip.style.top = (rect.bottom + 5) + 'px';
                
                setTimeout(() => {
                    if (hideTooltip) {
                        hideTooltip.classList.add('show');
                    }
                }, 10);
            });
            
            hideCheckbox.addEventListener('mouseleave', function() {
                if (hideTooltip) {
                    hideTooltip.classList.remove('show');
                    setTimeout(() => {
                        if (hideTooltip && hideTooltip.parentNode) {
                            hideTooltip.parentNode.removeChild(hideTooltip);
                        }
                        hideTooltip = null;
                    }, 300);
                }
            });
            
            // 折叠复选框自定义tooltip
            const collapseCheckbox = document.getElementById('collapse');
            let collapseTooltip = null;
            
            collapseCheckbox.addEventListener('mouseenter', function(e) {
                collapseTooltip = document.createElement('div');
                collapseTooltip.className = 'custom-tooltip';
                // 根据复选框状态显示不同提示
                if (collapseCheckbox.checked) {
                    collapseTooltip.textContent = '详细显示';
                } else {
                    collapseTooltip.textContent = '精简显示';
                }
                document.body.appendChild(collapseTooltip);
                
                const rect = e.target.getBoundingClientRect();
                collapseTooltip.style.left = (rect.left + 10) + 'px';
                collapseTooltip.style.top = (rect.bottom + 5) + 'px';
                
                setTimeout(() => {
                    if (collapseTooltip) {
                        collapseTooltip.classList.add('show');
                    }
                }, 10);
            });
            
            collapseCheckbox.addEventListener('mouseleave', function() {
                if (collapseTooltip) {
                    collapseTooltip.classList.remove('show');
                    setTimeout(() => {
                        if (collapseTooltip && collapseTooltip.parentNode) {
                            collapseTooltip.parentNode.removeChild(collapseTooltip);
                        }
                        collapseTooltip = null;
                    }, 300);
                }
            });
            

    
            // 记工表按钮自定义tooltip
            const attendanceBtn = document.getElementById('attendance-btn');
            let attendanceTooltip = null;
            
            attendanceBtn.addEventListener('mouseenter', function(e) {
                attendanceTooltip = document.createElement('div');
                attendanceTooltip.className = 'custom-tooltip';
                attendanceTooltip.textContent = '生成记工表格或员工信息';
                document.body.appendChild(attendanceTooltip);
                
                const rect = e.target.getBoundingClientRect();
                // 先添加到DOM中再计算实际宽度，确保位置准确
                attendanceTooltip.style.left = (rect.right + 10) + 'px'; // 显示在按钮右侧
                attendanceTooltip.style.top = (rect.top - 30) + 'px'; // 显示在按钮上方
                
                setTimeout(() => {
                    if (attendanceTooltip) {
                        attendanceTooltip.classList.add('show');
                    }
                }, 10);
            });
            
            attendanceBtn.addEventListener('mouseleave', function() {
                if (attendanceTooltip) {
                    attendanceTooltip.classList.remove('show');
                    setTimeout(() => {
                        if (attendanceTooltip && attendanceTooltip.parentNode) {
                            attendanceTooltip.parentNode.removeChild(attendanceTooltip);
                        }
                        attendanceTooltip = null;
                    }, 300);
                }
            });
    

            // 表格行点击事件
            document.getElementById('employee-tbody').addEventListener('click', function(e) {
                const tr = e.target.closest('tr');
                if (tr) {
                    // 移除所有行的选中状态
                    document.querySelectorAll('#employee-tbody tr').forEach(row => {
                        row.classList.remove('active-row');
                        // 移除直接设置背景色的代码，使用CSS样式控制隔行背景色
                        row.style.backgroundColor = '';
                    });
                    // 设置当前行的选中状态
                    tr.classList.add('active-row');
                    // 保存选中的员工ID
                    selectedEmployeeId = tr.dataset.id;
                }
            });

            // 表格行双击事件 - 弹出修改模态框
            document.getElementById('employee-tbody').addEventListener('dblclick', function(e) {
                const tr = e.target.closest('tr');
                if (tr) {
                    selectedEmployeeId = tr.dataset.id;
                    showEditModal();
                }
            });
            
            // 添加点击模态框外部关闭模态框的功能
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.addEventListener('click', function(e) {
                    // 如果点击的是模态框容器本身（不是内容），则关闭模态框
                    if (e.target === this) {
                        this.style.display = 'none';
                    }
                });
            });
            
            // 实现底部固定按钮容器的拖拽功能
            const bottomButtons = document.querySelector('.bottom-fixed-buttons');
            if (bottomButtons) {
                let isDragging = false;
                let startX, startY, startLeft, startTop;
                
                // 鼠标按下事件
                bottomButtons.addEventListener('mousedown', function(e) {
                    // 只有当点击的是容器本身而不是按钮时才允许拖拽
                    if (e.target === bottomButtons) {
                        isDragging = true;
                        bottomButtons.classList.add('dragging');
                        
                        // 记录初始位置
                        startX = e.clientX;
                        startY = e.clientY;
                        
                        // 获取当前容器的位置（相对于整个页面）
                        const rect = bottomButtons.getBoundingClientRect();
                        
                        startLeft = rect.left;
                        startTop = rect.top;
                    }
                });
                
                // 鼠标移动事件
                document.addEventListener('mousemove', function(e) {
                    if (isDragging) {
                        // 计算新位置（相对于整个页面）
                        const newLeft = startLeft + (e.clientX - startX);
                        const newTop = startTop + (e.clientY - startY);
                        
                        // 不限制在容器内移动，允许拖到表格之外
                        
                        // 设置新位置
                        bottomButtons.style.left = newLeft + 'px';
                        bottomButtons.style.top = newTop + 'px';
                        // 移除bottom和right属性，使用left和top
                        bottomButtons.style.bottom = 'auto';
                        bottomButtons.style.right = 'auto';
                    }
                });
                
                // 鼠标释放事件
                document.addEventListener('mouseup', function() {
                    if (isDragging) {
                        isDragging = false;
                        bottomButtons.classList.remove('dragging');
                    }
                });
                
                // 鼠标离开窗口事件
                document.addEventListener('mouseleave', function() {
                    if (isDragging) {
                        isDragging = false;
                        bottomButtons.classList.remove('dragging');
                    }
                });
            }
        }

        // 显示添加员工模态框
        function showAddModal() {
            document.getElementById('add-modal').style.display = 'flex';
            applyFontSettings();
            // 清空表单
            document.getElementById('add-name').value = '';
            document.getElementById('add-status').value = '在职';
            document.getElementById('add-wage').value = '';
            document.getElementById('add-phone').value = '';
            document.getElementById('add-id-card').value = '';
            document.getElementById('add-bank').value = '';
            document.getElementById('add-bank-card').value = '';
            document.getElementById('add-bank-branch').value = '';
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('add-entry-date').value = today;
            document.getElementById('add-remark').value = '';
        }

        // 隐藏添加员工模态框
        function hideAddModal() {
            document.getElementById('add-modal').style.display = 'none';
        }

        // 显示修改员工模态框
        function showEditModal() {
            if (!selectedEmployeeId) {
                showNotification('请选择要修改的员工', true);
                return;
            }

            // 通过UUID格式的employee_id查找员工
            let employee = employees.find(emp => 
                String(emp.employee_id) === selectedEmployeeId
            );
            
            if (employee) {
                // 必须优先使用employee_id（UUID格式），但在界面上不显示，只用于后端更新
                // 确保获取UUID格式的员工唯一标识
                const employeeUniqueId = employee.employee_id;
                // 将UUID格式的员工唯一标识保存到隐藏字段
                document.getElementById('edit-id').value = employeeUniqueId;
                document.getElementById('edit-name').value = employee.emp_name || '';
                document.getElementById('edit-status').value = employee.status || '在职';
                document.getElementById('edit-wage').value = employee.labor_cost || '';
                document.getElementById('edit-phone').value = employee.phone || '';
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('edit-leave-date').value = employee.leave_date || today;
                document.getElementById('edit-id-card').value = employee.id_card || '';
                document.getElementById('edit-bank').value = employee.bank_name || '';
                document.getElementById('edit-bank-card').value = employee.bank_card_number || '';
                document.getElementById('edit-bank-branch').value = employee.bank_address || '';

                document.getElementById('edit-remark').value = employee.remarks || '';

                // 确保额外字段默认折叠，按钮显示为"▼"
                document.getElementById('edit-extra-fields').style.display = 'none';
                document.getElementById('edit-toggle-fields-btn').textContent = '▼';

                document.getElementById('edit-modal').style.display = 'flex';
                applyFontSettings();
            }
        }

        // 隐藏修改员工模态框
        function hideEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        // 显示筛选员工模态框
        function showFilterModal() {
            document.getElementById('filter-modal').style.display = 'flex';
            applyFontSettings();
        }

        // 隐藏筛选员工模态框
        function hideFilterModal() {
            document.getElementById('filter-modal').style.display = 'none';
        }

        // 显示字体设置模态框
        function showFontModal() {
            document.getElementById('font-family').value = currentFont.family;
            document.getElementById('font-size').value = currentFont.size;

            document.getElementById('font-modal').style.display = 'flex';
            applyFontSettings();
        }

        // 隐藏字体设置模态框
        function hideFontModal() {
            document.getElementById('font-modal').style.display = 'none';
        }



        // 生成PostgreSQL兼容的UUID v4函数
        function generateUUID() {
            // 生成标准的UUID v4格式，确保与PostgreSQL兼容
            const uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = (Math.random() * 16) | 0;
                const v = c === 'x' ? r : (r & 0x3) | 0x8;
                return v.toString(16);
            });
            return uuid;
        }

        // 验证项目选择
        function validateProjectSelection() {
            const projectSelect = document.getElementById('project-name');
            if (!projectSelect || projectSelect.selectedIndex < 0 || projectSelect.value === '') {
                showNotification('请选择项目', true);
                return false;
            }
            return true;
        }

        // 保存新员工
        async function saveEmployee() {
            // 验证项目选择
            if (!validateProjectSelection()) {
                return;
            }

            // 验证输入
            const name = document.getElementById('add-name').value.trim();
            const status = document.getElementById('add-status').value;
            const wage = document.getElementById('add-wage').value.trim();

            // 表单验证：姓名、状态和工价为必填项
            if (!name) {
                showNotification('姓名不能为空', true);
                return;
            }

            if (!status) {
                showNotification('状态不能为空', true);
                return;
            }

            if (!wage || !/^\d{3}$/.test(wage)) {
                showNotification('工价必须是3位数字', true);
                return;
            }

            const phone = document.getElementById('add-phone').value.trim();
            if (phone && !/^\d{11}$/.test(phone)) {
                showNotification('电话必须是11位数字', true);
                return;
            }

            const idCard = document.getElementById('add-id-card').value.trim();
            if (idCard && !/^\d{18}$/.test(idCard)) {
                showNotification('身份证必须是18位数字', true);
                return;
            }

            const bankCard = document.getElementById('add-bank-card').value.trim();
            if (bankCard && !/^\d{19}$/.test(bankCard)) {
                showNotification('卡号必须是19位数字', true);
                return;
            }

            // 查找当前最大工号并加1（用于工号字段）
            let maxId = 0;
            employees.forEach(emp => {
                const empId = parseInt(emp.emp_code);
                if (!isNaN(empId) && empId > maxId) {
                    maxId = empId;
                }
            });

            // 生成UUID作为员工唯一标识
            const employeeUniqueId = generateUUID();

            // 获取当前选中的项目信息
            const projectSelect = document.getElementById('project-name');
            let selectedProjectId = null;
            let selectedProjectName = 'default_project';
            
            if (projectSelect && projectSelect.selectedIndex >= 0 && projectSelect.value !== '') { // 确保选择的是真实项目而不是提示语
                const selectedOption = projectSelect.options[projectSelect.selectedIndex];
                selectedProjectId = projectSelect.value; // 获取项目ID
                selectedProjectName = selectedOption.textContent || 'default_project';
                
                // 如果项目信息中有更完整的ID信息，优先使用
                if (selectedOption.dataset.projectInfo) {
                    try {
                        const projectInfo = JSON.parse(selectedOption.dataset.projectInfo);
                        selectedProjectId = projectInfo.id || projectSelect.value;
                    } catch (e) {
                        // 如果解析失败，使用select的value
                    }
                }
            }

            // 创建新员工 - 严格按照数据库表结构
            const newEmployee = {
                // 员工唯一标识 - 使用UUID格式，放在第一位
                employee_id: employeeUniqueId,
                // 项目唯一标识符
                project_id: selectedProjectId,
                emp_code: (maxId + 1).toString(),  // 工号 - NOT NULL, UNIQUE
                emp_name: name,  // 姓名 - NOT NULL
                status: status,  // 状态 - NOT NULL, DEFAULT '在职'
                labor_cost: parseFloat(wage),  // 工价 - numeric
                phone: phone || null,  // 员工电话
                id_card: idCard || null,  // 身份证 - UNIQUE
                hire_date: (status === '在职' || status === '隐藏') && document.getElementById('add-entry-date').value ? document.getElementById('add-entry-date').value : null,
                leave_date: status === '离职' && document.getElementById('add-leave-date') && document.getElementById('add-leave-date').value ? document.getElementById('add-leave-date').value : null,
                remarks: document.getElementById('add-remark').value.trim() || null,  // 备注
                bank_name: document.getElementById('add-bank').value || null,  // 银行
                bank_card_number: bankCard || null,  // 卡号
                bank_address: document.getElementById('add-bank-branch').value || null  // 开户行地址
            };

            // 处理身份证信息
            processIdCardInfo(newEmployee);

            try {
                // 添加到本地员工列表
                employees.push(newEmployee);
                
                // 按工号升序排序
                employees.sort((a, b) => {
                    const codeA = parseInt(a.emp_code) || 0;
                    const codeB = parseInt(b.emp_code) || 0;
                    return codeA - codeB;
                });
                // 检查是否在线
                const isOnline = window.offlineSyncService && window.offlineSyncService.syncStatus.isOnline;
                
                if (!isOnline) {
                    // 只有离线模式下才保存到本地存储
                    // 保存到本地存储 - 确保正确处理empid(工号)和employeeid(员工唯一标识)
                    // 使用第一次获取的项目信息，确保一致性
                    const currentProjectId = selectedProjectId || 'default_project'; // 使用已验证的项目ID，避免空值
                    const localKey = `employees_${currentProjectId}`; // 使用项目ID作为键名
                    const timestamp = Date.now();
                    
                    // 确保所有员工记录只包含英文字段，按指定顺序排列
                    const employeesWithId = employees.map(emp => {
                        // 创建只包含英文字段的新对象，按指定顺序排列
                        const cleanEmp = {
                            // 员工唯一标识 - 放在第一位
                            employee_id: emp.employee_id,
                            // 项目唯一标识符
                            project_id: emp.project_id,
                            // 工号字段
                            emp_code: emp.emp_code,
                            // 基本信息字段
                            emp_name: emp.emp_name,
                            status: emp.status,
                            labor_cost: emp.labor_cost,
                            phone: emp.phone,
                            id_card: emp.id_card,
                            hire_date: emp.hire_date,
                            leave_date: emp.leave_date,
                            remarks: emp.remarks,
                            // 银行信息字段
                            bank_name: emp.bank_name,
                            bank_card_number: emp.bank_card_number,
                            bank_address: emp.bank_address
                        };
                        return cleanEmp;
                    });
                    
                    const dataToSave = {
                        employees: employeesWithId,
                        project_id: currentProjectId,  // 项目唯一标识符
                        timestamp: timestamp
                    };
                    localStorage.setItem(localKey, JSON.stringify(dataToSave));
                    localStorage.setItem(`${localKey}_timestamp`, timestamp.toString());
                    console.log('员工数据已保存到本地存储（离线模式）');
                } else {
                    console.log('在线模式，不保存到本地存储，只保存到Supabase');
                }

                // 刷新显示
                toggleHide();

                // 立即关闭模态框，不等待云端上传
                hideAddModal();
                
                // 创建用于同步的清理对象，只包含数据库中实际存在的字段，按指定顺序排列
                const syncEmployee = {
                    employee_id: newEmployee.employee_id,  // 员工唯一标识 - 放在第一位
                    project_id: newEmployee.project_id,
                    emp_code: newEmployee.emp_code,
                    emp_name: newEmployee.emp_name,
                    status: newEmployee.status,
                    labor_cost: newEmployee.labor_cost,
                    phone: newEmployee.phone,
                    id_card: newEmployee.id_card || null,  // 将空身份证号处理为 null，避免违反数据库唯一约束
                    hire_date: newEmployee.hire_date,
                    leave_date: newEmployee.leave_date,
                    remarks: newEmployee.remarks,
                    bank_name: newEmployee.bank_name,
                    bank_card_number: newEmployee.bank_card_number,
                    bank_address: newEmployee.bank_address
                };
                // 删除可能存在的created_at字段，由数据库默认值处理
                delete syncEmployee.created_at;

                // 显示本地保存成功通知
                showNotification(isOnline ? '员工添加成功' : '员工添加成功（本地保存）', false);
                playSuccessSound();

                // 然后异步保存到云端
                setTimeout(async () => {
                    try {
                        const phone = localStorage.getItem('loggedInPhone');
                        if (!phone) {
                            console.error('未找到用户手机号');
                            return;
                        }

                        // 检查是否在线
                        if (window.offlineSyncService && window.offlineSyncService.syncStatus.isOnline) {
                            // 在线时直接保存到云端
                            try {
                                const { error } = await window.supabase
                                    .from('employees')
                                    .insert(syncEmployee);
                                
                                if (error) {
                                    console.error('添加员工失败:', error);
                                    // 如果云端保存失败，添加到同步队列
                                    if (window.offlineSyncService) {
                                        await window.offlineSyncService.addToSyncQueue('add', syncEmployee, syncEmployee.employee_id);
                                        // 员工添加已添加到同步队列的日志已移除
                                    }
                                } else {
                                    console.log('✅ 员工信息已成功保存到Supabase');
                                }
                            } catch (supabaseError) {
                                console.error('Supabase操作异常:', supabaseError);
                                // 如果云端保存失败，添加到同步队列
                                if (window.offlineSyncService) {
                                    await window.offlineSyncService.addToSyncQueue('add', syncEmployee, syncEmployee.employee_id);
                                    // 员工添加已添加到同步队列的日志已移除
                                }
                            }
                        } else {
                            // 离线时添加到同步队列
                            if (window.offlineSyncService) {
                                await window.offlineSyncService.addToSyncQueue('add', syncEmployee, syncEmployee.employee_id);
                            }
                        }
                    } catch (error) {
                        console.error('保存员工数据到云端失败:', error);
                        // 如果云端保存失败，尝试添加到同步队列
                        if (window.offlineSyncService) {
                            try {
                                await window.offlineSyncService.addToSyncQueue('add', syncEmployee, syncEmployee.employee_id);
                            } catch (queueError) {
                            }
                        }
                    }
                }, 0);
                
            } catch (error) {
                console.error('保存员工信息时出错:', error);
                // 即使出错，也尝试添加到本地列表
                employees.push(newEmployee);
                toggleHide();
                // 立即关闭模态框，不等待云端上传
                hideAddModal();
                showNotification('员工添加成功，但数据保存失败', true);
            }
        }

        // 更新员工信息
        async function updateEmployee() {
            // 验证项目选择
            if (!validateProjectSelection()) {
                return;
            }

            // 验证输入
            const name = document.getElementById('edit-name').value.trim();
            const status = document.getElementById('edit-status').value;
            const wage = document.getElementById('edit-wage').value.trim();

            if (!name) {
                showNotification('姓名不能为空', true);
                return;
            }

            if (!wage || !/^\d{3}$/.test(wage)) {
                showNotification('工价必须是3位数字', true);
                return;
            }

            const phone = document.getElementById('edit-phone').value.trim();
            if (phone && !/^\d{11}$/.test(phone)) {
                showNotification('电话必须是11位数字', true);
                return;
            }

            const idCard = document.getElementById('edit-id-card').value.trim();
            if (idCard && !/^\d{18}$/.test(idCard)) {
                showNotification('身份证必须是18位数字', true);
                return;
            }

            const bankCard = document.getElementById('edit-bank-card').value.trim();
            if (bankCard && !/^\d{19}$/.test(bankCard)) {
                showNotification('卡号必须是19位数字', true);
                return;
            }

            // 获取员工ID - 从隐藏字段获取employeeid（UUID格式）
            const employeeUniqueId = document.getElementById('edit-id').value;

            // 查找员工 - 只通过UUID格式的employee_id查找员工
            let employee = employees.find(emp => 
                String(emp.employee_id) === employeeUniqueId
            );
            if (employee) {
                // 获取当前选中的项目信息
                const projectSelect = document.getElementById('project-name');
                const selectedProjectId = projectSelect ? projectSelect.value : '';
                const selectedOption = projectSelect && projectSelect.selectedIndex > 0 ? projectSelect.options[projectSelect.selectedIndex] : null; // 排除第一个空选项
                let selectedProjectName = employee.project_name || 'default_project';
                
                if (selectedOption && selectedOption.dataset.projectInfo) {
                    try {
                        const projectInfo = JSON.parse(selectedOption.dataset.projectInfo);
                        selectedProjectName = projectInfo.project_name || selectedOption.textContent || employee.project_name || 'default_project';
                    } catch (e) {
                        selectedProjectName = selectedOption.textContent || employee.project_name || 'default_project';
                    }
                }

                // 保存原始数据用于数据库更新
                // 严格按照数据库表结构排列字段
                const updatedEmployee = {
                    // 员工唯一标识 - 放在第一位
                    employee_id: employee.employee_id || employeeUniqueId,
                    // 项目信息字段
                    project_id: selectedProjectId || employee.project_id || null,
                    // 工号字段 - NOT NULL, UNIQUE
                    emp_code: employee.emp_code || employee.empid || '',
                    // 基本信息字段
                    emp_name: name,  // 姓名 - NOT NULL
                    status: status,  // 状态 - NOT NULL, DEFAULT '在职'
                    labor_cost: parseFloat(wage),  // 工价 - numeric
                    phone: document.getElementById('edit-phone').value.trim() || null,  // 电话
                    id_card: idCard || null,  // 身份证 - UNIQUE
                    hire_date: employee.hire_date || employee.hire_data || null,  // 入职日期
                    leave_date: null, // 离职日期将在下面根据状态处理
                    remarks: document.getElementById('edit-remark').value.trim() || null,  // 备注
                    bank_name: document.getElementById('edit-bank').value || null,  // 银行
                    bank_card_number: bankCard || null,  // 卡号
                    bank_address: document.getElementById('edit-bank-branch').value || null  // 开户行地址
                };

                // 处理离职日期逻辑
                if (status === '离职' || status === '结清') {
                    // 获取并设置离职日期
                    const leaveDate = document.getElementById('edit-leave-date').value;
                    
                    // 如果设置了日期，则验证离职日期不能早于入职日期
                    if (leaveDate) {
                        // 获取入职日期
                        const hireDate = employee.hire_date || employee.hire_data || '';
                        
                        // 如果入职日期存在，则进行比较
                        if (hireDate) {
                            // 将日期字符串转换为Date对象进行比较
                            const leaveDateObj = new Date(leaveDate);
                            const hireDateObj = new Date(hireDate);
                            
                            // 验证离职日期不能早于入职日期
                            if (leaveDateObj < hireDateObj) {
                                showNotification('离职日期不能早于入职日期', true);
                                return;
                            }
                        }
                        
                        updatedEmployee.leave_date = leaveDate; // 英文键名
                    } else {
                        updatedEmployee.leave_date = null; // 英文键名 - 使用null而不是空字符串
                    }
                } else {
                    // 当状态不为离职或结清时，将离职日期设置为null
                    updatedEmployee.leave_date = null;
                }

                // 处理身份证信息
                processIdCardInfo(updatedEmployee);
                
                // 计算身份证相关信息（用于本地显示）
                const idCardInfo = calculateIdCardInfo(updatedEmployee.id_card);
                
                // 创建本地存储专用的员工对象，空值保持为空字符串，明确排除created_at和updated_at字段
                const localEmployee = {
                    // 员工唯一标识字段 - 必须保持不变，不能被其他字段覆盖，使用UUID格式，放在第一位
                    employee_id: employee.employee_id || employeeUniqueId,
                    // 项目信息字段 - 移动到employee_id后面
                    project_id: updatedEmployee.project_id || selectedProjectId || '',
                    // 工号字段 - 只使用英文字段
                    emp_code: employee.emp_code || employee.empid || '',
                    // 基本信息字段，使用英文列名
                    emp_name: updatedEmployee.emp_name || '',
                    status: updatedEmployee.status || '在职',
                    labor_cost: updatedEmployee.labor_cost || '',
                    // 直接使用表单输入的电话值，确保不使用登录账号phone值
                    phone: (function() {
                        const phoneInput = document.getElementById('edit-phone').value.trim();
                        return phoneInput || '';
                    })(),
                    id_card: updatedEmployee.id_card || '',
                    hire_date: updatedEmployee.hire_date || '',  // 本地存储：空值保持为空字符串
                    leave_date: updatedEmployee.leave_date || '',  // 本地存储：空值保持为空字符串
                    remarks: updatedEmployee.remarks || '',
                    // 银行信息字段
                    bank_name: updatedEmployee.bank_name || '',
                    bank_card_number: updatedEmployee.bank_card_number || '',
                    bank_address: updatedEmployee.bank_address || ''
                };

                // 创建Supabase专用的员工对象，用于云端存储，日期字段转换为null
                const supabaseEmployee = {
                    ...localEmployee,
                    hire_date: updatedEmployee.hire_date || null,  // 云端存储：空字符串转为null以符合数据库date类型
                    leave_date: updatedEmployee.leave_date || null,  // 云端存储：空字符串转为null以符合数据库date类型
                    id_card: updatedEmployee.id_card || null,  // 将空身份证号处理为null，避免违反数据库唯一约束
                    // 明确设置updated_at字段为当前时间（UTC+8），确保更新时间正确
                    updated_at: new Date(new Date().getTime() + 8 * 60 * 60 * 1000).toISOString()
                };
                // 删除可能存在的created_at字段，由数据库默认值处理
                delete supabaseEmployee.created_at;
                
                // 按照指定格式创建嵌套结构的数据对象
                const timestamp = Date.now();
                
                // 使用已存在的currentProjectId变量，避免重复声明
                const projectIdForFormat = updatedEmployee.project_id || selectedProjectId || '';
                
                // 创建符合指定格式的数据对象
                const formattedEmployeeData = {
                    [`employees_${projectIdForFormat}_timestamp`]: timestamp,
                    [`employees_${projectIdForFormat}`]: {
                        employees: [supabaseEmployee],
                        project_id: projectIdForFormat,
                        timestamp: timestamp
                    }
                };
                
                // 不设置本地数据中的时间戳，让数据库触发器自动处理
                
                // 先更新本地员工数据，使用空字符串处理空值（按需求取消身份证相关字段）
                Object.assign(employee, updatedEmployee);
                // 不再保存身份证验证、性别、年龄字段到本地
                
                // 按工号升序排序
                employees.sort((a, b) => {
                    const codeA = parseInt(a.emp_code) || 0;
                    const codeB = parseInt(b.emp_code) || 0;
                    return codeA - codeB;
                });

                // 获取当前项目信息（使用已存在的selectedOption变量）
                const currentProject = selectedOption ? selectedOption.textContent : '';
                const currentProjectId = projectSelect ? projectSelect.value : '';
                
                // 检查是否在线
                const isOnline = window.offlineSyncService && window.offlineSyncService.syncStatus.isOnline;
                
                if (!isOnline) {
                    // 只有离线模式下才保存到本地存储
                    // 立即保存修改后的数据到本地存储
                    // 使用与添加员工相同的格式保存到本地存储
                    const localKey = `employees_${projectIdForFormat}`;
                    const existingData = localStorage.getItem(localKey);
                    let dataToSave = existingData ? JSON.parse(existingData) : { employees: [], project_id: projectIdForFormat, timestamp: timestamp };
                    
                    // 更新员工数据（使用本地存储对象，保持空值为空字符串）
                    const employeeIndex = dataToSave.employees.findIndex(emp => emp.employee_id === (employee.employee_id || employeeUniqueId));
                    if (employeeIndex !== -1) {
                        dataToSave.employees[employeeIndex] = localEmployee;
                    } else {
                        dataToSave.employees.push(localEmployee);
                    }
                    
                    // 按工号排序
                    dataToSave.employees.sort((a, b) => {
                        const idA = a.emp_code || '';
                        const idB = b.emp_code || '';
                        return idA.localeCompare(idB);
                    });
                    
                    // 更新时间和保存
                    dataToSave.timestamp = timestamp;
                    localStorage.setItem(localKey, JSON.stringify(dataToSave));
                    localStorage.setItem(`${localKey}_timestamp`, timestamp.toString());
                    console.log('员工数据已保存到本地存储（离线模式）');
                } else {
                    console.log('在线模式，不保存到本地存储，只保存到Supabase');
                }
                
                // 刷新显示
                toggleHide();

                // 立即关闭模态框，不等待云端上传
                hideEditModal();
                
                // 显示本地保存成功通知
                console.log('✅ 员工更新成功！员工信息已处理完成');
                showNotification(isOnline ? '员工更新成功' : '员工更新成功（本地保存）', false);

                // 然后异步保存到云端
                setTimeout(async () => {
                    try {
                        const phone = localStorage.getItem('loggedInPhone');
                        if (!phone) {
                            console.error('未找到用户手机号');
                            return;
                        }

                        // 检查是否在线
                        if (window.offlineSyncService && window.offlineSyncService.syncStatus.isOnline) {
                            // 在线时直接保存到云端
                            try {
                                const { error } = await window.supabase
                                    .from('employees')
                                    .update(supabaseEmployee)
                                    .eq('employee_id', employee.employee_id);
                                
                                if (error) {
                                    // 如果云端保存失败，添加到同步队列
                                    if (window.offlineSyncService) {
                                        await window.offlineSyncService.addToSyncQueue('update', formattedEmployeeData, employee.employee_id);
                                    }
                                }
                            } catch (supabaseError) {
                                // 如果云端保存失败，添加到同步队列
                                if (window.offlineSyncService) {
                                    await window.offlineSyncService.addToSyncQueue('update', formattedEmployeeData, employee.employee_id);
                                }
                            }
                        } else {
                            // 离线时添加到同步队列
                            if (window.offlineSyncService) {
                                await window.offlineSyncService.addToSyncQueue('update', formattedEmployeeData, employee.employee_id);
                            }
                        }
                    } catch (error) {
                        // 如果云端保存失败，尝试添加到同步队列
                        if (window.offlineSyncService) {
                            try {
                                await window.offlineSyncService.addToSyncQueue('update', formattedEmployeeData, employee.employee_id);
                            } catch (queueError) {
                            }
                        }
                    }
                }, 0);
            }
        }

        // 根据身份证号码动态计算验证、性别和年龄信息
        function calculateIdCardInfo(idCard) {
            // 复用processIdCardInfo的逻辑，避免代码重复
            let tempEmployee = { id_card: idCard };
            processIdCardInfo(tempEmployee);
            
            return {
                idcardValid: tempEmployee.判断 || '',
                gender: tempEmployee.性别 || '',
                age: tempEmployee.年龄 || ''
            };
        }

        // 处理身份证信息
        function processIdCardInfo(employee) {
            // 确保员工唯一标识字段存在
            // 确保员工唯一标识字段存在
            if (!employee.employee_id) {
                employee.employee_id = generateUUID();
            }
            
            // 确保工号字段存在
            if (!employee.emp_code) {
                employee.emp_code = '';
            }
            
            // 确保日期字段存在
            if (!employee.hire_date) {
                employee.hire_date = null;
            }
            
            if (!employee.leave_date) {
                employee.leave_date = null;
            }
            
            // 确保身份证字段存在
            if (!employee.id_card) {
                employee.id_card = '';
            }
            
            // 确保备注字段存在
            if (!employee.remarks) {
                employee.remarks = '';
            }
            
            // 确保银行相关字段存在
            if (!employee.bank_name) {
                employee.bank_name = '';
            }
            if (!employee.bank_card_number) {
                employee.bank_card_number = '';
            }
            if (!employee.bank_address) {
                employee.bank_address = '';
            }
            
            // 根据身份证号计算判断、性别和年龄字段
            if (employee.id_card && employee.id_card.length === 18) {
                const idCard = employee.id_card;
                
                // 计算校验码（判断字段）
                const weights = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2];
                const checkCodes = ['1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2'];
                let sum = 0;
                
                for (let i = 0; i < 17; i++) {
                    sum += parseInt(idCard[i]) * weights[i];
                }
                
                const checkCode = checkCodes[sum % 11];
                employee.判断 = (checkCode === idCard[17].toUpperCase()) ? '正确' : '错误';
                
                // 计算性别
                const genderCode = parseInt(idCard[16]);
                employee.性别 = (genderCode % 2 === 1) ? '男' : '女';
                
                // 计算年龄
                const birthYear = parseInt(idCard.substring(6, 10));
                const birthMonth = parseInt(idCard.substring(10, 12));
                const birthDay = parseInt(idCard.substring(12, 14));
                const today = new Date();
                let age = today.getFullYear() - birthYear;
                
                if (today.getMonth() + 1 < birthMonth || (today.getMonth() + 1 === birthMonth && today.getDate() < birthDay)) {
                    age--;
                }
                
                employee.年龄 = age.toString();
            } else {
                employee.判断 = '';
                employee.性别 = '';
                employee.年龄 = '';
            }
            
        }

        // 执行删除操作
        async function verifyPassword() {
            // 验证项目选择
            if (!validateProjectSelection()) {
                return;
            }
            
            employees = employees.filter(emp => emp.employee_id !== selectedEmployeeId);
            
            // 按工号升序排序（兼容中英文属性名）
            employees.sort((a, b) => {
                const idA = a.empid || a.工号 || '';
                const idB = b.empid || b.工号 || '';
                return idA.localeCompare(idB);
            });


            
            toggleHide();
            await saveEmployeeData();
            
            // 获取当前项目名称
            const projectSelect = document.getElementById('project-name');
            const selectedOption = projectSelect.options[projectSelect.selectedIndex];
            const currentProject = selectedOption ? selectedOption.textContent : '';
            
            // 通知项目列表更新统计
            notifyProjectListToUpdate(currentProject);
            
            hidePasswordModal();
            
            // 使用离线同步服务处理员工删除
                if (window.offlineSyncService) {
                    try {
                        await window.offlineSyncService.addToSyncQueue('delete', null, selectedEmployeeId);
                        showNotification('员工删除成功，正在同步到云端...');
                    } catch (error) {
                        showNotification('员工删除成功，但同步失败', true);
                    }
                } else {
                    showNotification('员工删除成功，同步服务不可用', true);
                }
        }

        // 应用筛选
        function applyFilter() {
            // 清理现有的工价tooltip
            clearWageTooltips();
            
            // 获取选中的状态值
            const statusCheckboxes = document.querySelectorAll('input[name="filter-status"]:checked');
            const selectedStatuses = Array.from(statusCheckboxes).map(checkbox => checkbox.value);
            const wage = document.getElementById('filter-wage').value;
            

            // 清空表格
            const tbody = document.getElementById('employee-tbody');
            tbody.innerHTML = '';

            // 收集所有员工姓名用于检查重复
            const names = [];
            employees.forEach(emp => {
                const empWage = emp.labor_cost || '';
                const matchesStatus = selectedStatuses.includes(emp.status);
                const matchesWage = wage === '全部' || String(empWage) === String(wage);
                
                // 调试信息 - 显示前几个员工的详细信息
                if (names.length < 5) {
                       
                }
                
                if (matchesStatus && matchesWage) {
                    names.push(emp.emp_name);
                }
            });
            

            // 按照emp_code升序排序员工数据
            const sortedEmployees = [...employees].sort((a, b) => {
                // 将emp_code转换为数值进行比较，确保正确的数字排序
                const codeA = parseInt(a.emp_code) || 0;
                const codeB = parseInt(b.emp_code) || 0;
                return codeA - codeB;
            });

            // 遍历排序后的员工数据并应用筛选
            sortedEmployees.forEach((emp, index) => {
                const empWage = emp.labor_cost || '';
                if (selectedStatuses.includes(emp.status) && (wage === '全部' || String(empWage) === String(wage))) {
                    // 创建行
                    const tr = document.createElement('tr');
                    tr.dataset.id = emp.employee_id; // 使用UUID格式的员工唯一标识

                    // 设置行样式
                    const tags = [];
                    // 移除直接设置背景色的代码，使用CSS样式控制隔行背景色

                    // 重复姓名样式
                    if (names.filter(n => n === emp.emp_name).length > 1) {
                        tr.classList.add('duplicate-name');
                    }

                    // 状态样式
                    if (emp.status === '隐藏') {
                        tr.classList.add('hidden-status');
                    } else if (emp.status === '离职') {
                        tr.classList.add('resigned-status');
                    } else if (emp.status === '结清') {
                        tr.classList.add('settled-status');
                    }

                    // 添加单元格
                    const collapse = document.getElementById('collapse').checked;
                     
                     // 动态计算身份证验证、性别和年龄信息
                     const idCardInfo = calculateIdCardInfo(emp.id_card);
                     
                     let cells = collapse ?
                 [emp.emp_code, emp.emp_name, emp.status, showWageData ? empWage : '', emp.phone, emp.id_card, emp.hire_date, emp.leave_date, emp.remarks] :
                 [emp.emp_code, emp.emp_name, emp.status, showWageData ? empWage : '', emp.phone, emp.id_card, emp.hire_date, emp.leave_date, emp.remarks, idCardInfo.idcardValid, idCardInfo.gender, idCardInfo.age, emp.bank_name, emp.bank_card_number, emp.bank_address];

                    cells.forEach((cellText, index) => {
                        const td = document.createElement('td');
                        td.textContent = cellText;
                        // 应用当前字体设置到新创建的单元格
                        td.style.fontFamily = `"${currentFont.family}"`;
                        td.style.fontSize = `${currentFont.size}px`;
                        td.style.fontWeight = currentFont.bold ? 'bold' : 'normal';
                        
                        // 设置固定列宽度
                        if (index === 0) {  // 工号列
                            td.style.width = FIXED_COL_WIDTHS.empCode;
                            td.style.minWidth = FIXED_COL_WIDTHS.empCode;
                            td.style.maxWidth = FIXED_COL_WIDTHS.empCode;
                            td.style.whiteSpace = 'nowrap';
                            td.style.overflow = 'hidden';
                            td.style.textOverflow = 'ellipsis';
                        } else if (index === 1) {  // 姓名列
                            td.style.width = FIXED_COL_WIDTHS.empName;
                            td.style.minWidth = FIXED_COL_WIDTHS.empName;
                            td.style.maxWidth = FIXED_COL_WIDTHS.empName;
                            td.style.whiteSpace = 'nowrap';
                            td.style.overflow = 'hidden';
                            td.style.textOverflow = 'ellipsis';
                        }
                        
                        tr.appendChild(td);
                    });

                    tbody.appendChild(tr);
                }
            });

            // 关闭模态框
            hideFilterModal();
        }

        // 切换隐藏非在职员工
        function toggleHide() {
            // 清理现有的工价tooltip
            clearWageTooltips();
            
            const hideCheckbox = document.getElementById('hide');
            const hideNonActive = hideCheckbox.checked;
            
            // 更新按钮文本
            const hideLabel = hideCheckbox.parentElement;
            const hideTextSpan = hideLabel.querySelector('span:last-child');
            if (hideTextSpan) {
                hideTextSpan.textContent = hideNonActive ? '隐藏' : '全显';
            }

            // 清空表格
            const tbody = document.getElementById('employee-tbody');
            tbody.innerHTML = '';

            // 收集所有员工姓名用于检查重复
            const names = [];
            employees.forEach(emp => {
                if (!hideNonActive || emp.status === '在职') {
                    names.push(emp.emp_name);
                }
            });

            // 遍历员工数据并应用筛选
            let displayIndex = 0; // 用于交替行颜色
            employees.forEach((emp) => {
                if (!hideNonActive || emp.status === '在职') {
                    // 创建行
                    const tr = document.createElement('tr');
                    tr.dataset.id = emp.employee_id; // 使用UUID格式的员工唯一标识

                    // 移除直接设置背景色的代码，使用CSS样式控制隔行背景色
                    displayIndex++;

                    // 重复姓名样式
                    if (names.filter(n => n === emp.emp_name).length > 1) {
                        tr.classList.add('duplicate-name');
                    }

                    // 状态样式
                    if (emp.status === '隐藏') {
                        tr.classList.add('hidden-status');
                    } else if (emp.status === '离职') {
                        tr.classList.add('resigned-status');
                    } else if (emp.status === '结清') {
                        tr.classList.add('settled-status');
                    }

                    // 添加单元格
                    const collapse = document.getElementById('collapse').checked;
                    const empWage = emp.labor_cost;
                    
                    // 动态计算身份证验证、性别和年龄信息
                    const idCardInfo = calculateIdCardInfo(emp.id_card);
                    
                    let cells = collapse ?
                [emp.emp_code, emp.emp_name, emp.status, showWageData ? empWage : '', emp.phone, emp.id_card, emp.hire_date, emp.leave_date, emp.remarks] :
                [emp.emp_code, emp.emp_name, emp.status, showWageData ? empWage : '', emp.phone, emp.id_card, emp.hire_date, emp.leave_date, emp.remarks, idCardInfo.idcardValid, idCardInfo.gender, idCardInfo.age, emp.bank_name, emp.bank_card_number, emp.bank_address];

                    cells.forEach(cellText => {
                        const td = document.createElement('td');
                        td.textContent = cellText;
                        // 应用当前字体设置到新创建的单元格
                        td.style.fontFamily = `"${currentFont.family}"`;
                        td.style.fontSize = `${currentFont.size}px`;
                        td.style.fontWeight = currentFont.bold ? 'bold' : 'normal';
                        tr.appendChild(td);
                    });

                    tbody.appendChild(tr);
                }
            });

            // 尝试查找可能使用旧随机ID保存的数据
        async function tryFindEmployeeDataWithOldId(phone, projectName, projectId) {
            try {
                // 获取所有localStorage键名
                const keys = Object.keys(localStorage);
                
                // 筛选出可能匹配的员工数据键
                const employeeKeys = keys.filter(key => 
                    (key.startsWith(`employees_${phone}_`) || key.startsWith('employees_')) && 
                    !key.includes(projectId) && 
                    !key.includes(projectName)
                );
                
                console.log(`找到 ${employeeKeys.length} 个可能的旧员工数据键`);
                
                // 尝试从每个键中加载数据，检查是否包含当前项目的员工
                for (const key of employeeKeys) {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        if (data.employees && Array.isArray(data.employees) && data.employees.length > 0) {
                            // 检查是否有员工属于当前项目
                            const projectEmployees = data.employees.filter(emp => 
                                emp.project === projectName
                            );
                            
                            if (projectEmployees.length > 0) {
                                console.log(`在旧键 ${key} 中找到 ${projectEmployees.length} 条当前项目的员工数据`);
                                
                                // 将找到的数据保存到新的键名下
                        const newKey = `employees_${projectId}`;
                        localStorage.setItem(newKey, JSON.stringify({employees: projectEmployees, project_id: projectId, timestamp: Date.now()}));
                                
                                // 设置为当前员工数据
                                employees = projectEmployees;
                                
                                // 新数据格式不再包含creation_time和last_modified_time字段，无需处理
                                
                                console.log(`已将旧数据迁移到新键名: ${newKey}`);
                                return;
                            }
                        }
                    } catch (e) {
                        console.warn(`处理旧键 ${key} 时出错:`, e);
                    }
                }
                
                
                employees = [];
            } catch (error) {
                console.error('查找旧员工数据时出错:', error);
                employees = [];
            }
        }

        // 更新工价筛选下拉框
            // 重新计算固定列位置
            setTimeout(updateStickyColumns, 100);
        }

        // 全局变量存储当前的工价tooltip
        let currentWageTooltip = null;
        
        // 清理所有存在的工价tooltip
        function clearWageTooltips() {
            // 清理所有带有特定文本的tooltip
            const existingTooltips = document.querySelectorAll('.custom-tooltip');
            existingTooltips.forEach(tooltip => {
                if (tooltip.textContent === '双击隐藏/显示') {
                    // 先移除CSS类，停止动画
                    tooltip.classList.remove('show');
                    // 立即移除元素
                    if (tooltip.parentNode) {
                        tooltip.parentNode.removeChild(tooltip);
                    }
                }
            });
            
            // 清理全局变量引用的tooltip
            if (currentWageTooltip) {
                currentWageTooltip.classList.remove('show');
                if (currentWageTooltip.parentNode) {
                    currentWageTooltip.parentNode.removeChild(currentWageTooltip);
                }
                currentWageTooltip = null;
            }
        }
        
        // 固定列宽度设置
        const FIXED_COL_WIDTHS = {
            empCode: '50px',  // 工号列宽度
            empName: '80px'   // 姓名列宽度
        };

        // 切换折叠显示状态
        function toggleCollapse() {
            const collapseCheckbox = document.getElementById('collapse');
            const collapse = collapseCheckbox.checked;
            
            // 更新按钮文本
            const collapseLabel = collapseCheckbox.parentElement;
            const collapseTextSpan = collapseLabel.querySelector('span:last-child');
            if (collapseTextSpan) {
                collapseTextSpan.textContent = collapse ? '折叠' : '展开';
            }

            const table = document.getElementById('employee-table');
            const thead = table.querySelector('thead tr');

            // 清理现有的工价tooltip
            clearWageTooltips();

            // 清空表头
            while (thead.firstChild) {
                thead.removeChild(thead.firstChild);
            }

            // 设置表头
            const headers = collapse ?
                ['工号', '姓名', '状态', '工价', '电话', '身份证', '入职日期', '离职日期', '备注'] :
                ['工号', '姓名', '状态', '工价', '电话', '身份证', '入职日期', '离职日期', '备注', '判断', '性别', '年龄', '银行', '卡号', '开户行地址'];

            headers.forEach((headerText, index) => {
                const th = document.createElement('th');
                th.textContent = headerText;
                // 应用当前字体设置到新创建的表头单元格
                th.style.fontFamily = `"${currentFont.family}"`;
                th.style.fontSize = `${currentFont.size}px`;
                th.style.fontWeight = currentFont.bold ? 'bold' : 'normal';
                
                // 设置固定列宽度
                if (index === 0) {  // 工号列
                    th.style.width = FIXED_COL_WIDTHS.empCode;
                    th.style.minWidth = FIXED_COL_WIDTHS.empCode;
                    th.style.maxWidth = FIXED_COL_WIDTHS.empCode;
                    th.style.whiteSpace = 'nowrap';
                    th.style.overflow = 'hidden';
                    th.style.textOverflow = 'ellipsis';
                } else if (index === 1) {  // 姓名列
                    th.style.width = FIXED_COL_WIDTHS.empName;
                    th.style.minWidth = FIXED_COL_WIDTHS.empName;
                    th.style.maxWidth = FIXED_COL_WIDTHS.empName;
                    th.style.whiteSpace = 'nowrap';
                    th.style.overflow = 'hidden';
                    th.style.textOverflow = 'ellipsis';
                }
                // 为工价表头添加双击事件和自定义tooltip
                    if (headerText === '工价') {
                    th.addEventListener('mouseenter', function(e) {
                        // 先清理任何现有的tooltip
                        clearWageTooltips();
                        
                        // 直接创建新的tooltip，类似项目切换的实现方式
                        currentWageTooltip = document.createElement('div');
                        currentWageTooltip.className = 'custom-tooltip';
                        currentWageTooltip.textContent = '双击隐藏/显示';
                        document.body.appendChild(currentWageTooltip);
                        
                        const rect = e.target.getBoundingClientRect();
                        currentWageTooltip.style.left = (rect.left + 10) + 'px';
                        currentWageTooltip.style.top = (rect.bottom + 5) + 'px';
                        
                        // 显示tooltip
                        setTimeout(() => {
                            if (currentWageTooltip) {
                                currentWageTooltip.classList.add('show');
                            }
                        }, 10);
                    });
                    
                    th.addEventListener('mouseleave', function() {
                        if (currentWageTooltip) {
                            // 移除show类以触发淡出动画
                            currentWageTooltip.classList.remove('show');
                            
                            // 使用简单直接的方式清理tooltip，类似项目切换的实现
                            setTimeout(() => {
                                if (currentWageTooltip && currentWageTooltip.parentNode) {
                                    currentWageTooltip.parentNode.removeChild(currentWageTooltip);
                                }
                                currentWageTooltip = null;
                            }, 300);
                        }
                    });
                    
                    th.addEventListener('dblclick', function() {
                        // 清理tooltip
                        clearWageTooltips();
                        showWageData = !showWageData;
                        // 保存状态到localStorage
                        localStorage.setItem('showWageData', JSON.stringify(showWageData));
                        toggleHide(); // 重新渲染表格
                    });
                }
                thead.appendChild(th);
            });

            // 刷新显示
            toggleHide();

            // 调整容器宽度 - 动态设置最大宽度
            const container = document.querySelector('.container');
            if (collapse) {
                container.style.maxWidth = '800px';
                container.style.width = '100%';
            } else {
                container.style.maxWidth = '1200px';
                container.style.width = '100%';
            }
            
            // 重新计算固定列位置
            setTimeout(updateStickyColumns, 100);
        }



        // 更新固定列位置
        function updateStickyColumns() {
            const table = document.getElementById('employee-table');
            if (!table) return;
            
            // 使用固定的列宽值计算，确保切换折叠时列位置保持一致
            const firstColWidth = parseInt(FIXED_COL_WIDTHS.empCode);
            
            // 设置第二列（姓名）的 left 属性
            const secondColCells = table.querySelectorAll('th:nth-child(2), td:nth-child(2)');
            secondColCells.forEach(cell => {
                cell.style.left = firstColWidth + 'px';
            });
        }

        // 监听窗口大小变化，重新计算固定列位置
        window.addEventListener('resize', updateStickyColumns);

        // 应用字体设置
        function applyFontSettings() {
            const family = document.getElementById('font-family').value;
            const size = document.getElementById('font-size').value;
            const bold = document.getElementById('font-bold').checked;

            // 更新全局字体设置
            currentFont = { family, size, bold };

            // 应用字体到body
            document.body.style.fontFamily = `"${family}"`;
            document.body.style.fontSize = `${size}px`;
            document.body.style.fontWeight = bold ? 'bold' : 'normal';

            // 应用字体到表格
            const table = document.getElementById('employee-table');
            table.style.fontFamily = `"${family}"`;
            table.style.fontSize = `${size}px`;
            table.style.fontWeight = bold ? 'bold' : 'normal';

            // 应用字体到表格单元格（关键修复）
            const tableCells = document.querySelectorAll('#employee-table td, #employee-table th');
            tableCells.forEach(cell => {
                cell.style.fontFamily = `"${family}"`;
                cell.style.fontSize = `${size}px`;
                cell.style.fontWeight = bold ? 'bold' : 'normal';
            });

            // 应用字体到所有按钮和输入类型按钮
            const buttons = document.querySelectorAll('button, input[type="button"], input[type="submit"], input[type="reset"], input[type="image"], [role="button"], .btn, .button, [class*="btn"], [class*="button"], [class^="btn-"], [class*=" btn-"], [class*="-btn"], [id*="btn"]');
            buttons.forEach(btn => {
                btn.style.fontFamily = `"${family}"`;
                btn.style.fontSize = `${size}px`;
                btn.style.fontWeight = bold ? 'bold' : 'normal';
            });

            // 应用字体到输入框和文本区域
            const inputs = document.querySelectorAll('input:not([type="button"]):not([type="submit"]):not([type="reset"]):not([type="image"]), textarea');
            inputs.forEach(input => {
                input.style.fontFamily = `"${family}"`;
                input.style.fontSize = `${size}px`;
                input.style.fontWeight = bold ? 'bold' : 'normal';
            });

            // 应用字体到下拉框
            const selects = document.querySelectorAll('select');
            selects.forEach(select => {
                select.style.fontFamily = `"${family}"`;
                select.style.fontSize = `${size}px`;
                select.style.fontWeight = bold ? 'bold' : 'normal';
            });
            
            // 应用字体到复选框标签
            const checkboxLabels = document.querySelectorAll('.checkbox-group label');
            checkboxLabels.forEach(label => {
                label.style.fontFamily = `"${family}"`;
                label.style.fontSize = `${size}px`;
                label.style.fontWeight = bold ? 'bold' : 'normal';
            });
            
            // 重新计算固定列位置，因为字体变化可能导致列宽变化
            setTimeout(updateStickyColumns, 100);
        }

        // 确认字体设置
        function confirmFontSettings() {
            applyFontSettings();
            // 保存字体设置到本地存储
            const fontSettings = {
                family: currentFont.family,
                size: currentFont.size,
                bold: currentFont.bold
            };
            localStorage.setItem('fontSettings', JSON.stringify(fontSettings));
            hideFontModal();
        }
        

        // 保存员工数据到本地数据库（不同步到云端）
        async function saveEmployeeData(showNotificationParam = true) {
            try {
                // 获取当前项目ID
                const projectSelect = document.getElementById('project-name');
                const currentProjectId = (projectSelect && projectSelect.value !== '') ? projectSelect.value : 'default_project'; // 避免空值
                
                if (!currentProjectId) {
                    if (typeof showNotification === 'function') {
                        showNotification('请先选择项目', true);
                    }
                    return false;
                }
                
                // 构造员工数据对象
                const timestamp = Date.now();
                const enhancedEmployees = employees.map(emp => {
                    // 构造员工数据对象，只包含英文字段，使用与Supabase表匹配的字段名
                    const orderedEmployee = {
                        // 员工唯一标识
                        employee_id: emp.employee_id,
                        // 项目唯一标识符
                        project_id: currentProjectId,
                        // 工号
                        emp_code: emp.emp_code,
                        // 姓名
                        emp_name: emp.emp_name,
                        // 状态
                        status: emp.status,
                        // 工价
                        labor_cost: emp.labor_cost,
                        // 电话
                        phone: emp.phone,
                        // 身份证
                        id_card: emp.id_card,
                        // 入职日期
                        hire_date: emp.hire_date,
                        // 离职日期
                        leave_date: emp.leave_date,
                        // 备注
                        remarks: emp.remarks,
                        // 银行信息
                        bank_name: emp.bank_name,
                        bank_card_number: emp.bank_card_number,
                        bank_address: emp.bank_address
                    };
                    return orderedEmployee;
                });
                
                // 保存到本地存储 - 使用项目ID作为键名以确保一致性
                const key = `employees_${currentProjectId}`;
                const dataToSave = {
                    employees: enhancedEmployees,
                    project_id: currentProjectId,
                    timestamp: timestamp
                };
                
                localStorage.setItem(key, JSON.stringify(dataToSave));
                localStorage.setItem(`${key}_timestamp`, timestamp.toString());
                console.log('员工数据已成功保存');
                if (showNotificationParam && typeof showNotification === 'function') {
                    showNotification('数据已保存到本地', false);
                }
                return true;
            } catch (error) {
                console.error('保存员工数据时发生错误:', error);
                if (typeof showNotification === 'function') {
                    showNotification('数据保存失败', true);
                }
                return false;
            }
        }

        // 保存数据主函数
        async function saveData(silent = false) {
            try {
                // 调用保存员工数据函数（仅本地存储）
                const success = await saveEmployeeData();
                
                // 注意：saveEmployeeData内部已经处理了所有的通知显示
                return success;
            } catch (error) {
                console.error('保存数据时发生错误:', error);
                if (!silent && typeof showNotification === 'function') {
                    showNotification('数据保存失败，请检查网络连接', true);
                }
                return false;
            }
        }
        // 加载数据
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            if (!notification) {
                console.error('未找到notification元素!');
                alert('提示框元素未找到: ' + message); // 作为备用
                return;
            }
            
            // 设置文本和样式
            notification.textContent = message;
            notification.className = isError ? 'notification error' : 'notification';
            
            // 强制显示 - 确保所有样式属性都正确设置
            notification.style.cssText = `
                display: block;
                visibility: visible;
                opacity: 1;
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                padding: 16px 24px;
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                color: white;
                border-radius: 8px;
                box-shadow: 0 15px 40px rgba(16, 185, 129, 0.4), 0 8px 20px rgba(16, 185, 129, 0.2);
                z-index: 9999;
                font-weight: 700;
                border: 1px solid rgba(255, 255, 255, 0.3);
                font-size: 16px;
                min-width: 200px;
                text-align: center;
                animation: notificationPop 0.3s ease-out;
            `;
            
            // 如果是错误消息，覆盖背景和阴影颜色
            if (isError) {
                notification.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                notification.style.boxShadow = '0 15px 40px rgba(239, 68, 68, 0.4), 0 8px 20px rgba(239, 68, 68, 0.2)';
            }
            
            // 3秒后隐藏
            setTimeout(() => {
                // 使用CSS动画淡出
                notification.style.transition = 'opacity 0.3s ease-out';
                notification.style.opacity = '0';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 300);
            }, 3000);
        }

        function loadData() {
            // 从本地存储加载字体设置
            const savedFontSettings = localStorage.getItem('fontSettings');
            if (savedFontSettings) {
                try {
                    const fontSettings = JSON.parse(savedFontSettings);
                    currentFont = {
                        family: fontSettings.family || 'Microsoft YaHei',
                        size: fontSettings.size || 14,  // 没有本地设置时默认14px
                        bold: fontSettings.bold || false
                    };
                    // 更新字体设置表单值
                    document.getElementById('font-family').value = currentFont.family;
                    document.getElementById('font-size').value = currentFont.size;
                    document.getElementById('font-bold').checked = currentFont.bold;
                    applyFontSettings();
                } catch (error) {
                    console.error('加载本地字体设置失败:', error);
                }
            } else {
                // 没有本地字体设置文件时，设置默认字体大小为14px
                currentFont = {
                    family: 'Microsoft YaHei',
                    size: 14,
                    bold: false
                };
                // 更新字体设置表单值
                document.getElementById('font-family').value = currentFont.family;
                document.getElementById('font-size').value = currentFont.size;
                document.getElementById('font-bold').checked = currentFont.bold;
                applyFontSettings();
            }
            
            // 直接从本地加载数据
            loadLocalDataOnly();
        }
        
        // 只从本地加载数据（网络不可用时）
        function loadLocalDataOnly() {
            const projectSelect = document.getElementById('project-name');
            const selectedOption = projectSelect.options[projectSelect.selectedIndex];
            const currentProject = selectedOption ? selectedOption.textContent : '';
            const currentProjectId = (projectSelect && projectSelect.value !== '') ? projectSelect.value : 'default_project'; // 避免空值
            
            let phone = localStorage.getItem('loggedInPhone');
            if (!phone && window.location.hostname === 'localhost') {
                phone = '13800138000';
            }
            
            if (currentProject && phone && currentProjectId) {
                // 使用与保存函数相同的键名格式：使用项目ID作为键名以确保一致性
                const localKey = `employees_${currentProjectId}`;

                try {
                    const localData = JSON.parse(localStorage.getItem(localKey));
                    if (localData && Array.isArray(localData.employees)) {
                        employees = localData.employees;
                        console.log('成功加载本地缓存数据，共', employees.length, '条');
                        showNotification('加载本地缓存数据成功');
                    } else {
                        // 尝试使用项目名称作为备选键名
                        console.log('未找到项目ID对应的本地缓存数据，尝试使用项目名称作为备选键名');
                        const altLocalKey = `employees_${currentProject}`;
                        const altLocalData = JSON.parse(localStorage.getItem(altLocalKey));
                        if (altLocalData && Array.isArray(altLocalData.employees)) {
                            employees = altLocalData.employees;
                            console.log('使用项目名称作为键名成功加载本地缓存数据，共', employees.length, '条');
                            showNotification('加载本地缓存数据成功');
                        } else {
                            employees = [];
                            console.log('本地无缓存数据');
                            showNotification('本地无缓存数据', true);
                        }
                    }
                } catch (error) {
                    console.error('加载本地数据失败:', error);
                    employees = [];
                }
                toggleHide();
            }
        }
        
        // 使用本地数据库代替下载云端数据进行时间对比
        function downloadCloudDataForComparison(employeeFilePath, localKey, localTimestamp) {
            console.log('不再下载云端数据进行对比，直接使用本地数据库数据');
            
            try {
                // 从localKey中提取项目信息
                const parts = localKey.split('_');
                if (parts.length >= 3) {
                    const projectName = parts.slice(2).join('_'); // 提取项目名称部分
                    
                    // 使用已实现的函数从数据库加载项目员工数据
                    loadEmployeeDataForProject(projectName, project.id).then(() => {
                        showNotification('使用本地数据库数据');
                    }).catch(error => {
                        console.error('加载本地数据库数据失败:', error);
                        employees = [];
                        showNotification('加载数据失败: ' + error.message, true);
                    });
                } else {
                    // 如果无法从localKey中提取项目信息，则尝试直接从localStorage加载
                    console.log('无法从localKey中提取项目信息，尝试从本地存储加载数据');
                    try {
                        const localData = JSON.parse(localStorage.getItem(localKey));
                        employees = localData?.employees || [];
                        showNotification('使用本地存储数据');
                    } catch (error) {
                        console.error('加载本地存储数据失败:', error);
                        employees = [];
                        showNotification('加载数据失败: ' + error.message, true);
                    }
                    toggleHide();
                }
            } catch (error) {
                console.log(`数据处理出错: ${error.message}，使用空员工列表`);
                try {
                    const localData = JSON.parse(localStorage.getItem(localKey));
                    employees = localData.employees || [];
                } catch (error) {
                    console.error('加载本地数据失败:', error);
                    employees = [];
                }
                toggleHide();
            }
        }
        
        // 只使用本地数据库数据，不再下载云端数据
        function downloadAndLoadCloudData(employeeFilePath, localKey) {
            console.log('不再从云端下载数据，只使用本地数据库数据');
            
            // 从localKey中提取项目信息
            const parts = localKey.split('_');
            if (parts.length >= 3) {
                const projectName = parts.slice(2).join('_'); // 提取项目名称部分
                
                // 使用已实现的函数从数据库加载项目员工数据
                loadEmployeeDataForProject(projectName, project.id).then(() => {
                    // 函数内部已处理toggleHide()
                    showNotification('只使用本地数据库数据');
                }).catch(error => {
                    console.error('加载本地数据库数据失败:', error);
                    employees = [];
                    showNotification('加载数据失败: ' + error.message, true);
                    toggleHide();
                });
            } else {
                // 如果无法从localKey中提取项目信息，则使用默认处理
                console.error('无法从localKey中提取项目信息:', localKey);
                
                try {
                    // 默认使用本地存储加载数据
                    const projectSelect = document.getElementById('project-name');
                    const selectedOption = projectSelect?.options[projectSelect.selectedIndex];
                    const projectName = selectedOption ? selectedOption.textContent : '';
                    if (projectName) {
                        loadEmployeeDataForProject(projectName, project.id).then(() => {
                            showNotification('数据已从本地存储加载');
                        }).catch(() => {
                            employees = [];
                            showNotification('加载数据失败', true);
                            toggleHide();
                        });
                        return;
                    }
                    
                    // 默认情况，使用空员工列表
                    employees = [];
                    showNotification('无法获取项目信息，使用空数据', true);
                    toggleHide();
                } catch (error) {
                    console.error('处理本地数据库数据失败:', error);
                    employees = [];
                    showNotification('加载数据失败: ' + error.message, true);
                    toggleHide();
                }
            }
        }
        
        // 保存数据到本地存储
        function saveDataToLocal(data, localKey, timestamp) {
            try {
                localStorage.setItem(localKey, JSON.stringify(data));
                localStorage.setItem(`${localKey}_timestamp`, timestamp.toString());
                console.log('数据已保存到本地');
            } catch (error) {
                console.error('保存数据到本地失败:', error);
            }
        }


        // 从本地加载员工数据（使用项目ID作为查询参数）
        async function loadEmployeeDataForProject(projectName, projectId) {
            return new Promise(async (resolve, reject) => {
                try {
                    let phone = localStorage.getItem('loggedInPhone');
                    if (!phone && window.location.hostname === 'localhost') {
                        phone = '13800138000';
                    }
                         
                    if (!phone) {
                        console.error('未找到用户信息');
                        resolve();
                        return;
                    }
                    
                    // 只从本地加载员工数据
                    try {
                        // 初始化employees为数组
                        employees = [];
                        
                        // 直接从localStorage加载数据 - 使用项目ID作为键名以确保一致性
                        const localKey = `employees_${projectId}`;

                        const savedData = localStorage.getItem(localKey);
                        
                        if (savedData) {
                            try {
                                const parsedData = JSON.parse(savedData);
                                if (parsedData && Array.isArray(parsedData.employees)) {
                                    employees = parsedData.employees;


                                    // 新数据格式不再包含creation_time和last_modified_time字段，无需处理
                                } else {
                                    console.error('本地存储数据格式错误，缺少employees数组或不是数组类型');
                                    employees = [];
                                }
                            } catch (parseError) {
                                console.error('解析本地存储的员工数据失败:', parseError);
                                employees = [];
                            }
                        } else {
                            // 新数据格式只使用项目ID作为键名，不尝试其他备选键名

                            employees = [];
                        }
                        
                        // 确保employees是数组
                        if (!Array.isArray(employees)) {
                            employees = [];
                        }
                        
                        // 按工号emp_code升序排序（数字排序）
                        employees.sort((a, b) => {
                            const codeA = parseInt(a.emp_code) || 0;
                            const codeB = parseInt(b.emp_code) || 0;
                            return codeA - codeB;
                        });
                        
                        // 刷新显示
                        toggleHide();
                        
                        // 计算并设置固定列位置
                        setTimeout(updateStickyColumns, 100);
                        
                        resolve();
                    } catch (error) {
                        console.error('加载数据失败:', error);
                        employees = [];
                        toggleHide();
                        resolve();
                    }
                } catch (error) {
                    console.error(`加载项目ID "${projectId}" 的员工数据失败:`, error);
                    employees = [];
                    toggleHide();
                    resolve();
                }
            });
        }

        // 更新工价筛选下拉框
        function updateWageFilter() {
            const filterWage = document.getElementById('filter-wage');

            // 清空下拉框
            while (filterWage.firstChild) {
                filterWage.removeChild(filterWage.firstChild);
            }

            // 添加默认选项
            const defaultOption = document.createElement('option');
            defaultOption.value = '全部';
            defaultOption.textContent = '全部';
            filterWage.appendChild(defaultOption);

            // 收集所有唯一工价
            const wages = new Set();
            employees.forEach(emp => {
                const wageValue = emp.labor_cost || '';
                if (wageValue) {
                    wages.add(wageValue);
                }
            });

            // 添加工价选项
            Array.from(wages).sort().forEach(wage => {
                const option = document.createElement('option');
                option.value = wage;
                option.textContent = wage;
                filterWage.appendChild(option);
            });
        }

        // 播放成功提示音
        function playSuccessSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                function playTone(frequency, startTime, duration, type = 'sine') {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.value = frequency;
                    oscillator.type = type;

                    gainNode.gain.setValueAtTime(0, startTime);
                    gainNode.gain.linearRampToValueAtTime(0.3, startTime + 0.02);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration);

                    oscillator.start(startTime);
                    oscillator.stop(startTime + duration);
                }

                const now = audioContext.currentTime;
                playTone(523.25, now, 0.15);
                playTone(659.25, now + 0.15, 0.15);
                playTone(783.99, now + 0.3, 0.25);
                
                console.log('成功提示音已播放');
            } catch (e) {
                console.log('音频播放失败:', e);
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
<script>
            document.querySelectorAll('#employee-table tr:not(thead tr)').forEach(row => {
                row.addEventListener('click', () => {
                    document.querySelectorAll('#employee-table tr:not(thead tr)').forEach(r => {
                        r.classList.remove('active-row');
                        // 恢复初始交替颜色
                        if(Array.from(r.classList).indexOf('active-row') === -1) {
                            if(Array.from(r.parentNode.children).indexOf(r) % 2 === 1) {
                                r.style.backgroundColor = '#ED7D31';
                            } else {
                                r.style.backgroundColor = 'white';
                            }
                        }
                    });
                    row.classList.add('active-row');
                });
            });
        </script>
    <!-- 确认删除模态框 -->
    <div class="modal" id="confirm-delete-modal" style="display: none;">
        <div class="modal-content">
            <h3 style="color: #8B0000;">确认删除</h3>
            <p>您确定要删除此员工吗？删除后不可恢复！</p>
            <div class="form-buttons">
                <button id="confirm-delete-btn" style="background-color: #ED7D31;" onmouseover="this.style.backgroundColor='#8B0000'" onmouseout="this.style.backgroundColor='#ED7D31'">确定</button>
                <button id="cancel-delete-btn" style="background-color: #3a5a89;" onmouseover="this.style.backgroundColor='#8B0000'" onmouseout="this.style.backgroundColor='#3a5a89'">取消</button>
            </div>
        </div>
    </div>

    <!-- 记工表导出选择模态框 -->
    <div class="modal" id="export-choice-modal" style="display: none;">
        <div class="modal-content" style="text-align: center; width: 320px; padding: 15px;">
            <h3 style="color: #ED7D31; margin-bottom: 15px; font-size: 18px;">选择导出类型</h3>
            <div style="display: flex; gap: 15px; justify-content: center; margin-bottom: 15px;">
                <div style="flex: 1; padding: 15px 10px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.3s; background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);" id="pdf-option" onmouseover="this.style.borderColor='#667eea'; this.style.boxShadow='0 8px 20px rgba(102, 126, 234, 0.2)';" onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none';" onclick="generateAttendancePDF()">
                    <div style="font-size: 36px; margin-bottom: 8px; color: #667eea;">📄</div>
                    <div style="font-size: 14px; font-weight: bold; color: #374151; margin-bottom: 4px;">记工表格</div>
                    <div style="font-size: 11px; color: #64748b;">生成PDF格式</div>
                </div>
                <div style="flex: 1; padding: 15px 10px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.3s; background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);" id="excel-option" onmouseover="this.style.borderColor='#10b981'; this.style.boxShadow='0 8px 20px rgba(16, 185, 129, 0.2)';" onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none';" onclick="generateEmployeeExcel()">
                    <div style="font-size: 36px; margin-bottom: 8px; color: #10b981;">📊</div>
                    <div style="font-size: 14px; font-weight: bold; color: #374151; margin-bottom: 4px;">员工信息</div>
                    <div style="font-size: 11px; color: #64748b;">生成EXCEL格式</div>
                </div>
            </div>
            <div class="form-buttons">
                <button id="cancel-export-btn" style="background-color: #64748b;" onmouseover="this.style.backgroundColor='#475569'" onmouseout="this.style.backgroundColor='#64748b'" onclick="document.getElementById('export-choice-modal').style.display='none'">取消</button>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>
    <script>
        // 页面加载完成后初始化实时订阅
        document.addEventListener('DOMContentLoaded', function() {
            
            // 延迟初始化，确保所有资源都已加载
            setTimeout(initRealtimeSubscription, 1000);
        });
        
        // 监听来自父页面的消息，用于实时更新
        window.addEventListener('message', function(event) {
            // 验证消息来源（在本地开发环境中可能无法验证）
            // 在生产环境中应使用具体的域名验证
            
            try {
                if (event.data && typeof event.data === 'object') {
                    switch (event.data.type) {
                        case 'refreshEmployeeData':
                            console.log('🔄 收到员工数据刷新指令');
                            // 重新加载员工数据
                            const selectedProjectName = document.getElementById('project-name').value;
                            const selectedProjectId = document.getElementById('project-name').options[document.getElementById('project-name').selectedIndex]?.value;
                            if (selectedProjectName && selectedProjectId) {
                                loadEmployeeDataForProject(selectedProjectName, selectedProjectId);
                                console.log('✅ 已触发员工数据刷新');
                            }
                            break;
                        case 'refreshData':
                            console.log('🔄 收到通用数据刷新指令');
                            // 重新加载员工数据
                            const projName = document.getElementById('project-name').value;
                            const projId = document.getElementById('project-name').options[document.getElementById('project-name').selectedIndex]?.value;
                            if (projName && projId) {
                                loadEmployeeDataForProject(projName, projId);
                                console.log('✅ 已触发通用数据刷新');
                            }
                            break;
                        default:
                            // 忽略其他类型的消息
                            break;
                    }
                }
            } catch (error) {
                console.error('处理消息时发生错误:', error);
            }
        });
        
        // 初始化实时订阅 - 子页面不需要重复订阅，由首页统一管理
        function initRealtimeSubscription() {
            // 子页面不需要重复订阅，由首页统一管理实时订阅
            // 仅需监听来自父页面的消息即可
        }
    </script>
</body>
</html>   