<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>记工系统</title>
    


    <!-- 本地加载完整的Supabase库 -->
    <script src="./JavaScript/supabase/supabase.min.js"></script>
    <!-- 加载浏览器环境的Supabase配置 -->
    <script src="./JavaScript/supabase/supabase-client.js"></script>
    <!-- 离线同步服务 -->
    <script src="./JavaScript/离线同步/offline-sync-service.js"></script>
    <!-- 同步状态指示器 -->
    <script src="./JavaScript/离线同步/sync-status-indicator.js"></script>
    <!-- tus-js-client用于大文件上传 -->
    <script src="./JavaScript/supabase/tus.min.js"></script>
    <!-- Compressor.js用于图片压缩 -->
    <script src="./JavaScript/supabase/compressor.min.js"></script>
    <!-- 中文转拼音库 -->
    <script src="./JavaScript/supabase/pinyin-pro.js"></script>


    <!-- 修复记工系统中的全局函数问题 -->
    <script src="./JavaScript/记工/fix-global-functions.js"></script>
    <script src="./JavaScript/记工/work-record-service.js"></script>
    <script src="./JavaScript/记工/work-flow-service.js"></script>
    <script src="./JavaScript/记工/work-record-marker.js"></script>
    
    <!-- URL参数处理脚本 -->
    <script>
        // 页面加载时处理URL参数
        document.addEventListener('DOMContentLoaded', () => {
            // 获取URL参数
            const urlParams = new URLSearchParams(window.location.search);
            const tab = urlParams.get('tab');
            const date = urlParams.get('date');
            const employeeId = urlParams.get('employee_id');

            // 如果指定了tab参数且为workflow，则切换到记工流水标签页
            if (tab === 'workflow') {
                const tabWorkFlow = document.getElementById('tabWorkFlow');
                if (tabWorkFlow) {
                    tabWorkFlow.checked = true;
                    // 触发change事件，确保标签页内容切换
                    tabWorkFlow.dispatchEvent(new Event('change'));
                }
            }

            // 如果指定了date参数，则设置日期选择器的值
            if (date) {
                const workDateInput = document.getElementById('workDate');
                if (workDateInput) {
                    workDateInput.value = date;
                    // 触发change事件，确保日期选择器更新
                    workDateInput.dispatchEvent(new Event('change'));
                }
            }

            // 如果指定了employee_id参数，保存到全局变量，供后续使用
            if (employeeId) {
                window.employeeIdFromUrl = employeeId;
            }
        });
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background-color: #f5f5f5;
            font-family: 'Microsoft YaHei', sans-serif;
            padding: 10px;
        }
        .container {
            width: 100%;
            margin: 0;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .form-group {
            margin-bottom: 15px;
            padding: 0 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            padding: 0 15px;
        }
        .form-row > div {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .form-row label {
            margin-bottom: 0;
            white-space: nowrap;
        }
        .work-type {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        .work-type-option {
            cursor: pointer;
            padding: 8px 16px;
            position: relative;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 8px;
            backdrop-filter: blur(5px);
            background: rgba(255, 255, 255, 0.1);
            margin: 2px;
        }
        .work-type-option:hover {
            transform: translateY(-1px) scale(1.05);
            background: rgba(0, 102, 204, 0.2);
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3);
        }
        .work-type-option.active {
            color: white;
            background: linear-gradient(135deg, rgba(0, 102, 204, 0.9), rgba(30, 144, 255, 0.8));
            box-shadow: 0 2px 8px rgba(0, 102, 204, 0.4);
            transform: translateY(-0.5px);
        }
        .work-type-option.active:hover {
            transform: translateY(-1px) scale(1.05);
            box-shadow: 0 3px 12px rgba(0, 102, 204, 0.5);
        }
        
        /* 标签页导航中的标签样式 */
        .work-type.tab-navigation {
            background-color: #fff;
            border-bottom: 1px solid #f0f0f0;
            padding: 0;
            gap: 0;
        }

        .work-type.tab-navigation .work-type-option {
            border: none;
            background-color: #fff;
            color: #333; /* 未选中字体黑色 */
            margin: 0;
            flex: none; /* 取消自动填充 */
            width: auto; /* 恢复自动宽度 */
            text-align: center;
            border-radius: 0;
            font-weight: bold; /* 未选中字体加粗 */
            padding: 8px 30px; /* 增加水平内边距 */
            position: relative;
            transition: none; /* 禁用动画 */
            transform: none !important; /* 禁用变形 */
            box-shadow: none !important; /* 禁用阴影 */
        }
        
        /* 禁用悬停效果 */
        .work-type.tab-navigation .work-type-option:hover {
            background-color: #fff;
            transform: none;
            box-shadow: none;
        }

        .work-type.tab-navigation .work-type-option.active {
            border: none;
            color: white; /* 选中字体白色 */
            font-weight: bold;
            box-shadow: none;
            z-index: 1;
        }
        
        /* 左侧“记工”选中时的背景 - 右上圆角 */
        .work-type.tab-navigation label[for="tabWorkRecord"].active {
            background: linear-gradient(135deg, rgba(0, 102, 204, 0.9), rgba(30, 144, 255, 0.8));
            border-radius: 0 20px 0 0;
        }

        /* 右侧“记工流水”选中时的背景 - 左上圆角 */
        .work-type.tab-navigation label[for="tabWorkFlow"].active {
            background: linear-gradient(135deg, rgba(0, 102, 204, 0.9), rgba(30, 144, 255, 0.8));
            border-radius: 20px 0 0 0;
        }

        /* Restore global active underline */
        .work-type-option.active::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: #0066cc;
        }

        /* Hide underline for tab navigation */
        .work-type.tab-navigation .work-type-option.active::after {
            display: none;
        }
        .work-type input {
            display: none;
        }
        input[type="text"], select, input[type="date"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f5f5f5;
        }
        
        /* 项目名称输入框特殊样式 */
        #projectName {
            background-color: #f8f9fa !important;
            cursor: not-allowed !important;
            color: #6c757d !important;
            border: 1px solid #dee2e6 !important;
            font-weight: 500;
            font-size: 16px !important;
        }
        
        #projectName:focus {
            outline: none !important;
            box-shadow: none !important;
            border-color: #dee2e6 !important;
        }
        
        /* 必填项星号样式 */
        .required-asterisk {
            color: #ff0000;
            font-weight: bold;
            margin-right: 2px;
        }
        
        /* 日期输入框容器样式 */
        .date-input-container {
            position: relative;
            width: 100%;
        }
        
        .date-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f5f5f5;
            position: relative;
            z-index: 1;
        }
        
        .date-display {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 8px;
            border: 1px solid #1890ff;
            border-radius: 4px;
            background-color: #e6f7ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
            pointer-events: none;
            display: flex;
            align-items: center;
            font-size: 16px;
            color: #333;
            z-index: 2;
        }
        
        
        
        .date-display .today-text {
            color: #1890ff;
            font-weight: bold;
        }
        
        /* 隐藏原始日期输入框 */
        .date-input-container.active .date-input {
            opacity: 1;
            z-index: 3;
        }
        
        .date-input-container.active .date-display {
            opacity: 0;
        }

        /* 响应式样式，防止界面溢出 */
        @media screen and (max-width: 768px) {
            .container {
                margin: 5px;
                border-radius: 4px;
            }
            .form-row {
                flex-direction: column;
                gap: 10px;
            }
            .employee-list {
                grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
                gap: 2px;
                padding: 5px;
            }
            .header {
                font-size: 20px;
                padding: 8px 10px;
            }
            .form-group, .form-row {
                padding: 0 10px;
            }
            
            /* 加班模态框在手机界面字体减小 */
            #overtimeModal h3 {
                font-size: 14px !important;
            }
            #overtimeModal .overtime-option {
                font-size: 14px !important;
                padding: 6px 12px !important;
            }
            #overtimeModal .work-btn-text {
                font-size: 14px !important;
            }
            #overtimeModal .work-input {
                font-size: 14px !important;
            }
            #overtimeModal .hours-input {
                font-size: 14px !important;
            }
            #overtimeModal .hours-option {
                font-size: 14px !important;
                padding: 8px 12px !important;
                cursor: pointer;
                border-bottom: 1px solid #f0f0f0;
                transition: background-color 0.2s ease;
                color: #333 !important;
            }
            
            #overtimeModal .hours-option:hover {
                background-color: #f5f5f5;
            }
            
            #overtimeModal .hours-option.disabled {
                color: #999;
                background-color: #f9f9f9;
                cursor: not-allowed;
            }
            
            #overtimeModal .hours-option.disabled:hover {
                background-color: #f9f9f9;
            }
            
            #overtimeModal .hours-option:last-child {
                border-bottom: none;
            }
            #overtimeModal #cancelOvertime,
            #overtimeModal #confirmOvertime {
                font-size: 14px !important;
                padding: 8px 16px !important;
            }
            
            /* 上下午模态框在手机界面字体减小 */
            #morningAfternoonModal h3 {
                font-size: 14px !important;
            }
            #morningAfternoonModal span[style*="font-weight: bold"] {
                font-size: 14px !important;
            }
            #morningAfternoonModal .morning-afternoon-btn {
                font-size: 14px !important;
                padding: 4px 8px !important;
            }
            #morningAfternoonModal .work-btn-text {
                font-size: 14px !important;
            }
            #morningAfternoonModal .work-input {
                font-size: 14px !important;
            }
            #morningAfternoonModal .modal-hours-input {
                font-size: 14px !important;
            }
            #morningAfternoonModal .modal-hours-option {
                font-size: 14px !important;
                padding: 6px 10px !important;
                color: #333 !important;
            }
            #morningAfternoonModal #cancelMorningAfternoon,
            #morningAfternoonModal #confirmMorningAfternoon {
                font-size: 14px !important;
                padding: 8px 16px !important;
            }
            #morningAfternoonModal #morningHours,
            #morningAfternoonModal #afternoonHours {
                width: 90px !important;
            }
        }
        
        /* 添加员工模态框按钮样式 */
        #addEmployeeModal .form-buttons {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
            margin-top: 20px;
        }
        
        #addEmployeeModal #confirmAddEmployees {
            margin-left: 0;
        }
        
        #addEmployeeModal #cancelAddEmployees {
            margin-right: 0;
        }

        @media screen and (max-width: 768px) {
            .container {
                margin: 5px;
                border-radius: 4px;
            }
            .form-row {
                flex-direction: column;
                gap: 10px;
            }
            .employee-list {
                grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
                gap: 2px;
                padding: 5px;
            }
            .header {
                font-size: 20px;
                padding: 8px 10px;
            }
            .form-group, .form-row {
                padding: 0 10px;
            }
            .employee-controls {
                padding: 8px 10px;
                flex-direction: column;
                align-items: stretch;
            }
            .employee-controls button {
            margin: 2px 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: center;
        }
        
        .employee-controls button:hover {
            transform: translateY(-1px) scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        }

        @media screen and (max-width: 480px) {
            body {
                padding: 5px;
            }
            .container {
                margin: 0;
                border-radius: 0;
            }
            .header {
                font-size: 18px;
                padding: 10px;
            }
            .form-group, .form-row {
                padding: 0 8px;
            }
            .employee-list {
                grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
                font-size: 12px;
            }
            .work-type {
                flex-direction: column;
                gap: 10px;
            }
            /* 标签页导航在手机界面时保持横向排列 */
            .work-type.tab-navigation {
                flex-direction: row;
                gap: 5px;
                justify-content: space-between;
                flex-wrap: nowrap;
                padding: 0 10px;
            }
            /* 标签页导航在手机界面时的标签样式 */
            .work-type.tab-navigation .work-type-option {
                text-align: center;
                padding: 10px 20px;
                font-size: 16px;
                font-weight: bold;
                min-width: 75px;
                border-radius: 8px;
            }
            /* 工作类型选择在手机界面时保持横向排列 */
            .work-type.work-type-selection {
                flex-direction: row;
                gap: 25px;
                justify-content: center;
                flex-wrap: nowrap;
            }
            .work-type-option {
                text-align: center;
                padding: 10px 20px;
                font-size: 16px;
                font-weight: bold;
                min-width: 75px;
                border-radius: 8px;
            }
        }
        textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            min-height: 80px;
        }
        .employee-selection {
            margin-top: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            width: 100%;
        }
        .employee-controls {
            display: flex;
            gap: 10px;
            padding: 10px 15px;
            background-color: #f2f2f2;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
        }
        .employee-list {
            min-height: auto;
            max-height: none;
            overflow-y: auto;
            padding: 10px 15px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, auto));
            gap: 3px;
            width: 100%;
            box-sizing: border-box;
        }
        .employee-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 2px;
            border: none;
            border-radius: 0;
            color: #333;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            font-size: 14px;
            aspect-ratio: 1/1;
            background: none;
            margin: 0;
        }
        .employee-item:hover {
            transform: scale(1.03);
            background: none;
        }
        .employee-item.selected {
            border: none;
            background: none;
        }
        .employee-item.selected::after {
            content: '✓';
            position: absolute;
            top: 1px;
            right: 10px;
            width: 18px;
            height: 18px;
            background-color: #f5222d;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }
        
        /* +和-按钮样式 */
        .add-button {
            color: #52c41a !important;
        }
        
        .delete-button {
            color: #f5222d !important;
        }
        
        /* +和-按钮悬停样式 */
        .add-button:hover {
            color: #52c41a !important;
        }
        
        .delete-button:hover {
            color: #f5222d !important;
        }
        .employee-item:last-child {
            border-bottom: none;
        }
        .employee-item input[type="checkbox"] {
            display: none;
        }
        .employee-info {
            text-align: center;
            width: 100%;
        }
        .employee-id {
            background-color: #f0f0f0;
            color: #666;
            width: 45px;
            height: 45px;
            border-radius: 3px;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1px;
            box-sizing: border-box;
            border: 1px solid #ddd;
        }
        .employee-item.selected .employee-id {
            background-color: #1890ff;
            color: white;
            border: 2px solid #ff7a45;
        }
        /* 移除冲突的.selected样式，确保只有一个定义 */
        .hidden-status {
            color: orange;
        }
        .resigned-status {
            color: purple;
        }
        .settled-status {
            color: green;
        }
        /* 模态框样式调整 */
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 500px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }
        #addEmployeeModal .modal-content {
            height:68vh;
            overflow-y: auto;
        }
        .day-work-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .day-work-options label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .day-work-options input {
            margin-right: 5px;
        }
        
        /* 可编辑数字样式 */
        .editable-number {
            display: inline-block;
            min-width: 20px;
            text-align: center;
            outline: none;
            border-radius: 2px;
            transition: all 0.3s ease;
            padding: 0 2px;
        }
        
        .editable-number:focus {
            min-width: 40px;
            background-color: white !important;
            color: #333 !important;
            box-shadow: 0 0 0 2px rgba(237, 125, 49, 0.3);
            border: 1px solid #ED7D31;
        }
        
        /* 小时选择器样式 */
        .hours-select-container {
            position: relative !important;
            width: 110px !important; /* 调宽一些 */
            flex-shrink: 0 !important;
        }
        
        .hours-input {
            width: 100% !important;
            border: none !important;
            background: transparent !important;
            color: inherit !important;
            cursor: pointer !important;
            outline: none !important;
            font-size: 16px !important;
            font-weight: bold !important;
            text-align: center !important;
            padding: 0 20px 0 5px !important; /* 为下拉箭头留出空间 */
            box-sizing: border-box !important;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e") !important;
            background-position: right 0.3rem center !important;
            background-repeat: no-repeat !important;
            background-size: 1.2em 1.2em !important;
        }
        
        /* .hours-input:focus {
            background-color: rgba(0,0,0,0.1) !important;
        } */
        
        /* 确保所有daywork-btn按钮字体样式一致 */
        .daywork-btn {
            font-size: 16px !important;
            font-weight: bold !important;
            height: auto !important;
            min-height: 36px !important; /* 与其他按钮统一高度 */
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            transform-origin: center !important;
        }
        
        .daywork-btn:hover {
            transform: translateY(-1px) scale(1.05) !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2) !important;
        }
        
        /* 小时选择器容器特殊样式 */
        .hours-select-container {
            position: relative !important;
            width: 110px !important; /* 调宽至110px */
            flex-shrink: 0 !important;
            height: 36px !important; /* 与其他按钮统一高度 */
            box-sizing: border-box !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            padding: 0 !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            transform-origin: center !important;
            cursor: pointer !important;
        }
        
        .hours-select-container:hover {
            transform: translateY(-1px) scale(1.05) !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2) !important;
        }
        
        /* 上下午模态框按钮样式 */
        .morning-afternoon-btn {
            font-size: 16px !important;
            font-weight: bold !important;
            height: 36px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            transform-origin: center !important;
        }
        
        .morning-afternoon-btn:hover {
            transform: translateY(-1px) scale(1.05) !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2) !important;
        }
        
        .morning-afternoon-btn.active {
            background-color: #1890ff !important;
            color: white !important;
            border: none !important;
        }
        
        /* 模态框中的可编辑数字样式 */
        .modal-editable-number {
            display: inline-block;
            min-width: 20px;
            text-align: center;
            outline: none;
            border-radius: 2px;
            transition: all 0.3s ease;
            padding: 0 2px;
        }
        
        .modal-editable-number:focus {
            min-width: 40px;
            background-color: white !important;
            color: #333 !important;
            box-shadow: 0 0 0 2px rgba(237, 125, 49, 0.3);
            border: 1px solid #ED7D31;
        }
        
        /* 模态框中的小时选择器样式 */
        .modal-hours-select-container {
            position: relative !important;
            width: 110px !important;
            flex-shrink: 0 !important;
            height: 36px !important;
            box-sizing: border-box !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            padding: 0 !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            transform-origin: center !important;
            cursor: pointer !important;
        }
        
        .modal-hours-select-container:hover {
            transform: translateY(-1px) scale(1.05) !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2) !important;
        }
        
        .modal-hours-input {
            width: 100% !important;
            border: none !important;
            background: transparent !important;
            color: inherit !important;
            cursor: pointer !important;
            outline: none !important;
            font-size: 16px !important;
            font-weight: bold !important;
            text-align: center !important;
            padding: 0 5px !important;
            box-sizing: border-box !important;
        }
        
        .modal-hours-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1001;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: none;
        }
        
        /* 当下拉框显示时，提高其z-index确保在最前面 */
        .modal-hours-dropdown[style*="block"] {
            z-index: 1003 !important;
        }
        
        /* 确保下拉框在悬停时保持最高层级 */
        .modal-hours-dropdown:hover {
            z-index: 1004 !important;
        }
        
        .modal-hours-option {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
            color: #000 !important;
            font-size: 14px !important;
            font-weight: bold !important;
        }
        
        .modal-hours-option:hover {
            background-color: #f5f5f5;
        }
        
        .modal-hours-option.disabled {
            color: #999 !important;
            cursor: not-allowed;
            background-color: #f9f9f9;
        }
        
        .modal-hours-option.disabled:hover {
            background-color: #f9f9f9;
        }
        
        .modal-hours-option:last-child {
            border-bottom: none;
        }
        
        .hours-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1001;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: none;
        }
        
        .hours-option {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px !important;
            transition: background-color 0.2s ease;
            color: #333 !important;
        }
        
        .hours-option:hover {
            background-color: #f5f5f5;
        }
        
        .hours-option.disabled {
            color: #999 !important;
            cursor: not-allowed;
            background-color: #f9f9f9;
        }
        
        .hours-option.disabled:hover {
            background-color: #f9f9f9;
        }
        
        .hours-option:last-child {
            border-bottom: none;
        }

        /* 统一按钮hover效果 */
        .overtime-option:hover,
        #cancelOvertime:hover,
        #confirmOvertime:hover,
        #cancelMorningAfternoon:hover,
        #confirmMorningAfternoon:hover,
        #cancelAddEmployees:hover,
        #confirmAddEmployees:hover,
        .morning-afternoon-btn:hover,
        .modal-hours-select-container:hover {
            transform: translateY(-1px) scale(1.05) !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2) !important;
        }

        .bottom-buttons {
            display: flex;
            justify-content: flex-start;
            padding: 15px;
            background-color: #f2f2f2;
            position: fixed;
            bottom: 0;
            width: 100%;
            left: 0;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        }
        button {
            padding: 10px 20px;
            background-color: #ED7D31;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: center;
        }
        button:hover {
            background-color: #8B0000;
            transform: translateY(-1px) scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 15px 20px;
            border-radius: 5px;
            background-color: #4CAF50;
            color: white;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 2000;
        }
        .notification.error {
            background-color: #f44336;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }
        /* 日期选择器样式 */
        .date-picker-content {
            background-color: white;
            border-radius: 12px;
            width: 480px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }
        
        .date-picker-body {
            padding: 20px;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .calendar-header button {
            background: linear-gradient(135deg, rgba(240, 240, 240, 0.8), rgba(255, 255, 255, 0.6));
            border: none;
            border-radius: 8px;
            width: 36px;
            height: 36px;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .calendar-header button:hover {
            background: linear-gradient(135deg, rgba(24, 144, 255, 0.9), rgba(64, 169, 255, 0.8));
            color: white;
            transform: translateY(-1px) scale(1.15);
            box-shadow: 0 4px 15px rgba(24, 144, 255, 0.4);
        }
        
        .calendar-header button.confirm-btn {
            width: auto;
            padding: 0 16px;
            font-size: 14px;
            font-weight: 500;
            background: #333;
            color: white;
        }
        
        .calendar-header button.confirm-btn:hover {
            background: linear-gradient(135deg, rgba(24, 144, 255, 0.9), rgba(64, 169, 255, 0.8));
            color: white;
            transform: translateY(-1px) scale(1.15);
            box-shadow: 0 4px 15px rgba(24, 144, 255, 0.4);
        }
        
        #currentMonth {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        
        .calendar-grid {
            margin-bottom: 20px;
        }
        
        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 10px;
        }
        
        .weekdays > div {
            text-align: center;
            padding: 8px;
            font-weight: bold;
            color: #666;
            font-size: 14px;
        }
        
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        
        .day-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .day-cell:hover {
            background: linear-gradient(135deg, rgba(230, 247, 255, 0.8), rgba(240, 250, 255, 0.6));
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(24, 144, 255, 0.2);
            backdrop-filter: blur(5px);
        }
        
        .day-cell.other-month {
            color: #ccc;
            cursor: not-allowed;
        }
        
        .day-cell.disabled-future {
            color: #d0d0d0;
            background-color: #f9f9f9;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .day-cell.disabled-future:hover {
            background-color: #f9f9f9;
            transform: none;
        }
        
        .day-cell.today {
            background: #fff2e6;
            border: 2px solid #ff7a00;
            font-weight: bold;
            color: #ff7a00;
            position: relative;
        }
        
        .day-cell.today::before {
            content: '今天';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff7a00;
            color: white;
            font-size: 10px;
            padding: 1px 4px;
            border-radius: 8px;
            font-weight: bold;
            white-space: nowrap;
            z-index: 1;
        }
        
        .day-cell.selected-single {
            background: #1890ff;
            color: white;
            font-weight: bold;
        }
        
        .day-cell.selected-temp {
            background: #ffc53d;
            color: white;
            font-weight: bold;
        }
        
        .day-cell.selected-confirmed {
            background: #52c41a;
            color: white;
            font-weight: bold;
        }
        
        .date-picker-footer {
            padding: 15px 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fafafa;
            border-radius: 0 0 12px 12px;
        }
        
        .left-controls {
            display: flex;
            align-items: center;
        }
        
        .mode-switch-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.9), rgba(118, 75, 162, 0.8));
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        
        .mode-switch-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .mode-switch-btn .mode-icon {
            font-size: 16px;
            transition: transform 0.3s ease;
        }
        
        .mode-switch-btn:hover .mode-icon {
            transform: scale(1.1);
        }
        
        .mode-switch-btn .mode-icon {
            font-size: 16px;
            transition: transform 0.3s ease;
        }
        
        .mode-switch-btn:hover .mode-icon {
            transform: scale(1.1);
        }
        
        .mode-switch-btn.multiple {
            background: linear-gradient(135deg, #ff7043 0%, #f4511e 100%);
            box-shadow: 0 2px 8px rgba(255, 112, 67, 0.3);
        }
        
        .mode-switch-btn.multiple:hover {
            box-shadow: 0 4px 12px rgba(255, 112, 67, 0.4);
        }
        
        .footer-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn-secondary, .btn-primary {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(5px);
            position: relative;
            overflow: hidden;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, rgba(240, 240, 240, 0.9), rgba(255, 255, 255, 0.8));
            color: #666;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, rgba(217, 217, 217, 0.9), rgba(240, 240, 240, 0.8));
            transform: translateY(-1px) scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, rgba(24, 144, 255, 0.9), rgba(64, 169, 255, 0.8));
            color: white;
            box-shadow: 0 2px 8px rgba(24, 144, 255, 0.3);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, rgba(64, 169, 255, 0.9), rgba(100, 189, 255, 0.8));
            transform: translateY(-1px) scale(1.05);
            box-shadow: 0 4px 15px rgba(24, 144, 255, 0.4);
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
    
    <!-- 引入编辑模式处理函数 -->
    <script src="JavaScript/记工/edit-mode-handlers.js"></script>
</head>
<body>
    <div class="container">
        <div class="form-row">
            <div>
                <label for="projectName">*项目名称：</label>
                <input type="text" id="projectName" readonly disabled style="background-color: #f8f9fa; cursor: not-allowed; color: #6c757d;">
            </div>
        </div>

        <div class="form-row">
            <div>
                <label for="workDate"><span class="required-asterisk">*</span>记工日期：</label>
                <div class="date-input-container">
                    <input type="date" id="workDate" class="date-input">
                    <div id="dateDisplay" class="date-display"></div>
                </div>
            </div>
        </div>

        <!-- 折叠容器 -->
        <div id="collapseContainer">
            <!-- 可折叠内容 -->
            <div id="collapsibleContent">
        <script>
            // 设置当前日期到日期输入框并添加"今天"标识
            function setTodayDate() {
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                const formattedToday = `${yyyy}-${mm}-${dd}`;
                const workDateInput = document.getElementById('workDate');
                
                // 设置默认日期为今天
                workDateInput.value = formattedToday;
                
                // 更新显示
                updateDateDisplay();
            }

            // 更新日期显示（在框内显示今天标识）
            function updateDateDisplay() {
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                const formattedToday = `${yyyy}-${mm}-${dd}`;
                const workDateInput = document.getElementById('workDate');
                const dateDisplay = document.getElementById('dateDisplay');
                const container = document.querySelector('.date-input-container');
                
                if (workDateInput.value) {
                    // 检查是否有多选日期的显示值
                    let displayText;
                    if (workDateInput.dataset.displayValue) {
                        // 多选模式，使用格式化后的显示值
                        displayText = workDateInput.dataset.displayValue;
                    } else {
                        // 为分项选择器添加点击事件
                        const subProjectSelector = document.getElementById('subProjectSelector');
                        if (subProjectSelector) {
                            subProjectSelector.onclick = function() {
                                // 加载本地分项数据
                                loadSubProjectsFromLocal();
                                
                                const subProjectModal = document.getElementById('subProjectModal');
                                if (subProjectModal) {
                                    subProjectModal.style.display = 'flex';
                                }
                            };
                        }
                        
                        // 为关闭按钮添加点击事件
                        const closeSubProjectModal = document.getElementById('closeSubProjectModal');
                        if (closeSubProjectModal) {
                            closeSubProjectModal.onclick = function() {
                                const subProjectModal = document.getElementById('subProjectModal');
                                if (subProjectModal) {
                                    subProjectModal.style.display = 'none';
                                }
                            };
                        }
                        
                        // 点击模态框外部关闭模态框
                        const subProjectModal = document.getElementById('subProjectModal');
                        if (subProjectModal) {
                            subProjectModal.onclick = function(e) {
                                if (e.target === subProjectModal) {
                                    subProjectModal.style.display = 'none';
                                }
                            };
                        }
                        
                        // 添加新分项的功能
                        const addSubProjectBtn = document.getElementById('addSubProjectBtn');
                        const subProjectList = document.getElementById('subProjectList');
                        
                        if (addSubProjectBtn && subProjectList) {
                            addSubProjectBtn.onclick = function() {
                                const addSubProjectModal = document.getElementById('addSubProjectModal');
                                if (addSubProjectModal) {
                                    addSubProjectModal.style.display = 'flex';
                                }
                            };
                        }
                        
                        // 绑定分项项的点击、编辑和删除事件
                        function bindSubProjectEvents() {
                            // 确保subProjectList存在
                            const subProjectList = document.getElementById('subProjectList');
                            if (!subProjectList) return;
                            
                            // 绑定分项事件...
                            
                            // 选择分项 - 绑定到整个div行
                            const projectRows = subProjectList.querySelectorAll('div');
                            projectRows.forEach(row => {
                                // 清除之前的事件监听器，避免重复绑定
                                row.onclick = null;
                                row.onclick = function(e) {
                                    // 如果点击的是编辑或删除按钮，不触发选择事件
                                    if (e.target.closest('.editSubProjectBtn') || e.target.closest('.deleteSubProjectBtn')) {
                                        return;
                                    }
                                    
                                    const span = this.querySelector('span');
                                    if (!span) return;
                                    
                                    const currentSubProject = document.getElementById('currentSubProject');
                                    if (currentSubProject) {
                                        currentSubProject.textContent = span.textContent;
                                        // 更新overtimeData中的分项数据
                                        if (typeof window.overtimeData !== 'undefined') {
                                            window.overtimeData.value = window.overtimeData.value || {};
                                            window.overtimeData.value.subProject = span.textContent;
                                        }
                                    }
                                    
                                    // 获取分项的单位信息
                                    const editBtn = this.querySelector('.editSubProjectBtn');
                                    if (editBtn) {
                                        const unit = editBtn.getAttribute('data-unit') || '';
                                        
                                        // 填充工量输入框后面的单位
                                        const workAmountUnit = document.getElementById('workAmountUnit');
                                        if (workAmountUnit) {
                                            workAmountUnit.textContent = unit;
                                        }
                                        
                                        // 填充单价输入框后面的单位，用/分隔
                                        const unitPriceUnit = document.getElementById('unitPriceUnit');
                                        if (unitPriceUnit) {
                                            unitPriceUnit.textContent = unit ? `元/${unit}` : '元';
                                        }
                                    }
                                    
                                    const subProjectModal = document.getElementById('subProjectModal');
                                    if (subProjectModal) {
                                        subProjectModal.style.display = 'none';
                                    }
                                };
                            });
                            
                            // 编辑分项按钮事件
                            const editBtns = subProjectList.querySelectorAll('.editSubProjectBtn');
                            editBtns.forEach(btn => {
                                // 清除之前的事件监听器
                                btn.onclick = null;
                                btn.addEventListener('click', function(e) {
                                    e.stopPropagation();
                                    const oldName = this.getAttribute('data-name');
                                    const oldUnit = this.getAttribute('data-unit') || '';
                                    
                                    console.log('点击编辑按钮:', oldName, oldUnit);
                                    
                                    // 创建修改分项模态框 - 与上面的逻辑相同
                                    let editModal = document.getElementById('editSubProjectModal');
                                    if (editModal) {
                                        editModal.remove();
                                    }
                                    
                                    editModal = document.createElement('div');
                                    editModal.id = 'editSubProjectModal';
                                    editModal.className = 'modal';
                                    editModal.style.cssText = 'display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1002; align-items: center; justify-content: center;';
                                    
                                    editModal.innerHTML = `
                                        <div style="background-color: white; border-radius: 8px; width: 500px; max-width: 90%; padding: 20px;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                                <h3 style="margin: 0; font-size: 18px; color: #333;">修改分项</h3>
                                                <button id="closeEditSubProjectModal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">×</button>
                                            </div>
                                            <div style="margin-bottom: 20px;">
                                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                                    <span style="color: red; font-weight: bold;">*</span>
                                                    <label style="color: black; margin: 0;">分项名称：</label>
                                                    <input type="text" id="editSubProjectName" value="${oldName}" 
                                                           style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 8px;">
                                                    <span style="color: red; font-weight: bold;">*</span>
                                                    <span style="color: black; margin: 0;">分项单位：</span>
                                                    <input type="text" id="editSubProjectUnit" value="${oldUnit}" 
                                                           placeholder="请输入单位名称(不超过四个汉字)" 
                                                           style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                                </div>
                                            </div>
                                            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                                                <button id="cancelEditSubProject" style="padding: 8px 20px; background-color: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 14px;">取消</button>
                                                <button id="confirmEditSubProject" style="padding: 8px 20px; background-color: #1890ff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">确认</button>
                                            </div>
                                        </div>
                                    `;
                                    
                                    document.body.appendChild(editModal);
                                    
                                    // 绑定模态框内的事件
                                    editModal.querySelector('#closeEditSubProjectModal').addEventListener('click', function() {
                                        editModal.remove();
                                    });
                                    
                                    editModal.querySelector('#cancelEditSubProject').addEventListener('click', function() {
                                        editModal.remove();
                                    });
                                    
                                    editModal.addEventListener('click', function(e) {
                                        if (e.target === editModal) {
                                            editModal.remove();
                                        }
                                    });
                                    
                                    // 确认修改事件
                                    editModal.querySelector('#confirmEditSubProject').addEventListener('click', function() {
                                        const newNameValue = editModal.querySelector('#editSubProjectName').value.trim();
                                        const newUnitValue = editModal.querySelector('#editSubProjectUnit').value.trim();
                                        
                                        if (!newNameValue) {
                                            alert('请输入分项名称！');
                                            return;
                                        }
                                        
                                        // 更新分项显示
                                        const spanElement = btn.parentElement.previousElementSibling;
                                        if (spanElement) {
                                            spanElement.textContent = newNameValue;
                                        }
                                        btn.setAttribute('data-name', newNameValue);
                                        btn.setAttribute('data-unit', newUnitValue);
                                        
                                        // 更新删除按钮的数据
                                        const deleteBtn = btn.nextElementSibling;
                                        if (deleteBtn) {
                                            deleteBtn.setAttribute('data-name', newNameValue);
                                            deleteBtn.setAttribute('data-unit', newUnitValue);
                                        }
                                        
                                        // 更新当前选中的分项（如果是被修改的这个）
                                        const currentSubProject = document.getElementById('currentSubProject');
                                        if (currentSubProject && currentSubProject.textContent === oldName) {
                                            currentSubProject.textContent = newNameValue;
                                        }
                                        
                                        // 保存到本地存储
                                        saveSubProjectsToLocal();
                                        
                                        editModal.remove();
                                    });
                                });
                            });
                            
                            // 删除分项按钮事件
                            const deleteBtns = subProjectList.querySelectorAll('.deleteSubProjectBtn');
                            deleteBtns.forEach(btn => {
                                // 清除之前的事件监听器
                                btn.onclick = null;
                                btn.addEventListener('click', function(e) {
                                    e.stopPropagation();
                                    const name = this.getAttribute('data-name');
                                    
                                    console.log('点击删除按钮:', name);
                                    
                                    // 检查是否至少保留一个分项
                                    const totalItems = document.querySelectorAll('#subProjectList > div').length;
                                    if (totalItems <= 1) {
                                        alert('至少需要保留一个分项！');
                                        return;
                                    }
                                    
                                    if (confirm(`确定要删除分项"${name}"吗？`)) {
                                        const itemToDelete = this.closest('div[style*="display: flex"]');
                                        if (itemToDelete) {
                                            // 如果删除的是当前选中的分项，选择第一个剩余的分项
                                            const currentSubProject = document.getElementById('currentSubProject');
                                            if (currentSubProject && currentSubProject.textContent === name) {
                                                itemToDelete.remove();
                                                const firstItem = document.querySelector('#subProjectList div span');
                                                if (firstItem && currentSubProject) {
                                                    currentSubProject.textContent = firstItem.textContent;
                                                }
                                            } else {
                                                itemToDelete.remove();
                                            }
                                            
                                            // 保存到本地存储
                                            saveSubProjectsToLocal();
                                        }
                                    }
                                });
                            });
                        }
                        
                        // 初始绑定事件
                        bindSubProjectEvents();
                        
                        // 找到第一个分项作为默认值
                        if (subProjectList && document.getElementById('currentSubProject')) {
                            const firstItem = subProjectList.querySelector('div > span');
                            if (firstItem) {
                                const currentSubProject = document.getElementById('currentSubProject');
                                if (currentSubProject) {
                                    currentSubProject.textContent = firstItem.textContent;
                                    // 更新overtimeData中的分项数据
                                    if (typeof window.overtimeData !== 'undefined') {
                                        window.overtimeData.value = window.overtimeData.value || {};
                                        window.overtimeData.value.subProject = firstItem.textContent;
                                    }
                                }
                            }
                        }
                        // 单选模式，格式化单个日期
                        displayText = formatDateForDisplay(workDateInput.value);
                        
                        // 检查是否为今天
                        if (workDateInput.value === formattedToday) {
                            displayText += '<span class="today-text">（今天）</span>';
                        }
                    }
                    
                    dateDisplay.innerHTML = displayText;
                    
                    // 检查是否为今天（只在单选模式下检查）
                    if (!workDateInput.dataset.displayValue && workDateInput.value === formattedToday) {
                        dateDisplay.classList.add('today');
                        workDateInput.setAttribute('data-today', 'true');
                    } else {
                        dateDisplay.classList.remove('today');
                        workDateInput.removeAttribute('data-today');
                    }
                    
                    // 触发日期变化自定义事件
                    const dateChangedEvent = new CustomEvent('dateChanged', {
                        detail: { 
                            date: workDateInput.value,
                            displayText: displayText
                        }
                    });
                    document.dispatchEvent(dateChangedEvent);
                } else {
                    dateDisplay.innerHTML = '请选择日期';
                    dateDisplay.classList.remove('today');
                    workDateInput.removeAttribute('data-today');
                    // 清除多选显示值
                    delete workDateInput.dataset.displayValue;
                }
            }
            
            // 处理日期输入框交互
            function setupDateInteraction() {
                const workDateInput = document.getElementById('workDate');
                const container = document.querySelector('.date-input-container');
                
                // 点击显示区域时激活输入框或打开日期选择器
                const dateDisplay = document.getElementById('dateDisplay');
                dateDisplay.addEventListener('click', function() {
                    // 如果日期输入框被禁用，不打开日期选择器
                    if (workDateInput && workDateInput.disabled) {
                        return;
                    }
                    showDatePicker();
                });
                
                // 输入框点击时打开日期选择器
                workDateInput.addEventListener('click', function(e) {
                    // 如果日期输入框被禁用，不打开日期选择器
                    if (this.disabled) {
                        e.preventDefault();
                        return;
                    }
                    e.preventDefault();
                    showDatePicker();
                });
                
                // 防止原生日期输入框获得焦点
                workDateInput.addEventListener('focus', function(e) {
                    // 如果日期输入框被禁用，不打开日期选择器
                    if (this.disabled) {
                        e.preventDefault();
                        return;
                    }
                    e.preventDefault();
                    this.blur(); // 立即失去焦点
                    showDatePicker();
                });
                
                // 日期改变时更新显示
                workDateInput.addEventListener('change', function() {
                    updateDateDisplay();
                });
                    
                    // 刷新记工流水数据
                    if (window.workFlowService && window.workFlowService.refreshWorkFlow) {
                        window.workFlowService.refreshWorkFlow();
                    }
                }
            
            // 日期选择器状态管理
            let datePickerState = {
                currentDate: new Date(),
                displayDate: new Date(),
                mode: 'single', // 'single' 或 'multiple'
                tempSelectedDates: new Set(), // 多选模式下的临时选中日期
                confirmedDates: new Set(), // 多选模式下的已确认日期
                singleSelectedDate: null // 单选模式下的选中日期
            };
            
            // 显示日期选择器
            function showDatePicker() {
                const modal = document.getElementById('datePickerModal');
                modal.style.display = 'flex';
                
                // 初始化选择器状态
                initializeDatePicker();
                
                // 渲染日历
                renderCalendar();
                
                // 更新模式显示
                updateModeDisplay();
            }
            
            // 隐藏日期选择器
            function hideDatePicker() {
                const modal = document.getElementById('datePickerModal');
                modal.style.display = 'none';
            }
            
            // 初始化日期选择器
            function initializeDatePicker() {
                const workDateInput = document.getElementById('workDate');
                
                // 设置当前显示日期
                if (workDateInput.value) {
                    datePickerState.displayDate = new Date(workDateInput.value + 'T00:00:00');
                    if (datePickerState.mode === 'single') {
                        datePickerState.singleSelectedDate = workDateInput.value;
                    }
                } else {
                    datePickerState.displayDate = new Date();
                }
                
                // 绑定事件监听器
                bindDatePickerEvents();
            }
            
            // 绑定日期选择器事件
            function bindDatePickerEvents() {
                // 模式切换按钮
                document.getElementById('modeSwitchBtn').onclick = toggleMode;
                
                // 月份切换
                document.getElementById('prevMonth').onclick = () => changeMonth(-1);
                document.getElementById('nextMonth').onclick = () => changeMonth(1);
                
                // 确认按钮
                document.getElementById('confirmDates').onclick = confirmSelectedDates;
                
                // 点击模态框外部关闭
                const modal = document.getElementById('datePickerModal');
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        hideDatePicker();
                    }
                });
            }
            
            // 切换模式（单个按钮切换）
            function toggleMode() {
                const newMode = datePickerState.mode === 'single' ? 'multiple' : 'single';
                switchMode(newMode);
            }
            
            // 切换模式
            function switchMode(newMode) {
                if (datePickerState.mode === newMode) return;
                
                const oldMode = datePickerState.mode;
                datePickerState.mode = newMode;
                
                // 更新按钮显示
                updateModeSwitchButton();
                
                // 模式转换逻辑
                if (newMode === 'multiple' && oldMode === 'single') {
                    // 从单选转为多选：保留当前选中日期
                    if (datePickerState.singleSelectedDate) {
                        datePickerState.tempSelectedDates.add(datePickerState.singleSelectedDate);
                        datePickerState.singleSelectedDate = null;
                    }
                } else if (newMode === 'single' && oldMode === 'multiple') {
                    // 从多选转为单选：保留最后一个日期
                    const allDates = [...datePickerState.tempSelectedDates, ...datePickerState.confirmedDates];
                    if (allDates.length > 0) {
                        datePickerState.singleSelectedDate = allDates[allDates.length - 1];
                    }
                    datePickerState.tempSelectedDates.clear();
                    datePickerState.confirmedDates.clear();
                }
                
                // 重新渲染
                renderCalendar();
                updateModeDisplay();
            }
            
            // 更新模式切换按钮
            function updateModeSwitchButton() {
                const modeSwitchBtn = document.getElementById('modeSwitchBtn');
                
                if (datePickerState.mode === 'single') {
                    modeSwitchBtn.textContent = '📅';
                    modeSwitchBtn.title = '切换单选/多选模式';
                    modeSwitchBtn.classList.remove('multiple');
                } else {
                    modeSwitchBtn.textContent = '📆';
                    modeSwitchBtn.title = '切换单选/多选模式';
                    modeSwitchBtn.classList.add('multiple');
                }
            }
            
            // 渲染日历
            function renderCalendar() {
                const currentMonthEl = document.getElementById('currentMonth');
                const calendarDays = document.getElementById('calendarDays');
                
                const year = datePickerState.displayDate.getFullYear();
                const month = datePickerState.displayDate.getMonth();
                
                // 更新月份显示
                currentMonthEl.textContent = `${year}年${month + 1}月`;
                
                // 更新月份切换按钮状态
                updateMonthNavigationButtons(year, month);
                
                // 清空日历
                calendarDays.innerHTML = '';
                
                // 获取当月第一天和最后一天
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                // 调整星期计算：0(日)转为6，1-6(一-六)转为0-5
                const firstDayOfWeek = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
                const daysInMonth = lastDay.getDate();
                
                // 获取上个月的最后几天
                const prevMonth = new Date(year, month - 1, 0);
                const daysInPrevMonth = prevMonth.getDate();
                
                // 渲染上个月的日期
                for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                    const day = daysInPrevMonth - i;
                    const dateStr = formatDate(year, month - 1, day);
                    const dayEl = createDayElement(day, true, dateStr);
                    calendarDays.appendChild(dayEl);
                }
                
                // 渲染当月的日期
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = formatDate(year, month, day);
                    const dayEl = createDayElement(day, false, dateStr);
                    calendarDays.appendChild(dayEl);
                }
                
                // 渲染下个月的日期（填满网格）
                const totalCells = calendarDays.children.length;
                const remainingCells = 42 - totalCells; // 6周 * 7天
                for (let day = 1; day <= remainingCells; day++) {
                    const dateStr = formatDate(year, month + 1, day);
                    const dayEl = createDayElement(day, true, dateStr);
                    calendarDays.appendChild(dayEl);
                }
            }
            
            // 更新月份导航按钮状态
            function updateMonthNavigationButtons(year, month) {
                const today = new Date();
                const currentYear = today.getFullYear();
                const currentMonth = today.getMonth();
                const nextMonthBtn = document.getElementById('nextMonth');
                
                // 如果下个月大于当前月，禁用下个月按钮
                if (year > currentYear || (year === currentYear && month >= currentMonth)) {
                    nextMonthBtn.disabled = true;
                    nextMonthBtn.style.opacity = '0.3';
                    nextMonthBtn.style.cursor = 'not-allowed';
                    nextMonthBtn.style.background = '#f0f0f0';
                    nextMonthBtn.style.color = '#ccc';
                } else {
                    nextMonthBtn.disabled = false;
                    nextMonthBtn.style.opacity = '1';
                    nextMonthBtn.style.cursor = 'pointer';
                    nextMonthBtn.style.background = '#f0f0f0';
                    nextMonthBtn.style.color = '#666';
                }
            }
            
            // 农历转换函数 - 将公历日期转换为大写农历
            function getLunarCalendar(dateStr) {
                const date = new Date(dateStr + 'T00:00:00');
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const day = date.getDate();
                
                // 简化的农历转换（实际项目中可以使用更完整的农历库）
                // 这里使用一个简化的实现，实际应用中应该使用完整的农历算法
                const lunarDays = ['初一', '初二', '初三', '初四', '初五', '初六', '初七', '初八', '初九', '初十',
                                  '十一', '十二', '十三', '十四', '十五', '十六', '十七', '十八', '十九', '二十',
                                  '廿一', '廿二', '廿三', '廿四', '廿五', '廿六', '廿七', '廿八', '廿九', '三十'];
                
                // 简化的农历计算（实际应用中需要更精确的算法）
                // 这里使用一个基于年份的简单偏移量计算
                const offset = (year - 2000) * 12 + month;
                const lunarDayIndex = (day + offset) % 30;
                
                return `${lunarDays[lunarDayIndex]}`;
            }
            
            // 创建日期元素
            function createDayElement(day, isOtherMonth, dateStr) {
                const dayEl = document.createElement('div');
                dayEl.className = 'day-cell';
                dayEl.dataset.date = dateStr;
                
                // 创建日期和农历的容器
                const dayContent = document.createElement('div');
                dayContent.style.display = 'flex';
                dayContent.style.flexDirection = 'column';
                dayContent.style.alignItems = 'center';
                dayContent.style.justifyContent = 'center';
                dayContent.style.height = '100%';
                dayContent.style.padding = '5px';
                
                // 添加日期数字
                const dayNumber = document.createElement('span');
                dayNumber.textContent = day;
                dayNumber.style.fontSize = '14px';
                dayNumber.style.fontWeight = 'bold';
                dayContent.appendChild(dayNumber);
                
                // 添加农历
                if (!isOtherMonth) {
                    const lunarCalendar = getLunarCalendar(dateStr);
                    const lunarElement = document.createElement('span');
                    lunarElement.textContent = lunarCalendar;
                    lunarElement.style.fontSize = '10px';
                    lunarElement.style.color = '#999';
                    lunarElement.style.marginTop = '2px';
                    dayContent.appendChild(lunarElement);
                }
                
                dayEl.appendChild(dayContent);
                
                if (isOtherMonth) {
                    dayEl.classList.add('other-month');
                    return dayEl;
                }
                
                // 检查是否为今天
                const today = new Date();
                const todayStr = formatDate(today.getFullYear(), today.getMonth(), today.getDate());
                if (dateStr === todayStr) {
                    dayEl.classList.add('today');
                }
                
                // 检查是否大于今天（禁用未来日期）
                const selectedDate = new Date(dateStr + 'T00:00:00');
                if (selectedDate > today) {
                    dayEl.classList.add('disabled-future');
                    dayEl.style.cursor = 'not-allowed';
                    return dayEl; // 不添加点击事件
                }
                
                // 检查选中状态
                if (datePickerState.mode === 'single') {
                    if (dateStr === datePickerState.singleSelectedDate) {
                        dayEl.classList.add('selected-single');
                    }
                } else {
                    if (datePickerState.tempSelectedDates.has(dateStr)) {
                        dayEl.classList.add('selected-temp');
                    }
                    if (datePickerState.confirmedDates.has(dateStr)) {
                        dayEl.classList.add('selected-confirmed');
                    }
                }
                
                // 添加点击事件（只对非禁用日期）
                dayEl.addEventListener('click', () => selectDate(dateStr));
                
                return dayEl;
            }
            
            // 选择日期
            function selectDate(dateStr) {
                if (datePickerState.mode === 'single') {
                    // 单选模式：直接设置并关闭
            datePickerState.singleSelectedDate = dateStr;
            
            // 更新输入框
            const workDateInput = document.getElementById('workDate');
            workDateInput.value = dateStr;
            // 清除多选显示值
            delete workDateInput.dataset.displayValue;
            updateDateDisplay();
            
            // 触发日期变化事件，让workRecordMarker重新检查已记工员工
            const event = new Event('dateDisplayUpdated');
            document.dispatchEvent(event);
            
            // 切换日期时取消所有员工的选中状态
            selectedEmployeeIds.clear();
            
            // 重新加载员工数据，确保只显示在职员工和当前日期有记工记录的员工
            const projectName = document.getElementById('projectName').value;
            if (projectName) {
                loadEmployeeData(projectName);
            }
            
            // 关闭模态框
            hideDatePicker();
                } else {
                    // 多选模式：处理已确认日期和临时选中日期
                    let confirmedChanged = false;
                    if (datePickerState.confirmedDates.has(dateStr)) {
                        // 已确认的日期，点击取消确认
                        datePickerState.confirmedDates.delete(dateStr);
                        confirmedChanged = true;
                    } else if (datePickerState.tempSelectedDates.has(dateStr)) {
                        // 临时选中的日期，点击取消选中
                        datePickerState.tempSelectedDates.delete(dateStr);
                    } else {
                        // 未选中的日期，点击添加到临时选中
                        datePickerState.tempSelectedDates.add(dateStr);
                    }
                    
                    // 重新渲染日历
                    renderCalendar();
                    
                    // 如果已确认日期有变化，更新输入框显示
                    if (confirmedChanged) {
                        const allDates = Array.from(datePickerState.confirmedDates).sort();
                        const workDateInput = document.getElementById('workDate');
                        
                        if (allDates.length > 0) {
                            if (allDates.length === 1) {
                                // 单个日期，直接显示
                                workDateInput.value = allDates[0];
                                // 清除多选显示值
                                delete workDateInput.dataset.displayValue;
                            } else {
                                // 多个日期，格式化显示
                                const formattedDates = formatMultipleDates(allDates);
                                // 使用第一个日期作为输入框的值（用于表单提交）
                                workDateInput.value = allDates[0];
                                // 但在显示层显示所有日期
                                workDateInput.dataset.displayValue = formattedDates;
                            }
                            updateDateDisplay();
                        } else {
                            // 没有已确认日期，清空输入框
                            workDateInput.value = '';
                            delete workDateInput.dataset.displayValue;
                            updateDateDisplay();
                        }
                    }

            }
        }
            
            // 更新模式显示
            function updateModeDisplay() {
                const confirmBtn = document.getElementById('confirmDates');
                
                // 更新模式切换按钮
                updateModeSwitchButton();
                
                if (datePickerState.mode === 'single') {
                    confirmBtn.style.display = 'none';
                } else {
                    confirmBtn.style.display = 'flex';
                }
            }
            
            // 确认选中的日期
            function confirmSelectedDates() {
                // 将临时选中的日期移动到已确认集合
                datePickerState.tempSelectedDates.forEach(dateStr => {
                    datePickerState.confirmedDates.add(dateStr);
                });
                datePickerState.tempSelectedDates.clear();
                
                // 更新输入框显示（显示所有选中的日期）
                const allDates = Array.from(datePickerState.confirmedDates).sort();
                if (allDates.length > 0) {
                    const workDateInput = document.getElementById('workDate');
                    
                    if (allDates.length === 1) {
                        // 单个日期，直接显示
                        workDateInput.value = allDates[0];
                    } else {
                        // 多个日期，格式化显示
                        const formattedDates = formatMultipleDates(allDates);
                        // 使用第一个日期作为输入框的值（用于表单提交）
                        workDateInput.value = allDates[0];
                        // 但在显示层显示所有日期
                        workDateInput.dataset.displayValue = formattedDates;
                    }
                    
                    updateDateDisplay();
                }
                
                // 重新渲染
                renderCalendar();
                
                // 关闭模态框
                hideDatePicker();
            }
            
            // 格式化多个日期显示
            function formatMultipleDates(dateStrings) {
                if (dateStrings.length === 0) return '';
                if (dateStrings.length === 1) return formatDateForDisplay(dateStrings[0]);
                
                const dates = dateStrings.map(dateStr => {
                    const [year, month, day] = dateStr.split('-');
                    return {
                        year: parseInt(year),
                        month: parseInt(month),
                        day: parseInt(day),
                        original: dateStr
                    };
                });
                
                let result = [];
                let currentYear = null;
                let currentMonth = null;
                
                for (let i = 0; i < dates.length; i++) {
                    const date = dates[i];
                    
                    if (i === 0) {
                        // 第一个日期总是显示完整格式
                        result.push(`${date.year}年${date.month}月：${date.day}`);
                        currentYear = date.year;
                        currentMonth = date.month;
                    } else {
                        if (date.year === currentYear && date.month === currentMonth) {
                            // 相同年月，只显示日
                            result.push(String(date.day));
                        } else {
                            // 不同年月，显示完整格式
                            result.push(`${date.year}年${date.month}月：${date.day}`);
                            currentYear = date.year;
                            currentMonth = date.month;
                        }
                    }
                }
                
                // 在最后一个元素后添加"日"字
                if (result.length > 0) {
                    const lastIndex = result.length - 1;
                    result[lastIndex] = result[lastIndex] + '日';
                }
                
                return result.join('，');
            }
            
            // 改变月份
            function changeMonth(delta) {
                const newDate = new Date(datePickerState.displayDate);
                newDate.setMonth(newDate.getMonth() + delta);
                
                // 检查是否超过当前月份
                const today = new Date();
                const currentYear = today.getFullYear();
                const currentMonth = today.getMonth();
                const newYear = newDate.getFullYear();
                const newMonth = newDate.getMonth();
                
                // 如果新日期大于当前年月，则不允许切换
                if (newYear > currentYear || (newYear === currentYear && newMonth > currentMonth)) {
                    return; // 不执行切换
                }
                
                datePickerState.displayDate = newDate;
                renderCalendar();
            }
            
            // 格式化日期
            function formatDate(year, month, day) {
                const adjustedMonth = month < 0 ? 11 : (month > 11 ? 0 : month);
                const adjustedYear = month < 0 ? year - 1 : (month > 11 ? year + 1 : year);
                
                const yyyy = adjustedYear;
                const mm = String(adjustedMonth + 1).padStart(2, '0');
                const dd = String(day).padStart(2, '0');
                return `${yyyy}-${mm}-${dd}`;
            }
            
            // 格式化日期为显示格式
            function formatDateForDisplay(dateStr) {
                const [year, month, day] = dateStr.split('-');
                return `${year}年${parseInt(month)}月${parseInt(day)}日`;
            }

            // 页面加载时设置今天日期
            document.addEventListener('DOMContentLoaded', function() {
                setTodayDate();
                setupDateInteraction();
            });

            // 当日期改变时更新显示
            document.addEventListener('DOMContentLoaded', function() {
                const workDateInput = document.getElementById('workDate');
                if (workDateInput) {
                    workDateInput.addEventListener('change', updateDateDisplay);
                }
            });

            // 折叠功能实现
            document.addEventListener('DOMContentLoaded', function() {
                const collapseToggle = document.getElementById('collapseToggle');
                const collapsibleContent = document.getElementById('collapsibleContent');
                const collapseIcon = document.getElementById('collapseIcon');
                const workTabRadios = document.querySelectorAll('input[name="workTab"]');

                // 折叠/展开切换功能
                collapseToggle.addEventListener('click', function() {
                    if (collapsibleContent.style.display === 'none') {
                        // 展开
                        collapsibleContent.style.display = 'block';
                        collapseIcon.textContent = '▼';
                    } else {
                        // 折叠
                        collapsibleContent.style.display = 'none';
                        collapseIcon.textContent = '▶';
                    }
                });

                // 监听记工流水标签选中事件
                workTabRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        if (this.value === '记工流水') {
                            // 选中记工流水标签，折叠中间元素
                            collapsibleContent.style.display = 'none';
                            collapseIcon.textContent = '▶';
                        } else if (this.value === '记工') {
                            // 选中记工标签，展开中间元素
                            collapsibleContent.style.display = 'block';
                            collapseIcon.textContent = '▼';
                        }
                    });
            });
            
            // 触发员工列表渲染完成事件
            const event = new Event('employeeListRendered');
            document.dispatchEvent(event);

                // 初始状态：记工流水标签未选中时，展开内容
                collapsibleContent.style.display = 'block';
            });
        </script>

        <div class="form-group">
            <div class="work-type work-type-selection">
                <input type="radio" id="workType1" name="workType" value="点工" checked>
                <label for="workType1" class="work-type-option active">点工</label>
                <input type="radio" id="workType2" name="workType" value="包工">
                <label for="workType2" class="work-type-option">包工</label>
                <input type="radio" id="workType3" name="workType" value="工量">
                <label for="workType3" class="work-type-option">工量</label>
            </div>
        </div>

        <div class="form-group">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                <label id="employeeSelectionLabel">选择员工：</label>
                <button id="selectAllBtn" style="padding: 5px 10px; background-color: #ED7D31; color: white; border: none; border-radius: 4px; cursor: pointer;">全选</button>
                <button id="selectInverseBtn" style="padding: 5px 10px; background-color: #722ed1; color: white; border: none; border-radius: 4px; cursor: pointer;">反选</button>
            </div>
            <div class="employee-selection">
                
                <div class="employee-list" id="employeeList">
                    <!-- 员工列表将通过JavaScript动态添加 -->
                </div>
            </div>
        </div>
            </div>
        </div>

        <!-- 标签页导航 -->
        <div class="form-group">
            <div class="work-type tab-navigation" style="margin-bottom: 0; border-bottom: 2px solid #ddd; display: flex; align-items: center;">
                <input type="radio" id="tabWorkRecord" name="workTab" value="记工" checked>
                <label for="tabWorkRecord" class="work-type-option active">记工</label>
                
                <!-- 折叠图标按钮 -->
                <div id="collapseToggle" style="display: flex; align-items: center; justify-content: center; padding: 8px; cursor: pointer; background-color: transparent; border: none; margin: 0 10px; font-size: 16px;">
                    <span id="collapseIcon" style="font-size: 16px;">▼</span>
                </div>
                
                <input type="radio" id="tabWorkFlow" name="workTab" value="记工流水">
                <label for="tabWorkFlow" class="work-type-option">记工流水</label>
            </div>
        </div>

        <!-- 记工标签页内容 -->
        <div id="workRecordTabContent">

        <div class="form-group" id="dayWorkOptions" style="display: block;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                <label>上班：</label>
                <div style="display: flex; align-items: center; gap: 15px; flex: 1;">
                    <button id="dayWork1" class="daywork-btn" data-value="1" style="padding: 5px 10px; background-color: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; flex-shrink: 0; width: auto;"><span class="editable-number" contenteditable="true">1</span>个工</button>
                    <button id="dayWork05" class="daywork-btn" data-value="0.5" style="padding: 5px 10px; background-color: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; flex-shrink: 0; width: auto;">半个工</button>
                    <div id="dayWorkHours" class="daywork-btn hours-select-container" data-value="hours" style="padding: 5px 10px; background-color: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; position: relative; width: 110px; flex-shrink: 0;">
                        <input type="text" class="hours-input" value="选小时" readonly style="border: none; background: transparent; color: inherit; width: 100%; cursor: pointer; outline: none;">
                        <div class="hours-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                            <div class="hours-option" data-value="hours" style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;">选小时</div>
                        </div>
                    </div>
                </div>
                <!-- 隐藏的单选按钮用于保持表单功能 -->
                <input type="radio" name="dayWork" value="1" style="display: none;" id="hiddenRadio1">
                <input type="radio" name="dayWork" value="0.5" style="display: none;" id="hiddenRadio05">
                <input type="radio" name="dayWork" value="hours" style="display: none;" id="hiddenRadioHours">
                <input type="radio" name="dayWork" value="rest" style="display: none;" id="hiddenRadioRest">
                <input type="radio" name="dayWork" value="period" style="display: none;" id="hiddenRadioPeriod">
            </div>
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                <label style="visibility: hidden;">上班：</label>
                <div style="display: flex; align-items: center; gap: 15px; flex: 1;">
                    <button id="morningAfternoonBtn" class="daywork-btn" style="padding: 5px 10px; background-color: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; flex-shrink: 0; width: auto;">上下午</button>
                    <button id="dayWorkRest" class="daywork-btn" data-value="rest" style="padding: 5px 10px; background-color: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; flex-shrink: 0; width: auto;">休息</button>
                </div>
            </div>

        </div>

        <div class="form-group" id="overtimeContainer">
            <div style="display: flex; align-items: center; gap: 10px;">
                <label>加班：</label>
                <button id="overtimeBtn" style="margin: 0; background-color: transparent; border: 1px solid #ddd; height: 36px; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: bold; color: #000; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: center;">无加班</button>
            </div>
            <!-- 加班模态框 -->
            <div id="overtimeModal" class="modal" style="display: none;">
                <div class="modal-content" style="width: 450px; position: relative;">
                    <button class="modal-close" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 20px; cursor: pointer; color: #999;" onclick="hideOvertimeModal()">&times;</button>
                    <h3 style="color: #ED7D31; margin-top: 0; margin-bottom: 20px;">请选择加班时长</h3>
                    <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                        <button id="overtimeNone" class="overtime-option" data-value="none" style="padding: 8px 15px; background-color: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: center;">无加班</button>
                        <div id="overtimeWork" class="overtime-option work-container" data-value="work" style="padding: 8px 15px; background-color: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; position: relative; font-family: inherit; font-size: 16px; font-weight: bold; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: center; min-height: 34px; display: flex; align-items: center;">
                            <span class="work-btn-text" style="font-family: inherit; font-size: 16px; font-weight: bold;">输入工</span>
                            <input type="text" class="work-input" style="display: none; border: none; background: transparent; color: inherit; width: 60px; outline: none; text-align: center; font-size: 16px; font-weight: bold;" placeholder="半" value="半">
                        </div>
                        <div id="overtimeHours" class="overtime-option hours-select-container" data-value="hours" style="padding: 8px 15px; background-color: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; position: relative; width: 110px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: center;">
                            <input type="text" class="modal-hours-input" value="选小时" readonly style="border: none; background: transparent; color: inherit; width: 100%; cursor: pointer; outline: none;">
                            <div class="modal-hours-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                                <div class="modal-hours-option disabled" data-value="hours">选小时</div>
                                <!-- 小时选项将通过JavaScript动态添加 -->
                            </div>
                        </div>
                    </div>
                    <div class="form-buttons" style="display: flex; justify-content: space-between; align-items: flex-end; gap: 10px; margin-top: 20px;">
                        <button id="cancelOvertime" style="padding: 10px 20px; background-color: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: center;">取消</button>
                        <button id="confirmOvertime" style="padding: 10px 20px; background-color: #ED7D31; color: white; border: none; border-radius: 4px; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: center;">确认</button>
                    </div>
                </div>
            </div>
            <div id="overtimeDetails" style="display: none; margin-top: 10px;">
                <label for="overtimeHoursInput">加班小时数</label>
                <input type="text" id="overtimeHoursInput" placeholder="输入加班小时数">
            </div>
        </div>

        <div class="form-row">
            <div style="flex: 1; display: flex; align-items: center; gap: 10px;">
                <label for="remark" style="margin-bottom: 0; white-space: nowrap; font-weight: bold;">备注：</label>
                <textarea id="remark" style="width: 40%; min-height: 55px; height: 55px; border: 1px solid #ddd; border-radius: 4px; padding: 8px; font-size: 16px; font-weight: bold; resize: both;" placeholder="请输入备注"></textarea>
            </div>
        </div>

        <div class="form-group">
            <div style="display: flex; align-items: center; gap: 10px;">
                <label>图片：</label>
                <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                <!-- 图片上传微缩框容器将在这里动态创建 -->
            </div>
            
            <!-- 图片放大模态框 -->
            <div id="imageModal" style="display: none;"></div>
            <div style="height: 60px;"></div>
        </div>
    </div>

    <div class="bottom-buttons" style="display: flex; justify-content: flex-start; background-color: transparent;">
        <button id="confirmBtn" style="
            padding: 8px 16px;
            background: linear-gradient(135deg, #1890ff 0%, #096dd9 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(24, 144, 255, 0.3);
        ">确认记工</button>
    </div>

    <!-- 记工标签页内容结束 -->
    </div>

    <!-- 日期选择器模态框 -->
    <div class="modal" id="datePickerModal">
        <div class="date-picker-content">
            <div class="date-picker-body">
                <div class="calendar-header">
                    <button id="prevMonth">&lt;</button>
                    <div style="display: flex; align-items: center; gap: 15px; flex: 1; justify-content: center;">
                        <span id="currentMonth"></span>
                        <button id="modeSwitchBtn" class="month-btn" title="切换单选/多选模式">📅</button>
                        <button id="confirmDates" class="month-btn confirm-btn" style="display: none;">确定</button>
                    </div>
                    <button id="nextMonth">&gt;</button>
                </div>
                
                <div class="calendar-grid">
                    <div class="weekdays">
                        <div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div><div>日</div>
                    </div>
                    <div id="calendarDays" class="calendar-days"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加员工模态框 -->
    <div class="modal" id="addEmployeeModal">
        <div class="modal-content">
            <h3 style="color: #ED7D31;">添加员工</h3>
            <div id="inactiveEmployeesList">
                <!-- 非在职员工列表将通过JavaScript动态添加 -->
            </div>
            <div class="form-buttons">
                <button id="confirmAddEmployees">确认添加</button>
                <button id="cancelAddEmployees">取消</button>
            </div>
        </div>
    </div>

    <!-- 上下午选择模态框 -->
    <div class="modal" id="morningAfternoonModal">
        <div class="modal-content" style="width: 450px; position: relative;">
            <button class="modal-close" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 20px; cursor: pointer; color: #999;">&times;</button>
            <h3 style="color: #ED7D31; margin-bottom: 20px;">请选择上/下午时长</h3>
            
            <!-- 上午选项 -->
            <div style="margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="color: #333; font-weight: bold;">上午：</span>
                    <button id="morningRest" class="morning-afternoon-btn" data-period="morning" data-value="rest" style="padding: 5px 10px; background-color: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: center; position: relative; z-index: 999;">休息</button>
                    <div id="morningWorkContainer" class="morning-afternoon-btn" data-period="morning" data-value="work" style="padding: 5px 10px; background-color: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; position: relative; z-index: 999; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: center;">
                        <span class="work-btn-text">输入工</span>
                        <input type="text" class="work-input" style="display: none; border: none; background: transparent; color: inherit; width: 60px; outline: none; text-align: center; font-size: 16px; font-weight: bold;" placeholder="半">
                    </div>
                    <div id="morningHours" class="morning-afternoon-btn modal-hours-select-container" data-period="morning" data-value="hours" style="padding: 5px 10px; background-color: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; position: relative; z-index: 999; width: 110px; flex-shrink: 0;">
                        <input type="text" class="modal-hours-input" value="选小时" readonly style="border: none; background: transparent; color: inherit; width: 100%; cursor: pointer; outline: none;">
                        <div class="modal-hours-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto; z-index: 1001; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                            <!-- 小时选项将通过JavaScript动态添加 -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 下午选项 -->
            <div style="margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="color: #333; font-weight: bold;">下午：</span>
                    <button id="afternoonRest" class="morning-afternoon-btn" data-period="afternoon" data-value="rest" style="padding: 5px 10px; background-color: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: center; position: relative; z-index: 998;">休息</button>
                    <div id="afternoonWorkContainer" class="morning-afternoon-btn" data-period="afternoon" data-value="work" style="padding: 5px 10px; background-color: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; position: relative; z-index: 998; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: center;">
                        <span class="work-btn-text">输入工</span>
                        <input type="text" class="work-input" style="display: none; border: none; background: transparent; color: inherit; width: 60px; outline: none; text-align: center; font-size: 16px; font-weight: bold;" placeholder="半">
                    </div>
                    <div id="afternoonHours" class="morning-afternoon-btn modal-hours-select-container" data-period="afternoon" data-value="hours" style="padding: 5px 10px; background-color: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; position: relative; z-index: 998; width: 110px; flex-shrink: 0;">
                        <input type="text" class="modal-hours-input" value="选小时" readonly style="border: none; background: transparent; color: inherit; width: 100%; cursor: pointer; outline: none;">
                        <div class="modal-hours-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto; z-index: 1001; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                            <!-- 小时选项将通过JavaScript动态添加 -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-buttons" style="display: flex; justify-content: space-between; align-items: flex-end; gap: 10px; margin-top: 20px;">
                <button id="cancelMorningAfternoon" style="padding: 10px 20px; background-color: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: center;">取消</button>
                    <button id="confirmMorningAfternoon" style="padding: 10px 20px; background-color: #ED7D31; color: white; border: none; border-radius: 4px; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: center;">确认</button>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // 全局变量
        let employees = []; // 所有员工
        let activeEmployees = []; // 在职员工
        let inactiveEmployees = []; // 非在职员工(离职和隐藏)
        let selectedEmployeeIds = new Set(); // 选中的员工ID
        let isOvertime = false; // 是否加班
        let projectData = []; // 项目数据
        let isAllSelected = false; // 全选状态标记
        let isEditMode = false; // 是否为编辑模式标记
        let isFromEditMode = false; // 是否从编辑模式展开
        let isFromTimesheet = false; // 是否从记工表进入
        let timesheetEmployeeId = null; // 从记工表进入时的员工ID
        let isFromTimesheetExpanded = false; // 是否从记工表进入后展开

        // 确保又拍云配置正确加载
        if (typeof upConfig !== 'undefined') {
            console.log('又拍云配置已加载，basePath:', typeof upConfig !== 'undefined' ? upConfig.basePath : 'undefined');
        }

        // 设置编辑模式状态
        function setEditMode(mode) {
            isEditMode = mode;
        }
        
        // 将setEditMode函数暴露到全局，以便在其他脚本中调用
        window.setEditMode = setEditMode;
        
        // 更新编辑模式下的UI状态
        function updateUIForEditMode() {
            // 这个函数用于更新UI状态，以反映当前是否处于编辑模式
            // 可以根据需要添加具体的UI更新逻辑
            // 例如：显示/隐藏某些控件、更新按钮文本等
        }
        
        // 将updateUIForEditMode函数暴露到全局
        window.updateUIForEditMode = updateUIForEditMode;
        
        // 初始化函数
        function init() {
            // 通知父页面更新标题为"记工"
            if (window.parent && window.parent !== window) {
                // 使用当前页面的origin作为targetOrigin，提高安全性
                const targetOrigin = window.location.origin || '*';
                window.parent.postMessage({
                    type: 'updateTitle',
                    page: '记工.html'
                }, targetOrigin);
            }
            

            
            // 初始化绑定点工按钮事件，确保在任何模式下都能正常工作
            if (typeof bindDayWorkButtons === 'function') {
                bindDayWorkButtons();
            } else if (typeof window.bindDayWorkButtons === 'function') {
                window.bindDayWorkButtons();
            }
            
            // 检查URL参数中是否有记录ID（编辑模式）
            const urlParams = new URLSearchParams(window.location.search);
            const record_idFromUrl = urlParams.get('record_id');
            
            if (record_idFromUrl) {
                // 进入编辑模式
                loadRecordForEditing(record_idFromUrl);
            } else {
                // 正常的新建模式
                loadNormalMode();
            }
        }

        // 压缩图片函数 - 提升到全局范围内
        function processImage(file) {
            return new Promise((resolve, reject) => {
                new Compressor(file, {
                    quality: 0.7,
                    maxWidth: 1920,
                    maxHeight: 1080,
                    success(result) {
                        const reader = new FileReader();
                        reader.readAsDataURL(result);
                        reader.onload = function(e) {
                            resolve({
                                dataURL: e.target.result,
                                blob: result,
                                width: 0,
                                height: 0
                            });
                        };
                        reader.onerror = function() {
                            reject(new Error('文件读取失败'));
                        };
                    },
                    error(err) {
                        reject(err);
                    }
                });
            });
        }
        window.processImage = processImage;
        
        // 初始化全局图片数组
        window.selectedImages = [];
        
        // 清除图片函数（清除所有微缩框图片）
        window.clearImage = function() {
            // 清空全局图片数组
            window.selectedImages = [];
            
            const container = document.getElementById('imageUploadContainer');
            if (container) {
                // 保留添加按钮，删除所有预览图片
                const items = container.querySelectorAll('.image-preview-item');
                items.forEach(item => item.remove());
            }
            document.getElementById('imageUpload').value = '';
            document.getElementById('imageModal').style.display = 'none';
        }
        
        // 全局标志，跟踪图片上传功能是否已初始化
        window.imageUploadInitialized = false;
        
        // 初始化图片上传功能 - 提升到全局范围内
        function initImageUpload() {

            
            // 检查是否已经初始化过图片上传功能
            if (window.imageUploadInitialized) {

                return;
            }
            
            // 检查是否已经初始化过图片上传容器
            if (document.getElementById('imageUploadContainer')) {

                window.imageUploadInitialized = true;
                return;
            }
            
            // 获取图片表单组 - 通过查找包含图片标签的div
            const labels = document.querySelectorAll('label');
            let formGroup = null;
            for (let label of labels) {
                if (label.textContent.includes('图片')) {
                    formGroup = label.closest('div');
                    break;
                }
            }
            if (!formGroup) return;
            
            // 创建图片上传微缩框容器
            const container = document.createElement('div');
            container.id = 'imageUploadContainer';
            container.style.display = 'flex';
            container.style.gap = '10px';
            container.style.flexWrap = 'wrap';
            container.style.marginTop = '10px';
            
            // 创建初始添加图片微缩框
            const initialItem = document.createElement('div');
            initialItem.className = 'image-upload-item';
            initialItem.innerHTML = `
                <label for="imageUpload" style="display: block; width: 100px; height: 100px; border: 1px dashed #ddd; border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                    <span style="font-size: 24px; color: #999;">+</span>
                </label>
            `;
            
            container.appendChild(initialItem);
            
            // 插入到表单组中
            formGroup.appendChild(container);
            
            // 获取图片上传元素
            const imageUpload = document.getElementById('imageUpload');
            if (!imageUpload) {
                console.error('未找到imageUpload元素');
                return;
            }
            
            // 保存原有的图片上传事件监听器
            const originalChangeHandler = imageUpload.onchange;
            
            // 移除原有的事件监听器
            imageUpload.onchange = null;
            
            // 中文转英文的辅助函数 - 使用pinyin-pro库将中文转为拼音
            function convertChineseToEnglish(str) {
                if (!str) {
                    return 'image';
                }
                
                let result = str;
                
                try {
                    // 检查pinyin-pro库是否可用
                    // 修复：pinyin-pro库的正确调用方式是pinyinPro.pinyin()
                    if (typeof window.pinyinPro !== 'undefined' && typeof window.pinyinPro.pinyin === 'function') {
                        // 使用正确的调用方式：pinyinPro.pinyin()
                        result = window.pinyinPro.pinyin(result, {
                            tone: false,  // 不带声调
                            type: 'string',  // 返回字符串
                            separator: ''  // 空分隔符，生成连续的拼音
                        });
                        // 手动移除声调符号（库参数tone:false可能不生效）
                        result = result
                            .replace(/[āáǎà]/g, 'a')
                            .replace(/[ōóǒò]/g, 'o')
                            .replace(/[ēéěè]/g, 'e')
                            .replace(/[īíǐì]/g, 'i')
                            .replace(/[ūúǔù]/g, 'u')
                            .replace(/[ǖǘǚǜü]/g, 'v')
                            .replace(/[^a-zA-Z0-9_.-]/g, '_');
                    } else {
                        // 如果pinyinPro库不可用，使用简单的中文转拼音映射
                        const pinyinMap = {
                            '你': 'ni', '好': 'hao',
                            '图': 'tu', '片': 'pian',
                            '考': 'kao', '勤': 'qin',
                            '记': 'ji', '工': 'gong',
                            '一': 'yi', '二': 'er', '三': 'san',
                            '四': 'si', '五': 'wu',
                            '六': 'liu', '七': 'qi',
                            '八': 'ba', '九': 'jiu', '十': 'shi'
                        };
                        
                        // 替换中文汉字为拼音
                        let pinyinResult = '';
                        for (let char of result) {
                            if (pinyinMap[char]) {
                                pinyinResult += pinyinMap[char] + '_';
                            } else {
                                pinyinResult += char;
                            }
                        }
                        // 移除末尾的下划线
                        result = pinyinResult.replace(/_$/, '');
                    }
                } catch (error) {
                    console.error('中文转拼音失败:', error);
                }
                
                // 移除连续的下划线
                result = result.replace(/_+/g, '_');
                
                // 移除开头和结尾的下划线
                result = result.replace(/^_|_$/g, '');
                
                // 确保生成的文件名不为空
                if (!result || result.trim() === '') {
                    result = 'image';
                }
                
                return result;
            }
            
            // 新的图片上传事件处理
            imageUpload.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    // 获取原始文件名，将中文转为拼音
                    const originalName = file.name;
                    const nameWithoutExt = originalName.substring(0, originalName.lastIndexOf('.'));
                    const ext = originalName.substring(originalName.lastIndexOf('.'));
                    const pinyinName = convertChineseToEnglish(nameWithoutExt) + ext;
                    
                    // 创建一个新的File对象，使用拼音文件名
                    const fileWithPinyinName = new File([file], pinyinName, {
                        type: file.type,
                        lastModified: file.lastModified
                    });
                    
                    // 添加到全局图片数组
                    window.selectedImages.push(fileWithPinyinName);

                    
                    // 压缩图片
                    processImage(fileWithPinyinName).then(compressed => {
                        // 给压缩后的blob添加拼音文件名
                        const blobWithPinyinName = new File([compressed.blob], pinyinName, {
                            type: compressed.blob.type
                        });
                        
                        // 替换全局数组中的原始文件为压缩后的带拼音文件名的blob
                        window.selectedImages[window.selectedImages.length - 1] = blobWithPinyinName;

                        
                        // 创建图片预览微缩框
                        const previewItem = document.createElement('div');
                        previewItem.className = 'image-preview-item';
                        previewItem.style.position = 'relative';
                        previewItem.style.width = '100px';
                        previewItem.style.height = '100px';
                        previewItem.style.borderRadius = '4px';
                        previewItem.style.overflow = 'hidden';
                        previewItem.style.border = '1px solid #ddd';
                        
                        // 保存文件索引，用于删除
                        previewItem.dataset.fileIndex = window.selectedImages.length - 1;
                        
                        // 预览图片
                        const previewImg = document.createElement('img');
                        previewImg.src = compressed.dataURL;
                        previewImg.style.width = '100%';
                        previewImg.style.height = '100%';
                        previewImg.style.objectFit = 'cover';
                        previewImg.style.cursor = 'pointer';
                        
                        // 查看大图功能
                        previewImg.addEventListener('click', function() {
                            const modal = document.getElementById('imageModal');
                            modal.innerHTML = `
                                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2001;" 
                                     onclick="if(event.target === this) document.getElementById('imageModal').style.display='none'">
                                    <img id="draggableImage" src="${compressed.dataURL}" 
                                         style="max-width: 90%; max-height: 90%; position: absolute; cursor: move; top: 50%; left: 50%; transform: translate(-50%, -50%);"
                                         ondragstart="return false;">
                                    <button onclick="document.getElementById('imageModal').style.display='none'" 
                                            style="position: fixed; top: 20px; right: 20px; background: #f5222d; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer; z-index: 2002;">×</button>
                                </div>
                            `;
                            modal.style.display = 'block';
                            
                            // 图片拖动功能
                            const img = document.getElementById('draggableImage');
                            let isDragging = false;
                            let offsetX, offsetY;
                            let scale = 1; // 初始缩放比例

                            img.addEventListener('mousedown', function(e) {
                                isDragging = true;
                                offsetX = e.clientX - img.getBoundingClientRect().left;
                                offsetY = e.clientY - img.getBoundingClientRect().top;
                                img.style.cursor = 'grabbing';
                            });

                            document.addEventListener('mousemove', function(e) {
                                if (!isDragging) return;
                                img.style.left = (e.clientX - offsetX) + 'px';
                                img.style.top = (e.clientY - offsetY) + 'px';
                                img.style.transform = `scale(${scale})`;
                            });

                            document.addEventListener('mouseup', function() {
                                isDragging = false;
                                img.style.cursor = 'move';
                            });
                            
                            // 鼠标滚轮缩放功能
                            img.addEventListener('wheel', function(e) {
                                e.preventDefault(); // 阻止页面滚动
                                
                                // 获取当前缩放值
                                const delta = e.deltaY > 0 ? 0.9 : 1.1; // 向下滚动缩小，向上滚动放大
                                const oldScale = scale;
                                scale *= delta;
                                
                                // 限制缩放范围
                                scale = Math.min(Math.max(0.5, scale), 3); // 最小0.5倍，最大3倍
                                
                                // 计算缩放后的位置，保持图片中心点在窗口中心
                                const modalRect = img.parentElement.getBoundingClientRect();
                                const centerX = modalRect.width / 2;
                                const centerY = modalRect.height / 2;
                                
                                // 如果图片没有拖动过，则居中显示
                                if (!img.style.left && !img.style.top) {
                                    img.style.left = centerX + 'px';
                                    img.style.top = centerY + 'px';
                                }
                                
                                // 调整位置以保持中心点不变
                                const currentLeft = parseFloat(img.style.left) || centerX;
                                const currentTop = parseFloat(img.style.top) || centerY;
                                
                                img.style.left = currentLeft - (currentLeft - centerX) * (scale - oldScale) + 'px';
                                img.style.top = currentTop - (currentTop - centerY) * (scale - oldScale) + 'px';
                                
                                // 应用缩放，并设置变换原点为图片中心
                                img.style.transformOrigin = 'center';
                                img.style.transform = `scale(${scale})`;
                            });
                        });
                        
                        // 删除按钮
                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = '×';
                        deleteBtn.style.position = 'absolute';
                        deleteBtn.style.top = '5px';
                        deleteBtn.style.right = '5px';
                        deleteBtn.style.background = 'rgba(245, 34, 45, 0.9)';
                        deleteBtn.style.color = 'white';
                        deleteBtn.style.border = 'none';
                        deleteBtn.style.borderRadius = '50%';
                        deleteBtn.style.width = '24px';
                        deleteBtn.style.height = '24px';
                        deleteBtn.style.fontSize = '16px';
                        deleteBtn.style.cursor = 'pointer';
                        deleteBtn.style.display = 'flex';
                        deleteBtn.style.alignItems = 'center';
                        deleteBtn.style.justifyContent = 'center';
                        deleteBtn.style.padding = '0';
                        
                        // 删除图片功能
                        deleteBtn.addEventListener('click', function() {
                            // 获取文件索引
                            const fileIndex = parseInt(previewItem.dataset.fileIndex);

                            
                            // 从全局数组中移除
                            if (!isNaN(fileIndex) && fileIndex >= 0 && fileIndex < window.selectedImages.length) {
                                window.selectedImages.splice(fileIndex, 1);

                                
                                // 更新后续图片的索引
                                const previewItems = container.querySelectorAll('.image-preview-item');
                                previewItems.forEach((item, index) => {
                                    const itemIndex = parseInt(item.dataset.fileIndex);
                                    if (itemIndex > fileIndex) {
                                        item.dataset.fileIndex = itemIndex - 1;

                                    }
                                });
                            }
                            
                            // 移除预览元素
                            previewItem.remove();
                        });
                        
                        // 添加到预览微缩框
                        previewItem.appendChild(previewImg);
                        previewItem.appendChild(deleteBtn);
                        
                        // 插入到添加按钮之前
                        container.insertBefore(previewItem, initialItem);
                        
                        // 重置文件输入，以便可以再次选择同一文件
                        imageUpload.value = '';
                    }).catch(error => {
                        console.error('图片处理失败:', error);
                        // 移除失败的文件
                        window.selectedImages.pop();
                        console.log('图片处理失败，移除文件，当前数组长度:', window.selectedImages.length);
                    });
                }
            });
            
            // 标记图片上传功能已初始化
            window.imageUploadInitialized = true;

        }
        window.initImageUpload = initImageUpload;
        
        // 压缩图片函数 - 提升到全局范围内
        function processImage(file) {
            return new Promise((resolve, reject) => {
                new Compressor(file, {
                    quality: 0.7,
                    maxWidth: 1920,
                    maxHeight: 1080,
                    success(result) {
                        const reader = new FileReader();
                        reader.readAsDataURL(result);
                        reader.onload = function(e) {
                            resolve({
                                dataURL: e.target.result,
                                blob: result,
                                width: 0,
                                height: 0
                            });
                        };
                        reader.onerror = function() {
                            reject(new Error('文件读取失败'));
                        };
                    },
                    error(err) {
                        reject(err);
                    }
                });
            });
        }
        window.processImage = processImage;
        
        // 初始化全局图片数组
        window.selectedImages = [];
        
        // 清除图片函数（清除所有微缩框图片）
        window.clearImage = function() {
            // 清空全局图片数组
            window.selectedImages = [];
            
            const container = document.getElementById('imageUploadContainer');
            if (container) {
                // 保留添加按钮，删除所有预览图片
                const items = container.querySelectorAll('.image-preview-item');
                items.forEach(item => item.remove());
            }
            document.getElementById('imageUpload').value = '';
            document.getElementById('imageModal').style.display = 'none';
        }
        
        
        // 加载记录用于编辑
        async function loadRecordForEditing(record_id) {
            try {
                // 进入编辑模式，记录ID: ${record_id}
                
                // 设置编辑模式标记
                isEditMode = true;
                isFromEditMode = false; // 重置编辑模式展开标记
                
                // 调用bindEvents函数，确保编辑模式下也有正确的事件监听器
                bindEvents();
                
                // 调用bindDayWorkButtons函数，确保编辑模式下的小时选择器等功能正常
                if (typeof bindDayWorkButtons === 'function') {
                    bindDayWorkButtons();
                } else if (typeof window.bindDayWorkButtons === 'function') {
                    window.bindDayWorkButtons();
                }
                
                // 获取URL参数
                const urlParams = new URLSearchParams(window.location.search);
                const projectIdFromUrl = urlParams.get('projectId');
                const workDateFromUrl = urlParams.get('workDate');
                const employeeIdFromUrl = urlParams.get('employeeId');
                const workTypeFromUrl = urlParams.get('workType');
                
                // 确保workRecordService已初始化
                if (typeof window.workRecordService === 'undefined' || !window.workRecordService) {
                    throw new Error('workRecordService未定义，无法初始化');
                }
                
                // 获取记录
                let record = await window.workRecordService.getAttendanceRecord(record_id);
                
                // 如果本地存储中找不到记录，尝试从Supabase数据库获取
                if (!record && window.supabaseWorkService) {
                    try {
                        // 从Supabase获取记录
                        record = await window.supabaseWorkService.getWorkRecord(record_id);
                        // 如果从数据库获取到记录，保存到本地存储
                        if (record) {
                            await window.workRecordService.saveAttendanceRecord(record_id, record);
                        }
                    } catch (dbError) {
                        console.error('从数据库获取记录失败:', dbError);
                    }
                }
                
                if (!record) {
                    showNotification('未找到要编辑的记录', true);
                    loadNormalMode();
                    return;
                }
                
                // 记录已获取到用于编辑
                
                // 隐藏工作类型选择标签
                const workTypeSelection = document.querySelector('.work-type-selection');
                if (workTypeSelection) {
                    workTypeSelection.style.display = 'none';
                }
                
                // 在编辑模式下隐藏标签页导航（记工、▼、记工流水）
                const tabNavigation = document.querySelector('.work-type.tab-navigation');
                if (tabNavigation) {
                    tabNavigation.parentElement.style.display = 'none';
                }
                
                // 根据记录的工作类型自动选择并显示对应页面
                if (record && record.work_type) {
                    const workType = record.work_type;

                    
                    // 根据工作类型确定要激活的单选按钮
                    let workTypeValue = workType;
                    if (workType === '点工' || workType === 'day') {
                        workTypeValue = '点工';
                    } else if (workType === '包工' || workType === 'contract') {
                        workTypeValue = '包工';
                    } else if (workType === '工量' || workType === 'quantity') {
                        workTypeValue = '工量';
                    }
                    
                    // 设置工作类型单选按钮
                    const workTypeRadio = document.querySelector(`input[name="workType"][value="${workTypeValue}"]`);
                    if (workTypeRadio) {
                        workTypeRadio.checked = true;
                        
                        // 更新工作类型选择的选中样式
                        document.querySelectorAll('label[for^="workType"]').forEach(option => {
                            option.classList.remove('active');
                        });
                        workTypeRadio.nextElementSibling.classList.add('active');
                        
                        // 触发change事件以显示相应的选项
                        workTypeRadio.dispatchEvent(new Event('change'));
                        
                        // 确保对应的工作类型内容区域显示
                        setTimeout(() => {
                            if (workTypeValue === '点工') {
                                const dayWorkOptions = document.getElementById('dayWorkOptions');
                                if (dayWorkOptions) {
                                    dayWorkOptions.style.display = 'block';
                                    
                                    // 重新绑定点工按钮事件，确保编辑模式下按钮可用
                                    if (typeof bindDayWorkButtons === 'function') {
                                        bindDayWorkButtons();
                                    } else if (typeof window.bindDayWorkButtons === 'function') {
                                        window.bindDayWorkButtons();
                                    }
                                }
                            } else if (workTypeValue === '包工') {
                                const amountInputContainer = document.getElementById('amountInputContainer');
                                if (amountInputContainer) {
                                    amountInputContainer.style.display = 'flex';
                                }
                            } else if (workTypeValue === '工量') {
                                const workAmountInputContainer = document.getElementById('workAmountInputContainer');
                                if (workAmountInputContainer) {
                                    workAmountInputContainer.style.display = 'flex';
                                }
                            }
                        }, 100);
                        

                    }
                }
                
                // 在编辑模式下隐藏全选、反选按钮
                const selectAllBtn = document.getElementById('selectAllBtn');
                const selectInverseBtn = document.getElementById('selectInverseBtn');
                const employeeSelectionLabel = document.getElementById('employeeSelectionLabel');
                
                if (selectAllBtn) selectAllBtn.style.display = 'none';
                if (selectInverseBtn) selectInverseBtn.style.display = 'none';
                if (employeeSelectionLabel) employeeSelectionLabel.textContent = '员工：';
                
                // 在编辑模式下，将"员工："与员工列表水平排列
                const employeeSelectionDiv = document.querySelector('.form-group:has(#employeeSelectionLabel)');
                if (employeeSelectionDiv) {
                    // 将整个.form-group容器设置为flex布局
                    employeeSelectionDiv.style.display = 'flex';
                    employeeSelectionDiv.style.alignItems = 'center';
                    employeeSelectionDiv.style.flexWrap = 'nowrap';
                    
                    // 获取包含员工选择标签的div
                    const labelContainer = employeeSelectionDiv.querySelector('div:first-child');
                    if (labelContainer) {
                        labelContainer.style.display = 'inline-flex'; // 水平排列
                        labelContainer.style.alignItems = 'center'; // 垂直居中
                        labelContainer.style.marginBottom = '0'; // 移除底部外边距
                    }
                    
                    // 获取员工选择容器
                    const employeeSelectionContainer = employeeSelectionDiv.querySelector('.employee-selection');
                    if (employeeSelectionContainer) {
                        employeeSelectionContainer.style.display = 'flex'; // 水平排列
                        employeeSelectionContainer.style.alignItems = 'center'; // 垂直居中
                        employeeSelectionContainer.style.marginLeft = '15px'; // 添加左侧间距
                        employeeSelectionContainer.style.height = 'auto'; // 允许根据内容自动调整高度
                        employeeSelectionContainer.style.flexGrow = '1'; // 根据可用空间自动增长
                        employeeSelectionContainer.style.width = 'auto'; // 根据页面宽度自动调整
                        employeeSelectionContainer.style.maxWidth = '100%'; // 最大宽度为父容器宽度
                    }
                    
                    // 获取员工列表
                    const employeeList = document.getElementById('employeeList');
                    if (employeeList) {
                        // 恢复默认的网格布局，与新建模式一致
                        employeeList.style.display = 'grid';
                        employeeList.style.gridTemplateColumns = 'repeat(auto-fill, minmax(60px, auto))';
                        employeeList.style.alignItems = 'center';
                        employeeList.style.width = '100%';
                        employeeList.style.flexWrap = 'wrap';
                        employeeList.style.gap = '3px';
                        employeeList.style.maxHeight = 'none';
                        employeeList.style.overflowY = 'auto';
                        employeeList.style.padding = '5px 10px';
                    }
                }
                
                // 填充表单数据
                // 使用URL参数或记录中的project_id
                const projectId = projectIdFromUrl || record.project_id || record.projectId || '';
                // 辅助函数：通过project_id从本地存储获取project_name
                function getProjectNameById(projectId) {
                    try {
                        // 获取当前登录用户信息
                        let currentUser = {};
                        let userId = 'default';
                        const currentUserStr = localStorage.getItem('currentUser');
                        if (currentUserStr) {
                            currentUser = JSON.parse(currentUserStr);
                            userId = currentUser.user_id || 'default';
                        }
                        
                        // 从本地存储获取项目数据
                        const projectsData = localStorage.getItem('project_cache_' + userId);
                        if (projectsData) {
                            const projects = JSON.parse(projectsData);
                            const project = projects.find(p => p.project_id === projectId);
                            return project ? project.project_name : projectId;
                        }
                        return projectId;
                    } catch (error) {
                        console.error('通过project_id获取项目名称失败:', error);
                        return projectId;
                    }
                }
                
                // 设置项目名称
                document.getElementById('projectName').value = getProjectNameById(projectId);
                
                // 设置记工日期，优先使用URL参数
                const workDate = workDateFromUrl || record.record_date || record.date || '';
                document.getElementById('workDate').value = workDate;
                updateDateDisplay();
                
                // 加载员工数据
                await loadEmployeeData(document.getElementById('projectName').value);
                
                // 设置选中的员工，优先使用URL参数中的employeeId
                if (employeeIdFromUrl) {
                    selectedEmployeeIds.add(employeeIdFromUrl);
                } else if (record.employee_id) {
                    selectedEmployeeIds.add(record.employee_id);
                } else if (record.employees && Array.isArray(record.employees)) {
                    record.employees.forEach(emp => {
                        selectedEmployeeIds.add(emp.empid || emp.employee_id);
                    });
                }
                
                // 确保workRecordService正确引用selectedEmployeeIds
                if (window.workRecordService) {
                    window.workRecordService.setGlobalReferences({
                        selectedEmployeeIds: selectedEmployeeIds,
                        employees: employees,
                        activeEmployees: activeEmployees,
                        inactiveEmployees: inactiveEmployees
                    });
                }
                
                // 更新员工列表显示
                displayActiveEmployees();
                
                // 获取工作类型，用于后续处理
                const workType = workTypeFromUrl || record.work_type || record.type;
                let workTypeValue = workType;
                if (workType === '点工' || workType === 'day') {
                    workTypeValue = '点工';
                } else if (workType === '包工' || workType === 'contract') {
                    workTypeValue = '包工';
                } else if (workType === '工量' || workType === 'quantity') {
                    workTypeValue = '工量';
                }
                
                // 更新标题为"修改点工"/"修改包工"/"修改工量"
                if (window.parent && window.parent !== window) {
                    const targetOrigin = window.location.origin || '*';
                    let titleText = '';
                    if (workTypeValue === '点工') {
                        titleText = '修改点工';
                    } else if (workTypeValue === '包工') {
                        titleText = '修改包工';
                    } else if (workTypeValue === '工量') {
                        titleText = '修改工量';
                    }
                    window.parent.postMessage({
                        type: 'updateTitle',
                        page: titleText
                    }, targetOrigin);
                }
                
                // 根据工作类型填充相应字段
                if (workTypeValue === '点工') {
                    // 处理点工相关字段
                    handleDayWorkFieldsForEditing(record);
                } else if (workTypeValue === '包工') {
                    // 处理包工相关字段
                    handleContractWorkFieldsForEditing(record);
                } else if (workTypeValue === '工量') {
                    // 处理工量相关字段
                    handleWorkQuantityFieldsForEditing(record);
                }

                // 处理备注和图片信息
                if (typeof handleRemarkAndImagesForEditing === 'function') {
                    handleRemarkAndImagesForEditing(record);
                }

                
                // 确保所有数据加载完成后，再次检查并显示对应工作类型的内容区域
                setTimeout(() => {

                    const workType = workTypeFromUrl || record.work_type || record.type;
                    let workTypeValue = workType;
                    if (workType === '点工' || workType === 'day') {
                        workTypeValue = '点工';
                    } else if (workType === '包工' || workType === 'contract') {
                        workTypeValue = '包工';
                    } else if (workType === '工量' || workType === 'quantity') {
                        workTypeValue = '工量';
                    }
                    
                    // 检查并显示对应工作类型的内容区域
                    const dayWorkOptions = document.getElementById('dayWorkOptions');
                    const amountInputContainer = document.getElementById('amountInputContainer');
                    const workAmountInputContainer = document.getElementById('workAmountInputContainer');
                    




                    
                    // 隐藏所有工作类型的内容区域
                    if (dayWorkOptions) dayWorkOptions.style.display = 'none';
                    if (amountInputContainer) amountInputContainer.style.display = 'none';
                    if (workAmountInputContainer) workAmountInputContainer.style.display = 'none';
                    
                    // 显示对应工作类型的内容区域
                    if (workTypeValue === '点工') {
                        if (dayWorkOptions) {
                            dayWorkOptions.style.display = 'block';

                            
                            // 重新绑定点工按钮事件，确保编辑模式下按钮可用
                            if (typeof bindDayWorkButtons === 'function') {
                                bindDayWorkButtons();
                            } else if (typeof window.bindDayWorkButtons === 'function') {
                                window.bindDayWorkButtons();
                            }
                        }
                    } else if (workTypeValue === '包工') {
                        // 确保包工界面已创建
                        if (!amountInputContainer) {
                            // 创建包工界面
                            amountInputContainer = document.createElement('div');
                            amountInputContainer.id = 'amountInputContainer';
                            amountInputContainer.style.cssText = 'display: flex; align-items: center; gap: 8px; margin-top: 10px;';
                            amountInputContainer.innerHTML = `
                                <label style="color: black; font-weight: bold; margin: 0;">金额：</label>
                                <input type="number" id="amountInput" placeholder="*请输入金额" 
                                       style="width: 150px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;" 
                                       onfocus="this.setAttribute('placeholder', ''); this.style.fontWeight = 'bold';" 
                                       onblur="this.setAttribute('placeholder', '*请输入金额'); this.style.fontWeight = (this.value ? 'bold' : 'normal');">
                                <span style="font-size: 16px; color: #666; white-space: nowrap;">元</span>
                                <style>
                                    #amountInput::placeholder {
                                        color: red;
                                        opacity: 1;
                                    }
                                </style>
                            `;
                            
                            const overtimeContainer = document.getElementById('overtimeContainer');
                            overtimeContainer.appendChild(amountInputContainer);
                        } else {
                            amountInputContainer.style.display = 'flex';
                        }
                        console.log('已显示包工页面');
                    } else if (workTypeValue === '工量') {
                        // 确保工量界面已创建
                        if (!workAmountInputContainer) {
                            // 创建工量界面
                            workAmountInputContainer = document.createElement('div');
                            workAmountInputContainer.id = 'workAmountInputContainer';
                            workAmountInputContainer.style.cssText = 'margin-top: 10px; display: flex; flex-direction: column; gap: 12px;';
                            workAmountInputContainer.innerHTML = `
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: red; font-weight: bold;">*</span>
                                    <label style="color: black; font-weight: bold; margin: 0;">分项：</label>
                                    <div id="subProjectSelector" style="display: flex; align-items: center; gap: 10px;">
                                        <div id="currentSubProject" style="width: 250px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; cursor: pointer; background-color: white; color: #999;">
                                            请选择分项
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 分项选择模态框 -->
                                <div id="subProjectModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.3); z-index: 1000; align-items: flex-start; justify-content: flex-end;">
                                    <div style="background-color: white; width: 320px; height: 100%; overflow-y: auto; box-shadow: -2px 0 10px rgba(0,0,0,0.1);">
                                        <div style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                            <button id="addSubProjectBtn" style="background-color: #1890ff; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-size: 14px; cursor: pointer;">
                                                添加分项
                                            </button>
                                            <button id="closeSubProjectModal" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #666;">×</button>
                                        </div>
                                        <div style="padding: 15px;">
                                            <div id="subProjectList" style="display: flex; flex-direction: column; gap: 10px;">
                                                <!-- 分项列表初始为空，用户通过添加分项功能添加 -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: red; font-weight: bold;">*</span>
                                    <label style="color: black; font-weight: bold; margin: 0;">工量：</label>
                                    <input type="number" id="workAmountInput" placeholder="请输入工程量" 
                                           style="width: 250px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;">
                                    <span id="workAmountUnit" style="font-size: 16px; color: #666; white-space: nowrap;"></span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: red; font-weight: bold;">*</span>
                                    <label style="color: black; font-weight: bold; margin: 0;">单价：</label>
                                    <input type="number" id="unitPriceInput" placeholder="请输入单价" step="0.01" 
                                           style="width: 250px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;">
                                    <span id="unitPriceUnit" style="font-size: 16px; color: #666; white-space: nowrap;">元</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: red; font-weight: bold;">*</span>
                                    <label style="color: black; font-weight: bold; margin: 0;">工钱：</label>
                                    <input type="number" id="totalPriceInput" placeholder="可输入谈好的价钱" 
                                           style="width: 250px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;">
                                    <span style="font-size: 16px; color: #666; white-space: nowrap;">元</span>
                                </div>
                            `;
                            
                            const overtimeContainer = document.getElementById('overtimeContainer');
                            overtimeContainer.appendChild(workAmountInputContainer);
                            
                            // 添加自动计算功能
                            const workAmountInput = document.getElementById('workAmountInput');
                            const unitPriceInput = document.getElementById('unitPriceInput');
                            const totalPriceInput = document.getElementById('totalPriceInput');
                            
                            function calculateTotal() {
                                const workAmount = parseFloat(workAmountInput.value) || 0;
                                const unitPrice = parseFloat(unitPriceInput.value) || 0;
                                
                                if (workAmount > 0 && unitPrice > 0) {
                                    const total = Math.floor(workAmount * unitPrice);
                                    totalPriceInput.value = total;
                                } else if (workAmount === 0 || unitPrice === 0) {
                                    totalPriceInput.value = '';
                                }
                            }
                            
                            workAmountInput.addEventListener('input', calculateTotal);
                            unitPriceInput.addEventListener('input', calculateTotal);
                            
                            // 为分项选择器添加点击事件
                            setTimeout(function() {
                                const subProjectSelector = document.getElementById('subProjectSelector');
                                if (subProjectSelector) {
                                    subProjectSelector.onclick = function() {
                                        // 加载本地分项数据
                                        loadSubProjectsFromLocal();
                                        
                                        const subProjectModal = document.getElementById('subProjectModal');
                                        if (subProjectModal) {
                                            subProjectModal.style.display = 'flex';
                                        }
                                    };
                                }
                                
                                // 为分项选择模态框中的添加分项按钮绑定事件
                                const addSubProjectBtnInModal = document.getElementById('addSubProjectBtn');
                                if (addSubProjectBtnInModal) {
                                    addSubProjectBtnInModal.onclick = function() {
                                        const addSubProjectModal = document.getElementById('addSubProjectModal');
                                        if (addSubProjectModal) {
                                            addSubProjectModal.style.display = 'flex';
                                        }
                                    };
                                }
                                
                                // 为关闭按钮添加点击事件
                                const closeSubProjectModal = document.getElementById('closeSubProjectModal');
                                if (closeSubProjectModal) {
                                    closeSubProjectModal.onclick = function() {
                                        const subProjectModal = document.getElementById('subProjectModal');
                                        if (subProjectModal) {
                                            subProjectModal.style.display = 'none';
                                        }
                                    };
                                }
                                
                                // 点击模态框外部关闭模态框
                                const subProjectModal = document.getElementById('subProjectModal');
                                if (subProjectModal) {
                                    subProjectModal.onclick = function(e) {
                                        if (e.target === subProjectModal) {
                                            subProjectModal.style.display = 'none';
                                        }
                                    };
                                }
                            }, 100);
                        } else {
                            workAmountInputContainer.style.display = 'flex';
                        }

                    }
                }, 500);
                
                // 更新按钮文本为"保存修改"
                const confirmButton = document.getElementById('confirmBtn');
                if (confirmButton) {
                    confirmButton.textContent = '保存修改';
                    confirmButton.onclick = () => window.workRecordService.confirmUpdateWorkRecord(record_id);
                    // 美化保存修改按钮样式
                    confirmButton.style.padding = '8px 16px';
                    confirmButton.style.background = 'linear-gradient(135deg, #52c41a 0%, #389e0d 100%)';
                    confirmButton.style.color = 'white';
                    confirmButton.style.border = 'none';
                    confirmButton.style.borderRadius = '8px';
                    confirmButton.style.cursor = 'pointer';
                    confirmButton.style.fontSize = '16px';
                    confirmButton.style.fontWeight = 'bold';
                    confirmButton.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                    confirmButton.style.boxShadow = '0 2px 8px rgba(82, 196, 26, 0.3)';
                    confirmButton.style.marginRight = '40px';
                }
                
                // 添加删除记工按钮
                const bottomButtonsContainer = document.querySelector('.bottom-buttons');
                if (bottomButtonsContainer) {
                    // 检查是否已存在删除按钮
                    let deleteButton = bottomButtonsContainer.querySelector('#deleteBtn');
                    if (!deleteButton) {
                        deleteButton = document.createElement('button');
                        deleteButton.id = 'deleteBtn';
                        deleteButton.textContent = '删除记工';
                        deleteButton.style.padding = '8px 16px';
                        deleteButton.style.background = 'linear-gradient(135deg, #ff4d4f 0%, #cf1322 100%)';
                        deleteButton.style.color = 'white';
                        deleteButton.style.border = 'none';
                        deleteButton.style.borderRadius = '8px';
                        deleteButton.style.cursor = 'pointer';
                        deleteButton.style.fontSize = '16px';
                        deleteButton.style.fontWeight = 'bold';
                        deleteButton.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                        deleteButton.style.boxShadow = '0 2px 8px rgba(255, 77, 79, 0.3)';
                        deleteButton.style.marginLeft = '0';
                        deleteButton.onclick = () => window.workRecordService.confirmDeleteWorkRecord(record_id);
                        
                        // 将删除按钮添加到保存修改按钮的旁边
                        bottomButtonsContainer.appendChild(deleteButton);
                    }
                }
                
                // 初始化图片上传功能（仅在未初始化时调用）
                if (!window.imageUploadInitialized) {
                    initImageUpload();
                }
                

            } catch (error) {
                console.error('加载记录用于编辑时出错:', error);
                showNotification('加载记录失败: ' + error.message, true);
                loadNormalMode();
            }
        }

        // 显示加班模态框
        function showOvertimeModal() {
            const overtimeModal = document.getElementById('overtimeModal');
            if (overtimeModal) {
                overtimeModal.style.display = 'flex';
                console.log('加班模态框已显示'); // 添加调试日志
            } else {
                console.error('找不到加班模态框元素');
            }
        }
        // 使函数全局可访问
        window.showOvertimeModal = showOvertimeModal;

        // 显示上下午模态框
        function showMorningAfternoonModal() {
            console.log('显示上下午模态框'); // 添加调试日志
            // 重置数据
            window.morningAfternoonData = {
                morning: { type: 'rest', value: '' },
                afternoon: { type: 'rest', value: '' }
            };
            
            // 重置UI
            const morningBtn = document.getElementById('morningBtn');
            const afternoonBtn = document.getElementById('afternoonBtn');
            if (morningBtn) {
                morningBtn.style.backgroundColor = '#f5f5f5';
                morningBtn.style.color = '#333';
            }
            if (afternoonBtn) {
                afternoonBtn.style.backgroundColor = '#f5f5f5';
                afternoonBtn.style.color = '#333';
            }
            
            // 显示模态框
            const modal = document.getElementById('morningAfternoonModal');
            if (modal) {
                modal.style.display = 'flex';
            } else {
                console.error('找不到上下午模态框元素');
            }
        }
        // 使函数全局可访问
        window.showMorningAfternoonModal = showMorningAfternoonModal;

        // 隐藏加班模态框
        function hideOvertimeModal() {
            console.log('隐藏加班模态框'); // 添加调试日志
            // 关闭加班模态框
            const modal = document.getElementById('overtimeModal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('show');
            }
            
            // 关闭模态框时重置按钮显示值
            // 重置选小时按钮为"选小时"
            const hoursInput = document.querySelector('#overtimeHours .modal-hours-input');
            if (hoursInput) {
                hoursInput.value = '选小时';
            }
            
            // 重置输入工按钮为"输入工"
            const workText = document.querySelector('#overtimeWork .work-btn-text');
            if (workText) {
                workText.textContent = '输入工';
            }
            
            // 重置所有按钮的样式
            document.querySelectorAll('.overtime-option').forEach(opt => {
                opt.style.backgroundColor = '#f5f5f5';
                opt.style.color = '#333';
                opt.style.border = '1px solid #ddd';
            });
            
            // 隐藏所有下拉框
            document.querySelectorAll('#overtimeHours .hours-dropdown').forEach(dropdown => {
                dropdown.style.display = 'none';
            });
        }
        
        // 使函数全局可访问
        window.hideOvertimeModal = hideOvertimeModal;

        // 处理点工字段用于编辑




        // 处理工量字段用于编辑 - 与新建模式行为一致


        // 加载正常模式
        function loadNormalMode() {
            // 进入新建模式：
            // 设置新建模式标记
            isEditMode = false;
            isFromEditMode = false; // 重置编辑模式展开标记
            
            // 恢复工作类型选择标签的显示
            const workTypeSelection = document.querySelector('.work-type-selection');
            if (workTypeSelection) {
                workTypeSelection.style.display = 'flex';
            }
            
            // 恢复标签页导航的显示
            const tabNavigation = document.querySelector('.work-type.tab-navigation');
            if (tabNavigation && tabNavigation.parentElement) {
                tabNavigation.parentElement.style.display = 'block';
            }
            
            // 辅助函数：通过project_id从本地存储获取project_name
            function getProjectById(projectId) {
                try {
                    // 获取当前登录用户信息
                    let currentUser = {};
                    let userId = 'default';
                    const currentUserStr = localStorage.getItem('currentUser');
                    if (currentUserStr) {
                        currentUser = JSON.parse(currentUserStr);
                        userId = currentUser.user_id || 'default';
                    }
                    
                    // 从本地存储获取项目数据
                    const projectsData = localStorage.getItem('project_cache_' + userId);
                    if (projectsData) {
                        const projects = JSON.parse(projectsData);
                        return projects.find(p => p.project_id === projectId) || null;
                    }
                    return null;
                } catch (error) {
                    console.error('通过project_id获取项目数据失败:', error);
                    return null;
                }
            }

            // 检查URL参数中是否有项目ID和日期
            const urlParams = new URLSearchParams(window.location.search);
            const projectIdFromUrl = urlParams.get('project_id');
            const dateFromUrl = urlParams.get('date');
            const employeeIdFromUrl = urlParams.get('employee_id');
            const workTypeFromUrl = urlParams.get('work_type');
            
            // 检查是否从记工表进入（有employee_id参数且不是编辑模式）
            if (employeeIdFromUrl && !isEditMode) {
                isFromTimesheet = true;
                timesheetEmployeeId = employeeIdFromUrl;
            }
            
            let projectName = null;
            if (projectIdFromUrl) {
                // 从URL获取到project_id，查询对应的项目数据
                const project = getProjectById(projectIdFromUrl);
                
                if (project) {
                    projectName = project.project_name;
                    // 直接设置项目名称到输入框
                    document.getElementById('projectName').value = projectName;
                    
                    // 保存项目名称、ID和工时配置到localStorage
                    localStorage.setItem('currentProjectName', projectName);
                    localStorage.setItem('currentProjectId', projectIdFromUrl);
                    localStorage.setItem('currentProjectRegularHours', project.regular_hours || 8);
                    localStorage.setItem('currentProjectOvertimeHours', project.overtime_hours || 7);
                    
                    // 加载员工数据
                    loadEmployeeData(projectName);
                } else {
                    // 未找到对应的项目名称，显示提示信息
                    showNotification('未找到对应的项目信息', true);
                }
            } else {
                // 未从 URL 参数获取到项目名称，尝试从localStorage获取...
                // 从localStorage获取项目名称和ID
                const projectNameFromStorage = localStorage.getItem('currentProjectName');
                const projectIdFromStorage = localStorage.getItem('currentProjectId');
                if (projectNameFromStorage) {
                    // 从localStorage获取到项目名称: ${projectNameFromStorage}
                    // 设置项目名称到输入框
                    document.getElementById('projectName').value = projectNameFromStorage;
                    
                    // 如果localStorage中没有项目工时配置，尝试从project_cache中获取
                    if (projectIdFromStorage && !localStorage.getItem('currentProjectRegularHours')) {
                        const project = getProjectById(projectIdFromStorage);
                        if (project) {
                            localStorage.setItem('currentProjectRegularHours', project.regular_hours || 8);
                            localStorage.setItem('currentProjectOvertimeHours', project.overtime_hours || 7);
                        }
                    }
                    
                    // 加载员工数据
                    loadEmployeeData(projectNameFromStorage);
                } else {
                    // 未找到项目名称，显示提示信息
                    showNotification('请先选择项目名称', true);
                }
            }

            // 如果有日期参数，设置到日期输入框
            if (dateFromUrl) {
                // 从 URL 参数获取到日期: ${dateFromUrl}
                document.getElementById('workDate').value = dateFromUrl;
                updateDateDisplay();
                
                // 如果是从记工表进入，禁用日期选择框
                if (isFromTimesheet) {
                    const workDateInput = document.getElementById('workDate');
                    const dateDisplay = document.getElementById('dateDisplay');
                    const container = document.querySelector('.date-input-container');
                    
                    if (workDateInput) {
                        workDateInput.disabled = true;
                        workDateInput.style.cursor = 'not-allowed';
                    }
                    if (dateDisplay) {
                        dateDisplay.style.cursor = 'not-allowed';
                    }
                    if (container) {
                        container.style.cursor = 'not-allowed';
                    }
                }
            } else {
                // 如果没有日期参数，设置为今天
                setTodayDate();
            }

            // 如果是从记工表进入，根据work_type参数自动切换工作类型
            if (isFromTimesheet && workTypeFromUrl) {
                setTimeout(() => {
                    let targetRadioId = '';
                    if (workTypeFromUrl === '点工') {
                        targetRadioId = 'workType1';
                    } else if (workTypeFromUrl === '包工') {
                        targetRadioId = 'workType2';
                    } else if (workTypeFromUrl === '工量') {
                        targetRadioId = 'workType3';
                    }
                    
                    if (targetRadioId) {
                        const targetRadio = document.getElementById(targetRadioId);
                        if (targetRadio) {
                            targetRadio.checked = true;
                            // 触发change事件，更新样式和显示
                            const event = new Event('change');
                            targetRadio.dispatchEvent(event);
                        }
                        
                        // 根据工作类型禁用相应的标签
                        // 点工：禁用包工和工量
                        // 包工/工量：只禁用点工
                        if (workTypeFromUrl === '点工') {
                            // 禁用包工和工量
                            ['workType2', 'workType3'].forEach(id => {
                                const radio = document.getElementById(id);
                                if (radio) {
                                    radio.disabled = true;
                                    const label = radio.nextElementSibling;
                                    if (label) {
                                        label.style.cursor = 'not-allowed';
                                        label.style.opacity = '0.5';
                                    }
                                }
                            });
                        } else {
                            // 包工或工量，只禁用点工
                            const radio = document.getElementById('workType1');
                            if (radio) {
                                radio.disabled = true;
                                const label = radio.nextElementSibling;
                                if (label) {
                                    label.style.cursor = 'not-allowed';
                                    label.style.opacity = '0.5';
                                }
                            }
                        }
                    }
                }, 200);
            }

            // 绑定事件
            bindEvents();
            
            // 绑定点工按钮事件，确保1个工、半个工、休息按钮在新建模式下也能正常工作
            if (typeof bindDayWorkButtons === 'function') {
                bindDayWorkButtons();
            } else if (typeof window.bindDayWorkButtons === 'function') {
                window.bindDayWorkButtons();
            }
            
            // 在新建模式下显示全选、反选按钮
            const selectAllBtn = document.getElementById('selectAllBtn');
            const selectInverseBtn = document.getElementById('selectInverseBtn');
            const employeeSelectionLabel = document.getElementById('employeeSelectionLabel');
            
            // 如果是从记工表进入，隐藏全选和反选按钮，隐藏“员工：”标签
            if (isFromTimesheet) {
                if (selectAllBtn) selectAllBtn.style.display = 'none';
                if (selectInverseBtn) selectInverseBtn.style.display = 'none';
                if (employeeSelectionLabel) employeeSelectionLabel.style.display = 'none';
            } else {
                if (selectAllBtn) selectAllBtn.style.display = 'inline-block';
                if (selectInverseBtn) selectInverseBtn.style.display = 'inline-block';
                if (employeeSelectionLabel) {
                    employeeSelectionLabel.style.display = 'inline-block';
                    employeeSelectionLabel.textContent = '选择员工：';
                }
            }
            
            // 恢复员工选择区域的原始布局
            const employeeSelectionDiv = document.querySelector('.form-group:has(#employeeSelectionLabel)');
            if (employeeSelectionDiv) {
                // 恢复.form-group容器的原始样式，移除编辑模式下的flex布局
                employeeSelectionDiv.style.display = '';
                employeeSelectionDiv.style.alignItems = '';
                employeeSelectionDiv.style.flexWrap = '';
            }
            
            // 重置已记工事件监听器，确保已记员工不可选中
            if (typeof workRecordMarker !== 'undefined') {
                workRecordMarker.resetEventListeners();
            }
            
            // 检查已记工员工，恢复已记标记
            if (typeof window.checkMarkedEmployees === 'function') {
                window.checkMarkedEmployees();
            }
        }
        
        // 将loadNormalMode函数暴露到全局，以便在其他脚本中调用
        window.loadNormalMode = loadNormalMode;

        // 重置全选状态函数
        function resetSelectAllState() {
            isAllSelected = false;
            const selectAllBtn = document.getElementById('selectAllBtn');
            if (selectAllBtn) {
                selectAllBtn.textContent = '全选';
            }
        }

        // 获取可见员工复选框函数
        function getVisibleEmployeeCheckboxes() {
            const listContainer = document.getElementById('employeeList');
            if (!listContainer) return [];
            
            // 获取员工列表容器中的所有员工项
            const employeeItems = listContainer.querySelectorAll('.employee-item');
            
            // 筛选出可见的员工项并获取其复选框
            const visibleCheckboxes = [];
            
            employeeItems.forEach(item => {
                // 检查元素是否可见
                const isVisible = item.offsetParent !== null && 
                                 getComputedStyle(item).display !== 'none' && 
                                 getComputedStyle(item).visibility !== 'hidden';
                
                if (isVisible) {
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    if (checkbox) {
                        visibleCheckboxes.push(checkbox);
                    }
                }
            });
            
            return visibleCheckboxes;
        }

        // 更新全选按钮状态（基于可见项）
        function updateSelectAllButtonState() {
            const selectAllBtn = document.getElementById('selectAllBtn');
            const visibleCheckboxes = getVisibleEmployeeCheckboxes();
            const checkedVisibleBoxes = visibleCheckboxes.filter(cb => cb.checked);
            
            // 检查是否全部可见项都已选中
            const allVisibleSelected = visibleCheckboxes.length > 0 && checkedVisibleBoxes.length === visibleCheckboxes.length;
            
            if (allVisibleSelected && !isAllSelected) {
                isAllSelected = true;
                selectAllBtn.textContent = '取消全选';
            } else if (!allVisibleSelected && isAllSelected) {
                isAllSelected = false;
                selectAllBtn.textContent = '全选';
            }
        }

        // 全选/取消全选功能（基于可见项）
        function toggleSelectAllEmployees() {
            const selectAllBtn = document.getElementById('selectAllBtn');
            // 使用修复的可见性检查函数
            const visibleCheckboxes = getVisibleEmployeeCheckboxes();
            
            if (visibleCheckboxes.length === 0) {
                return;
            }
            
            // 检查当前是否全部可见项都已选中（仅考虑非已记工员工）
            const allVisibleSelected = visibleCheckboxes.every(cb => {
                const employeeItem = cb.closest('.employee-item');
                const isMarked = employeeItem && (employeeItem.classList.contains('recorded') || employeeItem.querySelector('.recorded-label'));
                return isMarked || cb.checked;
            });
            
            // 切换全选状态
            isAllSelected = !allVisibleSelected;
            
            // 更新按钮文本
            selectAllBtn.textContent = isAllSelected ? '取消全选' : '全选';
            
            // 仅操作可见的复选框，跳过已记工的员工
            visibleCheckboxes.forEach(checkbox => {
                try {
                    const employeeItem = checkbox.closest('.employee-item');
                    const isMarked = employeeItem && (employeeItem.classList.contains('recorded') || employeeItem.querySelector('.recorded-label'));
                    
                    // 跳过已记工的员工
                    if (!isMarked) {
                        checkbox.checked = isAllSelected;
                        if (employeeItem) {
                            if (checkbox.checked) {
                                selectedEmployeeIds.add(checkbox.value);
                                employeeItem.classList.add('selected');
                            } else {
                                selectedEmployeeIds.delete(checkbox.value);
                                employeeItem.classList.remove('selected');
                            }
                        }
                    }
                } catch (error) {
                    console.error('处理复选框时出错:', error);
                }
            });
        }

        // 绑定事件
        function bindEvents() {
            // 绑定全选按钮事件
            document.getElementById('selectAllBtn').addEventListener('click', toggleSelectAllEmployees);
            
            // 记工类型切换 - 统一新建模式和编辑模式的行为
            document.querySelectorAll('input[name="workType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    // 如果是从记工表进入，根据work_type参数限制切换
                    if (isFromTimesheet) {
                        const workTypeFromUrl = new URLSearchParams(window.location.search).get('work_type');
                        
                        // 点工：不能切换到包工或工量
                        if (workTypeFromUrl === '点工' && this.id !== 'workType1') {
                            const targetRadio = document.getElementById('workType1');
                            if (targetRadio) {
                                targetRadio.checked = true;
                                return;
                            }
                        }
                        
                        // 包工或工量：不能切换到点工
                        if ((workTypeFromUrl === '包工' || workTypeFromUrl === '工量') && this.id === 'workType1') {
                            let targetRadioId = workTypeFromUrl === '包工' ? 'workType2' : 'workType3';
                            const targetRadio = document.getElementById(targetRadioId);
                            if (targetRadio) {
                                targetRadio.checked = true;
                                return;
                            }
                        }
                    }
                    
                    // 更新工作类型选择的选中样式（只处理工作类型选择区域，不影响标签页导航）
                    document.querySelectorAll('label[for^="workType"]').forEach(option => {
                        option.classList.remove('active');
                    });
                    this.nextElementSibling.classList.add('active');

                    // 重置表单，但不重置工作类型
                    resetForm(false);

                    // 显示/隐藏点工选项
                    if (this.value === '点工') {
                        document.getElementById('dayWorkOptions').style.display = 'block';
                        
                        // 重新绑定点工按钮事件，确保重置表单后按钮仍然可用
                        if (typeof bindDayWorkButtons === 'function') {
                            bindDayWorkButtons();
                        } else if (typeof window.bindDayWorkButtons === 'function') {
                            window.bindDayWorkButtons();
                        }
                    } else {
                        document.getElementById('dayWorkOptions').style.display = 'none';
                    }

                    if (this.value === '包工') {
                        const overtimeLabel = document.querySelector('#overtimeContainer label');
                        if (overtimeLabel) {
                            overtimeLabel.innerHTML = ''; // 清空标签内容
                        }
                        
                        const overtimeBtn = document.getElementById('overtimeBtn');
                        if (overtimeBtn) {
                            overtimeBtn.style.display = 'none';
                        }

                        // 隐藏模态框相关元素
                        const overtimeModal = document.getElementById('overtimeModal');
                        if (overtimeModal) {
                            overtimeModal.style.display = 'none';
                        }

                        // 隐藏工量输入框（如果存在）
                        const workAmountInputContainer = document.getElementById('workAmountInputContainer');
                        if (workAmountInputContainer) {
                            workAmountInputContainer.style.display = 'none';
                        }

                        // 创建并显示金额输入框，放在*金额：后面一排显示
                        let amountInputContainer = document.getElementById('amountInputContainer');
                        if (!amountInputContainer) {
                            amountInputContainer = document.createElement('div');
                            amountInputContainer.id = 'amountInputContainer';
                            amountInputContainer.style.cssText = 'display: flex; align-items: center; gap: 8px; margin-top: 10px;';
                            amountInputContainer.innerHTML = `
                                <label style="color: black; font-weight: bold; margin: 0;">金额：</label>
                                <input type="number" id="amountInput" placeholder="*请输入金额" 
                                       style="width: 150px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;" 
                                       onfocus="this.setAttribute('placeholder', ''); this.style.fontWeight = 'bold';" 
                                       onblur="this.setAttribute('placeholder', '*请输入金额'); this.style.fontWeight = (this.value ? 'bold' : 'normal');">
                                <span style="font-size: 16px; color: #666; white-space: nowrap;">元</span>
                                <style>
                                    #amountInput::placeholder {
                                        color: red;
                                        opacity: 1;
                                    }
                                </style>
                            `;
                            
                            const overtimeContainer = document.getElementById('overtimeContainer');
                            overtimeContainer.appendChild(amountInputContainer);
                        } else {
                            amountInputContainer.style.display = 'flex';
                        }

                    } else if (this.value === '工量') {
                        // 切换到工量时，更新为完整的工量表单
                        const overtimeLabel = document.querySelector('#overtimeContainer label');
                        if (overtimeLabel) {
                            overtimeLabel.innerHTML = ''; // 清空原有标签
                        }
                        
                        // 隐藏加班按钮
                        const overtimeBtn = document.getElementById('overtimeBtn');
                        if (overtimeBtn) {
                            overtimeBtn.style.display = 'none';
                        }

                        // 隐藏模态框相关元素
                        const overtimeModal = document.getElementById('overtimeModal');
                        if (overtimeModal) {
                            overtimeModal.style.display = 'none';
                        }

                        // 隐藏金额输入框（如果存在）
                        const amountInputContainer = document.getElementById('amountInputContainer');
                        if (amountInputContainer) {
                            amountInputContainer.style.display = 'none';
                        }

                        // 创建并显示完整的工量表单
                        let workAmountInputContainer = document.getElementById('workAmountInputContainer');
                        if (!workAmountInputContainer) {
                            workAmountInputContainer = document.createElement('div');
                            workAmountInputContainer.id = 'workAmountInputContainer';
                            workAmountInputContainer.style.cssText = 'margin-top: 10px; display: flex; flex-direction: column; gap: 12px;';
                            workAmountInputContainer.innerHTML = `
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: red; font-weight: bold;">*</span>
                                    <label style="color: black; font-weight: bold; margin: 0;">分项：</label>
                                    <div id="subProjectSelector" style="display: flex; align-items: center; gap: 10px;">
                                        <div id="currentSubProject" style="width: 250px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; cursor: pointer; background-color: white; color: #999;">
                                            请选择分项
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 分项选择模态框 -->
                                <div id="subProjectModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.3); z-index: 1000; align-items: flex-start; justify-content: flex-end;">
                                    <div style="background-color: white; width: 320px; height: 100%; overflow-y: auto; box-shadow: -2px 0 10px rgba(0,0,0,0.1);">
                                        <div style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                            <button id="addSubProjectBtn" style="background-color: #1890ff; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-size: 14px; cursor: pointer;">
                                                添加分项
                                            </button>
                                            <button id="closeSubProjectModal" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #666;">×</button>
                                        </div>
                                        <div style="padding: 15px;">
                                            <div id="subProjectList" style="display: flex; flex-direction: column; gap: 10px;">
                                                <!-- 分项列表初始为空，用户通过添加分项功能添加 -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: red; font-weight: bold;">*</span>
                                    <label style="color: black; font-weight: bold; margin: 0;">工量：</label>
                                    <input type="number" id="workAmountInput" placeholder="请输入工程量" 
                                           style="width: 250px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;">
                                    <span id="workAmountUnit" style="font-size: 16px; color: #666; white-space: nowrap;"></span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: red; font-weight: bold;">*</span>
                                    <label style="color: black; font-weight: bold; margin: 0;">单价：</label>
                                    <input type="number" id="unitPriceInput" placeholder="请输入单价" step="0.01" 
                                           style="width: 250px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;">
                                    <span id="unitPriceUnit" style="font-size: 16px; color: #666; white-space: nowrap;">元</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: red; font-weight: bold;">*</span>
                                    <label style="color: black; font-weight: bold; margin: 0;">工钱：</label>
                                    <input type="number" id="totalPriceInput" placeholder="可输入谈好的价钱" 
                                           style="width: 250px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;">
                                    <span style="font-size: 16px; color: #666; white-space: nowrap;">元</span>
                                </div>
                            `;
                            
                            const overtimeContainer = document.getElementById('overtimeContainer');
                            overtimeContainer.appendChild(workAmountInputContainer);
                            
                            // 添加自动计算功能
                            const workAmountInput = document.getElementById('workAmountInput');
                            const unitPriceInput = document.getElementById('unitPriceInput');
                            const totalPriceInput = document.getElementById('totalPriceInput');
                            
                            function calculateTotal() {
                                const workAmount = parseFloat(workAmountInput.value) || 0;
                                const unitPrice = parseFloat(unitPriceInput.value) || 0;
                                
                                if (workAmount > 0 && unitPrice > 0) {
                                    const total = Math.floor(workAmount * unitPrice);
                                    totalPriceInput.value = total;
                                } else if (workAmount === 0 || unitPrice === 0) {
                                    totalPriceInput.value = '';
                                }
                            }
                            
                            workAmountInput.addEventListener('input', calculateTotal);
                            unitPriceInput.addEventListener('input', calculateTotal);
                        } else {
                            workAmountInputContainer.style.display = 'flex';
                            
                            // 为已存在的输入框添加自动计算功能
                            const workAmountInput = document.getElementById('workAmountInput');
                            const unitPriceInput = document.getElementById('unitPriceInput');
                            const totalPriceInput = document.getElementById('totalPriceInput');
                            
                            function calculateTotal() {
                                const workAmount = parseFloat(workAmountInput.value) || 0;
                                const unitPrice = parseFloat(unitPriceInput.value) || 0;
                                
                                if (workAmount > 0 && unitPrice > 0) {
                                    const total = Math.floor(workAmount * unitPrice);
                                    totalPriceInput.value = total;
                                } else if (workAmount === 0 || unitPrice === 0) {
                                    totalPriceInput.value = '';
                                }
                            }
                            
                            // 移除之前的事件监听器（如果存在）
                            workAmountInput.removeEventListener('input', calculateTotal);
                            unitPriceInput.removeEventListener('input', calculateTotal);
                            
                            // 添加新的事件监听器
                            workAmountInput.addEventListener('input', calculateTotal);
                            unitPriceInput.addEventListener('input', calculateTotal);
                        }
                        
                        // 为分项选择器添加点击事件（确保元素创建后再绑定）
                        setTimeout(function() {
                            const subProjectSelector = document.getElementById('subProjectSelector');
                            if (subProjectSelector) {
                                subProjectSelector.onclick = function() {
                                    // 加载本地分项数据
                                    loadSubProjectsFromLocal();
                                    
                                    const subProjectModal = document.getElementById('subProjectModal');
                                    if (subProjectModal) {
                                        subProjectModal.style.display = 'flex';
                                    }
                                };
                            }
                            
                            // 为分项选择模态框中的添加分项按钮绑定事件
                            const addSubProjectBtnInModal = document.getElementById('addSubProjectBtn');
                            if (addSubProjectBtnInModal) {
                                addSubProjectBtnInModal.onclick = function() {
                                    const addSubProjectModal = document.getElementById('addSubProjectModal');
                                    if (addSubProjectModal) {
                                        addSubProjectModal.style.display = 'flex';
                                    }
                                };
                            }
                            
                            // 为关闭按钮添加点击事件
                            const closeSubProjectModal = document.getElementById('closeSubProjectModal');
                            if (closeSubProjectModal) {
                                closeSubProjectModal.onclick = function() {
                                    const subProjectModal = document.getElementById('subProjectModal');
                                    if (subProjectModal) {
                                        subProjectModal.style.display = 'none';
                                    }
                                };
                            }
                            
                            // 点击模态框外部关闭模态框
                            const subProjectModal = document.getElementById('subProjectModal');
                            if (subProjectModal) {
                                subProjectModal.onclick = function(e) {
                                    if (e.target === subProjectModal) {
                                        subProjectModal.style.display = 'none';
                                    }
                                };
                            }
                        }, 100);

                    } else {
                        // 切换回点工时，恢复原有设置
                        const overtimeLabel = document.querySelector('#overtimeContainer label');
                        if (overtimeLabel) {
                            overtimeLabel.innerHTML = '加班：';
                        }
                        
                        // 显示加班按钮
                        const overtimeBtn = document.getElementById('overtimeBtn');
                        if (overtimeBtn) {
                            overtimeBtn.style.display = 'flex';
                            overtimeBtn.textContent = '无加班';
                            // 重置为加载页面时的默认样式
                            overtimeBtn.style.backgroundColor = 'transparent';
                            overtimeBtn.style.border = '1px solid #ddd';
                            overtimeBtn.style.height = '36px';
                            overtimeBtn.style.display = 'flex';
                            overtimeBtn.style.alignItems = 'center';
                            overtimeBtn.style.justifyContent = 'center';
                            overtimeBtn.style.fontSize = '16px';
                            overtimeBtn.style.fontWeight = 'bold';
                            overtimeBtn.style.color = '#000'; // 加载页面时的默认颜色
                            overtimeBtn.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                            overtimeBtn.style.transformOrigin = 'center';
                        }

                        // 隐藏金额和工程量输入框
                        const amountInputContainer = document.getElementById('amountInputContainer');
                        if (amountInputContainer) {
                            amountInputContainer.style.display = 'none';
                        }
                        const workAmountInputContainer = document.getElementById('workAmountInputContainer');
                        if (workAmountInputContainer) {
                            workAmountInputContainer.style.display = 'none';
                        }
                    }

                    // 切换工类型时取消所有员工的选中状态
                    selectedEmployeeIds.clear();

                    // 重新加载员工数据，确保只显示在职员工和当前日期有记工记录且与记工类型匹配的员工
                    const projectName = document.getElementById('projectName').value;
                    if (projectName) {
                        loadEmployeeData(projectName);
                    }
                });
            });

            // 初始化小时选择器
            function initHoursSelector() {
                // 为所有小时选择器生成选项
                const hoursDropdowns = document.querySelectorAll('.hours-dropdown, .modal-hours-dropdown');
                hoursDropdowns.forEach(hoursDropdown => {
                    // 清空现有选项
                    hoursDropdown.innerHTML = '';
                    
                    // 创建默认选项，并设为不可选择
                    const defaultOption = document.createElement('div');
                    defaultOption.className = 'hours-option disabled';
                    defaultOption.setAttribute('data-value', 'hours');
                    defaultOption.style.cssText = 'padding: 8px 12px; cursor: not-allowed; border-bottom: 1px solid #f0f0f0; color: #999; background-color: #f9f9f9;';
                    defaultOption.textContent = '选小时';
                    hoursDropdown.appendChild(defaultOption);
                    
                    // 生成0.5-24小时的选项，每0.5为一个单位
                    for (let i = 0.5; i <= 24; i += 0.5) {
                        const option = document.createElement('div');
                        option.className = 'hours-option';
                        option.setAttribute('data-value', i.toString());
                        option.style.cssText = 'padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; color: #333;';
                        option.textContent = i + '小时';
                        hoursDropdown.appendChild(option);
                    }
                });
            }
            // 上班按钮事件处理
            document.querySelectorAll('.daywork-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    // 如果点击的是可编辑数字，不处理按钮切换
                    if (e.target.classList.contains('editable-number')) {
                        return;
                    }
                    
                    // 处理选小时按钮点击事件，无论是否有hours-select-container类
                if (true) {
                        e.stopPropagation();
                        
                        // 移除所有按钮的active状态
                        document.querySelectorAll('.daywork-btn').forEach(b => {
                            b.classList.remove('active');
                            b.style.backgroundColor = '#f5f5f5';
                            b.style.color = '#333';
                            b.style.border = '1px solid #ddd';
                        });
                        
                        // 为当前按钮添加active状态
                        this.classList.add('active');
                        this.style.backgroundColor = '#1890ff';
                        this.style.color = 'white';
                        this.style.border = 'none';
                        
                        // 同步更新隐藏的单选按钮
                        document.querySelectorAll('input[name="dayWork"]').forEach(radio => {
                            radio.checked = radio.value === 'hours';
                        });
                        
                        // 显示下拉框
                    const dropdown = this.querySelector('.hours-dropdown');
                    if (dropdown) {
                        dropdown.style.display = 'block';
                    }
                        
                        // 隐藏工作小时数输入框（点击选小时按钮时不显示）
                        // 已删除hoursInput元素，无需处理
                        
                        return;
                    }
                    
                    // 检查当前按钮是否已激活
                    const isCurrentlyActive = this.classList.contains('active');
                    // 对于1个工按钮，从editable-number获取当前值，而不是从data-value
                    let value;
                    if (this.id === 'dayWork1') {
                        const editableNumber = this.querySelector('.editable-number');
                        value = editableNumber ? parseFloat(editableNumber.textContent) || 1 : 1;
                        value = value.toString();
                    } else {
                        value = this.getAttribute('data-value');
                    }
                    
                    // 移除所有按钮的active状态
                    document.querySelectorAll('.daywork-btn').forEach(b => {
                        b.classList.remove('active');
                        b.style.backgroundColor = '#f5f5f5';
                        b.style.color = '#333';
                        b.style.border = '1px solid #ddd';
                        
                        // 如果是小时选择器按钮，恢复原始文字
                        if (b.classList.contains('hours-select-container')) {
                            const hoursInput = b.querySelector('.hours-input');
                            if (hoursInput) {
                                hoursInput.value = '选小时';
                                b.setAttribute('data-value', 'hours');
                            }
                        }
                    });
                    
                    // 同步更新隐藏的单选按钮，默认全部取消选中
                    document.querySelectorAll('input[name="dayWork"]').forEach(radio => {
                        radio.checked = false;
                    });
                    
                    // 处理小时输入框显示/隐藏
                    // 已删除hoursInput元素，无需处理
                    
                    // 隐藏所有下拉框
                    document.querySelectorAll('.hours-dropdown, .modal-hours-dropdown').forEach(dropdown => {
                        dropdown.style.display = 'none';
                    });
                    
                    // 如果当前按钮不是活动状态，则激活它
                    if (!isCurrentlyActive) {
                        this.classList.add('active');
                        this.style.backgroundColor = '#1890ff';
                        this.style.color = 'white';
                        this.style.border = 'none';
                        
                        // 同步更新隐藏的单选按钮
                        document.querySelectorAll('input[name="dayWork"]').forEach(radio => {
                            radio.checked = radio.value === value;
                        });
                        
                        // 处理小时输入框显示/隐藏
                        if (value === 'hours') {
                            // 已删除hoursInput元素，无需处理
                        }
                    }
                });
            });
            
            // 小时选择器事件处理
            function bindHoursSelectorEvents() {
                // 为所有小时选择器绑定事件，包括日工时选择器
                const hoursDropdowns = document.querySelectorAll('.hours-dropdown, .modal-hours-dropdown');
                hoursDropdowns.forEach(hoursDropdown => {
                    // 绑定选项点击事件
                    hoursDropdown.addEventListener('click', function(e) {
                        e.stopPropagation();
                        if (e.target.classList.contains('modal-hours-option') && !e.target.classList.contains('disabled')) {
                            const value = e.target.getAttribute('data-value');
                            let hoursInput;
                            let container = this.closest('.hours-select-container');
                            
                            if (container) {
                                // 普通小时选择器
                                hoursInput = container.querySelector('.hours-input, .modal-hours-input');
                            } else {
                                // 加班模态框的小时选择器
                                container = this.closest('#overtimeHours');
                                if (container) {
                                    hoursInput = container.querySelector('.modal-hours-input');
                                }
                            }
                            
                            // 更新输入框显示值
                            if (hoursInput && container) {
                                hoursInput.value = value + '小时';
                                
                                // 更新按钮的data-value
                                container.setAttribute('data-value', value);
                                
                                // 同步更新隐藏的单选按钮值 - 仅当是上班时间的小时选择器时
                                if (container.id === 'dayWorkHours') {
                                    const hiddenRadio = document.getElementById('hiddenRadioHours');
                                    if (hiddenRadio) {
                                        hiddenRadio.value = value;
                                    }
                                }
                            }
                            
                            // 选择具体小时数后也隐藏工作小时数输入框
                            // 已删除hoursInput元素，无需处理
                            
                            // 隐藏下拉框
                            this.style.display = 'none';
                        }
                    });
                    
                    // 添加选项悬停效果（只对非禁用的选项）
                    hoursDropdown.addEventListener('mouseover', function(e) {
                        if (e.target.classList.contains('hours-option') && !e.target.classList.contains('disabled')) {
                            e.target.style.backgroundColor = '#f5f5f5';
                        }
                    });
                    
                    hoursDropdown.addEventListener('mouseout', function(e) {
                        if (e.target.classList.contains('hours-option') && !e.target.classList.contains('disabled')) {
                            e.target.style.backgroundColor = '';
                        }
                    });
                });
                
                // 点击外部关闭所有下拉框
            document.addEventListener('click', function(e) {
                const hoursContainers = document.querySelectorAll('.hours-select-container');
                hoursContainers.forEach(container => {
                    const dropdown = container.querySelector('.hours-dropdown');
                    if (dropdown && !container.contains(e.target)) {
                        dropdown.style.display = 'none';
                    }
                });
            });

            // 压缩图片函数
            function processImage(file) {
                return new Promise((resolve, reject) => {
                    new Compressor(file, {
                        quality: 0.7,
                        maxWidth: 1920,
                        maxHeight: 1080,
                        success(result) {
                            const reader = new FileReader();
                            reader.readAsDataURL(result);
                            reader.onload = function(e) {
                                resolve({
                                    dataURL: e.target.result,
                                    blob: result,
                                    width: 0,
                                    height: 0
                                });
                            };
                            reader.onerror = function() {
                                reject(new Error('文件读取失败'));
                            };
                        },
                        error(err) {
                            reject(err);
                        }
                    });
                });
            }
            
            // 初始化全局图片数组
            window.selectedImages = [];
            
            // 清除图片函数（清除所有微缩框图片）
            window.clearImage = function() {
                // 清空全局图片数组
                window.selectedImages = [];
                
                const container = document.getElementById('imageUploadContainer');
                if (container) {
                    // 保留添加按钮，删除所有预览图片
                    const items = container.querySelectorAll('.image-preview-item');
                    items.forEach(item => item.remove());
                }
                document.getElementById('imageUpload').value = '';
                document.getElementById('imageModal').style.display = 'none';
            }
            
            // 初始化图片上传功能（仅在未初始化时调用）
            if (!window.imageUploadInitialized && typeof initImageUpload === 'function') {
                initImageUpload();
            }
            }
            const editableNumber = document.querySelector('.editable-number');
            if (editableNumber) {
                // 点击时选中所有文本
                editableNumber.addEventListener('click', function(e) {
                    e.stopPropagation(); // 阻止事件冒泡
                    this.focus();
                    // 选中所有文本
                    const range = document.createRange();
                    range.selectNodeContents(this);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                });
                
                // 获得焦点时的样式处理
                editableNumber.addEventListener('focus', function() {
                    // 焦点状态下的样式已经在CSS中定义
                });
                
                // 失去焦点时恢复样式
                editableNumber.addEventListener('blur', function() {
                    let value = parseFloat(this.textContent) || 1;
                    // 限制范围为0.1-10
                    if (value < 0.1) value = 0.1;
                    if (value > 10) value = 10;
                    this.textContent = value;
                    console.log('editableNumber blur, value:', value);
                    
                    // 更新按钮的data-value
                    const btn = this.closest('.daywork-btn');
                    if (btn) {
                        btn.setAttribute('data-value', value.toString());
                        console.log('Set btn data-value to:', value.toString());
                        // 确保按钮保持active状态
                        btn.classList.add('active');
                        btn.style.backgroundColor = '#1890ff';
                        btn.style.color = 'white';
                        btn.style.border = 'none';
                        console.log('Set btn to active');
                        
                        // 同步更新隐藏的单选按钮值
                        const hiddenRadio = document.getElementById('hiddenRadio1');
                        if (hiddenRadio) {
                            hiddenRadio.value = value.toString();
                            hiddenRadio.checked = true;
                            console.log('Set hiddenRadio value to:', value.toString());
                        }
                        
                        // 确保其他按钮和单选按钮处于非选中状态
                        document.querySelectorAll('.daywork-btn:not(#dayWork1)').forEach(b => {
                            b.classList.remove('active');
                            b.style.backgroundColor = '#f5f5f5';
                            b.style.color = '#333';
                            b.style.border = '1px solid #ddd';
                        });
                        
                        document.querySelectorAll('input[name="dayWork"]:not(#hiddenRadio1)').forEach(radio => {
                            radio.checked = false;
                        });
                    }
                    
                    // 失去焦点时恢复样式（CSS会自动处理）
                });
                
                // 输入时限制为数字和小数点
                editableNumber.addEventListener('input', function() {
                    let value = this.textContent.replace(/[^0-9.]/g, '');
                    // 限制只能有一个小数点
                    const parts = value.split('.');
                    if (parts.length > 2) {
                        value = parts[0] + '.' + parts.slice(1).join('');
                    }
                    this.textContent = value;
                    
                    // 更新按钮的data-value
                    const btn = this.closest('.daywork-btn');
                    if (btn && value) {
                        btn.setAttribute('data-value', value);
                        // 同步更新隐藏的单选按钮值
                        const hiddenRadio = document.getElementById('hiddenRadio1');
                        if (hiddenRadio) {
                            hiddenRadio.value = value;
                        }
                    }
                });
                
                // 按Enter键确认编辑
                editableNumber.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.blur();
                    }
                });
            }

        // 压缩图片函数 - 提升到全局范围内
        function processImage(file) {
            return new Promise((resolve, reject) => {
                new Compressor(file, {
                    quality: 0.7,
                    maxWidth: 1920,
                    maxHeight: 1080,
                    success(result) {
                        const reader = new FileReader();
                        reader.readAsDataURL(result);
                        reader.onload = function(e) {
                            resolve({
                                dataURL: e.target.result,
                                blob: result,
                                width: 0,
                                height: 0
                            });
                        };
                        reader.onerror = function() {
                            reject(new Error('文件读取失败'));
                        };
                    },
                    error(err) {
                        reject(err);
                    }
                });
            });
        }
        window.processImage = processImage;
        
        // 初始化全局图片数组
        window.selectedImages = [];
        
        // 清除图片函数（清除所有微缩框图片）
        window.clearImage = function() {
            // 清空全局图片数组
            window.selectedImages = [];
            
            const container = document.getElementById('imageUploadContainer');
            if (container) {
                // 保留添加按钮，删除所有预览图片
                const items = container.querySelectorAll('.image-preview-item');
                items.forEach(item => item.remove());
            }
            document.getElementById('imageUpload').value = '';
            document.getElementById('imageModal').style.display = 'none';
        }
        
        // initImageUpload 函数已在前面定义，此处删除重复定义
        
        // 加班数据 - 提升为全局变量以便bindOvertimeHoursSelectorEvents函数访问
        window.overtimeData = {
            type: 'none', // none/work/hours
            value: '' // 工数或小时数
        };

            // 初始化加班按钮和关闭事件
            const overtimeBtn = document.getElementById('overtimeBtn');
            overtimeBtn.textContent = '无加班';
            overtimeBtn.style.backgroundColor = 'transparent';
            overtimeBtn.addEventListener('click', function(e) {
                showOvertimeModal();
            });

            // 绑定加班模态框关闭事件
            const overtimeModal = document.getElementById('overtimeModal');
            if (overtimeModal) {
                // 点击模态框外部关闭
                overtimeModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        hideOvertimeModal();
                    }
                });
                
                // 确保关闭按钮事件绑定
                const closeBtn = overtimeModal.querySelector('.modal-close');
                if (closeBtn) {
                    closeBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        hideOvertimeModal();
                    });
                }
            }

            // 绑定加班选项事件
            document.querySelectorAll('.overtime-option').forEach(option => {
                option.addEventListener('click', function() {
                    const value = this.getAttribute('data-value');
                    
                    // 移除所有active状态
                    document.querySelectorAll('.overtime-option').forEach(opt => {
                        opt.style.backgroundColor = '#f5f5f5';
                        opt.style.color = '#333';
                        opt.style.border = '1px solid #ddd';
                    });

                    // 设置当前选项为active
                    this.style.backgroundColor = '#1890ff';
                    this.style.color = 'white';
                    this.style.border = 'none';

                    // 更新数据
                    if (typeof window.overtimeData !== 'undefined') {
                        window.overtimeData.type = value;
                    }
                    
                    // 按钮联动效果：当点击输入工按钮时，重置选小时按钮
                    if (value === 'work') {
                        const hoursInput = document.querySelector('#overtimeHours .modal-hours-input');
                        if (hoursInput) {
                            hoursInput.value = '选小时';
                        }
                    }
                    
                    // 按钮联动效果：当点击选小时按钮时，重置输入工按钮
                    if (value === 'hours') {
                        const workText = document.querySelector('#overtimeWork .work-btn-text');
                        if (workText) {
                            workText.textContent = '输入工';
                        }
                    }
                    
                    // 按钮联动效果：当点击无加班按钮时，重置其他两个按钮
                    if (value === 'none') {
                        // 重置输入工按钮
                        const workText = document.querySelector('#overtimeWork .work-btn-text');
                        if (workText) {
                            workText.textContent = '输入工';
                        }
                        
                        // 重置选小时按钮
                        const hoursInput = document.querySelector('#overtimeHours .modal-hours-input');
                        if (hoursInput) {
                            hoursInput.value = '选小时';
                        }
                        
                        // 隐藏选小时下拉框
                        const hoursDropdown = document.querySelector('#overtimeHours .modal-hours-dropdown');
                        if (hoursDropdown) {
                            hoursDropdown.style.display = 'none';
                        }
                    }
                    
                    // 如果是输入工容器，切换到输入模式
                    if (value === 'work') {
                        const textSpan = this.querySelector('.work-btn-text');
                        const input = this.querySelector('.work-input');
                        textSpan.innerHTML = '<input type="text" class="work-input-inline" style="border: none; background: transparent; color: inherit; width: 60px; outline: none; text-align: center; font-size: 16px; font-weight: bold; margin: 0; padding: 0; vertical-align: middle; line-height: 1;" placeholder="半" value="半">个工';
                        const inlineInput = textSpan.querySelector('.work-input-inline');
                        if (inlineInput) {
                            inlineInput.focus();
                            inlineInput.select();
                            
                            inlineInput.addEventListener('blur', function() {
                                let value = this.value;
                                // 处理"半"的特殊情况
                                if (value === '半' || value === '0.5') {
                                    value = 0.5;
                                } else {
                                    value = parseFloat(value) || 0.5;
                                }
                                if (value < 0.1) value = 0.1;
                                if (value > 10) value = 10;
                                
                                textSpan.innerHTML = (value === 0.5 ? '半' : value) + '个工';
                                window.overtimeData.value = value.toString();
                            });
                        }
                    }
                });
            });

            // 绑定小时选择器事件
            document.getElementById('overtimeHours').addEventListener('click', function(e) {
                // 重置输入工按钮
                const workBtnText = document.querySelector('#overtimeWork .work-btn-text');
                const workInput = document.querySelector('#overtimeWork .work-input');
                if (workBtnText && workInput) {
                    workBtnText.style.display = 'inline-block';
                    workInput.style.display = 'none';
                    workBtnText.textContent = '输入工';
                }
                
                const dropdown = this.querySelector('.modal-hours-dropdown');
                if (dropdown.style.display === 'block') {
                    dropdown.style.display = 'none';
                } else {
                    document.querySelectorAll('.hours-dropdown, .modal-hours-dropdown').forEach(d => d.style.display = 'none');
                    dropdown.style.display = 'block';
                }
                e.stopPropagation();
            });

            // 绑定小时选项事件
            document.querySelectorAll('#overtimeHours .modal-hours-option').forEach(option => {
                option.addEventListener('click', function() {
                    const value = this.getAttribute('data-value');
                    const input = document.querySelector('#overtimeHours .modal-hours-input');
                    input.value = value + '小时';
                    overtimeData.type = 'hours';
                    window.overtimeData.value = value;
                document.querySelector('#overtimeHours .modal-hours-dropdown').style.display = 'none';
                });
            });

            // 取消加班选择
            document.getElementById('cancelOvertime').addEventListener('click', function() {
                const workTypeRadio = document.querySelector('input[name="workType"]:checked');
                
                const overtimeBtn = document.getElementById('overtimeBtn');
                if (workTypeRadio && workTypeRadio.value === '包工') {
                    // 包工模式：重置为"输入金额"
                    overtimeBtn.textContent = '输入金额';
                } else {
                    // 点工模式：重置为"无加班"
                    overtimeBtn.textContent = '无加班';
                }
                overtimeBtn.style.backgroundColor = 'transparent';
                overtimeBtn.style.color = '#333';
                
                hideOvertimeModal();
            });

            // 确认加班选择
            document.getElementById('confirmOvertime').addEventListener('click', function() {
                const workTypeRadio = document.querySelector('input[name="workType"]:checked');
                
                if (workTypeRadio && workTypeRadio.value === '包工') {
                    // 包工模式：金额已经通过实时输入更新，直接关闭模态框
                    hideOvertimeModal();
                } else {
                    // 点工模式：原有逻辑
                    // 获取当前选中的小时值
                    const hoursInput = document.querySelector('#overtimeHours .modal-hours-input');
                    const workInput = document.querySelector('#overtimeWork .work-input-inline');
                    
                    // 优先处理小时选择
                    if (hoursInput && hoursInput.value !== '选小时') {
                        // 从显示值中提取小时数值
                        const match = hoursInput.value.match(/^(\d+(?:\.\d+)?)小时$/);
                        if (match) {
                            overtimeData.type = 'hours';
                            window.overtimeData.value = match[1];
                        }
                    } else if (workInput && workInput.value) {
                        // 处理输入工
                        let value = workInput.value;
                        if (value === '半' || value === '0.5') {
                            value = 0.5;
                        } else {
                            value = parseFloat(value) || 0.5;
                        }
                        if (value < 0.1) value = 0.1;
                        if (value > 10) value = 10;
                        if (typeof window.overtimeData !== 'undefined') {
                            window.overtimeData.type = 'work';
                            window.overtimeData.value = value.toString();
                        }
                    }
                    
                    // 更新加班按钮显示（与新建模式保持一致）
                    const overtimeBtn = document.getElementById('overtimeBtn');
                    if (typeof window.overtimeData !== 'undefined' && window.overtimeData.type === 'none') {
                        overtimeBtn.textContent = '无加班';
                        overtimeBtn.style.backgroundColor = 'transparent';
                        overtimeBtn.style.color = '#333';
                    } else if (typeof window.overtimeData !== 'undefined' && window.overtimeData.type === 'work') {
                        overtimeBtn.textContent = (window.overtimeData.value === '0.5' ? '半' : window.overtimeData.value) + '个工';
                        overtimeBtn.style.backgroundColor = '#ff4d4f';  // 改为红色
                        overtimeBtn.style.color = 'white';
                    } else if (typeof window.overtimeData !== 'undefined' && window.overtimeData.type === 'hours') {
                        overtimeBtn.textContent = window.overtimeData.value + '小时';
                        overtimeBtn.style.backgroundColor = '#ff4d4f';  // 改为红色
                        overtimeBtn.style.color = 'white';
                    }
                }
                
                hideOvertimeModal();
            });

            // 点击外部关闭下拉框
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.hours-select-container')) {
                    document.querySelectorAll('.hours-dropdown, .modal-hours-dropdown').forEach(dropdown => {
                        dropdown.style.display = 'none';
                    });
                }
            });

            // 获取可见员工复选框函数
            function getVisibleEmployeeCheckboxes() {
                const listContainer = document.getElementById('employeeList');
                if (!listContainer) return [];
                
                const items = listContainer.querySelectorAll('.employee-item');
                return Array.from(items)
                    .filter(item => {
                        // 检查元素是否可见：offsetParent不为null，且样式不为hidden/none
                        return item.offsetParent !== null && 
                               getComputedStyle(item).visibility !== 'hidden' &&
                               getComputedStyle(item).display !== 'none';
                    })
                    .map(item => item.querySelector('input[type="checkbox"]'))
                    .filter(cb => cb !== null); // 过滤不存在的复选框
            }

            // 移除重复的事件监听器绑定
            /* const selectAllBtn = document.getElementById('selectAllBtn');
            if (selectAllBtn) {
                selectAllBtn.addEventListener('click', function() {
                    const visibleCheckboxes = getVisibleEmployeeCheckboxes();
                    
                    if (visibleCheckboxes.length === 0) {
                        console.log('没有可见的员工项可操作');
                        return;
                    }
                    
                    // 检查当前是否全部可见项都已选中
                    const allVisibleSelected = visibleCheckboxes.every(cb => cb.checked);
                    
                    // 切换全选状态：如果全部可见项已选中，则取消全选；否则全选
                    isAllSelected = !allVisibleSelected;
                    
                    // 更新按钮文本
                    this.textContent = isAllSelected ? '取消全选' : '全选';
                    
                    // 仅操作可见的复选框
                    visibleCheckboxes.forEach(checkbox => {
                        checkbox.checked = isAllSelected;
                        const employeeItem = checkbox.closest('.employee-item');
                        if (checkbox.checked) {
                            selectedEmployeeIds.add(checkbox.value);
                            employeeItem.classList.add('selected');
                        } else {
                            selectedEmployeeIds.delete(checkbox.value);
                            employeeItem.classList.remove('selected');
                        }
                        
                        // 触发change事件确保其他监听器正常工作
                        const event = new Event('change', { bubbles: true });
                        checkbox.dispatchEvent(event);
                    });
                    
                    // 全选操作完成 - 可见员工数: ${visibleCheckboxes.length} 全选状态: ${isAllSelected}
                });
            } else {
                // 未找到全选按钮
            } */

            // 反选功能 - 仅针对可见员工项
            function selectInverseEmployees() {
                const visibleCheckboxes = getVisibleEmployeeCheckboxes();
                
                if (visibleCheckboxes.length === 0) {
                    console.log('没有可见的员工项可操作');
                    return;
                }
                
                let selectedCount = 0;
                
                // 仅对可见的复选框进行反选操作，跳过已记工的员工
                visibleCheckboxes.forEach(checkbox => {
                    const employeeItem = checkbox.closest('.employee-item');
                    const isMarked = employeeItem && (employeeItem.classList.contains('recorded') || employeeItem.querySelector('.recorded-label'));
                    
                    // 跳过已记工的员工
                    if (!isMarked) {
                        checkbox.checked = !checkbox.checked;
                        if (checkbox.checked) {
                            selectedEmployeeIds.add(checkbox.value);
                            employeeItem.classList.add('selected');
                            selectedCount++;
                        } else {
                            selectedEmployeeIds.delete(checkbox.value);
                            employeeItem.classList.remove('selected');
                        }
                        
                        // 触发change事件确保其他监听器正常工作
                        const event = new Event('change', { bubbles: true });
                        checkbox.dispatchEvent(event);
                    }
                });
                
                // 检查是否全部可见项都已选中（仅考虑非已记工员工）
                const allVisibleSelected = visibleCheckboxes.every(cb => {
                    const employeeItem = cb.closest('.employee-item');
                    const isMarked = employeeItem && (employeeItem.classList.contains('recorded') || employeeItem.querySelector('.recorded-label'));
                    return isMarked || cb.checked;
                });
                const selectAllBtn = document.getElementById('selectAllBtn');
                
                // 根据可见项的选择状态更新全选按钮
                if (allVisibleSelected) {
                    isAllSelected = true;
                    selectAllBtn.textContent = '取消全选';
                } else {
                    isAllSelected = false;
                    selectAllBtn.textContent = '全选';
                }
                
                // 调用监测函数确保状态同步
                monitorSelectionState();
                
                // 反选完成 - 可见员工数: ${visibleCheckboxes.length} 选中员工数: ${selectedCount} 全部可见项选中: ${allVisibleSelected}
            }
            
            // 绑定反选按钮事件
            document.getElementById('selectInverseBtn').addEventListener('click', selectInverseEmployees);
            
            // 绑定工作类型标签点击事件，防止在禁用状态下切换
            document.querySelectorAll('label[for^="workType"]').forEach(label => {
                label.addEventListener('click', function(e) {
                    const radio = document.getElementById(this.getAttribute('for'));
                    if (radio && radio.disabled) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                });
            });
            
            // 增强版 - 实时监测员工列表选择状态函数（基于可见项）
            function monitorSelectionState() {
                const selectAllBtn = document.getElementById('selectAllBtn');
                const visibleCheckboxes = getVisibleEmployeeCheckboxes();
                const checkedVisibleBoxes = visibleCheckboxes.filter(cb => cb.checked);
                
                // 检查选择状态（基于可见项）
                const allVisibleSelected = visibleCheckboxes.length > 0 && checkedVisibleBoxes.length === visibleCheckboxes.length;
                const noneVisibleSelected = checkedVisibleBoxes.length === 0;
                const partialVisibleSelected = checkedVisibleBoxes.length > 0 && checkedVisibleBoxes.length < visibleCheckboxes.length;
                
                // 根据可见项的选择状态更新全选按钮文本
                if (allVisibleSelected) {
                    isAllSelected = true;
                    selectAllBtn.textContent = '取消全选';
                } else {
                    isAllSelected = false;
                    selectAllBtn.textContent = '全选';
                }
                
                // 输出详细的状态监测信息（基于可见项）
                // 实时状态监测（可见项）: {
                //     visibleTotal: visibleCheckboxes.length,
                //     visibleSelected: checkedVisibleBoxes.length,
                //     allVisibleSelected: allVisibleSelected,
                //     noneVisibleSelected: noneVisibleSelected,
                //     partialVisibleSelected: partialVisibleSelected,
                //     buttonText: selectAllBtn.textContent,
                //     isAllSelected: isAllSelected
                // }
            }

            // 点击外部关闭下拉框
            document.addEventListener('click', function(e) {
                const hoursDropdowns = document.querySelectorAll('.hours-dropdown, .modal-hours-dropdown');
                hoursDropdowns.forEach(dropdown => {
                    const container = dropdown.closest('.hours-select-container');
                    if (!dropdown.contains(e.target) && container && !container.contains(e.target)) {
                        dropdown.style.display = 'none';
                    }
                });
            });
            
            // 初始化小时选择器
            initHoursSelector();
            bindHoursSelectorEvents();

            // 上下午按钮事件处理
            document.getElementById('morningAfternoonBtn').addEventListener('click', function() {

                // 重置1个工按钮为默认状态
                resetDayWork1Button();
                
                // 重置小时选择器按钮
                resetHoursSelectorButton();
                
                // 重置上下午按钮
                const morningAfternoonBtn = document.getElementById('morningAfternoonBtn');
                if (morningAfternoonBtn) {
                    morningAfternoonBtn.textContent = '上下午';
                    morningAfternoonBtn.style.backgroundColor = '#f5f5f5';
                    morningAfternoonBtn.style.color = '#333';
                    morningAfternoonBtn.style.border = '1px solid #ddd';
                }
                
                // 重置上下午数据
                if (window.morningAfternoonData) {
                    window.morningAfternoonData = {
                        morning: { type: 'rest', value: '' },
                        afternoon: { type: 'rest', value: '' }
                    };
                }
                
                showMorningAfternoonModal();
                // 切换为 period 选项
                document.querySelectorAll('input[name="dayWork"]').forEach(radio => { radio.checked = false; });
                const periodRadio = document.getElementById('hiddenRadioPeriod');
                if (periodRadio) periodRadio.checked = true;
            });

            // 模态框事件处理
            document.getElementById('confirmMorningAfternoon').addEventListener('click', confirmMorningAfternoon);
            document.getElementById('cancelMorningAfternoon').addEventListener('click', hideMorningAfternoonModal);

            // 模态框中的按钮事件处理
            bindMorningAfternoonButtonEvents();

            // 模态框中的小时选择器
            initModalHoursSelector();
            bindModalHoursSelectorEvents();
            
            // 初始化加班模态框中的小时选择器
            initOvertimeHoursSelector();
            bindOvertimeHoursSelectorEvents();

            // 监听金额输入框的变化（包工模式）
            document.addEventListener('input', function(e) {
                if (e.target && e.target.id === 'amountInput') {
                    const workTypeRadio = document.querySelector('input[name="workType"]:checked');
                    if (workTypeRadio && workTypeRadio.value === '包工') {
                        const amount = parseFloat(e.target.value);
                        
                        if (!isNaN(amount) && amount > 0) {
                            window.overtimeData.type = 'amount';
                            window.overtimeData.value = amount.toString();
                        } else {
                            window.overtimeData.type = 'none';
                            window.overtimeData.value = null;
                        }
                    }
                }
                
                // 监听工量模式下所有输入框的变化
                if (['workAmountInput', 'unitPriceInput', 'totalPriceInput', 'subProject'].includes(e.target.id)) {
                    const workTypeRadio = document.querySelector('input[name="workType"]:checked');
                    if (workTypeRadio && workTypeRadio.value === '工量') {
                        // 收集工量相关的所有数据
                        const subProject = document.getElementById('subProject') ? document.getElementById('subProject').value : '';
                        const workAmount = document.getElementById('workAmountInput') ? document.getElementById('workAmountInput').value : '';
                        const unitPrice = document.getElementById('unitPriceInput') ? document.getElementById('unitPriceInput').value : '';
                        const totalPrice = document.getElementById('totalPriceInput') ? document.getElementById('totalPriceInput').value : '';
                        
                        // 保存到window.overtimeData对象中
                        window.overtimeData.type = 'workAmount';
                        window.overtimeData.value = {
                            subProject: subProject,
                            workAmount: workAmount,
                            unitPrice: unitPrice,
                            totalPrice: totalPrice
                        };
                    }
                }
            });

            // 确认记工按钮
            document.getElementById('confirmBtn').addEventListener('click', function() {
                // 如果处于编辑模式，则不执行新建记工的逻辑
                if (typeof isEditMode !== 'undefined' && isEditMode) {
                    return;
                }

                // 设置全局引用
                window.workRecordService.setGlobalReferences({
                    selectedEmployeeIds: selectedEmployeeIds,
                    employees: employees,
                    activeEmployees: activeEmployees,
                    inactiveEmployees: inactiveEmployees
                });
                window.workRecordService.confirmWorkRecord();
            });

            // 模态框按钮
            document.getElementById('confirmAddEmployees').addEventListener('click', addSelectedEmployees);
            document.getElementById('cancelAddEmployees').addEventListener('click', hideAddEmployeeModal);
        }

        // 绑定模态框事件
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('cancelAddEmployees').addEventListener('click', hideAddEmployeeModal);
        });

        // 加载数据
        function loadData() {
            console.log('loadData函数已废弃，跳过项目公共设置加载...');
            // 获取当前项目名称
            const currentProjectName = document.getElementById('projectName').value;
            if (currentProjectName) {
                loadEmployeeData(currentProjectName);
            } else {
                showNotification('请先选择项目名称', true);
            }
        }

        // 显示在职员工
        function displayActiveEmployees() {
            const employeeList = document.getElementById('employeeList');
            
            // 在编辑模式下调整员工列表容器高度，与结算借支页面保持一致
            if (employeeList) {
                employeeList.style.maxHeight = 'none';
                employeeList.style.minHeight = 'auto';
                employeeList.style.width = '100%';
                employeeList.style.boxSizing = 'border-box';
            }
            
            employeeList.innerHTML = '';
            // 显示在职员工: ${activeEmployees.length} 个员工
            // 当前选中集合: ${Array.from(selectedEmployeeIds)}
            // 当前模式: ${isEditMode ? '编辑模式' : '新建模式'}

            let employeesToDisplay = activeEmployees;
            let showAddButton = false;

            // 编辑模式：只显示选中的员工，并添加+按钮
            // 但如果是从编辑模式展开的，则显示所有员工
            if (isEditMode && selectedEmployeeIds.size > 0 && !isFromEditMode) {
                employeesToDisplay = activeEmployees.filter(emp => selectedEmployeeIds.has(emp.employee_id));
                showAddButton = true;
            } else if (isEditMode && isFromEditMode) {
                // 从编辑模式展开，显示所有员工，但保持编辑模式
                employeesToDisplay = activeEmployees;
                showAddButton = false;
            }
            
            // 如果是从记工表进入且有选中的员工，只显示选中的员工
            if (isFromTimesheet && selectedEmployeeIds.size > 0 && !isFromTimesheetExpanded) {
                employeesToDisplay = activeEmployees.filter(emp => selectedEmployeeIds.has(emp.employee_id));
                // 不显示展开按钮
            }

            employeesToDisplay.forEach(emp => {
                const employeeItem = document.createElement('div');
                employeeItem.className = 'employee-item';
                // 添加data-id属性方便调试
                employeeItem.dataset.id = emp.employee_id;
                // 直接生成HTML，不使用变量和+按钮
                employeeItem.innerHTML = `<input type="checkbox" value="${emp.employee_id}" id="emp_${emp.employee_id}"> <label for="emp_${emp.employee_id}" style="display: none;">${emp.姓名}</label><div class="employee-info"><div class="employee-id">${emp.emp_code}</div><div style="width: 45px; color: #000000;">${emp.姓名}</div></div>`;
                employeeList.appendChild(employeeItem);

                // 检查是否已在选中集合中
                const isSelected = selectedEmployeeIds.has(emp.employee_id);
                const checkbox = employeeItem.querySelector('input[type="checkbox"]');
                checkbox.checked = isSelected;
                
                // 如果是从记工表进入且处于折叠状态，禁用复选框
                if (isFromTimesheet && !isFromTimesheetExpanded) {
                    checkbox.disabled = true;
                    employeeItem.style.cursor = 'not-allowed';
                }
                
                if (isSelected) {
                    employeeItem.classList.add('selected');
                    // 初始化员工项: ${emp.ID} 已选中
                } else {
                    // 初始化员工项: ${emp.ID} 未选中
                }

                // 绑定点击事件到整个员工项
                employeeItem.addEventListener('click', function(e) {
                    // 如果是从记工表进入且处于折叠状态，阻止点击
                    if (isFromTimesheet && !isFromTimesheetExpanded) {
                        e.preventDefault();
                        e.stopPropagation();
                        return;
                    }
                    
                    // 阻止事件冒泡
                    e.stopPropagation();
                    // 切换复选框状态
                const checkbox = this.querySelector('input[type="checkbox"]');
                checkbox.checked = !checkbox.checked;
                // 触发change事件
                const event = new Event('change');
                checkbox.dispatchEvent(event);
                // 更新全选按钮状态
                    updateSelectAllButtonState();
                    // 调用增强版监测函数确保状态同步
                    monitorSelectionState();
                });

                // 绑定复选框事件
                checkbox.addEventListener('change', function(e) {
                    // 如果是从记工表进入且处于折叠状态，阻止change事件
                    if (isFromTimesheet && !isFromTimesheetExpanded) {
                        e.preventDefault();
                        e.stopPropagation();
                        return;
                    }
                    
                    e.stopPropagation();
                    const employeeItem = this.closest('.employee-item');
                    if (this.checked) {
                        selectedEmployeeIds.add(this.value);
                        employeeItem.classList.add('selected');
                        // 选中员工: ${this.value} 添加到选中集合
                        // 当前选中集合: ${Array.from(selectedEmployeeIds)}
                    } else {
                        selectedEmployeeIds.delete(this.value);
                        employeeItem.classList.remove('selected');
                        // 取消选中员工: ${this.value} 从选中集合移除
                        // 当前选中集合: ${Array.from(selectedEmployeeIds)}
                    }
                    // 更新全选按钮状态
                    updateSelectAllButtonState();
                    // 调用增强版监测函数确保状态同步
                    monitorSelectionState();
                });
            });
            
            // 在员工列表末尾添加独立的+按钮项（展开按钮）
            if (showAddButton) {
                const addEmployeeItem = document.createElement('div');
                addEmployeeItem.className = 'employee-item';
                addEmployeeItem.innerHTML = `
                    <div class="employee-info">
                        <div class="employee-id" style="cursor: pointer; color: #1890ff; font-size: 36px; font-weight: bold;">+</div>
                        <div style="width: 45px; color: #000000;">展开</div>
                    </div>
                `;
                employeeList.appendChild(addEmployeeItem);
                
                // 绑定+按钮点击事件
                addEmployeeItem.addEventListener('click', function(e) {
                    e.stopPropagation();
                    // 保持编辑模式，显示所有员工
                    isEditMode = true;
                    isFromEditMode = true; // 标记是从编辑模式展开的
                    isFromTimesheetExpanded = true; // 标记是从记工表进入后展开的
                    // 刷新员工列表
                    displayActiveEmployees();
                    // 更新UI状态
                    updateUIForEditMode();
                });
            }
            
            // 显示所有员工时，添加-按钮用于只显示选中员工
            // 在编辑模式下且从编辑模式展开时，也显示折叠按钮
            // 但如果是从记工表进入且处于折叠状态，不显示折叠按钮
            if ((!isEditMode || (isEditMode && isFromEditMode)) && selectedEmployeeIds.size > 0 && !(isFromTimesheet && !isFromTimesheetExpanded)) {
                const subtractEmployeeItem = document.createElement('div');
                subtractEmployeeItem.className = 'employee-item';
                subtractEmployeeItem.innerHTML = `
                    <div class="employee-info">
                        <div class="employee-id" style="cursor: pointer; color: #1890ff; font-size: 36px; font-weight: bold;">-</div>
                        <div style="width: 45px; color: #000000;">折叠</div>
                    </div>
                `;
                employeeList.appendChild(subtractEmployeeItem);
                
                // 绑定-按钮点击事件
                subtractEmployeeItem.addEventListener('click', function(e) {
                    e.stopPropagation();
                    // 进入编辑模式，只显示选中员工
                    isEditMode = true;
                    isFromEditMode = false; // 重置展开状态标记
                    isFromTimesheetExpanded = false; // 重置记工表展开状态标记
                    // 刷新员工列表
                    displayActiveEmployees();
                    // 更新UI状态
                    updateUIForEditMode();
                });
            }
            
            // 新建模式下，添加+按钮用于添加员工
            // 但如果是从记工表进入且处于折叠状态，不显示添加按钮
            if (!isEditMode && !isFromEditMode && !(isFromTimesheet && !isFromTimesheetExpanded)) {
                const addEmployeeItem = document.createElement('div');
                addEmployeeItem.className = 'employee-item';
                addEmployeeItem.innerHTML = `
                    <div class="employee-info">
                        <div class="employee-id add-button" style="cursor: pointer; color: #52c41a; font-size: 36px; font-weight: bold;">+</div>
                        <div style="width: 45px; color: #000000;">添加</div>
                    </div>
                `;
                employeeList.appendChild(addEmployeeItem);
                
                // 绑定+按钮点击事件 - 添加员工功能
                addEmployeeItem.addEventListener('click', function(e) {
                    e.stopPropagation();
                    showAddEmployeeModal();
                });
            }
            
            // 新建模式下，添加-按钮用于删除选中员工
            // 但如果是从记工表进入且处于折叠状态，不显示删除按钮
            if (!isEditMode && !isFromEditMode && !(isFromTimesheet && !isFromTimesheetExpanded)) {
                const deleteEmployeeItem = document.createElement('div');
                deleteEmployeeItem.className = 'employee-item';
                deleteEmployeeItem.innerHTML = `
                    <div class="employee-info">
                        <div class="employee-id delete-button" style="cursor: pointer; color: #f5222d; font-size: 36px; font-weight: bold;">-</div>
                        <div style="width: 45px; color: #000000;">删除</div>
                    </div>
                `;
                employeeList.appendChild(deleteEmployeeItem);
                
                // 绑定-按钮点击事件 - 删除选中员工功能
                deleteEmployeeItem.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const selectedItems = document.querySelectorAll('.employee-item.selected');
                    if(selectedItems.length === 0) {
                        showNotification('请先选中要删除的员工！', 'error');
                        return;
                    }
                    
                    // 显示确认模态框
                    showConfirmModal(
                        '确认删除', 
                        `确定要删除选中的${selectedItems.length}名员工吗？`, 
                        function() {
                            // 确认删除
                            selectedItems.forEach(item => {
                                item.remove();
                            });
                            selectedEmployeeIds.clear();
                            showNotification('员工删除成功！', true);
                        }
                    );
                });
            }

            // 添加全选按钮事件
            // 移除重复的事件监听器绑定
            /* const selectAllBtn = document.getElementById('selectAllBtn');
            if (selectAllBtn) {
                // 使用现有的全选按钮，不替换它
                selectAllBtn.addEventListener('click', function() {
                    // 获取当前可见的员工复选框
                    const visibleCheckboxes = getVisibleEmployeeCheckboxes();
                    
                    if (visibleCheckboxes.length === 0) {
                        // 没有可见的员工可选择
                        return;
                    }
                    
                    // 检查当前是否全部可见项都已选中
                    const allVisibleSelected = visibleCheckboxes.every(cb => cb.checked);
                    
                    // 切换全选状态：如果全部可见项已选中，则取消全选；否则全选
                    isAllSelected = !allVisibleSelected;
                    
                    // 开始全选操作 - 目标状态: ${isAllSelected} 复选框数量: ${visibleCheckboxes.length}
                    
                    // 手动更新复选框状态，不依赖dispatchEvent，避免事件处理中的冲突
                    let processedCount = 0;
                    visibleCheckboxes.forEach((checkbox, index) => {
                        // 直接设置复选框状态
                        checkbox.checked = isAllSelected;
                        
                        // 手动更新员工项的选中样式
                        const employeeItem = checkbox.closest('.employee-item');
                        if (employeeItem) {
                            if (isAllSelected) {
                                employeeItem.classList.add('selected');
                                selectedEmployeeIds.add(checkbox.value);
                                // 选中员工: ${checkbox.value} 添加到选中集合
                            } else {
                                employeeItem.classList.remove('selected');
                                selectedEmployeeIds.delete(checkbox.value);
                                // 取消选中员工: ${checkbox.value} 从选中集合移除
                            }
                        }
                        
                        processedCount++;
                        // 处理复选框 ${index + 1}/${visibleCheckboxes.length}: ${checkbox.value} 状态: ${isAllSelected}
                    });
                    
                    // 全选操作处理完成，已处理: ${processedCount} 个复选框
                    // 当前选中集合: ${Array.from(selectedEmployeeIds)}
                    
                    // 更新按钮文本
                    this.textContent = isAllSelected ? '取消全选' : '全选';
                    
                    // 全选操作完成 - 可见员工数: ${visibleCheckboxes.length} 全选状态: ${isAllSelected}
                });
            } else {
                console.error('未找到全选按钮');
            } */

            // 获取可见的员工复选框
            function getVisibleEmployeeCheckboxes() {
                // 获取所有员工复选框
                const allCheckboxes = document.querySelectorAll('.employee-item input[type="checkbox"]');
                const visibleCheckboxes = [];
                
                // 获取所有员工复选框，总数: ${allCheckboxes.length}
                
                // 筛选出可见的复选框
                allCheckboxes.forEach(checkbox => {
                    // 获取父元素以检查可见性
                    const parentItem = checkbox.closest('.employee-item');
                    // 使用更宽松的可见性检查，同时考虑display和visibility属性
                    const isVisible = parentItem && 
                                     parentItem.offsetParent !== null && 
                                     parentItem.style.display !== 'none' && 
                                     parentItem.style.visibility !== 'hidden';
                    
                    if (isVisible) {
                        visibleCheckboxes.push(checkbox);
                        // 添加可见复选框: ${checkbox.value}
                    } else {
                        // 跳过不可见复选框: ${checkbox.value}
                    }
                });
                
                // 筛选后可见复选框数量: ${visibleCheckboxes.length}
                return visibleCheckboxes;
            }
            
            // 更新全选按钮状态 - 增强实时监测版本
            function updateSelectAllButtonState() {
                const selectAllBtn = document.getElementById('selectAllBtn');
                const visibleCheckboxes = getVisibleEmployeeCheckboxes();
                const checkedVisibleBoxes = visibleCheckboxes.filter(cb => cb.checked);
                
                if (!selectAllBtn) {
                    // 未找到全选按钮
                    return;
                }
                
                if (visibleCheckboxes.length === 0) {
                    isAllSelected = false;
                    selectAllBtn.textContent = '全选';
                    return;
                }
                
                // 实时监测员工列表选择状态（基于可见项）
                const allVisibleSelected = visibleCheckboxes.length > 0 && checkedVisibleBoxes.length === visibleCheckboxes.length;
                const noneVisibleSelected = checkedVisibleBoxes.length === 0;
                const partialVisibleSelected = checkedVisibleBoxes.length > 0 && checkedVisibleBoxes.length < visibleCheckboxes.length;
                
                // 根据可见项的选择状态更新全选按钮文本
                if (allVisibleSelected && !isAllSelected) {
                    isAllSelected = true;
                    selectAllBtn.textContent = '取消全选';
                } else if (!allVisibleSelected && isAllSelected) {
                    isAllSelected = false;
                    selectAllBtn.textContent = '全选';
                }

            }
            
            // 确保已记工员工被正确标记
            if (typeof window.workRecordMarker !== 'undefined') {
                window.workRecordMarker.markEmployees();
            }
        }

        // 加载员工数据函数 - 从localStorage获取
        async function loadEmployeeData(projectName) {
            // 开始加载员工数据，项目名称: ${projectName}
            
            // 获取用户信息（作为userId）
            let phone = localStorage.getItem('loggedInPhone');
            if (!phone && window.location.hostname === 'localhost') {
                phone = '13800138000';
            }
            
            // 当前用户手机号: ${phone}
            
            if (!phone) {
                // 未找到用户信息
                showNotification('未找到用户信息，无法加载员工数据', true);
                return;
            }
            
            if (!projectName) {
                // 未找到项目名称
                showNotification('未找到项目名称，无法加载员工数据', true);
                return;
            }
            
            // 获取项目ID
            const projectId = localStorage.getItem('currentProjectId') || '';
            // 正在从localStorage加载项目 "${projectName}" 的员工数据，项目ID: ${projectId}...
            
            try {
                // 直接从localStorage加载数据 - 使用项目ID作为键名以确保一致性
                const localKey = `employees_${projectId}`;
                const savedData = localStorage.getItem(localKey);
                
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    if (parsedData.employees && Array.isArray(parsedData.employees)) {

                    // 将localStorage返回的数据格式转换为应用需要的格式
                        employees = parsedData.employees.map(localEmp => ({
                            employee_id: localEmp.employee_id || '', // 员工唯一标识（UUID）
                            emp_code: localEmp.emp_code || '', // 工号
                            姓名: localEmp.emp_name || '', // 姓名
                            状态: localEmp.status || '在职', // 状态，默认为在职
                            工价: localEmp.labor_cost || 0, // 工价
                            // 其他需要的字段
                            电话: localEmp.phone || '',
                            身份证: localEmp.id_card || '',
                            进场日期: localEmp.hire_date || '',
                            离场日期: localEmp.leave_date || '',
                            备注: localEmp.remarks || '',
                            银行: localEmp.bank_name || '',
                            银行卡: localEmp.bank_card_number || '',
                            开户行: localEmp.bank_address || ''
                    })).sort((a, b) => {
                        // 按工号升序排序，确保工号为数字类型进行比较
                        const codeA = parseInt(a.emp_code) || 0;
                        const codeB = parseInt(b.emp_code) || 0;
                        return codeA - codeB;
                    });
                    
                    // 从localStorage加载项目 "${projectName}" 的员工数据: ${employees.length} 个员工
                    
                    // 在编辑模式下，activeEmployees包含所有员工，以便编辑时能选中任何状态的员工
                    if (isEditMode) {
                        activeEmployees = employees; // 编辑模式下显示所有员工
                        inactiveEmployees = []; // 编辑模式下不需要非活跃员工列表
                    } else {
                        // 非编辑模式下，显示在职员工和有记工记录的非在职员工
                        let markedEmployeeIds = [];
                        // 直接从本地存储获取已记员工ID，避免依赖workRecordMarker的异步操作
                        try {
                            // 获取用户ID，与workRecordMarker保持一致
                            let userId = 'default';
                            const currentUserStr = localStorage.getItem('currentUser');
                            if (currentUserStr) {
                                const currentUser = JSON.parse(currentUserStr);
                                userId = currentUser.user_id || 'default';
                            }
                            
                            // 获取当前记工日期
                            const workDateInput = document.getElementById('workDate');
                            const workDate = workDateInput ? workDateInput.value : new Date().toISOString().split('T')[0];
                            
                            // 获取当前工作类型
                            const currentWorkType = (() => {
                                // 查找当前激活的工作类型选项
                                const activeOption = document.querySelector('input[name="workType"] + .work-type-option.active');
                                if (activeOption) {
                                    const optionText = activeOption.textContent.trim();
                                    if (optionText.includes('点工')) return '点工';
                                    if (optionText.includes('包工')) return '包工';
                                    if (optionText.includes('工量')) return '工量';
                                }
                                // 如果没有找到激活的选项，通过单选按钮的checked状态来判断
                                const checkedRadio = document.querySelector('input[name="workType"]:checked');
                                if (checkedRadio) {
                                    const radioId = checkedRadio.id;
                                    if (radioId.includes('workType1')) return '点工';
                                    if (radioId.includes('workType2')) return '包工';
                                    if (radioId.includes('workType3')) return '工量';
                                }
                                return null;
                            })();
                            
                            if (!currentWorkType) {
                                throw new Error('无法获取当前工作类型');
                            }
                            
                            // 使用与workRecordMarker一致的键名从本地存储获取数据
                            const localStorageKey = `work_records_${userId}`;
                            const localWorkFlowDataStr = localStorage.getItem(localStorageKey);
                            if (localWorkFlowDataStr) {
                                const allRecords = JSON.parse(localWorkFlowDataStr);
                                
                                // 过滤出当前项目、日期和工作类型的记录
                                const filteredRecords = allRecords.filter(record => 
                                    record.project_id === projectId && 
                                    record.record_date === workDate && 
                                    record.work_type === currentWorkType
                                );
                                
                                // 将过滤后的记录的员工ID添加到已记工集合
                                filteredRecords.forEach(record => {
                                    if (record.employee_id) {
                                        markedEmployeeIds.push(record.employee_id);
                                    }
                                });
                            }
                        } catch (error) {
                            console.error('直接从本地存储获取已记工员工ID失败:', error);
                            // 如果直接获取失败，尝试使用workRecordMarker
                            if (typeof window.workRecordMarker !== 'undefined') {
                                try {
                                    // 调用检查已记工员工的方法，确保markedEmployees集合是最新的
                                    await window.workRecordMarker._checkMarkedEmployeesImpl();
                                    // 获取已记工员工ID集合
                                    markedEmployeeIds = Array.from(window.workRecordMarker.markedEmployees);
                                } catch (error) {
                                    console.error('通过workRecordMarker获取已记工员工ID失败:', error);
                                }
                            }
                        }

                        // 非编辑模式下，显示在职员工和有记工记录的非在职员工
                        activeEmployees = employees.filter(emp =>
                            emp.状态 === '在职' || markedEmployeeIds.includes(emp.employee_id)
                        );
                        // 将状态不为在职且没有记工记录的员工加载到添加模体框
                        inactiveEmployees = employees.filter(emp =>
                            emp.状态 !== '在职' &&
                            !markedEmployeeIds.includes(emp.employee_id)
                        );

                        // 如果URL中指定了员工ID，确保这些员工也显示在列表中
                        if (window.employeeIdFromUrl) {
                            const employee = employees.find(emp => emp.employee_id === window.employeeIdFromUrl);
                            if (employee) {
                                if (!activeEmployees.some(emp => emp.employee_id === employee.employee_id)) {
                                    // 添加到activeEmployees（即使不是在职状态或没有记工记录）
                                    activeEmployees.push(employee);
                                }
                                // 添加到selectedEmployeeIds集合（在displayActiveEmployees之前）
                                selectedEmployeeIds.add(window.employeeIdFromUrl);
                            }
                        }
                    }

                    // 显示在职员工（会根据selectedEmployeeIds自动选中）
                    displayActiveEmployees();
                    
                    // 员工列表重新渲染后，更新全选按钮状态和已记标记
            setTimeout(() => {
                updateSelectAllButtonState();
                // 确保已记工员工被正确标记
                if (typeof window.workRecordMarker !== 'undefined') {
                    window.workRecordMarker.markEmployees();
                }
            }, 100);
                    
                    // 预加载非在职员工到添加按钮的模态框中
                    const inactiveList = document.getElementById('inactiveEmployeesList');
                    if(inactiveList) {
                        inactiveList.innerHTML = '';
                        inactiveEmployees.forEach(emp => {
                            const employeeItem = document.createElement('div');
                    employeeItem.className = 'employee-item';
                    employeeItem.innerHTML = `
                        <input type="checkbox" value="${emp.employee_id}" data-name="${emp.姓名}" data-status="${emp.状态}" data-emp-code="${emp.emp_code}"> 
                        <div class="employee-info">
                            <div class="employee-id">${emp.emp_code}</div>
                            <div><span style="color: #000000;">${emp.姓名}</span> (${emp.状态})</div>
                        </div>
                    `;
                    inactiveList.appendChild(employeeItem);
                        });
                    }
                    
                } else {
                    console.log(`项目 "${projectName}" 无员工数据或查询失败`);
                    employees = [];
                    activeEmployees = [];
                    inactiveEmployees = [];
                    displayActiveEmployees();
                    
                    // 提供更详细的错误信息
                    showNotification(`未找到员工数据，可能该项目下还没有员工信息`, true);
                }
            }
            } catch(error) {
                console.error(`从localStorage加载项目 "${projectName}" 的员工数据失败:`, error);
                employees = [];
                activeEmployees = [];
                inactiveEmployees = [];
                displayActiveEmployees();
                
                // 根据错误类型提供具体的错误信息
                let errorMessage = '加载员工数据失败';
                if (error.message) {
                    errorMessage = `加载失败: ${error.message}`;
                }
                
                showNotification(errorMessage, true);
            }
        }

        // 显示添加员工模态框
        function showAddEmployeeModal() {
            const modal = document.getElementById('addEmployeeModal');
            const inactiveList = document.getElementById('inactiveEmployeesList');
            inactiveList.innerHTML = '';
            
            // 设置容器样式，限制高度并添加滚动
            inactiveList.style.height = '320px';
        inactiveList.style.overflowY = 'auto';
        inactiveList.style.overflowX = 'hidden';

            // 创建表格结构
                inactiveList.innerHTML = `
                    <table class="employee-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="width: 30px; background-color: #f2f2f2; color: #ED7D31; padding: 5px; border: 1px solid #ddd;"></th>
                                <th style="background-color: #f2f2f2; color: #ED7D31; padding: 5px; border: 1px solid #ddd;">工号</th>
                                <th style="background-color: #f2f2f2; color: #ED7D31; padding: 5px; border: 1px solid #ddd;">姓名</th>
                                <th style="background-color: #f2f2f2; color: #ED7D31; padding: 5px; border: 1px solid #ddd;">状态</th>
                            </tr>
                        </thead>
                        <tbody id="employeeTableBody"></tbody>
                    </table>
                `;
                
                const tableBody = document.getElementById('employeeTableBody');
                
                inactiveEmployees.forEach((emp, index) => {
                    const row = document.createElement('tr');
                    // 设置交替行颜色
                    row.style.backgroundColor = index % 2 === 0 ? '#DDEBF7' : 'white';
                    row.style.border = '1px solid #ddd';
                    
                    row.innerHTML = `
                        <td style="padding: 5px; border: 1px solid #ddd; text-align: center;">
                            <input type="checkbox" value="${emp.employee_id}" data-name="${emp.姓名}" data-status="${emp.状态}" data-emp-code="${emp.emp_code}">
                        </td>
                        <td style="padding: 5px; border: 1px solid #ddd; text-align: center;">${emp.emp_code}</td>
                        <td style="padding: 5px; border: 1px solid #ddd; text-align: center;">${emp.姓名}</td>
                        <td style="padding: 5px; border: 1px solid #ddd; text-align: center;">
                            <span class="${getStatusClass(emp.状态)}">${emp.状态}</span>
                        </td>
                    `;
                    
                    // 保存原始背景色
                    const originalBgColor = index % 2 === 0 ? '#DDEBF7' : 'white';
                    
                    // 绑定行点击事件
                    row.addEventListener('click', function(e) {
                        // 如果点击的不是复选框，则切换复选框状态
                        if (e.target.type !== 'checkbox') {
                            const checkbox = this.querySelector('input[type="checkbox"]');
                            checkbox.checked = !checkbox.checked;
                            // 根据复选框状态设置行背景色
                            if (checkbox.checked) {
                                this.style.backgroundColor = '#E74C3C'; // 选中时的深红色背景
                            } else {
                                this.style.backgroundColor = originalBgColor; // 恢复原始背景色
                            }
                            // 触发change事件
                            const event = new Event('change');
                            checkbox.dispatchEvent(event);
                        }
                    });
                    
                    tableBody.appendChild(row);
                });
                
                // 添加状态样式函数
                function getStatusClass(status) {
                    if (status.includes('隐藏')) return 'hidden-status';
                    if (status.includes('离职')) return 'resigned-status';
                    if (status.includes('结清')) return 'settled-status';
                    return '';
                }

            modal.style.display = 'flex';
            
            // 绑定添加员工模态框关闭事件
            const addEmployeeModal = document.getElementById('addEmployeeModal');
            if (addEmployeeModal) {
                // 点击模态框外部关闭
                addEmployeeModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        hideAddEmployeeModal();
                    }
                });
                
                // 确保关闭按钮事件绑定
                const closeBtn = addEmployeeModal.querySelector('.modal-close');
                if (closeBtn) {
                    closeBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        hideAddEmployeeModal();
                    });
                }
            }
        }

        // 隐藏添加员工模态框
        function hideAddEmployeeModal() {
            // 关闭添加员工模态框
            const modal = document.getElementById('addEmployeeModal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('show');
            }
        }

        // 添加选中的员工
        function addSelectedEmployees() {
            const checkboxes = document.querySelectorAll('#inactiveEmployeesList input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                showNotification('请选择要添加的员工', true);
                return;
            }

            checkboxes.forEach(checkbox => {
                const empId = checkbox.value;
                const empName = checkbox.dataset.name;
                const empStatus = checkbox.dataset.status;
                const empCode = checkbox.dataset.empCode;

                // 添加到员工列表
                const employeeList = document.getElementById('employeeList');
                const employeeItem = document.createElement('div');
                employeeItem.className = 'employee-item';
                employeeItem.innerHTML = `
                    <input type="checkbox" value="${empId}"> 
                    <div class="employee-info">
                        <div class="employee-id" style="color: #FAAD14;">${empCode}</div>
                        <div style="color: #FAAD14; width: 45px;">${empName}</div>
                    </div>
                `;
                
                // 找到+按钮元素，将新员工插入到+按钮前面
                // 查找包含"+"文本的employee-id元素
                const addButtons = employeeList.querySelectorAll('.employee-item .employee-id');
                let addButtonItem = null;
                
                for (const btn of addButtons) {
                    if (btn.textContent.trim() === '+') {
                        addButtonItem = btn.closest('.employee-item');
                        break;
                    }
                }
                
                if (addButtonItem) {
                    employeeList.insertBefore(employeeItem, addButtonItem);
                } else {
                    // 如果没有找到+按钮，则追加到列表末尾
                    employeeList.appendChild(employeeItem);
                }

                // 绑定点击事件到整个员工项
                employeeItem.addEventListener('click', function(e) {
                    // 如果点击的不是复选框，则切换复选框状态
                    if (e.target.type !== 'checkbox') {
                        const checkbox = this.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                        // 触发change事件
                        const event = new Event('change');
                        checkbox.dispatchEvent(event);
                    }
                });

                // 绑定复选框事件
                const newCheckbox = employeeItem.querySelector('input[type="checkbox"]');
                newCheckbox.addEventListener('change', function() {
                    const employeeItem = this.closest('.employee-item');
                    if (this.checked) {
                        selectedEmployeeIds.add(this.value);
                        employeeItem.classList.add('selected');
                        // 选中员工: ${this.value}
                    } else {
                        selectedEmployeeIds.delete(this.value);
                        employeeItem.classList.remove('selected');
                        // 取消选中员工: ${this.value}
                    }
                });

                // 初始化未选中状态
                // 添加员工: ${empId}
            });

            hideAddEmployeeModal();
        }

        // 确认记工
        function confirmWorkRecord() {
            // 获取表单数据
            const workTypeRadio = document.querySelector('input[name="workType"]:checked');
            
            // 验证工作类型是否已选择
            if (!workTypeRadio) {
                showNotification('请选择工作类型（点工/包工/工量）', true);
                return;
            }
            
            const workType = workTypeRadio.value;
            const projectName = document.getElementById('projectName').value;
            const workDate = document.getElementById('workDate').value;
            const remark = document.getElementById('remark').value;

            // 验证必填项 - 增强的数据验证逻辑
            if (!projectName) {
                showNotification('请选择项目名称', true);
                return;
            }
            if (!workDate) {
                showNotification('请选择记工日期', true);
                return;
            }
            if (selectedEmployeeIds.size === 0) {
                showNotification('请选择员工', true);
                return;
            }

            // 构建基础记工数据 - 与系统其他部分保持一致的数据结构
            // 获取选中员工的完整信息（工号、姓名、单价）
            const selectedEmployees = Array.from(selectedEmployeeIds).map(employeeId => {
                const employee = employees.find(emp => emp.employee_id === employeeId);
                if (employee) {
                    return {
                        employeeId: employee.employee_id,
                        employeeName: employee.姓名,
                        unitPrice: employee.工价 || 0
                    };
                }
                return null;
            }).filter(emp => emp !== null);
            
            // 获取当前登录账号
            let loggedInPhone = localStorage.getItem('loggedInPhone');
            if (!loggedInPhone && window.location.hostname === 'localhost') {
                loggedInPhone = '13800138000';
            }
            
            const workRecord = {
                date: workDate,
                project: projectName,
                type: workType,
                employees: selectedEmployees,
                remark: remark,
                timestamp: new Date().toISOString(),
                // 添加额外的标识字段以支持数据同步
                recordType: 'attendance',
                source: 'web',
                syncStatus: 'pending',
                // 添加登录账号信息
                phone: loggedInPhone
            };

            // 根据不同的工作类型处理不同的字段 - 增强的数据处理逻辑
            try {
                if (workType === '点工') {
                    // 点工模式 - 处理上班和加班
                    // 获取点工选项值 - 优先检查按钮状态，而不是隐藏的单选按钮
                    let dayWorkOption = null;
                    
                    // 首先检查1个工按钮是否被选中
                    const dayWork1Btn = document.getElementById('dayWork1');
                    console.log('dayWork1Btn:', dayWork1Btn);
                    if (dayWork1Btn) {
                        console.log('dayWork1Btn.classList:', dayWork1Btn.classList.toString());
                        console.log('dayWork1Btn.data-value:', dayWork1Btn.getAttribute('data-value'));
                        const editableNumber = dayWork1Btn.querySelector('.editable-number');
                        if (editableNumber) {
                            console.log('editableNumber.textContent:', editableNumber.textContent);
                        }
                    }
                    
                    if (dayWork1Btn && dayWork1Btn.classList.contains('active')) {
                        // 获取1个工按钮的实际值（可能是修改后的值）
                        const actualValue = dayWork1Btn.getAttribute('data-value');
                        console.log('actualValue:', actualValue);
                        if (actualValue) {
                            dayWorkOption = actualValue;
                        }
                    }
                    
                    // 如果1个工按钮未被选中，检查其他按钮
                    if (!dayWorkOption) {
                        const dayWorkChecked = document.querySelector('input[name="dayWork"]:checked');
                        dayWorkOption = dayWorkChecked ? dayWorkChecked.value : null;
                        
                        // 检查是否是选小时模式（隐藏单选按钮被选中）
                        if (dayWorkChecked && dayWorkChecked.id === 'hiddenRadioHours') {
                            // 获取实际选中的小时数
                            const dayWorkHoursContainer = document.getElementById('dayWorkHours');
                            const actualHours = dayWorkHoursContainer ? dayWorkHoursContainer.getAttribute('data-value') : null;
                            if (actualHours) {
                                dayWorkOption = actualHours; // 使用实际小时数而不是'hours'
                            }
                        }
                    }
                    
                    // 读取当前项目设置的小时/天（本地存储中）
                    const currentProjectNameForCalc = document.getElementById('projectName').value;
                    let regularHoursPerDay = 8;
                    let overtimeHoursPerDay = 0;
                    try {
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key && key.startsWith('project_data_')) {
                                const val = localStorage.getItem(key);
                                if (!val) continue;
                                const proj = JSON.parse(val);
                                if (proj && proj.name === currentProjectNameForCalc) {
                                    if (typeof proj.regularHours === 'number') regularHoursPerDay = proj.regularHours;
                                    else if (proj.regularHours) regularHoursPerDay = parseFloat(proj.regularHours) || 8;
                                    if (typeof proj.overtimeHours === 'number') overtimeHoursPerDay = proj.overtimeHours;
                                    else if (proj.overtimeHours) overtimeHoursPerDay = parseFloat(proj.overtimeHours) || 0;
                                    break;
                                }
                            }
                        }
                    } catch (e) {
                        console.warn('读取项目小时设置失败，使用默认值', e);
                    }
                    
                    // 记录点工选项卡页面中的上班时间，仅记录被选中的按钮值
                    workRecord.workDetails = {
                        workType: '点工',
                        上班时间: {}
                    };
                    
                    // 若未选择“1个工/半个工/选小时”，但“上下午”设置了有效值，则以“上下午”作为上班依据
                    if (!dayWorkOption) {
                        try {
                            if (window.morningAfternoonData) {
                                const m = morningAfternoonData.morning || { type: 'rest', value: '' };
                                const a = morningAfternoonData.afternoon || { type: 'rest', value: '' };
                                const mDays = m.type === 'work' && m.value ? parseFloat(m.value) : 0;
                                const aDays = a.type === 'work' && a.value ? parseFloat(a.value) : 0;
                                const mHours = m.type === 'hours' && m.value ? parseFloat(m.value) : 0;
                                const aHours = a.type === 'hours' && a.value ? parseFloat(a.value) : 0;
                                const totalDaysFromWork = (isNaN(mDays) ? 0 : mDays) + (isNaN(aDays) ? 0 : aDays);
                                const totalHoursFromHours = (isNaN(mHours) ? 0 : mHours) + (isNaN(aHours) ? 0 : aHours);
                                const totalHours = totalDaysFromWork * regularHoursPerDay + totalHoursFromHours;
                                const totalDays = totalDaysFromWork + (regularHoursPerDay > 0 ? (totalHoursFromHours / regularHoursPerDay) : (totalHoursFromHours / 8));
                                if (totalHours > 0 || totalDays > 0) {
                                    // 采用“上下午”结果作为 dayWorkOption 与工时
                                    dayWorkOption = totalDays.toString();
                                    workRecord.dayWorkOption = dayWorkOption;
                                    workRecord.workDays = totalDays;
                                    workRecord.hours = totalHours;
                                }
                            }
                        } catch (e) {
                            console.warn('上下午数据处理失败', e);
                        }
                    }
                    
                    // 通用处理：如果为数字（包含'1'、'0.5'以及可编辑的'3'等），按"X个工；Y小时"记录
                    const numericOption = parseFloat(dayWorkOption);
                    if (dayWorkOption === 'period') {
                        // 来自上下午的数据
                        let totalDaysFromWork = 0;
                        let totalHoursFromHours = 0;
                        if (window.morningAfternoonData) {
                            const m = morningAfternoonData.morning || { type: 'rest', value: '' };
                            const a = morningAfternoonData.afternoon || { type: 'rest', value: '' };
                            const mDays = m.type === 'work' && m.value ? parseFloat(m.value) : 0;
                            const aDays = a.type === 'work' && a.value ? parseFloat(a.value) : 0;
                            const mHours = m.type === 'hours' && m.value ? parseFloat(m.value) : 0;
                            const aHours = a.type === 'hours' && a.value ? parseFloat(a.value) : 0;
                            totalDaysFromWork = (isNaN(mDays) ? 0 : mDays) + (isNaN(aDays) ? 0 : aDays);
                            totalHoursFromHours = (isNaN(mHours) ? 0 : mHours) + (isNaN(aHours) ? 0 : aHours);
                        }
                        const totalHours = totalDaysFromWork * regularHoursPerDay + totalHoursFromHours;
                        const totalDays = totalDaysFromWork + (regularHoursPerDay > 0 ? (totalHoursFromHours / regularHoursPerDay) : (totalHoursFromHours / 8));
                        workRecord.workDays = totalDays;
                        workRecord.hours = totalHours;
                        // 将计算出来的值写入regular_hours
                        workRecord.regularHours = totalHours;
                        // 保存显示文本
                        const btnEl = document.getElementById('morningAfternoonBtn');
                        if (btnEl) {
                            const btnText = (btnEl.textContent || '').trim();
                            if (btnText && btnText !== '上下午') {
                                workRecord.workDetails.上班时间.上下午 = btnText;
                                workRecord.periodText = btnText;
                                // 将上下午的文本写入work_time
                                workRecord.work_time = btnText;
                            }
                        }
                    } else if (!isNaN(numericOption) && numericOption > 0 && !document.getElementById('hiddenRadioHours').checked) {
                        // 只有在不是选小时模式时，才将数字作为工数处理
                        const isHalf = numericOption === 0.5;
                        // 对于1个工按钮，使用按钮的实际显示值而不是dayWorkOption
                        let workText = isHalf ? '半个工' : `${numericOption}个工`;
                        
                        // 如果是1个工按钮被选中，使用按钮的实际显示值
                        if (dayWork1Btn && dayWork1Btn.classList.contains('active')) {
                            const editableNumber = dayWork1Btn.querySelector('.editable-number');
                            if (editableNumber) {
                                const actualValue = editableNumber.textContent;
                                console.log('Setting workText from editableNumber:', actualValue);
                                workText = `${actualValue}个工`;
                            }
                        }
                        
                        console.log('Final workText:', workText);
                        console.log('Final numericOption:', numericOption);
                        
                        workRecord.workDetails.上班时间.工数 = workText;
                        workRecord.workDays = numericOption;
                        workRecord.hours = numericOption * regularHoursPerDay; // Y = X * 点工 小时/天
                        // 将计算出来的值写入regular_hours
                        workRecord.regularHours = workRecord.hours;
                        // 将工数文本写入work_time
                        workRecord.work_time = workText;
                    } else if (dayWorkOption === 'hours' || (!isNaN(parseFloat(dayWorkOption)) && parseFloat(dayWorkOption) > 0 && document.getElementById('hiddenRadioHours') && document.getElementById('hiddenRadioHours').checked)) {
                        // 选小时：优先从上班区域的小时选择器读取
                        const hoursInputEl = document.querySelector('#dayWorkHours .hours-input');
                        let hoursText = hoursInputEl ? hoursInputEl.value : '';
                        if (!hoursText || hoursText === '选小时') {
                            // 退回到自由输入框（如果使用了该输入）
                            // 已删除workHours元素，仅使用hoursText
                        }
                        const match = hoursText && hoursText.match(/^(\d+(?:\.\d+)?)小时$/);
                        if (!match) {
                            // 此处若“上下午”已经提供小时数，则允许通过
                            try {
                                if (window.morningAfternoonData) {
                                    const m = morningAfternoonData.morning || { type: 'rest', value: '' };
                                    const a = morningAfternoonData.afternoon || { type: 'rest', value: '' };
                                    const mHours = m.type === 'hours' && m.value ? parseFloat(m.value) : 0;
                                    const aHours = a.type === 'hours' && a.value ? parseFloat(a.value) : 0;
                                    const totalHoursFromHours = (isNaN(mHours) ? 0 : mHours) + (isNaN(aHours) ? 0 : aHours);
                                    const totalDaysFromWork = 0; // 仅针对 hours 分支
                                    if (totalHoursFromHours > 0) {
                                        workRecord.workDetails.上班时间.小时数 = `${totalHoursFromHours}小时`;
                                        // 当用户选择"选小时"时，直接使用小时数，不转换为工数
                                        workRecord.workDays = 0; // 不使用工数概念
                                        workRecord.hours = totalHoursFromHours;
                                        // 将计算出来的值写入regular_hours
                                        workRecord.regularHours = totalHoursFromHours;
                                        // 将小时数文本写入work_time
                                        workRecord.work_time = `${totalHoursFromHours}小时`;
                                    } else {
                                        showNotification('请选择上班方式或设置上/下班时长', true);
                                        return;
                                    }
                                } else {
                                    showNotification('请选择上班方式或设置上/下班时长', true);
                                    return;
                                }
                            } catch (e) {
                                showNotification('请选择上班方式或设置上/下班时长', true);
                                return;
                            }
                        } else {
                            const hoursValue = parseFloat(match[1]);
                            if (hoursValue <= 0 || hoursValue > 24) {
                                showNotification('上班小时数必须在0-24之间', true);
                                return;
                            }
                            workRecord.workDetails.上班时间.小时数 = `${hoursValue}小时`;
                            // 使用项目配置的“点工 小时/天”进行换算
                            workRecord.workDays = 0; // 当用户选择"选小时"时，直接使用小时数，不转换为工数
                            workRecord.hours = hoursValue;
                            // 将计算出来的值写入regular_hours
                            workRecord.regularHours = hoursValue;
                            // 将小时数文本写入work_time
                            workRecord.work_time = `${hoursValue}小时`;
                        }
                    } else if (dayWorkOption === 'rest') {
                        // 休息
                        workRecord.workDetails.上班时间.休息 = '是';
                        workRecord.workDays = 0;
                        workRecord.hours = 0;
                    }
                    
                    // 上下午：如果用户实际选择了上/下午具体值，则记录；否则不写入该字段
                    try {
                        if (window.morningAfternoonData) {
                            const hasRealMorning = (morningAfternoonData.morning.type === 'work' && morningAfternoonData.morning.value) ||
                                                  (morningAfternoonData.morning.type === 'hours' && morningAfternoonData.morning.value) ||
                                                  (morningAfternoonData.morning.type === 'rest');
                            const hasRealAfternoon = (morningAfternoonData.afternoon.type === 'work' && morningAfternoonData.afternoon.value) ||
                                                    (morningAfternoonData.afternoon.type === 'hours' && morningAfternoonData.afternoon.value) ||
                                                    (morningAfternoonData.afternoon.type === 'rest');
                            if (hasRealMorning || hasRealAfternoon) {
                                const formatText = (pd) => {
                                    if (pd.type === 'rest') return '休息';
                                    if (pd.type === 'work') return pd.value ? ((pd.value === '0.5' ? '半' : pd.value) + '个工') : '输入工';
                                    if (pd.type === 'hours') return pd.value ? (pd.value + '小时') : '选小时';
                                    return '';
                                };
                                const morningText = formatText(morningAfternoonData.morning);
                                const afternoonText = formatText(morningAfternoonData.afternoon);
                                const periodTextFromData = `上午${morningText}-下午${afternoonText}`;
                                workRecord.workDetails.上班时间.上下午 = periodTextFromData;
                                workRecord.periodText = periodTextFromData;
                            } else {
                                // 兜底：直接读取已更新的按钮显示文本
                                const btnEl = document.getElementById('morningAfternoonBtn');
                                if (btnEl) {
                                    const btnText = (btnEl.textContent || '').trim();
                                    if (btnText && btnText !== '上下午') {
                                        workRecord.workDetails.上班时间.上下午 = btnText;
                                        workRecord.periodText = btnText;
                                    }
                                }
                            }
                        }
                    } catch (e) {
                        // 忽略上下午未初始化等情况
                    }
                    
                    // 加班处理：仅在非“无加班”时记录
                    if (window.overtimeData && window.overtimeData.type && window.overtimeData.type !== 'none') {
                        let otHoursValue = 0;
                        if (window.overtimeData.type === 'hours') {
                            otHoursValue = parseFloat(window.overtimeData.value);
                            if (isNaN(otHoursValue) || otHoursValue <= 0 || otHoursValue > 12) {
                                showNotification('加班小时数必须在0-12之间', true);
                                return;
                            }
                        } else if (window.overtimeData.type === 'work') {
                            // 将加班工数换算为加班小时：Y = X × 加班 小时/天
                            const otDays = parseFloat(window.overtimeData.value);
                            if (isNaN(otDays) || otDays <= 0 || otDays > 10) {
                                showNotification('加班工数必须在0-10之间', true);
                                return;
                            }
                            // 从项目缓存中获取正确的加班小时/天设置
                            let correctOvertimeHoursPerDay = 0;
                            try {
                                const userId = JSON.parse(localStorage.getItem('currentUser'))?.user_id || 'default';
                                const projectsData = localStorage.getItem('project_cache_' + userId);
                                if (projectsData) {
                                    const projects = JSON.parse(projectsData);
                                    const currentProject = projects.find(p => p.project_id === workRecord.projectId);
                                    if (currentProject) {
                                        correctOvertimeHoursPerDay = parseFloat(currentProject.overtime_hours) || 0;
                                    }
                                }
                            } catch (error) {
                                console.error('获取项目加班小时设置失败:', error);
                            }
                            // 仅使用项目设置的加班小时/天，不使用默认值
                            otHoursValue = otDays * correctOvertimeHoursPerDay;
                        } else {
                            // 其他类型（如金额）在点工模式不记录加班小时
                            otHoursValue = 0;
                        }
                        if (otHoursValue > 0) {
                            workRecord.overtime = true;
                            workRecord.overtimeHours = otHoursValue;
                            // 记录加班工数（若来源为工）以便提示展示
                            if (window.overtimeData.type === 'work') {
                                const otDays = parseFloat(window.overtimeData.value);
                                workRecord.overtimeDays = otDays;
                                const daysText = (otDays === 0.5) ? '半个工' : `${otDays}个工`;
                                // 按按钮上的实际文本保存，不添加计算出来的小时数
                                workRecord.workDetails.加班 = daysText;
                            } else {
                                // 来源为小时
                                // 同时计算折算工数用于后续展示（非必需）
                                // 从项目缓存中获取正确的加班小时/天设置
                                let correctOvertimeHoursPerDay = 0;
                                try {
                                    const userId = JSON.parse(localStorage.getItem('currentUser'))?.user_id || 'default';
                                    const projectsData = localStorage.getItem('project_cache_' + userId);
                                    if (projectsData) {
                                        const projects = JSON.parse(projectsData);
                                        const currentProject = projects.find(p => p.project_id === workRecord.projectId);
                                        if (currentProject) {
                                            correctOvertimeHoursPerDay = parseFloat(currentProject.overtime_hours) || 0;
                                        }
                                    }
                                } catch (error) {
                                    console.error('获取项目加班小时设置失败:', error);
                                }
                                // 仅使用项目设置的加班小时/天，不使用默认值
                                workRecord.overtimeDays = (correctOvertimeHoursPerDay > 0) ? otHoursValue / correctOvertimeHoursPerDay : 0;
                                workRecord.workDetails.加班 = `${otHoursValue}小时`;
                            }
                        } else {
                            workRecord.overtime = false;
                        }
                    }
                    
                    // 将加班信息添加到work_time字段中
                    if (workRecord.overtime && workRecord.workDetails.加班) {
                        // 如果有加班，将加班信息添加到work_time字段中
                        if (workRecord.work_time) {
                            // 如果已经有work_time，在后面添加/和加班信息
                            workRecord.work_time += `/加班${workRecord.workDetails.加班}`;
                        } else {
                            // 如果没有work_time，直接设置为加班信息
                            workRecord.work_time = `加班${workRecord.workDetails.加班}`;
                        }
                    }
                    
                    // 备注
                    workRecord.workDetails.备注 = remark;
                    
                    // 图片信息 - 使用压缩后的图片
                    if (window.selectedImages && window.selectedImages.length > 0) {
                        workRecord.hasImage = true;
                        workRecord.imageCount = window.selectedImages.length;
                        workRecord.workDetails.图片数量 = window.selectedImages.length;
                        workRecord.images = Array.from(window.selectedImages); // 使用压缩后的图片文件对象
                    }
                } else if (workType === '包工') {
                    // 包工模式 - 处理金额
                    const amountInput = document.getElementById('amountInput');
                    if (!amountInput) {
                        showNotification('未找到金额输入框', true);
                        return;
                    }
                    
                    const amount = amountInput.value;
                    if (!amount || isNaN(parseFloat(amount))) {
                        showNotification('请输入有效的金额', true);
                        return;
                    }
                    const amountValue = parseFloat(amount);
                    if (amountValue <= 0) {
                        showNotification('金额必须大于0', true);
                        return;
                    }
                    workRecord.amount = amountValue;
                    workRecord.hours = 8; // 包工默认8小时
                    
                    // 记录包工选项卡页面信息
                    workRecord.workDetails = {
                        workType: '包工',
                        金额: amountValue,
                        备注: remark,
                        图片数量: 0
                    };
                    
                    // 图片信息 - 使用压缩后的图片
                    if (window.selectedImages && window.selectedImages.length > 0) {
                        workRecord.hasImage = true;
                        workRecord.imageCount = window.selectedImages.length;
                        workRecord.workDetails.图片数量 = window.selectedImages.length;
                        workRecord.images = Array.from(window.selectedImages); // 使用压缩后的图片文件对象
                    }
                } else if (workType === '工量') {
                    // 工量模式 - 处理分项、工量、单价、工钱
                    const currentSubProject = document.getElementById('currentSubProject');
                    const workQuantityInput = document.getElementById('workAmountInput');
                    const unitPriceInput = document.getElementById('unitPriceInput');
                    const totalPriceInput = document.getElementById('totalPriceInput');
                    
                    if (!currentSubProject || !workQuantityInput || !unitPriceInput || !totalPriceInput) {
                        showNotification('未找到工量相关输入框', true);
                        return;
                    }
                    
                    const workItem = currentSubProject.textContent;
                    const workQuantity = workQuantityInput.value;
                    const unitPrice = unitPriceInput.value;
                    const totalPrice = totalPriceInput.value;
                    
                    if (workItem === '请选择分项') {
                        showNotification('请选择分项', true);
                        return;
                    }
                    if (!workQuantity || isNaN(parseFloat(workQuantity))) {
                        showNotification('请输入有效的工量', true);
                        return;
                    }
                    if (!unitPrice || isNaN(parseFloat(unitPrice))) {
                        showNotification('请输入有效的单价', true);
                        return;
                    }
                    if (!totalPrice || isNaN(parseFloat(totalPrice))) {
                        showNotification('请输入有效的工钱', true);
                        return;
                    }
                    
                    const quantityValue = parseFloat(workQuantity);
                    const priceValue = parseFloat(unitPrice);
                    const totalValue = parseFloat(totalPrice);
                    
                    if (quantityValue <= 0 || priceValue <= 0 || totalValue <= 0) {
                        showNotification('工量、单价和工钱必须大于0', true);
                        return;
                    }
                    
                    // 验证工钱计算的准确性
                    const calculatedTotal = parseFloat((quantityValue * priceValue).toFixed(2));
                    if (Math.abs(calculatedTotal - totalValue) > 0.01) {
                        showNotification('工钱计算不正确，请重新计算', true);
                        return;
                    }
                    
                    workRecord.workItem = workItem;
                    workRecord.workQuantity = quantityValue;
                    workRecord.unitPrice = priceValue;
                    workRecord.contractAmount = totalValue;
                    workRecord.hours = 8; // 工量默认8小时
                    
                    // 记录工量选项卡页面信息
                    workRecord.workDetails = {
                        workType: '工量',
                        分项: workItem,
                        工量: quantityValue,
                        单价: priceValue,
                        工钱: totalValue,
                        备注: remark,
                        图片数量: 0
                    };
                    
                    // 图片信息 - 使用压缩后的图片
                    if (window.selectedImages && window.selectedImages.length > 0) {
                        workRecord.hasImage = true;
                        workRecord.imageCount = window.selectedImages.length;
                        workRecord.workDetails.图片数量 = window.selectedImages.length;
                        workRecord.images = Array.from(window.selectedImages); // 使用压缩后的图片文件对象
                    }
                }
            } catch (dataError) {
                showNotification('数据处理错误，请检查输入', true);
                return;
            }

            // 显示确认模态框 - 增强用户体验
            showConfirmModal('确认记工', getConfirmationMessage(workRecord), async () => {
                try {
                    // 保存记工记录 - 增强的错误处理
                    showNotification('正在保存记工记录...', false);
                    
                    const success = await saveWorkRecord(workRecord);
                    
                    if (success) {
                        showNotification('记工成功', false);
                        // 重置表单
                        resetForm();
                        
                        // 刷新员工列表
                        const currentProjectName = document.getElementById('projectName').value;
                        await loadEmployeeData(currentProjectName);
                        
                        // 在实际应用中，这里可以添加记录成功的回调
                        console.log('记工流程完成，表单已重置');
                    } else {
                        showNotification('记工失败，请重试', true);
                    }
                } catch (saveError) {
                    console.error('保存记工记录时出现异常:', saveError);
                    showNotification(`记工失败: ${saveError.message || '未知错误'}`, true);
                }
            });
            
            // 生成确认消息函数
            function getConfirmationMessage(record) {
                // 获取记工日期输入框的显示文本
                let dateDisplayText = record.date;
                const workDateInput = document.getElementById('workDate');
                if (workDateInput) {
                    const dateDisplay = document.getElementById('dateDisplay');
                    if (dateDisplay) {
                        // 使用日期显示区域的innerHTML作为显示文本
                        dateDisplayText = dateDisplay.innerHTML.replace('<span class="today-text">（今天）</span>', '（今天）');
                    } else {
                        // 如果没有显示区域，格式化日期
                        dateDisplayText = formatDateForDisplay(record.date);
                        // 检查是否为今天
                        const today = new Date();
                        const yyyy = today.getFullYear();
                        const mm = String(today.getMonth() + 1).padStart(2, '0');
                        const dd = String(today.getDate()).padStart(2, '0');
                        const formattedToday = `${yyyy}-${mm}-${dd}`;
                        if (record.date === formattedToday) {
                            dateDisplayText += '（今天）';
                        }
                    }
                } else {
                    // 默认格式化
                    dateDisplayText = formatDateForDisplay(record.date);
                }
                
                let message = `项目名称: ${record.project}\n记工日期: ${dateDisplayText}\n员工数量: ${record.employees.length}\n类型: ${record.type}`;
                

                
                // 根据工作类型显示上班和加班信息
                if (record.type === '点工') {
                    // 获取当前项目的工时配置
                    let regularHoursPerDay = 8; // 默认值
                    let overtimeHoursPerDay = 0; // 默认值
                    
                    try {
                        // 从localStorage获取项目数据
                        const userId = JSON.parse(localStorage.getItem('currentUser'))?.user_id || 'default';
                        const projectsData = localStorage.getItem('project_cache_' + userId);
                        if (projectsData) {
                            const projects = JSON.parse(projectsData);
                            const currentProject = projects.find(p => p.project_id === record.projectId);
                            if (currentProject) {
                                regularHoursPerDay = parseFloat(currentProject.regular_hours) || 8;
                                overtimeHoursPerDay = parseFloat(currentProject.overtime_hours) || 0;
                            }
                        }
                    } catch (error) {
                        console.error('获取项目配置失败:', error);
                    }
                    
                    // 优先使用记录中的“上班时间”细节，避免 undefined
                    const workTime = record.workDetails && record.workDetails.上班时间 ? record.workDetails.上班时间 : null;
                    const periodText = (record.periodText) || (workTime && workTime.上下午) || (record.workDetails && record.workDetails.上下午) || '';
                    const isRest = workTime && workTime.休息 === '是';
                    const hasGongShu = workTime && workTime.工数; // 如 '半个工'、'3个工'
                    const hasHourText = workTime && workTime.小时数; // 如 '6小时'
                    
                    if (periodText) {
                        message += `\n上班: ${periodText}`;
                    } else if (isRest) {
                        message += `\n上班: 休息`;
                    } else if (hasGongShu) {
                        // 计算转换后的小时数
                        let convertedHours = 0;
                        if (workTime.工数.includes('半个工')) {
                            convertedHours = 0.5 * regularHoursPerDay;
                        } else {
                            const daysValue = parseFloat(workTime.工数.replace('个工', '')) || 1;
                            convertedHours = daysValue * regularHoursPerDay;
                        }
                        message += `\n上班: ${workTime.工数}；${convertedHours}小时`;
                    } else if (hasHourText) {
                        // 直接显示小时数，不转换为工数
                        message += `\n上班: ${workTime.小时数}`;
                    } else {
                        // 回退到 dayWorkOption 逻辑（保持兼容），依然确保不出现 undefined
                        const numericOption = parseFloat(record.dayWorkOption);
                        if (!isNaN(numericOption) && numericOption > 0) {
                            // 检查是否是选小时模式
                            const isHoursMode = record.dayWorkOption === 'hours' || 
                                              (document.getElementById('hiddenRadioHours') && 
                                               document.getElementById('hiddenRadioHours').checked);
                            
                            if (isHoursMode) {
                                // 选小时模式：直接显示小时数，不转换为工数
                                const hoursText = (typeof record.hours === 'number' && !isNaN(record.hours)) ? `${record.hours}小时` : `${numericOption}小时`;
                                message += `\n上班: ${hoursText}`;
                            } else {
                                // 工数模式：显示工数和转换后的小时数
                                const isHalf = numericOption === 0.5;
                                const workText = isHalf ? '半个工' : `${numericOption}个工`;
                                const convertedHours = numericOption * regularHoursPerDay;
                                message += `\n上班: ${workText}；${convertedHours}小时`;
                            }
                        } else if (record.dayWorkOption === 'period') {
                            // 来自上下午
                            const periodText = (record.periodText) || (record.workDetails && record.workDetails.上班时间 && record.workDetails.上班时间.上下午) || '';
                            message += `\n上班: ${periodText || '未设置'}`;
                        } else if (record.dayWorkOption === 'hours') {
                            // 直接显示小时数，不转换为工数
                            const hoursText = (typeof record.hours === 'number' && !isNaN(record.hours)) ? `${record.hours}小时` : '未设置';
                            message += `\n上班: ${hoursText}`;
                        } else if (record.dayWorkOption === 'rest') {
                            message += `\n上班: 休息`;
                        } else {
                            message += `\n上班: 未设置`;
                        }
                    }
                    if (record.overtime) {
                        // 根据加班按钮的实际显示状态来决定提示信息的显示方式
                        // 检查是否存在加班详情信息
                        if (record.workDetails && record.workDetails.加班) {
                            const overtimeText = record.workDetails.加班;
                            if (overtimeText.includes('个工')) {
                                // 提取加班工数，重新计算正确的小时数
                                let overtimeDays = 0;
                                if (overtimeText.includes('半个工')) {
                                    overtimeDays = 0.5;
                                } else {
                                    // 提取工数，忽略已有的小时数
                                    const daysMatch = overtimeText.match(/([0-9.]+)个工/);
                                    if (daysMatch && daysMatch[1]) {
                                        overtimeDays = parseFloat(daysMatch[1]) || 0;
                                    }
                                }
                                
                                // 计算转换后的加班小时数
                                let convertedOvertimeHours = overtimeDays * overtimeHoursPerDay;
                                
                                // 构建正确的加班文本
                                const daysText = (overtimeDays === 0.5) ? '半个工' : `${overtimeDays}个工`;
                                message += `\n加班: ${daysText}；${convertedOvertimeHours}小时`;
                            } else {
                                message += `\n加班: ${overtimeText}`;
                            }
                        } else if (window.overtimeData) {
                            // 根据window.overtimeData.type来判断显示方式
                            if (window.overtimeData.type === 'work') {
                                // 显示为"？个工"时，提示信息显示为："？个工；？小时"
                                const daysValue = parseFloat(window.overtimeData.value);
                                const daysText = (daysValue === 0.5) ? '半个工' : `${daysValue}个工`;
                                // 计算转换后的加班小时数
                                const convertedOvertimeHours = daysValue * overtimeHoursPerDay;
                                message += `\n加班: ${daysText}；${convertedOvertimeHours}小时`;
                            } else if (window.overtimeData.type === 'hours') {
                                // 显示为"？小时"时，提示信息只显示为："？小时"
                                const hoursValue = parseFloat(window.overtimeData.value);
                                message += `\n加班: ${hoursValue}小时`;
                            } else {
                                // 其他情况，使用原来的逻辑
                                if (typeof record.overtimeHours === 'number' && record.overtimeHours > 0 && !isNaN(record.overtimeHours)) {
                                    message += `\n加班: ${record.overtimeHours}小时`;
                                }
                            }
                        } else {
                            // 没有window.overtimeData信息时，使用原来的逻辑
                            if (typeof record.overtimeHours === 'number' && record.overtimeHours > 0 && !isNaN(record.overtimeHours)) {
                                message += `\n加班: ${record.overtimeHours}小时`;
                            }
                        }
                    }
                } else if (record.type === '包工') {
                    message += `\n金额: ${record.amount}元`;
                } else if (record.type === '工量') {
                    // 工量模式下显示详细信息
                    message += `\n分项: ${record.workItem}`;
                    
                    // 获取工量单位
                    let workAmountUnit = '';
                    const workAmountUnitElement = document.getElementById('workAmountUnit');
                    if (workAmountUnitElement) {
                        workAmountUnit = workAmountUnitElement.textContent;
                    }
                    message += `\n工量: ${record.workQuantity} ${workAmountUnit}`;
                    
                    // 获取单价单位
                    let unitPriceUnit = '元';
                    const unitPriceUnitElement = document.getElementById('unitPriceUnit');
                    if (unitPriceUnitElement) {
                        unitPriceUnit = unitPriceUnitElement.textContent || '元';
                    }
                    message += `\n单价: ${record.unitPrice} ${unitPriceUnit}`;
                    
                    message += `\n工钱: ${record.contractAmount}元`;
                    // 移除原来的"上班"行，因为已经在上面显示了详细信息
                }
                
                if (record.remark) {
                    message += `\n备注: ${record.remark}`;
                }
                
                if (record.hasImage) {
                    message += `\n图片: ${record.imageCount || 1}张`;
                }
                
                message += '\n\n确认保存此记工记录吗？';
                return message;
            }
        }

        // 保存记工记录 - 使用本地存储实现数据持久化
        async function saveWorkRecord(workRecord) {
            try {
                console.log('开始保存记工记录:', workRecord);
                
                // 获取用户信息
                let phone = localStorage.getItem('loggedInPhone');
                if (!phone && window.location.hostname === 'localhost') {
                    phone = '13800138000';
                    console.log('测试环境：使用测试手机号:', phone);
                }
                
                if (!phone) {
                    throw new Error('未找到用户信息');
                }
                
                // 获取当前项目的配置信息
                let regularHoursPerDay = 8; // 默认值
                let overtimeHoursPerDay = 0; // 默认值
                
                try {
                    // 从localStorage获取项目数据
                    const userId = JSON.parse(localStorage.getItem('currentUser'))?.user_id || 'default';
                    const projectsData = localStorage.getItem('project_cache_' + userId);
                    if (projectsData) {
                        const projects = JSON.parse(projectsData);
                        const currentProject = projects.find(p => p.project_id === workRecord.projectId);
                        if (currentProject) {
                            regularHoursPerDay = parseFloat(currentProject.regular_hours) || 8;
                            overtimeHoursPerDay = parseFloat(currentProject.overtime_hours) || 0;
                        }
                    }
                } catch (error) {
                    console.error('获取项目配置失败:', error);
                }
                
                // 上传图片到Supabase存储
                let imageUrls = [];
                if (workRecord.images && workRecord.images.length > 0) {
                    console.log('开始上传图片到Supabase...');
                    imageUrls = await uploadImagesToSupabase(workRecord.images);
                    console.log('图片上传成功，URLs:', imageUrls);
                }
                
                // 检查网络状态
                const isOnline = navigator.onLine;
                let hasSupabaseError = false;
                let supabaseErrorMessage = '';
                
                // 构建所有员工的记录数据
                const attendanceRecords = [];
                
                for (const employee of workRecord.employees) {
                    // 计算工时转换
                    let regular_hours = 0;
                    let overtime_hours = 0;
                    
                    // 处理点工类型的工时转换
                    if (workRecord.type === '点工') {
                        // 处理上班工时
                        if (workRecord.workDetails?.休息 === '是') {
                            // 选择休息，不上传regular_hours
                            regular_hours = null;
                        } else {
                            // 计算工数
                            let workDays = 0;
                            if (workRecord.workDetails?.上班时间?.工数) {
                                const workTimeText = workRecord.workDetails.上班时间.工数;
                                if (workTimeText.includes('半个工')) {
                                    workDays = 0.5;
                                } else {
                                    workDays = parseFloat(workTimeText.replace('个工', '')) || 1;
                                }
                            } else if (workRecord.workDetails?.工数) {
                                const workTimeText = workRecord.workDetails.工数;
                                if (workTimeText.includes('半个工')) {
                                    workDays = 0.5;
                                } else {
                                    workDays = parseFloat(workTimeText.replace('个工', '')) || 1;
                                }
                            } else if (workRecord.workDetails?.上班时间?.小时数) {
                                // 处理"选小时"的情况，直接使用小时数，不转换为工数
                                workDays = 0;
                                regular_hours = parseFloat(workRecord.workDetails.上班时间.小时数.replace('小时', '')) || 0;
                            }
                            
                            // 如果已经有小时数（来自"选小时"），则使用它；否则转换为小时数：1个工 = regular_hours
                            if (!regular_hours) {
                                regular_hours = workDays * regularHoursPerDay;
                            }
                        }
                        
                        // 处理加班工时
                        if (workRecord.workDetails?.加班) {
                            const overtimeText = workRecord.workDetails.加班;
                            let overtimeDays = 0;
                            
                            if (overtimeText.includes('半个工')) {
                                overtimeDays = 0.5;
                            } else if (overtimeText.includes('个工')) {
                                overtimeDays = parseFloat(overtimeText.replace('个工', '')) || 0;
                            }
                            
                            // 转换为小时数：1个工 = overtime_hours
                            overtime_hours = overtimeDays * overtimeHoursPerDay;
                        }
                    }
                    
                    // 构建基础记工记录数据（与Supabase格式一致）
                    const baseData = {
                        phone: phone,
                        project_id: workRecord.projectId,
                        employee_id: employee.employee_id,
                        record_date: workRecord.date || new Date().toISOString().split('T')[0],
                        
                        // 记工核心数据
                        work_type: workRecord.type, // 点工、包工、工量
                        
                        // 图片信息
                        image_ids: imageUrls,
                        
                        // 备注信息
                        remark: workRecord.workDetails?.备注 || null,
                        
                        // 审核状态
                        audit_status: '未审核',
                        
                        // 系统字段
                        created_at: new Date(new Date().getTime() + 8 * 60 * 60 * 1000).toISOString(),
                        updated_at: new Date(new Date().getTime() + 8 * 60 * 60 * 1000).toISOString()
                    };
                    
                    // 根据工作类型构建不同的attendanceData（与Supabase格式一致）
                    let attendanceData = {};
                    
                    if (workRecord.type === '包工') {
                        // 包工模式：只包含包工相关字段
                        attendanceData = {
                            ...baseData,
                            contract_amount: workRecord.workDetails?.金额 || 0,
                            work_time: '金额'
                        };
                    } else if (workRecord.type === '点工') {
                        // 点工模式：只包含点工相关字段
                        attendanceData = {
                            ...baseData,
                            regular_hours: regular_hours,
                            overtime_hours: overtime_hours,
                            work_time: getWorkTime(workRecord)
                        };
                    } else if (workRecord.type === '工量') {
                        // 工量模式：只包含工量相关字段，使用work_time字段
                        attendanceData = {
                            ...baseData,
                            work_time: getWorkTime(workRecord) || null,
                            work_quantity: workRecord.workDetails?.工量 || 0,
                            unit_price: workRecord.workDetails?.单价 || 0,
                            contract_amount: workRecord.workDetails?.工钱 || 0
                        };
                    }
                    
                    // 添加到记录数组
                    attendanceRecords.push({
                        data: attendanceData,
                        record_id: `attendance_${phone}_${employee.employee_id}_${workRecord.date || new Date().toISOString().split('T')[0]}`
                    });
                }
                
                // 如果在线且有Supabase连接，先尝试保存到Supabase
                if (isOnline && window.supabase && typeof window.supabase.from === 'function') {
                    try {
                        console.log('在线模式：尝试保存到Supabase');
                        
                        // 批量插入到Supabase
                        const { data, error } = await window.supabase
                            .from('attendance_records')
                            .insert(attendanceRecords.map(record => record.data));
                        
                        if (error) {
                            console.error('保存到Supabase失败:', error);
                            hasSupabaseError = true;
                            supabaseErrorMessage = error.message;
                        } else {
                            console.log('记工记录已成功保存到Supabase');
                            
                            // 保存到本地存储作为备份
                            for (const record of attendanceRecords) {
                                localStorage.setItem(record.record_id, JSON.stringify(record.data));
                                console.log('保存记工记录到本地存储（备份）:', record.record_id);
                            }
                            
                            // 显示成功消息
                            showNotification('记工数据保存成功！', false);
                            
                            // 保存记工备注历史（如果有）
                            if (workRecord.workDetails?.备注) {
                                await saveRemarkHistory(workRecord.workDetails.备注, phone);
                            }
                            
                            // 记录操作日志
                            await logDatabaseOperation({
                                operation: 'CREATE_ATTENDANCE',
                                table: 'attendance_records',
                                recordCount: workRecord.employees.length,
                                projectId: workRecord.projectId,
                                phone: phone,
                                timestamp: new Date().toISOString()
                            });
                            
                            return true;
                        }
                    } catch (supabaseError) {
                        console.error('Supabase操作异常:', supabaseError);
                        hasSupabaseError = true;
                        supabaseErrorMessage = supabaseError.message;
                    }
                }
                
                // 如果离线或Supabase保存失败，保存到本地并加入同步队列
                console.log('离线模式或Supabase失败：保存到本地存储并加入同步队列');
                
                for (const record of attendanceRecords) {
                    // 保存到本地存储
                    localStorage.setItem(record.record_id, JSON.stringify(record.data));
                    console.log('保存记工记录到本地存储:', record.record_id);
                    
                    // 添加到同步队列
                    if (window.offlineSyncService) {
                        // 生成唯一的记录ID用于同步
                        const syncRecordId = `${record.record_id}_${Date.now()}`;
                        window.offlineSyncService.addToSyncQueue('add', record.data, syncRecordId, 'attendance');
                    }
                }
                
                // 显示离线保存成功消息
                showNotification('记工数据保存到本地（网络恢复后同步）', false);
                
                // 保存记工备注历史（如果有）
                if (workRecord.workDetails?.备注) {
                    await saveRemarkHistory(workRecord.workDetails.备注, phone);
                }
                
                // 记录操作日志
                await logDatabaseOperation({
                    operation: 'CREATE_ATTENDANCE',
                    table: 'attendance_records',
                    recordCount: workRecord.employees.length,
                    projectId: workRecord.projectId,
                    phone: phone,
                    timestamp: new Date().toISOString(),
                    offlineMode: true
                });
                
                return true;
                
            } catch (error) {
                console.error('保存记工记录失败（本地存储版本）:', error);
                showNotification('记工记录保存成功，但数据同步失败', true);
                return true; // 即使同步失败，也返回成功，因为数据已保存到本地
            }
        }
        
        // 上传图片到Supabase存储
        async function uploadImagesToSupabase(images) {
            try {
                // 等待Supabase客户端初始化完成
                const supabase = await waitForSupabase();
                const bucketName = 'FYKQ';
                const folderName = 'attendance';
                const uploadedUrls = [];
                
                for (let i = 0; i < images.length; i++) {
                    const image = images[i];
                    // 生成当前日期格式的文件名
                    const currentDate = new Date();
                    const year = currentDate.getFullYear();
                    const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                    const day = String(currentDate.getDate()).padStart(2, '0');
                    const dateStr = `${year}-${month}-${day}`;
                    
                    // 获取文件扩展名
                    const fileExtension = image.name.split('.').pop();
                    
                    // 生成新的文件名：(当前日期)attendance_序号.后缀
                    const fileName = `${folderName}/${dateStr}attendance_${i + 1}.${fileExtension}`;
                    
                    // 上传图片到Supabase存储
                    const { data, error } = await supabase.storage
                        .from(bucketName)
                        .upload(fileName, image, {
                            cacheControl: '3600',
                            upsert: false
                        });
                    
                    if (error) {
                        console.error('上传图片失败:', error);
                        throw new Error(`上传图片失败: ${error.message}`);
                    }
                    
                    // 获取图片的公共URL
                    const { data: urlData } = await supabase.storage
                        .from(bucketName)
                        .getPublicUrl(fileName);
                    
                    uploadedUrls.push(urlData.publicUrl);
                    console.log('图片上传成功，URL:', urlData.publicUrl);
                }
                
                return uploadedUrls;
            } catch (error) {
                console.error('上传图片到Supabase失败:', error);
                throw error;
            }
        }
        
        // 记录数据库操作日志（已移除数据库依赖）
        async function logDatabaseOperation(logData) {
            try {
                console.log('记录操作日志:', logData);
            } catch (error) {
                console.warn('记录操作日志失败:', error);
            }
        }
        
        // 获取工作状态 - 匹配鱼泡APP的状态定义
        function getWorkStatus(workRecord) {
            if (workRecord.workDetails?.休息 === '是') {
                return 2; // 请假/休息状态
            } else if (workRecord.workDetails?.加班 === '是') {
                return 3; // 加班状态
            } else {
                return 1; // 正常工作状态
            }
        }
        
        // 判断是否为节假日 - 简化实现
        function isHoliday(date) {
            const checkDate = new Date(date);
            const day = checkDate.getDay();
            return day === 0 || day === 6; // 周日或周六
        }
        
        // 获取工作时长 - 格式化为鱼泡APP需要的格式
        function getWorkTime(workRecord) {
            if (workRecord.type === '点工') {
                if (workRecord.workDetails?.工数) {
                    return workRecord.workDetails.工数;
                } else if (workRecord.workDetails?.小时数) {
                    return workRecord.workDetails.小时数;
                } else {
                    return '1个工'; // 默认
                }
            } else {
                return workRecord.workDetails?.工量 || '0';
            }
        }
        
        // 获取星期字符串
        function getWeekString(date) {
            const weekDays = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
            const checkDate = new Date(date);
            return weekDays[checkDate.getDay()];
        }
        
        // 保存到本地缓存 - 模拟鱼泡APP的AccountClockCache
        async function saveToLocalCache(entities, phone) {
            try {
                // 确保dataStorage已初始化
                if (typeof dataStorage === 'undefined' || !dataStorage) {
                    console.log('正在初始化数据存储服务...');
                    if (typeof DataStorageService !== 'undefined') {
                        // 使用已创建的dataStorage实例，避免重复初始化
                    } else {
                        throw new Error('DataStorageService未定义');
                    }
                }
                
                // 为每个员工保存记工记录
                for (const entity of entities) {
                    const cacheKey = `account_clock_${phone}_${entity.date}_${entity.empid}`;
                    localStorage.setItem(cacheKey, JSON.stringify(entity));
                    console.log('保存到本地缓存:', cacheKey);
                }
                
                // 保存记工设置配置
                const configKey = `account_clock_config_${phone}`;
                const configData = {
                    lastSyncTime: new Date().toISOString(),
                    recordCount: entities.length,
                    lastRecordDate: entities[0]?.date
                };
                localStorage.setItem(configKey, JSON.stringify(configData));
                
                return true;
            } catch (error) {
                console.error('保存到本地缓存失败:', error);
                throw error;
            }
        }
        
        // 提交到服务器 - 实现鱼泡APP的API调用和又拍云同步
        async function submitToServer(entities, phone) {
            try {
                console.log('开始提交数据到服务器...');
                
                // 构建API参数 - 匹配鱼泡APP的API结构
                const apiParams = {
                    phone: phone,
                    records: entities.map(entity => ({
                        time: entity.time,
                        week: entity.week,
                        holiday_status: entity.holiday_status,
                        status: entity.status,
                        is_calendar: entity.is_calendar,
                        employee_id: entity.empid,
                        date: entity.date,
                        remark: entity.remark
                    }))
                };
                
                console.log('API提交参数:', apiParams);
                
                // 1. 调用真实的API
                let apiResponse;
                try {
                    const response = await fetch('api/custom_push/add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(apiParams)
                    });
                    apiResponse = await response.json();
                    console.log('API响应:', apiResponse);
                } catch (apiError) {
                    console.warn('API调用失败，继续尝试又拍云同步:', apiError);
                }
                
                // 2. 确保数据同步到数据库
                const dbSyncResult = await syncToDatabase(entities);
                
                // 3. 返回合并的结果
                return {
                    success: (apiResponse?.success === true) || dbSyncResult,
                    message: apiResponse?.message || (dbSyncResult ? '数据已同步到数据库' : '同步失败'),
                    data: apiResponse?.data || { recordIds: entities.map(e => e.id) },
                    dbSynced: dbSyncResult
                };
            } catch (error) {
                console.error('提交到服务器失败:', error);
                // 即使服务器提交失败，本地记录仍然有效
                return {
                    success: false,
                    message: error.message,
                    localSuccess: true,
                    dbSynced: false
                };
            }
        }
        
        // 同步数据到数据库
        async function syncToDatabase(entities) {
            try {
                console.log('开始同步数据到数据库...');
                
                // 为每个实体创建本地存储记录
                let allSuccess = true;
                for (const entity of entities) {
                    console.log(`正在保存到本地存储: ${entity.empid} - ${entity.date}`);
                    
                    try {
                        // 保存数据到本地存储
                        const phone = localStorage.getItem('loggedInPhone') || 'default';
                        const cacheKey = `attendance_${phone}_${entity.empid}_${entity.date}`;
                        localStorage.setItem(cacheKey, JSON.stringify(entity));
                        console.log(`保存成功: ${entity.empid} - ${entity.date}`);
                    } catch (saveError) {
                        console.error(`本地存储保存失败: ${entity.empid} - ${entity.date}`, saveError);
                        allSuccess = false;
                    }
                }
                
                return allSuccess;
            } catch (error) {
                console.error('又拍云同步过程出错:', error);
                return false;
            }
        }
        
        // 更新本地缓存状态
        async function updateLocalCacheStatus(entities, phone) {
            try {
                for (const entity of entities) {
                    const cacheKey = `account_clock_${phone}_${entity.date}_${entity.empid}`;
                    
                    // 获取现有数据
                    const existingDataStr = localStorage.getItem(cacheKey);
                    if (existingDataStr) {
                        try {
                            const existingData = JSON.parse(existingDataStr);
                            // 更新同步状态
                            const updatedData = {
                                ...existingData,
                                sync_status: 1, // 已同步
                                updateTime: new Date().toISOString()
                            };
                            localStorage.setItem(cacheKey, JSON.stringify(updatedData));
                        } catch (parseError) {
                            console.error('解析现有数据失败:', parseError);
                        }
                    }
                }
                
                return true;
            } catch (error) {
                console.error('更新本地缓存状态失败:', error);
                // 不影响主流程
                return false;
            }
        }
        
        // 保存记工备注历史 - 匹配鱼泡APP的ReMarkHistoryKV
        async function saveRemarkHistory(remark, phone) {
            try {
                if (!remark || remark.trim().length === 0) return;
                
                const historyKey = `remark_history_${phone}`;
                // 从本地存储获取历史记录
                let historyList = [];
                const historyStr = localStorage.getItem(historyKey);
                if (historyStr) {
                    try {
                        historyList = JSON.parse(historyStr);
                    } catch (parseError) {
                        console.error('解析备注历史失败:', parseError);
                        historyList = [];
                    }
                }
                
                // 去重并限制数量
                if (!historyList.includes(remark)) {
                    historyList.unshift(remark); // 添加到开头
                    // 只保留最近20条
                    if (historyList.length > 20) {
                        historyList = historyList.slice(0, 20);
                    }
                    // 保存到本地存储
                    localStorage.setItem(historyKey, JSON.stringify(historyList));
                }
                
                return true;
            } catch (error) {
                console.error('保存备注历史失败:', error);
                // 不影响主流程
                return false;
            }
        }
        
        // 更新项目考勤计数（已移除数据库依赖）
        async function updateProjectAttendanceCount(projectName) {
            try {
                // 获取当前项目数据
                const phone = localStorage.getItem('loggedInPhone') || 'default';
                const projectsKey = `projects_${phone}`;
                const projectsStr = localStorage.getItem(projectsKey);
                
                if (projectsStr) {
                    try {
                        const allProjects = JSON.parse(projectsStr);
                        const projectIndex = allProjects.findIndex(p => p.name === projectName || p.project_name === projectName);
                        
                        if (projectIndex !== -1) {
                            // 更新项目考勤计数
                            const updatedProject = {
                                ...allProjects[projectIndex],
                                count: (allProjects[projectIndex].count || 0) + 1,
                                lastModified: new Date().toISOString()
                            };
                            
                            // 保存更新后的项目数据
                            allProjects[projectIndex] = updatedProject;
                            localStorage.setItem(projectsKey, JSON.stringify(allProjects));
                            return true;
                        }
                    } catch (parseError) {
                        console.error('解析项目数据失败:', parseError);
                    }
                }
                return false;
            } catch (error) {
                console.error('更新项目考勤计数失败:', error);
                throw error;
            }
        }

        // 重置表单
        function resetForm(resetWorkType = true) {
            // 如果是从记工表进入，保存当前选中的员工ID
            let savedEmployeeId = null;
            if (isFromTimesheet && timesheetEmployeeId) {
                savedEmployeeId = timesheetEmployeeId;
            }
            
            // 重置全选状态
            resetSelectAllState();
            // 重置记工类型为点工（仅当resetWorkType为true时且不是从记工表进入）
            if (resetWorkType && !isFromTimesheet) {
                document.querySelector('input[name="workType"][value="点工"]').checked = true;
                document.getElementById('dayWorkOptions').style.display = 'block';
                
                // 重新绑定点工按钮事件，确保重置表单后按钮仍然可用
                if (typeof bindDayWorkButtons === 'function') {
                    bindDayWorkButtons();
                } else if (typeof window.bindDayWorkButtons === 'function') {
                    window.bindDayWorkButtons();
                }
            }

            // 重置上班按钮
            document.querySelectorAll('.daywork-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.backgroundColor = '#f5f5f5';
                btn.style.color = '#333';
                btn.style.border = '1px solid #ddd';
            });
            // 重置所有上班按钮为默认状态，不设置任何选中状态
            document.querySelectorAll('.daywork-btn').forEach(btn => {
                // 重置可编辑数字为默认值
                const editableNumber = btn.querySelector('.editable-number');
                if (editableNumber) {
                    // 根据按钮ID设置默认值
                    if (btn.id === 'dayWork1') {
                        editableNumber.textContent = '1';
                        btn.setAttribute('data-value', '1');
                    } else if (btn.id === 'dayWork2') {
                        editableNumber.textContent = '0.5';
                        btn.setAttribute('data-value', '0.5');
                    } else {
                        // 其他按钮重置为默认文本
                        editableNumber.textContent = '';
                        btn.setAttribute('data-value', '');
                    }
                }
            });
            // 重置小时选择器
            const hoursInput = document.querySelector('.hours-input');
            if (hoursInput) {
                hoursInput.value = '选小时';
            }
            const hoursContainer = document.getElementById('dayWorkHours');
            if (hoursContainer) {
                hoursContainer.setAttribute('data-value', 'hours');
            }
            // 隐藏所有下拉框
            document.querySelectorAll('.hours-dropdown, .modal-hours-dropdown').forEach(dropdown => {
                dropdown.style.display = 'none';
            });
            // 取消所有上班时间单选按钮的选中状态
            document.querySelectorAll('input[name="dayWork"]').forEach(radio => {
                radio.checked = false;
            });
            // 已删除hoursInput元素，无需处理

            // 重置加班
            isOvertime = false;
            const overtimeBtn = document.getElementById('overtimeBtn');
            overtimeBtn.textContent = '无加班';
            // 重置为加载页面时的默认样式
            overtimeBtn.style.backgroundColor = 'transparent';
            overtimeBtn.style.border = '1px solid #ddd';
            overtimeBtn.style.height = '36px';
            overtimeBtn.style.display = 'flex';
            overtimeBtn.style.alignItems = 'center';
            overtimeBtn.style.justifyContent = 'center';
            overtimeBtn.style.fontSize = '16px';
            overtimeBtn.style.fontWeight = 'bold';
            overtimeBtn.style.color = '#000'; // 加载页面时的默认颜色
            overtimeBtn.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
            overtimeBtn.style.transformOrigin = 'center';
            const overtimeDetails = document.getElementById('overtimeDetails');
            if (overtimeDetails) {
                overtimeDetails.style.display = 'none';
            }
            const overtimeHours = document.getElementById('overtimeHours');
            if (overtimeHours) {
                overtimeHours.value = '';
            }

            // 重置包工模式下的金额输入框
            const amountInput = document.getElementById('amountInput');
            if (amountInput) {
                amountInput.value = '';
            }

            // 重置工量模式下的输入框
            const workAmountInput = document.getElementById('workAmountInput');
            if (workAmountInput) {
                workAmountInput.value = '';
            }
            const unitPriceInput = document.getElementById('unitPriceInput');
            if (unitPriceInput) {
                unitPriceInput.value = '';
            }
            const totalPriceInput = document.getElementById('totalPriceInput');
            if (totalPriceInput) {
                totalPriceInput.value = '';
            }
            const currentSubProject = document.getElementById('currentSubProject');
            if (currentSubProject) {
                currentSubProject.textContent = '请选择分项';
            }

            // 重置备注
            document.getElementById('remark').value = '';

            // 重置图片上传
            document.getElementById('imageUpload').value = '';
            document.getElementById('imageModal').style.display = 'none';
            
            // 清空全局图片数组
            window.selectedImages = [];
            
            // 清除所有图片预览项
            const container = document.getElementById('imageUploadContainer');
            if (container) {
                const items = container.querySelectorAll('.image-preview-item');
                items.forEach(item => item.remove());
            }
            
            // 重置员工选择
            selectedEmployeeIds.clear();
            document.querySelectorAll('.employee-item input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
                // 移除员工项的selected类
                const employeeItem = checkbox.closest('.employee-item');
                if (employeeItem) {
                    employeeItem.classList.remove('selected');
                }
            });
            const selectAllBtn = document.getElementById('selectAllBtn');
            if (selectAllBtn) {
                selectAllBtn.textContent = '全选';
                selectAllBtn.style.backgroundColor = '#ED7D31';
            }
            
            // 如果是从记工表进入，恢复员工选择和折叠状态
            if (isFromTimesheet) {
                setTimeout(() => {
                    // 恢复员工选择
                    if (savedEmployeeId) {
                        selectedEmployeeIds.add(savedEmployeeId);
                        
                        // 恢复员工选中状态
                        const employeeItem = document.querySelector(`.employee-item[data-id="${savedEmployeeId}"]`);
                        if (employeeItem) {
                            const checkbox = employeeItem.querySelector('input[type="checkbox"]');
                            if (checkbox) {
                                checkbox.checked = true;
                            }
                            employeeItem.classList.add('selected');
                        }
                    }
                }, 100);
            }
        }

        // 显示通知
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = isError ? 'notification error' : 'notification';
            notification.style.display = 'block';

            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // 显示确认模态框
        function showConfirmModal(title, message, confirmCallback) {
            // 只移除确认类型的模态框，防止叠加，保留所有功能性模态框
            // 确认模态框通常没有特定ID，或者是动态创建的
            document.querySelectorAll('.modal').forEach(existingModal => {
                // 保留具有特定ID的功能性模态框，移除其他（主要是确认模态框）
                const hasFunctionalId = existingModal.id && (
                    existingModal.id === 'overtimeModal' || 
                    existingModal.id === 'morningAfternoonModal' ||
                    existingModal.id === 'addEmployeeModal' ||
                    existingModal.id === 'datePickerModal' ||
                    existingModal.id === 'imageModal' ||
                    existingModal.id === 'subProjectModal' ||
                    existingModal.id === 'addSubProjectModal' ||
                    existingModal.id === 'editSubProjectModal' ||
                    existingModal.id.includes('SubProject') // 保护所有包含SubProject的模态框
                );
                const isFunctional = hasFunctionalId || existingModal.classList.contains('functional-modal');
                
                // 只移除没有功能性ID的模态框（即确认模态框）
                if (!isFunctional) {
                    existingModal.remove();
                }
            });
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            // 创建带有蓝色数据颜色的确认消息
            const formattedMessage = formatConfirmationMessage(message);
            modal.innerHTML = `
                <div class="modal-content">
                    <h3 style="color: #ED7D31;">${title === '删除记工' ? '删除记工' : (document.getElementById('confirmBtn') && document.getElementById('confirmBtn').textContent === '保存修改' ? '修改记工' : title)}</h3>
                    <p>${formattedMessage}</p>
                    <div class="form-buttons" style="display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; margin-top: 20px;">
                        <button id="confirmAction" style="background-color: #52c41a; margin-left: 0;">${title === '删除记工' ? '删除' : (document.getElementById('confirmBtn') && document.getElementById('confirmBtn').textContent === '保存修改' ? '修改' : '确认')}</button>
                        <button id="cancelAction" style="background-color: #f5222d; margin-right: 0;">取消</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 确保DOM已渲染完成后再添加事件监听器
            setTimeout(() => {
                // 从modal元素内部查找按钮，而不是全局查找
                const confirmButton = modal.querySelector('#confirmAction');
                const cancelButton = modal.querySelector('#cancelAction');
                
                if (confirmButton) {
                    confirmButton.addEventListener('click', () => {
                        confirmCallback();
                        modal.remove();
                    });
                }
                
                if (cancelButton) {
                    cancelButton.addEventListener('click', () => {
                        modal.remove();
                    });
                }
            }, 0);
        }
        
        // 格式化确认消息，将数据部分设置为蓝色
        function formatConfirmationMessage(message) {
            // 将消息按行分割
            const lines = message.split('\n');
            const formattedLines = lines.map(line => {
                // 检查是否包含冒号，且不是最后一行（确认提示）
                if (line.includes(':') && !line.includes('确认保存此记工记录吗')) {
                    const parts = line.split(':');
                    if (parts.length >= 2) {
                        const label = parts[0] + ':';
                        const data = parts.slice(1).join(':');
                        // 将数据部分设置为蓝色
                        return `${label}<span style="color: blue;">${data}</span>`;
                    }
                }
                return line;
            });
            return formattedLines.join('<br>');
        }

        // 上下午模态框相关函数
        window.morningAfternoonData = {
            morning: { type: 'rest', value: '' },
            afternoon: { type: 'rest', value: '' }
        };

        // 隐藏上下午模态框
        function hideMorningAfternoonModal() {

            // 关闭上下午模态框
            const modal = document.getElementById('morningAfternoonModal');
            if (modal) {
                modal.style.display = 'none';
                // 确保移除所有打开状态
                modal.classList.remove('show');
            }
        }

        // 点击模态框外部关闭模态框
        document.addEventListener('DOMContentLoaded', function() {
            const morningAfternoonModal = document.getElementById('morningAfternoonModal');
            if (morningAfternoonModal) {
                // 点击模态框外部关闭
                morningAfternoonModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        hideMorningAfternoonModal();
                    }
                });
                
                // 绑定关闭按钮事件
                const closeBtn = morningAfternoonModal.querySelector('.modal-close');
                if (closeBtn) {
                    closeBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        hideMorningAfternoonModal();
                    });
                }
            }
        });

        // 确认上下午选择
        function confirmMorningAfternoon() {
            // 收集当前选择的数据
            const morningSelected = document.querySelector('.morning-afternoon-btn[data-period="morning"].active');
            const afternoonSelected = document.querySelector('.morning-afternoon-btn[data-period="afternoon"].active');
            
            // 选择“上下午”后，强制切换到 period 选项
            document.querySelectorAll('input[name="dayWork"]').forEach(radio => { radio.checked = false; });
            const periodRadio = document.getElementById('hiddenRadioPeriod');
            if (periodRadio) periodRadio.checked = true;
            
            if (morningSelected) {
                const morningType = morningSelected.getAttribute('data-value');
                if (morningType === 'work') {
                    const morningValue = morningSelected.getAttribute('data-work-value');
                    if (morningValue) {
                        window.morningAfternoonData.morning = { type: 'work', value: morningValue };
                    } else {
                        window.morningAfternoonData.morning = { type: 'work', value: '' };
                    }
                } else if (morningType === 'hours') {
                    const morningValue = morningSelected.getAttribute('data-selected-hours');
                    if (morningValue) {
                        window.morningAfternoonData.morning = { type: 'hours', value: morningValue };
                    } else {
                        window.morningAfternoonData.morning = { type: 'hours', value: '' };
                    }
                } else {
                    window.morningAfternoonData.morning = { type: 'rest', value: '' };
                }
            }
            
            if (afternoonSelected) {
                const afternoonType = afternoonSelected.getAttribute('data-value');
                if (afternoonType === 'work') {
                    const afternoonValue = afternoonSelected.getAttribute('data-work-value');
                    if (afternoonValue) {
                        window.morningAfternoonData.afternoon = { type: 'work', value: afternoonValue };
                    } else {
                        window.morningAfternoonData.afternoon = { type: 'work', value: '' };
                    }
                } else if (afternoonType === 'hours') {
                    const afternoonValue = afternoonSelected.getAttribute('data-selected-hours');
                    if (afternoonValue) {
                        window.morningAfternoonData.afternoon = { type: 'hours', value: afternoonValue };
                    } else {
                        window.morningAfternoonData.afternoon = { type: 'hours', value: '' };
                    }
                } else {
                    window.morningAfternoonData.afternoon = { type: 'rest', value: '' };
                }
            }
            
            // 更新上下午按钮显示
            updateMorningAfternoonButtonDisplay();
            
            // 关闭模态框
            hideMorningAfternoonModal();
        }
        // 使函数全局可访问
        window.hideMorningAfternoonModal = hideMorningAfternoonModal;
        window.confirmMorningAfternoon = confirmMorningAfternoon;
        window.updateMorningAfternoonButtonDisplay = updateMorningAfternoonButtonDisplay;

        // 更新上下午按钮显示
        function updateMorningAfternoonButtonDisplay() {
            const btn = document.getElementById('morningAfternoonBtn');
            const morningText = formatPeriodText(window.morningAfternoonData.morning);
            const afternoonText = formatPeriodText(window.morningAfternoonData.afternoon);
            
            // 检查是否有实际的设置（非默认休息状态且有数值的工作类型）
            const hasRealMorning = (window.morningAfternoonData.morning.type === 'work' && window.morningAfternoonData.morning.value) || 
                                   (window.morningAfternoonData.morning.type === 'hours' && window.morningAfternoonData.morning.value);
            const hasRealAfternoon = (window.morningAfternoonData.afternoon.type === 'work' && window.morningAfternoonData.afternoon.value) || 
                                     (window.morningAfternoonData.afternoon.type === 'hours' && window.morningAfternoonData.afternoon.value);
            
            if (!hasRealMorning && !hasRealAfternoon) {
                // 都是休息或无实际设置，显示默认文本
                if (window.morningAfternoonData.morning.type === 'rest' && window.morningAfternoonData.afternoon.type === 'rest') {
                    // 上午和下午都选择休息时
                    btn.innerHTML = '上午休息-下午休息';
                } else {
                    btn.innerHTML = '上下午';
                }
            } else {
                // 有实际设置，显示具体内容
                btn.innerHTML = `上午${morningText}-下午${afternoonText}`;
            }
            
            // 更新按钮样式为活跃状态
            // 移除所有按钮的active状态
            document.querySelectorAll('.daywork-btn').forEach(b => {
                b.classList.remove('active');
                b.style.backgroundColor = '#f5f5f5';
                b.style.color = '#333';
                b.style.border = '1px solid #ddd';
            });
            
            // 为当前按钮添加active状态
            btn.classList.add('active');
            btn.style.backgroundColor = '#1890ff';
            btn.style.color = 'white';
            btn.style.border = 'none';
            
            // 同步更新隐藏的单选按钮
            document.querySelectorAll('input[name="dayWork"]').forEach(radio => {
                radio.checked = radio.value === 'period';
            });
        }

        // 格式化时段文本
        function formatPeriodText(periodData) {
            if (periodData.type === 'rest') {
                return '休息';
            } else if (periodData.type === 'work') {
                if (periodData.value) {
                    return (periodData.value === '0.5' ? '半' : periodData.value) + '个工';
                }
                return '输入工';
            } else if (periodData.type === 'hours') {
                return periodData.value ? periodData.value + '小时' : '选小时';
            }
            return '休息';
        }

        // 绑定模态框中的按钮事件
        function bindMorningAfternoonButtonEvents() {
            // 绑定休息按钮事件
            document.querySelectorAll('.morning-afternoon-btn[data-value="rest"]').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    const period = this.getAttribute('data-period');
                    
                    // 移除同一时段的所有active状态
                    document.querySelectorAll(`.morning-afternoon-btn[data-period="${period}"]`).forEach(b => {
                        b.classList.remove('active');
                        b.style.backgroundColor = '#f5f5f5';
                        b.style.color = '#333';
                        b.style.border = '1px solid #ddd';
                    });
                    
                    // 为当前按钮添加active状态
                        this.classList.add('active');
                        this.style.backgroundColor = '#1890ff';
                        this.style.color = 'white';
                        this.style.border = 'none';
                    
                    // 点击休息按钮时重置其它两个按钮
                    // 重置输入工按钮
                    const workContainer = document.querySelector(`.morning-afternoon-btn[data-period="${period}"][data-value="work"]`);
                    if (workContainer) {
                        const textSpan = workContainer.querySelector('.work-btn-text');
                        if (textSpan) {
                            textSpan.textContent = '输入工';
                        }
                        workContainer.removeAttribute('data-work-value');
                    }
                    
                    // 重置选小时按钮
                    const hoursContainer = document.querySelector(`.modal-hours-select-container[data-period="${period}"]`);
                    if (hoursContainer) {
                        const hoursInput = hoursContainer.querySelector('.modal-hours-input');
                        if (hoursInput) {
                            hoursInput.value = '选小时';
                        }
                        hoursContainer.removeAttribute('data-selected-hours');
                    }
                });
            });
            
            // 绑定输入工容器事件
            document.querySelectorAll('[id$="WorkContainer"]').forEach(container => {
                container.addEventListener('click', function(e) {
                    const period = this.getAttribute('data-period');
                    const textSpan = this.querySelector('.work-btn-text');
                    const input = this.querySelector('.work-input');
                    
                    // 移除同一时段的所有active状态
                    document.querySelectorAll(`.morning-afternoon-btn[data-period="${period}"]`).forEach(b => {
                        b.classList.remove('active');
                        b.style.backgroundColor = '#f5f5f5';
                        b.style.color = '#333';
                        b.style.border = '1px solid #ddd';
                    });
                    
                    // 为当前按钮添加active状态
                    this.classList.add('active');
                    this.style.backgroundColor = '#1890ff';
                    this.style.color = 'white';
                    this.style.border = 'none';
                    
                    // 点击输入工按钮时重置选小时按钮
                    const hoursContainer = document.querySelector(`.modal-hours-select-container[data-period="${period}"]`);
                    if (hoursContainer) {
                        const hoursInput = hoursContainer.querySelector('.modal-hours-input');
                        if (hoursInput) {
                            hoursInput.value = '选小时';
                        }
                        hoursContainer.removeAttribute('data-selected-hours');
                    }
                    
                    // 切换到输入框模式，显示输入框+个工
                    textSpan.innerHTML = '<input type="text" class="work-input-inline" style="border: none; background: transparent; color: inherit; width: 60px; outline: none; text-align: center; font-size: 16px; font-weight: bold; margin: 0; padding: 0; vertical-align: middle; line-height: 1;" placeholder="半" value="半">个工';
                    const inlineInput = textSpan.querySelector('.work-input-inline');
                    if (inlineInput) {
                        inlineInput.focus();
                        inlineInput.select();
                        
                        // 绑定内联输入框事件
                        inlineInput.addEventListener('blur', function() {
                            let value = this.value;
                            // 处理"半"的特殊情况
                            if (value === '半' || value === '0.5') {
                                value = 0.5;
                            } else {
                                value = parseFloat(value) || 0.5;
                            }
                            if (value < 0.1) value = 0.1;
                            if (value > 10) value = 10;
                            
                            textSpan.innerHTML = (value === 0.5 ? '半' : value) + '个工';
                            container.setAttribute('data-work-value', value.toString());
                        });
                        
                        inlineInput.addEventListener('input', function() {
                            let value = this.value;
                            // 允许输入"半"和数字
                            if (value === '半') {
                                return; // 允许输入"半"
                            }
                            value = value.replace(/[^0-9.]/g, '');
                            const parts = value.split('.');
                            if (parts.length > 2) {
                                value = parts[0] + '.' + parts.slice(1).join('');
                            }
                            this.value = value;
                        });
                        
                        inlineInput.addEventListener('keydown', function(e) {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                this.blur();
                            }
                        });
                    }
                });
                
                // 绑定输入工容器事件
                // 注意：已改为内联输入框模式，原有的input处理代码已移除
            });
            
            // 绑定小时选择器事件
            document.querySelectorAll('.modal-hours-select-container').forEach(container => {
                container.addEventListener('click', function(e) {
                    const period = this.getAttribute('data-period');
                    
                    // 移除同一时段的所有active状态
                    document.querySelectorAll(`.morning-afternoon-btn[data-period="${period}"]`).forEach(b => {
                        b.classList.remove('active');
                        b.style.backgroundColor = '#f5f5f5';
                        b.style.color = '#333';
                        b.style.border = '1px solid #ddd';
                    });
                    
                    // 为当前按钮添加active状态
                    this.classList.add('active');
                    this.style.backgroundColor = '#1890ff';
                    this.style.color = 'white';
                    this.style.border = 'none';
                    
                    // 点击选小时按钮时重置输入工按钮
                    const workContainer = document.querySelector(`.morning-afternoon-btn[data-period="${period}"][data-value="work"]`);
                    if (workContainer) {
                        const textSpan = workContainer.querySelector('.work-btn-text');
                        if (textSpan) {
                            textSpan.textContent = '输入工';
                        }
                        workContainer.removeAttribute('data-work-value');
                    }
                    
                    // 显示下拉框
                    e.stopPropagation();
                    const dropdown = this.querySelector('.modal-hours-dropdown');
                    
                    // 隐藏所有其他下拉框
                    document.querySelectorAll('.modal-hours-dropdown').forEach(d => {
                        if (d !== dropdown) {
                            d.style.display = 'none';
                            d.style.zIndex = '1001';
                        }
                    });
                    
                    // 显示当前下拉框并设置最高z-index
                    dropdown.style.display = 'block';
                    dropdown.style.zIndex = '1003';
                });
            });
        }

        // 重置1个工按钮为默认状态
        function resetDayWork1Button() {
            const dayWork1Btn = document.getElementById('dayWork1');
            if (dayWork1Btn) {
                const editableSpan = dayWork1Btn.querySelector('.editable-number');
                if (editableSpan) {
                    editableSpan.textContent = '1';
                }
                dayWork1Btn.setAttribute('data-value', '1');
            }
        }
        
        // 重置小时选择器按钮为默认状态
        function resetHoursSelectorButton() {
            // 先尝试通过ID查找（最可靠）
            let hoursButton = document.getElementById('dayWorkHours');
            if (!hoursButton) {
                // 如果没找到，尝试通过类名查找
                hoursButton = document.querySelector('.hours-select-container');
            }
            if (!hoursButton) {
                // 最后尝试通过其他方式查找
                hoursButton = document.querySelector('.daywork-btn[data-value="hours"]');
            }
            if (hoursButton) {
                hoursButton.classList.remove('active');
                hoursButton.style.backgroundColor = '#f5f5f5';
                hoursButton.style.color = '#333';
                hoursButton.style.border = '1px solid #ddd';
                
                const hoursInput = hoursButton.querySelector('.hours-input');
                if (hoursInput) {
                    hoursInput.value = '选小时';
                    hoursButton.setAttribute('data-value', 'hours');
                }
                
                // 隐藏下拉框（如果显示）
                const dropdown = hoursButton.querySelector('.hours-dropdown');
                if (dropdown) {
                    dropdown.style.display = 'none';
                }
            }
        }
        
        // 使函数全局可访问
        window.resetDayWork1Button = resetDayWork1Button;
        window.resetHoursSelectorButton = resetHoursSelectorButton;

        // 初始化模态框中的小时选择器
        function initModalHoursSelector() {
            const hoursDropdowns = document.querySelectorAll('.modal-hours-dropdown');
            hoursDropdowns.forEach(hoursDropdown => {
                // 清空现有选项
                hoursDropdown.innerHTML = '';
                
                // 创建默认选项，并设为不可选择
                const defaultOption = document.createElement('div');
                defaultOption.className = 'modal-hours-option disabled';
                defaultOption.setAttribute('data-value', 'hours');
                defaultOption.style.cssText = 'padding: 8px 12px; cursor: not-allowed; border-bottom: 1px solid #f0f0f0; color: #999; background-color: #f9f9f9;';
                defaultOption.textContent = '选小时';
                hoursDropdown.appendChild(defaultOption);
                
                // 生成0.5-24小时的选项，每0.5为一个单位
                for (let i = 0.5; i <= 24; i += 0.5) {
                    const option = document.createElement('div');
                    option.className = 'modal-hours-option';
                    option.setAttribute('data-value', i.toString());
                    option.style.cssText = 'padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; color: #333;';
                    option.textContent = i + '小时';
                    hoursDropdown.appendChild(option);
                }
            });
        }

        // 绑定模态框中的小时选择器事件
        function bindModalHoursSelectorEvents() {
            const hoursDropdowns = document.querySelectorAll('.modal-hours-dropdown');
            hoursDropdowns.forEach(hoursDropdown => {
                // 绑定选项点击事件
                hoursDropdown.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (e.target.classList.contains('modal-hours-option') && !e.target.classList.contains('disabled')) {
                        const value = e.target.getAttribute('data-value');
                        const hoursInput = this.previousElementSibling;
                        
                        // 更新输入框显示值
                        hoursInput.value = value + '小时';
                        
                        // 更新按钮的data-selected-hours属性
                        const container = hoursInput.closest('.modal-hours-select-container');
                        if (container) {
                            container.setAttribute('data-selected-hours', value);
                        }
                        
                        // 隐藏下拉框并重置z-index
                        this.style.display = 'none';
                        this.style.zIndex = '1001';
                    }
                });
                
                // 添加选项悬停效果（只对非禁用的选项）
                hoursDropdown.addEventListener('mouseover', function(e) {
                    if (e.target.classList.contains('modal-hours-option') && !e.target.classList.contains('disabled')) {
                        e.target.style.backgroundColor = '#f5f5f5';
                    }
                    // 确保下拉框保持最高z-index
                    this.style.zIndex = '1004';
                });
                
                hoursDropdown.addEventListener('mouseout', function(e) {
                    if (e.target.classList.contains('modal-hours-option') && !e.target.classList.contains('disabled')) {
                        e.target.style.backgroundColor = '';
                    }
                });
                
                // 防止下拉框内的点击事件冒泡
                hoursDropdown.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            });
            
            // 点击外部关闭下拉框
            document.addEventListener('click', function(e) {
                const modalHoursDropdowns = document.querySelectorAll('.modal-hours-dropdown');
                modalHoursDropdowns.forEach(dropdown => {
                    const container = dropdown.closest('.modal-hours-select-container');
                    // 只有当点击既不在下拉框内，也不在对应的容器内时，才关闭下拉框
                    if (!dropdown.contains(e.target) && (!container || !container.contains(e.target))) {
                        dropdown.style.display = 'none';
                        dropdown.style.zIndex = '1001'; // 重置z-index
                    }
                });
            });
        }





        // 初始化加班模态框中的小时选择器
        function initOvertimeHoursSelector() {

            const hoursDropdowns = document.querySelectorAll('#overtimeHours .modal-hours-dropdown');

            
            hoursDropdowns.forEach((hoursDropdown, index) => {

                // 清空现有选项
                hoursDropdown.innerHTML = '';
                
                // 创建默认选项，并设为不可选择
                const defaultOption = document.createElement('div');
                defaultOption.className = 'modal-hours-option disabled';
                defaultOption.setAttribute('data-value', 'hours');
                defaultOption.textContent = '选小时';
                hoursDropdown.appendChild(defaultOption);
                
                // 生成0.5-24小时的选项，每0.5为一个单位
                for (let i = 0.5; i <= 24; i += 0.5) {
                    const option = document.createElement('div');
                    option.className = 'modal-hours-option';
                    option.setAttribute('data-value', i.toString());
                    option.textContent = i + '小时';
                    hoursDropdown.appendChild(option);
                }
                

            });
            

        }

        // 绑定加班模态框中的小时选择器事件
        function bindOvertimeHoursSelectorEvents() {
            // 简化事件绑定，与新建模式保持一致
            const overtimeHoursContainer = document.getElementById('overtimeHours');
            if (overtimeHoursContainer) {
                // 移除之前可能绑定的事件
                overtimeHoursContainer.removeEventListener('click', overtimeHoursContainer._clickHandler);
                
                // 创建新的点击处理函数
                overtimeHoursContainer._clickHandler = function(e) {
                    const dropdown = this.querySelector('.modal-hours-dropdown');
                    if (dropdown.style.display === 'block') {
                        dropdown.style.display = 'none';
                    } else {
                        document.querySelectorAll('.hours-dropdown, .modal-hours-dropdown').forEach(d => d.style.display = 'none');
                        dropdown.style.display = 'block';
                    }
                    e.stopPropagation();
                };
                
                overtimeHoursContainer.addEventListener('click', overtimeHoursContainer._clickHandler);
            }
            
            // 绑定小时选项事件
            document.querySelectorAll('#overtimeHours .modal-hours-option').forEach(option => {
                // 移除之前可能绑定的事件
                option.removeEventListener('click', option._clickHandler);
                
                option._clickHandler = function() {
                    const value = this.getAttribute('data-value');
                    const input = document.querySelector('#overtimeHours .modal-hours-input');
                    if (input) {
                        input.value = value + '小时';
                    }
                    if (typeof window.overtimeData !== 'undefined') {
                        window.overtimeData.type = 'hours';
                        window.overtimeData.value = value;
                    }
                    const dropdown = document.querySelector('#overtimeHours .modal-hours-dropdown');
                    if (dropdown) {
                        dropdown.style.display = 'none';
                    }
                }
                
                option.addEventListener('click', option._clickHandler);
            });
            
            // 点击外部关闭下拉框
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#overtimeHours .hours-select-container')) {
                    document.querySelectorAll('#overtimeHours .hours-dropdown').forEach(dropdown => {
                        dropdown.style.display = 'none';
                    });
                }
            });
        }

        // 绑定加班模态框按钮事件（编辑模式专用）
        function bindOvertimeModalButtonEvents() {
            // 确保overtimeData对象存在
            if (typeof window.overtimeData === 'undefined') {
                window.overtimeData = {
                    type: 'none',
                    value: ''
                };
            }
            
            // 绑定加班选项按钮事件
            document.querySelectorAll('#overtimeModal .overtime-option').forEach(option => {
                option.addEventListener('click', function() {
                    const value = this.getAttribute('data-value');
                    
                    // 移除所有active状态
                    document.querySelectorAll('#overtimeModal .overtime-option').forEach(opt => {
                        opt.style.backgroundColor = '#f5f5f5';
                        opt.style.color = '#333';
                        opt.style.border = '1px solid #ddd';
                    });

                    // 设置当前选项为active
                    this.style.backgroundColor = '#1890ff';
                    this.style.color = 'white';
                    this.style.border = 'none';

                    // 更新数据
                    window.overtimeData.type = value;
                    
                    // 按钮联动效果：当点击输入工按钮时，重置选小时按钮
                    if (value === 'work') {
                        const hoursInput = document.querySelector('#overtimeHours .modal-hours-input');
                        if (hoursInput) {
                            hoursInput.value = '选小时';
                        }
                    }
                    
                    // 按钮联动效果：当点击选小时按钮时，重置输入工按钮
                    if (value === 'hours') {
                        const workText = document.querySelector('#overtimeWork .work-btn-text');
                        if (workText) {
                            workText.textContent = '输入工';
                        }
                    }
                    
                    // 按钮联动效果：当点击无加班按钮时，重置其他两个按钮
                    if (value === 'none') {
                        // 重置输入工按钮
                        const workText = document.querySelector('#overtimeWork .work-btn-text');
                        if (workText) {
                            workText.textContent = '输入工';
                        }
                        
                        // 重置选小时按钮
                        const hoursInput = document.querySelector('#overtimeHours .modal-hours-input');
                        if (hoursInput) {
                            hoursInput.value = '选小时';
                        }
                        
                        // 隐藏选小时下拉框
                        const hoursDropdown = document.querySelector('#overtimeHours .modal-hours-dropdown');
                        if (hoursDropdown) {
                            hoursDropdown.style.display = 'none';
                        }
                    }
                    
                    // 如果是输入工容器，切换到输入模式
                    if (value === 'work') {
                        // 重置选小时按钮
                        const hoursInput = document.querySelector('#overtimeHours .modal-hours-input');
                        if (hoursInput) {
                            hoursInput.value = '选小时';
                        }
                        
                        // 隐藏选小时下拉框
                        const hoursDropdown = document.querySelector('#overtimeHours .modal-hours-dropdown');
                        if (hoursDropdown) {
                            hoursDropdown.style.display = 'none';
                        }
                        
                        const textSpan = this.querySelector('.work-btn-text');
                        const input = this.querySelector('.work-input');
                        if (textSpan && input) {
                            textSpan.innerHTML = '<input type="text" class="work-input-inline" style="border: none; background: transparent; color: inherit; width: 60px; outline: none; text-align: center; font-size: 16px; font-weight: bold; margin: 0; padding: 0; vertical-align: middle; line-height: 1;" placeholder="半" value="半">个工';
                            const inlineInput = textSpan.querySelector('.work-input-inline');
                            if (inlineInput) {
                                inlineInput.focus();
                                inlineInput.select();
                                
                                inlineInput.addEventListener('blur', function() {
                                    let value = this.value;
                                    // 处理"半"的特殊情况
                                    if (value === '半' || value === '0.5') {
                                        value = 0.5;
                                    } else {
                                        value = parseFloat(value) || 0.5;
                                    }
                                    if (value < 0.1) value = 0.1;
                                    if (value > 10) value = 10;
                                    
                                    textSpan.innerHTML = (value === 0.5 ? '半' : value) + '个工';
                                    if (typeof window.overtimeData !== 'undefined') {
                                        window.overtimeData.value = value.toString();
                                    }
                                });
                            }
                        }
                    }
                });
            });

            // 注意：选小时按钮点击事件已经在 bindOvertimeHoursSelectorEvents 函数中绑定
            // 这里不需要重复绑定，避免事件冲突
        }

        // 绑定点工按钮事件
        function bindDayWorkButtons() {
            // 确保函数全局可访问
            window.bindDayWorkButtons = bindDayWorkButtons;
            
            // 移除所有已绑定的事件监听器，防止重复绑定
            const dayWork1Btn = document.getElementById('dayWork1');
            const dayWork05Btn = document.getElementById('dayWork05');
            const restBtn = document.getElementById('dayWorkRest');
            
            if (dayWork1Btn) {
                // 克隆节点以移除所有事件监听器
                const newBtn = dayWork1Btn.cloneNode(true);
                dayWork1Btn.parentNode.replaceChild(newBtn, dayWork1Btn);
            }
            
            if (dayWork05Btn) {
                // 克隆节点以移除所有事件监听器
                const newBtn = dayWork05Btn.cloneNode(true);
                dayWork05Btn.parentNode.replaceChild(newBtn, dayWork05Btn);
            }
            
            if (restBtn) {
                // 克隆节点以移除所有事件监听器
                const newBtn = restBtn.cloneNode(true);
                restBtn.parentNode.replaceChild(newBtn, restBtn);
            }
            
            // 重新获取元素引用（因为已经替换了）
            const newDayWork1Btn = document.getElementById('dayWork1');
            const newDayWork05Btn = document.getElementById('dayWork05');
            const newRestBtn = document.getElementById('dayWorkRest');
            // 初始化小时选择器下拉框选项（编辑模式专用）
            function initEditModeHoursSelector() {
                const hoursDropdowns = document.querySelectorAll('.hours-dropdown, .modal-hours-dropdown');
                hoursDropdowns.forEach(hoursDropdown => {
                    // 只初始化空的下拉框
                    if (hoursDropdown.children.length <= 1) {
                        // 清空现有选项
                        hoursDropdown.innerHTML = '';
                        
                        // 创建默认选项，并设为不可选择
                        const defaultOption = document.createElement('div');
                        defaultOption.className = 'hours-option disabled';
                        defaultOption.setAttribute('data-value', 'hours');
                        defaultOption.style.cssText = 'padding: 8px 12px; cursor: not-allowed; border-bottom: 1px solid #f0f0f0; color: #999; background-color: #f9f9f9;';
                        defaultOption.textContent = '选小时';
                        hoursDropdown.appendChild(defaultOption);
                        
                        // 生成0.5-24小时的选项，每0.5为一个单位
                        for (let i = 0.5; i <= 24; i += 0.5) {
                            const option = document.createElement('div');
                            option.className = 'hours-option';
                            option.setAttribute('data-value', i.toString());
                            option.style.cssText = 'padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; color: #333;';
                            option.textContent = i + '小时';
                            hoursDropdown.appendChild(option);
                        }
                    }
                });
            }
            
            // 初始化小时选择器
            initEditModeHoursSelector();
            
            // 1个工按钮
            if (newDayWork1Btn) {
                newDayWork1Btn.addEventListener('click', function() {
                // 检查当前按钮是否已激活
                const isCurrentlyActive = this.classList.contains('active');
                const value = this.getAttribute('data-value');
                
                // 重置小时选择器按钮
                resetHoursSelectorButton();
                
                // 移除所有按钮的active状态
                document.querySelectorAll('.daywork-btn').forEach(b => {
                    b.classList.remove('active');
                    b.style.backgroundColor = '#f5f5f5';
                    b.style.color = '#333';
                    b.style.border = '1px solid #ddd';
                });
                
                // 同步更新隐藏的单选按钮，默认全部取消选中
                document.querySelectorAll('input[name="dayWork"]').forEach(radio => {
                    radio.checked = false;
                });
                
                // 隐藏所有下拉框
                document.querySelectorAll('.hours-dropdown, .modal-hours-dropdown').forEach(dropdown => {
                    dropdown.style.display = 'none';
                });
                
                // 如果当前按钮不是活动状态，则激活它
                if (!isCurrentlyActive) {
                    this.classList.add('active');
                    this.style.backgroundColor = '#1890ff';
                    this.style.color = 'white';
                    this.style.border = 'none';
                    
                    // 同步更新隐藏的单选按钮
                    document.querySelectorAll('input[name="dayWork"]').forEach(radio => {
                        radio.checked = radio.value === value;
                    });
                }
                
                document.getElementById('morningAfternoonBtn').textContent = '上下午';
            });
            }
            
            // 半个工按钮
            if (newDayWork05Btn) {
                newDayWork05Btn.addEventListener('click', function() {
                // 检查当前按钮是否已激活
                const isCurrentlyActive = this.classList.contains('active');
                const value = this.getAttribute('data-value');
                
                // 重置1个工按钮为默认状态
                resetDayWork1Button();
                
                // 重置小时选择器按钮
                resetHoursSelectorButton();
                
                // 重置上下午按钮
                const morningAfternoonBtn = document.getElementById('morningAfternoonBtn');
                if (morningAfternoonBtn) {
                    morningAfternoonBtn.textContent = '上下午';
                    morningAfternoonBtn.style.backgroundColor = '#f5f5f5';
                    morningAfternoonBtn.style.color = '#333';
                    morningAfternoonBtn.style.border = '1px solid #ddd';
                }
                
                // 重置上下午数据
                if (window.morningAfternoonData) {
                    window.morningAfternoonData = {
                        morning: { type: 'rest', value: '' },
                        afternoon: { type: 'rest', value: '' }
                    };
                }
                
                // 移除所有按钮的active状态
                document.querySelectorAll('.daywork-btn').forEach(b => {
                    b.classList.remove('active');
                    b.style.backgroundColor = '#f5f5f5';
                    b.style.color = '#333';
                    b.style.border = '1px solid #ddd';
                });
                
                // 同步更新隐藏的单选按钮，默认全部取消选中
                document.querySelectorAll('input[name="dayWork"]').forEach(radio => {
                    radio.checked = false;
                });
                
                // 隐藏所有下拉框
                document.querySelectorAll('.hours-dropdown, .modal-hours-dropdown').forEach(dropdown => {
                    dropdown.style.display = 'none';
                });
                
                // 如果当前按钮不是活动状态，则激活它
                if (!isCurrentlyActive) {
                    this.classList.add('active');
                    this.style.backgroundColor = '#1890ff';
                    this.style.color = 'white';
                    this.style.border = 'none';
                    
                    // 同步更新隐藏的单选按钮
                    document.querySelectorAll('input[name="dayWork"]').forEach(radio => {
                        radio.checked = radio.value === value;
                    });
                }
                
                document.getElementById('morningAfternoonBtn').textContent = '上下午';
            });
            
            // 选小时按钮
            document.getElementById('dayWorkHours').addEventListener('click', function() {
                // 检查当前按钮是否已激活
                const isCurrentlyActive = this.classList.contains('active');
                const value = this.getAttribute('data-value');
                
                // 重置1个工按钮为默认状态
                resetDayWork1Button();
                
                // 处理选小时按钮点击事件，无论是否有hours-select-container类
                if (true) {
                    // 移除所有按钮的active状态
                    document.querySelectorAll('.daywork-btn').forEach(b => {
                        b.classList.remove('active');
                        b.style.backgroundColor = '#f5f5f5';
                        b.style.color = '#333';
                        b.style.border = '1px solid #ddd';
                    });
                    
                    // 为当前按钮添加active状态
                    this.classList.add('active');
                    this.style.backgroundColor = '#1890ff';
                    this.style.color = 'white';
                    this.style.border = 'none';
                    
                    // 同步更新隐藏的单选按钮
                    document.querySelectorAll('input[name="dayWork"]').forEach(radio => {
                        radio.checked = radio.value === 'hours';
                    });
                    
                    // 显示下拉框
                    const dropdown = this.querySelector('.hours-dropdown');
                    if (dropdown) {
                        dropdown.style.display = 'block';
                    }
                    
                    // 隐藏工作小时数输入框（点击选小时按钮时不显示）
                    // 已删除hoursInput元素，无需处理
                    
                    document.getElementById('morningAfternoonBtn').textContent = '上下午';
                    return;
                }
                
                // 如果当前按钮不是活动状态，则激活它
                if (!isCurrentlyActive) {
                    // 移除所有按钮的active状态
                    document.querySelectorAll('.daywork-btn').forEach(b => {
                        b.classList.remove('active');
                        b.style.backgroundColor = '#f5f5f5';
                        b.style.color = '#333';
                        b.style.border = '1px solid #ddd';
                    });
                    
                    // 为当前按钮添加active状态
                    this.classList.add('active');
                    this.style.backgroundColor = '#1890ff';
                    this.style.color = 'white';
                    this.style.border = 'none';
                    
                    // 同步更新隐藏的单选按钮
                    document.querySelectorAll('input[name="dayWork"]').forEach(radio => {
                        radio.checked = radio.value === value;
                    });
                    
                    // 显示下拉框
                    const hoursDropdown = this.querySelector('.hours-dropdown');
                    if (hoursDropdown) {
                        hoursDropdown.style.display = 'block';
                    }
                } else {
                    // 如果已经是活动状态，则取消选中
                    this.classList.remove('active');
                    this.style.backgroundColor = '#f5f5f5';
                    this.style.color = '#333';
                    this.style.border = '1px solid #ddd';
                    
                    // 同步更新隐藏的单选按钮
                    document.querySelectorAll('input[name="dayWork"]').forEach(radio => {
                        radio.checked = false;
                    });
                    
                    // 隐藏下拉框
                    const hoursDropdown = this.querySelector('.hours-dropdown');
                    if (hoursDropdown) {
                        hoursDropdown.style.display = 'none';
                    }
                }
                
                document.getElementById('morningAfternoonBtn').textContent = '上下午';
            });
            }
            
            // 休息按钮
            if (newRestBtn) {
                newRestBtn.addEventListener('click', function() {
                // 检查当前按钮是否已激活
                const isCurrentlyActive = this.classList.contains('active');
                const value = this.getAttribute('data-value');
                
                // 重置1个工按钮为默认状态
                resetDayWork1Button();
                
                // 重置小时选择器按钮
                resetHoursSelectorButton();
                
                // 重置上下午按钮
                const morningAfternoonBtn = document.getElementById('morningAfternoonBtn');
                if (morningAfternoonBtn) {
                    morningAfternoonBtn.textContent = '上下午';
                    morningAfternoonBtn.style.backgroundColor = '#f5f5f5';
                    morningAfternoonBtn.style.color = '#333';
                    morningAfternoonBtn.style.border = '1px solid #ddd';
                }
                
                // 重置上下午数据
                if (window.morningAfternoonData) {
                    window.morningAfternoonData = {
                        morning: { type: 'rest', value: '' },
                        afternoon: { type: 'rest', value: '' }
                    };
                }
                
                // 移除所有按钮的active状态
                document.querySelectorAll('.daywork-btn').forEach(b => {
                    b.classList.remove('active');
                    b.style.backgroundColor = '#f5f5f5';
                    b.style.color = '#333';
                    b.style.border = '1px solid #ddd';
                });
                
                // 同步更新隐藏的单选按钮，默认全部取消选中
                document.querySelectorAll('input[name="dayWork"]').forEach(radio => {
                    radio.checked = false;
                });
                
                // 隐藏所有下拉框
                document.querySelectorAll('.hours-dropdown, .modal-hours-dropdown').forEach(dropdown => {
                    dropdown.style.display = 'none';
                });
                
                // 如果当前按钮不是活动状态，则激活它
                if (!isCurrentlyActive) {
                    this.classList.add('active');
                    this.style.backgroundColor = '#1890ff';
                    this.style.color = 'white';
                    this.style.border = 'none';
                    
                    // 同步更新隐藏的单选按钮
                    document.querySelectorAll('input[name="dayWork"]').forEach(radio => {
                        radio.checked = radio.value === value;
                    });
                }
                
                document.getElementById('morningAfternoonBtn').textContent = '上下午';
            });
            }
            
            
            
            // 为日工时选择器绑定下拉框事件
            const dayWorkHoursContainer = document.getElementById('dayWorkHours');
            const dayWorkHoursDropdown = dayWorkHoursContainer.querySelector('.hours-dropdown');
            
            // 绑定下拉框选项点击事件
            if (dayWorkHoursDropdown) {
                dayWorkHoursDropdown.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (e.target.classList.contains('hours-option') && !e.target.classList.contains('disabled')) {
                        const value = e.target.getAttribute('data-value');
                        const hoursInput = dayWorkHoursContainer.querySelector('.hours-input');
                        
                        // 更新输入框显示值
                        hoursInput.value = value + '小时';
                        
                        // 更新按钮的data-value
                        dayWorkHoursContainer.setAttribute('data-value', value);
                        
                        // 同步更新隐藏的单选按钮选中状态（使用实际选中的小时数）
                        const hiddenRadio = document.getElementById('hiddenRadioHours');
                        if (hiddenRadio) {
                            hiddenRadio.checked = true;
                            hiddenRadio.value = value; // 使用实际选中的小时数
                        }
                        
                        // 隐藏下拉框并重置z-index
                        this.style.display = 'none';
                        this.style.zIndex = '1001';
                    }
                });
                
                // 添加选项悬停效果
                dayWorkHoursDropdown.addEventListener('mouseover', function(e) {
                    if (e.target.classList.contains('hours-option') && !e.target.classList.contains('disabled')) {
                        e.target.style.backgroundColor = '#f5f5f5';
                    }
                });
                
                dayWorkHoursDropdown.addEventListener('mouseout', function(e) {
                    if (e.target.classList.contains('hours-option') && !e.target.classList.contains('disabled')) {
                        e.target.style.backgroundColor = '';
                    }
                });
            }
            
            // 点击外部关闭日工时下拉框
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#dayWorkHours') && dayWorkHoursDropdown) {
                    dayWorkHoursDropdown.style.display = 'none';
                }
            });
        }

        // 保存分项数据到本地存储
        function saveSubProjectsToLocal() {
            const subProjectList = document.getElementById('subProjectList');
            const subProjects = [];
            
            if (subProjectList) {
                const items = subProjectList.querySelectorAll('div > span');
                items.forEach(item => {
                    const name = item.textContent;
                    const editBtn = item.parentElement.querySelector('.editSubProjectBtn');
                    const unit = editBtn ? editBtn.getAttribute('data-unit') || '' : '';
                    subProjects.push({ name: name, unit: unit });
                });
            }
            
            const phone = localStorage.getItem('loggedInPhone') || 'default';
            const key = `subprojects_${phone}`;
            localStorage.setItem(key, JSON.stringify(subProjects));

        }
        
        // 从本地存储加载分项数据
        function loadSubProjectsFromLocal() {
            const phone = localStorage.getItem('loggedInPhone') || 'default';
            const key = `subprojects_${phone}`;
            const savedData = localStorage.getItem(key);
            
            if (savedData) {
                try {
                    const subProjects = JSON.parse(savedData);
                    const subProjectList = document.getElementById('subProjectList');
                    
                    if (subProjectList) {
                        // 清空现有列表
                        subProjectList.innerHTML = '';
                        
                        // 添加保存的分项
                        subProjects.forEach(project => {
                            const newItem = document.createElement('div');
                            newItem.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 8px; border-radius: 4px; border: 1px solid #eee;';
                            newItem.innerHTML = `
                                <span style="font-size: 16px;">${project.name}</span>
                                <div style="display: flex; gap: 10px;">
                                    <button class="editSubProjectBtn" data-name="${project.name}" data-unit="${project.unit}" style="background: none; border: none; color: #1890ff; cursor: pointer; font-size: 16px; padding: 4px;" title="修改分项">
                                        <i style="font-family: Arial; font-style: normal; font-weight: bold;">✏️</i>
                                    </button>
                                    <button class="deleteSubProjectBtn" data-name="${project.name}" data-unit="${project.unit}" style="background: none; border: none; color: #ff4d4f; cursor: pointer; font-size: 16px; padding: 4px;" title="删除分项">
                                        <i style="font-family: Arial; font-style: normal; font-weight: bold;">🗑️</i>
                                    </button>
                                </div>
                            `;
                            
                            subProjectList.appendChild(newItem);
                            
                            // 为新添加的分项div行绑定点击事件
                            newItem.onclick = function(e) {
                                // 如果点击的是编辑或删除按钮，不触发选择事件
                                if (e.target.closest('.editSubProjectBtn') || e.target.closest('.deleteSubProjectBtn')) {
                                    return;
                                }
                                
                                const span = this.querySelector('span');
                                if (!span) return;
                                
                                const currentSubProject = document.getElementById('currentSubProject');
                                if (currentSubProject) {
                                    currentSubProject.textContent = span.textContent;
                                    // 更新overtimeData中的分项数据
                                    if (typeof window.overtimeData !== 'undefined') {
                                        window.overtimeData.value = window.overtimeData.value || {};
                                        window.overtimeData.value.subProject = span.textContent;
                                    }
                                }
                                
                                // 获取分项的单位信息
                                const editBtn = this.querySelector('.editSubProjectBtn');
                                if (editBtn) {
                                    const unit = editBtn.getAttribute('data-unit') || '';
                                    
                                    // 填充工量输入框后面的单位
                                    const workAmountUnit = document.getElementById('workAmountUnit');
                                    if (workAmountUnit) {
                                        workAmountUnit.textContent = unit;
                                    }
                                    
                                    // 填充单价输入框后面的单位，用/分隔
                                    const unitPriceUnit = document.getElementById('unitPriceUnit');
                                    if (unitPriceUnit) {
                                        unitPriceUnit.textContent = unit ? `元/${unit}` : '元';
                                    }
                                }
                                
                                const subProjectModal = document.getElementById('subProjectModal');
                                if (subProjectModal) {
                                    subProjectModal.style.display = 'none';
                                }
                            };
                            
                            // 绑定编辑按钮事件
                            const editBtn = newItem.querySelector('.editSubProjectBtn');
                            editBtn.addEventListener('click', function(e) {
                                e.stopPropagation();
                                const oldName = this.getAttribute('data-name');
                                const oldUnit = this.getAttribute('data-unit') || '';
                                
                                // 创建修改分项模态框
                                let editModal = document.getElementById('editSubProjectModal');
                                if (editModal) {
                                    editModal.remove();
                                }
                                
                                editModal = document.createElement('div');
                                editModal.id = 'editSubProjectModal';
                                editModal.className = 'modal';
                                editModal.style.cssText = 'display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1002; align-items: center; justify-content: center;';
                                
                                editModal.innerHTML = `
                                    <div style="background-color: white; border-radius: 8px; width: 500px; max-width: 90%; padding: 20px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                            <h3 style="margin: 0; font-size: 18px; color: #333;">修改分项</h3>
                                            <button id="closeEditSubProjectModal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">×</button>
                                        </div>
                                        <div style="margin-bottom: 20px;">
                                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                                <span style="color: red; font-weight: bold;">*</span>
                                                <label style="color: black; margin: 0;">分项名称：</label>
                                                <input type="text" id="editSubProjectName" value="${oldName}" 
                                                       style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <span style="color: red; font-weight: bold;">*</span>
                                                <span style="color: black; margin: 0;">分项单位：</span>
                                                <input type="text" id="editSubProjectUnit" value="${oldUnit}" 
                                                       placeholder="请输入单位名称(不超过四个汉字)" 
                                                       style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                                <div style="position: relative;">
                                                    <button id="editQuickUnitSelect" style="padding: 8px 12px; background-color: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 14px; min-width: 100px;">
                                                        快速选择 ▼
                                                    </button>
                                                    <div id="editUnitDropdown" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; z-index: 1003; box-shadow: 0 2px 8px rgba(0,0,0,0.15); min-width: 100px; max-height: 200px; overflow-y: auto;">
                                                        <div class="edit-unit-option" data-unit="平方米">平方米</div>
                                                        <div class="edit-unit-option" data-unit="立方米">立方米</div>
                                                        <div class="edit-unit-option" data-unit="吨">吨</div>
                                                        <div class="edit-unit-option" data-unit="米">米</div>
                                                        <div class="edit-unit-option" data-unit="个">个</div>
                                                        <div class="edit-unit-option" data-unit="次">次</div>
                                                        <div class="edit-unit-option" data-unit="条">条</div>
                                                        <div class="edit-unit-option" data-unit="块">块</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div style="display: flex; justify-content: flex-end; gap: 10px;">
                                            <button id="cancelEditSubProject" style="padding: 8px 20px; background-color: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 14px;">取消</button>
                                            <button id="confirmEditSubProject" style="padding: 8px 20px; background-color: #1890ff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">确认</button>
                                        </div>
                                    </div>
                                `;
                                
                                document.body.appendChild(editModal);
                                
                                // 绑定模态框内的事件
                                const editUnitOptions = editModal.querySelectorAll('.edit-unit-option');
                                editUnitOptions.forEach(option => {
                                    option.style.cssText = 'padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; color: #333;';
                                    option.addEventListener('mouseover', function() {
                                        this.style.backgroundColor = '#f5f5f5';
                                    });
                                    option.addEventListener('mouseout', function() {
                                        this.style.backgroundColor = '';
                                    });
                                    option.addEventListener('click', function() {
                                        editModal.querySelector('#editSubProjectUnit').value = this.getAttribute('data-unit');
                                        editModal.querySelector('#editUnitDropdown').style.display = 'none';
                                    });
                                });
                                
                                const editQuickUnitSelect = editModal.querySelector('#editQuickUnitSelect');
                                const editUnitDropdown = editModal.querySelector('#editUnitDropdown');
                                editQuickUnitSelect.addEventListener('click', function(e) {
                                    e.stopPropagation();
                                    editUnitDropdown.style.display = editUnitDropdown.style.display === 'none' ? 'block' : 'none';
                                });
                                
                                // 关闭模态框事件
                                editModal.querySelector('#closeEditSubProjectModal').addEventListener('click', function() {
                                    editModal.remove();
                                });
                                
                                editModal.querySelector('#cancelEditSubProject').addEventListener('click', function() {
                                    editModal.remove();
                                });
                                
                                editModal.addEventListener('click', function(e) {
                                    if (e.target === editModal) {
                                        editModal.remove();
                                    }
                                });
                                
                                // 确认修改事件
                                editModal.querySelector('#confirmEditSubProject').addEventListener('click', function() {
                                    const newNameValue = editModal.querySelector('#editSubProjectName').value.trim();
                                    const newUnitValue = editModal.querySelector('#editSubProjectUnit').value.trim();
                                    
                                    if (!newNameValue) {
                                        alert('请输入分项名称！');
                                        return;
                                    }
                                    
                                    // 更新分项显示
                                    const spanElement = editBtn.parentElement.previousElementSibling;
                                    if (spanElement) {
                                        spanElement.textContent = newNameValue;
                                    }
                                    editBtn.setAttribute('data-name', newNameValue);
                                    editBtn.setAttribute('data-unit', newUnitValue);
                                    
                                    // 更新删除按钮的数据
                                    const deleteBtn = editBtn.nextElementSibling;
                                    if (deleteBtn) {
                                        deleteBtn.setAttribute('data-name', newNameValue);
                                        deleteBtn.setAttribute('data-unit', newUnitValue);
                                    }
                                    
                                    // 更新当前选中的分项（如果是被修改的这个）
                                    const currentSubProject = document.getElementById('currentSubProject');
                                    if (currentSubProject && currentSubProject.textContent === oldName) {
                                        currentSubProject.textContent = newNameValue;
                                    }
                                    
                                    // 保存到本地存储
                                    saveSubProjectsToLocal();
                                    
                                    editModal.remove();
                                });
                            });
                            
                            // 绑定删除按钮事件
                            const deleteBtn = newItem.querySelector('.deleteSubProjectBtn');
                            deleteBtn.addEventListener('click', function(e) {
                                e.stopPropagation();
                                const name = this.getAttribute('data-name');
                                
                                if (confirm(`确定要删除分项"${name}"吗？`)) {
                                    // 如果删除的是当前选中的分项，选择第一个剩余的分项
                                    const currentSubProject = document.getElementById('currentSubProject');
                                    if (currentSubProject && currentSubProject.textContent === name) {
                                        newItem.remove();
                                        const firstItem = document.querySelector('#subProjectList div span');
                                        if (firstItem && currentSubProject) {
                                            currentSubProject.textContent = firstItem.textContent;
                                        }
                                    } else {
                                        newItem.remove();
                                    }
                                    
                                    // 保存到本地存储
                                    saveSubProjectsToLocal();
                                }
                            });
                        });
                        

                        return true;
                    }
                } catch (error) {
                    console.error('加载分项数据失败:', error);
                }
            }
            
            return false;
        }
        
        // 添加分项模态框功能
        function initAddSubProjectModal() {
            // 创建模态框元素
            const addSubProjectModal = document.createElement('div');
            addSubProjectModal.id = 'addSubProjectModal';
            addSubProjectModal.className = 'modal';
            addSubProjectModal.style.display = 'none';
            addSubProjectModal.style.cssText = 'display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1001; align-items: center; justify-content: center;';
            
            // 模态框内容
            addSubProjectModal.innerHTML = `
                <div style="background-color: white; border-radius: 8px; width: 500px; max-width: 90%; padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; font-size: 18px; color: #333;">添加分项</h3>
                        <button id="closeAddSubProjectModal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">×</button>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                            <span style="color: red; font-weight: bold;">*</span>
                            <label style="color: black; margin: 0;">分项名称：</label>
                            <input type="text" id="newSubProjectName" placeholder="请输入分项名称" 
                                   style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="color: red; font-weight: bold;">*</span>
                            <span style="color: black; margin: 0;">分项单位：</span>
                            <input type="text" id="newSubProjectUnit" placeholder="请输入单位名称(不超过四个汉字)" 
                                   style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                            <div style="position: relative;">
                                <button id="quickUnitSelect" style="padding: 8px 12px; background-color: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 14px; min-width: 100px;">
                                    快速选择 ▼
                                </button>
                                <div id="unitDropdown" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; z-index: 1002; box-shadow: 0 2px 8px rgba(0,0,0,0.15); min-width: 100px; max-height: 200px; overflow-y: auto;">
                                    <div class="unit-option" data-unit="平方米">平方米</div>
                                    <div class="unit-option" data-unit="立方米">立方米</div>
                                    <div class="unit-option" data-unit="吨">吨</div>
                                    <div class="unit-option" data-unit="米">米</div>
                                    <div class="unit-option" data-unit="个">个</div>
                                    <div class="unit-option" data-unit="次">次</div>
                                    <div class="unit-option" data-unit="条">条</div>
                                    <div class="unit-option" data-unit="块">块</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: flex-end; gap: 10px;">
                        <button id="cancelAddSubProject" style="padding: 8px 20px; background-color: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 14px;">取消</button>
                        <button id="confirmAddSubProject" style="padding: 8px 20px; background-color: #1890ff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">确认</button>
                    </div>
                </div>
            `;
            
            // 添加到文档中
            document.body.appendChild(addSubProjectModal);
            
            // 设置单位选项样式
            const unitOptions = addSubProjectModal.querySelectorAll('.unit-option');
            unitOptions.forEach(option => {
                option.style.cssText = 'padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; color: #333;';
                option.addEventListener('mouseover', function() {
                    this.style.backgroundColor = '#f5f5f5';
                });
                option.addEventListener('mouseout', function() {
                    this.style.backgroundColor = '';
                });
            });
            
            // 快速选择下拉菜单事件
            const quickUnitSelect = addSubProjectModal.querySelector('#quickUnitSelect');
            const unitDropdown = addSubProjectModal.querySelector('#unitDropdown');
            const newSubProjectUnit = addSubProjectModal.querySelector('#newSubProjectUnit');
            
            quickUnitSelect.addEventListener('click', function(e) {
                e.stopPropagation();
                unitDropdown.style.display = unitDropdown.style.display === 'none' ? 'block' : 'none';
            });
            
            unitOptions.forEach(option => {
                option.addEventListener('click', function() {
                    newSubProjectUnit.value = this.getAttribute('data-unit');
                    unitDropdown.style.display = 'none';
                });
            });
            
            // 点击外部关闭下拉菜单
            document.addEventListener('click', function(e) {
                const quickUnitSelectEl = e.target.closest('#quickUnitSelect');
                if (!quickUnitSelectEl || !quickUnitSelectEl.parentNode) {
                    unitDropdown.style.display = 'none';
                }
            });
            
            // 关闭模态框
            addSubProjectModal.querySelector('#closeAddSubProjectModal').addEventListener('click', function() {
                addSubProjectModal.style.display = 'none';
                // 清空输入框
                newSubProjectName.value = '';
                newSubProjectUnit.value = '';
            });
            
            // 取消按钮
            addSubProjectModal.querySelector('#cancelAddSubProject').addEventListener('click', function() {
                addSubProjectModal.style.display = 'none';
                // 清空输入框
                newSubProjectName.value = '';
                newSubProjectUnit.value = '';
            });
            
            // 点击模态框外部关闭
            addSubProjectModal.addEventListener('click', function(e) {
                if (e.target === addSubProjectModal) {
                    addSubProjectModal.style.display = 'none';
                    // 清空输入框
                    newSubProjectName.value = '';
                    newSubProjectUnit.value = '';
                }
            });
            
            // 确认添加分项
            addSubProjectModal.querySelector('#confirmAddSubProject').addEventListener('click', function() {
                const newName = newSubProjectName.value.trim();
                const newUnit = newSubProjectUnit.value.trim();
                
                if (!newName) {
                    alert('请输入分项名称！');
                    return;
                }
                
                // 检查是否已存在该分项
                const subProjectList = document.getElementById('subProjectList');
                const existingItems = subProjectList.querySelectorAll('div > span');
                let exists = false;
                
                existingItems.forEach(item => {
                    if (item.textContent === newName) {
                        exists = true;
                    }
                });
                
                if (exists) {
                    alert('该分项已存在！');
                    return;
                }
                
                // 创建新的分项项
                const newItem = document.createElement('div');
                newItem.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 8px; border-radius: 4px; border: 1px solid #eee;';
                newItem.innerHTML = `
                    <span style="font-size: 16px;">${newName}</span>
                    <div style="display: flex; gap: 10px;">
                        <button class="editSubProjectBtn" data-name="${newName}" data-unit="${newUnit}" style="background: none; border: none; color: #1890ff; cursor: pointer; font-size: 16px; padding: 4px;" title="修改分项">
                            <i style="font-family: Arial; font-style: normal; font-weight: bold;">✏️</i>
                        </button>
                        <button class="deleteSubProjectBtn" data-name="${newName}" data-unit="${newUnit}" style="background: none; border: none; color: #ff4d4f; cursor: pointer; font-size: 16px; padding: 4px;" title="删除分项">
                            <i style="font-family: Arial; font-style: normal; font-weight: bold;">🗑️</i>
                        </button>
                    </div>
                `;
                
                subProjectList.appendChild(newItem);
                
                // 保存到本地存储
                saveSubProjectsToLocal();
                
                // 为新添加的分项div行绑定点击事件
                newItem.onclick = function(e) {
                    // 如果点击的是编辑或删除按钮，不触发选择事件
                    if (e.target.closest('.editSubProjectBtn') || e.target.closest('.deleteSubProjectBtn')) {
                        return;
                    }
                    
                    const span = this.querySelector('span');
                    if (!span) return;
                    
                    const currentSubProject = document.getElementById('currentSubProject');
                    if (currentSubProject) {
                        currentSubProject.textContent = span.textContent;
                        // 更新overtimeData中的分项数据
                        if (typeof window.overtimeData !== 'undefined') {
                            window.overtimeData.value = window.overtimeData.value || {};
                            window.overtimeData.value.subProject = span.textContent;
                        }
                    }
                    
                    // 获取分项的单位信息
                    const editBtn = this.querySelector('.editSubProjectBtn');
                    if (editBtn) {
                        const unit = editBtn.getAttribute('data-unit') || '';
                        
                        // 填充工量输入框后面的单位
                        const workAmountUnit = document.getElementById('workAmountUnit');
                        if (workAmountUnit) {
                            workAmountUnit.textContent = unit;
                        }
                        
                        // 填充单价输入框后面的单位，用/分隔
                        const unitPriceUnit = document.getElementById('unitPriceUnit');
                        if (unitPriceUnit) {
                            unitPriceUnit.textContent = unit ? `元/${unit}` : '元';
                        }
                    }
                    
                    const subProjectModal = document.getElementById('subProjectModal');
                    if (subProjectModal) {
                        subProjectModal.style.display = 'none';
                    }
                };
                
                // 为新添加的按钮直接绑定事件
                const editBtn = newItem.querySelector('.editSubProjectBtn');
                const deleteBtn = newItem.querySelector('.deleteSubProjectBtn');
                
                // 绑定编辑按钮事件
                editBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const oldName = this.getAttribute('data-name');
                    const oldUnit = this.getAttribute('data-unit') || '';
                    
                    // 创建修改分项模态框
                    let editModal = document.getElementById('editSubProjectModal');
                    if (editModal) {
                        editModal.remove();
                    }
                    
                    editModal = document.createElement('div');
                    editModal.id = 'editSubProjectModal';
                    editModal.className = 'modal';
                    editModal.style.cssText = 'display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1002; align-items: center; justify-content: center;';
                    
                    editModal.innerHTML = `
                        <div style="background-color: white; border-radius: 8px; width: 500px; max-width: 90%; padding: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="margin: 0; font-size: 18px; color: #333;">修改分项</h3>
                                <button id="closeEditSubProjectModal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">×</button>
                            </div>
                            <div style="margin-bottom: 20px;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                    <span style="color: red; font-weight: bold;">*</span>
                                    <label style="color: black; margin: 0;">分项名称：</label>
                                    <input type="text" id="editSubProjectName" value="${oldName}" 
                                           style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: red; font-weight: bold;">*</span>
                                    <span style="color: black; margin: 0;">分项单位：</span>
                                    <input type="text" id="editSubProjectUnit" value="${oldUnit}" 
                                           placeholder="请输入单位名称(不超过四个汉字)" 
                                           style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                    <div style="position: relative;">
                                        <button id="editQuickUnitSelect" style="padding: 8px 12px; background-color: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 14px; min-width: 100px;">
                                            快速选择 ▼
                                        </button>
                                        <div id="editUnitDropdown" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; z-index: 1003; box-shadow: 0 2px 8px rgba(0,0,0,0.15); min-width: 100px; max-height: 200px; overflow-y: auto;">
                                            <div class="edit-unit-option" data-unit="平方米">平方米</div>
                                            <div class="edit-unit-option" data-unit="立方米">立方米</div>
                                            <div class="edit-unit-option" data-unit="吨">吨</div>
                                            <div class="edit-unit-option" data-unit="米">米</div>
                                            <div class="edit-unit-option" data-unit="个">个</div>
                                            <div class="edit-unit-option" data-unit="次">次</div>
                                            <div class="edit-unit-option" data-unit="条">条</div>
                                            <div class="edit-unit-option" data-unit="块">块</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                                <button id="cancelEditSubProject" style="padding: 8px 20px; background-color: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 14px;">取消</button>
                                <button id="confirmEditSubProject" style="padding: 8px 20px; background-color: #1890ff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">确认</button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(editModal);
                    
                    // 绑定模态框内的事件
                    const editUnitOptions = editModal.querySelectorAll('.edit-unit-option');
                    editUnitOptions.forEach(option => {
                        option.style.cssText = 'padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; color: #333;';
                        option.addEventListener('mouseover', function() {
                            this.style.backgroundColor = '#f5f5f5';
                        });
                        option.addEventListener('mouseout', function() {
                            this.style.backgroundColor = '';
                        });
                        option.addEventListener('click', function() {
                            editModal.querySelector('#editSubProjectUnit').value = this.getAttribute('data-unit');
                            editModal.querySelector('#editUnitDropdown').style.display = 'none';
                        });
                    });
                    
                    const editQuickUnitSelect = editModal.querySelector('#editQuickUnitSelect');
                    const editUnitDropdown = editModal.querySelector('#editUnitDropdown');
                    editQuickUnitSelect.addEventListener('click', function(e) {
                        e.stopPropagation();
                        editUnitDropdown.style.display = editUnitDropdown.style.display === 'none' ? 'block' : 'none';
                    });
                    
                    // 关闭模态框事件
                    editModal.querySelector('#closeEditSubProjectModal').addEventListener('click', function() {
                        editModal.remove();
                    });
                    
                    editModal.querySelector('#cancelEditSubProject').addEventListener('click', function() {
                        editModal.remove();
                    });
                    
                    editModal.addEventListener('click', function(e) {
                        if (e.target === editModal) {
                            editModal.remove();
                        }
                    });
                    
                    // 确认修改事件
                    editModal.querySelector('#confirmEditSubProject').addEventListener('click', function() {
                        const newNameValue = editModal.querySelector('#editSubProjectName').value.trim();
                        const newUnitValue = editModal.querySelector('#editSubProjectUnit').value.trim();
                        
                        if (!newNameValue) {
                            alert('请输入分项名称！');
                            return;
                        }
                        
                        // 更新分项显示
                        const spanElement = editBtn.parentElement.previousElementSibling;
                        if (spanElement) {
                            spanElement.textContent = newNameValue;
                        }
                        editBtn.setAttribute('data-name', newNameValue);
                        editBtn.setAttribute('data-unit', newUnitValue);
                        deleteBtn.setAttribute('data-name', newNameValue);
                        deleteBtn.setAttribute('data-unit', newUnitValue);
                        
                        // 更新当前选中的分项（如果是被修改的这个）
                        const currentSubProject = document.getElementById('currentSubProject');
                        if (currentSubProject && currentSubProject.textContent === oldName) {
                            currentSubProject.textContent = newNameValue;
                        }
                        
                        editModal.remove();
                    });
                });
                
                // 绑定删除按钮事件
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const name = this.getAttribute('data-name');
                    
                    // 移除至少保留一个分项的限制
                    /*
                    const totalItems = document.querySelectorAll('#subProjectList > div').length;
                    if (totalItems <= 1) {
                        alert('至少需要保留一个分项！');
                        return;
                    }
                    */
                    
                    if (confirm(`确定要删除分项"${name}"吗？`)) {
                        // 如果删除的是当前选中的分项，清空当前选中显示
                        const currentSubProject = document.getElementById('currentSubProject');
                        if (currentSubProject && currentSubProject.textContent === name) {
                            // 删除后清空当前选中显示
                            newItem.remove();
                            currentSubProject.textContent = '选择分项';
                        } else {
                            newItem.remove();
                        }
                        
                        // 保存到本地存储
                        saveSubProjectsToLocal();
                    }
                });
                
                // 关闭模态框
                addSubProjectModal.style.display = 'none';
                
                // 清空输入框
                newSubProjectName.value = '';
                newSubProjectUnit.value = '';
            });
        }
        
        // 修改添加分项按钮的点击事件
        function updateAddSubProjectBtn() {
            const addSubProjectBtn = document.getElementById('addSubProjectBtn');
            if (addSubProjectBtn) {
                addSubProjectBtn.onclick = function() {
                    const addSubProjectModal = document.getElementById('addSubProjectModal');
                    if (addSubProjectModal) {
                        addSubProjectModal.style.display = 'flex';
                    }
                };
            }
        }
        
        // 标签页切换功能
        function initTabSwitching() {
            const tabWorkRecord = document.getElementById('tabWorkRecord');
            const tabWorkFlow = document.getElementById('tabWorkFlow');
            const workRecordTabContent = document.getElementById('workRecordTabContent');
            
            // 创建记工流水标签页内容容器
            const workFlowContent = document.createElement('div');
            workFlowContent.id = 'workFlowTabContent';
            workFlowContent.style.display = 'none';
            workFlowContent.style.maxHeight = 'calc(100vh - 170px)';
            workFlowContent.style.overflowY = 'auto';
            workFlowContent.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">记工流水内容区域</div>';
            
            // 将记工流水内容容器插入到记工内容容器之后
            workRecordTabContent.parentNode.insertBefore(workFlowContent, workRecordTabContent.nextSibling);
            
            // 标签页切换事件
            function switchTab(targetTab) {
                // 分别处理标签页导航和工作类型选择的active状态
                
                // 处理标签页导航的active状态
                const tabLabels = document.querySelectorAll('label[for="tabWorkRecord"], label[for="tabWorkFlow"]');
                tabLabels.forEach(label => {
                    label.classList.remove('active');
                });
                
                // 隐藏所有内容
                workRecordTabContent.style.display = 'none';
                workFlowContent.style.display = 'none';
                
                // 通知父页面更新标题
                if (window.parent && window.parent !== window) {
                    const targetOrigin = window.location.origin || '*';
                    if (targetTab === '记工') {
                        window.parent.postMessage({
                            type: 'updateTitle',
                            page: '记工.html'
                        }, targetOrigin);
                    } else if (targetTab === '记工流水') {
                        window.parent.postMessage({
                            type: 'updateTitle',
                            page: '记工流水'
                        }, targetOrigin);
                    }
                }
                
                if (targetTab === '记工') {
                    // 显示记工标签页
                    document.querySelector('label[for="tabWorkRecord"]').classList.add('active');
                    workRecordTabContent.style.display = 'block';
                    
                    // 恢复整个页面的滚动
                    document.body.style.overflow = '';
                    
                    // 显示确认记工按钮
                    const confirmButton = document.getElementById('confirmBtn');
                    if (confirmButton) {
                        confirmButton.style.display = 'inline-block';
                    }
                    
                    // 检查URL参数中是否有记录ID（编辑模式）
                    const urlParams = new URLSearchParams(window.location.search);
                    const record_idFromUrl = urlParams.get('record_id');
                    
                    // 如果URL中没有record_id参数，但confirmButton的文本是'保存修改'，则恢复为'确认记工'
                    if (!record_idFromUrl && confirmButton && confirmButton.textContent === '保存修改') {
                        confirmButton.textContent = '确认记工';
                        confirmButton.onclick = () => window.workRecordService.confirmWorkRecord();
                        
                        // 恢复确认记工按钮样式
                        confirmButton.style.padding = '8px 16px';
                        confirmButton.style.background = 'linear-gradient(135deg, #1890ff 0%, #096dd9 100%)';
                        confirmButton.style.color = 'white';
                        confirmButton.style.border = 'none';
                        confirmButton.style.borderRadius = '8px';
                        confirmButton.style.cursor = 'pointer';
                        confirmButton.style.fontSize = '16px';
                        confirmButton.style.fontWeight = 'bold';
                        confirmButton.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                        confirmButton.style.boxShadow = '0 2px 8px rgba(24, 144, 255, 0.3)';
                        confirmButton.style.marginRight = '0';
                        
                        // 隐藏删除记工按钮
                        const deleteButton = document.getElementById('deleteBtn');
                        if (deleteButton) {
                            deleteButton.style.display = 'none';
                        }
                        
                        // 调用loadNormalMode函数，将isEditMode设置为false
                        loadNormalMode();
                    }
                    
                    // 检查是否处于编辑模式，如果是则显示删除记工按钮
                    const isInEditMode = confirmButton && confirmButton.textContent === '保存修改';
                    if (isInEditMode) {
                        const deleteButton = document.getElementById('deleteBtn');
                        if (deleteButton) {
                            deleteButton.style.display = 'inline-block';
                        }
                    }
                    
                    // 自动选中点工选项并显示相应内容
                    const pointWorkRadio = document.getElementById('workType1');
                    const pointWorkLabel = document.querySelector('label[for="workType1"]');
                    if (pointWorkRadio && pointWorkLabel) {
                        pointWorkRadio.checked = true;
                        pointWorkLabel.classList.add('active');
                        
                        // 手动触发工作类型change事件以显示点工内容
                        const workTypeEvent = new Event('change');
                        pointWorkRadio.dispatchEvent(workTypeEvent);
                        
                        // 确保dayWorkOptions显示
                        const dayWorkOptions = document.getElementById('dayWorkOptions');
                        if (dayWorkOptions) {
                            dayWorkOptions.style.display = 'block';
                        }
                        
                        // 隐藏其他工作类型的输入框
                        const amountInputContainer = document.getElementById('amountInputContainer');
                        if (amountInputContainer) {
                            amountInputContainer.style.display = 'none';
                        }
                        
                        const workAmountInputContainer = document.getElementById('workAmountInputContainer');
                        if (workAmountInputContainer) {
                            workAmountInputContainer.style.display = 'none';
                        }
                    }
                } else if (targetTab === '记工流水') {
                    // 显示记工流水标签页
                    document.querySelector('label[for="tabWorkFlow"]').classList.add('active');
                    workFlowContent.style.display = 'block';
                    
                    // 禁止整个页面滚动，只保留记工列表的滚动条
                    document.body.style.overflow = 'hidden';
                    
                    // 取消工作类型选择区域的选中状态
                    document.querySelectorAll('input[name="workType"]').forEach(radio => {
                        radio.checked = false;
                    });
                    document.querySelectorAll('label[for^="workType"]').forEach(label => {
                        label.classList.remove('active');
                    });
                    
                    // 重置点工页面的所有按钮
                    // 重置1个工按钮为默认状态
                    if (window.resetDayWork1Button) {
                        window.resetDayWork1Button();
                    }
                    
                    // 重置小时选择器按钮为默认状态
                    if (window.resetHoursSelectorButton) {
                        window.resetHoursSelectorButton();
                    }
                    
                    // 重置所有daywork-btn按钮状态
                    document.querySelectorAll('.daywork-btn').forEach(btn => {
                        btn.classList.remove('active');
                        btn.style.backgroundColor = '#f5f5f5';
                        btn.style.color = '#333';
                        btn.style.border = '1px solid #ddd';
                    });
                    
                    // 重置上下午按钮文本
                    const morningAfternoonBtn = document.getElementById('morningAfternoonBtn');
                    if (morningAfternoonBtn) {
                        morningAfternoonBtn.innerHTML = '上下午';
                    }
                    
                    // 重置隐藏的单选按钮
                    document.querySelectorAll('input[name="dayWork"]').forEach(radio => {
                        radio.checked = false;
                    });
                    
                    // 刷新记工流水数据
                    if (window.workFlowService && window.workFlowService.refreshWorkFlow) {
                        window.workFlowService.refreshWorkFlow();
                    }
                }
            }
            
            // 添加工作类型选择的自动切换功能
            function setupWorkTypeAutoSwitch() {
                // 监听工作类型标签的点击事件（只在记工流水标签页中点击工作类型时才切换）
                const workTypeLabels = document.querySelectorAll('label[for^="workType"]');
                workTypeLabels.forEach(label => {
                    label.addEventListener('click', function(e) {
                        // 只有当当前在记工流水标签页时，点击工作类型标签才切换到记工标签
                        if (tabWorkFlow && tabWorkFlow.checked) {
                            console.log('从记工流水切换到记工，当前点击的工作类型:', this.getAttribute('for'));
                            tabWorkRecord.checked = true;
                            switchTab('记工');
                        }
                    });
                });
                
                // 监听单选按钮的change事件，更新工作类型标签的active状态
                const workTypeOptions = document.querySelectorAll('input[name="workType"]');
                workTypeOptions.forEach(radio => {
                    radio.addEventListener('change', function() {
                        if (this.checked) {
                            // 更新工作类型标签的active状态
                            document.querySelectorAll('input[name="workType"]').forEach(r => {
                                const label = document.querySelector(`label[for="${r.id}"]`);
                                if (label) {
                                    if (r.checked) {
                                        label.classList.add('active');
                                    } else {
                                        label.classList.remove('active');
                                    }
                                }
                            });
                        }
                    });
                });
            }
            
            // 绑定标签页切换事件
            tabWorkRecord.addEventListener('change', function() {
                if (this.checked) {
                    switchTab('记工');
                }
            });
            
            tabWorkFlow.addEventListener('change', function() {
                if (this.checked) {
                    switchTab('记工流水');
                }
            });
            
            // 设置工作类型自动切换功能
            setupWorkTypeAutoSwitch();
            
            // 初始化显示记工标签页
            switchTab('记工');
        }

        // 页面加载完成后初始化所有功能
        document.addEventListener('DOMContentLoaded', function() {
            init();
            initAddSubProjectModal();
            updateAddSubProjectBtn();
            initTabSwitching(); // 初始化标签页切换功能
            
            // 延迟初始化实时订阅，确保所有资源都已加载
            setTimeout(initRealtimeSubscription, 1000);
        });
        
        // 监听来自父页面的消息，用于实时更新
        window.addEventListener('message', function(event) {
            // 验证消息来源（在本地开发环境中可能无法验证）
            // 在生产环境中应使用具体的域名验证
            
            try {
                if (event.data && typeof event.data === 'object') {
                    switch (event.data.type) {
                        case 'refreshAttendanceData':
                            console.log('🔄 收到考勤数据刷新指令', event.data);
                            
                            // 检查projectId是否匹配
                            // 尝试获取当前项目ID，支持两种命名格式：project_id（下划线）和projectId（驼峰）
                            const urlParams = new URLSearchParams(window.location.search);
                            let currentProjectId = urlParams.get('project_id');
                            if (!currentProjectId) {
                                currentProjectId = urlParams.get('projectId');
                            }
                            if (event.data.projectId && event.data.projectId !== currentProjectId) {
                                console.log(`⏭️ 项目ID不匹配，跳过刷新 (收到: ${event.data.projectId}, 当前: ${currentProjectId})`);
                                break;
                            }
                            // 重新加载考勤数据
                            if (typeof window.workFlowService !== 'undefined') {
                                // 刷新记工流水数据
                                if (typeof window.workFlowService.refreshWorkFlow === 'function') {
                                    window.workFlowService.refreshWorkFlow().then(() => {
                                        // 刷新完成后更新已记标记
                                        if (window.checkMarkedEmployees) {
                                            window.checkMarkedEmployees();
                                            console.log('✅ 已更新已记标记');
                                        }
                                        console.log('✅ 已触发记工流水刷新');
                                    });
                                }
                            }
                            // 触发日期选择器刷新
                            const workDateInput = document.getElementById('workDate');
                            if (workDateInput) {
                                // 触发日期变更事件，确保日期选择器状态正确
                                const dateChangeEvent = new Event('change');
                                workDateInput.dispatchEvent(dateChangeEvent);
                                console.log('✅ 已触发日期选择器刷新');
                            }
                            // 同时刷新考勤记录数据
                            if (typeof window.workRecordService !== 'undefined' && 
                               typeof window.workRecordService.loadAttendanceRecords === 'function') {
                                window.workRecordService.loadAttendanceRecords();
                                console.log('✅ 已触发考勤数据刷新');
                            }
                            break;
                        case 'refreshData':
                            console.log('🔄 收到通用数据刷新指令');
                            // 重新加载所有相关数据
                            if (typeof window.workFlowService !== 'undefined') {
                                // 刷新记工流水数据
                                if (typeof window.workFlowService.refreshWorkFlow === 'function') {
                                    window.workFlowService.refreshWorkFlow().then(() => {
                                        // 刷新完成后更新已记标记
                                        if (window.checkMarkedEmployees) {
                                            window.checkMarkedEmployees();
                                            console.log('✅ 已更新已记标记');
                                        }
                                        console.log('✅ 已触发记工流水刷新');
                                    });
                                }
                            }
                            // 同时刷新考勤记录数据
                            if (typeof window.workRecordService !== 'undefined' && 
                               typeof window.workRecordService.loadAttendanceRecords === 'function') {
                                window.workRecordService.loadAttendanceRecords();
                                console.log('✅ 已触发考勤数据刷新');
                            }
                            break;
                        default:
                            // 忽略其他类型的消息
                            break;
                    }
                }
            } catch (error) {
                console.error('处理消息时发生错误:', error);
            }
        });
        
        // 初始化实时订阅 - 子页面不需要重复订阅，由首页统一管理
        function initRealtimeSubscription() {
            // 子页面不需要重复订阅，由首页统一管理实时订阅
            // 仅需监听来自父页面的消息即可
        }
    </script>
</body>
</html>
</html>