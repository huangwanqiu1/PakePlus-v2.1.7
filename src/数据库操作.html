<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据库操作 - 飞鱼考勤系统</title>
    <!-- 本地加载完整的Supabase库 -->
    <script src="JavaScript/supabase/supabase.min.js"></script>
    <!-- 加载浏览器环境的Supabase配置 -->
    <script src="JavaScript/supabase/supabase-client.js"></script>
    
    <!-- 消息监听器错误修复 -->
    <script>
        // 完全重写消息处理逻辑，避免异步响应问题
        (function() {
            // 保存原始的console.error方法以进行错误过滤
            const originalConsoleError = console.error;
            
            // 重写console.error，过滤特定的错误
            console.error = function(...args) {
                // 将参数转换为字符串以检查是否包含特定错误信息
                const errorMessage = args.join(' ');
                
                // 过滤掉网络错误和Chrome扩展错误
                if (errorMessage.includes('net::ERR_ABORTED') || 
                    (errorMessage.includes('Unchecked runtime.lastError') && 
                    errorMessage.includes('listener indicated an asynchronous response'))) {
                    // 静默处理这些特定错误，不输出到控制台
                    return;
                }
                
                // 其他错误正常输出
                originalConsoleError.apply(console, args);
            };
            
            // 优化postMessage处理，避免消息通道关闭问题
            const originalPostMessage = window.postMessage;
            window.postMessage = function(message, targetOrigin, transfer) {
                try {
                    // 确保targetOrigin安全设置
                    if (!targetOrigin || targetOrigin === '*') {
                        console.warn('不安全的postMessage调用，未指定targetOrigin');
                    }
                    // 正常执行postMessage
                    originalPostMessage.apply(window, arguments);
                } catch (e) {
                    // 捕获并静默处理错误
                }
            };
            
            // 首先使用capture选项来确保我们的监听器先执行
            window.addEventListener('message', handleMessageEvent, { capture: true });
            
            // 定义消息处理函数
            function handleMessageEvent(event) {
                try {
                    // 处理消息数据
                    if (event.data && typeof event.data === 'object') {
                        // 消息类型处理
                        switch (event.data.type) {
                            case 'updateTitle':
                                if (event.data.project_name) {
                                    // 处理项目名称更新
                                    setTimeout(() => {
                                        const headerTitle = document.getElementById('headerTitle');
                                        if (headerTitle) {
                                            headerTitle.textContent = event.data.project_name;
                                        }
                                    }, 0);
                                }
                                break;
                            case 'navigate':
                                if (event.data.page) {
                                    // 导航处理
                                    setTimeout(() => {
                                        window.location.href = event.data.page;
                                    }, 0);
                                }
                                break;
                            default:
                                // 忽略其他类型的消息
                                break;
                        }
                    }
                } catch (e) {
                    // 静默处理错误，不抛出异常
                }
                
                // 重要：不要在这里返回任何值，特别是不要返回true
                // 这是防止异步响应错误的关键
            }
            
            // 清理函数，用于在组件卸载时移除监听器
            window.cleanupMessageListeners = function() {
                window.removeEventListener('message', handleMessageEvent, { capture: true });
            };
        })();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 25px;
            border: 1px solid #e8e8e8;
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        
        /* 选项卡样式 */
        .tabs {
            display: flex;
            border-bottom: 2px solid #1890ff;
            margin-bottom: 20px;
        }
        
        .tab-button {
            padding: 12px 24px;
            background-color: #f5f5f5;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s ease;
            margin-right: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .tab-button:hover {
            color: #1890ff;
            background-color: #e6f7ff;
            transform: translateY(-1px);
        }
        
        .tab-button.active {
            color: white;
            background-color: #1890ff;
            font-weight: bold;
            position: relative;
            z-index: 2;
            box-shadow: 0 2px 8px rgba(24, 144, 255, 0.3);
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 0 8px 8px 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            position: relative;
            top: -1px;
            z-index: 1;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        
        .section h2 {
            color: #666;
            margin-bottom: 15px;
            border-bottom: 2px solid #1890ff;
            padding-bottom: 5px;
        }
        
        .operation-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group textarea {
            height: 80px;
            resize: vertical;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: #1890ff;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #096dd9;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background-color: #52c41a;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #389e0d;
            transform: translateY(-1px);
        }
        
        .btn-warning {
            background-color: #faad14;
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #d48806;
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background-color: #ff4d4f;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #cf1322;
            transform: translateY(-1px);
        }
        
        .btn-info {
            background-color: #13c2c2;
            color: white;
        }
        
        .btn-info:hover {
            background-color: #08979c;
            transform: translateY(-1px);
        }
        
        .result-panel {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .result-item {
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
            font-family: monospace;
            font-size: 12px;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .success {
            color: #52c41a;
        }
        
        .error {
            color: #ff4d4f;
        }
        
        .info {
            color: #1890ff;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 15px;
            max-height: 500px; /* 设置最大高度，使其可以滚动 */
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        th {
            background-color: #f0f0f0;
            font-weight: bold;
            position: sticky; /* 标题行固定 */
            top: 0;
            z-index: 10; /* 确保标题行在内容之上 */
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .status-badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .status-success {
            background-color: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }
        
        .status-error {
            background-color: #fff2f0;
            color: #ff4d4f;
            border: 1px solid #ffccc7;
        }
        
        .status-info {
            background-color: #e6f7ff;
            color: #1890ff;
            border: 1px solid #91d5ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>数据库操作 - 飞鱼考勤系统</h1>
        
        <!-- 选项卡 -->
        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('database')">数据库</button>
            <button class="tab-button" onclick="switchTab('user')">用户管理</button>
            <button class="tab-button" onclick="switchTab('project')">项目管理</button>
            <button class="tab-button" onclick="switchTab('employee')">员工管理</button>
            <button class="tab-button" onclick="switchTab('attendance')">记工记录</button>
        </div>
        
        <!-- 数据库选项卡内容 -->
        <div id="database" class="tab-content active">
            <!-- 数据模式切换 -->
            <div class="section">
                <h2>数据模式切换</h2>
                <div class="button-group">
                    <button id="localModeBtn" class="btn-primary" onclick="switchToLocalMode()">本地模式</button>
                    <button id="supabaseModeBtn" class="btn-info" onclick="switchToSupabaseMode()">Supabase数据库模式</button>
                </div>
                <div id="modeStatus" class="result-panel" style="margin-top: 10px;"></div>
            </div>
            
            <!-- 数据库连接状态 -->
            <div class="section">
                <h2>数据库连接状态</h2>
                <div class="form-group">
                    <button class="btn-info" onclick="checkDatabaseStatus()">检查数据库状态</button>
                    <div id="databaseStatus" class="result-panel"></div>
                </div>
            </div>
            
            <!-- 数据库维护操作 -->
            <div class="section">
                <h2>数据库维护</h2>
                <div class="button-group">
                    <button class="btn-info" onclick="backupDatabase()">数据备份</button>
                    <button class="btn-warning" onclick="restoreDatabase()">数据恢复</button>
                    <button class="btn-danger" onclick="clearDatabase()">清空数据</button>
                    <button class="btn-success" onclick="exportData()">导出数据</button>
                </div>
                
                <div id="maintenanceResults" class="result-panel"></div>
            </div>
        </div>
        
        <!-- 用户管理选项卡内容 -->
        <div id="user" class="tab-content">
            <!-- 用户管理操作 -->
                <div class="section">
                <div class="operation-panel">
                    <div>
                        <div class="form-group" style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="phoneInput" placeholder="请输入手机号" style="width: 33.33%;">
                            <select id="userAccount" placeholder="请选择账号ID" style="width: 66.67%;">
                                <option value="">-- 请选择账号ID --</option>
                            </select>
                        </div>
                        <div class="button-group">
                            <button class="btn-info" onclick="queryUserByAccount()">按手机号查询</button>
                            <button class="btn-danger" onclick="deleteUser()">删除用户</button>
                            <button class="btn-success" onclick="listAllUsers()">查询所有用户</button>
                        </div>
                    </div>
                    
                    <div>
                        <div class="button-group">
                            <button class="btn-info" onclick="exportUsers()">导出用户数据</button>
                            <button class="btn-danger" onclick="clearAllUsers()">清空所有用户</button>
                        </div>
                    </div>
                </div>
                
                <div id="userResults" class="result-panel"></div>
            </div>
        </div>
        
        <!-- 项目管理选项卡内容 -->
        <div id="project" class="tab-content">
            <!-- 项目管理操作 -->
            <div class="section">
                <div style="display: flex; justify-content: center; padding: 20px; background: #f5f5f5; border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <select id="projectPhone" style="padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 6px; font-size: 14px; background-color: white; transition: all 0.3s;" title="选择账号"></select>
                            </div>
                            <button class="btn-info" onclick="listProjects()" style="padding: 8px 20px; border-radius: 4px;">查询项目</button>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <select id="projectName" style="padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 6px; font-size: 14px; background-color: white; transition: all 0.3s;" title="选择项目名称"></select>
                            </div>
                            <button class="btn-danger" onclick="deleteProject()" style="padding: 8px 20px; border-radius: 4px;">删除项目</button>
                        <button class="btn-warning" onclick="clearAllProjects()" style="padding: 8px 20px; border-radius: 4px;">清除所有项目</button>
                        <button class="btn-success" onclick="exportProjectData()" style="padding: 8px 20px; border-radius: 4px;">导出项目数据</button>
                    </div>
                </div>
                
                <div id="projectResults" class="result-panel"></div>
            </div>
        </div>
        
        <!-- 员工管理选项卡内容 -->
        <div id="employee" class="tab-content">
            <!-- 员工管理操作 -->
            <div class="section" style="background-color: white; border-radius: 12px; border: 1px solid #e8e8e8; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                <div style="display: flex; align-items: center; justify-content: flex-end; margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #f6f8fa 0%, #ffffff 100%); border-radius: 8px; border: 1px solid #e8e8e8;">
                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <select id="currentPhone" style="padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 6px; font-size: 14px; background-color: white; transition: all 0.3s;" title="选择账号"></select>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <select id="currentProject" style="padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 6px; font-size: 14px; background-color: white; transition: all 0.3s;" title="选择项目"></select>
                        </div>
                        <button class="btn-info" onclick="listEmployees()" style="padding: 8px 20px; border-radius: 6px; font-weight: 500;">查询员工</button>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <select id="employeeNames" style="padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 6px; font-size: 14px; background-color: white; transition: all 0.3s;" title="工号"></select>
                        </div>
                        <button class="btn-danger" onclick="deleteEmployeeById()" style="padding: 8px 20px; border-radius: 6px; font-weight: 500;">删除员工</button>
                        <button class="btn-warning" onclick="deleteAllEmployees()" style="padding: 8px 20px; border-radius: 6px; font-weight: 500;">全部删除</button>
                        <button class="btn-success" onclick="exportEmployeeData()" style="padding: 8px 20px; border-radius: 6px; font-weight: 500;">导出员工数据</button>
                    </div>
                </div>
                <div class="operation-panel">
                    <!-- 操作面板内容 -->
                </div>
                
                <div id="employeeResults" class="result-panel"></div>
            </div>
        </div>
        
        <!-- 记工记录选项卡内容 -->
        <div id="attendance" class="tab-content">
            <!-- 记工记录操作 -->
            <div class="section">
                <h2>记工记录管理 (CRUD操作)</h2>
                <div class="operation-panel">
                    <div>
                        <h3>创建记工记录</h3>
                        <div class="form-group">
                            <label>项目ID:</label>
                            <input type="text" id="attendanceProject" placeholder="请输入项目ID">
                        </div>
                        <div class="form-group">
                            <label>员工ID:</label>
                            <input type="text" id="attendanceEmployee" placeholder="请输入员工ID">
                        </div>
                        <div class="form-group">
                            <label>记工日期:</label>
                            <input type="date" id="attendanceDate">
                        </div>
                        <div class="form-group">
                            <label>工作类型:</label>
                            <select id="attendanceType">
                                <option value="点工">点工</option>
                                <option value="包工">包工</option>
                                <option value="工量">工量</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>工数/工时:</label>
                            <input type="number" id="attendanceWork" value="1" step="0.5">
                        </div>
                        <div class="button-group">
                            <button class="btn-primary" onclick="createAttendance()">创建记录</button>
                            <button class="btn-info" onclick="queryAttendance()">查询记录</button>
                        </div>
                    </div>
                    
                    <div>
                        <h3>记工记录操作</h3>
                        <div class="form-group">
                            <label>记录ID:</label>
                            <input type="text" id="attendanceId" placeholder="请输入记录ID">
                        </div>
                        <div class="button-group">
                            <button class="btn-success" onclick="readAttendance()">读取记录</button>
                            <button class="btn-warning" onclick="updateAttendance()">更新记录</button>
                            <button class="btn-danger" onclick="deleteAttendance()">删除记录</button>
                        </div>
                        
                        <h3 style="margin-top: 20px;">高级查询</h3>
                        <div class="form-group">
                            <label>查询条件:</label>
                            <textarea id="advancedQuery" placeholder='例如: {"projectId": "项目ID", "date": {"$gte": "2024-01-01"}}'></textarea>
                        </div>
                        <div class="button-group">
                            <button class="btn-info" onclick="advancedQuery()">执行高级查询</button>
                        </div>
                    </div>
                </div>
                
                <div id="attendanceResults" class="result-panel"></div>
            </div>
        </div>
    </div>

    <script>
        // 数据模式管理
        let currentDataMode = localStorage.getItem('dataMode') || 'local'; // 默认本地模式
        
        // 初始化数据模式
        function initDataMode() {
            updateModeButtons();
            updateModeStatus();
        }
        
        // 通知提示函数
        function showNotification(message, isError = false) {
            // 检查是否已有通知元素
            let notificationElement = document.getElementById('notification');
            
            if (!notificationElement) {
                // 创建通知元素
                notificationElement = document.createElement('div');
                notificationElement.id = 'notification';
                notificationElement.style.position = 'fixed';
                notificationElement.style.top = '20px';
                notificationElement.style.right = '20px';
                notificationElement.style.padding = '12px 20px';
                notificationElement.style.borderRadius = '5px';
                notificationElement.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
                notificationElement.style.zIndex = '9999';
                notificationElement.style.transition = 'opacity 0.3s, transform 0.3s';
                notificationElement.style.opacity = '0';
                notificationElement.style.transform = 'translateY(-20px)';
                notificationElement.style.fontFamily = 'Arial, sans-serif';
                notificationElement.style.fontSize = '14px';
                notificationElement.style.fontWeight = '500';
                document.body.appendChild(notificationElement);
            }
            
            // 设置消息内容和样式
            notificationElement.textContent = message;
            notificationElement.style.backgroundColor = isError ? '#f8d7da' : '#d4edda';
            notificationElement.style.color = isError ? '#721c24' : '#155724';
            notificationElement.style.border = `1px solid ${isError ? '#f5c6cb' : '#c3e6cb'}`;
            
            // 显示通知
            notificationElement.style.opacity = '1';
            notificationElement.style.transform = 'translateY(0)';
            
            // 3秒后自动隐藏
            setTimeout(() => {
                notificationElement.style.opacity = '0';
                notificationElement.style.transform = 'translateY(-20px)';
            }, 3000);
        }
        
        // 切换到本地模式
        function switchToLocalMode() {
            localStorage.setItem('dataMode', 'local');
            currentDataMode = 'local';
            updateModeButtons();
            updateModeStatus();
            showNotification('已切换到本地模式，所有数据操作将使用本地存储', false);
        }
        
        // 切换到Supabase模式
        function switchToSupabaseMode() {
            localStorage.setItem('dataMode', 'supabase');
            currentDataMode = 'supabase';
            updateModeButtons();
            updateModeStatus();
            showNotification('已切换到Supabase数据库模式，所有数据操作将使用Supabase', false);
        }
        
        // 更新模式按钮样式
        function updateModeButtons() {
            const localBtn = document.getElementById('localModeBtn');
            const supabaseBtn = document.getElementById('supabaseModeBtn');
            
            if (currentDataMode === 'local') {
                localBtn.classList.add('active');
                localBtn.classList.remove('btn-primary');
                localBtn.classList.add('btn-success');
                supabaseBtn.classList.remove('active');
                supabaseBtn.classList.remove('btn-success');
                supabaseBtn.classList.add('btn-info');
            } else {
                supabaseBtn.classList.add('active');
                supabaseBtn.classList.remove('btn-info');
                supabaseBtn.classList.add('btn-success');
                localBtn.classList.remove('active');
                localBtn.classList.remove('btn-success');
                localBtn.classList.add('btn-primary');
            }
        }
        
        // 更新模式状态显示
        function updateModeStatus() {
            const modeStatus = document.getElementById('modeStatus');
            if (currentDataMode === 'local') {
                modeStatus.innerHTML = '<div class="result-item success">✅ 当前模式：本地模式 - 数据将保存在浏览器本地存储中</div>';
            } else {
                modeStatus.innerHTML = '<div class="result-item info">ℹ️ 当前模式：Supabase数据库模式 - 数据将保存在Supabase数据库中</div>';
            }
        }
        
        // 选项卡切换函数
        function switchTab(tabId) {
            // 隐藏所有选项卡内容
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // 移除所有选项卡按钮的活动状态
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });
            
            // 显示选中的选项卡内容
            document.getElementById(tabId).classList.add('active');
            
            // 激活选中的选项卡按钮
            event.currentTarget.classList.add('active');
            
            // 如果切换到用户管理选项卡，刷新账号ID下拉框
            if (tabId === 'user') {
                setTimeout(fillUserAccountsDropdown, 100);
            }
        }
        
        // 数据库状态检查
        async function checkDatabaseStatus() {
            const statusDiv = document.getElementById('databaseStatus');
            statusDiv.innerHTML = '<div class="result-item info">正在检查数据库状态...</div>';
            
            // 获取当前数据模式
            const currentDataMode = localStorage.getItem('dataMode') || 'local';
            
            try {
                if (currentDataMode === 'local') {
                    // 本地模式：检查localStorage状态
                    statusDiv.innerHTML = `
                        <div class="result-item success">✅ 本地存储状态正常</div>
                        <div class="result-item info">当前使用本地存储模式</div>
                        <div class="result-item info">数据保存在浏览器本地</div>
                    `;
                } else {
                    // Supabase模式：检查Supabase数据库连接
                    if (!window.supabase) {
                        throw new Error('Supabase客户端未初始化');
                    }
                    
                    // 测试Supabase连接
                    let connectionSuccess = false;
                    let actualTables = [];
                    
                    try {
                        // 直接使用备用方案：尝试查询一些核心表（更可靠）
                        console.log('使用核心表测试Supabase连接');
                        const coreTables = ['users', 'projects', 'employees', 'attendance_records'];
                        
                        for (const table of coreTables) {
                            try {
                                const { data, error } = await window.supabase
                                    .from(table)
                                    .select('*')
                                    .limit(1);
                                
                                if (!error) {
                                    actualTables.push(table);
                                    connectionSuccess = true;
                                    console.log(`成功连接到${table}表`);
                                } else {
                                    console.log(`表${table}可能不存在或无权限访问`);
                                }
                            } catch (e) {
                                console.log(`测试${table}表失败:`, e.message);
                            }
                        }
                        
                        // 如果核心表查询都失败，尝试测试auth连接
                        if (!connectionSuccess) {
                            try {
                                const { data, error } = await window.supabase.auth.getSession();
                                if (!error) {
                                    connectionSuccess = true;
                                    console.log('Supabase认证连接成功');
                                }
                            } catch (authError) {
                                console.log('测试auth连接失败:', authError.message);
                            }
                        }
                    } catch (e) {
                        console.error('Supabase连接检查失败:', e.message);
                    }
                    
                    if (connectionSuccess) {
                        // 连接成功，显示状态
                        statusDiv.innerHTML = `
                            <div class="result-item success">✅ Supabase数据库连接正常</div>
                            <div class="result-item info">当前使用Supabase数据库模式</div>
                            <div class="result-item info">数据库中的实际表: ${actualTables.length > 0 ? actualTables.join(', ') : '无'}</div>
                        `;
                        
                        // 显示连接信息
                        statusDiv.innerHTML += `
                            <div class="result-item info">✅ 数据库连接已建立</div>
                        `;
                    } else {
                        throw new Error('无法连接到Supabase数据库');
                    }
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="result-item error">❌ 数据库异常: ${error.message}</div>`;
            }
        }
        
        // 项目管理函数
        async function createProject() {
            const projectData = {
                project_name: document.getElementById('projectName').value,
                address: document.getElementById('projectAddress').value,
                status: document.getElementById('projectStatus').value || '在建',
                regular_hours: parseFloat(document.getElementById('regularHours').value) || 8,
                overtime_hours: parseFloat(document.getElementById('overtimeHours').value) || 0
            };
            
            const result = await database.createProject(projectData);
            displayResult('projectResults', result, '项目');
        }
        
        async function readProject() {
            const projectId = document.getElementById('projectId').value;
            const result = await database.read('projects', projectId);
            displayResult('projectResults', result, '项目');
        }
        
        async function updateProject() {
            const projectId = document.getElementById('projectId').value;
            const updates = {
                project_name: document.getElementById('projectName').value,
                address: document.getElementById('projectAddress').value,
                status: document.getElementById('projectStatus').value,
                regular_hours: parseFloat(document.getElementById('regularHours').value) || 8,
                overtime_hours: parseFloat(document.getElementById('overtimeHours').value) || 0,
                updated_at: new Date().toISOString()
            };
            
            const result = await database.update('projects', projectId, updates);
            displayResult('projectResults', result, '项目');
        }
        
        async function deleteProject() {
            // 获取项目名称
            const project_name = document.getElementById('projectName').value;
            
            // 验证输入
            if (!project_name) {
                alert('请先选择项目名称');
                return;
            }
            
            // 确认删除操作
            if (!confirm(`确定要删除项目名称为"${project_name}"的所有项目吗？此操作不可逆！`)) {
                return;
            }
            
            try {
                console.log('开始删除匹配的项目数据', { project_name });
                
                // 构建查询条件 - 根据项目名称查找项目
                // 支持不同的字段名格式
                const query = {};
                // 尝试使用不同的字段名格式，优先使用project_name
                const fieldNames = ['project_name', 'projectname', 'name'];
                
                // 查询匹配的项目
                let searchResult = null;
                
                // 获取数据模式
                const dataMode = localStorage.getItem('dataMode') || 'local';
                console.log(`当前数据模式: ${dataMode}`);
                
                if (dataMode === 'local') {
                    // 本地模式：从localStorage查询
                    console.log('使用localStorage模式查找项目');
                    
                    // 使用与queryProjectsFromLocalStorage相同的方式查找项目
                    const projects = [];
                    const allKeys = Object.keys(localStorage);
                    
                    // 查找所有包含项目数据的键
                    for (const key of allKeys) {
                        try {
                            if (key.includes('project') || key.includes('projects')) {
                                const value = localStorage.getItem(key);
                                if (value) {
                                    // 尝试解析JSON
                                    let data = null;
                                    try {
                                        data = JSON.parse(value);
                                    } catch (parseError) {
                                        console.log(`键 ${key} 的数据不是有效JSON，跳过`);
                                        continue;
                                    }
                                    
                                    // 处理数组或单个对象
                                    if (Array.isArray(data)) {
                                        // 处理数组中的每个项目
                                        for (const item of data) {
                                            if (item && typeof item === 'object') {
                                                // 检查是否匹配项目名称
                                                for (const fieldName of fieldNames) {
                                                    if (item[fieldName] === project_name) {
                                                        projects.push(item);
                                                        break;
                                                    }
                                                }
                                            }
                                        }
                                    } else if (data && typeof data === 'object') {
                                        // 处理单个对象
                                        for (const fieldName of fieldNames) {
                                            if (data[fieldName] === project_name) {
                                                projects.push(data);
                                                break;
                                            }
                                        }
                                    }
                                }
                            }
                        } catch (itemError) {
                            console.log(`处理键 ${key} 时出错:`, itemError);
                        }
                    }
                    
                    // 去重处理，避免重复数据
                    const uniqueProjects = [];
                    const projectIds = new Set();
                    
                    for (const project of projects) {
                        const projectId = project.id || project.projectId || project.project_id || JSON.stringify(project);
                        if (!projectIds.has(projectId)) {
                            projectIds.add(projectId);
                            uniqueProjects.push(project);
                        }
                    }
                    
                    searchResult = {
                        success: true,
                        data: uniqueProjects
                    };
                    
                    console.log(`本地查找完成，找到 ${uniqueProjects.length} 个项目`);
                } else if (window.supabase && currentDataMode === 'supabase') {
                    // Supabase模式：使用Supabase客户端查询项目
                    console.log('使用Supabase查询项目');
                    let queryBuilder = window.supabase.from('projects').select('*');
                    
                    // 尝试使用不同的字段名查询
                    let foundData = false;
                    for (const fieldName of fieldNames) {
                        try {
                            const { data, error } = await queryBuilder.eq(fieldName, project_name);
                            
                            if (error) {
                                console.warn(`使用字段名 ${fieldName} 查询时出错:`, error);
                                continue;
                            }
                            
                            if (data && data.length > 0) {
                                console.log(`使用字段名 ${fieldName} 找到匹配的项目，共 ${data.length} 个`);
                                searchResult = {
                                    success: true,
                                    data: data
                                };
                                foundData = true;
                                break;
                            }
                        } catch (supabaseError) {
                            console.warn(`使用Supabase查询字段 ${fieldName} 时出错:`, supabaseError);
                        }
                    }
                    
                    if (!foundData) {
                        searchResult = {
                            success: true,
                            data: []
                        };
                    }
                } else if (window.lightweightDatabaseService) {
                    // 使用轻量级数据库服务
                    console.log('使用lightweightDatabaseService查询项目');
                    for (const fieldName of fieldNames) {
                        query[fieldName] = project_name;
                        try {
                            searchResult = await window.lightweightDatabaseService.query('projects', query);
                            
                            if (searchResult.success && searchResult.data && searchResult.data.length > 0) {
                                console.log(`使用字段名 ${fieldName} 找到匹配的项目，共 ${searchResult.data.length} 个`);
                                break;
                            }
                        } catch (queryError) {
                            console.warn(`查询字段 ${fieldName} 时出错:`, queryError);
                        }
                        // 清空查询条件，准备尝试下一个字段名
                        delete query[fieldName];
                    }
                } else {
                    console.error('未找到可用的数据库服务');
                    displayResult('projectResults', { 
                            success: false, 
                            error: '未找到可用的数据库服务' 
                        }, '删除项目');
                        return;
                    }
                
                // 调试：记录searchResult的完整信息
                console.log('searchResult详细信息:', JSON.stringify(searchResult, null, 2));
                
                if (!searchResult || !searchResult.success || !searchResult.data || searchResult.data.length === 0) {
                    // 调试：记录localStorage中所有包含project的键和值
                    console.log('未找到匹配的项目数据，开始调试localStorage内容:');
                    const allKeys = Object.keys(localStorage);
                    for (const key of allKeys) {
                        if (key.includes('project') || key.includes('projects')) {
                            try {
                                const value = localStorage.getItem(key);
                                console.log(`键: ${key}, 值: ${value.substring(0, 200)}${value.length > 200 ? '...' : ''}`);
                                // 尝试解析并显示项目名称
                                const data = JSON.parse(value);
                                if (Array.isArray(data)) {
                                    console.log(`键: ${key} 包含 ${data.length} 个项目`);
                                    data.slice(0, 3).forEach((item, idx) => {
                                        if (item && typeof item === 'object') {
                                            const projName = item.project_name || item.projectname || item.name || '未知名称';
                                            console.log(`  项目${idx+1}: ${projName}`);
                                        }
                                    });
                                } else if (data && typeof data === 'object') {
                                    const projName = data.project_name || data.projectname || data.name || '未知名称';
                                    console.log(`键: ${key} 是单个项目: ${projName}`);
                                }
                            } catch (e) {
                                console.log(`键: ${key} 解析失败:`, e.message);
                            }
                        }
                    }
                    
                    displayResult('projectResults', { 
                        success: false, 
                        error: `未找到名称为"${project_name}"的项目数据，请检查控制台获取详细调试信息` 
                    }, '删除项目');
                    return;
                }
                
                console.log(`找到 ${searchResult.data.length} 个匹配的项目`);
                
                // 删除每个匹配的项目
                let successfulDeletes = 0;
                let failedDeletes = 0;
                const deletionErrors = [];
                
                for (const project of searchResult.data) {
                    try {
                        console.log('处理项目:', JSON.stringify(project, null, 2));
                        
                        // 尝试获取项目ID，支持不同的字段名格式
                        let projectId = null;
                        const idFieldNames = ['project_id', 'projectID', 'id'];
                        
                        for (const idField of idFieldNames) {
                            if (project[idField]) {
                                projectId = project[idField];
                                console.log(`找到项目ID: ${projectId} (使用字段: ${idField})`);
                                break;
                            }
                        }
                        
                        if (!projectId) {
                            throw new Error('项目缺少有效的ID字段');
                        }
                        
                        // 使用找到的项目ID删除项目
                        console.log(`准备删除项目ID: ${projectId}`);
                        
                        if (dataMode === 'local') {
                            // 本地模式：从localStorage删除 - 搜索所有包含项目的键
                            console.log(`在所有localStorage键中删除项目ID: ${projectId}`);
                            let deletedFromAnyKey = false;
                            
                            // 遍历所有localStorage键
                            const allKeys = Object.keys(localStorage);
                            for (const key of allKeys) {
                                try {
                                    if (key.includes('project') || key.includes('projects')) {
                                        const value = localStorage.getItem(key);
                                        if (value) {
                                            // 尝试解析JSON
                                            let data = null;
                                            try {
                                                data = JSON.parse(value);
                                            } catch (parseError) {
                                                console.log(`键 ${key} 的数据不是有效JSON，跳过删除`);
                                                continue;
                                            }
                                            
                                            // 处理数组格式
                                            if (Array.isArray(data)) {
                                                // 过滤掉要删除的项目
                                                const updatedData = data.filter(p => {
                                                    if (!p || typeof p !== 'object') return true;
                                                    let idMatch = false;
                                                    for (const idField of idFieldNames) {
                                                        if (p[idField] === projectId) {
                                                            idMatch = true;
                                                            break;
                                                        }
                                                    }
                                                    return !idMatch;
                                                });
                                                
                                                // 如果有变化，更新localStorage
                                                if (updatedData.length !== data.length) {
                                                    localStorage.setItem(key, JSON.stringify(updatedData));
                                                    console.log(`从键 ${key} 中删除了项目ID: ${projectId}`);
                                                    deletedFromAnyKey = true;
                                                }
                                            }
                                            // 处理单个对象格式
                                            else if (data && typeof data === 'object') {
                                                // 检查是否匹配项目ID
                                                let idMatch = false;
                                                for (const idField of idFieldNames) {
                                                    if (data[idField] === projectId) {
                                                        idMatch = true;
                                                        break;
                                                    }
                                                }
                                                
                                                // 如果匹配，删除整个键
                                                if (idMatch) {
                                                    localStorage.removeItem(key);
                                                    console.log(`删除了包含项目ID ${projectId} 的键: ${key}`);
                                                    deletedFromAnyKey = true;
                                                }
                                            }
                                        }
                                    }
                                } catch (itemError) {
                                    console.log(`处理键 ${key} 时出错:`, itemError);
                                }
                            }
                            
                            // 调试：记录删除操作的详细信息
                            if (deletedFromAnyKey) {
                                console.log(`本地模式下成功删除项目ID: ${projectId}`);
                                successfulDeletes++;
                                
                                // 再次验证删除是否成功
                                let stillExists = false;
                                const verifyKeys = Object.keys(localStorage);
                                for (const key of verifyKeys) {
                                    if (key.includes('project') || key.includes('projects')) {
                                        try {
                                            const value = localStorage.getItem(key);
                                            const data = JSON.parse(value);
                                            if (Array.isArray(data)) {
                                                for (const p of data) {
                                                    if (!p || typeof p !== 'object') continue;
                                                    for (const idField of idFieldNames) {
                                                        if (p[idField] === projectId) {
                                                            stillExists = true;
                                                            console.warn(`验证失败: 项目ID ${projectId} 仍在键 ${key} 中存在`);
                                                            break;
                                                        }
                                                    }
                                                }
                                            } else if (data && typeof data === 'object') {
                                                for (const idField of idFieldNames) {
                                                    if (data[idField] === projectId) {
                                                        stillExists = true;
                                                        console.warn(`验证失败: 项目ID ${projectId} 仍在键 ${key} 中存在`);
                                                        break;
                                                    }
                                                }
                                            }
                                        } catch (e) {
                                            console.log(`验证键 ${key} 时出错:`, e.message);
                                        }
                                    }
                                }
                                
                                if (!stillExists) {
                                    console.log(`验证成功: 项目ID ${projectId} 已从所有键中删除`);
                                }
                            } else {
                                console.error(`在localStorage中未找到项目ID: ${projectId}，删除失败`);
                                // 不抛出异常，而是计入失败，继续处理其他项目
                                failedDeletes++;
                                deletionErrors.push(`在localStorage中未找到项目ID: ${projectId}`);
                            }
                        } else if (window.supabase && currentDataMode === 'supabase') {
                            // Supabase模式：使用Supabase客户端删除项目
                            console.log(`使用Supabase删除项目ID: ${projectId}`);
                            try {
                                // 尝试使用不同的ID字段名删除
                                let deleteSuccess = false;
                                for (const idField of idFieldNames) {
                                    const { error } = await window.supabase
                                        .from('projects')
                                        .delete()
                                        .eq(idField, projectId);
                                    
                                    if (!error) {
                                        console.log(`使用字段 ${idField} 成功删除项目: ${projectId}`);
                                        successfulDeletes++;
                                        deleteSuccess = true;
                                        break;
                                    }
                                    console.warn(`使用字段 ${idField} 删除项目 ${projectId} 失败:`, error);
                                }
                                
                                if (!deleteSuccess) {
                                    failedDeletes++;
                                    deletionErrors.push(`使用所有ID字段都无法删除项目 ${projectId}`);
                                    console.error(`所有ID字段都无法删除项目: ${projectId}`);
                                }
                            } catch (supabaseError) {
                                failedDeletes++;
                                deletionErrors.push(`Supabase删除项目 ${projectId} 异常: ${supabaseError.message}`);
                                console.error(`Supabase删除项目异常: ${projectId}`, supabaseError);
                            }
                        } else if (window.lightweightDatabaseService) {
                            // 使用轻量级数据库服务删除
                            try {
                                const deleteResult = await window.lightweightDatabaseService.delete('projects', projectId);
                                if (deleteResult.success) {
                                    successfulDeletes++;
                                    console.log(`成功删除项目: ${projectId}`);
                                } else {
                                    failedDeletes++;
                                    deletionErrors.push(`删除项目 ${projectId} 失败: ${deleteResult.error || '未知错误'}`);
                                    console.error(`删除项目失败: ${projectId}`, deleteResult.error);
                                }
                            } catch (deleteError) {
                                failedDeletes++;
                                deletionErrors.push(`删除项目 ${projectId} 异常: ${deleteError.message}`);
                                console.error(`删除项目异常: ${projectId}`, deleteError);
                            }
                        } else {
                            throw new Error('数据库删除方法不可用');
                        }
                    } catch (e) {
                        const projectInfo = project.project_id || project.projectID || project.id || '未知ID';
                        failedDeletes++;
                        deletionErrors.push(`删除项目 ${projectInfo} 异常: ${e.message}`);
                        console.error(`删除项目异常: ${projectInfo}`, e);
                    }
                }
                
                // 创建结果对象
                const result = {
                    success: failedDeletes === 0,
                    results: [],
                    total: searchResult.data.length,
                    successful: successfulDeletes,
                    failed: failedDeletes,
                    errors: deletionErrors,
                    details: {
                        totalProjectsDeleted: successfulDeletes,
                        project_name: project_name
                    }
                };
                
                // 显示操作结果
                displayResult('projectResults', result, '删除项目');
                
                // 删除完成后重新查询并更新列表
                console.log('删除完成，重新查询并更新列表');
                await listProjects();
                
            } catch (error) {
                console.error('删除项目异常:', error);
                displayResult('projectResults', { 
                    success: false, 
                    error: `操作失败: ${error.message}` 
                }, '删除项目');
            }
        }
        
        // 初始化项目管理页面的手机号下拉框
        function initProjectPhoneSelect() {
            let phone = localStorage.getItem('loggedInPhone');
            if (!phone && window.location.hostname === 'localhost') {
                phone = '13800138000';
            }
            
            // 填充手机号下拉框
            const phoneSelect = document.getElementById('projectPhone');
            if (phoneSelect && phone) {
                // 清空下拉框
                phoneSelect.innerHTML = '';
                // 添加当前手机号选项
                const option = document.createElement('option');
                option.value = phone;
                option.textContent = phone;
                phoneSelect.appendChild(option);
            }
        }
        
        // 当页面加载完成时初始化手机号下拉框
        document.addEventListener('DOMContentLoaded', function() {
            // 页面加载时立即初始化项目管理页面的手机号下拉框
            initProjectPhoneSelect();
            
            // 初始化项目管理页面的手机号下拉框
            const projectTab = document.getElementById('project');
            if (projectTab) {
                // 当切换到项目管理选项卡时初始化
                projectTab.addEventListener('click', function() {
                    setTimeout(initProjectPhoneSelect, 100);
                });
                // 立即初始化（如果当前就是项目选项卡）
                if (projectTab.classList.contains('active')) {
                    initProjectPhoneSelect();
                }
            }
        });
        
        // 导出项目数据功能
        async function exportProjectData() {
            console.log('开始导出项目数据');
            
            try {
                // 获取当前选择的手机号
                const phoneSelect = document.getElementById('projectPhone');
                const selectedPhone = phoneSelect.value;
                
                // 如果没有选择手机号，显示提示
                if (!selectedPhone) {
                    showNotification('请先选择要导出的项目所属账号', false);
                    return;
                }
                
                // 显示加载状态
                const projectResults = document.getElementById('projectResults');
                projectResults.innerHTML = '<div class="result-item info">正在导出项目数据...</div>';
                
                // 获取用户ID
                const userResult = await getUserByPhone(selectedPhone);
                if (!userResult.success || !userResult.data || userResult.data.length === 0) {
                    projectResults.innerHTML = '<div class="result-item error">未找到匹配的用户信息</div>';
                    return;
                }
                
                const user = userResult.data[0];
                const user_id = user.user_id || user.id;
                
                // 构建查询条件
                const query = { user_id: user_id };
                
                // 获取当前数据模式
                const currentDataMode = localStorage.getItem('dataMode') || 'local';
                
                let projectData = [];
                
                if (currentDataMode === 'supabase' && window.supabase) {
                    // Supabase模式：使用Supabase客户端查询项目
                    console.log('使用Supabase查询项目数据');
                    let queryBuilder = window.supabase.from('projects').select('*');
                    
                    if (user_id) {
                        queryBuilder = queryBuilder.eq('user_id', user_id);
                    }
                    
                    const { data, error } = await queryBuilder;
                    
                    if (error) {
                        throw error;
                    }
                    
                    projectData = data || [];
                } else {
                    // 本地模式：从localStorage查询项目数据
                    console.log('从localStorage查询项目数据');
                    projectData = await queryProjectsFromLocalStorage(query);
                    projectData = projectData.data || [];
                }
                
                // 如果没有找到项目数据，显示提示
                if (projectData.length === 0) {
                    projectResults.innerHTML = '<div class="result-item warning">未找到项目数据</div>';
                    showNotification('未找到可导出的项目数据', false);
                    return;
                }
                
                // 创建导出数据结构 - 直接使用project_cache_${user_id}作为根键，与用户期望格式一致
                const processedProjects = projectData.map(project => ({
                    project_id: project.project_id,
                    user_id: project.user_id,
                    project_name: project.project_name || '未命名项目',
                    address: project.address || '',
                    regular_hours: project.regular_hours || 0,
                    overtime_hours: project.overtime_hours || 0,
                    status: project.status || '在建',
                    created_at: project.created_at || new Date().toISOString(),
                    updated_at: project.updated_at || project.created_at || new Date().toISOString()
                }));
                
                // 直接使用project_cache_${user_id}作为根键
                const exportData = {
                    [`project_cache_${user_id}`]: processedProjects
                };
                
                // 转换为JSON字符串
                const jsonString = JSON.stringify(exportData, null, 2);
                
                // 创建Blob对象
                const blob = new Blob([jsonString], { type: 'application/json' });
                
                // 创建下载链接
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                // 设置文件名
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                a.download = `project_data_${selectedPhone}_${timestamp}.json`;
                
                // 触发下载
                document.body.appendChild(a);
                a.click();
                
                // 清理
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // 显示成功消息
                projectResults.innerHTML = `<div class="result-item success">✅ 成功导出 ${projectData.length} 个项目数据</div>`;
                showNotification(`成功导出 ${projectData.length} 个项目数据`, false);
                
            } catch (error) {
                console.error('导出项目数据失败:', error);
                const projectResults = document.getElementById('projectResults');
                projectResults.innerHTML = `<div class="result-item error">❌ 导出项目数据失败: ${error.message}</div>`;
                showNotification(`导出项目数据失败: ${error.message}`, true);
            }
        }
        
        // 辅助函数：通过手机号查询用户信息
        async function getUserByPhone(phone) {
            console.log('开始通过手机号查询用户:', phone);
            
            // 标准化手机号：去除所有非数字字符，只保留数字
            const normalizedPhone = phone.replace(/\D/g, '');
            console.log('标准化后的手机号:', normalizedPhone);
            
            let result;
            const currentDataMode = localStorage.getItem('dataMode') || 'local';
            
            try {
                if (currentDataMode === 'supabase' && window.supabase) {
                    // Supabase模式：使用phone查询
                    console.log('使用Supabase查询用户:', normalizedPhone);
                    let { data, error } = await window.supabase
                        .from('users')
                        .select('*')
                        .eq('phone', normalizedPhone);
                    
                    if (error) {
                        throw error;
                    }
                    
                    result = {
                        success: true,
                        data: data || [],
                        count: data ? data.length : 0,
                        total: data ? data.length : 0
                    };
                    console.log('成功从Supabase找到用户:', result.data.length, '条');
                } else {
                    // 本地模式：使用现有的逻辑（lightweightDatabaseService或localStorage）
                    if (window.lightweightDatabaseService) {
                        console.log('使用lightweightDatabaseService查询用户:', normalizedPhone);
                        // 使用phone查询
                        result = await window.lightweightDatabaseService.query('users', { phone: normalizedPhone });
                        
                        // 验证结果
                        if (result.success && result.data && result.data.length > 0) {
                            console.log('成功从lightweightDatabaseService找到用户:', result.data.length, '条');
                        } else {
                            console.log('lightweightDatabaseService未找到用户，尝试直接查询localStorage');
                            // 直接查询localStorage
                            result = await queryUsersFromLocalStorage({ phone: normalizedPhone });
                        }
                    } else {
                        // 如果轻量级服务不可用，直接查询localStorage
                        console.log('lightweightDatabaseService不可用，直接查询localStorage');
                        result = await queryUsersFromLocalStorage({ phone: normalizedPhone });
                    }
                }
            } catch (error) {
                console.error('查询用户时发生错误:', error);
                // 出错时仍尝试直接查询localStorage作为后备
                try {
                    result = await queryUsersFromLocalStorage({ phone: normalizedPhone });
                } catch (e) {
                    console.error('后备查询也失败:', e);
                    result = { success: false, error: '查询用户失败: ' + error.message };
                }
            }
            
            return result;
        }
        
        async function listProjects() {
            // 获取选中的手机号
            const phone = document.getElementById('projectPhone').value;
            console.log('执行项目查询，手机号:', phone);
            
            try {
                // 如果提供了手机号，先查询用户获取user_id
                let user_id = null;
                if (phone) {
                    console.log('开始通过手机号查询用户信息，以获取user_id');
                    const userResult = await getUserByPhone(phone);
                    
                    if (userResult.success && userResult.data && userResult.data.length > 0) {
                        // 获取第一个匹配的用户的user_id
                        const user = userResult.data[0];
                        user_id = user.user_id || user.id; // 支持多种字段名
                        console.log('成功获取用户ID:', user_id);
                    } else {
                        console.log('未找到匹配的用户信息');
                        displayResult('projectResults', { success: false, error: '未找到匹配的用户信息' }, '项目列表');
                        return;
                    }
                }
                
                // 构建查询条件，使用user_id而不是phone
                const query = {};
                if (user_id) {
                    query.user_id = user_id; // 使用user_id字段进行查询
                    console.log('构建查询条件:', query);
                } else {
                    console.log('未选择手机号或未找到用户，查询所有项目');
                }
                
                let result;
                const currentDataMode = localStorage.getItem('dataMode') || 'local';
                
                if (currentDataMode === 'supabase' && window.supabase) {
                    // Supabase模式：使用Supabase客户端查询项目
                    console.log('使用Supabase查询项目');
                    let queryBuilder = window.supabase.from('projects').select('*');
                    
                    if (user_id) {
                        queryBuilder = queryBuilder.eq('user_id', user_id);
                    }
                    
                    const { data, error } = await queryBuilder;
                    
                    if (error) {
                        throw error;
                    }
                    
                    result = {
                        success: true,
                        data: data || [],
                        count: data ? data.length : 0,
                        total: data ? data.length : 0
                    };
                } else {
                    // 本地模式：使用现有的逻辑（lightweightDatabaseService或localStorage）
                    if (window.lightweightDatabaseService) {
                        console.log('使用lightweightDatabaseService查询项目:', query);
                        result = await window.lightweightDatabaseService.query('projects', query);
                        
                        // 验证结果
                        if (result.success && result.data) {
                            console.log('成功从lightweightDatabaseService找到项目:', result.data.length, '条');
                        } else {
                            console.log('lightweightDatabaseService未找到项目，尝试直接查询localStorage');
                            // 直接查询localStorage作为后备
                            result = await queryProjectsFromLocalStorage(query);
                        }
                    } else {
                        // 如果轻量级服务不可用，直接查询localStorage
                        console.log('lightweightDatabaseService不可用，直接查询localStorage');
                        result = await queryProjectsFromLocalStorage(query);
                    }
                }
                
                console.log('项目查询结果:', result.success ? `成功，共${result.data?.length || 0}条记录` : `失败: ${result.error}`);
                displayResult('projectResults', result, '项目列表');
                
                // 填充项目名称下拉框
                if (result.success && result.data && result.data.length > 0) {
                    const projectNameSelect = document.getElementById('projectName');
                    // 清空现有选项
                    projectNameSelect.innerHTML = '';
                    // 添加默认选项
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = '请选择项目名称';
                    projectNameSelect.appendChild(defaultOption);
                    // 添加项目名称选项，使用正确的project_name字段
                    const projectNames = [...new Set(result.data.map(project => project.project_name || project.projectname).filter(name => name))];
                    projectNames.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        projectNameSelect.appendChild(option);
                    });
                    console.log('项目名称下拉框填充完成，共', projectNames.length, '个项目名称');
                }
            } catch (error) {
                console.error('项目查询异常:', error);
                displayResult('projectResults', { success: false, error: '查询失败: ' + error.message }, '项目列表');
            }
        }
        
        // 通用函数：从localStorage查询项目数据，模拟lightweightDatabaseService的查询逻辑
        async function queryProjectsFromLocalStorage(conditions = {}) {
            try {
                console.log('开始从localStorage查询项目数据，条件:', conditions);
                const projects = [];
                const allKeys = Object.keys(localStorage);
                
                // 查找所有包含项目数据的键
                for (const key of allKeys) {
                    try {
                        if (key.includes('project') || key.includes('projects')) {
                            const value = localStorage.getItem(key);
                            if (value) {
                                // 尝试解析JSON
                                let data = null;
                                try {
                                    data = JSON.parse(value);
                                } catch (parseError) {
                                    console.log(`键 ${key} 的数据不是有效JSON，跳过`);
                                    continue;
                                }
                                
                                // 处理数组或单个对象
                                if (Array.isArray(data)) {
                                    // 处理数组中的每个项目
                                    for (const item of data) {
                                        if (item && typeof item === 'object') {
                                            // 检查是否匹配条件
                                            let match = true;
                                            for (const [field, value] of Object.entries(conditions)) {
                                                if (item[field] !== value) {
                                                    match = false;
                                                    break;
                                                }
                                            }
                                            if (match) {
                                                projects.push(item);
                                            }
                                        }
                                    }
                                } else if (data && typeof data === 'object') {
                                    // 处理单个对象
                                    let match = true;
                                    for (const [field, value] of Object.entries(conditions)) {
                                        if (data[field] !== value) {
                                            match = false;
                                            break;
                                        }
                                    }
                                    if (match) {
                                        projects.push(data);
                                    }
                                }
                            }
                        }
                    } catch (itemError) {
                        console.log(`处理键 ${key} 时出错:`, itemError);
                    }
                }
                
                // 去重处理，避免重复数据
                const uniqueProjects = [];
                const projectIds = new Set();
                
                for (const project of projects) {
                    const projectId = project.id || project.projectId || JSON.stringify(project);
                    if (!projectIds.has(projectId)) {
                        projectIds.add(projectId);
                        uniqueProjects.push(project);
                    }
                }
                
                console.log('从localStorage查询到项目数量:', uniqueProjects.length);
                
                // 将项目数据存储到localStorage中，使用project_cache_开头的键名格式
                // 获取当前用户手机号作为标识
                let userPhone = 'default';
                try {
                    const currentUserStr = localStorage.getItem('currentUser');
                    if (currentUserStr) {
                        const currentUser = JSON.parse(currentUserStr);
                        if (currentUser && (currentUser.phone || currentUser.empphone)) {
                            userPhone = currentUser.phone || currentUser.empphone;
                        }
                    }
                } catch (e) {
                    console.log('获取当前用户信息失败:', e);
                }
                
                // 使用project_cache_+userPhone的格式存储数据
                const cacheKey = `project_cache_${userPhone}`;
                console.log(`将项目数据存储到localStorage，键名: ${cacheKey}`);
                localStorage.setItem(cacheKey, JSON.stringify(uniqueProjects));
                
                // 同时支持旧格式project_data_phone
                const oldCacheKey = `project_data_${userPhone}`;
                localStorage.setItem(oldCacheKey, JSON.stringify(uniqueProjects));
                
                // 返回标准格式的结果
                return {
                    success: true,
                    data: uniqueProjects,
                    count: uniqueProjects.length,
                    total: uniqueProjects.length
                };
            } catch (error) {
                console.error('从localStorage查询项目时发生错误:', error);
                return {
                    success: false,
                    error: '查询失败: ' + error.message
                };
            }
        }
        
        async function queryProjects() {
            const condition = document.getElementById('queryCondition').value;
            let queryConditions = {};
            
            if (condition === 'status') {
                queryConditions.status = document.getElementById('projectStatus').value;
            } else if (condition === 'date') {
                const today = new Date().toISOString().split('T')[0];
                queryConditions.date = { $gte: today };
            }
            
            const result = await database.query('projects', queryConditions);
            displayResult('projectResults', result, '项目查询');
        }
        
        async function clearAllProjects() {
            console.log('=== clearAllProjects函数开始执行 ===');
            console.log('执行时间:', new Date().toLocaleString());
            
            // 获取选中的手机号
            const phone = document.getElementById('projectPhone').value;
            console.log('获取到的手机号:', phone);
            console.log('手机号类型:', typeof phone);
            console.log('手机号长度:', phone ? phone.length : '未选择');
            
            if (!phone) {
                console.error('错误：未选择项目手机号');
                alert('请先选择要清除的手机号');
                return;
            }
            
            console.log('手机号验证通过，继续执行...');
            
            // 获取当前数据模式
            const currentDataMode = localStorage.getItem('dataMode') || localStorage.getItem('currentDataMode') || 'local';
            console.log('数据模式获取结果:', currentDataMode);
            console.log('localStorage中dataMode的值:', localStorage.getItem('dataMode'));
            console.log('localStorage中currentDataMode的值:', localStorage.getItem('currentDataMode'));
            
            if (confirm(`确定要清空手机号 "${phone}" 的所有项目数据吗？此操作不可逆！`)) {
                console.log('用户确认执行清除操作');
                try {
                    console.log(`=== 开始清空手机号 "${phone}" 的所有项目数据 ===`);
                    
                    // 初始化统计数据
                    let successfulDeletes = 0;
                    let failedDeletes = 0;
                    let deletedProjects = 0;
                    const deletionErrors = [];
                    let userId = null;
                    let phoneRelatedKeys = [];
                    let phoneRelatedData = [];
                    let projectRelatedKeys = [];
                    let totalProjectKeysFound = 0;
                    let finalRemainingKeys = [];
                    
                    // 定义项目相关的键名模式，确保只删除项目数据
                    const isProjectRelatedKey = (key) => {
                        const lowerKey = key.toLowerCase();
                        const result = lowerKey.includes('project') || 
                               lowerKey.includes('projects') || 
                               lowerKey.includes('project_cache') || 
                               lowerKey.includes('project_data');
                        console.log(`键 "${key}" 是否为项目相关键: ${result}`);
                        return result;
                    };
                    
                    console.log('=== 开始查找用户ID ===');
                    
                    // 根据数据模式查找用户ID
                    if (currentDataMode === 'supabase' && window.supabase) {
                        console.log('=== 在Supabase中查找用户ID ===');
                        // Supabase模式：从users表中查找user_id
                        try {
                            const { data: userData, error: userError } = await window.supabase
                                .from('users')
                                .select('user_id')
                                .eq('phone', phone)
                                .limit(1);
                            
                            if (!userError && userData && userData.length > 0) {
                                userId = userData[0].user_id;
                                console.log(`✓ 从Supabase users表中找到用户ID: ${userId}`);
                            } else {
                                console.warn(`✗ 从Supabase users表中未找到用户ID:`, userError || '无匹配用户');
                            }
                        } catch (e) {
                            console.error(`查询Supabase users表时发生错误:`, e);
                        }
                    } else {
                        console.log('=== 在本地存储中查找用户ID ===');
                        // 本地模式：从localStorage中查找用户ID
                        try {
                            // 1. 首先从currentUser中获取user_id
                            const currentUserStr = localStorage.getItem('currentUser');
                            if (currentUserStr) {
                                const currentUser = JSON.parse(currentUserStr);
                                if (currentUser && currentUser.user_id) {
                                    userId = currentUser.user_id;
                                    console.log(`✓ 从currentUser获取到用户ID: ${userId}`);
                                }
                            }
                            
                            // 2. 如果从currentUser中没有获取到user_id，尝试从其他方式获取
                            if (!userId) {
                                const allKeys = Object.keys(localStorage);
                                for (const key of allKeys) {
                                    if (key.startsWith('users.') || key.includes('user_') || key === 'currentUser') {
                                        const value = localStorage.getItem(key);
                                        if (value) {
                                            try {
                                                const user = JSON.parse(value);
                                                if (user.phone === phone || user.user_id) {
                                                    userId = user.user_id || user.id;
                                                    console.log(`✓ 从localStorage获取到用户ID: ${userId}`);
                                                    break;
                                                }
                                            } catch (parseError) {
                                                console.warn(`解析用户数据失败 ${key}:`, parseError);
                                            }
                                        }
                                    }
                                }
                            }
                            
                            // 3. 如果还是没有获取到user_id，尝试从project_cache键名中提取
                            if (!userId) {
                                const allKeys = Object.keys(localStorage);
                                for (const key of allKeys) {
                                    if (key.startsWith('project_cache_')) {
                                        // 从键名中提取user_id，例如project_cache_e7e422a6-f3d0-4c7e-a153-8b078ec5dbad
                                        const cacheUserId = key.replace('project_cache_', '');
                                        if (cacheUserId && cacheUserId !== '17318121365') {
                                            userId = cacheUserId;
                                            console.log(`✓ 从project_cache键名中提取到用户ID: ${userId}`);
                                            break;
                                        }
                                    }
                                }
                            }
                        } catch (e) {
                            console.error(`查询本地用户数据时发生错误:`, e);
                        }
                    }
                    
                    console.log(`最终找到的用户ID: ${userId}`);
                    
                    // 根据不同的数据模式执行不同的清除逻辑
                    console.log('=== 开始根据数据模式执行清除逻辑 ===');
                    console.log('检查数据模式:', { currentDataMode, supabaseAvailable: !!window.supabase });
                    
                    if (currentDataMode === 'supabase' && window.supabase) {
                        console.log('=== 执行Supabase模式清除逻辑 ===');
                        // Supabase模式下的清除逻辑
                        console.log('使用Supabase模式清除项目数据');
                        
                        try {
                            let deleteSuccess = false;
                            
                            if (userId) {
                                // 如果找到了user_id，使用user_id删除项目
                                console.log(`使用user_id ${userId} 删除项目`);
                                try {
                                    // 尝试使用user_id字段删除项目
                                    const { error: userIdError } = await window.supabase
                                        .from('projects')
                                        .delete()
                                        .eq('user_id', userId);
                                    
                                    if (!userIdError) {
                                        console.log(`✓ 使用user_id ${userId} 成功删除项目`);
                                        deleteSuccess = true;
                                        successfulDeletes++;
                                    } else {
                                        console.warn(`✗ 使用user_id ${userId} 删除项目失败:`, userIdError);
                                    }
                                } catch (e) {
                                    console.error(`使用user_id删除项目时发生异常:`, e);
                                }
                            }
                            
                            if (!deleteSuccess) {
                                // 尝试使用不同的phone字段名删除项目
                                const phoneFields = ['phone', 'contact_phone', 'manager_phone'];
                                console.log('准备使用的phone字段:', phoneFields);
                                
                                for (const field of phoneFields) {
                                    console.log(`尝试使用字段 "${field}" 删除项目...`);
                                    try {
                                        const { error } = await window.supabase
                                            .from('projects')
                                            .delete()
                                            .eq(field, phone);
                                        
                                        if (!error) {
                                            console.log(`✓ 使用字段 ${field} 成功删除项目`);
                                            deleteSuccess = true;
                                            successfulDeletes++;
                                            break;
                                        } else {
                                            console.warn(`✗ 使用字段 ${field} 删除项目失败:`, error);
                                        }
                                    } catch (fieldError) {
                                        console.error(`使用字段 ${field} 时发生异常:`, fieldError);
                                    }
                                }
                            }
                            
                            if (!deleteSuccess) {
                                failedDeletes++;
                                deletionErrors.push('使用所有字段都无法删除项目');
                                console.error('所有字段都无法删除项目');
                            } else {
                                console.log('Supabase模式删除成功完成');
                            }
                        } catch (supabaseError) {
                            failedDeletes++;
                            deletionErrors.push(`Supabase删除项目异常: ${supabaseError.message}`);
                            console.error('Supabase删除项目异常:', supabaseError);
                        }
                    } else {
                        console.log('=== 执行localStorage模式清除逻辑 ===');
                        // 本地模式：从localStorage清除项目数据
                        console.log('使用localStorage模式清除项目数据');
                        
                        try {
                            // 获取所有localStorage键
                            const allKeys = Object.keys(localStorage);
                            console.log(`总共有 ${allKeys.length} 个localStorage键`);
                            console.log('所有localStorage键:', allKeys);
                            
                            // 只查找项目相关的键
                            projectRelatedKeys = allKeys.filter(isProjectRelatedKey);
                            console.log(`找到 ${projectRelatedKeys.length} 个项目相关的键`);
                            console.log('项目相关键列表:', projectRelatedKeys);
                        
                             // 准备收集与指定手机号相关的项目数据和键
                             console.log('准备收集与指定手机号相关的项目数据');
                             // 确保所有必要的变量都被初始化
                    phoneRelatedData = [];
                    totalProjectKeysFound = 0;
                    
                    console.log('目标手机号:', phone);
                    console.log('初始phoneRelatedData长度:', phoneRelatedData.length);
                    console.log('初始phoneRelatedKeys长度:', phoneRelatedKeys.length);
                    console.log('初始化totalProjectKeysFound:', totalProjectKeysFound);
                             
                             // 遍历所有项目键，收集与指定手机号相关的数据
                             console.log('=== 开始遍历项目键收集相关数据 ===');
                              
                             // 1. 首先处理project_cache_${userId}格式的键
                             if (userId) {
                                 console.log(`=== 开始处理project_cache_${userId}格式的键 ===`);
                                 const cacheKey = `project_cache_${userId}`;
                                 console.log(`查找缓存键: ${cacheKey}`);
                                 
                                 if (localStorage.getItem(cacheKey)) {
                                     console.log(`✓ 找到缓存键: ${cacheKey}`);
                                     phoneRelatedKeys.push({ key: cacheKey, type: 'cache' });
                                 } else {
                                     console.log(`✗ 未找到缓存键: ${cacheKey}`);
                                 }
                             }
                             
                             // 2. 遍历所有项目键，收集与指定手机号或用户ID相关的数据
                             for (const key of projectRelatedKeys) {
                                 console.log(`\n--- 处理键: "${key}" ---`);
                                 try {
                                     const value = localStorage.getItem(key);
                                     console.log(`键 "${key}" 的值长度:`, value ? value.length : 0);
                                     
                                     if (value) {
                                         // 显示键值的实际内容（前200个字符用于调试）
                                         console.log(`键 "${key}" 的值内容（前200字符）:`, value.substring(0, 200));
                                         console.log(`键 "${key}" 的完整键名:`, `"${key}"`);
                                         console.log(`键名中是否包含手机号 "${phone}":`, key.includes(phone));
                                         
                                         // 先尝试字符串匹配，快速判断是否可能包含指定手机号或user_id
                                         const phonePattern = `"phone":"${phone}"`;
                                         const userIdPattern = userId ? `"user_id":"${userId}"` : null;
                                         const phoneMatch = value.includes(phonePattern);
                                         const userIdMatch = userIdPattern ? value.includes(userIdPattern) : false;
                                         const stringMatch = phoneMatch || userIdMatch;
                                         console.log(`字符串匹配结果: phone=${phoneMatch}, user_id=${userIdMatch}, 总匹配=${stringMatch}`);
                                          
                                         if (stringMatch) {
                                             try {
                                                 // 尝试解析为JSON
                                                 const data = JSON.parse(value);
                                                 console.log(`键 "${key}" JSON解析成功，数据类型:`, Array.isArray(data) ? 'array' : typeof data);
                                                 
                                                 // 处理数组格式
                                                 if (Array.isArray(data)) {
                                                     const matchingProjects = data.filter(item => 
                                                         item && typeof item === 'object' && (item.phone === phone || item.user_id === userId)
                                                     );
                                                     console.log(`数组中找到 ${matchingProjects.length} 个匹配项目`);
                                                     if (matchingProjects.length > 0) {
                                                         console.log(`✓ 键 ${key} 包含 ${matchingProjects.length} 个与手机号或user_id匹配的项目`);
                                                         phoneRelatedKeys.push({ key, type: 'array', projectCount: matchingProjects.length });
                                                         phoneRelatedData.push(...matchingProjects);
                                                         console.log('已添加到处理列表');
                                                     }
                                                 }
                                                 // 处理单个对象格式
                                                 else if (data && typeof data === 'object' && (data.phone === phone || data.user_id === userId)) {
                                                     console.log(`✓ 键 ${key} 包含与手机号或user_id匹配的单个项目`);
                                                     phoneRelatedKeys.push({ key, type: 'object' });
                                                     phoneRelatedData.push(data);
                                                     console.log('已添加到处理列表');
                                                 }
                                                 // 处理缓存格式，如project_cache_${userId}
                                                 else if (key.includes('project_cache')) {
                                                     console.log(`✓ 发现缓存键 ${key}，将特别处理`);
                                                     phoneRelatedKeys.push({ key, type: 'cache' });
                                                     console.log('已添加到缓存处理列表');
                                                 } else {
                                                     console.log(`键 "${key}" 数据不匹配或格式异常，跳过处理`);
                                                 }
                                             } catch (parseError) {
                                                 // 如果解析失败，但字符串包含手机号，也添加到待处理列表
                                                 console.log(`✗ 键 ${key} JSON解析失败但字符串包含手机号，标记为无效JSON`);
                                                 console.log('解析错误:', parseError.message);
                                                 phoneRelatedKeys.push({ key, type: 'invalid_json' });
                                             }
                                         } else {
                                             console.log(`键 "${key}" 不包含目标手机号，跳过`);
                                         }
                                     } else {
                                         console.log(`键 "${key}" 值为空，跳过`);
                                     }
                                 } catch (e) {
                                     console.error(`处理键 ${key} 时出错:`, e);
                                     deletionErrors.push(`处理键 ${key} 时出错: ${e.message}`);
                                 }
                             }
                             
                             console.log(`\n=== 数据收集完成 ===`);
                             console.log(`找到 ${phoneRelatedKeys.length} 个与手机号相关的项目键需要处理`);
                             console.log(`找到 ${phoneRelatedData.length} 个与手机号相关的项目数据`);
                             console.log('phoneRelatedKeys详细信息:', phoneRelatedKeys);
                             
                             // 按类型分类处理
                             const arrayKeys = phoneRelatedKeys.filter(item => item.type === 'array');
                             const objectKeys = phoneRelatedKeys.filter(item => item.type === 'object');
                             const cacheKeys = phoneRelatedKeys.filter(item => item.type === 'cache');
                             const invalidKeys = phoneRelatedKeys.filter(item => item.type === 'invalid_json');
                             
                             console.log('数据类型分类:', {
                                 arrayKeys: arrayKeys.length,
                                 objectKeys: objectKeys.length,
                                 cacheKeys: cacheKeys.length,
                                 invalidKeys: invalidKeys.length
                             });
                             console.log('数组键:', arrayKeys);
                             console.log('对象键:', objectKeys);
                             console.log('缓存键:', cacheKeys);
                             console.log('无效JSON键:', invalidKeys);
                             
                         } catch (localStorageError) {
                             console.error('localStorage模式处理异常:', localStorageError);
                             failedDeletes++;
                             deletionErrors.push(`localStorage处理异常: ${localStorageError.message}`);
                         }
                        
                        console.log('=== 开始删除相关键 ===');
                        
                        // 1. 首先处理数组格式的数据
                        const arrayKeys = phoneRelatedKeys.filter(item => item.type === 'array');
                        console.log(`处理 ${arrayKeys.length} 个数组格式的项目键`);
                        console.log('数组键列表:', arrayKeys.map(item => item.key));
                        
                        for (const { key } of arrayKeys) {
                            console.log(`\n--- 处理数组键: "${key}" ---`);
                            try {
                                const value = localStorage.getItem(key);
                                console.log(`键 "${key}" 当前值长度:`, value ? value.length : 0);
                                
                                if (value) {
                                    const data = JSON.parse(value);
                                    console.log(`键 "${key}" JSON解析成功，原始数组长度:`, data.length);
                                    
                                    if (Array.isArray(data)) {
                                        console.log('开始过滤数组项目...');
                                        const originalLength = data.length;
                                        let deletedCount = 0;
                                        
                                        // 过滤掉与指定手机号或user_id匹配的项目
                                        const filteredData = data.filter(item => {
                                            const shouldKeep = !(item && typeof item === 'object' && (item.phone === phone || item.user_id === userId));
                                            if (!shouldKeep) {
                                                deletedCount++;
                                                console.log(`将要删除的项目 [${deletedCount}]:`, item);
                                            }
                                            return shouldKeep;
                                        });
                                        
                                        console.log(`原始项目数: ${originalLength}, 匹配删除数: ${deletedCount}, 保留项目数: ${filteredData.length}`);
                                        
                                        // 如果过滤后数据为空，直接删除整个键
                                        if (filteredData.length === 0) {
                                            localStorage.removeItem(key);
                                            console.log(`✓ 删除整个空数组键: ${key}`);
                                            deletedProjects += deletedCount;
                                            successfulDeletes++;
                                        }
                                        // 否则更新数组，只保留不匹配的项目
                                        else {
                                            localStorage.setItem(key, JSON.stringify(filteredData));
                                            console.log(`✓ 更新数组键 ${key}: 原长度 ${originalLength}, 新长度 ${filteredData.length}`);
                                            deletedProjects += deletedCount;
                                            successfulDeletes++;
                                        }
                                    } else {
                                        console.log(`✗ 键 "${key}" 数据不是数组格式，跳过处理`);
                                        failedDeletes++;
                                        deletionErrors.push(`键 ${key} 不是数组格式`);
                                    }
                                } else {
                                    console.log(`✗ 键 "${key}" 值为空，跳过处理`);
                                }
                            } catch (e) {
                                console.error(`✗ 处理数组键 ${key} 失败:`, e);
                                failedDeletes++;
                                deletionErrors.push(`处理数组键 ${key} 失败: ${e.message}`);
                            }
                        }
                        
                        // 2. 处理单个对象格式的数据和无效JSON数据
                        const objectAndInvalidKeys = phoneRelatedKeys.filter(
                            item => item.type === 'object' || item.type === 'invalid_json'
                        );
                        console.log(`处理 ${objectAndInvalidKeys.length} 个对象格式或无效JSON的项目键`);
                        console.log('对象/无效JSON键列表:', objectAndInvalidKeys.map(item => `${item.key} (${item.type})`));
                        
                        for (const { key, type } of objectAndInvalidKeys) {
                            console.log(`\n--- 处理${type === 'object' ? '对象' : '无效JSON'}键: "${key}" ---`);
                            try {
                                const value = localStorage.getItem(key);
                                console.log(`键 "${key}" 当前值长度:`, value ? value.length : 0);
                                
                                if (type === 'object' && value) {
                                    // 对于对象类型，尝试解析验证
                                    try {
                                        const data = JSON.parse(value);
                                        console.log(`对象键 "${key}" JSON解析成功，数据类型:`, typeof data);
                                        if (data && typeof data === 'object' && data.phone === phone) {
                                            console.log(`✓ 对象匹配目标手机号 "${phone}"，确认删除`);
                                        }
                                    } catch (parseError) {
                                        console.log(`✗ 对象键 "${key}" JSON解析失败:`, parseError.message);
                                    }
                                } else if (type === 'invalid_json') {
                                    console.log(`✓ 无效JSON键 "${key}" 将直接删除，无需解析`);
                                }
                                
                                localStorage.removeItem(key);
                                // 确认删除
                                if (localStorage.getItem(key) === null) {
                                    console.log(`✓ 成功删除键: ${key}`);
                                    deletedProjects++;
                                    successfulDeletes++;
                                } else {
                                    console.error(`✗ 删除键失败: ${key} (仍然存在)`);
                                    failedDeletes++;
                                    deletionErrors.push(`无法删除键: ${key}`);
                                }
                            } catch (e) {
                                console.error(`✗ 删除键 ${key} 失败:`, e);
                                failedDeletes++;
                                deletionErrors.push(`删除键 ${key} 失败: ${e.message}`);
                            }
                        }
                        
                        // 3. 特别处理缓存数据，如project_cache_${userId}
                        const cacheKeys = phoneRelatedKeys.filter(item => item.type === 'cache');
                        console.log(`处理 ${cacheKeys.length} 个缓存格式的项目键`);
                        console.log('缓存键列表:', cacheKeys.map(item => item.key));
                        
                        for (const { key } of cacheKeys) {
                            console.log(`\n--- 处理缓存键: "${key}" ---`);
                            try {
                                const value = localStorage.getItem(key);
                                console.log(`缓存键 "${key}" 当前值长度:`, value ? value.length : 0);
                                
                                if (value) {
                                    try {
                                        const data = JSON.parse(value);
                                        console.log(`缓存键 "${key}" JSON解析成功，数据类型:`, Array.isArray(data) ? 'array' : typeof data);
                                        
                                        // 对于缓存数据，我们需要特别处理，确保只删除与指定手机号或user_id相关的数据
                                        if (Array.isArray(data)) {
                                            console.log('开始过滤缓存数组项目...');
                                            const originalLength = data.length;
                                            let deletedCount = 0;
                                            
                                            const filteredData = data.filter(item => {
                                                const shouldKeep = !(item && typeof item === 'object' && (item.phone === phone || item.user_id === userId));
                                                if (!shouldKeep) {
                                                    deletedCount++;
                                                    console.log(`将要删除的缓存项目 [${deletedCount}]:`, item);
                                                }
                                                return shouldKeep;
                                            });
                                            
                                            console.log(`缓存数组: 原始项目数 ${originalLength}, 匹配删除数 ${deletedCount}, 保留项目数 ${filteredData.length}`);
                                            
                                            if (filteredData.length === 0) {
                                                localStorage.removeItem(key);
                                                console.log(`✓ 删除空缓存键: ${key}`);
                                                deletedProjects += deletedCount;
                                                successfulDeletes++;
                                            } else {
                                                localStorage.setItem(key, JSON.stringify(filteredData));
                                                console.log(`✓ 更新缓存键 ${key}: 原长度 ${originalLength}, 新长度 ${filteredData.length}`);
                                                deletedProjects += deletedCount;
                                                successfulDeletes++;
                                            }
                                        } else if (data && typeof data === 'object') {
                                            console.log(`缓存对象类型:`, Object.keys(data));
                                            // 如果是对象且匹配手机号或user_id，删除整个键
                                            if (data.phone === phone || data.user_id === userId) {
                                                localStorage.removeItem(key);
                                                console.log(`✓ 删除匹配手机号或user_id的缓存对象: ${key}`);
                                                deletedProjects++;
                                                successfulDeletes++;
                                            } else {
                                                console.log(`✗ 缓存对象不匹配目标手机号 "${phone}"或user_id "${userId}"，跳过`);
                                            }
                                        } else {
                                            console.log(`✗ 缓存数据类型异常:`, typeof data);
                                        }
                                    } catch (parseError) {
                                        // 解析失败的缓存数据直接删除
                                        console.log(`✗ 缓存键 "${key}" JSON解析失败，直接删除`);
                                        localStorage.removeItem(key);
                                        console.log(`✓ 删除解析失败的缓存键: ${key}`);
                                        successfulDeletes++;
                                    }
                                } else {
                                    console.log(`✗ 缓存键 "${key}" 值为空，跳过处理`);
                                }
                            } catch (e) {
                                console.error(`✗ 处理缓存键 ${key} 失败:`, e);
                                failedDeletes++;
                                deletionErrors.push(`处理缓存键 ${key} 失败: ${e.message}`);
                            }
                        }
                        
                        // 4. 执行最终清理：只查找项目相关的键中的遗漏数据
                        console.log('\n=== 执行最终清理 ===');
                        console.log('查找可能遗漏的项目数据...');
                        console.log(`目标手机号: "${phone}"`);
                        console.log('finalRemainingKeys 初始长度:', finalRemainingKeys.length);
                        
                        // 再次遍历项目相关的键进行最终检查
                        const allKeysAfterFirstPass = Object.keys(localStorage);
                        console.log('当前localStorage总键数:', allKeysAfterFirstPass.length);
                        
                        const remainingProjectKeys = allKeysAfterFirstPass.filter(isProjectRelatedKey);
                        console.log('项目相关键数量:', remainingProjectKeys.length);
                        console.log('项目相关键列表:', remainingProjectKeys);
                        
                        let foundRemainingKeys = 0;
                        for (const key of remainingProjectKeys) {
                            try {
                                const value = localStorage.getItem(key);
                                console.log(`\n--- 最终检查键: "${key}" ---`);
                                console.log(`键值长度:`, value ? value.length : 0);
                                
                                if (value) {
                                    // 检查是否包含目标手机号或user_id
                                    const phonePattern = `"phone":"${phone}"`;
                                    const userIdPattern = userId ? `"user_id":"${userId}"` : null;
                                    const containsPhone = value.includes(phonePattern);
                                    const containsUserId = userIdPattern ? value.includes(userIdPattern) : false;
                                    const containsTarget = containsPhone || containsUserId;
                                    console.log(`包含目标模式: phone=${containsPhone}, user_id=${containsUserId}, 总匹配=${containsTarget}`);
                                    
                                    if (containsTarget) {
                                        finalRemainingKeys.push(key);
                                        foundRemainingKeys++;
                                        console.log(`✓ 发现可能遗漏的与手机号或user_id相关的项目键: ${key}`);
                                    } else {
                                        console.log(`✗ 键 "${key}" 不包含目标手机号或user_id，跳过`);
                                    }
                                } else {
                                    console.log(`✗ 键 "${key}" 值为空，跳过`);
                                }
                            } catch (e) {
                                console.error(`✗ 最终检查键 ${key} 失败:`, e);
                                deletionErrors.push(`最终检查键 ${key} 失败: ${e.message}`);
                            }
                        }
                        
                        console.log(`\n=== 最终清理完成 ===`);
                        console.log(`发现 ${foundRemainingKeys} 个可能遗漏的与手机号相关的项目键`);
                        console.log('最终剩余键列表:', finalRemainingKeys);
                        
                        // 尝试删除所有剩余的与手机号相关的项目键
                        if (finalRemainingKeys.length > 0) {
                            console.log(`\n--- 删除 ${finalRemainingKeys.length} 个剩余项目键 ---`);
                            let finalDeletes = 0;
                            
                            for (let i = 0; i < finalRemainingKeys.length; i++) {
                                const key = finalRemainingKeys[i];
                                console.log(`\n删除剩余项目键 [${i + 1}/${finalRemainingKeys.length}]: "${key}"`);
                                
                                try {
                                    const value = localStorage.getItem(key);
                                    console.log(`键当前值长度:`, value ? value.length : 0);
                                    
                                    localStorage.removeItem(key);
                                    // 确认删除
                                    if (localStorage.getItem(key) === null) {
                                        finalDeletes++;
                                        deletedProjects++;
                                        console.log(`✓ 成功删除剩余项目键: ${key}`);
                                    } else {
                                        console.error(`✗ 删除剩余项目键失败: ${key} (仍然存在)`);
                                        deletionErrors.push(`无法删除剩余键: ${key}`);
                                        failedDeletes++;
                                    }
                                } catch (e) {
                                    console.error(`✗ 删除剩余项目键 ${key} 失败:`, e);
                                    deletionErrors.push(`删除剩余项目键 ${key} 失败: ${e.message}`);
                                    failedDeletes++;
                                }
                            }
                            
                            // 更新成功删除计数
                            successfulDeletes += finalDeletes;
                            console.log(`\n最终清理成功删除 ${finalDeletes} 个剩余项目键`);
                        } else {
                            console.log('无剩余项目键需要删除');
                        }
                    }
                    
                    console.log('\n=== 构建删除结果 ===');
                    console.log('统计信息汇总:');
                    console.log(`  - 当前数据模式: "${currentDataMode}"`);
                    console.log(`  - 成功删除项目: ${successfulDeletes} 个`);
                    console.log(`  - 删除失败项目: ${failedDeletes} 个`);
                    console.log(`  - 删除错误数量: ${deletionErrors.length}`);
                    console.log(`  - 总项目数: ${totalProjectKeysFound} 个`);
                    
                    // 创建结果对象
                    const totalProjects = currentDataMode === 'supabase' ? successfulDeletes : phoneRelatedData.length;
                    console.log(`\n删除结果计算:`);
                    console.log(`  - 总项目数计算: ${currentDataMode === 'supabase' ? 'successfulDeletes' : 'phoneRelatedData.length'}`);
                    console.log(`  - 计算结果: ${totalProjects} 个项目`);
                    
                    const deleteResult = {
                        success: failedDeletes === 0 || successfulDeletes > 0, // 如果有部分成功也认为整体成功
                        results: [],
                        total: totalProjects,
                        successful: successfulDeletes,
                        failed: failedDeletes,
                        errors: deletionErrors
                    };
                    
                    console.log(`\n--- deleteResult 对象 ---`);
                    console.log('deleteResult:', JSON.stringify(deleteResult, null, 2));
                    
                    // 显示操作结果，包括详细统计
                    console.log('\n--- 构建详细结果对象 ---');
                    const dataByType = phoneRelatedKeys.reduce((acc, item) => {
                        const type = item.type || 'unknown';
                        acc[type] = (acc[type] || 0) + 1;
                        return acc;
                    }, {});
                    
                    console.log('结果详情:');
                    console.log(`  - 目标手机号: "${phone}"`);
                    console.log(`  - 总项目键数: ${projectRelatedKeys.length}`);
                    console.log(`  - 关联手机号键数: ${phoneRelatedKeys.length}`);
                    console.log(`  - 找到的项目数: ${phoneRelatedData.length}`);
                    console.log(`  - 删除的项目数: ${successfulDeletes}`);
                    console.log(`  - 最终剩余键数: ${finalRemainingKeys.length}`);
                    console.log(`  - 按数据类型分类:`, dataByType);
                    
                    const resultWithDetails = {
                        ...deleteResult,
                        details: {
                            phone: phone,
                            totalKeysFound: projectRelatedKeys.length,
                            totalPhoneRelatedKeys: phoneRelatedKeys.length,
                            totalProjectsFound: phoneRelatedData.length,
                            totalProjectsDeleted: successfulDeletes,
                            finalRemainingKeys: finalRemainingKeys.length,
                            // 按数据类型分类统计
                            dataByType: dataByType
                        }
                    };
                    
                    console.log(`\n--- resultWithDetails 对象 ---`);
                    console.log('resultWithDetails:', JSON.stringify(resultWithDetails, null, 2));
                    
                    console.log('\n=== 显示删除结果 ===');
                    console.log('即将调用 displayResult() 显示结果');
                    displayResult('projectResults', resultWithDetails, '清空项目');
                    
                    if (deletionErrors.length > 0) {
                        console.log('\n删除过程中出现的错误:');
                        deletionErrors.forEach((error, index) => {
                            console.log(`  [${index + 1}] ${error}`);
                        });
                    }
                    
                    // 删除完成后重新查询并更新列表
                    console.log('\n=== 清除功能执行完毕 ===');
                    console.log('准备重新加载项目列表...');
                    console.log('调用 listProjects() 重新加载项目列表');
                    await listProjects();
                    
                } catch (error) {
                    console.error('清空项目失败:', error);
                    displayResult('projectResults', { 
                        success: false, 
                        error: `操作失败: ${error.message}` 
                    }, '清空项目');
                }
            }
        }
        
        // 员工管理函数
        async function createEmployee() {
            const employeeData = {
                emp_name: document.getElementById('employeeName').value,
                phone: document.getElementById('employeePhone').value,
                id_card: document.getElementById('employeeIdCard').value,
                project_id: document.getElementById('employeeProject').value,
                status: '在职',
                emp_code: document.getElementById('employeeCode').value,
                labor_cost: parseFloat(document.getElementById('laborCost').value) || 0
                // 不添加createTime字段，updateTime字段会由database-service自动添加
            };
            
            const result = await database.createEmployee(employeeData);
            displayResult('employeeResults', result, '员工');
        }
        
        async function readEmployee() {
            const employeeId = document.getElementById('employeeId').value;
            const result = await database.read('employees', employeeId);
            displayResult('employeeResults', result, '员工');
        }
        
        async function updateEmployee() {
            const employeeId = document.getElementById('employeeId').value;
            const updates = {
                emp_name: document.getElementById('employeeName').value,
                phone: document.getElementById('employeePhone').value,
                id_card: document.getElementById('employeeIdCard').value,
                emp_code: document.getElementById('employeeCode').value,
                labor_cost: parseFloat(document.getElementById('laborCost').value) || 0,
                status: document.getElementById('employeeStatus').value || '在职',
                updated_at: new Date().toISOString()
            };
            
            const result = await database.update('employees', employeeId, updates);
            displayResult('employeeResults', result, '员工');
        }
        
        async function deleteEmployee() {
            const employeeId = document.getElementById('employeeId').value;
            const result = await database.delete('employees', employeeId);
            displayResult('employeeResults', result, '员工');
        }
        
        async function listEmployees() {
            const result = await database.query('employees', {});
            displayResult('employeeResults', result, '员工列表');
        }
        
        async function batchCreateEmployees() {
            const employees = [
                { name: '张三', phone: '13800138001', projectId: 'test', status: '在职' },
                { name: '李四', phone: '13800138002', projectId: 'test', status: '在职' },
                { name: '王五', phone: '13800138003', projectId: 'test', status: '在职' }
            ];
            
            const operations = employees.map(emp => ({
                type: 'CREATE',
                table: 'employees',
                data: emp
            }));
            
            const result = await database.batch(operations);
            displayResult('employeeResults', result, '批量创建员工');
        }
        
        async function batchUpdateEmployees() {
            // 批量更新功能
            displayResult('employeeResults', { 
                success: true, 
                message: '批量更新功能待实现' 
            }, '批量更新员工');
        }
        
        // 记工记录管理函数
        async function createAttendance() {
            const attendanceData = {
                projectId: document.getElementById('attendanceProject').value,
                employeeId: document.getElementById('attendanceEmployee').value,
                date: document.getElementById('attendanceDate').value,
                workType: document.getElementById('attendanceType').value,
                workDays: parseFloat(document.getElementById('attendanceWork').value),
                amount: parseFloat(document.getElementById('attendanceWork').value) * 200, // 假设200元/工
                status: '正常',
                createTime: new Date().toISOString()
            };
            
            const result = await database.createAttendance(attendanceData);
            displayResult('attendanceResults', result, '记工记录');
        }
        
        async function readAttendance() {
            const attendanceId = document.getElementById('attendanceId').value;
            const result = await database.read('attendance', attendanceId);
            displayResult('attendanceResults', result, '记工记录');
        }
        
        async function updateAttendance() {
            const attendanceId = document.getElementById('attendanceId').value;
            const updates = {
                workDays: parseFloat(document.getElementById('attendanceWork').value),
                amount: parseFloat(document.getElementById('attendanceWork').value) * 200,
                updateTime: new Date().toISOString()
            };
            
            const result = await database.update('attendance', attendanceId, updates);
            displayResult('attendanceResults', result, '记工记录');
        }
        
        async function deleteAttendance() {
            const attendanceId = document.getElementById('attendanceId').value;
            const result = await database.delete('attendance', attendanceId);
            displayResult('attendanceResults', result, '记工记录');
        }
        
        async function queryAttendance() {
            const result = await database.query('attendance', {});
            displayResult('attendanceResults', result, '记工记录列表');
        }
        
        async function advancedQuery() {
            try {
                const queryText = document.getElementById('advancedQuery').value;
                const conditions = JSON.parse(queryText);
                const result = await database.query('attendance', conditions);
                displayResult('attendanceResults', result, '高级查询');
            } catch (error) {
                displayResult('attendanceResults', { success: false, error: 'JSON格式错误' }, '高级查询');
            }
        }
        
        // 用户管理函数
        async function queryUserByAccount() {
            const phoneInputElem = document.getElementById('phoneInput');
            console.log('phoneInput元素:', phoneInputElem);
            let phone = phoneInputElem ? phoneInputElem.value : '';
            console.log('从phoneInput获取的原始手机号:', phone, '长度:', phone.length);
            console.log('手机号值类型:', typeof phone);
            console.log('手机号trim后:', phone.trim());
            
            // 标准化手机号：去除所有非数字字符，只保留数字
            phone = phone.replace(/\D/g, '');
            console.log('标准化后的手机号:', phone);
            
            if (!phone) {
                displayResult('userResults', { success: false, error: '请输入手机号' }, '用户查询');
                return;
            }
            
            let result;
            const currentDataMode = localStorage.getItem('dataMode') || 'local';
            
            try {
                if (currentDataMode === 'supabase' && window.supabase) {
                    // Supabase模式：使用phone查询
                    console.log('使用Supabase查询用户:', phone);
                    let { data, error } = await window.supabase
                        .from('users')
                        .select('*')
                        .eq('phone', phone);
                    
                    if (error) {
                        throw error;
                    }
                    
                    result = {
                        success: true,
                        data: data || [],
                        count: data ? data.length : 0,
                        total: data ? data.length : 0
                    };
                    console.log('成功从Supabase找到用户:', result.data.length, '条');
                } else {
                    // 本地模式：使用现有的逻辑（lightweightDatabaseService或localStorage）
                    if (window.lightweightDatabaseService) {
                        console.log('使用lightweightDatabaseService查询用户:', phone);
                        // 使用phone查询
                        result = await window.lightweightDatabaseService.query('users', { phone: phone });
                        
                        // 验证结果
                        if (result.success && result.data && result.data.length > 0) {
                            console.log('成功从lightweightDatabaseService找到用户:', result.data.length, '条');
                        } else {
                            console.log('lightweightDatabaseService未找到用户，尝试直接查询localStorage');
                            // 直接查询localStorage，与lightweightDatabaseService的getAllUsers方法保持一致
                            result = await queryUsersFromLocalStorage({ phone: phone });
                        }
                    } else {
                        // 如果轻量级服务不可用，直接查询localStorage
                        console.log('lightweightDatabaseService不可用，直接查询localStorage');
                        result = await queryUsersFromLocalStorage({ phone: phone });
                    }
                }
            } catch (error) {
                console.error('查询用户时发生错误:', error);
                // 出错时仍尝试直接查询localStorage作为后备
                try {
                    result = await queryUsersFromLocalStorage({ phone: phone });
                } catch (e) {
                    console.error('后备查询也失败:', e);
                    result = { success: false, error: '查询失败: ' + error.message };
                }
            }
            
            // 添加详细的调试日志，记录最终的查询结果
            console.log('最终查询结果 - 成功状态:', result.success);
            console.log('最终查询结果 - 数据数量:', result.data ? result.data.length : 0);
            console.log('最终查询结果 - 详细数据:', result.data);
            if (!result.success) {
                console.log('查询失败原因:', result.error);
            }
            
            displayResult('userResults', result, '用户查询');
        }
        
        async function listAllUsers() {
            let result;
            const currentDataMode = localStorage.getItem('dataMode') || 'local';
            
            try {
                if (currentDataMode === 'supabase' && window.supabase) {
                    // Supabase模式：使用Supabase客户端查询所有用户
                    console.log('使用Supabase获取所有用户');
                    const { data, error } = await window.supabase
                        .from('users')
                        .select('*');
                    
                    if (error) {
                        throw error;
                    }
                    
                    result = {
                        success: true,
                        data: data || [],
                        count: data ? data.length : 0,
                        total: data ? data.length : 0
                    };
                    console.log('成功从Supabase获取用户:', result.data.length, '条');
                } else {
                    // 本地模式：使用现有的逻辑（lightweightDatabaseService或localStorage）
                    if (window.lightweightDatabaseService) {
                        console.log('使用lightweightDatabaseService获取所有用户');
                        result = await window.lightweightDatabaseService.query('users', {});
                        
                        // 验证结果
                        if (result.success && result.data && result.data.length > 0) {
                            console.log('成功从lightweightDatabaseService获取用户:', result.data.length, '条');
                        } else {
                            console.log('lightweightDatabaseService未返回用户，尝试直接查询localStorage');
                            // 直接查询localStorage
                            result = await queryUsersFromLocalStorage({});
                        }
                    } else {
                        // 如果轻量级服务不可用，直接查询localStorage
                        console.log('lightweightDatabaseService不可用，直接查询localStorage');
                        result = await queryUsersFromLocalStorage({});
                    }
                }
            } catch (error) {
                console.error('获取所有用户时发生错误:', error);
                // 出错时仍尝试直接查询localStorage作为后备
                try {
                    result = await queryUsersFromLocalStorage({});
                } catch (e) {
                    console.error('后备查询也失败:', e);
                    result = { success: false, error: '查询失败: ' + error.message };
                }
            }
            
            displayResult('userResults', result, '所有用户');
        }
        
        // 通用函数：从localStorage查询用户数据，模拟lightweightDatabaseService的查询逻辑
        async function queryUsersFromLocalStorage(conditions = {}) {
            try {
                console.log('开始从localStorage查询用户数据，条件:', conditions);
                const users = [];
                const allKeys = Object.keys(localStorage);
                
                // 1. 从currentUser获取当前登录用户
                try {
                    const currentUserStr = localStorage.getItem('currentUser');
                    if (currentUserStr) {
                        const currentUser = JSON.parse(currentUserStr);
                        if (currentUser && typeof currentUser === 'object') {
                            // 确保用户有必要的字段
                            if (!currentUser.user_id && currentUser.id) {
                                currentUser.user_id = currentUser.id;
                            }
                            if (!currentUser.phone) {
                                currentUser.phone = localStorage.getItem('loggedInPhone') || '';
                            }
                            
                            // 检查是否有查询条件，如果有则只添加符合条件的用户
                            let shouldAddCurrentUser = true;
                            if (Object.keys(conditions).length > 0) {
                                shouldAddCurrentUser = false;
                                for (const [field, value] of Object.entries(conditions)) {
                                    if (value === undefined || value === null) continue;
                                    
                                    // 特殊处理phone字段，使其更宽松地匹配
                                    if (field === 'phone' || field === 'mobile' || field === 'telephone') {
                                        // 获取用户的手机号值，尝试多种可能的字段名
                                        let userPhone = currentUser[field];
                                        if (!userPhone) {
                                            userPhone = currentUser.mobile || currentUser.telephone || currentUser.phone_number || currentUser.phone || '';
                                        }
                                        
                                        // 标准化手机号：转换为字符串，只保留数字
                                        const normalizedUserPhone = String(userPhone).replace(/\D/g, '');
                                        const normalizedQueryPhone = String(value).replace(/\D/g, '');
                                        
                                        console.log(`比较currentUser手机号字段 ${field}: 用户手机号=${userPhone}, 标准化后=${normalizedUserPhone}, 查询手机号=${value}, 标准化后=${normalizedQueryPhone}`);
                                        
                                        if (normalizedUserPhone === normalizedQueryPhone) {
                                            shouldAddCurrentUser = true;
                                            break;
                                        }
                                    } else if (String(currentUser[field]) === String(value)) {
                                        shouldAddCurrentUser = true;
                                        break;
                                    }
                                }
                            }
                            
                            if (shouldAddCurrentUser) {
                                users.push(currentUser);
                                console.log('从currentUser获取到当前登录用户（符合查询条件）');
                            }
                        }
                    }
                } catch (e) {
                    console.error('解析currentUser失败:', e);
                }
                
                // 2. 查找所有以'users.'开头的键
                for (const key of allKeys) {
                    if (key.startsWith('users.')) {
                        try {
                            // 获取并解析数据
                            const dataStr = localStorage.getItem(key);
                            if (!dataStr) continue;
                            
                            const userData = JSON.parse(dataStr);
                            if (!userData) continue;
                            
                            // 支持多种数据格式
                            let userArray = [];
                            if (Array.isArray(userData)) {
                                // 直接是用户数组
                                userArray = userData;
                            } else if (userData.users && Array.isArray(userData.users)) {
                                // 包含users字段的对象
                                userArray = userData.users;
                            } else if (userData.data && Array.isArray(userData.data)) {
                                // 包含data字段的对象
                                userArray = userData.data;
                            } else if (typeof userData === 'object') {
                                // 单个用户对象
                                userArray = [userData];
                            }
                            
                            // 应用查询条件到每个用户
                            for (const user of userArray) {
                                let matches = true;
                                console.log('检查用户:', user, '查询条件:', conditions);
                                for (const [field, value] of Object.entries(conditions)) {
                                    if (value === undefined || value === null) continue;
                                    
                                    // 特殊处理phone字段，使其更宽松地匹配
                                    if (field === 'phone' || field === 'mobile' || field === 'telephone') {
                                        // 获取用户的手机号值，尝试多种可能的字段名
                                        let userPhone = user[field];
                                        if (!userPhone) {
                                            // 尝试其他可能的手机号字段名
                                            userPhone = user.mobile || user.telephone || user.phone_number || '';
                                        }
                                        
                                        // 标准化手机号：转换为字符串，只保留数字
                                        const normalizedUserPhone = String(userPhone).replace(/\D/g, '');
                                        const normalizedQueryPhone = String(value).replace(/\D/g, '');
                                        
                                        console.log(`比较手机号字段 ${field}: 用户手机号=${userPhone}, 标准化后=${normalizedUserPhone}, 查询手机号=${value}, 标准化后=${normalizedQueryPhone}`);
                                        
                                        if (normalizedUserPhone !== normalizedQueryPhone) {
                                            matches = false;
                                            break;
                                        }
                                    } else {
                                        // 其他字段使用标准比较
                                        console.log(`比较字段 ${field}: 用户值=${user[field]}, 查询值=${value}`);
                                        if (String(user[field]) !== String(value)) {
                                            matches = false;
                                            break;
                                        }
                                    }
                                }
                                
                                if (matches) {
                                    console.log('找到匹配用户:', user);
                                    users.push(user);
                                }
                            }
                        } catch (e) {
                            console.error(`解析用户数据失败 ${key}:`, e);
                        }
                    }
                }
                
                // 3. 从user_开头的键获取用户数据
                for (const key of allKeys) {
                    if (key.startsWith('user_')) {
                        try {
                            const dataStr = localStorage.getItem(key);
                            if (!dataStr) continue;
                            
                            const userData = JSON.parse(dataStr);
                            if (userData && typeof userData === 'object') {
                                // 单个用户对象
                                let matches = true;
                                console.log('检查user_开头键的用户:', userData, '查询条件:', conditions);
                                for (const [field, value] of Object.entries(conditions)) {
                                    if (value === undefined || value === null) continue;
                                    console.log(`比较字段 ${field}: 用户值=${userData[field]}, 查询值=${value}, 是否匹配=${userData[field] === value}`);
                                    if (userData[field] !== value) {
                                        matches = false;
                                        break;
                                    }
                                }
                                
                                if (matches) {
                                    console.log('找到匹配用户:', userData, `从${key}获取`);
                                    users.push(userData);
                                }
                            }
                        } catch (e) {
                            console.error(`解析用户数据失败 ${key}:`, e);
                        }
                    }
                }
                
                // 4. 去重处理，避免重复用户
                const uniqueUsers = [];
                const userMap = new Map();
                for (const user of users) {
                    const userId = user.user_id || user.id || user.phone || JSON.stringify(user);
                    if (!userMap.has(userId)) {
                        userMap.set(userId, user);
                        uniqueUsers.push(user);
                    }
                }
                
                console.log('从localStorage查询完成，找到用户:', uniqueUsers.length, '条');
                
                // 将用户数据存储到localStorage中，使用employee_cache_开头的键名格式
                // 获取当前用户手机号作为标识
                let userPhone = 'default';
                try {
                    const currentUserStr = localStorage.getItem('currentUser');
                    if (currentUserStr) {
                        const currentUser = JSON.parse(currentUserStr);
                        if (currentUser && (currentUser.phone || currentUser.empphone)) {
                            userPhone = currentUser.phone || currentUser.empphone;
                        }
                    }
                } catch (e) {
                    console.log('获取当前用户信息失败:', e);
                }
                
                // 使用employee_cache_+userPhone的格式存储数据
                const cacheKey = `employee_cache_${userPhone}`;
                console.log(`将用户数据存储到localStorage，键名: ${cacheKey}`);
                localStorage.setItem(cacheKey, JSON.stringify(uniqueUsers));
                
                // 同时支持旧格式employees_phone
                const oldCacheKey = `employees_${userPhone}`;
                localStorage.setItem(oldCacheKey, JSON.stringify(uniqueUsers));
                
                return { 
                    success: true, 
                    data: uniqueUsers, 
                    count: uniqueUsers.length,
                    total: uniqueUsers.length 
                };
            } catch (error) {
                console.error('从localStorage查询用户数据失败:', error);
                return { 
                    success: false, 
                    error: error.message 
                };
            }
        }
        
        async function readUser() {
            const userId = document.getElementById('userId').value;
            if (!userId) {
                displayResult('userResults', { success: false, error: '请输入用户ID' }, '用户读取');
                return;
            }
            
            const result = await database.read('users', userId);
            displayResult('userResults', result, '用户读取');
        }
        
        async function updateUser() {
            const userId = document.getElementById('userId').value;
            if (!userId) {
                displayResult('userResults', { success: false, error: '请输入用户ID' }, '用户更新');
                return;
            }
            
            // 获取当前用户信息
            const userResult = await database.read('users', userId);
            if (!userResult.success) {
                displayResult('userResults', userResult, '用户更新');
                return;
            }
            
            const currentUser = userResult.data;
            // 使用当前的login_name字段
            const currentLoginName = currentUser.login_name || '';
            
            const newLoginName = prompt('请输入新的用户名(login_name):', currentLoginName);
            const newPhone = prompt('请输入新的手机号:', currentUser.phone || '');
            
            if (newLoginName === null || newPhone === null) {
                return; // 用户取消
            }
            
            const updates = {
                login_name: newLoginName,
                phone: newPhone,
                updated_at: new Date().toISOString()
            };
            
            const result = await database.update('users', userId, updates);
            displayResult('userResults', result, '用户更新');
        }
        
        async function deleteUser() {
            const userId = document.getElementById('userAccount').value;
            if (!userId) {
                displayResult('userResults', { success: false, error: '请选择要删除的用户账号ID' }, '删除用户');
                return;
            }
            
            // 确认删除操作
            if (!confirm(`确定要删除账号ID为 ${userId} 的用户吗？此操作不可撤销。`)) {
                return;
            }
            
            let result;
            const currentDataMode = localStorage.getItem('dataMode') || 'local';
            
            try {
                if (currentDataMode === 'supabase' && window.supabase) {
                    // Supabase模式：只通过user_id删除
                    console.log('使用Supabase删除用户:', userId);
                    const { data, error } = await window.supabase
                        .from('users')
                        .delete()
                        .eq('user_id', userId);
                    
                    if (error) {
                        throw error;
                    }
                    
                    result = {
                        success: true,
                        message: `成功从Supabase删除账号ID为 ${userId} 的用户`
                    };
                } else {
                    // 本地模式：直接从localStorage删除用户
                    console.log('从localStorage删除用户:', userId);
                    
                    let deleted = false;
                    const allKeys = Object.keys(localStorage);
                    
                    // 1. 检查并删除currentUser中的用户数据
                    try {
                        const currentUserStr = localStorage.getItem('currentUser');
                        if (currentUserStr) {
                            const currentUser = JSON.parse(currentUserStr);
                            if (currentUser && (currentUser.user_id === userId || currentUser.id === userId)) {
                                localStorage.removeItem('currentUser');
                                localStorage.removeItem('loggedInPhone');
                                deleted = true;
                                console.log(`删除了currentUser中的用户 ${userId}`);
                            }
                        }
                    } catch (e) {
                        console.error('处理currentUser数据时出错:', e);
                    }
                    
                    // 2. 查找并删除以users.开头的键中的用户数据
                    for (const key of allKeys) {
                        if (key.startsWith('users.')) {
                            try {
                                const dataStr = localStorage.getItem(key);
                                if (dataStr) {
                                    const userData = JSON.parse(dataStr);
                                    // 检查user_id或id是否匹配
                                    if (userData && (userData.user_id === userId || userData.id === userId)) {
                                        localStorage.removeItem(key);
                                        deleted = true;
                                        console.log(`删除了用户数据 ${key}`);
                                    } else if (Array.isArray(userData)) {
                                        // 支持数组格式的数据
                                        const filteredUsers = userData.filter(user => !(user.user_id === userId || user.id === userId));
                                        if (filteredUsers.length < userData.length) {
                                            localStorage.setItem(key, JSON.stringify(filteredUsers));
                                            deleted = true;
                                            console.log(`从 ${key} 中删除了用户 ${userId}`);
                                        }
                                    }
                                }
                            } catch (e) {
                                console.error(`解析用户数据失败 ${key}:`, e);
                            }
                        }
                    }
                    
                    // 3. 检查并删除以user_开头的键中的用户数据
                    for (const key of allKeys) {
                        if (key.startsWith('user_')) {
                            try {
                                const dataStr = localStorage.getItem(key);
                                if (dataStr) {
                                    const userData = JSON.parse(dataStr);
                                    if (userData && (userData.user_id === userId || userData.id === userId)) {
                                        localStorage.removeItem(key);
                                        deleted = true;
                                        console.log(`删除了user_开头的用户数据 ${key}`);
                                    }
                                }
                            } catch (e) {
                                console.error(`解析user_开头的用户数据失败 ${key}:`, e);
                            }
                        }
                    }
                    
                    result = deleted 
                        ? { success: true, message: `成功从localStorage删除账号ID为 ${userId} 的用户` }
                        : { success: false, error: `未找到账号ID为 ${userId} 的用户` };
                }
                
                // 删除成功后，刷新下拉框
                if (result.success) {
                    await fillUserAccountsDropdown();
                }
            } catch (error) {
                console.error('删除用户时发生错误:', error);
                result = { success: false, error: '删除失败: ' + error.message };
            }
            
            displayResult('userResults', result, '删除用户');
        }
        

        
        async function exportUsers() {
            let users = [];
            const currentDataMode = localStorage.getItem('dataMode') || 'local';
            
            try {
                if (currentDataMode === 'supabase' && window.supabase) {
                    // Supabase模式：使用Supabase客户端获取所有用户
                    console.log('使用Supabase导出用户数据');
                    const { data, error } = await window.supabase
                        .from('users')
                        .select('*');
                    
                    if (error) {
                        throw error;
                    }
                    
                    users = data || [];
                } else {
                    // 本地模式：直接使用queryUsersFromLocalStorage函数获取用户数据
                    console.log('使用本地模式导出用户数据');
                    const result = await queryUsersFromLocalStorage({});
                    if (result.success && result.data) {
                        users = result.data;
                        console.log(`本地模式下获取到${users.length}个用户数据用于导出`);
                    } else {
                        throw new Error('获取用户数据失败: ' + (result.error || '未知错误'));
                    }
                }
                
                // 准备导出数据 - 直接使用users作为根键，与用户期望格式一致
                const processedUsers = users.map(u => ({
                    user_id: u.user_id,
                    login_name: u.login_name || '未命名用户',
                    phone: u.phone || '',
                    password: u.password || '',
                    status: u.status || 'active',
                    created_at: u.created_at || new Date().toISOString(),
                    updated_at: u.updated_at || u.created_at || new Date().toISOString()
                }));
                
                // 直接使用users作为根键
                const exportData = {
                    users: processedUsers
                };
                
                // 导出数据
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `users_export_${new Date().getTime()}.json`;
                link.click();
                
                displayResult('userResults', { 
                    success: true, 
                    message: `用户数据导出成功，共导出 ${users.length} 个用户`
                }, '用户导出');
            } catch (error) {
                console.error('导出用户数据时发生错误:', error);
                displayResult('userResults', { 
                    success: false, 
                    error: '导出用户数据失败: ' + error.message 
                }, '用户导出');
            }
        }
        
        async function clearAllUsers() {
            if (confirm('确定要清空所有用户数据吗？此操作不可逆！')) {
                let result;
                const currentDataMode = localStorage.getItem('dataMode') || 'local';
                
                try {
                    if (currentDataMode === 'supabase' && window.supabase) {
                        // Supabase模式：使用Supabase客户端删除所有用户
                        console.log('使用Supabase清空所有用户');
                        const { data, error } = await window.supabase
                            .from('users')
                            .delete()
                            .neq('phone', ''); // 删除所有用户
                        
                        if (error) {
                            throw error;
                        }
                        
                        result = {
                            success: true,
                            message: '成功清空所有用户数据'
                        };
                    } else {
                        // 本地模式：直接从localStorage中删除所有用户数据
                        console.log('使用本地模式清空所有用户');
                        
                        let deletedCount = 0;
                        const allKeys = Object.keys(localStorage);
                        
                        // 删除currentUser相关数据
                        localStorage.removeItem('currentUser');
                        localStorage.removeItem('loggedInPhone');
                        deletedCount++;
                        
                        // 查找并删除所有用户相关的数据
                        for (const key of allKeys) {
                            if (key.startsWith('users.') || key.startsWith('user_')) {
                                localStorage.removeItem(key);
                                deletedCount++;
                            }
                        }
                        
                        result = {
                            success: true,
                            message: `成功清空所有用户数据，共删除 ${deletedCount} 个用户相关条目`
                        };
                    }
                    
                    displayResult('userResults', result, '清空用户');
                } catch (error) {
                    console.error('清空用户数据时发生错误:', error);
                    displayResult('userResults', { 
                        success: false, 
                        error: '清空用户数据失败: ' + error.message 
                    }, '清空用户');
                }
            }
        }
        
        // 数据库维护函数
        async function backupDatabase() {
            const result = await database.backup();
            displayResult('maintenanceResults', result, '数据备份');
        }
        
        async function restoreDatabase() {
            const backupKey = prompt('请输入备份键:');
            if (backupKey) {
                const result = await database.restore(backupKey);
                displayResult('maintenanceResults', result, '数据恢复');
            }
        }
        
        async function clearDatabase() {
            if (confirm('确定要清空本地及数据库中的所有数据吗？此操作不可逆！')) {
                let result;
                
                try {
                    // 1. 清除数据库中的所有数据
                    const tables = ['projects', 'employees', 'attendance', 'logs'];
                    const operations = [];
                    
                    for (const table of tables) {
                        const records = await database.getAllRecords(table);
                        for (const record of records) {
                            operations.push({
                                type: 'DELETE',
                                table: table,
                                id: record.id
                            });
                        }
                    }
                    
                    await database.batch(operations);
                    
                    // 2. 清除localStorage中的所有相关数据
                    const allKeys = Object.keys(localStorage);
                    let localStorageKeysDeleted = 0;
                    
                    for (const key of allKeys) {
                        if (key.startsWith('projects.') || 
                            key.startsWith('employees.') || 
                            key.startsWith('attendance.') || 
                            key.startsWith('logs.') || 
                            key.startsWith('users.')) {
                            localStorage.removeItem(key);
                            localStorageKeysDeleted++;
                        }
                    }
                    
                    result = { 
                        success: true, 
                        message: `成功清空数据库和本地存储的数据。数据库记录已删除，本地存储中删除了${localStorageKeysDeleted}个键值对。` 
                    };
                } catch (error) {
                    console.error('清空数据时发生错误:', error);
                    result = { 
                        success: false, 
                        error: '清空数据失败: ' + error.message 
                    };
                }
                
                displayResult('maintenanceResults', result, '清空数据');
            }
        }
        
        async function exportData() {
            try {
                // 包含所有数据库表，包括users表
                const tables = ['projects', 'employees', 'attendance', 'logs', 'users'];
                const exportData = {
                    exportInfo: {
                        timestamp: new Date().toISOString(),
                        date: new Date().toLocaleString('zh-CN'),
                        description: '飞鱼考勤系统数据库完整导出（含注册用户数据）'
                    },
                    data: {}
                };
                
                let totalRecords = 0;
                
                for (const table of tables) {
                    const result = await database.query(table, {});
                    exportData.data[table] = result.data;
                    totalRecords += result.data.length;
                }
                
                // 添加统计信息
                exportData.exportInfo.statistics = {
                    totalTables: tables.length,
                    totalRecords: totalRecords,
                    tables: {}
                };
                
                tables.forEach(table => {
                    exportData.exportInfo.statistics.tables[table] = exportData.data[table].length;
                });
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                
                // 使用更易读的文件名格式
                const dateStr = new Date().toISOString().replace(/[:.]/g, '-');
                link.download = `飞鱼考勤_数据库导出_${dateStr}.json`;
                link.click();
                
                URL.revokeObjectURL(link.href); // 清理URL对象
                
                displayResult('maintenanceResults', 
                    { success: true, message: `数据导出成功！共导出 ${totalRecords} 条记录` }, 
                    '数据导出');
            } catch (error) {
                console.error('导出数据时发生错误:', error);
                displayResult('maintenanceResults', 
                    { success: false, error: '数据导出失败: ' + error.message }, 
                    '数据导出');
            }
        }
        
        // 获取记工记录字段的中文解释
        function getAttendanceFieldChineseName(fieldName) {
            const fieldMap = {
                'record_id': '记录ID',
                'phone': '手机号',
                'project_id': '项目ID',
                'employee_id': '员工ID',
                'record_date': '记工日期',
                'work_type': '工作类型',
                'regular_hours': '正常工时',
                'overtime_hours': '加班工时',
                'work_time': '工作时间',
                'contract_amount': '合同金额',
                'work_quantity': '工作数量',
                'unit_price': '单价',
                'total_price': '总价',
                'has_image': '是否有图片',
                'image_count': '图片数量',
                'image_ids': '图片ID列表',
                'remark': '备注',
                'created_at': '创建时间',
                'updated_at': '更新时间'
            };
            return fieldMap[fieldName] || fieldName;
        }
        
        // 获取项目字段的中文解释
        function getProjectFieldChineseName(fieldName) {
            const fieldMap = {
                'project_id': '项目ID',
                'user_id': '用户ID',
                'project_name': '项目名称',
                'address': '项目地址',
                'regular_hours': '正常工时',
                'overtime_hours': '加班工时',
                'status': '项目状态',
                'created_at': '创建时间',
                'updated_at': '更新时间'
            };
            return fieldMap[fieldName] || fieldName;
        }

        // 获取用户字段的中文解释
        function getUserFieldChineseName(fieldName) {
            const fieldMap = {
                'user_id': '用户ID',
                'login_name': '登录名',
                'phone': '手机号',
                'password': '密码(加密)',
                'status': '用户状态',
                'created_at': '创建时间',
                'updated_at': '更新时间'
            };
            return fieldMap[fieldName] || fieldName;
        }
        
        // 获取员工字段的中文解释
        function getEmployeeFieldChineseName(fieldName) {
            const fieldMap = {
                'employee_id': '员工ID',
                'project_id': '项目ID',
                'emp_code': '工号',
                'emp_name': '员工姓名',
                'status': '员工状态',
                'labor_cost': '工价',
                'phone': '员工手机号',
                'id_card': '身份证号',
                'hire_date': '入职日期',
                'leave_date': '离职日期',
                'remarks': '备注',
                'bank_name': '银行名称',
                'bank_card_number': '银行卡号',
                'bank_address': '开户行地址',
                'created_at': '创建时间',
                'updated_at': '更新时间'
            };
            return fieldMap[fieldName] || fieldName;
        }

        // 结果显示函数
        function displayResult(containerId, result, operation) {
            const container = document.getElementById(containerId);
            
            // 检查是否为记工记录表(attendance)
            const isAttendanceTable = operation.includes('记工记录') || operation.includes('attendance') || operation.includes('Attendance');
            // 检查是否为用户表
            const isUserTable = operation.includes('用户查询') || operation.includes('所有用户') || operation.includes('用户列表');
            // 检查是否为项目表
            const isProjectTable = operation.includes('项目列表') || operation.includes('项目查询') || operation.includes('projects') || operation.includes('项目');
            // 检查是否为员工表
            const isEmployeeTable = operation.includes('员工列表') || operation.includes('employees') || operation.includes('员工查询') || operation.includes('员工');
            // 员工字段优先顺序，包含更多可能的字段名，支持下划线命名法
            const employeeFieldsOrder = [
                'employee_id', 'emp_code', 'emp_name', 'phone', 'id_card', 
                'project_id', 'status', 'labor_cost', 'hire_date', 'leave_date',
                'bank_name', 'bank_card_number', 'bank_address', 'remarks',
                'created_at', 'updated_at', 'employeeId', 'empid', 'empname', 
                'empstatus', 'laborcost', 'empphone', 'projectname', 'createTime', 
                'updateTime', 'lastModified', 'noSync', 'id'
            ];
            
            if (result.success) {
                let content = `<div class="result-item success">✅ ${operation}操作成功</div>`;
                
                if (result.data) {
                    if (Array.isArray(result.data)) {
                        
                        content += `<div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        ${(() => {
                                            if (isAttendanceTable) {
                                                return Object.keys(result.data[0] || {}).map(key => {
                                                    const chineseName = getAttendanceFieldChineseName(key);
                                                    return `<th>${key}<br><span style="font-size: 12px; font-weight: normal; color: #666;">${chineseName}</span></th>`;
                                                }).join('');
                                            } else if (isUserTable) {
                                                // 按指定顺序显示用户字段
                                                const userFieldsOrder = ['user_id', 'phone', 'login_name', 'password', 'created_at', 'updated_at', 'status'];
                                                const allFields = Object.keys(result.data[0] || {});
                                                const orderedFields = [];
                                                
                                                // 先添加指定顺序的字段
                                                userFieldsOrder.forEach(field => {
                                                    if (allFields.includes(field)) {
                                                        orderedFields.push(field);
                                                    }
                                                });
                                                
                                                // 再添加其他未指定的字段
                                                allFields.forEach(field => {
                                                    if (!orderedFields.includes(field)) {
                                                        orderedFields.push(field);
                                                    }
                                                });
                                                
                                                return orderedFields.map(key => {
                                                    const chineseName = getUserFieldChineseName(key);
                                                    return `<th>${key}<br><span style="font-size: 12px; font-weight: normal; color: #666;">${chineseName}</span></th>`;
                                                }).join('');
                                            } else if (isProjectTable) {
                                                // 按指定顺序显示项目字段
                                                const projectFieldsOrder = ['project_id', 'user_id', 'project_name', 'address', 'regular_hours', 'overtime_hours', 'status', 'created_at', 'updated_at'];
                                                const allFields = Object.keys(result.data[0] || {});
                                                const orderedFields = [];
                                                
                                                // 先添加指定顺序的字段
                                                projectFieldsOrder.forEach(field => {
                                                    if (allFields.includes(field)) {
                                                        orderedFields.push(field);
                                                    }
                                                });
                                                
                                                // 再添加其他未指定的字段
                                                allFields.forEach(field => {
                                                    if (!orderedFields.includes(field)) {
                                                        orderedFields.push(field);
                                                    }
                                                });
                                                
                                                return orderedFields.map(key => {
                                                    const chineseName = getProjectFieldChineseName(key);
                                                    return `<th>${key}<br><span style="font-size: 12px; font-weight: normal; color: #666;">${chineseName}</span></th>`;
                                                }).join('');
                                            } else if (isEmployeeTable) {
                                                // 按指定顺序显示员工字段
                                                const allFields = Object.keys(result.data[0] || {});
                                                const orderedFields = [];
                                                
                                                // 先添加指定顺序的字段
                                                employeeFieldsOrder.forEach(field => {
                                                    if (allFields.includes(field)) {
                                                        orderedFields.push(field);
                                                    }
                                                });
                                                
                                                // 再添加其他未指定的字段
                                                allFields.forEach(field => {
                                                    if (!orderedFields.includes(field)) {
                                                        orderedFields.push(field);
                                                    }
                                                });
                                                
                                                return orderedFields.map(key => {
                                                    const chineseName = getEmployeeFieldChineseName(key);
                                                    return `<th>${key}<br><span style="font-size: 12px; font-weight: normal; color: #666;">${chineseName}</span></th>`;
                                                }).join('');
                                            } else {
                                                return Object.keys(result.data[0] || {}).map(key => `<th>${key}</th>`).join('');
                                            }
                                        })()}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${result.data.map(item => `
                                        <tr>
                                            ${(() => {
                                                if (isAttendanceTable) {
                                                    return Object.values(item).map(val => `<td>${val}</td>`).join('');
                                                } else if (isUserTable) {
                                                    // 按指定顺序显示用户字段值
                                                    const userFieldsOrder = ['user_id', 'phone', 'login_name', 'password', 'created_at', 'updated_at', 'status'];
                                                    const values = [];
                                                    
                                                    // 先添加指定顺序的字段值
                                                    userFieldsOrder.forEach(field => {
                                                        if (item.hasOwnProperty(field)) {
                                                            values.push(item[field]);
                                                        }
                                                    });
                                                    
                                                    // 再添加其他未指定的字段值
                                                    Object.keys(item).forEach(field => {
                                                        if (!userFieldsOrder.includes(field)) {
                                                            values.push(item[field]);
                                                        }
                                                    });
                                                    
                                                    return values.map(val => `<td>${val}</td>`).join('');
                                                } else if (isProjectTable) {
                                                    // 按指定顺序显示项目字段值
                                                    const projectFieldsOrder = ['project_id', 'user_id', 'project_name', 'address', 'regular_hours', 'overtime_hours', 'status', 'created_at', 'updated_at'];
                                                    const values = [];
                                                    
                                                    // 先添加指定顺序的字段值
                                                    projectFieldsOrder.forEach(field => {
                                                        if (item.hasOwnProperty(field)) {
                                                            values.push(item[field]);
                                                        }
                                                    });
                                                    
                                                    // 再添加其他未指定的字段值
                                                    Object.keys(item).forEach(field => {
                                                        if (!projectFieldsOrder.includes(field)) {
                                                            values.push(item[field]);
                                                        }
                                                    });
                                                    
                                                    return values.map(val => `<td>${val}</td>`).join('');
                                                } else if (isEmployeeTable) {
                                                    // 按指定顺序显示员工字段值
                                                    const values = [];
                                                    
                                                    // 先添加指定顺序的字段值
                                                    employeeFieldsOrder.forEach(field => {
                                                        if (item.hasOwnProperty(field)) {
                                                            values.push(item[field]);
                                                        }
                                                    });
                                                    
                                                    // 再添加其他未指定的字段值
                                                    Object.keys(item).forEach(field => {
                                                        if (!employeeFieldsOrder.includes(field)) {
                                                            values.push(item[field]);
                                                        }
                                                    });
                                                    
                                                    return values.map(val => `<td>${val}</td>`).join('');
                                                } else {
                                                    return Object.values(item).map(val => `<td>${val}</td>`).join('');
                                                }
                                            })()}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>`;
                    } else {
                        content += `<div class="result-item info">${JSON.stringify(result.data, null, 2)}</div>`;
                    }
                }
                
                if (result.count !== undefined) {
                    content += `<div class="result-item info">记录数量: ${result.count}</div>`;
                }
                
                // 显示操作统计
                if (result.total !== undefined) {
                    content += `<div class="result-item info">
                        总操作数: ${result.total}, 
                        成功: ${result.successful || 0}, 
                        失败: ${result.failed || 0}
                    </div>`;
                }
                
                // 显示详细统计信息
                if (result.details) {
                    content += `<div class="result-item details">
                        <h4>详细统计:</h4>
                        <ul>`;
                    
                    if (result.details.totalProjectsFound !== undefined) {
                        content += `<li>发现项目总数: ${result.details.totalProjectsFound}</li>`;
                    }
                    
                    if (result.details.totalProjectsDeleted !== undefined) {
                        content += `<li>成功删除项目数: ${result.details.totalProjectsDeleted}</li>`;
                    }
                    
                    if (result.details.projectsByStatus) {
                        content += `<li>
                            <span>项目状态分布:</span>
                            <ul style="margin-left: 20px;">
                                ${Object.entries(result.details.projectsByStatus).map(([status, count]) => 
                                    `<li>${status}: ${count}</li>`
                                ).join('')}
                            </ul>
                        </li>`;
                    }
                    
                    content += `</ul>
                    </div>`;
                }
                
                // 显示错误信息（如果有部分失败）
                if (result.failed > 0 && result.errors && result.errors.length > 0) {
                    content += `<div class="result-item warning">
                        <h4>部分操作失败:</h4>
                        <ul>
                            ${result.errors.slice(0, 10).map(error => `<li>${error}</li>`).join('')}
                            ${result.errors.length > 10 ? `<li>...还有 ${result.errors.length - 10} 个错误</li>` : ''}
                        </ul>
                    </div>`;
                }
                
                // 添加原始数据解析功能 - 转换为与首页从云端获取项目数据写入本地的格式一致
                function convertToTestFormat(result) {
                    // 从localStorage获取当前用户信息
                    const currentUserStr = localStorage.getItem('currentUser');
                    const loggedInPhone = localStorage.getItem('loggedInPhone');
                    
                    let user_id = '';
                    let phone = loggedInPhone;
                    
                    if (currentUserStr) {
                        try {
                            const currentUser = JSON.parse(currentUserStr);
                            user_id = currentUser.user_id || '';
                            phone = currentUser.phone || phone;
                        } catch (e) {
                            console.error('解析currentUser失败:', e);
                        }
                    }
                    
                    // 标准化手机号，确保只包含数字
                    if (phone) {
                        phone = phone.replace(/\D/g, '');
                    }
                    
                    // 创建转换后的数据结构
                    const convertedData = {};
                    
                    // 根据不同的表格类型生成不同的键名
                    if (isProjectTable && user_id) {
                        // 项目管理页面，使用与首页从云端获取项目数据写入本地的格式一致
                        // 处理项目数据，确保字段格式一致
                        const processedProjects = (result.data || []).map(project => ({
                            project_id: project.project_id,
                            user_id: project.user_id,
                            project_name: project.project_name || '未命名项目',
                            address: project.address || '',
                            regular_hours: project.regular_hours || 0,
                            overtime_hours: project.overtime_hours || 0,
                            status: project.status || '在建',
                            created_at: project.created_at || new Date().toISOString(),
                            updated_at: project.updated_at || project.created_at || new Date().toISOString()
                        }));
                        
                        // 使用project_cache_${user_id}作为键名，与首页同步服务格式一致
                        convertedData[`project_cache_${user_id}`] = processedProjects;
                    } else if (isEmployeeTable && phone) {
                        convertedData[`employees_${phone}`] = result.data || [];
                    } else if (isUserTable) {
                        // 用户管理页面，使用与首页修改密码格式一致的格式
                        if (Array.isArray(result.data)) {
                            // 多个用户数据，使用对象数组格式
                            convertedData.users = result.data.map(user => ({
                                user_id: user.user_id,
                                login_name: user.login_name,
                                phone: user.phone,
                                password: user.password,
                                status: user.status || 'active',
                                created_at: user.created_at,
                                updated_at: user.updated_at
                            }));
                        } else {
                            // 单个用户数据，直接使用对象格式
                            convertedData.user = {
                                user_id: result.data.user_id,
                                login_name: result.data.login_name,
                                phone: result.data.phone,
                                password: result.data.password,
                                status: result.data.status || 'active',
                                created_at: result.data.created_at,
                                updated_at: result.data.updated_at
                            };
                        }
                    } else {
                        // 其他类型数据，使用默认键名
                        convertedData[`data_${user_id || phone || 'default'}`] = result.data || [];
                    }
                    
                    return convertedData;
                }
                
                const testFormatResult = convertToTestFormat(result);
                
                content += `
                    <div class="raw-data-analysis" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px;">
                        <h3 style="margin-top: 0; color: #343a40;">原始数据解析</h3>
                        <div style="margin-top: 15px;">
                            <button onclick="toggleRawData('${containerId}')" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                查看原始数据
                            </button>
                        </div>
                        
                        <div id="${containerId}-raw-data" style="margin-top: 15px; display: none; background: white; padding: 15px; border: 1px solid #dee2e6; border-radius: 6px; overflow-x: auto;">
                            <h4 style="margin-top: 0; color: #495057;">原始JSON数据</h4>
                            <pre style="margin: 0; white-space: pre-wrap; word-wrap: break-word; font-size: 12px; line-height: 1.5;">${JSON.stringify(testFormatResult, null, 2)}</pre>
                        </div>
                    </div>
                `;
                
                container.innerHTML = content;
            }
        }
        
        // 切换原始数据显示
        function toggleRawData(containerId) {
            const rawDataDiv = document.getElementById(`${containerId}-raw-data`);
            if (rawDataDiv) {
                rawDataDiv.style.display = rawDataDiv.style.display === 'none' ? 'block' : 'none';
            }
        }
        

        
        // 初始化下拉框数据
        function initDropdowns() {
            console.log('开始初始化下拉框');
            
            // 获取当前登录手机号
            let phone = localStorage.getItem('loggedInPhone');
            // 测试环境下使用默认手机号
            if (!phone && window.location.hostname === 'localhost') {
                phone = '13800138000';
                console.log('使用测试环境默认手机号:', phone);
            }
            console.log('当前手机号:', phone);
            
            // 获取下拉框元素
            const phoneSelect = document.getElementById('currentPhone');
            const projectSelect = document.getElementById('currentProject');
            
            // 清空两个下拉框
            phoneSelect.innerHTML = '<option value="">请选择手机号</option>';
            projectSelect.innerHTML = '<option value="">请选择项目</option>';
            
            // 从localStorage获取所有唯一的手机号
            const allKeys = Object.keys(localStorage);
            console.log('localStorage中的键数量:', allKeys.length);
            console.log('localStorage中的键:', allKeys);
            
            const phoneSet = new Set();
            
            // 添加当前登录手机号（如果有）
            if (phone) {
                phoneSet.add(phone);
                console.log('添加当前登录手机号到下拉框');
            }
            
            // 扩大范围，从所有可能包含手机号的数据中提取
            allKeys.forEach(key => {
                try {
                    // 特殊处理dataMode和其他已知的非JSON格式键
                    if (key === 'dataMode' || key === 'loggedInPhone' || key === 'accessToken' || key === 'currentProjectId' || key === 'currentProjectName') {
                        const value = localStorage.getItem(key);
                        console.log(`跳过JSON解析，直接处理键 ${key} 值: ${value}`);
                        // 如果是可能包含手机号的值，添加到phoneSet
                        if (key === 'loggedInPhone' && value) {
                            phoneSet.add(value);
                        }
                        return;
                    }
                    
                    const data = localStorage.getItem(key);
                    // 检查data是否为空或不是字符串
                    if (!data || typeof data !== 'string') {
                        console.log(`跳过解析键 ${key}，值为空或不是字符串`);
                        return;
                    }
                    
                    const item = JSON.parse(data);
                    
                    if (item && typeof item === 'object') {
                        // 检查多种可能的手机号字段
                        const phoneFields = ['phone', 'userPhone', 'userId', '手机号', '账号', '账户'];
                        
                        for (const field of phoneFields) {
                            if (item[field]) {
                                phoneSet.add(item[field]);
                                console.log(`从键 ${key} 提取手机号: ${item[field]}`);
                                break;
                            }
                        }
                    }
                } catch (e) {
                    console.error(`解析键 ${key} 时出错:`, e);
                    // 出错时继续处理下一个键，不中断整个流程
                }
            });
            
            // 添加所有唯一的手机号到下拉框
            console.log('找到的唯一手机号数量:', phoneSet.size);
            phoneSet.forEach(phoneVal => {
                const option = document.createElement('option');
                option.value = phoneVal;
                option.textContent = phoneVal;
                phoneSelect.appendChild(option);
            });
            
            // 获取并填充项目列表，使用第一个手机号（如果有）
            const firstPhone = phoneSet.size > 0 ? phoneSet.values().next().value : null;
            console.log('使用手机号', firstPhone, '加载项目列表');
            
            // 立即调用loadUserProjects，同时也尝试直接从localStorage加载所有项目
            loadUserProjects(firstPhone);
            
            // 额外添加一个按钮点击事件，用于手动刷新项目列表（调试用）
            const refreshButton = document.createElement('button');
            refreshButton.textContent = '刷新项目列表';
            refreshButton.onclick = function() {
                const selectedPhone = phoneSelect.value;
                console.log('手动刷新，使用手机号:', selectedPhone);
                loadUserProjects(selectedPhone);
            };
            
            // 查找合适的位置插入刷新按钮
            const queryButton = document.getElementById('queryEmployeeButton');
            if (queryButton && queryButton.parentNode) {
                queryButton.parentNode.appendChild(refreshButton);
            }
        }
        
        // 加载用户项目列表
        async function loadUserProjects(phone) {
            console.log('加载项目列表，手机号:', phone);
            const projectSelect = document.getElementById('currentProject');
            projectSelect.innerHTML = '<option value="">请选择项目</option>';
            
            if (!phone) {
                return;
            }
            
            try {
                // 获取当前数据模式
                const currentDataMode = localStorage.getItem('dataMode') || 'local';
                console.log('当前数据模式:', currentDataMode);
                
                let user_id = '';
                let projects = [];
                
                // 根据数据模式获取user_id
                if (currentDataMode === 'supabase' && window.supabase) {
                    // 首先尝试从localStorage的currentUser中直接获取user_id，这是最可靠的方式
                    const currentUserStr = localStorage.getItem('currentUser');
                    if (currentUserStr) {
                        try {
                            const currentUser = JSON.parse(currentUserStr);
                            user_id = currentUser.user_id;
                            console.log('直接从currentUser获取到user_id:', user_id);
                        } catch (e) {
                            console.error('解析currentUser失败:', e);
                        }
                    }
                    
                    // 如果从currentUser获取失败，再尝试从Supabase获取
                    if (!user_id) {
                        console.log('从currentUser获取user_id失败，尝试使用Supabase从users表获取user_id，手机号:', phone);
                        
                        // 尝试不同的查询方式，确保能获取到user_id
                        let userData = null;
                        let userError = null;
                        
                        // 方法1：使用single()查询单个用户，尝试不同的字段名
                        try {
                            const result = await window.supabase
                                .from('users')
                                .select('*') // 选择所有字段，便于调试
                                .eq('phone', phone)
                                .single();
                            userData = result.data;
                            userError = result.error;
                            console.log('Supabase查询结果:', result);
                        } catch (e) {
                            console.error('使用single()查询用户失败:', e);
                        }
                        
                        // 如果方法1失败，尝试方法2：不使用single()，获取数组
                        if (!userData && !userError) {
                            try {
                                const result = await window.supabase
                                    .from('users')
                                    .select('*') // 选择所有字段，便于调试
                                    .eq('phone', phone);
                                userData = result.data && result.data.length > 0 ? result.data[0] : null;
                                userError = result.error;
                                console.log('Supabase查询结果（数组）:', result);
                            } catch (e) {
                                console.error('不使用single()查询用户失败:', e);
                            }
                        }
                        
                        if (userError) {
                            console.error('Supabase获取user_id失败:', userError);
                        } else if (userData) {
                            // 尝试从查询结果中提取user_id，支持不同的字段名
                            user_id = userData.user_id || userData.id || '';
                            console.log('从Supabase查询结果中提取到user_id:', user_id, '查询结果:', userData);
                        }
                    }
                    
                    // 使用user_id从projects表获取project_id和project_name
                    if (user_id) {
                        console.log('使用user_id从Supabase获取项目数据');
                        const { data: projectData, error: projectError } = await window.supabase
                            .from('projects')
                            .select('project_id, project_name')
                            .eq('user_id', user_id);
                        
                        if (projectError) {
                            console.error('Supabase获取项目数据失败:', projectError);
                        } else {
                            projects = projectData || [];
                            console.log('从Supabase获取到项目数据:', projects);
                        }
                    }
                } else {
                    // 本地模式：从用户数据中获取user_id
                    console.log('使用本地模式获取user_id');
                    
                    // 从localStorage获取用户数据
                    const allKeys = Object.keys(localStorage);
                    let userData = null;
                    
                    // 查找用户相关的键
                    const userKeys = allKeys.filter(key => 
                        key.includes('user') || key.includes('users') || key.includes('currentUser')
                    );
                    
                    for (const key of userKeys) {
                        try {
                            const value = localStorage.getItem(key);
                            if (value) {
                                const data = JSON.parse(value);
                                
                                // 处理不同的数据格式
                                if (Array.isArray(data)) {
                                    // 用户数组
                                    const foundUser = data.find(user => 
                                        user && typeof user === 'object' && user.phone === phone
                                    );
                                    if (foundUser) {
                                        userData = foundUser;
                                        break;
                                    }
                                } else if (data && typeof data === 'object') {
                                    // 单个用户对象或包含用户的对象
                                    if (data.phone === phone) {
                                        userData = data;
                                        break;
                                    } else if (data.user && data.user.phone === phone) {
                                        userData = data.user;
                                        break;
                                    } else if (data.data && Array.isArray(data.data)) {
                                        const foundUser = data.data.find(user => 
                                            user && typeof user === 'object' && user.phone === phone
                                        );
                                        if (foundUser) {
                                            userData = foundUser;
                                            break;
                                        }
                                    }
                                }
                            }
                        } catch (e) {
                            console.error('解析用户数据失败:', e);
                        }
                    }
                    
                    if (userData) {
                        user_id = userData.user_id || userData.id;
                        console.log('从本地数据获取到user_id:', user_id);
                    }
                    
                    // 使用user_id从项目数据中获取project_id和project_name
                    if (user_id) {
                        console.log('使用user_id从本地数据获取项目数据');
                        
                        // 查找项目相关的键
                        const projectKeys = allKeys.filter(key => 
                            key.includes('project')
                        );
                        
                        for (const key of projectKeys) {
                            try {
                                const value = localStorage.getItem(key);
                                if (value) {
                                    const data = JSON.parse(value);
                                    
                                    // 处理不同的数据格式
                                    if (Array.isArray(data)) {
                                        // 项目数组
                                        data.forEach(project => {
                                            if (project && typeof project === 'object' && project.user_id === user_id) {
                                                projects.push({
                                                    project_id: project.project_id || project.id,
                                                    project_name: project.project_name || project.name || '未命名项目'
                                                });
                                            }
                                        });
                                    } else if (data && typeof data === 'object') {
                                        // 单个项目对象或包含项目的对象
                                        if (data.user_id === user_id) {
                                            projects.push({
                                                project_id: data.project_id || data.id,
                                                project_name: data.project_name || data.name || '未命名项目'
                                            });
                                        } else if (data.projects && Array.isArray(data.projects)) {
                                            data.projects.forEach(project => {
                                                if (project && typeof project === 'object' && project.user_id === user_id) {
                                                    projects.push({
                                                        project_id: project.project_id || project.id,
                                                        project_name: project.project_name || project.name || '未命名项目'
                                                    });
                                                }
                                            });
                                        } else if (data.data && Array.isArray(data.data)) {
                                            data.data.forEach(project => {
                                                if (project && typeof project === 'object' && project.user_id === user_id) {
                                                    projects.push({
                                                        project_id: project.project_id || project.id,
                                                        project_name: project.project_name || project.name || '未命名项目'
                                                    });
                                                }
                                            });
                                        }
                                    }
                                }
                            } catch (e) {
                                console.error('解析项目数据失败:', e);
                            }
                        }
                        console.log('从本地数据获取到项目数据:', projects);
                    }
                }
                
                // 填充项目下拉框，确保项目名称去重显示
                if (projects.length > 0) {
                    const addedProjectNames = new Set(); // 用于存储已添加的项目名称，实现去重
                    
                    projects.forEach(project => {
                        if (project.project_id && project.project_name && !addedProjectNames.has(project.project_name)) {
                            const option = document.createElement('option');
                            option.value = project.project_id;
                            option.textContent = project.project_name;
                            projectSelect.appendChild(option);
                            addedProjectNames.add(project.project_name); // 标记该项目名称已添加
                        }
                    });
                } else {
                    console.log('未找到项目数据，添加默认选项');
                    const defaultOption = document.createElement('option');
                    defaultOption.value = 'default';
                    defaultOption.textContent = '默认项目';
                    projectSelect.appendChild(defaultOption);
                }
                
                return;
            } catch (error) {
                console.error('加载用户项目失败:', error);
                // 显示错误信息
                const errorOption = document.createElement('option');
                errorOption.value = '';
                errorOption.textContent = '加载项目失败，请重试';
                projectSelect.appendChild(errorOption);
                return;
            }
            
            try {
                // 尝试使用database-integration-service获取项目
                if (window.databaseService && typeof window.databaseService.getUserProjects === 'function') {
                    console.log('使用databaseService获取项目');
                    const result = await window.databaseService.getUserProjects(phone);
                    console.log('databaseService返回结果:', result);
                    if (result.success && result.data && result.data.length > 0) {
                        const addedProjectNames = new Set(); // 用于存储已添加的项目名称，实现去重
                        result.data.forEach(project => {
                            const projectId = project.project_id || project.id || project.projectId || project.projectid || project.name;
                            const projectName = project.name || project.projectName || project.projectId || project.projectname || '未知项目';
                            if (!addedProjectNames.has(projectName)) {
                                const option = document.createElement('option');
                                option.value = projectId;
                                option.textContent = projectName;
                                projectSelect.appendChild(option);
                                addedProjectNames.add(projectName); // 标记该项目名称已添加
                            }
                        });
                        return;
                    }
                }
                
                // 备用方案1：直接从项目表查询
                if (window.databaseService && typeof window.databaseService.query === 'function') {
                    console.log('尝试直接从项目表查询项目数据');
                    const result = await window.databaseService.query('projects', {});
                    console.log('直接查询项目表结果:', result);
                    if (result.success && result.data && result.data.length > 0) {
                        const projectMap = new Map(); // 用于存储project_id到project_name的映射，实现去重
                        result.data.forEach(project => {
                            // 检查手机号是否匹配
                            let phoneMatch = !phone;
                            if (phone && (project.phone === phone || project.userId === phone || project.userPhone === phone)) {
                                phoneMatch = true;
                            }
                            
                            if (phoneMatch) {
                                const projectId = project.project_id || project.id || project.projectId || project.projectid;
                                const projectNameFields = ['name', 'projectName', 'projectId', 'projectname', '项目名称'];
                                let projectName = '未知项目';
                                for (const field of projectNameFields) {
                                    if (project[field]) {
                                        projectName = project[field];
                                        break;
                                    }
                                }
                                // 使用project_id作为key，确保每个项目只添加一次
                                if (projectId) {
                                    projectMap.set(projectId, projectName);
                                }
                            }
                        });
                        
                        console.log('从项目表找到的项目数量:', projectMap.size);
                        projectMap.forEach((projectName, projectId) => {
                            const option = document.createElement('option');
                            option.value = projectId;
                            option.textContent = projectName;
                            projectSelect.appendChild(option);
                        });
                        
                        if (projectMap.size > 0) {
                            return;
                        }
                    }
                }
                
                // 备用方案2：从localStorage获取项目信息
                console.log('使用localStorage获取项目信息');
                const allKeys = Object.keys(localStorage);
                console.log('localStorage中的键数量:', allKeys.length);
                
                // 扩大搜索范围，包含更多可能的项目相关键
                const projectKeys = allKeys.filter(key => 
                    key.startsWith('projects.') || 
                    key.startsWith('project_cache_') || 
                    key.includes('project') || 
                    key.includes('Project') ||
                    key.includes('employee') ||
                    key.includes('Employee') ||
                    key.includes('attendance') ||
                    key.includes('Attendance')
                );
                
                console.log('找到的项目相关键数量:', projectKeys.length);
                const projectMap = new Map(); // 用于存储project_id到project_name的映射
                
                // 辅助函数：从项目项中提取项目ID和名称
                function extractProjectFromItem(item, projectMap, key) {
                    if (!item || typeof item !== 'object') return;
                    
                    // 尝试从多种可能的字段中提取项目ID
                    const projectId = item.project_id || item.id || item.projectId || item.projectid;
                    // 尝试从多种可能的字段中提取项目名称
                    const projectNameFields = ['name', 'projectName', 'projectId', 'projectname', '项目名称', '项目'];
                    let projectName = '未知项目';
                    
                    for (const field of projectNameFields) {
                        if (item[field]) {
                            projectName = item[field];
                            break;
                        }
                    }
                    
                    // 如果找到project_id，使用project_id作为key；否则使用projectName
                    const mapKey = projectId || projectName;
                    if (mapKey) {
                        projectMap.set(mapKey, projectName);
                        console.log(`从键 ${key} 提取项目: ID=${projectId}, 名称=${projectName}`);
                    }
                }
                
                // 遍历所有可能的键，尝试提取项目信息
                projectKeys.forEach(key => {
                    try {
                        const itemData = localStorage.getItem(key);
                        console.log(`检查键 ${key} 的数据`);
                        
                        // 尝试解析数据
                        const item = JSON.parse(itemData);
                        
                        // 检查是否为有效的项目数据，并且手机号匹配
                        if (item && typeof item === 'object') {
                            // 检查手机号是否匹配（支持多种可能的手机号字段）
                            const phoneFields = ['phone', 'userPhone', 'userId', '手机号', '账号', '账户'];
                            let phoneMatch = !phone; // 如果没有指定手机号，则匹配所有
                            
                            if (phone) {
                                for (const field of phoneFields) {
                                    if (item[field] === phone) {
                                        phoneMatch = true;
                                        break;
                                    }
                                }
                            }
                            
                            // 特殊处理project_cache_开头的键
                            if (key.startsWith('project_cache_')) {
                                console.log(`处理project_cache键: ${key}`);
                                // 尝试从cache数据中提取项目信息
                                // 可能的数据结构：缓存可能直接包含项目数组或对象
                                if (Array.isArray(item)) {
                                    item.forEach(cacheItem => {
                                        extractProjectFromItem(cacheItem, projectMap, key);
                                    });
                                } else {
                                    // 尝试检查cache的不同结构
                                    if (item.projects || item.items || item.data) {
                                        const potentialProjects = item.projects || item.items || item.data;
                                        if (Array.isArray(potentialProjects)) {
                                            potentialProjects.forEach(project => {
                                                extractProjectFromItem(project, projectMap, key);
                                            });
                                        } else if (typeof potentialProjects === 'object') {
                                            extractProjectFromItem(potentialProjects, projectMap, key);
                                        }
                                    } else {
                                        // 直接检查缓存对象本身
                                        extractProjectFromItem(item, projectMap, key);
                                    }
                                }
                            }
                            // 如果手机号匹配，或者这是一个独立的项目数据，提取项目名称
                            else if (phoneMatch || key.startsWith('projects.')) {
                                extractProjectFromItem(item, projectMap, key);
                            }
                        }
                        
                        // 特殊处理：如果数据是数组，尝试从中提取项目信息
                        if (Array.isArray(item)) {
                            item.forEach(subItem => {
                                if (subItem && typeof subItem === 'object') {
                                    // 检查手机号匹配
                                    const phoneFields = ['phone', 'userPhone', 'userId', '手机号', '账号', '账户'];
                                    let subPhoneMatch = !phone;
                                    if (phone) {
                                        for (const field of phoneFields) {
                                            if (subItem[field] === phone) {
                                                subPhoneMatch = true;
                                                break;
                                            }
                                        }
                                    }
                                    
                                    if (subPhoneMatch) {
                                        extractProjectFromItem(subItem, projectMap, key);
                                    }
                                }
                            });
                        }
                    } catch (e) {
                        console.error(`解析键 ${key} 时出错:`, e);
                    }
                });
                
                // 特殊处理：如果localStorage中有'projects'键，假设它存储了所有项目列表
                if (localStorage.getItem('projects')) {
                    try {
                        const projectsData = JSON.parse(localStorage.getItem('projects'));
                        if (Array.isArray(projectsData)) {
                            console.log('从projects键获取到项目数组，长度:', projectsData.length);
                            projectsData.forEach(project => {
                                if (project && typeof project === 'object') {
                                    const projectId = project.project_id || project.id || project.projectId || project.projectid;
                                    const projectNameFields = ['name', 'projectName', 'projectId', 'projectname', '项目名称'];
                                    let projectName = '未知项目';
                                    for (const field of projectNameFields) {
                                        if (project[field]) {
                                            projectName = project[field];
                                            break;
                                        }
                                    }
                                    if (projectId || projectName) {
                                        const mapKey = projectId || projectName;
                                        projectMap.set(mapKey, projectName);
                                        console.log(`从projects键提取项目: ID=${projectId}, 名称=${projectName}`);
                                    }
                                }
                            });
                        }
                    } catch (e) {
                        console.error('解析projects键时出错:', e);
                    }
                }
                
                console.log('找到的项目数量:', projectMap.size);
                
                // 如果没有找到项目，添加一些默认项目选项
                if (projectMap.size === 0) {
                    console.log('未找到项目数据，添加默认选项');
                    const defaultProjects = ['项目A', '项目B', '项目C', '测试项目'];
                    defaultProjects.forEach(projectName => {
                        projectMap.set(projectName, projectName); // 使用名称作为ID
                    });
                }
                
                // 添加到下拉框
                projectMap.forEach((projectName, projectId) => {
                    const option = document.createElement('option');
                    option.value = projectId;
                    option.textContent = projectName;
                    projectSelect.appendChild(option);
                });
            } catch (error) {
                console.error('加载项目列表失败:', error);
                
                // 出错时，至少提供一些默认选项
                const defaultProjects = ['项目A', '项目B', '项目C', '测试项目'];
                defaultProjects.forEach(projectName => {
                    const option = document.createElement('option');
                    option.value = projectName; // 默认项目使用名称作为ID
                    option.textContent = projectName;
                    projectSelect.appendChild(option);
                });
            }
        }
        
        // 修改查询员工函数，支持按手机号和项目筛选
        async function listEmployees() {
            const phone = document.getElementById('currentPhone').value;
            const projectValue = document.getElementById('currentProject').value;
            
            console.log('执行员工查询，手机号:', phone, '项目值:', projectValue);
            
            // 添加验证：只有在选择了phone或projectValue时才执行查询
            if (!phone && !projectValue) {
                console.log('没有选择筛选条件，不执行查询');
                const resultPanel = document.getElementById('employeeResults');
                resultPanel.innerHTML = '<div class="result-item empty">请选择至少一个筛选条件（手机号或项目名称）</div>';
                return;
            }
            
            // 获取当前数据模式
            const currentDataMode = localStorage.getItem('dataMode') || 'local';
            console.log('当前数据模式:', currentDataMode);
            
            // 构建查询条件
            const query = {};
            
            // 处理手机号查询，直接对应到phone字段
            if (phone) {
                query.phone = phone;
            }
            
            // 处理项目查询，根据数据模式使用不同的查询字段
            if (projectValue && projectValue !== 'default') {
                // 根据数据模式和项目值确定查询条件
                if (currentDataMode === 'supabase' && window.supabase) {
                    // Supabase模式：使用project_id字段查询
                    query.project_id = projectValue;
                    console.log('Supabase模式：使用project_id查询:', projectValue);
                } else {
                    // 本地模式：需要根据项目值确定是project_id还是project_name
                    // 先尝试从项目数据中获取对应的project_id
                    let projectId = projectValue;
                    let projectName = projectValue;
                    
                    // 尝试从localStorage获取项目数据，查找project_id和project_name的对应关系
                    try {
                        const allKeys = Object.keys(localStorage);
                        for (const key of allKeys) {
                            if (key.includes('project') || key.includes('projects')) {
                                const value = localStorage.getItem(key);
                                if (value) {
                                    const data = JSON.parse(value);
                                    if (Array.isArray(data)) {
                                        for (const project of data) {
                                            if (project && typeof project === 'object') {
                                                if (project.project_id === projectValue) {
                                                    projectName = project.project_name;
                                                    break;
                                                } else if (project.project_name === projectValue) {
                                                    projectId = project.project_id;
                                                    break;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    } catch (e) {
                        console.error('解析项目数据失败:', e);
                    }
                    
                    console.log('本地模式：project_id:', projectId, 'project_name:', projectName);
                    
                    // 本地模式下，员工数据可能使用不同的字段名存储项目信息
                    // 构建查询条件时，同时考虑project_id和projectname字段
                    query.$or = [
                        { project_id: projectId },
                        { projectname: projectName },
                        { project_name: projectName }
                    ];
                }
            }
            
            // 调用数据库查询
            try {
                let results;
                
                // 根据数据模式使用不同的查询方式
                if (currentDataMode === 'supabase' && window.supabase) {
                    // Supabase模式：直接使用supabase客户端查询
                    console.log('使用Supabase客户端查询员工数据');
                    
                    // 构建Supabase查询，使用更简单的查询逻辑
                    let queryBuilder = window.supabase.from('employees').select('*');
                    
                    // 处理项目条件（优先使用project_id）
                    if (projectValue && projectValue !== 'default') {
                        // 只使用project_id字段查询，因为这是最可靠的字段
                        queryBuilder = queryBuilder.eq('project_id', projectValue);
                    }
                    
                    // 不添加手机号条件，因为员工可能没有手机号，或者手机号可能不同
                    // 但如果有手机号且用户明确选择了，也可以添加
                    // if (phone) {
                    //     queryBuilder = queryBuilder.or(`phone.eq.${phone},phone.is.null,phone.is.undefined`);
                    // }
                    
                    const { data, error } = await queryBuilder;
                    
                    results = {
                        success: !error,
                        data: data || [],
                        error: error || null
                    };
                    console.log('Supabase查询结果:', results);
                    console.log('Supabase查询错误:', error);
                } else if (window.databaseService && typeof window.databaseService.query === 'function') {
                    // 本地模式：使用databaseService查询
                    console.log('使用databaseService查询员工数据');
                    results = await window.databaseService.query('employees', query);
                    
                    // 为了提高匹配成功率，在服务器返回结果后再在客户端做一次字段名兼容性处理
                    if (results.success && results.data) {
                        // 只要有查询条件，就应该在客户端进行精确筛选，确保字段匹配正确
                        if (phone || projectValue) {
                            console.log('执行客户端精确筛选，手机号:', phone, '项目值:', projectValue);
                            results.data = results.data.filter(employee => {
                                // 检查phone字段是否匹配手机号
                            // 当员工的phone字段为null或undefined时，也应该匹配，因为这些员工确实属于该项目
                            const phoneMatch = !phone || 
                                             employee.phone === phone || 
                                             employee.phone === null || 
                                             employee.phone === undefined;
                            
                            // 检查项目相关字段是否匹配
                            let projectMatch = true;
                            if (projectValue && projectValue !== 'default') {
                                projectMatch = employee.project_id === projectValue || 
                                               employee.projectname === projectValue ||
                                               employee.project_name === projectValue;
                            }
                            
                            return phoneMatch && projectMatch;
                            });
                            console.log('客户端筛选后结果数量:', results.data.length);
                        }
                    }
                } else {
                    // 没有可用的数据库服务，尝试从localStorage获取数据
                    console.log('没有可用的数据库服务，尝试从localStorage获取员工数据');
                    results = {
                        success: true,
                        data: [],
                        error: null
                    };
                    
                    // 从localStorage获取所有员工数据
                    const allKeys = Object.keys(localStorage);
                    console.log('开始从localStorage获取员工数据，所有键:', allKeys);
                    
                    for (const key of allKeys) {
                        // 扩大搜索范围，确保能匹配到首页写入的数据
                        if (key.includes('employee') || key.includes('employees') || key.includes('employee_cache')) {
                            console.log('处理员工相关键:', key);
                            try {
                                const value = localStorage.getItem(key);
                                if (value) {
                                    console.log('键', key, '的值:', value.substring(0, 100) + (value.length > 100 ? '...' : ''));
                                    const data = JSON.parse(value);
                                    
                                    // 处理多种可能的数据格式
                                    if (Array.isArray(data)) {
                                        console.log('键', key, '是员工数组，长度:', data.length);
                                        results.data = results.data.concat(data);
                                    } else if (typeof data === 'object') {
                                        // 检查是否是员工缓存对象，可能包含employees属性
                                        if (data.employees && Array.isArray(data.employees)) {
                                            console.log('键', key, '包含employees数组，长度:', data.employees.length);
                                            results.data = results.data.concat(data.employees);
                                        } 
                                        // 检查是否是首页写入的包含data属性的对象
                                        else if (data.data && Array.isArray(data.data)) {
                                            console.log('键', key, '包含data数组，长度:', data.data.length);
                                            results.data = results.data.concat(data.data);
                                        } 
                                        // 检查是否是首页写入的包含items属性的对象
                                        else if (data.items && Array.isArray(data.items)) {
                                            console.log('键', key, '包含items数组，长度:', data.items.length);
                                            results.data = results.data.concat(data.items);
                                        } 
                                        // 检查是否是单个员工对象，或者包含员工数据的对象
                                        else {
                                            // 检查对象是否包含员工特征字段
                                            const hasEmployeeFields = ['employee_id', 'emp_code', 'emp_name', 'phone', 'project_id'].some(field => data.hasOwnProperty(field));
                                            if (hasEmployeeFields) {
                                                console.log('键', key, '是单个员工对象');
                                                results.data.push(data);
                                            } else {
                                                // 可能是其他格式，尝试遍历所有属性
                                                let added = false;
                                                for (const prop in data) {
                                                    if (Array.isArray(data[prop])) {
                                                        // 检查数组中的元素是否是员工对象
                                                        const firstItem = data[prop][0];
                                                        if (firstItem && typeof firstItem === 'object') {
                                                            const hasEmpFields = ['employee_id', 'emp_code', 'emp_name', 'phone', 'project_id'].some(field => firstItem.hasOwnProperty(field));
                                                            if (hasEmpFields) {
                                                                console.log('键', key, '的属性', prop, '是员工数组，长度:', data[prop].length);
                                                                results.data = results.data.concat(data[prop]);
                                                                added = true;
                                                                break;
                                                            }
                                                        }
                                                    } else if (typeof data[prop] === 'object' && data[prop] !== null) {
                                                        // 检查属性是否是员工对象
                                                        const hasEmpFields = ['employee_id', 'emp_code', 'emp_name', 'phone', 'project_id'].some(field => data[prop].hasOwnProperty(field));
                                                        if (hasEmpFields) {
                                                            console.log('键', key, '的属性', prop, '是员工对象');
                                                            results.data.push(data[prop]);
                                                            added = true;
                                                        }
                                                    }
                                                }
                                                if (!added) {
                                                    console.log('键', key, '是未知格式的对象，跳过');
                                                }
                                            }
                                        }
                                    }
                                }
                            } catch (e) {
                                console.error('解析员工数据失败，键:', key, '错误:', e);
                            }
                        }
                    }
                    
                    console.log('从localStorage获取到的原始员工数据数量:', results.data.length);
                    
                    // 执行客户端筛选
                    if (phone || projectValue) {
                        console.log('执行客户端精确筛选，手机号:', phone, '项目值:', projectValue);
                        results.data = results.data.filter(employee => {
                            if (!employee || typeof employee !== 'object') {
                                console.log('跳过非对象员工数据:', employee);
                                return false;
                            }
                            
                            // 检查phone字段是否匹配手机号，支持多种字段名
                            const phoneFields = ['phone', 'empphone', 'employeePhone', 'loginPhone'];
                            const employeePhone = phoneFields.find(field => employee[field] !== undefined);
                            // 当员工的phone字段为null或undefined时，也应该匹配，因为这些员工确实属于该项目
                            const phoneMatch = !phone || 
                                             (employeePhone && 
                                              (employee[employeePhone] === phone || 
                                               employee[employeePhone] === null || 
                                               employee[employeePhone] === undefined));
                            // 对于没有phone字段的员工，也应该匹配
                            const hasPhoneField = phoneFields.some(field => employee.hasOwnProperty(field));
                            const phoneMatchFinal = !phone || phoneMatch || !hasPhoneField;
                            
                            // 检查项目相关字段是否匹配，支持多种字段名
                            let projectMatch = true;
                            if (projectValue && projectValue !== 'default') {
                                const projectFields = ['project_id', 'projectId', 'projectname', 'project_name', 'projectName'];
                                const projectMatchResult = projectFields.some(field => {
                                    return employee[field] === projectValue;
                                });
                                projectMatch = projectMatchResult;
                            }
                            
                            console.log('员工数据筛选结果:', {
                                employee: employee.emp_name || employee.empname || employee.name || '未知',
                                phoneMatch: phoneMatchFinal,
                                projectMatch: projectMatch,
                                employeePhone: employee.phone,
                                hasPhoneField: hasPhoneField,
                                employeeProject: employee.project_id || employee.projectId || employee.projectname || employee.project_name || '未知'
                            });
                            
                            return phoneMatchFinal && projectMatch;
                        });
                        console.log('客户端筛选后结果数量:', results.data.length);
                    }
                }
                
                // 按ID字段升序排序
                    if (results.data && results.data.length > 0) {
                        results.data.sort((a, b) => {
                            // 优先使用empid字段排序
                            const idA = a.empid !== undefined ? a.empid : (a.ID !== undefined ? a.ID : a.id || '');
                            const idB = b.empid !== undefined ? b.empid : (b.ID !== undefined ? b.ID : b.id || '');
                            
                            // 处理数字ID的情况
                            if (!isNaN(idA) && !isNaN(idB)) {
                                return Number(idA) - Number(idB);
                            }
                            // 处理字符串ID的情况
                            return String(idA).localeCompare(String(idB));
                        });
                    }
                    
                    // 更新员工emp_code下拉框
                    const employeeNamesSelect = document.getElementById('employeeNames');
                    employeeNamesSelect.innerHTML = ''; // 清空下拉框
                    
                    // 添加默认选项
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = '工号';
                    employeeNamesSelect.appendChild(defaultOption);
                    
                    // 添加员工emp_code到下拉框
                    if (results.success && results.data && results.data.length > 0) {
                        const empCodeSet = new Set(); // 使用Set去重
                        results.data.forEach(employee => {
                            // 优先使用emp_code字段，兼容不同的字段名
                            const empCode = employee.emp_code || employee.empid || employee.ID || employee.id || '';
                            if (empCode && !empCodeSet.has(empCode)) {
                                empCodeSet.add(empCode);
                                const option = document.createElement('option');
                                option.value = empCode;
                                option.textContent = empCode;
                                employeeNamesSelect.appendChild(option);
                            }
                        });
                        console.log('填充员工emp_code下拉框，共', empCodeSet.size, '个选项');
                    }
                
                // 显示结果
                const resultPanel = document.getElementById('employeeResults');
                
                if (results.success && results.data && results.data.length > 0) {
                    // 不使用弹窗显示筛选条件和结果数量，直接显示在页面上
                    console.log('当前筛选条件：', (phone ? '手机号: ' + phone : '所有手机号'), '|', (projectName ? '项目: ' + projectName : '所有项目'), '查询结果 (' + results.data.length + ' 条)');
                    
                    let content = '';
                    content += '<div style="height: 500px; overflow-y: auto; border-radius: 8px; border: 1px solid #e8e8e8; background-color: white;">';
                    content += '<table class="result-table" style="width: 100%; border-collapse: collapse; background-color: white; font-size: 14px;">';
                    content += '<thead>';
                    content += '<tr style="position: sticky; top: 0; background: linear-gradient(135deg, #1890ff 0%, #40a9ff 100%); color: white; z-index: 10; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);">';
                    
                    // 获取表头字段
                    const firstItem = results.data[0];
                    
                    // 字段映射表，将英文字段名转换为中文显示
                    const fieldMapping = {
                        'employee_id': '员工ID',
                        'project_id': '项目ID',
                        'emp_code': '工号',
                        'emp_name': '员工姓名',
                        'status': '员工状态',
                        'labor_cost': '工价',
                        'phone': '员工手机号',
                        'id_card': '身份证号',
                        'hire_date': '入职日期',
                        'leave_date': '离职日期',
                        'remarks': '备注',
                        'bank_name': '银行名称',
                        'bank_card_number': '银行卡号',
                        'bank_address': '开户行地址',
                        'created_at': '创建时间',
                        'updated_at': '更新时间',
                        'employeeId': '工号',
                        'empname': '姓名',
                        'empstatus': '状态',
                        'laborcost': '工价',
                        'empphone': '电话',
                        'projectname': '项目名称',
                        'createTime': '创建时间',
                        'updateTime': '更新时间',
                        'lastModified': '最后修改',
                        'noSync': '未同步',
                        'id': '记录ID',
                        'createdAt': '创建时间',
                        'updatedAt': '更新时间'
                    };
                    
                    Object.keys(firstItem).forEach(key => {
                        // 所有表头字段都使用统一的蓝色背景
                        const isKeyField = ['userId', 'userPhone', 'phone', 'projectName', 'projectId', '项目名称', '项目ID', 'employee_id', 'emp_code', 'emp_name'].includes(key);
                        // 使用映射表获取中文显示名，如果没有映射则使用原字段名
                        const displayName = fieldMapping[key] || key;
                        // 同时显示英文和中文标题
                        content += '<th style="font-weight: ' + (isKeyField ? 'bold' : 'normal') + '; background-color: #1890ff; padding: 12px 8px; text-align: left; border-bottom: 2px solid #096dd9; color: white; vertical-align: top;">' + key + '<br><span style="font-size: 12px; font-weight: normal; color: #e6f7ff;">' + displayName + '</span></th>';
                    });
                    
                    content += '</tr></thead><tbody>';
                    
                    // 添加数据行
                    results.data.forEach((item, index) => {
                        const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                        content += '<tr style="transition: all 0.2s ease; ' + (index % 2 === 0 ? 'background-color: #ffffff;' : 'background-color: #fafafa;') + '" onmouseover="this.style.backgroundColor=\'#e6f7ff\'; this.style.transform=\'translateZ(1px)\'; this.style.boxShadow=\'0 2px 4px rgba(0,0,0,0.05)\'" onmouseout="this.style.backgroundColor=\'' + (index % 2 === 0 ? '#ffffff' : '#fafafa') + '\'; this.style.transform=\'translateZ(0)\'; this.style.boxShadow=\'none\'">';
                        Object.values(item).forEach(value => {
                            content += '<td style="padding: 12px 8px; border-bottom: 1px solid #f0f0f0; color: #333;" title="' + (value || '') + '">' + (value || '') + '</td>';
                        });
                        content += '</tr>';
                    });
                    
                    content += '</tbody></table>';
                    content += '</div>';
                    
                    // 添加原始数据解析功能
                    // 处理员工数据格式，确保与导出功能使用相同的处理逻辑
                    const processedEmployees = results.data.map(employee => ({
                        employee_id: employee.employee_id || employee.id || '',
                        project_id: employee.project_id || employee.projectId || '',
                        emp_code: employee.emp_code || employee.empid || '',
                        emp_name: employee.emp_name || employee.empname || employee.name || '',
                        status: employee.status || '在职',
                        labor_cost: employee.labor_cost || employee.laborcost || 0,
                        phone: employee.phone || employee.empphone || null,
                        id_card: employee.id_card || employee.idCard || '',
                        hire_date: employee.hire_date || employee.hireDate || '',
                        leave_date: employee.leave_date || employee.leaveDate || null,
                        remarks: employee.remarks || '',
                        bank_name: employee.bank_name || employee.bankName || '',
                        bank_card_number: employee.bank_card_number || employee.bankCardNumber || '',
                        bank_address: employee.bank_address || employee.bankAddress || ''
                    }));
                    
                    // 构建与本地数据格式一致的解析结果
                    const timestamp = Date.now();
                    // 严格按照用户要求的格式，先显示timestamp键，再显示主要数据键
                    const rawDataFormat = {};
                    // 先添加timestamp键
                    rawDataFormat[`employees_${projectValue || 'default'}_timestamp`] = timestamp;
                    // 再添加主要数据键
                    rawDataFormat[`employees_${projectValue || 'default'}`] = {
                        employees: processedEmployees,
                        project_id: projectValue || 'default',
                        timestamp: timestamp
                    };
                    
                    content += `
                        <div class="raw-data-analysis" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px;">
                            <h3 style="margin-top: 0; color: #343a40;">原始数据解析</h3>
                            <div style="margin-top: 15px;">
                                <button onclick="toggleRawData('employeeResults')" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    查看原始数据
                                </button>
                            </div>
                            
                            <div id="employeeResults-raw-data" style="margin-top: 15px; display: none; background: white; padding: 15px; border: 1px solid #dee2e6; border-radius: 6px; overflow-x: auto;">
                                <h4 style="margin-top: 0; color: #495057;">原始JSON数据</h4>
                                <pre style="margin: 0; white-space: pre-wrap; word-wrap: break-word; font-size: 12px; line-height: 1.5;">${JSON.stringify(rawDataFormat, null, 2)}</pre>
                            </div>
                        </div>
                    `;
                    
                    resultPanel.innerHTML = content;
                } else {
                    resultPanel.innerHTML = '<div class="result-item empty">未找到符合条件的员工记录</div>';
                }
            } catch (error) {
                console.error('查询员工失败:', error);
                const resultPanel = document.getElementById('employeeResults');
                resultPanel.innerHTML = '<div class="result-item error">查询失败: ' + error.message + '</div>';
            }
        }

        // 导出员工数据功能
        async function exportEmployeeData() {
            console.log('开始导出员工数据');
            
            try {
                // 获取当前选择的手机号和项目
                const phoneSelect = document.getElementById('currentPhone');
                const projectSelect = document.getElementById('currentProject');
                const selectedPhone = phoneSelect.value;
                const selectedProject = projectSelect.value;
                
                // 显示加载状态
                const resultPanel = document.getElementById('employeeResults');
                resultPanel.innerHTML = '<div class="result-item info">正在导出员工数据...</div>';
                
                // 获取当前数据模式
                const currentDataMode = localStorage.getItem('dataMode') || 'local';
                
                let employeeData = [];
                
                if (currentDataMode === 'supabase' && window.supabase) {
                    // Supabase模式：使用Supabase客户端查询员工
                    console.log('使用Supabase查询员工数据');
                    let queryBuilder = window.supabase.from('employees').select('*');
                    
                    // 不添加手机号条件，因为员工可能没有手机号，或者手机号可能不同
                    // 只使用项目ID查询，确保能导出该项目下的所有员工
                    // if (selectedPhone) {
                    //     queryBuilder = queryBuilder.eq('phone', selectedPhone);
                    // }
                    
                    if (selectedProject && selectedProject !== 'default') {
                        queryBuilder = queryBuilder.eq('project_id', selectedProject);
                    }
                    
                    const { data, error } = await queryBuilder;
                    
                    if (error) {
                        throw error;
                    }
                    
                    employeeData = data || [];
                } else {
                    // 本地模式：从localStorage查询员工数据
                    console.log('从localStorage查询员工数据');
                    
                    // 从localStorage获取所有员工数据
                    const allKeys = Object.keys(localStorage);
                    for (const key of allKeys) {
                        if (key.includes('employee') || key.includes('employees')) {
                            try {
                                const value = localStorage.getItem(key);
                                if (value) {
                                    const data = JSON.parse(value);
                                    if (Array.isArray(data)) {
                                        employeeData = employeeData.concat(data);
                                    } else if (typeof data === 'object') {
                                        if (data.employees && Array.isArray(data.employees)) {
                                            employeeData = employeeData.concat(data.employees);
                                        } else {
                                            employeeData.push(data);
                                        }
                                    }
                                }
                            } catch (e) {
                                console.error('解析员工数据失败:', e);
                            }
                        }
                    }
                    
                    // 执行客户端筛选
                    if (selectedPhone || selectedProject) {
                        employeeData = employeeData.filter(employee => {
                            if (!employee || typeof employee !== 'object') {
                                return false;
                            }
                            
                            // 检查phone字段是否匹配手机号，支持多种字段名
                            const phoneFields = ['phone', 'empphone', 'employeePhone', 'loginPhone'];
                            const employeePhone = phoneFields.find(field => employee[field] !== undefined);
                            // 当员工的phone字段为null或undefined时，也应该匹配，因为这些员工确实属于该项目
                            const phoneMatch = !selectedPhone || 
                                             (employeePhone && 
                                              (employee[employeePhone] === selectedPhone || 
                                               employee[employeePhone] === null || 
                                               employee[employeePhone] === undefined));
                            // 对于没有phone字段的员工，也应该匹配
                            const hasPhoneField = phoneFields.some(field => employee.hasOwnProperty(field));
                            const phoneMatchFinal = !selectedPhone || phoneMatch || !hasPhoneField;
                            
                            // 检查项目相关字段是否匹配
                            let projectMatch = true;
                            if (selectedProject && selectedProject !== 'default') {
                                const projectFields = ['project_id', 'projectId', 'projectname', 'project_name', 'projectName'];
                                projectMatch = projectFields.some(field => employee[field] === selectedProject);
                            }
                            
                            return phoneMatchFinal && projectMatch;
                        });
                    }
                }
                
                // 如果没有找到员工数据，显示提示
                if (employeeData.length === 0) {
                    resultPanel.innerHTML = '<div class="result-item warning">未找到员工数据</div>';
                    alert('未找到可导出的员工数据');
                    return;
                }
                
                // 处理员工数据格式
                const processedEmployees = employeeData.map(employee => ({
                    employee_id: employee.employee_id || employee.id || '',
                    project_id: employee.project_id || employee.projectId || '',
                    emp_code: employee.emp_code || employee.empid || '',
                    emp_name: employee.emp_name || employee.empname || employee.name || '',
                    status: employee.status || '在职',
                    labor_cost: employee.labor_cost || employee.laborcost || 0,
                    phone: employee.phone || employee.empphone || null,
                    id_card: employee.id_card || employee.idCard || '',
                    hire_date: employee.hire_date || employee.hireDate || '',
                    leave_date: employee.leave_date || employee.leaveDate || null,
                    remarks: employee.remarks || '',
                    bank_name: employee.bank_name || employee.bankName || '',
                    bank_card_number: employee.bank_card_number || employee.bankCardNumber || '',
                    bank_address: employee.bank_address || employee.bankAddress || ''
                    // 移除created_at和updated_at字段，与用户提供的格式一致
                }));
                
                // 创建与本地数据格式一致的导出数据结构
                const timestamp = Date.now();
                // 严格按照用户要求的格式，先显示timestamp键，再显示主要数据键
                const exportData = {};
                // 先添加timestamp键
                exportData[`employees_${selectedProject || 'default'}_timestamp`] = timestamp;
                // 再添加主要数据键
                exportData[`employees_${selectedProject || 'default'}`] = {
                    employees: processedEmployees,
                    project_id: selectedProject || 'default',
                    timestamp: timestamp
                };
                
                // 转换为JSON字符串
                const jsonString = JSON.stringify(exportData, null, 2);
                
                // 创建Blob对象
                const blob = new Blob([jsonString], { type: 'application/json' });
                
                // 创建下载链接
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                // 设置文件名
                const filenameTimestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const filename = `employee_data_${selectedPhone || 'all'}_${filenameTimestamp}.json`;
                a.download = filename;
                
                // 触发下载
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                // 释放URL对象
                URL.revokeObjectURL(url);
                
                // 更新结果面板
                resultPanel.innerHTML = `<div class="result-item success">成功导出 ${employeeData.length} 条员工数据</div>`;
                
                // 不使用弹窗显示通知，直接在控制台显示
                console.log(`成功导出 ${employeeData.length} 条员工数据`);
                
            } catch (error) {
                console.error('导出员工数据失败:', error);
                const resultPanel = document.getElementById('employeeResults');
                resultPanel.innerHTML = `<div class="result-item error">导出失败: ${error.message}</div>`;
                alert(`导出员工数据失败: ${error.message}`);
            }
        }

        // 验证项目选择
        function validateProjectSelection() {
            const projectSelect = document.getElementById('currentProject');
            if (!projectSelect || projectSelect.selectedIndex < 0 || projectSelect.value === '') {
                alert('请选择项目');
                return false;
            }
            return true;
        }

        // 删除员工函数
        async function deleteEmployeeById() {
            try {
                // 验证项目选择
                if (!validateProjectSelection()) {
                    return;
                }

                // 从下拉框获取选中的工号
                const employeeNamesSelect = document.getElementById('employeeNames');
                const selectedEmpCode = employeeNamesSelect.value;
                
                if (!selectedEmpCode) {
                    alert("请从下拉框中选择要删除的员工工号");
                    return;
                }
                
                if (!confirm(`确定要删除工号为"${selectedEmpCode}"的员工吗？此操作不可撤销。`)) {
                    return;
                }
                
                console.log('准备删除员工工号:', selectedEmpCode);
                
                // 获取当前数据模式
                const currentDataMode = localStorage.getItem('dataMode') || 'local';
                console.log('当前数据模式:', currentDataMode);
                
                // 获取当前选中的项目ID
                const projectSelect = document.getElementById('currentProject');
                const selectedProjectId = projectSelect.value;
                console.log('当前选中的项目ID:', selectedProjectId);
                
                let foundEmployeeId = null;
                let foundEmployee = null;
                
                // 根据数据模式执行不同的查找和删除操作
                if (currentDataMode === 'supabase' && window.supabase) {
                    // Supabase模式：使用Supabase查询员工
                    console.log('Supabase模式：查询员工，工号:', selectedEmpCode, '项目ID:', selectedProjectId);
                    
                    // 查询匹配的员工
                    const { data, error } = await window.supabase
                        .from('employees')
                        .select('*')
                        .eq('project_id', selectedProjectId)
                        .eq('emp_code', selectedEmpCode);
                    
                    if (error) {
                        console.error('Supabase查询失败:', error);
                        alert(`查询失败: ${error.message}`);
                        return;
                    }
                    
                    if (data && data.length > 0) {
                        foundEmployee = data[0];
                        foundEmployeeId = foundEmployee.employee_id || foundEmployee.id;
                        console.log('找到匹配的员工:', foundEmployee);
                        
                        // 执行删除操作
                        const { deleteData, deleteError } = await window.supabase
                            .from('employees')
                            .delete()
                            .eq('employee_id', foundEmployeeId);
                        
                        if (deleteError) {
                            console.error('Supabase删除失败:', deleteError);
                            alert(`删除失败: ${deleteError.message}`);
                        } else {
                            console.log('Supabase删除成功');
                            alert(`成功删除工号为"${selectedEmpCode}"的员工`);
                            // 重新加载员工列表
                            listEmployees();
                        }
                    } else {
                        console.log('Supabase未找到匹配的员工');
                        alert(`未找到工号为"${selectedEmpCode}"的员工记录`);
                    }
                } else {
                    // 本地模式：从localStorage查询员工
                    console.log('本地模式：查询员工，工号:', selectedEmpCode, '项目ID:', selectedProjectId);
                    
                    // 从localStorage获取所有员工数据
                    const allKeys = Object.keys(localStorage);
                    let employeeData = [];
                    
                    for (const key of allKeys) {
                        if (key.includes('employee') || key.includes('employees')) {
                            try {
                                const value = localStorage.getItem(key);
                                if (value) {
                                    const data = JSON.parse(value);
                                    if (Array.isArray(data)) {
                                        employeeData = employeeData.concat(data);
                                    } else if (typeof data === 'object' && data.employees) {
                                        employeeData = employeeData.concat(data.employees);
                                    }
                                }
                            } catch (e) {
                                console.error('解析员工数据失败:', e);
                            }
                        }
                    }
                    
                    // 查找匹配的员工
                    foundEmployee = employeeData.find(emp => {
                        return emp.emp_code === selectedEmpCode && emp.project_id === selectedProjectId;
                    });
                    
                    if (foundEmployee) {
                        foundEmployeeId = foundEmployee.employee_id || foundEmployee.id || foundEmployee.project_id;
                        console.log('找到匹配的员工:', foundEmployee);
                        
                        // 执行删除操作
                        if (window.databaseService && typeof window.databaseService.delete === 'function') {
                            // 使用databaseService删除
                            const deleteResult = await window.databaseService.delete('employees', foundEmployeeId);
                            displayResult('employeeResults', deleteResult, '员工删除');
                            
                            console.log('删除员工结果:', deleteResult);
                            
                            if (deleteResult && deleteResult.success) {
                                alert(`成功删除工号为"${selectedEmpCode}"的员工`);
                                // 重新加载员工列表
                                listEmployees();
                            } else {
                                alert(`删除失败: ${deleteResult?.error || '未知错误'}`);
                            }
                        } else {
                            // 直接从localStorage删除
                            console.log('直接从localStorage删除员工');
                            
                            // 遍历所有localStorage键，删除匹配的员工
                            for (const key of allKeys) {
                                if (key.includes('employees_') || key.includes('employee_')) {
                                    try {
                                        const value = localStorage.getItem(key);
                                        if (value) {
                                            const data = JSON.parse(value);
                                            if (Array.isArray(data)) {
                                                // 过滤掉要删除的员工
                                                const filteredData = data.filter(emp => 
                                                    !(emp.emp_code === selectedEmpCode && emp.project_id === selectedProjectId)
                                                );
                                                // 保存过滤后的数据
                                                localStorage.setItem(key, JSON.stringify(filteredData));
                                                console.log('已从', key, '中删除员工');
                                            } else if (typeof data === 'object' && data.employees) {
                                                // 处理包含employees数组的对象
                                                data.employees = data.employees.filter(emp => 
                                                    !(emp.emp_code === selectedEmpCode && emp.project_id === selectedProjectId)
                                                );
                                                localStorage.setItem(key, JSON.stringify(data));
                                                console.log('已从', key, '中删除员工');
                                            }
                                        }
                                    } catch (e) {
                                        console.error('删除员工数据失败:', e);
                                    }
                                }
                            }
                            
                            alert(`成功删除工号为"${selectedEmpCode}"的员工`);
                            // 重新加载员工列表
                            listEmployees();
                        }
                    } else {
                        console.log('本地模式未找到匹配的员工');
                        alert(`未找到工号为"${selectedEmpCode}"的员工记录`);
                    }
                }
            } catch (error) {
                console.error('删除员工失败:', error);
                alert(`删除员工时发生错误: ${error.message || '未知错误'}`);
            }
        }
        
        // 删除选中项目中的所有员工
        async function deleteAllEmployees() {
            try {
                // 获取当前选中的项目ID和名称
                const currentProjectSelect = document.getElementById('currentProject');
                const selectedProjectId = currentProjectSelect.value;
                const selectedProjectName = currentProjectSelect.options[currentProjectSelect.selectedIndex]?.text || '当前项目';
                
                if (!selectedProjectId) {
                    alert('请先选择要删除员工的项目');
                    return;
                }
                
                // 确认操作，防止误删
                if (!confirm(`确定要删除"${selectedProjectName}"项目中的所有员工吗？此操作不可撤销！`)) {
                    return;
                }
                
                console.log(`开始删除"${selectedProjectName}"项目中的所有员工`);
                
                // 获取当前数据模式
                const currentDataMode = localStorage.getItem('dataMode') || 'local';
                console.log('当前数据模式:', currentDataMode);
                
                // 根据数据模式执行不同的删除操作
                if (currentDataMode === 'supabase' && window.supabase) {
                    // Supabase模式：使用Supabase查询和删除
                    console.log('Supabase模式：删除项目中的所有员工');
                    
                    // 查询该项目下的员工记录，使用project_id字段
                    const { data, error } = await window.supabase
                        .from('employees')
                        .select('*')
                        .eq('project_id', selectedProjectId);
                    
                    if (error) {
                        console.error('Supabase查询失败:', error);
                        alert(`查询失败: ${error.message}`);
                        return;
                    }
                    
                    if (data && data.length > 0) {
                        const totalCount = data.length;
                        console.log(`找到"${selectedProjectName}"项目中的 ${totalCount} 名员工，开始批量删除`);
                        
                        // 执行批量删除
                        const { error: deleteError } = await window.supabase
                            .from('employees')
                            .delete()
                            .eq('project_id', selectedProjectId);
                        
                        if (deleteError) {
                            console.error('Supabase批量删除失败:', deleteError);
                            alert(`删除失败: ${deleteError.message}`);
                        } else {
                            // Supabase delete操作成功时，使用查询到的员工数量作为删除数量
                            // 因为delete()操作返回的是一个空数组，而不是包含被删除数据的数组
                            const deletedCount = totalCount;
                            console.log('Supabase批量删除成功，影响行数:', deletedCount);
                            alert(`"${selectedProjectName}"项目员工批量删除完成！共删除 ${deletedCount} 名员工`);
                            // 重新加载员工列表
                            listEmployees();
                            
                            // 显示删除结果
                            displayResult('employeeResults', {
                                success: true,
                                message: `批量删除完成`,
                                details: {
                                    total: totalCount,
                                    deleted: deletedCount,
                                    failed: totalCount - deletedCount
                                }
                            }, '员工批量删除');
                        }
                    } else {
                        console.log('Supabase未找到匹配的员工');
                        alert(`"${selectedProjectName}"项目中没有员工记录可删除`);
                    }
                } else {
                    // 本地模式：从localStorage删除
                    console.log('本地模式：删除项目中的所有员工');
                    
                    // 从localStorage获取所有员工数据
                    const allKeys = Object.keys(localStorage);
                    let totalCount = 0;
                    let deletedCount = 0;
                    
                    // 遍历所有localStorage键，查找包含员工数据的键
                    for (const key of allKeys) {
                        // 扩大搜索范围，包含employeesIndex键
                        if (key.includes('employees_') || key.includes('employee_') || key === 'employeesIndex') {
                            try {
                                const value = localStorage.getItem(key);
                                if (value) {
                                    const data = JSON.parse(value);
                                    
                                    // 处理数组格式
                                    if (Array.isArray(data)) {
                                        // 统计该项目下的员工数量
                                        const projectEmployees = data.filter(emp => emp.project_id === selectedProjectId);
                                        const projectEmployeeCount = projectEmployees.length;
                                        totalCount += projectEmployeeCount;
                                        
                                        // 过滤掉要删除的员工
                                        const filteredData = data.filter(emp => emp.project_id !== selectedProjectId);
                                        if (filteredData.length < data.length) {
                                            localStorage.setItem(key, JSON.stringify(filteredData));
                                            const actualDeleted = projectEmployeeCount;
                                            deletedCount += actualDeleted;
                                            console.log('已从', key, '中删除', actualDeleted, '名员工');
                                        }
                                    }
                                    // 处理包含employees数组的对象格式
                                    else if (typeof data === 'object' && data.employees) {
                                        // 处理包含employees数组的对象
                                        const projectEmployees = data.employees.filter(emp => emp.project_id === selectedProjectId);
                                        const projectEmployeeCount = projectEmployees.length;
                                        totalCount += projectEmployeeCount;
                                        
                                        const filteredEmployees = data.employees.filter(emp => emp.project_id !== selectedProjectId);
                                        if (filteredEmployees.length < data.employees.length) {
                                            data.employees = filteredEmployees;
                                            localStorage.setItem(key, JSON.stringify(data));
                                            const actualDeleted = projectEmployeeCount;
                                            deletedCount += actualDeleted;
                                            console.log('已从', key, '中删除', actualDeleted, '名员工');
                                        }
                                    }
                                    // 处理employeesIndex格式（对象，每个属性是一个员工对象）
                                    else if (typeof data === 'object' && key === 'employeesIndex') {
                                        console.log('处理employeesIndex键，当前格式:', typeof data);
                                        
                                        // 复制原始对象，避免直接修改
                                        const updatedData = { ...data };
                                        let deletedFromIndex = 0;
                                        
                                        // 统计该项目下的员工数量
                                        let projectEmployeeCount = 0;
                                        for (const empId in updatedData) {
                                            if (updatedData.hasOwnProperty(empId)) {
                                                const employee = updatedData[empId];
                                                if (employee.project_id === selectedProjectId) {
                                                    projectEmployeeCount++;
                                                }
                                            }
                                        }
                                        totalCount += projectEmployeeCount;
                                        
                                        // 遍历所有属性，检查每个员工对象
                                        for (const empId in updatedData) {
                                            if (updatedData.hasOwnProperty(empId)) {
                                                const employee = updatedData[empId];
                                                // 检查员工的project_id是否匹配
                                                if (employee.project_id === selectedProjectId) {
                                                    // 删除匹配的员工
                                                    delete updatedData[empId];
                                                    deletedFromIndex++;
                                                    console.log('从employeesIndex中删除员工:', empId, employee.emp_name || employee.name);
                                                }
                                            }
                                        }
                                        
                                        // 更新localStorage
                                        if (deletedFromIndex > 0) {
                                            localStorage.setItem('employeesIndex', JSON.stringify(updatedData));
                                            deletedCount += deletedFromIndex;
                                            console.log('已从employeesIndex中删除', deletedFromIndex, '名员工');
                                        }
                                    }
                                    // 处理其他可能的对象格式
                                    else if (typeof data === 'object') {
                                        // 检查是否是单个员工对象
                                        if (data.project_id === selectedProjectId) {
                                            // 删除整个键
                                            localStorage.removeItem(key);
                                            totalCount++;
                                            deletedCount++;
                                            console.log('已删除单个员工对象键:', key);
                                        }
                                    }
                                }
                            } catch (e) {
                                console.error('删除员工数据失败，键:', key, '错误:', e);
                            }
                        }
                    }
                    
                    // 重新加载员工列表
                    listEmployees();
                    
                    // 显示删除结果
                    displayResult('employeeResults', {
                        success: true,
                        message: `批量删除完成`,
                        details: {
                            total: totalCount,
                            deleted: deletedCount,
                            failed: totalCount - deletedCount
                        }
                    }, '员工批量删除');
                    
                    alert(`"${selectedProjectName}"项目员工批量删除完成！共删除 ${deletedCount} 名员工，失败 ${totalCount - deletedCount} 名`);
                }
            } catch (error) {
                console.error('批量删除员工失败:', error);
                alert(`批量删除员工时发生错误: ${error.message || '未知错误'}`);
            }
        }
        
        // 填充账号ID下拉框
        async function fillUserAccountsDropdown() {
            try {
                console.log('开始填充手机号下拉框');
                const dropdown = document.getElementById('userAccount');
                if (!dropdown) {
                    console.warn('未找到手机号下拉框元素');
                    return;
                }
                
                // 清空现有选项（保留默认选项）
                while (dropdown.options.length > 1) {
                    dropdown.remove(1);
                }
                
                let users = [];
                const currentDataMode = localStorage.getItem('dataMode') || 'local';
                
                if (currentDataMode === 'supabase' && window.supabase) {
                    // Supabase模式：使用Supabase客户端获取所有用户
                    console.log('使用Supabase获取所有用户用于填充下拉框');
                    const { data, error } = await window.supabase
                        .from('users')
                        .select('*');
                    
                    if (error) {
                        console.error('从Supabase获取用户失败:', error);
                    } else if (data && data.length > 0) {
                        // 添加去重逻辑
                        const userMap = new Map();
                        for (const user of data) {
                            if (user) {
                                const userId = user.user_id || user.id || user.phone || JSON.stringify(user);
                                if (!userMap.has(userId)) {
                                    userMap.set(userId, user);
                                    users.push(user);
                                }
                            }
                        }
                        console.log('从Supabase获取到并去重后有', users.length, '个用户');
                    }
                } else {
                    // 本地模式：使用现有的逻辑（lightweightDatabaseService或localStorage）
                    // 首先尝试使用lightweightDatabaseService获取所有用户
                    if (window.lightweightDatabaseService) {
                        console.log('使用lightweightDatabaseService获取所有用户');
                        const result = await window.lightweightDatabaseService.query('users', {});
                        if (result.success && result.data) {
                            users = result.data;
                        } else {
                            console.log('lightweightDatabaseService未找到用户或获取失败');
                        }
                    }
                    
                    // 如果没有从lightweightDatabaseService获取到用户，尝试从localStorage获取
                    if (users.length === 0) {
                        console.log('尝试从localStorage获取所有用户');
                        const allKeys = Object.keys(localStorage);
                        const tempUsers = [];
                        
                        // 1. 从currentUser获取当前登录用户
                        try {
                            const currentUserStr = localStorage.getItem('currentUser');
                            if (currentUserStr) {
                                const currentUser = JSON.parse(currentUserStr);
                                if (currentUser && typeof currentUser === 'object') {
                                    // 不再强制添加phone，而是使用实际存在的字段
                                    tempUsers.push(currentUser);
                                    console.log('从currentUser获取到当前登录用户');
                                }
                            }
                        } catch (e) {
                            console.error('解析currentUser失败:', e);
                        }
                        
                        // 2. 查找所有以'users.'开头的键
                        for (const key of allKeys) {
                            if (key.startsWith('users.')) {
                                try {
                                    const dataStr = localStorage.getItem(key);
                                    if (!dataStr) continue;
                                    
                                    const userData = JSON.parse(dataStr);
                                    if (!userData) continue;
                                    
                                    // 支持多种数据格式
                                    let userArray = [];
                                    if (Array.isArray(userData)) {
                                        userArray = userData;
                                    } else if (userData.users && Array.isArray(userData.users)) {
                                        userArray = userData.users;
                                    } else if (userData.data && Array.isArray(userData.data)) {
                                        userArray = userData.data;
                                    } else if (typeof userData === 'object') {
                                        userArray = [userData];
                                    }
                                    
                                    tempUsers.push(...userArray);
                                } catch (e) {
                                    console.error(`解析用户数据失败 ${key}:`, e);
                                }
                            }
                        }
                        
                        // 3. 从user_开头的键获取用户数据
                        for (const key of allKeys) {
                            if (key.startsWith('user_')) {
                                try {
                                    const dataStr = localStorage.getItem(key);
                                    if (!dataStr) continue;
                                    
                                    const userData = JSON.parse(dataStr);
                                    if (userData && typeof userData === 'object') {
                                        tempUsers.push(userData);
                                        console.log(`从${key}获取到用户数据`);
                                    }
                                } catch (e) {
                                    console.error(`解析用户数据失败 ${key}:`, e);
                                }
                            }
                        }
                        
                        // 4. 去重处理，避免重复用户
                        const userMap = new Map();
                        for (const user of tempUsers) {
                            if (user) {
                                const userId = user.user_id || user.id || user.phone || JSON.stringify(user);
                                if (!userMap.has(userId)) {
                                    userMap.set(userId, user);
                                    users.push(user);
                                }
                            }
                        }
                    }
                }
                
                // 添加user_id到下拉框，优先使用user_id，如果没有则使用其他标识
                users.forEach(user => {
                    const userId = user.user_id || user.id || user.phone;
                    if (userId) {
                        const option = document.createElement('option');
                        option.value = userId;
                        option.textContent = userId;
                        dropdown.appendChild(option);
                    }
                });
                
                console.log('账号ID下拉框填充完成，共', users.length, '个账号');
            } catch (error) {
                console.error('填充账号ID下拉框时发生错误:', error);
            }
        }
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化数据模式
            initDataMode();
            
            // 设置默认日期
            document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
            
            // 检查数据库状态
            checkDatabaseStatus();
            
            // 初始化下拉框数据
            initDropdowns();
            
            // 使用setTimeout确保其他脚本已加载
            setTimeout(fillUserAccountsDropdown, 100);
            
            // 添加手机号下拉框变化事件监听
            const phoneSelect = document.getElementById('currentPhone');
            if (phoneSelect) {
                phoneSelect.addEventListener('change', function() {
                    const selectedPhone = this.value;
                    console.log('手机号选择变化:', selectedPhone);
                    loadUserProjects(selectedPhone);
                });
            }
            
            // 添加查询员工按钮点击事件监听
            const queryButton = document.getElementById('queryEmployeeButton');
            if (queryButton) {
                queryButton.addEventListener('click', listEmployees);
            }
        });
    </script>
</body>
</html>